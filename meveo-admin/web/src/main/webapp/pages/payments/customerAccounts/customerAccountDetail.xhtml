<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:s="http://jboss.org/seam/faces"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org"
	xmlns:hf="http://java.sun.com/jsf/composite/tags"
	template="/layout/template.xhtml">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{customerAccountBean.preRenderView}" />
			<f:viewParam name="customerAccountId"
				value="#{customerAccountBean.objectId}" />
			<f:viewParam name="customerId"
				value="#{customerAccountBean.customerId}" />
			<f:viewParam name="customerId" value="#{customerBean.objectId}" />
		</f:metadata>
	</ui:define>

	<ui:define name="navigation">
		<ui:include src="/layout/navigation.xhtml" />
	</ui:define>

	<ui:define name="body">

		<hftl:entityPopup id="searchCustomerPopup"
			header="#{messages['customer.popup.header']}"
			backingBean="#{customerListBean}"
			searchField1Label="#{messages['customer.code']}" searchField1="code"
			column1Label="#{messages['customer.code']}" column1="code"
			selection="#{customerAccountBean.entity.customer}"
			updateField=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:customerSelectId">
		</hftl:entityPopup>

		<hftl:entityPopup id="customerAccCurrencyPopup"
			header="#{messages['customerAccountCurrencyPopup.header']}"
			backingBean="#{tradingCurrencyBean}"
			searchField1Label="#{messages['businessEntity.code']}"
			searchField1="currency.currencyCode"
			column1Label="#{messages['businessEntity.code']}"
			column1="currencyCode"
			column2Label="#{messages['businessEntity.description']}"
			column2="prDescription"
			selection="#{customerAccountBean.entity.tradingCurrency}"
			updateField=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:currencySelectId">
		</hftl:entityPopup>
		
		<hftl:entityPopup id="tradingLanguagePopup"
				header="#{messages['tradingLanguage.popup.header']}"
				backingBean="#{tradingLanguageBean}"
				searchField1Label="#{messages['businessEntity.code']}"
				searchField1="language.languageCode"
				column1Label="#{messages['businessEntity.code']}"
				column1="languageCode"
				column2Label="#{messages['businessEntity.description']}"
				column2="prDescription"
				selection="#{customerAccountBean.entity.tradingLanguage}"
				updateField=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:trLanguageSelectId">
		</hftl:entityPopup>
		<p:panel>
			<h:form id="crumbmenuForm">
				<p:breadCrumb homeDisplay="text" id="crumbmenu">
					<p:menuitem value="#{messages['menu.crm']}" disabled="true" />
					<p:menuitem outcome="customerAccounts"
						value="#{messages['menu.customerAccounts']}" />
				</p:breadCrumb>
			</h:form>
		</p:panel>
        <h:panelGroup styleClass="col2-set">
            <h:panelGroup styleClass="col1">
					<hf:hierarchyPanel
						treeValue="#{customerTreeBean.buildAccountsHierarchy(customerAccountBean.entity)}"
						entity="#{customerAccountBean.entity}" />
            </h:panelGroup>
			<h:panelGroup styleClass="col2">

					<p:tabView id="parentTab"
						activeIndex="#{customerAccountBean.selectedTab}">
						<p:tab id="compte"
							title="#{messages['customerAccount.tab.account']}">
							<hf:formPanel id="formCustomerAccountPanel"
								formId="formCustomerAccount"
								label="#{messages['customerAccount.form']}"
								backingBean="#{customerAccountBean}" showFormButtons="false"
								useCustomIdParam="true">
									<p:tabView id="childTab" activeIndex="#{customerAccountBean.activeTab}">
										<p:ajax event="tabChange" listener="#{customerAccountBean.onTabChange}"/>
										<p:tab id="tab0"
											title="#{messages['customerAccount.tab.account']}">
												<hf:formField id="customerSelectId"
													label="#{messages['customerAccount.customer']}"
													field="customer" valueLabelField="code" required="true"
													popup="true" popupId="searchCustomerPopup" />
                                              
                                              <p:fieldset legend="#{messages['customerAccount.form']}" styleClass="clearLeft" >
                                                    
												<hf:formField label="#{messages['businessEntity.code']}"
													field="code" maxlength="35" validateUnique="true"
													required="true" />
												<hf:formField
													label="#{messages['accountEntity.primaryContact']}"
													field="primaryContact" valueLabelField="code"
													listBean="#{providerContactBean}" />
												<hf:formField
													label="#{messages['businessEntity.description']}"
													field="description" id="description" maxlength="100"
													required="true" />
												<hf:formField
													label="#{messages['customerAccount.externalRef1']}"
													field="externalRef1" maxlength="50" />
												<hf:formField
													label="#{messages['customerAccount.externalRef2']}"
													field="externalRef2" maxlength="50" />
												<hf:formField id="currencySelectId"
													label="#{messages['currency.codeCurrency']}"
													required="true" field="tradingCurrency"
													valueLabelField="currencyCode" popup="true"
													popupId="customerAccCurrencyPopup" />
                                               <hf:formField id="trLanguageSelectId"
														label="#{messages['tradingLanguage.tradingLanguage']}"
														field="tradingLanguage" valueLabelField="languageCode"
														required="true" popup="true"
														popupId="tradingLanguagePopup" />	                                               


												<h:panelGroup rendered="#{!customerAccountBean.edit}">
        											<hf:formDecorateField fieldId="dunning_text" label="#{messages['customerAccount.dunningLevel']}" newLine="true">
													<h:outputText id="dunning_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.entity.getDunningLevel()}"
														style="font-weight:bold;" />
    												</hf:formDecorateField>
        											<hf:formDecorateField fieldId="dunning_date_text" label="#{messages['customerAccount.dateDunningLevel']}">
													<h:outputText id="dunning_date_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.entity.getDateDunningLevel()}"
														style="font-weight:bold;" />
    												</hf:formDecorateField>
    												<hf:formDecorateField fieldId="balance_text" label="#{messages['customerAccount.balanceDue']}">
													<h:outputText id="balance_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.getBalanceDue()}"
														style="font-weight:bold;" converter="bigDecimalConverter" />
    												</hf:formDecorateField>
    												<hf:formDecorateField fieldId="balanceEx_text" label="#{messages['customerAccount.balanceExigible']}">
													<h:outputText id="balanceEx_text"
														rendered="#{!customerAccountBean.edit}"
														value="#{customerAccountBean.getBalanceExigibleWithoutLitigation()}"
														style="font-weight:bold;" converter="bigDecimalConverter" />
    												</hf:formDecorateField>
												</h:panelGroup>

                                                <hf:formField label="#{messages['name.title']}" field="name" childField="title" valueLabelField="description" required="true"
                                                    listBean="#{titleBean}" listenerUpdate=":parentTab:formCustomerAccountPanel:formCustomerAccount:childTab:userNamePanel" styleClass="clearLeft"/>
                
            									<h:panelGroup id="userNamePanel" layout="block">
            											<hf:formField label="#{messages['name.lastName']}"
            												field="name" childField="lastName" 
														maxlength="50" required="true" />
                                                        <hf:formField label="#{messages['name.firstName']}"
                                                            field="name" childField="firstName" 
                                                            maxlength="50" rendered="#{customerAccountBean.entity.name.title == null or !customerAccountBean.entity.name.title.isCompany}"/>            											
            									</h:panelGroup>

												<hf:formField
													label="#{messages['customerAccount.paymentMethod']}"
													field="paymentMethod" newLine="true"/>
												<hf:formField
													label="#{messages['customerAccount.creditCategory']}"
													field="creditCategory" valueLabelField="code"
													listBean="#{creditCategoryBean}" />

												<hf:formField label="#{messages['customerAccount.status']}"
													field="status" disabled="true" />

												<hf:formField
													label="#{messages['accountEntity.defaultLevel']}"
													field="defaultLevel" isMessage="true" />
                                                    
                                            </p:fieldset>
										</p:tab>

										<p:tab id="tab1"
											title="#{messages['customerAccount.tab.information']}">
											<p:fieldset legend="#{messages['commons.contacts']}">
												<hf:formField
													label="#{messages['contactInformation.email']}"
													field="contactInformation" childField="email" popup="false"
													required="false" id="email" maxlength="100"
													validateEmail="true" />
                                                    
													<hf:formField
														label="#{messages['contactInformation.phone']}"
														field="contactInformation" childField="phone"
														popup="false" maxlength="15" />
													<hf:formField
														label="#{messages['contactInformation.mobile']}"
														field="contactInformation" childField="mobile"
														popup="false" maxlength="15" />
											</p:fieldset>
											<p:fieldset legend="#{messages['commons.address']}">
													<hf:formField label="#{messages['address.address1']}"
														field="address" id="address1" childField="address1"
														popup="false" size="80" maxlength="80" />
													<hf:formField label="#{messages['address.address2']}"
														field="address" id="address2" childField="address2"
														popup="false" size="80" maxlength="80" />
													<hf:formField label="#{messages['address.address3']}"
														field="address" id="address3" childField="address3"
														popup="false" size="80" maxlength="80" />
													<hf:formField label="#{messages['address.zipCode']}"
														size="10" id="zipCode" field="address"
														childField="zipCode" length="10" popup="false"
														maxlength="10" newLine="true"/>
													<hf:formField label="#{messages['address.city']}"
														id="city" field="address" childField="city" popup="false"
														maxlength="50" />
												<hf:formField id="countryPanel"
													label="#{messages['address.country']}" fkToEntity="true"
													field="address" childField="country"
													valueLabelField="descriptionEn" valueField="countryCode"
													listBean="#{countryBean}"/>
											</p:fieldset>
											<p:fieldset legend="#{messages['customerAccount.sepaDebit']}">
													<hf:formField
														label="#{messages['customerAccount.mandateIdentification']}"
														field="mandateIdentification" />
													<hf:formField
														label="#{messages['customerAccount.mandateDate']}"
														field="mandateDate" isDate="true" />
											</p:fieldset>
										</p:tab>

										<p:tab title="#{messages['customFieldTemplate.panel']}" id="tab2">
											<hf:customFields />
										</p:tab>

									</p:tabView>

									<hf:formButtons columns="5"
										backingBean="#{customerAccountBean}"
										edit="#{customerAccountBean.edit}" ajaxSubmit="false"
										useCustomIdParam="true">
										<p:commandButton
											rendered="#{customerAccountBean.isActiveAccount() and !customerAccountBean.edit}"
											action="#{customerAccountBean.closeCustomerAccount}"
											value="#{messages['customerAccount.buttonCloseAccount']}"
											onclick="if(confirm('#{messages['customerAccount.confirmCloseAccount']}')){return true;}else{return false;}">
											<!-- 										<f:attribute name="backView" value="#{backView}" /> -->
										</p:commandButton>
										<p:button
											rendered="#{customerAccountBean.isActiveAccount() and !customerAccountBean.edit}"
											outcome="addBillingAccount"
											value="#{messages['customerAccount.buttonAddBillingAccount']}">
											<f:param name="cid"
												value="#{javax.enterprise.context.conversation.id}" />
										</p:button>
									</hf:formButtons>
							</hf:formPanel>
						</p:tab>
						<p:tab id="ops" title="#{messages['customerAccount.operations']}">
							<hf:searchPanel renderNewButton="false"
								label="#{messages['accountOperation.search']}" columns="1"
								backingBean="#{accountOperationBean}" ajax="true"
								ajaxUpdateIds=":parentTab:results_panel">
									<hf:searchField
										label="#{messages['accountOperation.transactionCategory']}"
										field="transactionCategory" />
									<hf:searchField
										label="#{messages['accountOperation.matchingStatus']}"
										field="matchingStatus" />
									<hf:searchField label="#{messages['accountOperation.occCode']}"
										field="occCode" />
									<hf:searchField
										label="#{messages['accountOperation.accountCode']}"
										field="accountCode" />
								<hf:searchField
									label="#{messages['accountOperation.transactionDate']}"
									field="transactionDate" />
								<hf:searchField label="#{messages['accountOperation.dueDate']}"
									field="dueDate" />
							</hf:searchPanel>

							<h:form id="addOperationForm">
								<h:panelGroup layout="block" styleClass="form-panel-actions">
									<p:button value="#{messages['customerAccount.addOperation']}"
										outcome="addNewOperation"
										rendered="#{customerAccountBean.isActiveAccount()}"
										includeViewParams="true">
										<f:param name="cid"
											value="#{javax.enterprise.context.conversation.id}" />
									</p:button>
									<p:commandButton
										value="#{messages['customerAccount.addPaymentCheck']}"
										action="#{otherCreditAndChargeBean.loadFromTemplatePaymentCheck(customerAccountBean.entity.id)}"
										rendered="#{customerAccountBean.isActiveAccount()}" />
									<p:button outcome="transferAccount"
										value="#{messages['customerAccount.buttonTransfert']}"
										rendered="#{customerAccountBean.isActiveAccount()}">
										<f:param name="objectId"
											value="#{customerAccountBean.entity.id}" />
										<f:param name="cid"
											value="#{javax.enterprise.context.conversation.id}" />
									</p:button>
							     </h:panelGroup>
							</h:form>

						<hftl:dataList backingBean="#{accountOperationBean}"
								dataModel="#{accountOperationBean.getAccountOperations(customerAccountBean.entity)}"
								label="#{messages['accountOperation.title']}" disabled="true"
								checkMany="false" >
								<p:column selectionMode="multiple" style="width:5%"  />
							    <p:ajax event="rowSelectCheckbox" update="@form" />

								<p:column width="10%">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.type']}" />
									</f:facet>
									<h:outputText value="#{entity.type}" />
								</p:column>

								<p:column width="10%">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.occCode']}" />
									</f:facet>
									<h:outputText value="#{entity.occCode}" />
								</p:column>

								<p:column width="20%">
									<f:facet name="header">
										<h:outputText
											value="#{messages['accountOperation.occDescription']}" />
									</f:facet>
									<h:outputText value="#{entity.occDescription}" />
								</p:column>

								<p:column width="10%" styleClass="noWrap">
									<f:facet name="header">
										<h:outputText
											value="#{messages['accountOperation.transactionDate']}" />
									</f:facet>
									<h:outputText value="#{entity.transactionDate}" style="text-wrap" />
								</p:column>

								<p:column width="10%" styleClass="noWrap">
									<f:facet name="header">
										<h:outputText value="#{messages['accountOperation.dueDate']}" />
									</f:facet>
									<h:outputText value="#{entity.dueDate}" />
								</p:column>

                                <p:column headerText="#{messages['accountOperation.debit']}" width="10%">
                                    <h:outputText value="#{entity.amount}" rendered="#{entity.transactionCategory eq 'DEBIT'}" >
                                        <f:converter converterId="bigDecimal4DigitsConverter"/>
                                    </h:outputText>
                                </p:column>
                                <p:column headerText="#{messages['accountOperation.credit']}" width="10%">
                                    <h:outputText value="#{entity.amount}" rendered="#{entity.transactionCategory eq 'CREDIT'}" >
                                        <f:converter converterId="bigDecimal4DigitsConverter"/>
                                    </h:outputText>
                                </p:column>

								<hftl:column
									label="#{messages['accountOperation.unMatchingAmount']}"
									field="unMatchingAmount" converterParam="4digits" width="10%"/>
	
								<hftl:column
									label="#{messages['accountOperation.matchingStatus']}"
									field="matchingStatus.label" isMessage="true" width="10%" />	
									
									<hftl:column
									label="#{messages['accountOperation.excludedFromDunning']}"
									field="excludedFromDunning" isMessage="true"  width="10%"/>

								<hftl:actionsColumn width="15%"
									editView="#{accountOperationBean.displayOperation(entity.getId())}" renderEditLink="false"/> 
								<ui:define name="add-on-buttons"> 
									<h:panelGroup layout="block" styleClass="form-panel-actions">
										<p:commandButton
											action="#{accountOperationBean.matching(customerAccountBean.entity.id)}"
											value="#{messages['customerAccount.buttonLettrage']}"
											rendered="#{customerAccountBean.isActiveAccount()}" />
										<p:commandButton
											action="#{accountOperationBean.consultMatching(customerAccountBean.entity.id)}"
											value="#{messages['customerAccount.buttonConsultMatching']}"
											rendered="#{customerAccountBean.isActiveAccount()}" />
										
										<p:commandButton
											action="#{accountOperationBean.dunningInclusionExclusion(customerAccountBean.entity.id,true)}"
											value="#{messages['customerAccount.excludeFromDunning']}"
											rendered="#{customerAccountBean.isActiveAccount()}"
											disabled="#{accountOperationBean.isSelectedOperationExcluded()}"/>
											<p:commandButton
											action="#{accountOperationBean.dunningInclusionExclusion(customerAccountBean.entity.id,false)}"
											value="#{messages['customerAccount.includeToDunning']}"
											rendered="#{customerAccountBean.isActiveAccount()}"
											disabled="#{accountOperationBean.isSelectedOperationIncluded()}"/>	
									</h:panelGroup>
								</ui:define> 
							</hftl:dataList>

							<h:form>
								<hf:formButtons columns="3" backingBean="#{customerAccountBean}"
									edit="#{customerAccountBean.edit}" ajaxSubmit="false"
									useCustomIdParam="true">
								</hf:formButtons>
							</h:form>
						</p:tab>
					</p:tabView>

            </h:panelGroup>
        </h:panelGroup>
	</ui:define>
</ui:composition>
