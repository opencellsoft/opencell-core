<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.com/products/seam/taglib"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html" xmlns:hftl="http://hftl.org"
	xmlns:hf="http://java.sun.com/jsf/composite/tags"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:p="http://primefaces.org/ui" template="/layout/template.xhtml">

    <ui:define name="metadata">
        <f:metadata>
            <f:viewParam name="objectId" value="#{userBean.objectId}" />
        </f:metadata>
    </ui:define>

    <ui:define name="body">

			<h:form id="crumbmenuForm">
				<p:breadCrumb homeDisplay="text" id="crumbmenu">
					<p:menuitem value="#{messages['menu.admin']}" disabled="true" />
					<p:menuitem value="#{messages['menu.users']}" outcome="users" />
					<p:menuitem value="#{messages['user.new']}" disabled="true" rendered="#{userBean.entity.transient}" />
					<p:menuitem value="#{messages['user.editView']}" disabled="true" rendered="#{!userBean.entity.transient}" />
				</p:breadCrumb>
			</h:form>

		<p:panel>
			<p:tabView id="tabView" activeIndex="#{userBean.activeTab}">
				<p:tab title="#{messages['commons.tab.information']}">
					<hftl:formPanel
						backingBean="#{userBean}" columns="1">
						<hftl:formField label="#{messages['user.userName']}"
							field="userName" required="true" validateUnique="true"
							useConverter="false" />
						<hftl:formField label="#{messages['contactInformation.email']}"
							field="email" required="true" useConverter="false"
							validatorId="emailValidator" />
						<p:outputPanel styleClass="clearLeft">
							<hftl:formField label="#{messages['name.firstName']}"
								field="name" childField="firstName" maxlength="50" />
							<hftl:formField label="#{messages['name.lastName']}" field="name"
								childField="lastName" maxlength="50" />
						</p:outputPanel>
						<p:commandLink value="#{messages['menutop.changePassword']}"
							action="#{userBean.showHidePassword}" update="passwordPanel"
							rendered="#{!(userBean.entity.id==null) and userBean.edit and userBean.canUserUpdateEntity()}"
							partialSubmit="true" process="@this" style="text-align:right;" />


            <p:outputPanel id="passwordPanel" styleClass="clearLeft">
							<h:panelGroup
								rendered="#{(userBean.show or userBean.entity.id==null) and userBean.edit}">
								<hftl:decorateFormField fieldId="password"
									label="#{messages['user.password']}">
									<p:password autocomplete="off" id="password" feedback="true"
										value="#{userBean.password}" required="true"
										match="repeatedPassword" />
                    </hftl:decorateFormField>
								<hftl:decorateFormField id="repeatedPassword"
									fieldId="repeatedPassword"
									label="#{messages['user.repeatedPassword']}">
									<p:password id="repeatedPassword"
										value="#{userBean.repeatedPassword}" autocomplete="off" />
                    </hftl:decorateFormField>
                </h:panelGroup>
            </p:outputPanel>

            <hftl:formField label="#{messages['commons.provider']}" field="provider" listBean="#{providerBean}" valueLabelField="code" required="true" allowEdit="false"
                rendered="#{identity.hasPermission('superAdmin', 'superAdminManagement')}" newLine="true" listenerUpdate="userGroupLevel userRoles" actionListenerBean="#{userBean}"
                actionListenerMethod="onProviderChange" />

            <hftl:decorateFormField fieldId="formId:userGroupLevel" label="#{messages['user.userGroupLevel']}" newLine="true">
                <p:tree id="userGroupLevel" value="#{userBean.userGroupRootNode}" var="groupLevel" propagateSelectionUp="false" propagateSelectionDown="false" selectionMode="single"
                    selection="#{userBean.userGroupSelectedNode}">
                    <p:treeNode>
                        <h:outputText value="#{groupLevel.descriptionOrCode}" />
                    </p:treeNode>
                </p:tree>
            </hftl:decorateFormField>

            <hftl:formField id="userRoles" label="#{messages['user.roles']}" field="roles" listType="pickUpList" valueLabelField="name" required="true"
                dualListModel="#{userBean.dualListModel}" />

        </hftl:formPanel>
				</p:tab>


				<p:tab title="#{messages['user.securedEntitiesTab']}" rendered="#{!(userBean.entity.id==null) and userBean.edit and userBean.canUserUpdateEntity()}">
					<h:panelGroup id="selectedEntitiesPanel">
						<p:messages />
						<p:dataTable id="selectedEntitiesDatatable" var="securedEntity"
							value="#{userBean.selectedSecuredEntities}" paginator="true"
							rows="10" sortBy="#{securedEntity.code}"
							paginatorAlwaysVisible="false"
							paginatorTemplate="{RowsPerPageDropdown} {FirstPageLink} {PreviousPageLink} {CurrentPageReport} {NextPageLink} {LastPageLink}"
							lazy="false" styleClass="custom-grid"
							rowsPerPageTemplate="10, 20, 50" reflow="true">
							<p:column headerText="#{messages['BusinessEntity.type']}">
								<h:outputText value="#{securedEntity.readableEntityClass}"
									styleClass="field-value" />
							</p:column>
							<p:column headerText="#{messages['BusinessEntity.code']}">
								<h:outputText value="#{securedEntity.code}"
									styleClass="field-value" />
							</p:column>
							<p:column headerText="#{messages['BusinessEntity.description']}">
								<h:outputText value="#{securedEntity.description}"
									styleClass="field-value" />
							</p:column>
							<p:column styleClass="actions-column" rendered="#{userBean.edit}">
								<f:facet name="header">
									<h:outputText value="#{messages['commons.actions']}" />
								</f:facet>
								<p:commandButton
									action="#{userBean.deleteSecuredEntity(securedEntity)}"
									rendered="#{userBean.canUserUpdateEntity()}"
									icon="ui-icon-trash" update=":tabView:selectedEntitiesPanel" />
							</p:column>
							<f:facet name="footer">
								<p:commandButton id="addEntity"
									value="#{messages['user.addSecuredEntity']}"
									rendered="#{userBean.canUserUpdateEntity()}"
									oncomplete="PF('securedEntitiesDialog').show()"></p:commandButton>
							</f:facet>
						</p:dataTable>
					</h:panelGroup>

					<p:dialog id="securedEntitiesDialog"
						header="#{messages['user.securedEntities']}"
						widgetVar="securedEntitiesDialog" dynamic="true" modal="true"
						styleClass="form-dialog" closeOnEscape="true" width="600"
						appendTo="@(body)">

						<h:panelGroup id="securedEntitiesDialogPanel" layout="block"
							styleClass="search-panel">
							<h:form id="securedEntitiesDialogForm">
								<h:panelGroup layout="block" styleClass="search-panel">
									<p:messages />
									<p:outputPanel styleClass="search-panel-fields">
										<hftl:decorateFormField fieldId="securedEntityType"
											label="#{messages['BusinessEntity.type']}">
											<p:selectOneMenu id="securedEntityType"
												value="#{userBean.securedEntityType}">
												<f:selectItem itemLabel="" />
												<f:selectItems
													value="#{userBean.securedEntityTypes.entrySet()}"
													var="item" itemLabel="#{item.key}"
													itemValue="#{item.value}" />
												<p:ajax listener="#{userBean.updateSelectedAccountBean}"
													update=":tabView:securedEntitiesDialogPanel" />
											</p:selectOneMenu>
										</hftl:decorateFormField>
										<hftl:decorateFormField fieldId="codeSearchField"
											label="#{messages['BusinessEntity.code']}"
											rendered="#{userBean.selectedAccountBean != null}">
											<p:inputText id="codeSearchField"
												value="#{userBean.selectedAccountBean.filters['code']}"
												size="20" maxlength="40" disabled="false" />
										</hftl:decorateFormField>
									</p:outputPanel>
									<h:panelGroup layout="block" styleClass="search-panel-actions"
										rendered="#{userBean.selectedAccountBean != null}">
										<p:commandButton id="buttonSearch"
											value="#{messages['commons.search']}" update="@form" />
										<p:commandButton id="buttonClear"
											action="#{userBean.selectedAccountBean.clean}"
											value="#{messages['commons.clean']}"
											update=":tabView:securedEntitiesDialogForm" />
									</h:panelGroup>
								</h:panelGroup>

								<p:panel id="securedEntitiesDialogDataPanel"
									rendered="#{userBean.selectedAccountBean != null}">
									<p:dataTable id="securedEntitiesDialogDatatable" var="e"
										paginator="true" resizableColumns="true"
										value="#{userBean.selectedAccountBean.lazyDataModel}"
										rows="10" selection="#{userBean.selectedEntity}"
										selectionMode="single" rowKey="#{e.id}" lazy="true">
										<p:ajax event="rowSelect"
											listener="#{userBean.saveSecuredEntity}"
											oncomplete="PF('securedEntitiesDialog').hide()"
											update=":tabView:selectedEntitiesPanel" />
										<p:column headerText="#{messages['BusinessEntity.code']}">
											<h:outputText value="#{e.code}" />
										</p:column>
										<p:column
											headerText="#{messages['BusinessEntity.description']}">
											<h:outputText value="#{e.description}" />
										</p:column>
									</p:dataTable>
								</p:panel>
							</h:form>
						</h:panelGroup>
					</p:dialog>
				</p:tab>
			</p:tabView>
		</p:panel>
    </ui:define>

</ui:composition>
