<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:s="http://jboss.org/seam/faces"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	
	xmlns:o="http://omnifaces.org/ui"
	xmlns:of="http://omnifaces.org/functions"
	 xmlns:hftl="http://hftl.org"
	xmlns:hf="http://java.sun.com/jsf/composite/tags"
	template="/layout/template.xhtml" xmlns:p="http://primefaces.org/ui">

	<ui:define name="metadata">
		<f:metadata>
			<f:event type="preRenderView"
				listener="#{userAccountBean.preRenderView}" />

            <f:viewParam name="userAccountId" value="#{userAccountBean.objectId}" />
            <f:viewParam name="billingAccountId" value="#{userAccountBean.billingAccountId}" />
            <f:viewParam name="billingAccountId" value="#{billingAccountBean.objectId}" />
            <f:viewParam name="customerAccountId" value="#{customerAccountBean.objectId}" />
            <f:viewParam name="customerId" value="#{customerBean.objectId}" />
        </f:metadata>

		<o:importConstants
			type="org.meveo.model.billing.WalletOperationStatusEnum" />
	</ui:define>

	<ui:define name="navigation">
		<ui:include src="/layout/navigation.xhtml" />
	</ui:define>

	<ui:define name="body">
		<p:panel>
			<h:form id="crumbmenuForm">
				<p:breadCrumb homeDisplay="text" id="crumbmenu">
					<p:menuitem value="#{messages['menu.crm']}" disabled="true" />
					<p:menuitem outcome="userAccounts"
						value="#{messages['menu.userAccounts']}" />
				</p:breadCrumb>
			</h:form>
		</p:panel>
		<hftl:entityPopup id="billingAccountPopup"
			header="#{messages['billingAccount.popup.header']}"
			backingBean="#{billingAccountBean}"
			searchField1Label="#{messages['billingAccount.code']}"
			searchField1="code" column1Label="#{messages['billingAccount.code']}"
			column1="code" selection="#{userAccountBean.entity.billingAccount}"
			updateField=":userAccountFormPanel:formId:userAccountTab:billingAccountSelectId">
		</hftl:entityPopup>

		<hftl:entityPopup id="walletOperationPopup"
			dataModel="#{userAccountBean.getWalletOperationsNoInvoiced()}"
			header="#{messages['ratedTransactionsNoInvoiced.popup.header']}"
			showSearchButton="false" backingBean="#{walletOperationBean}"
			column1Label="#{messages['walletOperation.operationDate']}"
			column1="operationDate" column1Converter="date"
			column2Label="#{messages['walletOperation.endDate']}"
			column2="endDate" column3Label="#{messages['chargeInstance.code']}"
			column2Converter="date" column3="chargeInstance" column3Child="code"
			column4Label="#{messages['walletOperation.quantity']}"
			column4="quantity" column4Converter="4digits"
			column5Label="#{messages['walletOperation.amountWithoutTax']}"
			column5="amountWithoutTax" column5Converter="4digits"
			column6Label="#{messages['walletOperation.amountWithTax']}"
			column6="amountWithTax" column6Converter="4digits"
			column7Label="#{messages['currency.codeCurrency']}"
			column7="currency">
		</hftl:entityPopup>

		<hftl:entityPopup id="ratedTransactionsInvoicedPopup"
			header="#{messages['ratedTransactionsInvoiced.popup.header']}"
			showSearchButton="false" backingBean="#{ratedTransactionBean}"
			column1Label="#{messages['ratedTransaction.usageDate']}"
			column1="usageDate"
			column2Label="#{messages['ratedTransaction.usageCode']}"
			column2="usageCode"
			column3Label="#{messages['ratedTransaction.description']}"
			column3="prDescription"
			column4Label="#{messages['ratedTransaction.usageQuantity']}"
			column4="usageQuantity"
			column5Label="#{messages['ratedTransaction.amount1WithoutTax']}"
			column5="amount"
			column6Label="#{messages['ratedTransaction.amount1WithTax']}"
			column6="amountWithTax">
		</hftl:entityPopup>

		<p:dialog id="reloadPopup"
			header="#{messages['dialog.reloadPopup.title']}"
			widgetVar="dlg_reloadPopup" dynamic="false" width="400">
			<p:outputPanel id="reloadPanel">
				<hf:formPanel edit="true"
					label="#{messages['dialog.reloadPopup.title']}"
					backingBean="#{userAccountBean}"
					entity="#{userAccountBean.reloadOperation}" styleClass="formPanel"
					formId="reloadFrm" showFormButtons="false" useCustomIdParam="true">
					<hftl:decorateFormField fieldId="operationDate" label="#{messages['walletOperation.operationDate']}">
						<p:inputText id="operationDate" value=""></p:inputText>
						<p:calendar
							value="#{userAccountBean.reloadOperation.operationDate}"
							pattern="dd/MM/yyyy HH:mm" required="true" />
					</hftl:decorateFormField>
					<hftl:decorateFormField fieldId="amountWithoutTax" label="#{messages['walletOperation.amountWithoutTax']}">
						<p:inputText id="amountWithoutTax"
							value="#{userAccountBean.reloadOperation.amountWithoutTax}"></p:inputText>
					</hftl:decorateFormField>
					<hftl:decorateFormField fieldId="amountWithTax" label="#{messages['walletOperation.amountWithTax']}">
						<p:inputText id="amountWithTax"
							value="#{userAccountBean.reloadOperation.amountWithTax}"></p:inputText>
					</hftl:decorateFormField>
					<f:facet name="buttons">
						<p:commandButton action="#{userAccountBean.reload()}"
							value="#{messages['button.terminateButton']}"
							onclick="PF('dlg_reloadPopup').hide()"
							update=":#{p:component('userAccountFormPanel')}" />
						<p:commandButton immediate="true" onclick="PF('dlg_reloadPopup').hide()"
							value="#{messages['management.close']}" />
					</f:facet>
				</hf:formPanel>
			</p:outputPanel>
		</p:dialog>

        <h:panelGroup styleClass="col2-set">
            <h:panelGroup styleClass="col1">
					<hf:hierarchyPanel
						treeValue="#{customerTreeBean.buildAccountsHierarchy(userAccountBean.entity)}"
						entity="#{userAccountBean.entity}" />
            </h:panelGroup>
			<h:panelGroup styleClass="col2">
					<hf:formPanel id="userAccountFormPanel" ajaxSubmit="true" submitPartialProcess=":userAccountFormPanel:formId:userAccountTab"
						label="#{messages['userAccount.userAccountPanel']}"
						backingBean="#{userAccountBean}" useCustomIdParam="true">
						<p:tabView id="userAccountTab">
							<p:tab title="#{messages['userAccount.userAccountPanel']}" id="tab0">
									<hf:formField id="billingAccountSelectId"
										label="#{messages['userAccount.billingAccount']}"
										field="billingAccount" valueLabelField="code" required="true"
										popup="true" popupId="billingAccountPopup"/>
								<p:fieldset legend="#{messages['userAccount.userAccountPanel']}" styleClass="clearLeft" >
										<!--Creation window fields-->
										<hf:formField label="#{messages['businessEntity.code']}"
											field="code" maxlength="35" validateUnique="true" size="35"
											required="true" />
										<hf:formField
											label="#{messages['accountEntity.primaryContact']}"
											field="primaryContact" valueLabelField="code" 
											listBean="#{providerContactBean}" />
										<hf:formField
											label="#{messages['businessEntity.description']}"
											field="description" id="description" showOnlyOnNew="true"
											useConverter="false" size="70" maxlength="100"
											required="true" />
										<hf:formField label="#{messages['accountEntity.externalRef1']}"
											field="externalRef1" validateUnique="false" newLine="true"/>
										<hf:formField label="#{messages['accountEntity.externalRef2']}"
											field="externalRef2" />

                                    <hf:formField label="#{messages['name.title']}" field="name" childField="title" valueLabelField="description" required="false"
                                        listBean="#{titleBean}" listenerUpdate=":userAccountFormPanel:formId:userAccountTab:userNamePanel" styleClass="clearLeft"/>

                                    <h:panelGroup id="userNamePanel" layout="block">
                                            <hf:formField label="#{messages['name.lastName']}"
                                                field="name" childField="lastName" 
                                                maxlength="50" required="true" />
                                            <hf:formField label="#{messages['name.firstName']}"
                                                field="name" childField="firstName" 
                                                maxlength="50" rendered="#{userAccountBean.entity.name.title == null or !userAccountBean.entity.name.title.isCompany}"/>
                                    </h:panelGroup>    

										<hf:formField
											label="#{messages['accountEntity.defaultLevel']}"
											field="defaultLevel" isMessage="true" />
								</p:fieldset>
							</p:tab>

							<p:tab title="#{messages['billingAccount.tab.information']}" id="tab1">
								<p:fieldset legend="#{messages['commons.contacts']}"> 
										<hf:formField label="#{messages['address.address1']}"
											field="address" childField="address1"  size="80"
											maxlength="80" />
										<hf:formField label="#{messages['address.address2']}"
											field="address" childField="address2"  size="80"
											maxlength="80" />
										<hf:formField label="#{messages['address.address3']}"
											field="address" childField="address3"  size="80"
											maxlength="80" />
										<hf:formField label="#{messages['address.zipCode']}"
											field="address" childField="zipCode" 
											maxlength="10" size="10" newLine="true"/>
										<hf:formField label="#{messages['address.city']}"
											field="address" childField="city" 
											maxlength="50" />
										<hf:formField id="countryPanel"
											label="#{messages['address.country']}" fkToEntity="true"
											field="address" childField="country"
											valueLabelField="descriptionEn" valueField="countryCode"
											listBean="#{countryBean}"/>
								</p:fieldset>
							</p:tab>

							<p:tab title="#{messages['customFieldTemplate.cfValues']}" id="tab2">
								<hf:customFields id="customFields" backingBean="#{userAccountBean}" messagesId=":userAccountFormPanel:formId:messages"/>
							</p:tab>

							<c:forEach items="#{userAccountBean.entity.prepaidWallets}"
								var="wallet"> 
								<p:tab title="Wallet #{wallet.key}"
									id="tab#{wallet.key}">
									<p:panel id="panelWallet_#{wallet.key}"
										styleClass="form-panel-fields">
                                            <hftl:decorateFormField label="#{messages['chargeInstance.code']}">
												<h:outputText value="#{wallet.value.code}" />
                                            </hftl:decorateFormField>
											<hftl:decorateFormField label="#{messages['BusinessEntity.description']}">
												<h:outputText value="#{wallet.value.description}" />
                                            </hftl:decorateFormField>
                                            <hftl:decorateFormField label="#{messages['walletTemplate.lowBalanceLevel']}">
                                            	<h:outputText value="#{wallet.value.lowBalanceLevel}" />
                                            </hftl:decorateFormField>
                                            <hftl:decorateFormField label="#{messages['chargeTemplate.type']}">
												<h:outputText
													value="#{wallet.value.walletTemplate.walletType}" />
                                            </hftl:decorateFormField>
												<p:fieldset legend="#{messages['walletOperationStatus.open']}" rendered="#{wallet.key!='PREPAID'}" styleClass="clearLeft" style="width: 25%; float:left;">
													<hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithTax']}" displayOneLine="true" componentWidth="100" labelWidth="70">
                                                    	<h:outputText 
													       value="#{userAccountBean.getOpenBalanceWithTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code,userAccountBean.entity.code,null,null)}" />
                                                    </hftl:decorateFormField>
													<hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithoutTax']}" displayOneLine="true" componentWidth="100" labelWidth="70" newLine="true" >
    													<h:outputText
    														value="#{userAccountBean.getOpenBalanceWithoutTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code
    													,userAccountBean.entity.code,null,null)}" />
                                                    </hftl:decorateFormField>
												</p:fieldset>
												<p:fieldset legend="#{messages['walletOperationStatus.reserved']}"  rendered="#{wallet.key!='PREPAID'}"  style="width: 25%; float:left;">
													<hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithTax']}" displayOneLine="true" componentWidth="100" labelWidth="70">
    													<h:outputText 
    														value="#{userAccountBean.getReservedBalanceWithTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code
    													,userAccountBean.entity.code,null,null)}" />
													</hftl:decorateFormField>
													<hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithoutTax']}" displayOneLine="true" componentWidth="100" labelWidth="70" newLine="true">
    													<h:outputText 
    														value="#{userAccountBean.getReservedBalanceWithoutTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code
    													,userAccountBean.entity.code,null,null)}" />
                                                    </hftl:decorateFormField>
												</p:fieldset>
												<p:fieldset legend="#{messages['walletOperationStatus.current']}" rendered="#{wallet.key!='PREPAID'}"  style="width: 25%; float:left;">
													<hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithTax']}" displayOneLine="true" componentWidth="100" labelWidth="70">
    													<h:outputText 
    														value="#{userAccountBean.getCurrentBalanceWithTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code
    													,userAccountBean.entity.code,null,null)}" />
                                                    </hftl:decorateFormField>
                                                    <hftl:decorateFormField label="#{messages['pricePlanMatrix.amountWithoutTax']}" displayOneLine="true" componentWidth="100" labelWidth="70" newLine="true">
    													<h:outputText 
    														value="#{userAccountBean.getCurrentBalanceWithoutTax(userAccountBean.getCurrentProvider(),userAccountBean.entity.billingAccount.customerAccount.customer.seller.code
    													,userAccountBean.entity.code,null,null)}" />
                                                    </hftl:decorateFormField>
												</p:fieldset>
											<p:fieldset legend="#{messages['userAccount.cachedBalance']}" rendered="#{wallet.key!='PRINCIPAL'}"  style="float:left;">
												<hftl:decorateFormField label="#{messages['userAccount.cachedBalance']}" style="width:45%;" displayOneLine="true">
        											<h:outputText
        												value="#{userAccountBean.getBalance(wallet.value)}" />
                                                </hftl:decorateFormField>
												<hftl:decorateFormField label="#{messages['userAccount.cachedReservedBalance']}" style="width:55%;" displayOneLine="true">
        											<h:outputText
        												value="#{userAccountBean.getReservedBalance(wallet.value)}" />
                                                </hftl:decorateFormField> 
											</p:fieldset>
										
										<p:dataTable id="wallet#{wallet.key}datatable" var="e"
											paginator="true" resizableColumns="true"
											value="#{userAccountBean.getWalletOperations(wallet.key)}"
											rows="10" rowKey="#{e.id}" widget="walletOperationsTable" styleClass="verticalSpaceSmall">
											<p:column>
												<f:facet name="header">
													<h:outputText
														value="#{messages['walletOperation.operationDate']}" />
												</f:facet>
												<c:set var="converter1"
													value="#{getConverter.forType(e[operationDate], 'date')}"></c:set>
												<h:outputText value="#{e.operationDate}"
													converter="#{converter1}" />
											</p:column>
											<p:column>
												<f:facet name="header">
													<h:outputText
														value="#{messages['walletOperation.endDate']}" />
												</f:facet>
												<c:set var="converter2"
													value="#{getConverter.forType(e[endDate], 'date')}"></c:set>
												<h:outputText value="#{e.endDate}" converter="#{converter2}" />
											</p:column>
											<p:column filterBy="#{e.chargeInstance.code}"
												footerText="contains" filterMatchMode="contains">
												<f:facet name="header">
													<h:outputText value="#{messages['chargeInstance.code']}" />
												</f:facet>
												<h:outputText value="#{e.chargeInstance.code}" />
											</p:column>
											<p:column>
												<f:facet name="header">
													<h:outputText
														value="#{messages['walletOperation.quantity']}" />
												</f:facet>
												<h:outputText value="#{e.quantity}"
													converter="bigDecimal4DigitsConverter" />
											</p:column>

											<p:column>
												<f:facet name="header">
													<h:outputText
														value="#{messages['walletOperation.amountWithoutTax']}" />
												</f:facet>
												
												<h:outputText value="#{e.amountWithoutTax}"
													converter="bigDecimal12DigitsConverter" />
											</p:column>

											<p:column>
												<f:facet name="header">
													<h:outputText
														value="#{messages['walletOperation.amountWithTax']}" />
												</f:facet>
												
												<h:outputText value="#{e.amountWithTax}"
													converter="bigDecimal12DigitsConverter" />
											</p:column>
											<p:column filterBy="#{e.status}"
												headerText="#{messages['walletOperation.status']}"
												footerText="exact" filterMatchMode="exact"
												filterOptions="#{userAccountBean.walletOperationStatusList}">
												<h:outputText value="#{messages[e.status.label]}" />
											</p:column>
										</p:dataTable>
										<!-- <p:commandButton rendered="#{wallet.key!='PRINCIPAL'}"
											value="#{messages['action.reload']}"
											update=":#{p:component('reloadPopup')}"
											actionListener="#{userAccountBean.setSelectedWalletCode(wallet.key)}"
											oncomplete="PF('dlg_reloadPopup').show()" /> -->
									</p:panel>
								</p:tab>
							</c:forEach>

							<p:tab title="#{messages['counterPeriod.title']}" id="tab#{3+userAccountBean.entity.prepaidWallets.size}"
								rendered="#{userAccountBean.entity.id!=null}">
									<hftl:decorateFormField fieldId="counterPeriod" label="#{messages['counterInstance.title']}" >
										<p:selectOneMenu id="counterPeriod"
											converter="omnifaces.SelectItemsConverter"
											value="#{userAccountBean.selectedCounterInstance}">
											<f:selectItem itemLabel="#{messages['commons.select']}" />
											<f:selectItems value="#{userAccountBean.entity.counters.keySet().toArray()}" var="c" itemLabel="#{c}" itemValue="#{userAccountBean.entity.counters.get(c)}"/>
											<p:ajax event="valueChange"
												update=":userAccountFormPanel:formId:userAccountTab:counters" />
										</p:selectOneMenu>
									</hftl:decorateFormField>
								<p:panel id="counters">
									
										<hftl:decorateFormField fieldId="uaDescription" label="#{messages['businessEntity.description']} :" >
											<h:outputText id="uaDescription"
												value="#{userAccountBean.selectedCounterInstance.description}" />
                                        </hftl:decorateFormField>
										<hftl:decorateFormField fieldId="uaCounterCode" label="#{messages['counterTemplate.title']} :" >
											<h:outputText id="uaCounterCode"
												value="#{userAccountBean.selectedCounterInstance.counterTemplate.code}" />
									   </hftl:decorateFormField>
									<hftl:dataList resultsId="datatable_counters"
										backingBean="#{counterPeriodBean}"
										dataModel="#{counterPeriodBean.getCounterPeriods(userAccountBean.selectedCounterInstance)}"
									    sortBy="periodStartDate"
										sortOrder="DESCENDING">
										<hftl:column label="#{messages['businessEntity.code']}"
											field="code" />
										<hftl:column label="#{messages['businessEntity.description']}"
											field="description" />
										<hftl:column
											label="#{messages['counterTemplate.counterType']}"
											field="counterType.label" isMessage="true" />
										<hftl:column
											label="#{messages['counterPeriod.periodStartDate']}"
											field="periodStartDate" isDate="true" />
										<hftl:column
											label="#{messages['counterPeriod.periodEndDate']}"
											field="periodEndDate" isDate="true" />
										<hftl:column label="#{messages['counterPeriod.level']}"
											field="level" converterParam="4digits" wrapHeader="true" />
										<hftl:column label="#{messages['counterPeriod.value']}"
											field="value" converterParam="4digits" wrapHeader="true" />
									</hftl:dataList>
								</p:panel>
							</p:tab>
						</p:tabView>
                        
                        <f:facet name="buttons">

                            <h:panelGroup rendered="#{not empty userAccountBean.entity.id}">
                                <div class="action-buttons">    
                                    <p:button outcome="addNewSubscription"
                                        value="#{messages['userAccount.addNewSubscription']}"
                                        disabled="#{userAccountBean.entity.status.toString() != 'ACTIVE'}">
<!--                                                                        <f:param name="cid" value="#{javax.enterprise.context.conversation.id}" /> -->
                                    </p:button>
                                    <p:commandButton value="#{messages['button.terminateButton']}"
                                        oncomplete="PF('dlg_userAccountTerminationPopup').show()"
                                        disabled="#{userAccountBean.entity.status.toString() != 'ACTIVE'}" />
                                    <p:commandButton action="#{userAccountBean.cancelAccount()}"
                                        value="#{messages['button.cancelButton']}" immediate="true"
                                        onclick="if(confirm('#{messages['confirmationMessage.confirmCancellation']}')){return true;}else{return false;}"
                                        disabled="#{userAccountBean.entity.status.toString() != 'ACTIVE'}" />
                                    <p:commandButton action="#{userAccountBean.reactivateAccount()}"
                                        value="#{messages['button.reactivateButton']}" immediate="true"
                                        onclick="if(confirm('#{messages['confirmationMessage.confirmReactivation']}')){return true;}else{return false;}"
                                        disabled="#{userAccountBean.entity.status.toString() != 'TERMINATED' or userAccountBean.entity.status.toString()!='ACTIVE'}" />
                                    <!--<p:commandButton type="button"
                                        value="#{messages['walletOperationPopup.button']}"
                                        onclick="PF('dlg_walletOperationPopup').show();" />
                                     <p:commandButton type="button"
                                    value="#{messages['ratedTransactionInvoiced.button']}"
                                    onclick="PF('dlg_ratedTransactionsInvoicedPopup').show();" /> -->
                                    <!--                            </custom:listPanel> -->                                
                                </div>
                                
                            </h:panelGroup>                    
                        </f:facet>
					</hf:formPanel>

            </h:panelGroup>
        </h:panelGroup>

		<p:dialog id="userAccountTerminationPopup"
			header="#{messages['userAccount.accountTermination']}"
			widgetVar="dlg_userAccountTerminationPopup" dynamic="false"
			width="400">
			<hf:formPanel edit="true" backingBean="#{userAccountBean}"
				styleClass="formPanel" formId="termFrm" showFormButtons="false"
				useCustomIdParam="true">
					<hf:formField label="#{messages['serviceInstance.code']}"
						field="code" size="50" edit="false" />
					<hf:formField
						label="#{messages['serviceInstance.terminationDate']}"
						field="terminationDate" required="true" edit="true" />
					<hf:formField label="Motifs " field="terminationReason"
						valueLabelField="description" required="true"  edit="true"
						listElements="#{subscriptionTerminationReasonService.listReasons()}" />
					<f:facet name="buttons">
						<p:commandButton action="#{userAccountBean.terminateAccount()}"
							value="#{messages['button.terminateButton']}"
							onsuccess="PF('dlg_userAccountTerminationPopup').hide()"
							update=":userAccountFormPanel:formId">
						</p:commandButton>
						<p:commandButton immediate="true"
							onclick="PF('dlg_userAccountTerminationPopup').hide()"
							value="#{messages['management.close']}" />
					</f:facet>
			</hf:formPanel>
		</p:dialog>
        
	</ui:define>

</ui:composition>
