  -- crm customer procedure 
CREATE OR REPLACE PROCEDURE insert_crm_customer(param_max_customers integer)
language plpgsql
AS $$
declare 
    counter integer := 0;
	var_seller_id integer := 15;
	var_customer_brand_id integer :=-1;
	var_customer_category_id integer := -2;
	var_billing_cycle_id integer := -1;
	var_offer_id integer :=1;
	var_offer_code varchar :='OF_BASIC';
	var_oss_charge_id integer :=4;
	var_oss_charge_code varchar := 'ISCAT_OSS';
	var_ost_charge_id integer :=5;
	var_rec_charge_id integer :=2;
	var_rec_charge_code varchar := 'ISCAT_REC';
	var_usg_charge_id integer :=3;
	var_service_template_id integer :=1;
	var_trading_country_id integer :=1;
	var_trading_currency_id integer :=1;
	var_tax_id integer := 1;
	var_tax_class_id integer := 1;
	var_tax_cat_id integer := 1;
	var_currency_id integer := 1;
	var_invoice_subcat_id integer :=1;
	var_foo integer :=0;
	var_bc_id integer := 1;
	var_title_id integer := -3;
	var_rec_cal_id integer := 1;
	var_customer_iterations integer := 1;
	var_max_cust_id integer := 1;
begin

	create sequence IF NOT EXISTS perf_parent_entity_seq;
	create sequence IF NOT EXISTS perf_parent_entity2_seq;
	create sequence IF NOT EXISTS perf_account_seq;
	create sequence IF NOT EXISTS perf_account2_seq;

 	update billing_invoice set recorded_invoice_id = null;
	delete from ar_account_operation;
	delete from billing_rated_transaction;
	delete from billing_invoice_agregate;
	delete from billing_invoice;
	delete from billing_wallet_operation;
	delete from billing_chrginst_wallet;
	delete from BILLING_CHARGE_INSTANCE;
	delete from billing_service_instance;
	delete from medina_access;
	delete from rating_cdr;
	delete from rating_edr;
	delete from billing_subscription;
	update billing_user_account set wallet_id=null;
	delete from billing_wallet;
	delete from billing_user_account;
	delete from billing_billing_account ;
	delete from ar_payment_token;
	delete from ar_customer_account;
	delete from crm_customer;	
	delete from account_entity where account_type!='ACCT_S';
	delete from job_execution;
	delete from billing_billing_run;
	delete from audit_log;
	
	select max(id) into var_seller_id from crm_seller;
	select id into var_offer_id from cat_offer_template where code='OF_BASIC';
	select id into var_title_id from adm_title where code='MR';
	select id into var_service_template_id from cat_service_template where code='SE_OSS_OST_USG_RECU';
	select id into var_oss_charge_id from cat_charge_template where code='CH_OSS';
	select id into var_ost_charge_id from cat_charge_template where code='CH_OST';
	select id into var_rec_charge_id from cat_charge_template where code='CH_REC_BUILD_RUN_ADV';
	select id into var_usg_charge_id from cat_charge_template where code='CH_USG_UNIT';
	select max(id) into var_trading_currency_id from billing_trading_currency;
	select max(id) into var_trading_country_id from billing_trading_country;
	select id into var_tax_id from billing_tax where code='TAX_10';
	select id into var_tax_cat_id from billing_tax_category where code='REGULAR';
	select id into var_tax_class_id from billing_tax_class where code='NORMAL';
	select id into var_currency_id from adm_currency where currency_code='EUR';
	select id into var_bc_id from billing_cycle where code='INV_MT_1';
	-- select max(id) into var_invoice_subcat_id from billing_invoice_sub_cat;
	select id into var_rec_cal_id from cat_calendar where code='CAL_MONTHLY_1ST';

	select ceil(log(2,param_max_customers)) into var_customer_iterations;
	
	select setval('perf_account_seq', (select max(id)+1 from account_entity), false) into var_foo;
	select setval('perf_parent_entity_seq', (select min(id) from crm_customer), false) into var_foo;

	INSERT INTO account_entity(id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode, default_level, external_ref_1, external_ref_2, firstname, lastname, provider_contact, creator, updater, title_id, primary_contact, account_type, uuid, bam_id, cf_values, job_title, email, fax, mobile, phone, vat_no, registration_no, minimum_amount_el, minimum_label_el, minimum_amount_el_sp, minimum_label_el_sp, minimum_charge_template_id)
	(select nextval('account_entity_seq'),0,now(),null,'cust_'||currval('account_entity_seq'),'Demo Distributor',null,null,null,null,null,null,null,1,null,null,'firstname_'||currval('account_entity_seq'),'lastname_'||currval('account_entity_seq'),null,null,null,var_title_id,null,'ACCT_CUST','cust_'||currval('account_entity_seq')||currval('account_entity_seq'),null,null,null,null,null,null,null,null,null,null,null,null,null,null);

	INSERT INTO crm_customer
	(id, customer_brand_id, customer_category_id, seller_id, additional_details_id, address_book_id,minimum_target_account_id,invoicing_threshold, check_threshold,threshold_per_entity)
	select ae.id, var_customer_brand_id, var_customer_category_id, var_seller_id, null, null, null, null, null, 0 from account_entity ae where account_type='ACCT_CUST' and ae.id not in (select id from crm_customer);
       
	   
   while counter < var_customer_iterations loop
        INSERT INTO account_entity(id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode, default_level, external_ref_1, external_ref_2, firstname, lastname, provider_contact, creator, updater, title_id, primary_contact, account_type, uuid, bam_id, cf_values, job_title, email, fax, mobile, phone, vat_no, registration_no, minimum_amount_el, minimum_label_el, minimum_amount_el_sp, minimum_label_el_sp, minimum_charge_template_id)
        (select nextval('account_entity_seq'),0,now(),null,'cust_'||currval('account_entity_seq'),'Demo Distributor',null,null,null,null,null,null,null,1,null,null,'firstname_'||currval('account_entity_seq'),'lastname_'||currval('account_entity_seq'),null,null,null,var_title_id,null,'ACCT_CUST','cust_'||currval('account_entity_seq')||currval('account_entity_seq'),null,null,null,null,null,null,null,null,null,null,null,null,null,null from crm_customer);
        
		INSERT INTO crm_customer
		(id, customer_brand_id, customer_category_id, seller_id, additional_details_id, address_book_id,minimum_target_account_id,invoicing_threshold, check_threshold,threshold_per_entity)
		select ae.id, var_customer_brand_id, var_customer_category_id, var_seller_id, null, null, null, null, null, 0 from account_entity ae where account_type='ACCT_CUST' and ae.id not in (select id from crm_customer);
        counter := counter + 1;
   end loop;


	-- Remove customers exceeding the number needed
       	select max(cust.id) into var_max_cust_id from (select id from crm_customer order by id limit param_max_customers) cust;

       	delete from crm_customer where id > var_max_cust_id;
       	delete from account_entity where id > var_max_cust_id;

	select setval('account_entity_seq', (select max(id)+1 from account_entity), false) into var_foo;

	-- "ACCT_CA"

	select setval('perf_account_seq', (select max(id)+1 from account_entity), false) into var_foo;
	select setval('perf_parent_entity_seq', (select min(id) from crm_customer), false) into var_foo;

	INSERT INTO account_entity(id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode, default_level, external_ref_1, external_ref_2, firstname, lastname, provider_contact, creator, updater, title_id, primary_contact, account_type, uuid, bam_id, cf_values, job_title, email, fax, mobile, phone, vat_no, registration_no, minimum_amount_el, minimum_label_el, minimum_amount_el_sp, minimum_label_el_sp, minimum_charge_template_id) 
	(select nextval('account_entity_seq'),0,now(),null,'ca_'||currval('account_entity_seq'),'Demo Distributor',null,null,null,null,null,null,null,1,null,null,'firstname_'||currval('account_entity_seq'),'lastname_'||currval('account_entity_seq'),null,null,null,var_title_id,null,'ACCT_CA','ca_'||currval('account_entity_seq')||currval('account_entity_seq'),null,null,null,null,null,null,null,null,null,null,null,null,null,null from crm_customer);

	INSERT INTO ar_customer_account(id, date_dunning_level, date_status, dunning_level, status, customer_id, trading_currency_id, trading_language_id, credit_category_id, due_date_delay_el, due_date_delay_el_sp, excluded_from_payment, crm_address_book_id, minimum_target_account_id, invoicing_threshold, check_threshold, threshold_per_entity)
	(select nextval('perf_account_seq'),NOW(),NOW(),'R0','ACTIVE',nextval('perf_parent_entity_seq'),-2,-2,null,null,null,0,null,null,null,null,0 from crm_customer);

    	INSERT INTO ar_payment_token (id, version, created, updated, disabled, alias, is_default, bank_name, bank_code ,account_number,iban, bic,mandate_date,mandate_identification, customer_account_id, token_type)
	(select nextval('ar_payment_token_seq'), 0, now(), now(), 0, 'SEPA', 1,'Some Bank','12456','...','FR123456789123456789','BDNFR123456',TO_DATE('2020-01-10','YYYY-MM-DD'),'G', ca.id, 'DIRECTDEBIT' from ar_customer_account ca); 


	-- "ACCT_BA"
	select setval('perf_account_seq', (select max(id)+1 from account_entity), false) into var_foo;
	select setval('perf_parent_entity_seq', (select min(id) from ar_customer_account), false) into var_foo;

	INSERT INTO account_entity(id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode, default_level, external_ref_1, external_ref_2, firstname, lastname, provider_contact, creator, updater, title_id, primary_contact, account_type, uuid, bam_id, cf_values, job_title, email, fax, mobile, phone, vat_no, registration_no, minimum_amount_el, minimum_label_el, minimum_amount_el_sp, minimum_label_el_sp, minimum_charge_template_id) 	(select nextval('account_entity_seq'),0,now(),null,'ba_'||currval('account_entity_seq'),'Demo Distributor',null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,'ACCT_BA','ba_'||currval('account_entity_seq')||currval('account_entity_seq'),null,null,null,null,null,null,null,null,null,null,null,null,null,null from crm_customer);

	INSERT INTO billing_billing_account(id, br_amount_with_tax, br_amount_without_tax, discount_rate, electronic_billing, invoice_prefix, next_invoice_date, status, status_date, subscription_date, termination_date, billing_cycle, billing_run, customer_account_id, termin_reason_id, trading_country_id, trading_language_id, invoicing_threshold, mailing_type, cced_emails, email_template_id, minimum_invoice_sub_category_id, tax_category_id, check_threshold, payment_method_id, threshold_per_entity) 
	(select nextval('perf_account_seq'), null, null, null, 0, 'test', now() ,'ACTIVE', NOW(), TO_DATE('2021-03-01','YYYY-MM-DD'), null, var_bc_id, null, nextval('perf_parent_entity_seq'), null, -2, -2, null, null, null, null, null, var_tax_cat_id, null, null, 0 from crm_customer);



	-- "ACCT_UA"
	select setval('perf_account_seq', (select max(id)+1 from account_entity), false) into var_foo;
	select setval('perf_account2_seq', (select max(id)+1 from account_entity), false) into var_foo;
	select setval('perf_parent_entity_seq', (select min(id) from billing_billing_account), false) into var_foo;

	INSERT INTO account_entity(id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode, default_level, external_ref_1, external_ref_2, firstname, lastname, provider_contact, creator, updater, title_id, primary_contact, account_type, uuid, bam_id, cf_values, job_title, email, fax, mobile, phone, vat_no, registration_no, minimum_amount_el, minimum_label_el, minimum_amount_el_sp, minimum_label_el_sp, minimum_charge_template_id) 
	(select nextval('account_entity_seq'),0,now(),null,'ua_'||currval('account_entity_seq'),'Demo Distributor',null,null,null,null,null,null,null,1,null,null,null,null,null,null,null,null,null,'ACCT_UA','ua_'||currval('account_entity_seq')||currval('account_entity_seq'),null,null,null,null,null,null,null,null,null,null,null,null,null,null from crm_customer);

	INSERT INTO billing_user_account(id,status, status_date, subscription_date, termination_date, billing_account_id, termin_reason_id, wallet_id)
	  (select  nextval('perf_account_seq'), 'ACTIVE', NOW(), NOW(), null, nextval('perf_parent_entity_seq'), null, null from crm_customer);

	INSERT INTO billing_wallet(id,version,created, updated, code, description,user_account_id)
		(select nextval('perf_account2_seq'), 0, now(), now(), 'PRINCIPAL',null, currval('perf_account2_seq') from crm_customer);

	update 	billing_user_account set wallet_id=id;


	-- "Subscriptions"

	insert into billing_subscription (id, version, created, updated, code, description, subscription_date, user_account_id, uuid, seller_id, offer_id, auto_renew, initial_term_type, renewal_term_type, status, status_date)
	(select nextval('billing_subscription_seq'), 0, now(), now(), 'sub_'||currval('billing_subscription_seq'), null, date_trunc('month', now()) - interval '1 month', ua.id,'sub_'||currval('billing_subscription_seq'),var_seller_id,var_offer_id,0,'RECURRING','RECURRING','ACTIVE', now() from billing_user_account ua);


	insert into medina_access (id, version, disabled, acces_user_id, end_date, start_date, subscription_id, uuid, creator, updater, created, updated, cf_values)
	(select nextval('medina_access_seq'), 0, 0, 'acc_'||currval('medina_access_seq'), null, null, sub.id, 'acc_'||currval('medina_access_seq'), null, null, now(), null, null from billing_subscription sub );

	-- "Service instantiation" 

	INSERT INTO BILLING_SERVICE_INSTANCE (id, version,description, created, code, quantity, status, status_date, subscription_date, service_template_id, subscription_id, uuid, cf_values) 
	(select nextval('billing_service_instance_seq'),0,null, NOW(),'SE_OSS_OST_USG_RECU', 2, 'ACTIVE', now(),date_trunc('month', now()) - interval '1 month',var_service_template_id,id,'serv'||currval('billing_service_instance_seq'),null from billing_subscription);



	-- For subscription charge:
	select setval('perf_parent_entity_seq', (select min(id) from BILLING_SERVICE_INSTANCE), false) into var_foo;

	INSERT INTO BILLING_CHARGE_INSTANCE(id, version, created, code, description,  is_prepaid, status, status_date, charge_template_id, trading_country, trading_currency, seller_id, subscription_id, user_account_id, charge_type, quantity, service_instance_id, uuid, calendar_id, apply_in_advance, subscription_date, charge_date, next_charge_date, charged_to_date, priority)
	(select nextval('billing_charge_instance_seq'), 0, NOW(), 'CH_OSS', null,  0, 'CLOSED', NOW(), var_oss_charge_id,var_trading_country_id, var_trading_currency_id,var_seller_id,sub.id, sub.user_account_id,'S', 2,  serv.id, 'ch_'||currval('billing_charge_instance_seq'), null, 1,sub.subscription_date, sub.subscription_date, null, null, 1 from BILLING_SERVICE_INSTANCE serv join billing_subscription sub on serv.subscription_id=sub.id);

	-- For Subscription charge wallet operation
	select id into var_invoice_subcat_id from billing_invoice_sub_cat where code = var_oss_charge_code;
	
	insert into billing_wallet_operation (id, version, accounting_code_id, amount_tax, amount_with_tax, amount_without_tax, cf_values, charge_instance_id, code, counter_id, created, currency_id, description, edr_id, end_date, input_quantity, input_unit_description, input_unitofmeasure, invoice_sub_category_id, invoicing_date, offer_code, offer_id, operation_date, order_number, parameter_1, parameter_2, parameter_3, parameter_extra, priceplan_id, quantity, rated_transaction_id, rating_unit_description, rating_unitofmeasure, raw_amount_with_tax, raw_amount_without_tax, reject_reason, reratedWalletOperation_id, seller_id, service_instance_id, sort_index, start_date, status, subscription_id, subscription_date, tax_id, tax_class_id, tax_percent, credit_debit_flag, unit_amount_tax, unit_amount_with_tax, unit_amount_without_tax, updated, uuid, wallet_id, operation_type) 
	(select nextval('billing_wallet_operation_seq'), 0, null, 2, 12, 10, null, ch.id, ch.code, null, now(), var_currency_id, ch.description, null, null, null, null, null, var_invoice_subcat_id, null, var_offer_code, var_offer_id, date_trunc('month', now()) - interval '1 month', null, null, null, null, null, null, ch.quantity, null, null, null, null, null, null, null, var_seller_id, ch.service_instance_id, 0, null, 'OPEN', ch.subscription_id, ch.subscription_date, var_tax_id, var_tax_class_id, 0, 'DEBIT', 1, 6, 5, null, 'wo_'||currval('billing_wallet_operation_seq'),ch.user_account_id, 'W' from billing_charge_instance ch where ch.code = 'CH_OSS');


	-- For recurring charge: 
	

	INSERT INTO BILLING_CHARGE_INSTANCE(id, version, created, code, description,  is_prepaid, status, status_date, charge_template_id, trading_country, trading_currency, seller_id, subscription_id, user_account_id, charge_type, quantity, service_instance_id, uuid, calendar_id, apply_in_advance,  subscription_date, charge_date, next_charge_date, charged_to_date, priority)
	(select nextval('billing_charge_instance_seq'), 0, NOW(), 'CH_REC_BUILD_RUN_ADV', null,  0, 'ACTIVE', NOW(), var_rec_charge_id,var_trading_country_id, var_trading_currency_id,var_seller_id,sub.id, sub.user_account_id,'R', 2,  serv.id, 'ch_'||currval('billing_charge_instance_seq'), var_rec_cal_id, 1,sub.subscription_date, sub.subscription_date, now(), now(), 1 from BILLING_SERVICE_INSTANCE serv join billing_subscription sub on serv.subscription_id=sub.id);

	-- For recurring charge wallet operation
	select id into var_invoice_subcat_id from billing_invoice_sub_cat where code = var_rec_charge_code;
		
	insert into billing_wallet_operation (id, version, accounting_code_id, amount_tax, amount_with_tax, amount_without_tax, cf_values, charge_instance_id, code, counter_id, created, currency_id, description, edr_id, end_date, input_quantity, input_unit_description, input_unitofmeasure, invoice_sub_category_id, invoicing_date, offer_code, offer_id, operation_date, order_number, parameter_1, parameter_2, parameter_3, parameter_extra, priceplan_id, quantity, rated_transaction_id, rating_unit_description, rating_unitofmeasure, raw_amount_with_tax, raw_amount_without_tax, reject_reason, reratedWalletOperation_id, seller_id, service_instance_id, sort_index, start_date, status, subscription_id, subscription_date, tax_id, tax_class_id, tax_percent, credit_debit_flag, unit_amount_tax, unit_amount_with_tax, unit_amount_without_tax, updated, uuid, wallet_id, operation_type) 
	(select nextval('billing_wallet_operation_seq'), 0, null, 2, 12, 10, null, ch.id, ch.code, null, now(), var_currency_id, ch.description, null, null, null, null, null, var_invoice_subcat_id, null, var_offer_code, var_offer_id, date_trunc('month', now()) - interval '1 month', null, null, null, null, null, null, ch.quantity, null, null, null, null, null, null, null, var_seller_id, ch.service_instance_id, 0, null, 'OPEN', ch.subscription_id, ch.subscription_date, var_tax_id, var_tax_class_id, 0, 'DEBIT', 1, 6, 5, null, 'wo_'||currval('billing_wallet_operation_seq'),ch.user_account_id, 'W' from billing_charge_instance ch  where ch.code = 'CH_REC_BUILD_RUN_ADV');
 
	-- For usage charge:

	INSERT INTO BILLING_CHARGE_INSTANCE(id, version, created, code, description,  is_prepaid, status, status_date, charge_template_id, trading_country, trading_currency, seller_id, subscription_id, user_account_id, charge_type, quantity, service_instance_id, uuid, calendar_id, apply_in_advance,  subscription_date, charge_date, next_charge_date, charged_to_date, priority)
	(select nextval('billing_charge_instance_seq'), 0, NOW(), 'CH_USG_UNIT', null,  0, 'ACTIVE', NOW(), var_usg_charge_id,var_trading_country_id, var_trading_currency_id,var_seller_id,sub.id, sub.user_account_id,'U', 2,  serv.id, 'ch_'||currval('billing_charge_instance_seq'), null, 1,sub.subscription_date, sub.subscription_date, null, null, 1 from BILLING_SERVICE_INSTANCE serv join billing_subscription sub on serv.subscription_id=sub.id);

	-- For termination charge:

	INSERT INTO BILLING_CHARGE_INSTANCE(id, version, created, code, description,  is_prepaid, status, status_date, charge_template_id, trading_country, trading_currency, seller_id, subscription_id, user_account_id, charge_type, quantity, service_instance_id, uuid, calendar_id, apply_in_advance,  subscription_date, charge_date, next_charge_date, charged_to_date, priority)
	(select nextval('billing_charge_instance_seq'), 0, NOW(), 'CH_OST', null,  0, 'INACTIVE', NOW(), var_ost_charge_id,var_trading_country_id, var_trading_currency_id,var_seller_id,sub.id, sub.user_account_id,'T', 2,  serv.id, 'ch_'||currval('billing_charge_instance_seq'), null, 1, sub.subscription_date, sub.subscription_date, null, null, 1 from BILLING_SERVICE_INSTANCE serv join billing_subscription sub on serv.subscription_id=sub.id);


end$$;


