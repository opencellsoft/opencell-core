<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

	<!--  For Media post -->

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-seq">
		<createSequence sequenceName="cpq_product_seq" />
		<createSequence sequenceName="cpq_product_line_seq" />
		<createSequence sequenceName="cpq_product_version_seq" />
		<createSequence sequenceName="cpq_tag_seq" />
		<createSequence sequenceName="cpq_tag_filter_seq" />
		<createSequence sequenceName="cpq_tag_type_seq" />
		<createSequence sequenceName="cpq_media_seq" />
		<createSequence sequenceName="cpq_offer_component_seq" />
		<createSequence sequenceName="cpq_commercial_rule_header_seq" />
		<createSequence sequenceName="cpq_commercial_rule_item_seq" />
		<createSequence sequenceName="cpq_commercial_rule_line_seq" />
		<createSequence sequenceName="cpq_grouped_service_seq" />
		<createSequence sequenceName="cpq_product_mapping_seq" />
		<createSequence sequenceName="cpq_accounting_article_seq" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-01">
		<createTable tableName="cpq_product">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="status" type="varchar(255)" />
			<column name="status_date" type="datetime" />
			<column name="product_line_id" type="bigint" />
			<column name="customer_brand_id" type="bigint" />
			<column name="reference" type="varchar(50)"/>
			<column name="model" type="varchar(20)"/>
			<column name="discount_flag" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="package_flag" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
            <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</createTable>
	</changeSet>




	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-04">
		<createTable tableName="cpq_product_line">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_line_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="long_description" type="text" />

			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="seller_id" type="bigint" />
			<column name="parent_line" type="bigint" />
		</createTable>
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-05">
		<createTable tableName="cpq_product_version">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_version_pkey" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="version" type="int4" />
			<column name="status" type="varchar(255)" />
			<column name="status_date" type="datetime" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="short_description" type="varchar(255)" />
			<column name="long_description" type="text" />
			<column name="start_date" type="datetime" />
			<column name="end_date" type="datetime" />
			<column name="product_id" type="bigint" >
				<constraints nullable="false" />
			</column>
			<column name="current_version" type="int4" >
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-06">
		<createTable tableName="cpq_tag">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="seller_id" type="bigint" />
			<column name="name" type="varchar(255)" />
			<column name="tag_type_id" type="bigint" />
			<column name="parent_tag_id" type="bigint" />
			<column name="filter_el" type="varchar(2000)"/>
			 <column name="attribute_id" type="bigint" />
		</createTable>
	</changeSet>



	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-07">
		<createTable tableName="cpq_tag_filter">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_filter_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="tag_id" type="bigint" />
			<column name="operator" type="varchar(255)" />
			<column name="entity" type="varchar(255)" />
			<column name="field" type="varchar(255)" />
			<column name="comparaison" type="varchar(255)" />
			<column name="value" type="varchar(255)" />
		</createTable>
	</changeSet>


	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-08">
		<createTable tableName="cpq_tag_type">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_type_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="seller_id" type="bigint" />
		</createTable>
	</changeSet>



	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-10">
		<createTable tableName="cpq_media">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
							 primaryKeyName="cpq_media_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="offer_id" type="bigint" />
			<column name="product_id" type="bigint" />
			<column name="attribute_id" type="bigint" />
			<column name="service_template_id" type="bigint" />
			<column name="media_name" type="varchar(50)" />
			<column name="label" type="varchar(255)" />
			<column name="main" type="${type.boolean}" defaultValueNumeric="1">
				<constraints nullable="false" />
			</column>
			<column name="media_type" type="varchar(50)" />
			<column name="media_path" type="varchar(50)" />
		</createTable>
	</changeSet>


	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-13">
		<createTable tableName="cpq_offer_component">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
							 primaryKeyName="cpq_offer_component_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="offer_template_id" type="bigint" />
			<column name="product_id" type="bigint" />
		</createTable>
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-14">
		<createTable tableName="cpq_commercial_rule_header">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
							 primaryKeyName="cpq_commercial_rule_header_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="rule_type" type="varchar(50)" />
			<column name="offer_template_id" type="bigint" />
			<column name="product_id" type="bigint" />
			<column name="product_version_id" type="bigint" />
			<column name="grouped_service_id" type="bigint" />
			<column name="service_template_id" type="bigint" />
			<column name="grouped_attributes_id" type="bigint" />
			<column name="attribute_id" type="bigint" />
			<column name="target_attribute_value" type="varchar(255)" />
			<column name="tag_id" type="bigint" />
			<column name="rule_el" type="varchar(2000)" />
		</createTable>
	</changeSet>

	   <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-15">
		<createTable tableName="cpq_commercial_rule_item">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="cpq_commercial_rule_item_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="commercial_rule_header_id" type="bigint" />
			<column name="operator" type="varchar(255)" />
			<column name="rule_item_el" type="varchar(2000)" />
		</createTable>
	</changeSet>


	  <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-16">
		<createTable tableName="cpq_commercial_rule_line">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="cpq_commercial_rule_line_pkey" />
			</column>
			<column name="version" type="int4" />  
			<column name="offer_template_id" type="bigint" />
			<column name="grouped_attributes_id" type="bigint" />
			<column name="commercial_rule_item_id" type="bigint" />
			<column name="product_id" type="bigint" />
			<column name="product_version_id" type="bigint" />
			<column name="attribute_id" type="bigint" />
			<column name="tag_id" type="bigint" />
			<column name="operator" type="varchar(255)" />
			<column name="source_attribute_value" type="varchar(255)" />
			<column name="source_grouped_attribute_value" type="varchar(255)" />
			<column name="value" type="varchar(255)" />
		</createTable>
	</changeSet>



   <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-19">
    <createTable tableName="cpq_offer_component_tags">
        <column name="offer_component_id" type="bigint">
            <constraints nullable="false" />
        </column>
        <column name="tag_id" type="bigint">
            <constraints nullable="false" />
        </column>
    </createTable>
    <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_offer_component_tags_pkey" tableName="cpq_offer_component_tags" />

         <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="offer_component_id"
                                 constraintName="cpq_offer_component_tags_offer_component_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_component_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
   </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-20">
		<createTable tableName="cpq_grouped_service">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="cpq_grouped_service_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="product_version_id" type="bigint" />
			<column name="mandatory" type="${type.boolean}" >
				<constraints nullable="false" />
			</column>
			<column name="display" type="${type.boolean}" >
				<constraints nullable="false" />
			</column>
	        <column name="sequence" type="INT4" />
		</createTable>
	</changeSet>

	 <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-29">
		<createTable tableName="cpq_product_mapping">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
					primaryKeyName="cpq_product_mapping_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="service1Value" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="product_id" type="bigint" />
			<column name="attribute_1" type="bigint" />
			<column name="attribute_1_value" type="varchar(100)" />
			<column name="attribute_2" type="bigint" />
			<column name="attribute_2_value" type="varchar(100)" />
			<column name="attribute_3" type="bigint" />
			<column name="attribute_3_value" type="varchar(100)" />
			<column name="accounting_article_id" type="bigint" />
			<column name="charge_template_id" type="bigint" />

		</createTable>
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-30">
		<createTable tableName="cpq_accounting_article">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"
							 primaryKeyName="cpq_accounting_article_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
		</createTable>
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-01">
		<addForeignKeyConstraint baseColumnNames="product_line_id" baseTableName="cpq_product" constraintName="fk_1y8p1q0o8tw5u0vcodfukdbez" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
	</changeSet>
	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-02">
		<addForeignKeyConstraint baseColumnNames="customer_brand_id" baseTableName="cpq_product" constraintName="fk_5iap1p3o8tw5u0vcodazokdub" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer_brand" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-03">
		<addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_product_line" constraintName="fk_1ykj5q0o8tw5u0vcodpoqljca" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-04">
		<addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag_type" constraintName="fk_9axk5q0o8nddo2vcodpoqlopq" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-05">
		<addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag" constraintName="fk_oop625q0o8tw5u0vcodospq5c" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-06">
		<addForeignKeyConstraint baseColumnNames="parent_line" baseTableName="cpq_product_line" constraintName="fk_bnrqyk9sqqcnt5m298cpbfrqo3" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
								 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-07">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_version" constraintName="fk_pomyp8vq0o8t5u0vcodpoaopq" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-08">
		<addForeignKeyConstraint baseColumnNames="tag_type_id" baseTableName="cpq_tag" constraintName="fk_pomyppo52t5u0vcodpolcm" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag_type" />
	</changeSet> 
	
	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-09">
		<addForeignKeyConstraint baseColumnNames="parent_tag_id" baseTableName="cpq_tag" constraintName="fk_pomjqq6n5u0vcodkopm" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-10">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovooi1" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-11">
		<addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_media" constraintName="fk_op1zppqjdn5vabcipq5" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>


	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-17">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_offer_component" constraintName="fk_sspl5q1jj6jdakklqp" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>



	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-19">
		<addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_iw510u1o6ndaphf4" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-20">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_ii50ihu1qzsqikh2bo" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-21">
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_nh50ihuoo32sqijo5v" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-22">
		<addForeignKeyConstraint baseColumnNames="commercial_rule_item_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_rule_item_rule_line" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_item" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-23">
		<addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_nhi85o6nnipl087" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_commercial_rule_header_rule_item">
        <addForeignKeyConstraint baseColumnNames="commercial_rule_header_id" baseTableName="cpq_commercial_rule_item" constraintName="fk_commercial_rule_header_rule_item" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_header" />
     </changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-24">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_ggi871iihn0ii77" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-25">
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_omk25ihukik058ijj20" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-26">
		<addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_hhokb05o32yhp50" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
	</changeSet>

	<changeSet author="Rachid-Ay" id="rebuild-mediapost-fk-28">
		<addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovoo52" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	</changeSet>

	<changeSet id="21112020-540-23-entity-quoteCustomerService" author="TarikFAKHOURI">
		<createTable tableName="cpq_quote_lot">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_lot_pkey" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />

			<column name="quote_version" type="int4" >
				<constraints nullable="false" />
			</column>
			<column name="name" type="varchar(50)" />
			<column name="duration" type="int4" />
			<column name="execution_date" type="datetime" />
			<column name="cpq_quote_version_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
	</changeSet>




	<changeSet id="21112020-540-23-entity-quoteProduct" author="TarikFAKHOURI">
		<createTable tableName="cpq_quote_product">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_product_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />
			<column name="quote_version_id" type="bigint" />
			<column name="quote_lot_id" type="bigint" />
			<column name="offer_component_id" type="bigint" >
				<constraints nullable="false" />
			</column>
			<column name="product_version_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="quantity" type="numeric(23, 12)" />
			<column name="cpq_quote_id" type="bigint" />
		</createTable>
	</changeSet>

	<changeSet id="21112020-540-23-entity-quoteVersion" author="TarikFAKHOURI">
		<createTable tableName="cpq_quote_version">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_version_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="cpq_quote_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="quote_version" type="int4" >
				<constraints nullable="false"/>
			</column>
			<column name="status" type="varchar(20)"  >
				<constraints nullable="false"/>
			</column>
			<column name="status_date" type="datetime" >
				<constraints nullable="false"/>
			</column>
			<column name="start_date" type="datetime" />
			<column name="end_date" type="datetime" />
			<column name="billing_plan_code" type="varchar(20)" />
		</createTable>
	</changeSet>


	<changeSet id="22112020-540-23-entity-contract" author="TarikFAKHOURI">
		<createTable tableName="cpq_contract">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_pkey" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />

			<column name="seller_id" type="bigint" />
			<column name="billing_account_id" type="bigint" />
			<column name="customer_account_id" type="bigint" />
			<column name="customer_id" type="bigint" />
			<column name="status" type="varchar(20)" >
				<constraints nullable="false" />
			</column>
			<column name="status_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="contract_date" type="date">
				<constraints nullable="false" />
			</column>
			<column name="begin_date" type="date">
				<constraints nullable="false" />
			</column>
			<column name="end_date" type="date">
				<constraints nullable="false" />
			</column>
			<column name="renewal" type="${type.boolean}">
				<constraints nullable="false" />
			</column>
			<column name="contract_duration" type="int4" />
		</createTable>
	</changeSet>


	<changeSet id="22112020-540-23-entity-contract-item" author="TarikFAKHOURI">
		<createTable tableName="cpq_contract_item">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_item_pkey" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" unique="true" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />

			<column name="cpq_contract_id" type="bigint" />
			<column name="offer_template_id" type="bigint" />
			<column name="cpq_product_id" type="bigint" />
			<column name="price_plan_id" type="bigint" />
			<column name="charge_template_id" type="bigint" />
			<column name="service_template_id" type="bigint" />
			<column name="rate" type="int4" />
			<column name="amount_without_tax" type="numeric(23, 12)" />
		</createTable>
	</changeSet>

	<changeSet id="540-30_20201023_PricePlanMatrixItem" author="TarikF">
		<createTable tableName="cpq_price_plan_matrix_item">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_item_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="dim1_value" type="varchar(50)">
				<constraints nullable="false" />
			</column>
			<column name="dim2_value" type="varchar(50)" />
			<column name="dim3_value" type="varchar(50)" />
			<column name="price_without_tax" type="numeric(23, 12)" />
		</createTable>
	</changeSet>

	<changeSet id="540-31_20201023_PricePlanVersion" author="TarikF">
		<createTable tableName="cpq_price_plan_version">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_version_pkey" />
			</column>
			<column name="label" type="varchar(255)" />
			<column name="version" type="int4" />
			<column name="current_version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />
			<column name="ppm_id" type="bigint" />
			<column name="status" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="status_date" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="valid_from" type="datetime" />
			<column name="valid_to" type="datetime" />
			<column name="amount_without_tax" type="numeric(23, 12)" />
			<column name="amount_with_tax" type="numeric(23, 12)" />
			<column name="amount_without_tax_el" type="varchar(255)" />
			<column name="amount_with_tax_el" type="varchar(255)" />
			<column name="is_matrix" type="${type.boolean}"/>
			<column name="priority" type="int4" defaultValueNumeric="0"/>
		</createTable>
	</changeSet>

	<changeSet id="540-15_20201019_servicetype" author="TarikF">
		<createTable tableName="cpq_service_type">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="cpq_service_type_pkey" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />
			<column name="service_type" type="varchar(100)">
				<constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>



	<changeSet id="current-str-fk-32" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_product" constraintName="fk_quote_lot_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
	</changeSet>

	<changeSet id="current-str-fk-33" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="offer_component_id" baseTableName="cpq_quote_product" constraintName="fk_offer_component_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_offer_component" />
	</changeSet>

	<changeSet id="current-str-fk-34" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_quote_product" constraintName="fk_product_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	</changeSet>

	<changeSet id="current-str-fk-43" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_seller_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
	</changeSet>

	<changeSet id="current-str-fk-44" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_billing_account_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
	</changeSet>

	<changeSet id="current-str-fk-45" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_account_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />
	</changeSet>

	<changeSet id="current-str-fk-46" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="customer_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer" />
	</changeSet>


	<changeSet id="current-str-fk-47" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="cpq_contract_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_contract_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />
	</changeSet>
	<changeSet id="current-str-fk-48" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_offer_template_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	</changeSet>
	<changeSet id="current-str-fk-49" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="cpq_product_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_product_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>
	<changeSet id="current-str-fk-50" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="price_plan_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_price_plan_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
	</changeSet>
	<changeSet id="current-str-fk-51" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_charge_template_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
	</changeSet>
	<changeSet id="current-str-fk-52" author="TarikFAKHOURI">
		<addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_service_template_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-28">
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_service" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-29">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_mapping" constraintName="fk-product-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-30">
		<addForeignKeyConstraint baseColumnNames="attribute_1" baseTableName="cpq_product_mapping" constraintName="fk1-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>
	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-31">
		<addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk2-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-32">
		<addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk3-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-33">
		<addForeignKeyConstraint baseColumnNames="attribute_3" baseTableName="cpq_product_mapping" constraintName="fk4-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
	</changeSet>


	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-35">
		<addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_mapping" constraintName="fk-charge_template-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
	</changeSet>

	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-36">
		<addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_tag_filter" constraintName="fk-tag-tag_filter" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
	</changeSet>


	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-40">
		<addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_cpq_tag_rule_line" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
	</changeSet>

	<changeSet author="NabilOuachi" id="rebuild-mediapost-fk-41">
		<addForeignKeyConstraint baseColumnNames="ppm_id" baseTableName="cpq_price_plan_version" constraintName="fk_cpq_price_pla_version_price_plan_matrix" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
	</changeSet>

     <changeSet id="#5595_20201023" author="Mbarek-Ay">
			<addColumn tableName="cat_service_template">
				<column name="offer_template_id" type="bigint" />
			</addColumn>
			<addColumn tableName="cat_service_template">
				<column name="product_id" type="bigint" />
			</addColumn>
			<addColumn tableName="cat_service_template">
				<column name="grouped_service_id" type="bigint" />
			</addColumn>
			<addColumn tableName="cat_service_template">
				<column name="service_type_id" type="bigint" />
			</addColumn>
			<addColumn tableName="cat_service_template">
				<column name="mandatory" type="${type.boolean}" />
			</addColumn>

			<addColumn tableName="cat_service_template">
				<column name="priority" type="int4" defaultValueNumeric="0" />
			</addColumn>

			<addColumn tableName="cat_service_template">
				<column name="param" type="text" />
			</addColumn>

			<addColumn tableName="cat_service_template">
				<column name="material" type="${type.boolean}" />
			</addColumn>

			<addColumn tableName="cat_service_template">
				<column name="accounting_article_id" type="bigint" />
			</addColumn>

		   <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_service_template" constraintName="fk-product-service_template" deferrable="false" initiallyDeferred="false"
		       onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

		   <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_service_template" constraintName="fk-product-offer_template" deferrable="false" initiallyDeferred="false"
		       onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

		   <addForeignKeyConstraint baseColumnNames="grouped_service_id" baseTableName="cat_service_template" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
		       onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_service" />


		    <addForeignKeyConstraint baseColumnNames="service_type_id" baseTableName="cat_service_template" constraintName="fk-product-service_type" deferrable="false" initiallyDeferred="false"
		       onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_service_type" />

		    <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_service_template" constraintName="fk-product-accounting_article" deferrable="false" initiallyDeferred="false"
		       onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_accounting_article" />


		   </changeSet>

		   <changeSet id="#5595_#32_20201023" author="Mbarek-Ay">
        <addColumn tableName="cat_charge_template">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="product_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="service_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="price_plan_matrix_id" type="bigint" />
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="recurrence_duration_enum" type="varchar(20)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="duration_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="recurrence_calendar" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="calendar_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="usage_service_template_id" type="bigint" />
        </addColumn>


          <addColumn tableName="cat_charge_template">
            <column name="surcharge" type="${type.boolean}"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="price_matrix" type="${type.boolean}"/>
        </addColumn>


         <addColumn tableName="cat_charge_template">
            <column name="param1" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param1_service_id" type="bigint"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param2" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param2_service_id" type="bigint"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param3" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param3_service_id" type="bigint"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param4" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="param4_service_id" type="bigint"/>
        </addColumn>


          <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix" type="varchar(50)"/>
        </addColumn>

          <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_service" type="bigint" />
        </addColumn>


         <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_service" type="bigint" />
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix" type="varchar(50)"/>
        </addColumn>

         <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_service" type="bigint" />
        </addColumn>


        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_charge_template" constraintName="fk-product-charge_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_charge_template" constraintName="fk-offer_template-charge_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cat_charge_template" constraintName="fk1-service_template-charge_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


         <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_charge_template" constraintName="fk-price_plan-charge_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />

         <addForeignKeyConstraint baseColumnNames="duration_service" baseTableName="cat_charge_template" constraintName="fk2-service_template-charge_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


         <addForeignKeyConstraint baseColumnNames="recurrence_calendar" baseTableName="cat_charge_template" constraintName="fk-cat_calendar-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />


           <addForeignKeyConstraint baseColumnNames="calendar_service" baseTableName="cat_charge_template" constraintName="fk3-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

         <addForeignKeyConstraint baseColumnNames="usage_service_template_id" baseTableName="cat_charge_template" constraintName="fk4-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


           <addForeignKeyConstraint baseColumnNames="param1_service_id" baseTableName="cat_charge_template" constraintName="fk5-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


           <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk6-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


           <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk7-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

           <addForeignKeyConstraint baseColumnNames="param3_service_id" baseTableName="cat_charge_template" constraintName="fk8-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

           <addForeignKeyConstraint baseColumnNames="param4_service_id" baseTableName="cat_charge_template" constraintName="fk9-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

           <addForeignKeyConstraint baseColumnNames="dim1_matrix_service" baseTableName="cat_charge_template" constraintName="fk10-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

          <addForeignKeyConstraint baseColumnNames="dim2_matrix_service" baseTableName="cat_charge_template" constraintName="fk11-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

            <addForeignKeyConstraint baseColumnNames="dim3_matrix_service" baseTableName="cat_charge_template" constraintName="fk12-service_template-charge_template" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
       </changeSet>

        <changeSet id="#5595_18_20201102" author="Mbarek-Ay">
        <addColumn tableName="cat_offer_template">
            <column name="product_status" type="varchar(50)"/>
            <column name="status_date" type="datetime" />
        </addColumn>
        </changeSet>

      <changeSet id="#5595-36-20201103" author="Mbarek-Ay">
        <addColumn tableName="cpq_tag">
            <column name="product_version_id" type="bigint" />
        </addColumn>
         <addColumn tableName="cpq_tag">
            <column name="service_template_id" type="bigint" />
        </addColumn>
         <addColumn tableName="cpq_tag">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_tag" constraintName="fk_product_version_tag" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
           <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_tag" constraintName="fk_service_template_tag" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
            <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_tag" constraintName="fk_offer_template_version_tag" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
       </changeSet>

          <changeSet id="#5595_49_20201118" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_version">
            <column name="short_description" type="varchar(255)"/>
        </addColumn>
        </changeSet>

        <changeSet author="Mbarek-Ay" id="#43-20201113">
	    <createTable tableName="cpq_offer_template_tags">
	        <column name="offer_template_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	        <column name="tag_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	    </createTable>

	       <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="offer_template_id"
                                 constraintName="cpq_offer_template_tags_offer_template_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

	    <createTable tableName="cpq_service_template_tags">
	        <column name="service_template_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	        <column name="tag_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	    </createTable>
	    <addUniqueConstraint columnNames="service_template_id,tag_id" constraintName="service_template_tag_pkey" tableName="cpq_service_template_tags" />

	       <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="service_template_id"
                                 constraintName="cpq_service_template_tags_offer_template_id_fk" referencedTableName="cat_service_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_service_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

	    <createTable tableName="cpq_product_version_tags">
	        <column name="product_version_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	        <column name="tag_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	    </createTable>

	        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="product_version_id"
                                 constraintName="cpq_product_version_tags_offer_template_id_fk" referencedTableName="cpq_product_version"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_product_version_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

	     <dropColumn tableName="cpq_tag">
            <column name="product_version_id"></column>
            <column name="service_template_id"></column>
            <column name="offer_template_id"></column>
        </dropColumn>

	   </changeSet>
	   <changeSet id="#5596-20201113" author="Rachid.AIT">
		          <createTable tableName="cpq_product_discount_plan">
			        <column name="product_id" type="bigint">
			            <constraints nullable="false" />
			        </column>
			        <column name="discount_id" type="bigint">
			            <constraints nullable="false" />
			        </column>
			    </createTable>
			       <createTable tableName="cpq_product_version_services">
			        <column name="product_version_id" type="bigint">
			            <constraints nullable="false" />
			        </column>
			        <column name="service_template_id" type="bigint">
			            <constraints nullable="false" />
			        </column>
			    </createTable>

			    <createTable tableName="cpq_product_model_children">
		            <column name="product_id" type="bigint" />
		            <column name="model_chlidren" type="varchar(100)" />
		        </createTable>
		        <addPrimaryKey columnNames="product_id,model_chlidren" constraintName="cpq_product_model_children_pkey" tableName="cpq_product_model_children" />

			      <addUniqueConstraint columnNames="product_id,discount_id" constraintName="cpq_product_discount_plan_pkey" tableName="cpq_product_discount_plan" />
			      <addUniqueConstraint columnNames="product_version_id,service_template_id" constraintName="cpq_product_services_pkey" tableName="cpq_product_version_services" />

	        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_product_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

	        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_service_template_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

       </changeSet>

      <changeSet id="#5569_54052_20201117" author="TarikFAKHOURI">

        	<createSequence sequenceName="cpq_quote_article_line_seq" />

	    	<createTable tableName="cpq_quote_article_line">
	    		<column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_article_line_pkey" />
	            </column>
	            <column name="version" type="int4" />
	            <column name="creator" type="varchar(100)" />
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="updater" type="varchar(100)" />
	            <column name="billable_account_id" type="bigint" >
	                <constraints nullable="false" />
	            </column>
	            <column name="accounting_article_id" type="bigint" >
	                <constraints nullable="false" />
	            </column>
            	<column name="quantity" type="numeric(23, 12)" >
	                <constraints nullable="false" />
	            </column>
            	<column name="service_quantity" type="numeric(23, 12)" >
	                <constraints nullable="false" />
	            </column>
	    	</createTable>

	        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

			<addColumn tableName="cat_service_template">
	            <column name="sequence" type="INT4" />
	            <column name="display" type="${type.boolean}" />
	        </addColumn>

	  </changeSet>


	    <changeSet author="Mbarek-Ay" id="#51-20201123">
            <dropColumn tableName="cpq_quote_product">
            <column name="offer_component_id"/>
           </dropColumn>

	    </changeSet>

	    <changeSet id="#65-20201127" author="TarikFAKHOURI">

        	<createSequence sequenceName="quote_offer_seq" />

	        <createTable tableName="quote_offer">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_offer_seq" />
	            </column>
	            <column name="version" type="int4" />
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />

				<column name="offer_template_id" type="bigint">
					<constraints nullable="false"/>
				</column>
				<column name="billable_account_id" type="bigint" />
				<column name="quote_version_id" type="bigint">
					<constraints nullable="false"/>
				</column>
				<column name="quote_customer_service_id" type="bigint" />
	            <column name="sequence" type="INT4" />
	             <column name="contract_code" type="varchar(50)" />
	             <column name="position" type="int4" />

	        </createTable>

	        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="quote_offer" constraintName="fk_quote_offer_offer_template_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="quote_offer" constraintName="fk_quote_offer_billable_account_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
	        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
	        <addForeignKeyConstraint baseColumnNames="quote_customer_service_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_customer_service_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />

	        <addColumn tableName="cpq_quote_product">
	            <column name="offer_quote_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	        </addColumn>

	        <addForeignKeyConstraint baseColumnNames="offer_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_offer_quote_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
	    </changeSet>

	    <changeSet id="540-66-20201201" author="TarikFA">
		        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_component" constraintName="fk_cpq_offer_component_offer_template_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	    </changeSet>

	    <changeSet id="540-69-20201202" author="TarikFA">

        <createSequence sequenceName="cpq_attribute_seq" />
        <createSequence sequenceName="cpq_grouped_attributes_seq" />

	        <createTable tableName="cpq_attribute">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute" />
	            </column>
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
	            <column name="version" type="int4" />
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
	            <column name="disabled" type="${type.boolean}">
	            	<constraints nullable="false"/>
	            </column>
	            <column name="uuid" type="varchar(60)">
	            	<constraints nullable="false" unique="true"/>
	            </column>
            	<column name="cf_values" type="${type.json}" />
            	<column name="cf_values_accum" type="${type.json}" />
               <column name="parent_id" type="bigint" />
	            <column name="grouped_attributes_id" type="bigint" />
	            <column name="mandatory" type="${type.boolean}" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="priority" type="int4" />
	            <column name="sequence" type="int4" />
	            <column name="display" type="${type.boolean}" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="attribute_type" type="varchar(100)" />
	            <column name="unit_nb_decimal" type="int4" />
	        </createTable>

	        <createTable tableName="cpq_grouped_attributes">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_grouped_attributes" />
	            </column>
	            <!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->
	            <column name="product_version_id" type="bigint" />
	            <column name="mandatory" type="${type.boolean}" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="priority" type="int4" />
	            <column name="display" type="${type.boolean}" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="sequence" type="int4" />
	        </createTable>

		    <createTable tableName="cpq_attribute_allowed_values">
	            <column name="attribute_id" type="bigint" />
	            <column name="allowed_values" type="varchar(100)" />
	        </createTable>

		    <createTable tableName="cpq_product_version_attributes">
	            <column name="product_version_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="attribute_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	        </createTable>

		    <createTable tableName="cpq_service_template_attributes">
	            <column name="service_template_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="attribute_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	        </createTable>




		        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_grouped_attributes_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
		            
		                <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_parent_attributes_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

		        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_attributes" constraintName="fk_cpq_grouped_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

		        <addPrimaryKey columnNames="attribute_id,allowed_values" constraintName="cpq_attribute_allowed_values_pkey" tableName="cpq_attribute_allowed_values" />
		        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_allowed_values" constraintName="fk_cpq_attribute_allowed_values_attribute_type_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

		        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
		        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />


		       <addPrimaryKey columnNames="service_template_id,attribute_id" constraintName="cpq_service_template_attributes_pkey" tableName="cpq_service_template_attributes" />
		        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
		        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_serviceTemplate_id" deferrable="false" initiallyDeferred="false"
		            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

	    </changeSet>

	    <changeSet id="540-75-20201203" author="TarikFA">

        	<createSequence sequenceName="cpq_quote_seq" />

	    	<createTable tableName="cpq_quote">
	    	  <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote" />
	            </column>
	            <!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
            	<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="seller_id" type="bigint" />
	            <column name="contract_id" type="bigint" />
	            <column name="status_version" type="int4" />
	            <column name="status" type="varchar(20)">
	                <constraints nullable="false" />
	            </column>
	            <column name="status_date" type="datetime" />
	            <column name="send_date" type="datetime" />
	            <column name="quote_date" type="datetime" />
	            <column name="prestation_date_begin" type="datetime" />
	            <column name="prestation_duration" type="int4" />
	            <column name="opportunity_ref" type="varchar(50)" />
	            <column name="customer_ref" type="varchar(50)" />
	            <column name="customer_name" type="varchar(52)" />
	            <column name="contact_name" type="varchar(52)" />
	            <column name="register_number" type="varchar(50)" />
	            <column name="sales_person_name" type="varchar(52)" />
	            <column name="billable_account_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="applicant_account_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="valid_from" type="datetime" />
	            <column name="valid_to" type="datetime" />
	            <column name="quote_number" type="varchar(50)" />
	            <column name="invoice_type_id" type="bigint" />
	            <column name="pdf_filename" type="varchar(255)" />
                <column name="xml_filename" type="varchar(255)" />
	    	</createTable>

	        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_cpq_quote_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

	            <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_seller_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

	        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

	        <addForeignKeyConstraint baseColumnNames="applicant_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_applicant_account_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

	        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_contract_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

	        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_product" constraintName="fk_quote_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />

	        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_cpq_quote_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

	        <addForeignKeyConstraint baseColumnNames="cpq_quote_version_id" baseTableName="cpq_quote_lot" constraintName="fk_cpq_quote_lot_cpq_quote_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" /> 

	    </changeSet>

	<changeSet id="#5569_124_20200118" author="NabilOUACHI">


		<createSequence sequenceName="cpq_quote_price_seq" startValue="1" />
		<createTable tableName="cpq_quote_price">

			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_price" />
			</column>
			<!-- Auditable Start -->
			<column name="version" type="int4" />
			<column name="created" type="datetime"/>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<!-- Auditable End -->

			<column name="quote_article_line_id" type="bigint" />
			<column name="quote_version_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="price_level" type="varchar(50)" />
			<column name="price_type" type="varchar(50)" />

			<column name="amount_with_tax" type="numeric(23, 12)" />
			<column name="unit_price_without_tax" type="numeric(23, 12)" />
			<column name="amount_without_tax" type="numeric(23, 12)" />
			<column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
			<column name="tax_amount" type="numeric(23, 12)" />
			<column name="tax_rate" type="numeric(23, 12)" />

			<column name="price_over_charged" type="${type.boolean}" />


			<column name="currency_code" type="varchar(25)" />

			<column name="recurrence_duration" type="int8" />


			<column name="recurrence_periodicity" type="varchar(50)" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="quote_article_line_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_article_Line" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_article_line" />
		<addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_version" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />


	</changeSet>

      <changeSet id="current-str-fk-35" author="TarikFAKHOURI">


        	<createSequence sequenceName="cpq_quote_attribute_seq" />

	    	<createTable tableName="cpq_quote_attribute">
	    	  <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote_attribute" />
	            </column>
            	<column name="version" type="int4" />
            	<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="cpq_attribute_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="cpq_quote_product_id" type="bigint" />
            	<column name="string_value" type="varchar(255)" />
            	<column name="double_value" type="float8" />
            	<column name="date_value" type="datetime" />
	    	</createTable>

	        <addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

	        <addForeignKeyConstraint baseColumnNames="cpq_quote_product_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_product_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
     </changeSet>

     <changeSet id="540-84-20201209" author="TarikFa">
<!-- 	    	<addUniqueConstraint columnNames="cpq_attribute_id,cpq_quote_product_id" tableName="cpq_quote_attribute" constraintName="uniquekey_attribute_quote_product_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
<!-- 	    	<addUniqueConstraint columnNames="offer_template_id,quote_version_id" tableName="quote_offer" constraintName="uniquekey_offer_template_quote_version_id_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
<!-- 	    	<addUniqueConstraint columnNames="product_version_id,offer_quote_id" tableName="cpq_quote_product" constraintName="uniquekey_product_version_offer_quote_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
	    	<addUniqueConstraint columnNames="cpq_quote_id,quote_version" tableName="cpq_quote_version" constraintName="uniquekey_pquote_id_cpq_quote_id,quote_version" deferrable="false" initiallyDeferred="false" disabled="false"/>

	 </changeSet>

	<changeSet id="540-83-20201211" author="Mbarek-Ay">
		<createTable
			tableName="cpq_product_version_grouped_attributes">
			<column name="product_version_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="grouped_attributes_id" type="bigint">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey
			columnNames="product_version_id,grouped_attributes_id"
			constraintName="cpq_product_version_grouped_attributes_pkey"
			tableName="cpq_product_version_grouped_attributes" />
		<addForeignKeyConstraint
			baseColumnNames="grouped_attributes_id"
			baseTableName="cpq_product_version_grouped_attributes"
			constraintName="cpq_product_version_grouped__attribute_id"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cpq_grouped_attributes" />

		<addForeignKeyConstraint
			baseColumnNames="product_version_id"
			baseTableName="cpq_product_version_grouped_attributes"
			constraintName="cpq_product_version_grouped_attributes_product_version_id"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="cpq_product_version" />

	      <addColumn tableName="cpq_product_version">
            <column name="valid_from" type="datetime"></column>
            <column name="valid_to" type="datetime"></column>
        </addColumn>
	</changeSet>
    <!-- end MediaPost -->
    <changeSet id = "#FEAT-761-2020-10-19" author = "ZBariki">
        <createSequence sequenceName="billing_accounting_article_seq" startValue="1" />
        <createTable tableName="billing_accounting_article" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name ="analytic_code_1" type="varchar(255)"></column>
            <column name ="analytic_code_2" type="varchar(255)"></column>
            <column name ="analytic_code_3" type="varchar(255)"></column>
            <column name="tax_class_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_sub_category_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_id" type="bigint"/>
            <column name="accounting_code_id" type="bigint" />
            <column name="description_i18n" type="${type.json}"></column>

			<column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
            <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
        </createTable>

        <createSequence sequenceName="billing_article_family_seq" startValue="1" />
        <createTable tableName="billing_article_family" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_family_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)" />
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="accounting_code_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_ref_id" type="bigint" />
            <column name="cf_values" type="${type.json}"/>
            <column name="cf_values_accum" type="${type.json}"/>
            <column name="description_i18n" type="${type.json}"></column>
        </createTable>

        <createSequence sequenceName="billing_article_mapping_seq" startValue="1" />
        <createTable tableName="billing_article_mapping" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mapping_script_id" type="bigint" />
        </createTable>

        <createSequence sequenceName="billing_article_mapping_line_seq" startValue="1" />
        <createTable tableName="billing_article_mapping_line">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_line_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="code" type="varchar(50)" />
            <column name="description" type="varchar(255)" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>
            <column name="article_mapping_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="offer_template_id" type="bigint"></column>
            <column name="charge_template_id" type="bigint"></column>
            <column name="product_id" type="bigint"></column>

            <column name="parameter_1" type="varchar(255)"/>
            <column name="parameter_2" type="varchar(255)"/>
            <column name="parameter_3" type="varchar(255)"/>
            <column name="mapping_key_el" type="varchar(255)"/>
        </createTable>

        <createSequence sequenceName="billing_attribute_mapping_seq" startValue="1" />
        <createTable tableName="billing_attribute_mapping">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_attribute_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>

            <column name="article_mapping_line_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="attribute" type="varchar(30)"/>
            <column name="attribute_value" type="varchar(255)"/>
        </createTable>


        <addColumn tableName="billing_rated_transaction">
            <column name="article_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_tax_class" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax_class" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_invoice_sub_category" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="article_family_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_article_family" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="article_family_ref_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_article_family_ref" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />

        <addForeignKeyConstraint baseColumnNames="mapping_script_id" baseTableName="billing_article_mapping"
                                 constraintName="fk_billing_article_mapping_mapping_script" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />

        <addForeignKeyConstraint baseColumnNames="article_mapping_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article_mapping" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_mapping" />

        <addForeignKeyConstraint baseColumnNames="article_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_charge_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_charge_template" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_service_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_product_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="article_id"
                                 constraintName="rated_transaction_article_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="article_mapping_line_id"
                                 constraintName="attribute_mapping_article_mapping_line_fk" referencedTableName="billing_article_mapping_line"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="attribute_id"
                                 constraintName="attribute_mapping_attribute_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
    </changeSet>

     <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-">
   <createTable tableName="cpq_billing_account_tags">
       <column name="billing_account_id" type="bigint">
           <constraints nullable="false" />
       </column>
       <column name="tag_id" type="bigint">
           <constraints nullable="false" />
       </column>
   </createTable>
   <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_billing_account_tags_pkey" tableName="cpq_offer_component_tags" />
   <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="billing_account_id"
                                 constraintName="cpq_billing_account_tags_billing_account_id_fk" referencedTableName="billing_billing_account"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_billing_account_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
  </changeSet>


   <changeSet author="Mbarek-Ay" id="current-mediapost-tbl-charge_attribute">
   <createTable tableName="cpq_attribute_charge">
       <column name="charge_id" type="bigint">
           <constraints nullable="false" />
       </column>
       <column name="attribute_id" type="bigint">
           <constraints nullable="false" />
       </column>
   </createTable>
   <addUniqueConstraint columnNames="charge_id,attribute_id" constraintName="cpq_attribute_charge_pkey" tableName="cpq_attribute_charge" />
   <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="charge_id"
                                 constraintName="cpq_attribute_charge_charge_id_fk" referencedTableName="cat_charge_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="attribute_id"
                                 constraintName="cpq_attribute_charge_attribute_id_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
       </changeSet>


      <changeSet id="#REF_INV_20201223" author="MohammedELAZZOUZI">
    	<addColumn tableName="cat_discount_plan_item">
        	<column name="accounting_article_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_discount_plan_item" constraintName="fk__cat_discount_plan_item__accounting_article" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addColumn tableName="cat_discount_plan_item">
        	<column name="priorty" type="bigint"></column>
        </addColumn>

        <addColumn tableName="quote_offer">
        	<column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="quote_offer" constraintName="fk__quote_offer__cat_discount_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote">
        	<column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote" constraintName="fk__ord_quote__cat_discount_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote_product">
        	<column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_product" constraintName="fk__cpq_quote_product__cat_discount_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

    </changeSet>

      <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-27">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovoo51" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

     <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-41">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_attribute_trade_rule_header" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
     </changeSet>

      <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-39">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_attribute_rule_line" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
     </changeSet>


     <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_grouped_attributes_commercial_rule_line">
        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_grouped_attributes_commercial_rule_line" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
     </changeSet>

     <changeSet id="540-103-add-swagger-docs-to-All-ChargeTemplates" author="TarikFA.">
     		<createTable tableName="cpq_offer_attributes">
     			<column name="offer_template_id" type="bigint" />
     			<column name="attribute_id" type="bigint" />
     		</createTable>

     		<addPrimaryKey columnNames="offer_template_id,attribute_id," tableName="cpq_offer_attributes"/>

	        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_offer_template_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

	        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
     </changeSet>


	<changeSet id="#540-100-20201225" author="TarikFA">

        <createSequence sequenceName="cpq_commercial_order_seq" />
        <createSequence sequenceName="cpq_order_type_seq" />
        <createSequence sequenceName="cpq_order_item_seq" />
        <createSequence sequenceName="cpq_order_product_seq" />
        <createSequence sequenceName="cpq_order_lot_seq" />
        <createSequence sequenceName="cpq_order_offer_seq" />
        <createSequence sequenceName="order_article_line_seq" />
        <createSequence sequenceName="cpq_order_invoice_seq" />
        <createSequence sequenceName="cpq_invoice_line_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_item_seq" />

		<createTable tableName="cpq_commercial_order">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_commercial_order" />
	            </column>
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
	            <column name="version" type="int" />
				<!-- Auditable End -->

	            <column name="seller_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="order_number" type="varchar(50)" />
	            <column name="label" type="varchar(255)" />
	            <column name="billing_account_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="cpq_quote_id" type="bigint" />
	            <column name="contract_id" type="bigint" />
	            <column name="status" type="varchar(50)" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="status_date" type="datetime" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="order_progress" type="int" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="progress_date" type="datetime" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="order_date" type="datetime" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="realisation_date" type="datetime" />
	            <column name="customer_service_begin" type="datetime" />
	            <column name="customer_service_duration" type="int" />
	            <column name="external_reference" type="varchar(50)" />
	            <column name="order_parent_id" type="bigint" />
	            <column name="order_type_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="invoicing_plan_id" type="bigint" />
	            <column name="invoice_type_id" type="bigint">
	            	<constraints nullable="false"/>
	            </column>
	            <column name="user_account_id" type="bigint" />
	            <column name="access_id" type="bigint" />
	        </createTable>

	        <createTable tableName="cpq_commercial_order_billing_invoice">
	        	<column name="commercial_order_id" type="bigint">
	        		<constraints nullable="false"/>
	        	</column>
	        	<column name="invoice_id" type="bigint">
	        		<constraints nullable="false"/>
	        	</column>
	        </createTable>

	        <addPrimaryKey columnNames="commercial_order_id,invoice_id" tableName="cpq_commercial_order_billing_invoice"/>

        	<addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        	<addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_invoice_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
        	<addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoice_type_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />


		<createTable tableName="cpq_invoicing_plan">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->
		</createTable>
		<createTable tableName="cpq_order_type">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_type" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->
		</createTable>


        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_seller_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_billing_account_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_cpq_quote_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_contract_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

        <addForeignKeyConstraint baseColumnNames="order_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_type_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_type" />

        <addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoicing_plan_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

        <addForeignKeyConstraint baseColumnNames="order_parent_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_parent_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


		<createTable tableName="cpq_order_item">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_item" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->


	            <column name="order_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="order_lot_id" type="bigint" />
	            <column name="order_product_id" type="bigint" />
	            <column name="access_point" type="varchar(20)" />
	            <column name="attribute_id" type="bigint" />
	            
	            <column name="string_value" type="varchar(255)" />
	            <column name="date_value" type="datetime" />
	            <column name="double_value" type="float8" />

		</createTable>

		<createTable tableName="cpq_order_product">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_product" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="order_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="order_service_commercial_id" type="bigint" />
	            <column name="order_offer_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="product_version_id" type="bigint" />
	            <column name="quantity" type="numeric(23, 12)" >
	            	<constraints nullable="false"/>
	            </column>
		</createTable>

		<createTable tableName="cpq_order_lot">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_lot" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="order_id" type="bigint">
	                <constraints nullable="false" />
	            </column>
				<column name="name" type="varchar(50)" />
		</createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_lot_order_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_service_commercial_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="order_product_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_product_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_product" />
            
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_attribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

		<createTable tableName="cpq_order_offer">

	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_offer" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->
	            <column name="order_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="offer_template_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
		</createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_template_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

         <!-- foreign key for Order Product  Start -->

		<addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

		<addForeignKeyConstraint baseColumnNames="order_service_commercial_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_service_commercial_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

		<addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_offer_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />

		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <!-- foreign key for Order Product  End -->

        <!--  Creation table order_article_Line (OrderArticleLine) -->
        <createTable tableName="order_article_line">

	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_article_line" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

				<column name="order_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="order_customer_service_id" type="bigint" />
				<column name="accounting_article_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="quantity" type="numeric(23, 12)">
					<constraints nullable="false"/>
				</column>
				<column name="quantity_service" type="numeric(23, 12)" >
					<constraints nullable="false"/>
				</column>
				<column name="os_unit_price_without_tax" type="numeric(23, 12)" />
				<column name="os_price_without_tax" type="numeric(23, 12)" />
				<column name="os_tax_code" type="numeric(23, 12)" />
				<column name="os_tax_rate" type="int" />
				<column name="os_price_with_tax" type="numeric(23, 12)" />
				<column name="rc_unit_price_without_tax" type="numeric(23, 12)" />
				<column name="rc_price_without_tax" type="numeric(23, 12)" />
				<column name="rc_tax_code" type="numeric(23, 12)" />
				<column name="rc_tax_rate" type="int" />
				<column name="rc_price_with_tax" type="numeric(23, 12)" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_id" deferrable="false"
								initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

		<addForeignKeyConstraint baseColumnNames="order_customer_service_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_customer_service_id" deferrable="false"
								initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

		<addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_accounting_article_id" deferrable="false"
								initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

		<createSequence sequenceName="order_price_seq" startValue="1" />
		<createTable tableName="order_price">

			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_price" />
			</column>
			<!-- BusinessEntity Start -->
			<column name="code" type="varchar(255)" >
				<constraints nullable="false" unique="true" />
			</column>
			<column name="description" type="varchar(255)" />
			<column name="version" type="int4" />
			<!-- BusinessEntity End -->
			<!-- Auditable Start -->
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<!-- Auditable End -->

			<column name="order_article_line_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="order_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="price_level" type="varchar(50)" />
			<column name="price_type" type="varchar(50)" />

			<column name="amount_with_tax" type="numeric(23, 12)" />
			<column name="unit_price_without_tax" type="numeric(23, 12)" />
			<column name="amount_without_tax" type="numeric(23, 12)" />
			<column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
			<column name="tax_amount" type="numeric(23, 12)" />
			<column name="tax_rate" type="numeric(23, 12)" />

			<column name="price_over_charged" type="${type.boolean}" />


			<column name="currency_code" type="varchar(25)" />

			<column name="recurrence_duration" type="int8" />


			<column name="recurrence_periodicity" type="varchar(50)" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="order_article_line_id" baseTableName="order_price" constraintName="fk_order_price_order_article_Line" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_article_line" />
		<addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_price" constraintName="fk_order_price_order_commercial_order" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

		  <createTable tableName="cpq_order_invoice">

	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_invoice" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

				<column name="seller_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="billing_account_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="invoice_type_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="invoice_ref" type="varchar(20)" />
				<column name="status" type="varchar(20)" />
				<column name="status_date" type="datetime" >
					<constraints nullable="false"/>
				</column>
				<column name="invoice_date" type="datetime" >
					<constraints nullable="false"/>
				</column>
				<column name="due_date" type="datetime" >
					<constraints nullable="false"/>
				</column>
				<column name="begin_date" type="datetime" />
				<column name="end_date" type="datetime" />
				<column name="amount_without_tax" type="numeric(23, 12)" >
					<constraints nullable="false"/>
				</column>
				<column name="amount_with_tax" type="numeric(23, 12)" >
					<constraints nullable="false"/>
				</column>
				<column name="amount_tax" type="numeric(23, 12)" >
					<constraints nullable="false"/>
				</column>
				<column name="payment_method_id" type="bigint" >
					<constraints nullable="false"/>
				</column>
				<column name="pdf_link" type="varchar(255)" />
				<column name="commercial_order_id" type="bigint" />
		</createTable>

	    <createTable tableName="cpq_order_invoice_access_point_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="access_point_list" type="varchar(100)" />
        </createTable>

	    <createTable tableName="cpq_order_invoice_order_ref_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="order_ref_list" type="varchar(100)" />
        </createTable>

		<addPrimaryKey columnNames="order_invoice_id,access_point_list" constraintName="cpq_order_invoice_access_point_list_pkey" tableName="cpq_order_invoice_access_point_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_access_point_list" constraintName="fk_cpq_order_invoice_access_point_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />


		<addPrimaryKey columnNames="order_invoice_id,order_ref_list" constraintName="cpq_order_invoice_order_ref_list_pkey" tableName="cpq_order_invoice_order_ref_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_order_ref_list" constraintName="fk_cpq_order_invoice_order_ref_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_seller_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_billing_account_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_invoice_type_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_payment_method_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <createTable tableName="cpq_invoice_line">

	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoice_line" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="invoice_id" type="bigint" />
	            <column name="prestation" type="varchar(255)" />
	            <column name="accounting_article_id" type="bigint" >
	            	<constraints nullable="false"/>
	            </column>
	            <column name="offer_service_template_id" type="bigint" />
	            <column name="product_id" type="bigint" />
	            <column name="service_template_id" type="bigint" />
				<column name="begin_date" type="datetime" />
				<column name="end_date" type="datetime" />
				<column name="quantity" type="numeric(23, 12)"  >
	            	<constraints nullable="false"/>
	            </column>
				<column name="unit_price" type="numeric(23, 12)"  >
	            	<constraints nullable="false"/>
	            </column>
				<column name="discount_rate" type="numeric(23, 12)"  >
	            	<constraints nullable="false"/>
	            </column>
				<column name="amount_without_tax" type="numeric(23, 12)" >
	            	<constraints nullable="false"/>
	            </column>
				<column name="tax_rate" type="numeric(23, 12)" >
	            	<constraints nullable="false"/>
	            </column>
				<column name="amount_with_tax" type="numeric(23, 12)" >
	            	<constraints nullable="false"/>
	            </column>
				<column name="amount_tax" type="numeric(23, 12)"  >
	            	<constraints nullable="false"/>
	            </column>
				<column name="discount_plan_id" type="bigint"  />
				<column name="tax_id" type="bigint"  />
				<column name="order_ref" type="varchar(20)"  />
				<column name="access_point" type="varchar(20)"  />
				<column name="commercial_order_id" type="bigint"  />
		</createTable>

        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_accounting_article_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="offer_service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_offer_service_template_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_serv_templates" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_product_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_service_template_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_discount_plan_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_tax_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_commercial_order_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

		  <createTable tableName="cpq_invoicing_plan_item">

	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan_item" />
	            </column>
			<!-- BusinessEntity Start -->
				<column name="code" type="varchar(255)" >
					<constraints nullable="false" unique="true" />
				</column>
				<column name="description" type="varchar(255)" />
            	<column name="version" type="int4" />
				<!-- BusinessEntity End -->
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->

	            <column name="billing_plan_id" type="bigint" >
	                <constraints nullable="false" />
	            </column>
	                
	            <column name="advancement" type ="int4">
	            	<constraints nullable="false" />
	            </column>
	            <column name="rate_to_bill" type="numeric(23, 12)" >
	                <constraints nullable="false" />
	            </column>
		</createTable>


        <addForeignKeyConstraint baseColumnNames="billing_plan_id" baseTableName="cpq_invoicing_plan_item" constraintName="fk_cpq_invoicing_plan_item_billing_plan_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

		<addColumn tableName="billing_subscription">
			<column name="commercial_order_id" type="bigint" />
			<column name="prestation" type="varchar(255)" />
		</addColumn>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


		<addColumn tableName="billing_wallet_operation">
			<column name="order_id" type="bigint" />
			<column name="accounting_article_id" type="bigint" />
			<column name="order_lot_id" type="bigint" />
			<column name="product_version_id" type="bigint" />
		</addColumn>


        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_product_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

		<addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_accounting_article_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

		<addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_lot_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

		<addColumn tableName="billing_rated_transaction">
			<column name="order_id" type="bigint" />
			<column name="accounting_article_id" type="bigint" />
			<column name="order_lot_id" type="bigint" />
			<column name="product_version_id" type="bigint" />
		</addColumn>



        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_order_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_product_version_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	    <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_accounting_article_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

		<addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_lot_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />        

	</changeSet>

    <changeSet id="20201230_pricematrix" author="NabilOuachi">
        <createSequence sequenceName="cpq_price_plan_matrix_column_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_column">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_column_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="ppm_version_id" type="bigint" />
            <column name="position" type ="int4"/>
            <column name="type" type="varchar(255)"/>

            <column name="el_value" type="varchar(255)"/>

            <column name="product_id" type="bigint" />
			<column name="offer_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
			<column name="is_range" type="${type.boolean}" defaultValueNumeric="0"/>
		</createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_value_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_value">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_value_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="ppm_column_id" type="bigint" />

			<column name="ppml_id" type="bigint" />

            <column name="long_value" type ="int8"/>
            <column name="double_value" type ="float8"/>
            <column name="string_value" type="varchar(255)"/>

			<column name="date_value" type="datetime"/>
			<column name="from_date_value" type="datetime"/>
			<column name="to_date_value" type="datetime"/>

			<column name="from_double_value" type ="float8"/>
			<column name="to_double_value" type ="float8"/>

        </createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_line_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_line">
             	<column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_price_plan_matrix_line" />
	            </column>
				<!-- Auditable Start -->
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
				<!-- Auditable End -->
	            <column name="version" type="int4" />

	            <column name="ppm_version_id" type="bigint" />
				<column name="priority" type="int4" defaultValueNumeric="0"/>

	            <column name="description" type="varchar(255)"/>
	            <column name="price_without_tax" type="numeric(23, 12)" />
        </createTable>

		<addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_ppm_version" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_attribute" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

		<addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_offer_template" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="ppm_column_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_column" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_column" />

		<addForeignKeyConstraint baseColumnNames="ppml_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_line" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_line" />

        <addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_line" constraintName="fk_price_plan_matrix_line_price_plan_matrix_version" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

    </changeSet>

    <changeSet id="20201230-ticket5870" author="NabilOUACHI">
        <createSequence sequenceName="cpq_product_charge_template_mapping_seq" startValue="1" />

        <createTable tableName="cat_product_wallet_template_1">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="wallet_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, wallet_template_id" constraintName="cat_product_wallet_template_1_pkey" tableName="cat_product_wallet_template_1" />

        <createTable tableName="cat_product_counter_template">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, counter_template_id" constraintName="cat_product_counter_template_pkey" tableName="cat_product_counter_template" />

        <createTable tableName="cpq_product_charge_template_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_charge_template_mapping_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="product_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="counter_template_id" type="bigint" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_product" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_counter" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="wallet_template_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_wallet_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_wallet_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_cat_counter_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />
    </changeSet>

    <changeSet id="540-112-20210107" author="TarikF">
	        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_invoice_type_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>
    <changeSet id="20210113" author="TarikF">
    
      <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_accounting_article_id" deferrable="false" initiallyDeferred="false"
          onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />
          
         
		<addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_product_mapping" constraintName="fk-accounting_article-product_mapping" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />
	            
	</changeSet>
	
	<changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-attribute_tag">
		<addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_tag" constraintName="fk_tag_attribute" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
	</changeSet>

	<changeSet id="540-139-20012020" author="NabilOUACHI">


		<createSequence sequenceName="cpq_attribute_instance_seq" />

		<createTable tableName="cpq_attribute_instance">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute_instance" />
			</column>
			<column name="version" type="int4" />
			<!-- Auditable Start -->
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<!-- Auditable End -->

			<column name="cpq_attribute_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="service_instance_id" type="bigint" >
				<constraints nullable="false"/>
			</column>
			<column name="subscription_id" type="bigint" >
				<constraints nullable="false"/>
			</column>

			<column name="string_value" type="varchar(255)" />
			<column name="double_value" type="float8" />
			<column name="date_value" type="datetime" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

		<addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_service_instance_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />

		<addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_subscription_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
	</changeSet>
	<changeSet id="#20210121-540-128" author="TarikFA">
		
	        <addColumn tableName="cpq_quote_article_line">
				<column name="quote_product_id" type="bigint" />
				<column name="quote_lot_id" type="bigint" />
	        </addColumn>
	        
			<addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_product_id" deferrable="false" initiallyDeferred="false"
									 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
			<addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_lot_id" deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
	</changeSet>
		<changeSet id="#20210122-540-128" author="TarikFA">
		
	        <addColumn tableName="billing_service_instance">
				<column name="product_version_id" type="bigint" />
				<column name="quote_product_id" type="bigint" />
	        </addColumn>
	        
			<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id" deferrable="false" initiallyDeferred="false"
									 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
			<addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_product_serviceInstance_id" deferrable="false" initiallyDeferred="false"
									 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
	</changeSet>
	
	<changeSet id="#20210127-540-190" author="TarikFA">
			<addForeignKeyConstraint baseColumnNames="access_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_access_id" deferrable="false" initiallyDeferred="false"
									 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="medina_access" />
			<addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_user_account_id" deferrable="false" initiallyDeferred="false"
									 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
	</changeSet>

	<changeSet id="Invoice_lines_job_20200114" author="ZBariki">
		<addColumn tableName="cpq_invoice_line">
			<column name="billing_run_id" type="bigint"/>
			<column name="billing_account_id" type="bigint"/>
			<column name="label" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="raw_amount" type="numeric">
				<constraints nullable="false"/>
			</column>
			<column name="value_date" type="datetime" />
			<column name="order_number" type="varchar(255)" />
			<column name="discount_amount" type="numeric">
				<constraints nullable="false"/>
			</column>
			<column name="subscription_id" type="bigint"/>
			<column name="service_instance_id" type="bigint"/>
			<column name="offer_template_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_run_id"
								 constraintName="billing_invoice_line_billing_run_id_fk"
								 referencedTableName="billing_billing_run" referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_account_id"
								 constraintName="billing_billing_account_id_fk"
								 referencedTableName="billing_billing_account" referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="service_instance_id"
								 constraintName="billing_service_instance_id_fk"
								 referencedTableName="billing_service_instance" referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="subscription_id"
								 constraintName="billing_subscription_id_fk"
								 referencedTableName="billing_subscription" referencedColumnNames="id"/>
		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="offer_template_id"
								 constraintName="billing_offer_template_id_fk"
								 referencedTableName="cat_offer_template" referencedColumnNames="id"/>
	</changeSet>
	<changeSet id="#5916_20210128" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_invoice_line">
            <column name="order_lot_id" type="bigint"/>
        </addColumn>
       		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="order_lot_id"
							 constraintName="cpq_invoice_line__order_lot__fk"
							 referencedTableName="cpq_order_lot" referencedColumnNames="id"/>
        <addColumn tableName="cpq_invoice_line">
            <column name="product_version_id" type="bigint"/>
        </addColumn>
  		<addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="product_version_id"
							 constraintName="cpq_invoice_line__product_version__fk"
							 referencedTableName="cpq_product_version" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#5937_20210204" author="TarikFA">
    	<addColumn tableName="cat_charge_template">
            <column name="attribute_id" type="bigint"/>
    	</addColumn>
  		<addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_id"
							 constraintName="fk_cat_charge_template_attribute_id"
							 referencedTableName="cpq_attribute" referencedColumnNames="id"/>
    </changeSet>

	<changeSet id="#214_20210203" author="NabilOUACHI">
		<addColumn tableName="cpq_quote_price">
			<column name="charge_template_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="cpq_quote_price" baseColumnNames="charge_template_id"
								 constraintName="fk_cpq_quote_price_charge_template_id"
								 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
		<addColumn tableName="order_price">
			<column name="charge_template_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="order_price" baseColumnNames="charge_template_id"
								 constraintName="fk_order_price_charge_template_id"
								 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
		<addColumn tableName="order_article_line">
			<column name="order_product_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseTableName="order_article_line" baseColumnNames="order_product_id"
								 constraintName="fk_order_article_line_order_product_id"
								 referencedTableName="cpq_order_product" referencedColumnNames="id"/>

		<addColumn tableName="cpq_commercial_order">
			<column name="rate_invoiced" type="int">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<sql>
			<![CDATA[
				alter table cpq_invoice_line alter column invoice_id drop not null;
				alter table cpq_quote_price alter column quote_article_line_id drop not null;
				alter table cpq_order_item drop column code;
				alter table cpq_order_item drop column description;
				alter table cpq_order_item rename column attribute_id to cpq_attribute_id;
			]]>
		</sql>
	</changeSet>
	
	<changeSet id="20210204_540" author="TarikFA">
		<addColumn tableName="cat_charge_template">
			<column name="attribute_duration_id" type="bigint"/>
			<column name="attribute_calendar_id" type="bigint"/>
		</addColumn>
		
		<addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_duration_id"
								 constraintName="fk_cat_charge_templat_attribute_duration_id"
								 referencedTableName="cpq_attribute" referencedColumnNames="id"/>
								 
		<addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_calendar_id"
								 constraintName="fk_cat_charge_template_attribute_calendar_id"
								 referencedTableName="cpq_attribute" referencedColumnNames="id"/>

	</changeSet>
	<changeSet id="Invoice_lines_job_202001145" author="ZBariki">
		<preConditions onFail="MARK_RAN">
			<foreignKeyConstraintExists foreignKeyName="fk_cpq_invoice_line_invoice_id"/>
		</preConditions>
		<dropForeignKeyConstraint baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id"/>
		<addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line"
								 constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_invoice" />
	</changeSet>
	<changeSet id="Invoicing_job_20210205_45" author="ZBariki">
		<addColumn tableName="cpq_invoice_line">
			<column name="status" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<addColumn tableName="billing_rated_transaction">
			<column name="invoice_line_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="invoice_line_id" baseTableName="billing_rated_transaction"
								 constraintName="fk_billing_rated_transaction_invoice_line_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
	</changeSet>
	<changeSet id="#20210205_540_223" author="TarikFA">
		<modifyDataType tableName="cpq_media" columnName="media_path" newDataType="varchar(255)"/>
		<modifyDataType tableName="cpq_media" columnName="media_name" newDataType="varchar(255)"/>
	</changeSet>
	
	<changeSet id="#5938_20210205" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_invoice">
            <column name="new_invoicing_process" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="#20210209_540177" author="TarikFA">
    	<addColumn tableName="cpq_product">
    		<column name="product_version_id" type="bigint" />
    	</addColumn>
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product"
								 constraintName="fk_cpq_product_product_version_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

	<changeSet id="#20210215-248" author="NabilOUACHI">
		<addColumn tableName="cpq_attribute_instance">
			<column name="parent_id" type="bigint"/>
		</addColumn>
		<addColumn tableName="cpq_quote_attribute">
			<column name="parent_id" type="bigint"/>
		</addColumn>
		<addColumn tableName="cpq_order_item">
			<column name="parent_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute_instance"
								 constraintName="fk_cpq_attribute_instance_parent_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="cpq_attribute_instance" />

		<addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_quote_attribute"
								 constraintName="fk_cpq_quote_instance_parent_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="cpq_quote_attribute" />

		<addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_order_item"
								 constraintName="fk_cpq_order_instance_parent_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="cpq_order_item" />

	</changeSet>
    
    <changeSet id="#20210212_540238" author="TarikFA">
    	<addUniqueConstraint columnNames="code,ppm_version_id" tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
    </changeSet>
    
    <changeSet id="#5950_20210210" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_billing_run">
            <column name="minimum_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="threshold_checked" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="discount_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    

    <changeSet id="#246_20210212" author="Mbarek-Ay">
		<addColumn tableName="cpq_invoicing_plan">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
			<column name="disabled" type="${type.boolean}"
				defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_commercial_order">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_product_line">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_quote_lot">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_order_lot">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
			<addColumn tableName="cpq_contract_item">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
			<column name="disabled" type="${type.boolean}"
				defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_contract">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
			<column name="disabled" type="${type.boolean}"
				defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_grouped_attributes">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
			<column name="disabled" type="${type.boolean}"
				defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_invoicing_plan_item">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column>
			<column name="disabled" type="${type.boolean}"
				defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="quote_offer">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_quote_product">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		
		<addColumn tableName="cpq_order_product">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		
		<addColumn tableName="cpq_order_offer">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_quote">
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
		
		<addColumn tableName="cpq_media">  
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />   
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
		 <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" unique="true"/>
            </column> 
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
		</addColumn>
</changeSet>

	<changeSet id="#248_20210215" author="NabilOuachi">
		<sql>
			<![CDATA[
					alter table cpq_order_offer drop column code;
					alter table cpq_order_offer drop column description;
					alter table cpq_order_product drop column code;
					alter table cpq_order_product drop column description;
					alter table cpq_order_item alter column order_id drop not null;
					alter table cpq_attribute_instance alter column service_instance_id drop not null;
					alter table cpq_attribute_instance alter column subscription_id drop not null;
				]]>
		</sql>
	</changeSet>

	<changeSet id="#20200215-247" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_attribute">
			<column name="cpq_quote_offer_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
	  </changeSet>
	  
	  <changeSet id="#20210217_260" author="TarikFA">
	  	<dropTable tableName="cpq_product_mapping"/>
	  </changeSet>

	<changeSet id="#5952_20210210" author="ZBariki">
		<addColumn tableName="crm_customer">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="ar_customer_account">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="billing_billing_account">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="billing_user_account">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="billing_subscription">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="billing_service_instance">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>
		<addColumn tableName="cat_offer_template">
			<column name="minimum_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="crm_customer"
								 constraintName="fk_crm_customer_iminimum_article_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="ar_customer_account"
								 constraintName="fk_ar_customer_account_minimum_article_id"
								 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_billing_account"
								 constraintName="fk_billing_billing_account_minimum_article_id"
								 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_user_account"
								 constraintName="fk_billing_user_account_minimum_article_id"
								 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_subscription"
								 constraintName="fk_billing_subscription_minimum_article_id"
								 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_service_instance"
								 constraintName="fk_billing_service_instance_minimum_article_id"
								 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
		<addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="cat_offer_template"
								 constraintName="fk_cat_offer_template_minimum_article_id" deferrable="false"
								 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
								 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
	</changeSet>
	
	  <changeSet id="#268_20210219_cpq_structure" author="Mbarek-Ay"> 
	    <dropNotNullConstraint columnName="tax_class_id" tableName="cat_charge_template"/>  
	</changeSet>
	
	
			<changeSet id="#222_20210219" author="Mbarek-Ay">
        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-26, 0, 0, now(), 'org.meveo.api.billing.QuoteValidation', 'QuoteValidation', 'JAVA', '
package org.meveo.api.billing;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.meveo.admin.exception.BusinessException;
import org.meveo.model.billing.BillingAccount;
import org.meveo.model.cpq.CpqQuote;
import org.meveo.model.cpq.QuoteAttribute;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.CommercialOrderEnum;
import org.meveo.model.cpq.commercial.OrderArticleLine;
import org.meveo.model.cpq.commercial.OrderAttribute;
import org.meveo.model.cpq.commercial.OrderLot;
import org.meveo.model.cpq.commercial.OrderOffer;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.model.cpq.commercial.OrderType;
import org.meveo.model.cpq.offer.QuoteOffer;
import org.meveo.model.quote.QuoteArticleLine;
import org.meveo.model.quote.QuoteLot;
import org.meveo.model.quote.QuoteProduct;
import org.meveo.model.quote.QuoteVersion;
import org.meveo.security.CurrentUser;
import org.meveo.security.MeveoUser;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.cpq.QuoteVersionService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderArticleLineService;
import org.meveo.service.cpq.order.OrderAttributeService;
import org.meveo.service.cpq.order.OrderLotService;
import org.meveo.service.cpq.order.OrderOfferService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.cpq.order.OrderProductService;
import org.meveo.service.cpq.order.OrderTypeService;
import org.meveo.service.cpq.order.QuotePriceService;
import org.meveo.service.crm.impl.CurrentUserProducer;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class QuoteValidation extends ModuleScript {

	private final static Logger LOGGER = LoggerFactory.getLogger(QuoteVersionService.class);

	private QuoteVersionService quoteVersionService = (QuoteVersionService) getServiceInterface(QuoteVersionService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private OrderOfferService orderOfferService = (OrderOfferService) getServiceInterface(OrderOfferService.class.getSimpleName());
    private OrderProductService orderProductService = (OrderProductService) getServiceInterface(OrderProductService.class.getSimpleName());
    private OrderAttributeService orderAttributeService = (OrderAttributeService) getServiceInterface(OrderAttributeService.class.getSimpleName());
    private OrderLotService orderCustomerServiceService = (OrderLotService) getServiceInterface(OrderLotService.class.getSimpleName());
    private OrderArticleLineService orderArticleLineService = (OrderArticleLineService) getServiceInterface(OrderArticleLineService.class.getSimpleName());
    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private QuotePriceService quotePriceService = (QuotePriceService) getServiceInterface(QuotePriceService.class.getSimpleName());
    private OrderTypeService orderTypeService = (OrderTypeService) getServiceInterface(OrderTypeService.class.getSimpleName());
    private MeveoUser currentUser = ((CurrentUserProducer) getServiceInterface(CurrentUserProducer.class.getSimpleName())).getCurrentUser();

	
	@Override
	public void execute(Map<String, Object> methodContext) throws BusinessException {
		final CpqQuote cpqQuote = (CpqQuote) methodContext.get("cpqQuote");
		if(cpqQuote == null)
			throw new BusinessException("No Quote found");
		LOGGER.info("start creation order from quote code {}", cpqQuote.getCode());
		var quotesVersions = quoteVersionService.findByQuoteIdAndStatusActive(cpqQuote.getId());
		if(quotesVersions.size() > 1)
			throw new BusinessException("More than one quote version is published !!");
		var quoteVersion = quotesVersions.get(0);
		var orderByBillingAccount = new Hashtable<String, List<QuoteOffer>>();
		var billingAccount = new Hashtable<String, BillingAccount>();
		quoteVersion.getQuoteOffers().forEach(quoteOffer -> {
			if(quoteOffer.getBillableAccount() == null) {
				quoteOffer.setBillableAccount(cpqQuote.getBillableAccount());
			}
			List<QuoteOffer> offers = new ArrayList<>();
			if(orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode()) != null) {
				offers = orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode());
			}
			offers.add(quoteOffer);
			orderByBillingAccount.put(quoteOffer.getBillableAccount().getCode(), offers);
			billingAccount.put(quoteOffer.getBillableAccount().getCode(), quoteOffer.getBillableAccount());
			
		});
		orderByBillingAccount.keySet().forEach(ba -> {
			List<QuoteOffer> offers = orderByBillingAccount.get(ba);
			BillingAccount billableAccount = billingAccount.get(ba);
			CommercialOrder order = processCommercialOrder(cpqQuote, quoteVersion, billableAccount);
			offers.forEach(offer -> {
				processOrderOffer(offer, order);
				OrderLot orderLot = processOrderCustomerService(offer.getQuoteLot(), order);
				OrderOffer orderOffer = processOrderOffer(offer, order);
				offer.getQuoteProduct().forEach(quoteProduct -> {
					processOrderProduct(quoteProduct, order, orderLot, orderOffer);
				});
			});
		});
		LOGGER.info("End creation order from quote code {}, number of order created is {}", cpqQuote.getCode(), orderByBillingAccount.size());
		
		
	}
	private CommercialOrder processCommercialOrder(CpqQuote cpqQuote, QuoteVersion quoteVersion, BillingAccount account) {
		CommercialOrder order = new CommercialOrder();
		order.setSeller(cpqQuote.getSeller());
		order.setBillingAccount(account);
		order.setQuote(cpqQuote);
		order.setContract(cpqQuote.getContract());
		order.setCustomerServiceBegin(quoteVersion.getStartDate());
		order.setStatus(CommercialOrderEnum.DRAFT.toString());
		Date now = Calendar.getInstance().getTime();
		order.setStatusDate(now);
		order.setOrderDate(now);
		order.setCustomerServiceDuration(cpqQuote.getQuoteLotDuration());
		order.setExternalReference(null);
		order.setInvoicingPlan(quoteVersion.getInvoicingPlan());
		order.setOrderType(createOrderTypeTemp()); //TODO: how to map order type
		order.setOrderProgress(0);
		order.setOrderInvoiceType(invoiceTypeService.getDefaultCommercialOrder());
		order.setProgressDate(Calendar.getInstance().getTime());
		order.setUserAccount(account.getUsersAccounts().size() > 0 ? account.getUsersAccounts().get(0) : null);
		commercialOrderService.create(order);
		return order;
	}
	
	private OrderType createOrderTypeTemp() {
		final String TEMP_CODE = "COMMERCIAL"; 
		OrderType orderType = orderTypeService.findByCode(TEMP_CODE);
		if(orderType == null) {
			orderType = new OrderType();
			orderType.setCode(TEMP_CODE);
			orderType.setDescription("generated on quote validation  script");
			orderTypeService.create(orderType);
		}
		return orderType;
	}
	
	private OrderOffer processOrderOffer(QuoteOffer quoteOffer, CommercialOrder order) {
		OrderOffer offer = new OrderOffer();
		offer.setOrder(order);
		offer.setOfferTemplate(quoteOffer.getOfferTemplate()); 
		offer.setDiscountPlan(quoteOffer.getDiscountPlan());
		orderOfferService.create(offer);
		return offer;
	}
	
	private OrderProduct processOrderProduct(QuoteProduct product, CommercialOrder commercialOrder, OrderLot orderLot, OrderOffer orderOffer) {
		OrderProduct orderProduct = new OrderProduct();
		orderProduct.setOrder(commercialOrder);
		orderProduct.setOrderServiceCommercial(orderLot);
		orderProduct.setProductVersion(product.getProductVersion());
		orderProduct.setQuantity(product.getQuantity());
		orderProduct.setDiscountPlan(product.getDiscountPlan());
		orderProduct.setOrderOffer(orderOffer);  
		
		orderProductService.create(orderProduct);
		
		product.getQuoteAttributes().forEach(quoteAttribute -> {
			processOrderAttribute(quoteAttribute, commercialOrder, orderLot, orderProduct);
		});
		
		product.getQuoteArticleLines().forEach(quoteArticleLine -> {
			OrderArticleLine orderArticleLine = processOrderArticleLine(quoteArticleLine, commercialOrder, orderLot, orderProduct);
			processOrderPrice(quoteArticleLine.getId(), orderArticleLine, commercialOrder, product.getQuoteOffre().getQuoteVersion());
		});
		
		
		return orderProduct;
	}
	
	private void processOrderAttribute(QuoteAttribute quoteAttribute, CommercialOrder commercialOrder, OrderLot orderLot, OrderProduct orderProduct) {
		OrderAttribute orderAttribute = new OrderAttribute(quoteAttribute, currentUser);
		orderAttribute.setCommercialOrder(commercialOrder);
		orderAttribute.setOrderLot(orderLot);
		orderAttribute.setOrderProduct(orderProduct);
		orderAttribute.setAccessPoint(null);
		orderAttributeService.create(orderAttribute);
	}
	
	private OrderLot processOrderCustomerService(QuoteLot quoteLot, CommercialOrder commercialOrder) {
		OrderLot orderCustomer = new OrderLot();
		orderCustomer.setCode(UUID.randomUUID().toString());
		orderCustomer.setCode(orderCustomerServiceService.findDuplicateCode(orderCustomer));
		orderCustomer.setOrder(commercialOrder);
		orderCustomerServiceService.create(orderCustomer);
		return orderCustomer;
	}
	
	private OrderArticleLine processOrderArticleLine(QuoteArticleLine quoteArticleLine, CommercialOrder commercialOrder, OrderLot orderCustomerService, OrderProduct orderProduct) {
		OrderArticleLine articleLine = new OrderArticleLine();
		articleLine.setCode(orderArticleLineService.findDuplicateCode(articleLine));
		articleLine.setOrder(commercialOrder);
		articleLine.setOrderCustomerService(orderCustomerService);
		articleLine.setQuantity(quoteArticleLine.getQuantity());
		articleLine.setQuantityService(quoteArticleLine.getServiceQuantity());
		articleLine.setAccountingArticle(quoteArticleLine.getAccountingArticle());
		articleLine.setOrderProduct(orderProduct);
		orderArticleLineService.create(articleLine);
		return articleLine;
	}
	
	private void processOrderPrice(Long quoteArticleLineId, OrderArticleLine orderArticleLine, CommercialOrder commercialOrder, QuoteVersion quoteVersion) {
		var quotePrices = quotePriceService.findByQuoteArticleLineIdandQuoteVersionId(quoteArticleLineId, quoteVersion.getId());
		quotePrices.forEach( price -> {
			OrderPrice orderPrice = new OrderPrice();
			orderPrice.setCode(UUID.randomUUID().toString());
			orderPrice.setCode(orderPriceService.findDuplicateCode(orderPrice));
			orderPrice.setOrderArticleLine(orderArticleLine);
			orderPrice.setOrder(commercialOrder);
			orderPrice.setPriceLevelEnum(price.getPriceLevelEnum());
			orderPrice.setAmountWithTax(price.getAmountWithTax());
			orderPrice.setUnitPriceWithoutTax(price.getUnitPriceWithoutTax());
			orderPrice.setAmountWithoutTax(price.getAmountWithoutTax());
			orderPrice.setAmountWithoutTaxWithDiscount(price.getAmountWithoutTaxWithDiscount());
			orderPrice.setTaxAmount(price.getTaxAmount());
			orderPrice.setTaxRate(price.getTaxRate());
			orderPrice.setPriceOverCharged(price.getPriceOverCharged());
			orderPrice.setCurrencyCode(price.getCurrencyCode());
			orderPrice.setRecurrenceDuration(price.getRecurrenceDuration());
			orderPrice.setRecurrencePeriodicity(price.getRecurrencePeriodicity());
			orderPrice.setChargeTemplate(price.getChargeTemplate());
			orderPriceService.create(orderPrice);
		});
	}
	
}

	');
        ]]></sql>
        
           
        
        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-27, 0, 0, now(), 'org.meveo.api.billing.OrderAdvancement', 'OrderAdvancement', 'JAVA', '
  package org.meveo.api.billing;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import org.meveo.admin.exception.BusinessException;
import org.meveo.api.cpq.CommercialOrderApi;
import org.meveo.api.exception.EntityDoesNotExistsException;
import org.meveo.commons.utils.ParamBean;
import org.meveo.model.article.AccountingArticle;
import org.meveo.model.billing.Invoice;
import org.meveo.model.billing.InvoiceType;
import org.meveo.model.catalog.ChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplateTypeEnum;
import org.meveo.model.cpq.Attribute;
import org.meveo.model.cpq.AttributeValue;
import org.meveo.model.cpq.Product;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.InvoiceLine;
import org.meveo.model.cpq.commercial.InvoicingPlanItem;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.service.billing.impl.InvoiceLinesService;
import org.meveo.service.billing.impl.InvoiceService;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.billing.impl.article.AccountingArticleService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class OrderAdvancement extends ModuleScript {

    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private CommercialOrderApi commercialOrderApi = (CommercialOrderApi) getServiceInterface(CommercialOrderApi.class.getSimpleName());
    private AccountingArticleService accountingArticleService = (AccountingArticleService) getServiceInterface(AccountingArticleService.class.getSimpleName());
    private InvoiceLinesService invoiceLinesService = (InvoiceLinesService) getServiceInterface(InvoiceLinesService.class.getSimpleName());
    private InvoiceService invoiceService = (InvoiceService) getServiceInterface(InvoiceService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private Logger log = LoggerFactory.getLogger(this.getClass());


    @Override
    public void execute(Map<String, Object> methodContext) throws BusinessException {
        CommercialOrder commercialOrder = (CommercialOrder) methodContext.get("commercialOrder");
        if(commercialOrder == null) {
            throw new BusinessException("No Commercial order is found");
        }
        Integer orderProgress = commercialOrder.getOrderProgress();

        if (commercialOrder.getInvoicingPlan() != null) {

            Date nextDay = java.sql.Date.valueOf(LocalDate.now().plusDays(1));
            Date firstTransactionDate = java.sql.Date.valueOf(LocalDate.now().minusDays(1));
            Date invoiceDate = new Date();
            List<OrderPrice> pricesToBill = orderPriceService.findByOrder(commercialOrder).stream()
                    .filter(this::isPriceRelatedToOneShotChargeTemplateOfTypeOther)
                    .collect(Collectors.toList());

            if (pricesToBill.isEmpty()) {
                log.info("No order prices to bill related to a one shot charge were found for commercial order: " + commercialOrder.getId());
                return;
            }

            AccountingArticle defaultAccountingArticle = getDefaultAccountingArticle();

            BigDecimal totalAmountWithoutTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithoutTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalAmountWithTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTax = pricesToBill.stream()
                    .map(OrderPrice::getTaxAmount)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTaxRate = pricesToBill.stream()
                    .map(OrderPrice::getTaxRate)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            OrderProduct orderProduct = pricesToBill.get(0).getOrderArticleLine().getOrderProduct();

            if(orderProgress == 100) {
                if(commercialOrder.getRateInvoiced() < 100) {
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                    commercialOrder.setOrderProgressTmp(orderProgress);
                    commercialOrder.setRateInvoiced(100);
                }
                commercialOrderApi.validateOrder(commercialOrder, true);
            } else {
                List<InvoicingPlanItem> itemsToBill = commercialOrder.getInvoicingPlan().getInvoicingPlanItems().stream()
                        .filter(item -> item.getAdvancement() == orderProgress)
                        .collect(Collectors.toList());

                if (itemsToBill.isEmpty()) {
                    log.info("No invoicing plan item found for the order progress: " + orderProgress + " commercial order id: " + commercialOrder.getId());
                    return;
                } else if (itemsToBill.size() > 1)
                    throw new BusinessException("Many invoicing plan items are set for the advancement: " + orderProgress + " using the invoicing plan: " + commercialOrder.getInvoicingPlan().getCode());

                InvoicingPlanItem invoicingPlanItem = itemsToBill.get(0);

                BigDecimal newRateInvoiced = invoicingPlanItem.getRateToBill().add(BigDecimal.valueOf(commercialOrder.getRateInvoiced()));
                if (newRateInvoiced.compareTo(BigDecimal.valueOf(100)) > 0) {
                    throw new BusinessException("the invoicing plan rate is grater than remaining rate to invoice");
                }
                if(newRateInvoiced.compareTo(BigDecimal.valueOf(100)) == 0){
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                }else {
                    BigDecimal amountWithoutTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithoutTax);
                    BigDecimal amountWithTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithTax);
                    BigDecimal taxAmountToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalTax);

                    createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
                    List<Invoice> invoices=invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,true);
                }
                commercialOrder.setRateInvoiced(newRateInvoiced.intValue());
                commercialOrder.setOrderProgressTmp(orderProgress);
                commercialOrderService.update(commercialOrder);
            }
        }


    }

    private void generateGlobalInvoice(CommercialOrder commercialOrder, Date nextDay, Date firstTransactionDate, Date invoiceDate, AccountingArticle defaultAccountingArticle, BigDecimal totalAmountWithoutTax, BigDecimal totalAmountWithTax, BigDecimal totalTax, BigDecimal totalTaxRate, OrderProduct orderProduct) {
        Map<String, Object> attributes = new HashMap<String, Object>();
        List<AttributeValue> orderAttributes = orderProduct.getOrderAttributes().stream().map(oa -> (AttributeValue)oa).collect(Collectors.toList());
        for (AttributeValue orderAttribute : orderAttributes) {
            Attribute attribute = orderAttribute.getAttribute();
            Object value = attribute.getAttributeType().getValue(orderAttribute);
            if (value != null) {
                attributes.put(orderAttribute.getAttribute().getCode(), value);
            }
        }
        Product product = orderProduct.getProductVersion().getProduct();
        Optional<AccountingArticle> accountingArticle = accountingArticleService.getAccountingArticle(product, attributes);
        if (!accountingArticle.isPresent())
            throw new BusinessException("No accounting article found for product code: " + product.getCode() + " and attributes: " + attributes.toString());

        List<InvoiceLine> accounts = invoiceLinesService.findByCommercialOrder(commercialOrder);
        for(InvoiceLine account : accounts){
            createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, account.getAmountWithoutTax().negate(), account.getAmountWithTax().negate(), account.getAmountTax().negate(), account.getTaxRate());
        }

        createInvoiceLine(commercialOrder, accountingArticle.get(), orderProduct, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate);
        invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,false);
      
    }

    private AccountingArticle getDefaultAccountingArticle() {
        String articleCode = ParamBean.getInstance().getProperty("advancePayment.accountingArticleCode", "ACT-STD");

        AccountingArticle accountingArticle = accountingArticleService.findByCode(articleCode);
        if (accountingArticle == null)
            throw new EntityDoesNotExistsException(AccountingArticle.class, articleCode);
        return accountingArticle;
    }

    private void createInvoiceLine(CommercialOrder commercialOrder, AccountingArticle accountingArticle, OrderProduct orderProduct, BigDecimal amountWithoutTaxToBeInvoiced, BigDecimal amountWithTaxToBeInvoiced, BigDecimal taxAmountToBeInvoiced, BigDecimal totalTaxRate) {
        invoiceLinesService.createInvoiceLine(commercialOrder, accountingArticle, orderProduct.getProductVersion(),orderProduct.getOrderServiceCommercial(), amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
    }

    private boolean isPriceRelatedToOneShotChargeTemplateOfTypeOther(OrderPrice price) {
        return price.getChargeTemplate().getChargeMainType() == ChargeTemplate.ChargeMainTypeEnum.ONESHOT
                && ((OneShotChargeTemplate) price.getChargeTemplate()).getOneShotChargeTemplateType() == OneShotChargeTemplateTypeEnum.OTHER;
    }


}

	
	
	');
        ]]></sql>
        
          </changeSet>
          
       <changeSet id="#270_20210222" author="Mbarek-Ay">
        <addColumn tableName="cpq_media">  
		<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="description" type="varchar(255)" />
		</addColumn>
		 <dropColumn tableName="cpq_media">
            <column name="product_id"></column>
            <column name="offer_id"></column>
            <column name="attribute_id"></column>
             <column name="service_template_id"></column>
        </dropColumn>

	<createTable tableName="cpq_offer_template_media">
		<column name="offer_template_id" type="bigint">
			<constraints nullable="false" />
		</column>
		<column name="media_id" type="bigint">
			<constraints nullable="false" />
		</column>
	</createTable>
 <addUniqueConstraint columnNames="offer_template_id,media_id" constraintName="cpq_offer_template_media_pkey" tableName="cpq_offer_template_media" />
	<addForeignKeyConstraint
		baseTableName="cpq_offer_template_media"
		baseColumnNames="offer_template_id"
		constraintName="cpq_offer_template_media_offer_template_id_fk"
		referencedTableName="cat_offer_template" referencedColumnNames="id" />

	<addForeignKeyConstraint
		baseTableName="cpq_offer_template_media" baseColumnNames="media_id"
		constraintName="cpq_offer_template_media_media_id_fk"
		referencedTableName="cpq_media" referencedColumnNames="id" />  
		
		
   <createTable tableName="cpq_product_media">
		<column name="product_id" type="bigint">
			<constraints nullable="false" />
		</column>
		<column name="media_id" type="bigint">
			<constraints nullable="false" />
		</column>
	</createTable>
<addUniqueConstraint columnNames="product_id,media_id" constraintName="cpq_product_media_pkey" tableName="cpq_product_media" />
	<addForeignKeyConstraint
		baseTableName="cpq_product_media"
		baseColumnNames="product_id"
		constraintName="cpq_product_media_product_id_fk"
		referencedTableName="cpq_product" referencedColumnNames="id" />

	<addForeignKeyConstraint
		baseTableName="cpq_product_media" baseColumnNames="media_id"
		constraintName="cpq_product_media_id_fk"
		referencedTableName="cpq_media" referencedColumnNames="id" />  
		
		
	 <createTable tableName="cpq_attribute_media">
		<column name="attribute_id" type="bigint">
			<constraints nullable="false" />
		</column>
		<column name="media_id" type="bigint">
			<constraints nullable="false" />
		</column>
	</createTable>
<addUniqueConstraint columnNames="attribute_id,media_id" constraintName="cpq_attribute_media_pkey" tableName="cpq_attribute_media" />
	<addForeignKeyConstraint
		baseTableName="cpq_attribute_media"
		baseColumnNames="attribute_id"
		constraintName="cpq_attribute_media_attribute_id_fk"
		referencedTableName="cpq_attribute" referencedColumnNames="id" />

	<addForeignKeyConstraint
		baseTableName="cpq_attribute_media" baseColumnNames="media_id"
		constraintName="cpq_attribute_media_id_fk"
		referencedTableName="cpq_media" referencedColumnNames="id" /> 	    
        
</changeSet>
        
        
        
  
    
    <changeSet id="#20210222_540_269" author="TarikFA.">
    	<dropColumn tableName="cpq_grouped_attributes">
    		<column name="product_version_id"></column>
    	</dropColumn>
    	
    	<dropColumn tableName="cpq_attribute">
    		<column name="grouped_attributes_id"></column>
    	</dropColumn>
    	
	    <createTable tableName="cpq_grouped_attributes_attribute">
            <column name="grouped_attributes" type="bigint" >
            	<constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
            	<constraints nullable="false"/>
            </column>
        </createTable>
        
        
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="grouped_attributes" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_groupedattribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
	        
    </changeSet>
    
    <changeSet id="#20210222_540_269" author="TarikFA.">
    	<dropColumn tableName="cpq_grouped_attributes">
    		<column name="product_version_id"></column>
    	</dropColumn>
    	
    	<dropColumn tableName="cpq_attribute">
    		<column name="grouped_attributes_id"></column>
    	</dropColumn>
    	
	    <createTable tableName="cpq_grouped_attributes_attribute">
            <column name="grouped_attributes" type="bigint" >
            	<constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
            	<constraints nullable="false"/>
            </column>
        </createTable>
        
        
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="grouped_attributes" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_groupedattribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
	        
    </changeSet>
    
    <changeSet id="#20210123_540_280" author="TarikFA.">
    
    	<addColumn tableName="adm_secured_entity">
    		<column name="disable" type="boolean" defaultValueNumeric="0">
    			<constraints nullable="false" />
    		</column>
    	</addColumn>
    	
    	<addColumn tableName="adm_role_secured_entity">
    		<column name="disable" type="boolean" defaultValueNumeric="0" >
    			<constraints nullable="false" />
    		</column>
    	</addColumn>
    	
    </changeSet>
    
    
    <changeSet   id="#20210123_540_281" author="TarikFA.">
        <addColumn tableName="adm_role">
            <column name="uuid" type="varchar(60)" defaultValue="" />
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
			<column name="created" type="datetime" defaultValueDate="now()">
				<constraints nullable="false" />
			</column>
			<column name="creator" type="varchar(100)" />
			<column name="updated" type="datetime" />
			<column name="updater" type="varchar(100)" />
        </addColumn>
        <sql>update ${db.schema.adapted}adm_role set uuid = 'role'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
    </changeSet>

	<changeSet id="#20210224_5868" author="Mbarek-Ay">
	<addColumn tableName="cpq_commercial_order">
	<column name="oneshot_total_amount" type="numeric(23, 12)" />
	</addColumn>
	<dropForeignKeyConstraint baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id"/>
		<addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_quote_offer_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
 </changeSet>
	
	<changeSet id="#20210222_907" author="ZBariki">
		<addColumn tableName="billing_invoice">
			<column name="has_taxes" type="${type.boolean}" defaultValueNumeric="0"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="has_discounts" type="${type.boolean}" defaultValueNumeric="0"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="has_minimum" type="${type.boolean}" defaultValueNumeric="0"/>
		</addColumn>
	</changeSet>
	
	<changeSet id="#20210302_540" author="TarikFA.">
		<dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id"/>
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
	</changeSet>
	
	<changeSet id="#20210303_540305" author="TarikFA.">
		<dropForeignKeyConstraint baseTableName="cat_service_template" constraintName="fk-product-accounting_article"/>
		<dropColumn tableName="cat_service_template">
			<column name="accounting_article_id" />
		</dropColumn>
		<dropTable tableName="cpq_accounting_article"/>
		<dropSequence sequenceName="cpq_accounting_article_seq"/>
	</changeSet>
	
	<changeSet id="#20210304_540320" author="TarikFA.">
	
		<addColumn tableName="cpq_quote_attribute">
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
		</addColumn>
		
        <sql>update ${db.schema.adapted}cpq_quote_attribute set uuid = 'quote_attribute'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
		
		<addColumn tableName="cpq_order_item">
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
		</addColumn>
		
        <sql>update ${db.schema.adapted}cpq_order_item set uuid = 'order_item'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
		
		<addColumn tableName="cpq_attribute_instance">
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
		</addColumn>
		
        <sql>update ${db.schema.adapted}cpq_attribute_instance set uuid = 'attribute_instance'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
		
		<addColumn tableName="ar_payment_token">
           	<column name="cf_values" type="${type.json}" />
           	<column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
		</addColumn>
		
        <sql>update ${db.schema.adapted}ar_payment_token set uuid = 'payment_token'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
        
        <addColumn tableName="cpq_attribute">
        	<column name="read_only" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        
        <addColumn tableName="account_entity">
        	<column name="address_4" type="varchar(255)" />
        	<column name="address_5" type="varchar(255)" />
        </addColumn>
        
        <addColumn tableName="com_sender_config">
        	<column name="address_4" type="varchar(255)" />
        	<column name="address_5" type="varchar(255)" />
        </addColumn>
        
        <addColumn tableName="crm_provider">
        	<column name="address_4" type="varchar(255)" />
        	<column name="address_5" type="varchar(255)" />
        </addColumn>
        
        <addColumn tableName="crm_provider_contact">
        	<column name="address_4" type="varchar(255)" />
        	<column name="address_5" type="varchar(255)" />
        </addColumn>
        
        <addColumn tableName="ord_order_item">
        	<column name="address_4" type="varchar(255)" />
        	<column name="address_5" type="varchar(255)" />
        </addColumn>
        
		<addColumn tableName="cpq_offer_component">
			<column name="sequence" type="int4" defaultValueNumeric="0"/>
        	<column name="mandatory" type="${type.boolean}" defaultValueNumeric="0"/>
        	<column name="display" type="${type.boolean}" />
		</addColumn>
		
	</changeSet>
	

     <changeSet id="#20210304-312" author="Mbarek-Ay">
		<addColumn tableName="cpq_order_item">
			<column name="cpq_order_offer_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="cpq_order_offer_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_cpq_order_offer_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
	  </changeSet>
	  
	  
	   <changeSet id="#20210310-342" author="Mbarek-Ay">
		<addColumn tableName="billing_invoice">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_discount_plan_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
		
		<addColumn tableName="cat_discount_plan">
			<column name="expression_el" type="varchar(2000)" />
		</addColumn>	
		
			    <createTable tableName="discount_plan_item_articles">
	        <column name="discount_plan_item_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	        <column name="accounting_article_id" type="bigint">
	            <constraints nullable="false" />
	        </column>
	    </createTable>

	        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="discount_plan_item_id"
									 constraintName="discount_plan_item_articles_discount_plan_item_id_fk" referencedTableName="cat_discount_plan_item"
									 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="accounting_article_id"
                                 constraintName="discount_plan_item_articles_accounting_article_id_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>
                                 	     
	  </changeSet>

	<changeSet id="#20210315-329" author="Mbarek-Ay">
		<dropForeignKeyConstraint baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id"/>
		<addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_product_version_serviceInstance_id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version"/>
	</changeSet>


	<changeSet id="#20210316-356" author="Mbarek-Ay">
		<addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_product_id" deferrable="false"
								 initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product"/>

	        <addForeignKeyConstraint baseColumnNames="discount_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_discount_id" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" /> 
	            
	  </changeSet>
	
	  <changeSet id="#20210316-356-2" author="Mbarek-Ay">
        <addColumn tableName="cat_discount_plan_item">
			<column name="price_plan_matrix_id" type="bigint" />
	  </addColumn>
	  <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_discount_plan_item" constraintName="fk_cat_discount_plan_item_price_plan_matrix_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" /> 
	</changeSet>

	<changeSet id="#20210317_M540_16" author="TarikFA.">
		<dropColumn tableName="cpq_tag">
			<column name="attribute_id" />
		</dropColumn>
		
		<createTable tableName="cpq_attribute_tag">
            <column name="tag_id" type="bigint" >
            	<constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
            	<constraints nullable="false"/>
            </column>
        </createTable>
        
        <addPrimaryKey columnNames="tag_id,attribute_id" tableName="cpq_attribute_tag"/>
        
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_attribute_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_tag_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
            
	</changeSet>
	
	<changeSet id="#2020317-342" author="Mbarek-Ay">
		<addColumn tableName="cpq_order_product">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_discount_plan_id" deferrable="false"
								 initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>

		<addColumn tableName="cpq_order_offer">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_discount_plan_id" deferrable="false"
								 initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>


		<addColumn tableName="cpq_quote_version">
			<column name="invoicing_plan_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_invoicing_plan_id" deferrable="false"
								 initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan"/>
	</changeSet>
	
	<changeSet id="#20210322_377" author="TarikFA.">
		<addColumn tableName="cpq_attribute">
			<column name="default_value" type="varchar(255)"></column>
		</addColumn>
		<addColumn tableName="cpq_offer_component">
			<column name="quantity_min" type="int4" />
			<column name="quantity_max" type="int4" />
			<column name="quantity_default" type="int4" />
		</addColumn>
	</changeSet>
	
	<changeSet id="#20210323_380" author="TarikFA.">
		<addColumn tableName="cat_discount_plan_item">
			<column name="description" type="varchar(255)"/>
		</addColumn>
	</changeSet>
	
		<changeSet id="#20210323-382" author="Mbarek-Ay">
		<addColumn tableName="cpq_contract_item">
			<column name="rate_type" type="varchar(255)"/>
		</addColumn>
	</changeSet>

	<changeSet id="#20210323-382" author="Mbarek-Ay">
		<addColumn tableName="cpq_contract_item">
			<column name="rate_type" type="varchar(255)"/>
		</addColumn>
	</changeSet>	
	<changeSet id="#20220325_360" author="TarikFA.">
		<createTable tableName="cpq_commercial_order_order_lot">
	        	<column name="commercial_order_id" type="bigint">
	        		<constraints nullable="false"/>
	        	</column>
	        	<column name="order_lot_id" type="bigint">
	        		<constraints nullable="false"/>
	        	</column>
	        </createTable>

	        <addPrimaryKey columnNames="commercial_order_id,order_lot_id" tableName="cpq_commercial_order_order_lot"/>

        	<addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_commercial_order_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        	<addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_order_lot_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />
            	
	</changeSet>
	<changeSet id="#20210329_399" author="TarikFA.">
            <renameTable newTableName="cpq_order_attribute" oldTableName="cpq_order_item"/>
    </changeSet>
    <changeSet id="#20210401_402" author="TarikFA.">
    	<addColumn tableName="account_entity">
    		<column name="company" type="${type.boolean}"/>
    		<column name="legal_entity_type_id" type="bigint" />
    	</addColumn>
        	<addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="account_entity" constraintName="fk_account_entity_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
    </changeSet>
    
    <changeSet id="#20210406_opencell-portal-593" author="TarikFA.">
    	<dropForeignKeyConstraint baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_service_template"/>
    	<addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_offer_template" deferrable="false" initiallyDeferred="false"
            	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

	<changeSet id="rebuild-str-tbl_5946_20210110" author="ZBariki">
		<addColumn tableName="cat_discount_plan">
			<column name="status" type="varchar(50)"/>
			<column name="status_date" type="datetime"/>
			<column name="initial_quantity" type="bigint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="used_quantity" type="bigint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="application_limit" type="bigint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
			<column name="application_filter_el" type="varchar(2000)"/>
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cat_discount_plan"
								 constraintName="fk_discount_plan_id"
								 referencedColumnNames="id" referencedTableName="cat_discount_plan"/>
		<addColumn tableName="cat_discount_plan_item">
			<column name="allow_to_negate" type="${type.boolean}"/>
		</addColumn>
		<addColumn tableName="billing_discount_plan_instance">
			<column name="status" type="varchar(50)"/>
			<column name="status_date" type="datetime"/>
			<column name="application_count" type="bigint" defaultValueNumeric="0">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<sql>UPDATE ${db.schema.adapted}cat_discount_plan set status='DRAFT', status_date= now() WHERE status IS NULL</sql>
		<createTable tableName="cat_discount_applicable_entity">
			<column name="disount_plan_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
			<column name="entity_class" type="varchar(255)">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<addPrimaryKey columnNames="disount_plan_id, code, entity_class" constraintName="cat_discount_applicable_entity_pkey" tableName="cat_discount_applicable_entity"/>
	</changeSet>

	<changeSet id="rebuild-str-tbl_5884_20210119" author="ZBariki">
		<addColumn tableName="billing_invoice">
			<column name="status_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="xml_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="pdf_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="email_sent_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="payment_status" type="varchar(255)"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="payment_status_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="start_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="end_date" type="datetime"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="raw_amount" type="numeric(23, 12)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="discount_amount" type="numeric(23, 12)">
				<constraints nullable="false"/>
			</column>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="discount_rate" type="numeric(3, 3)">
			</column>
		</addColumn>

		<addColumn tableName="billing_invoice">
			<column name="is_already_applied_minimum" type="${type.boolean}"/>
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="is_already_added_discount" type="${type.boolean}"/>
		</addColumn>
	</changeSet>

	<changeSet id="rebuild-str-col_5991_20210224" author="HatimOUDAD">
		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_subcategory_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_configuration_invoice_subcategory_id" referencedTableName="billing_invoice_sub_cat"
								 baseColumnNames="default_invoice_subcategory_id" baseTableName="billing_invoice_configuration" referencedColumnNames="id"/>

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_generic_article_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_configuration_generic_article_id" referencedTableName="billing_accounting_article"
								 baseColumnNames="default_generic_article_id" baseTableName="billing_invoice_configuration" referencedColumnNames="id"/>

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_discount_article_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_configuration_discount_article_id" referencedTableName="billing_accounting_article"
								 baseColumnNames="default_discount_article_id" baseTableName="billing_invoice_configuration" referencedColumnNames="id"/>

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_advanced_payment_article_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_configuration_advanced_payment_article_id" referencedTableName="billing_accounting_article"
								 baseColumnNames="default_advanced_payment_article_id" baseTableName="billing_invoice_configuration" referencedColumnNames="id"/>

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_minimum_article_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_invoice_configuration_invoice_minimum_article_id" referencedTableName="billing_accounting_article"
								 baseColumnNames="default_invoice_minimum_article_id" baseTableName="billing_invoice_configuration" referencedColumnNames="id"/>
	</changeSet>



	<changeSet id="rebuild-str-fk_6012_20210323" author="MohamedAliHammal">
		<dropForeignKeyConstraint baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02"/>
		<addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02" deferrable="false" initiallyDeferred="false"
								 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
		<dropForeignKeyConstraint baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx"/>
		<addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx" deferrable="false" initiallyDeferred="false"
								 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
		<dropForeignKeyConstraint baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa"/>
		<addForeignKeyConstraint baseColumnNames="inbound_request_id" baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
								 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
		<dropForeignKeyConstraint baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq"/>
		<addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq" deferrable="false" initiallyDeferred="false"
								 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
		<dropForeignKeyConstraint baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020"/>
		<addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020" deferrable="false" initiallyDeferred="false"
								 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
		<dropForeignKeyConstraint baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt"/>
		<addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt" deferrable="false" initiallyDeferred="false"
								 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
	</changeSet>
	<changeSet id="rebuild_5621_20201104_offer_template" author="NabilOUACHI">
		<addColumn tableName="cat_offer_template">
			<column name="offer_template_id" type="bigint"/>
		</addColumn>

		<addForeignKeyConstraint baseTableName="cat_offer_template" baseColumnNames="offer_template_id"
								 constraintName="offer_template_offer_template_fk" referencedTableName="cat_offer_template"
								 referencedColumnNames="id"/>
	</changeSet>
	
	 <changeSet id="#20210415-435" author="Mbarek-Ay">
		<addColumn tableName="billing_invoice">
			<column name="commercial_order_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
			     onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
	  </changeSet>
	  
	  <changeSet id="#20210416_441" author="TarikFA.">
	  	<addColumn tableName="cpq_offer_component">
	  		<column name="product_set" type="varchar(250)"/>
	  	</addColumn>
	  </changeSet>

</databaseChangeLog>