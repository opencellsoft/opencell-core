<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
        <changeSet id="#3773_20181130" author="abdelkader.bouazza">
            <modifyDataType tableName="dwh_report_extract" columnName="sql_query" newDataType="${type.text}"/>
            <modifyDataType tableName="dwh_report_extract" columnName="sql_query" newDataType="${type.text}"/>

            <modifyDataType tableName="rating_edr" columnName="reject_reason" newDataType="${type.text}"/>

            <modifyDataType tableName="cat_triggered_edr" columnName="param_1_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_triggered_edr" columnName="param_2_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_triggered_edr" columnName="param_3_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_triggered_edr" columnName="param_4_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_triggered_edr" columnName="quantity_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_triggered_edr" columnName="subscription_el" newDataType="${type.text}"/>

            <modifyDataType tableName="cat_price_plan_matrix" columnName="invoice_subcategory_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="minimum_amount_with_tax_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="minimum_amount_without_tax_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="rating_el_with_tax" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="wo_description_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="amount_with_tax_el" newDataType="${type.text}"/>
            <modifyDataType tableName="cat_price_plan_matrix" columnName="amount_without_tax_el" newDataType="${type.text}"/>

            <modifyDataType tableName="ar_ddrequest_lot" columnName="file_name" newDataType="${type.text}"/>
            <modifyDataType tableName="ar_account_operation" columnName="bank_lot" newDataType="${type.text}"/>
        </changeSet>

        <changeSet id="#3680 - Extend FtpAdapterJob to support file export and SFTP-P" author="mboukayoua" dbms="postgresql">
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_localDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_removeOriginalFile')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_ftpInputDirectory', 'FtpAdapterJob_remoteDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, '}]}', '}],&quot;FtpAdapterJob_operation&quot;:[{&quot;string&quot;:&quot;IMPORT&quot;}]}')" />
        </update>
        <renameColumn tableName="ftp_imported_file" oldColumnName="import_date" newColumnName="transfer_date" columnDataType="datetime"/>
        <addColumn tableName="ftp_imported_file">
            <column name="operation" type="varchar(100)" value="IMPORT" defaultValue="IMPORT" />
        </addColumn>
        <renameTable oldTableName="ftp_imported_file" newTableName="ftp_transferred_file" />
        <sql><![CDATA[
            ALTER INDEX IF EXISTS ftp_imported_file_pkey RENAME TO ftp_transferred_file_pkey;
            ALTER SEQUENCE IF EXISTS ftp_imported_file_seq RENAME TO ftp_transferred_file_seq;
        ]]>
        </sql>
        <sql><![CDATA[
            DELETE FROM crm_custom_field_tmpl_val WHERE customfieldtemplate_id IN (SELECT id FROM crm_custom_field_tmpl WHERE applies_to='JOB_FtpAdapterJob' AND code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory'));
        ]]>
        </sql>
        
        <delete tableName="crm_custom_field_tmpl">
            <where>applies_to='JOB_FtpAdapterJob' AND
                code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory')
            </where>
        </delete>
    </changeSet>

    <changeSet id="#3680 - Extend FtpAdapterJob to support file export and SFTP-M" author="mboukayoua" dbms="mysql">
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_localDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_removeOriginalFile')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_ftpInputDirectory', 'FtpAdapterJob_remoteDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, '}]}', '}],&quot;FtpAdapterJob_operation&quot;:[{&quot;string&quot;:&quot;IMPORT&quot;}]}')" />
        </update>
        <renameColumn tableName="ftp_imported_file" oldColumnName="import_date" newColumnName="transfer_date" columnDataType="datetime"/>
        <addColumn tableName="ftp_imported_file">
            <column name="operation" type="varchar(100)" value="IMPORT" defaultValue="IMPORT" />
        </addColumn>
        <renameTable oldTableName="ftp_imported_file" newTableName="ftp_transferred_file" />
        <createIndex tableName="ftp_transferred_file" indexName="ftp_transferred_file_pkey">
            <column name="id" type="bigint"/>
        </createIndex>
        <createSequence sequenceName="ftp_transferred_file_seq" startValue="1"/>
        <dropSequence sequenceName="ftp_imported_file_seq"/>
        <sql><![CDATA[
            DELETE FROM crm_custom_field_tmpl_val WHERE customfieldtemplate_id IN (SELECT id FROM crm_custom_field_tmpl WHERE applies_to='JOB_FtpAdapterJob' AND code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory'));
        ]]>
        </sql>
        <delete tableName="crm_custom_field_tmpl">
            <where>applies_to='JOB_FtpAdapterJob' AND
                code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory')
            </where>
        </delete>
    </changeSet>

    <changeSet id="#3644_04102018" author="AbdellatifBari">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="display_format" type="varchar(80)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3735_20181031_add_legal_information_seller" author="Khalid HORRI">
        <addColumn tableName="crm_seller">
            <column name="vat_no" type="varchar(100)"></column>
            <column name="registration_no" type="varchar(100)"></column>
            <column name="legal_text" type="text"></column>
            <column name="legal_type" type="varchar(255)"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#3464_20180522" author="AndriusKarpavicius">
        <addColumn tableName="crm_provider">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="account_entity">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="adm_user">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_cat">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_sub_cat">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_tax">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="crm_seller">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="medina_access">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="meveo_job_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="meveo_filter">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cust_cei">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_offer_template_category">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_product_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ord_order">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ord_quote">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_gateway">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_type">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_ddrequest_builder">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>

        <sql>update ${db.schema.adapted}crm_provider set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}account_entity set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}adm_user set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_account_operation set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_cycle set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_cat set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_sub_cat set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_service_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_subscription set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_tax set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_charge_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_offer_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_service_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}crm_seller set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}medina_access set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}meveo_filter set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cust_cei set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_offer_template_category set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_product_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ord_order set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ord_quote set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_payment_gateway set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_billing_run set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}dwh_report_extract set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_type set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_ddrequest_builder set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_payment_schedule_tmpl set cf_values_accum=cf_values</sql>
    </changeSet>

     <changeSet id="#3841_20181228" author="SaidRamli">
        <addColumn tableName="crm_customer_category">
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </addColumn>
        <sql>update ${db.schema.adapted}crm_customer_category set uuid = concat('customer_cat_', id)</sql>
     </changeSet>

    <changeSet id="#3464_20180701" author="AndriusKarpavicius">
        <addColumn tableName="cat_usage_charge_template">
            <column name="filter_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="cat_triggered_edr">
            <column name="condition_el_sp" type="${type.text}" />
            <column name="subscription_el_sp" type="${type.text}" />
            <column name="param_1_el_sp" type="${type.text}" />
            <column name="param_2_el_sp" type="${type.text}" />
            <column name="param_3_el_sp" type="${type.text}" />
            <column name="param_4_el_sp" type="${type.text}" />
            <column name="quantity_el_sp" type="${type.text}" />
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="criteria_el_sp" type="varchar(2000)" />
            <column name="rating_el_with_tax_sp" type="${type.text}" />
            <column name="rating_el_without_tax_sp" type="varchar(2000)" />
            <column name="minimum_amount_without_tax_el_sp" type="${type.text}" />
            <column name="minimum_amount_with_tax_el_sp" type="${type.text}" />
            <column name="amount_without_tax_el_sp" type="${type.text}" />
            <column name="amount_with_tax_el_sp" type="${type.text}" />
            <column name="wo_description_el_sp" type="${type.text}" />
        </addColumn>
        <addColumn tableName="crm_customer_category">
            <column name="exoneration_tax_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_inv_sub_cat_country">
            <column name="tax_code_el_sp" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3577_20180727" author="AndriusKarpavicius">
        <addColumn tableName="ord_order">
            <column name="order_number " type="varchar(255)" />
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order set order_number = case when external_id is not null then external_id else code end where order_number is null</sql>
        <addColumn tableName="billing_billing_account">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="charge_instance_id" type="bigint" />
            <column name="tax_id" type="bigint" />
            <column name="tax_percent" type="numeric(23, 12)" />
            <column name="user_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_rt_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="account_entity" />
        <addColumn tableName="billing_wallet_operation">
            <column name="tax_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addColumn tableName="billing_cycle">
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
            <column name="invoice_type_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="order_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="billing_invoice" constraintName="fk_inv_subscription" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_invoice" constraintName="fk_inv_order" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ord_order" />
        <addColumn tableName="cat_discount_plan_item">
            <column name="expression_el_sp" type="varchar(2000)" />
            <column name="discount_percent_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_invoice_agregate">
            <column name="discount_plan_item_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_invoice_agregate" constraintName="fk_ia_dpi" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
        <addDefaultValue columnName="rounding_mode" tableName="crm_provider" defaultValue="NEAREST" />
        <addDefaultValue columnName="invoice_rounding_mode" tableName="crm_provider" defaultValue="NEAREST" />
        <sql>update ${db.schema.adapted}crm_provider set rounding_mode='NEAREST' where rounding_mode is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set invoice_rounding_mode='NEAREST' where invoice_rounding_mode is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set rating_rounding=2 where rating_rounding is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set invoice_rounding=2 where invoice_rounding is null</sql>
        <addNotNullConstraint tableName="crm_provider" columnName="rounding_mode" columnDataType="varchar(50)" />
        <addNotNullConstraint tableName="crm_provider" columnName="invoice_rounding_mode" columnDataType="varchar(50)" />
        <addNotNullConstraint tableName="crm_provider" columnName="rating_rounding" columnDataType="int4" />
        <addNotNullConstraint tableName="crm_provider" columnName="invoice_rounding" columnDataType="int4" />
    </changeSet>

    <changeSet id="#3577_20180727_migration_P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_rated_transaction set charge_instance_id = billing_wallet_operation.charge_instance_id, seller_id = billing_wallet_operation.seller_id from
            ${db.schema.adapted}billing_wallet_operation where
            billing_rated_transaction.wallet_operation_id=billing_wallet_operation.id and
            billing_rated_transaction.wallet_operation_id is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate set discount_plan_item_id = cat_discount_plan_item.id from ${db.schema.adapted}cat_discount_plan_item where
            cat_discount_plan_item.code=billing_invoice_agregate.discount_plan_item_code and
            billing_invoice_agregate.discount_plan_item_code is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate set tax_id = billing_invoice_agregate_taxes.tax_id from ${db.schema.adapted}billing_invoice_agregate_taxes where
            billing_invoice_agregate.id=billing_invoice_agregate_taxes.sub_cat_invoice_aggregat_id and billing_invoice_agregate.tax_id is null
        </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_wallet.user_account_id from ${db.schema.adapted}billing_wallet where
            billing_rated_transaction.wallet_id=billing_wallet.id
            and
            billing_rated_transaction.wallet_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_subscription.user_account_id from ${db.schema.adapted}billing_subscription where
            billing_rated_transaction.subscription_id=billing_subscription.id and
            billing_rated_transaction.subscription_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_charge_instance.user_account_id from ${db.schema.adapted}billing_charge_instance where
            billing_rated_transaction.charge_instance_id=billing_charge_instance.id and
            billing_rated_transaction.charge_instance_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
    </changeSet>

    <changeSet id="#3577_20180727_migration_M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_wallet_operation
            on billing_rated_transaction.wallet_operation_id=billing_wallet_operation.id
            set billing_rated_transaction.charge_instance_id = billing_wallet_operation.charge_instance_id,
            billing_rated_transaction.seller_id = billing_wallet_operation.seller_id
            where billing_rated_transaction.wallet_operation_id is not null</sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate join ${db.schema.adapted}cat_discount_plan_item
            on cat_discount_plan_item.code=billing_invoice_agregate.discount_plan_item_code
            set billing_invoice_agregate.discount_plan_item_id = cat_discount_plan_item.id
            where billing_invoice_agregate.discount_plan_item_code is not null</sql>

        <sql>update ${db.schema.adapted}billing_invoice_agregate join ${db.schema.adapted}billing_invoice_agregate_taxes
            on billing_invoice_agregate.id=billing_invoice_agregate_taxes.sub_cat_invoice_aggregat_id set
            billing_invoice_agregate.tax_id = billing_invoice_agregate_taxes.tax_id where billing_invoice_agregate.tax_id is null</sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_wallet
            on billing_rated_transaction.wallet_id=billing_wallet.id
            set billing_rated_transaction.user_account_id = billing_wallet.user_account_id
            where billing_rated_transaction.wallet_id is not null and billing_rated_transaction.user_account_id is null </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_charge_instance
            on billing_rated_transaction.charge_instance_id=billing_charge_instance.id
            set billing_rated_transaction.user_account_id = billing_charge_instance.user_account_id
            where billing_rated_transaction.charge_instance_id is not null and billing_rated_transaction.user_account_id is null </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_subscription
            on billing_rated_transaction.subscription_id=billing_subscription.id
            set billing_rated_transaction.user_account_id = billing_subscription.user_account_id
            where billing_rated_transaction.subscription_id is not null and billing_rated_transaction.user_account_id is null </sql>
    </changeSet>

    <changeSet id="#3577_20180827" author="AndriusKarpavicius">
        <addNotNullConstraint tableName="billing_rated_transaction" columnName="seller_id" columnDataType="bigint" />
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="seller_id" columnDataType="bigint" />
        <dropTable tableName="billing_invoice_agregate_taxes" />
    </changeSet>

    <changeSet id="spark_P" author="AndriusKarpavicius" dbms="postgresql">
        <addDefaultValue tableName="job_execution" columnName="id" defaultValueSequenceNext="job_execution_seq" />
        <addDefaultValue tableName="rating_edr" columnName="id" defaultValueSequenceNext="rating_edr_seq" />
        <addDefaultValue tableName="billing_rated_transaction" columnName="id" defaultValueSequenceNext="billing_rated_transaction_seq" />
        <addDefaultValue tableName="billing_invoice" columnName="id" defaultValueSequenceNext="billing_invoice_seq" />
        <addDefaultValue tableName="billing_invoice_agregate" columnName="id" defaultValueSequenceNext="billing_invoice_agregate_seq" />
    </changeSet>

    <changeSet id="#3755_20181031" author="MounirBahije">
        <addColumn tableName="ar_payment_gateway">
            <column name="webhooks_secret_key" type="varchar(255)" />
        </addColumn>
        <addColumn tableName="ar_payment_gateway">
            <column name="webhooks_key_id" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3705_20181019 - Create discount plan bridge table" author="EdwardPLegaspi">
        <dropUniqueConstraint tableName="cat_discount_plan_item" constraintName="uk_1q0ayvmttpoo254r1v8hl0kjn" />
        <addUniqueConstraint columnNames="discount_plan_id, code" constraintName="uk_1q0ayvmttpoo254r1v8hl0kjn" deferrable="false" disabled="false" initiallyDeferred="false" tableName="cat_discount_plan_item" />

        <addColumn tableName="cat_discount_plan_item">
            <column name="discount_plan_item_type" type="varchar(25)" />
            <column name="discount_amount" type="numeric(23, 12)" />
            <column name="start_date" type="date" />
            <column name="end_date" type="date" />
            <column name="default_duration" type="int4" />
            <column name="duration_unit" type="varchar(50)" />
        </addColumn>

        <update tableName="cat_discount_plan_item">
            <column name="discount_plan_item_type" value="PERCENTAGE"></column>
        </update>

        <createTable tableName="billing_discount_plan">
            <column name="billing_account_id" type="bigint"></column>
            <column name="discount_plan_id" type="bigint"></column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_billing_discount_plan_ba" referencedTableName="billing_billing_account" baseColumnNames="billing_account_id" baseTableName="billing_discount_plan"
            referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_billing_discount_plan_dp" referencedTableName="cat_discount_plan" baseColumnNames="discount_plan_id" baseTableName="billing_discount_plan"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#3705_20181019 - Migrate discount plan from ba to new table" author="EdwardPLegaspi" dbms="postgresql">
        <sql>INSERT INTO ${db.schema.adapted}billing_discount_plan (billing_account_id, discount_plan_id) SELECT id, discount_plan_id FROM ${db.schema.adapted}billing_billing_account;</sql>
    </changeSet>

    <changeSet id="#3705_20181019 - Migrate discount plan from ba to new table" author="EdwardPLegaspi" dbms="mysql">
        <sql>INSERT INTO ${db.schema.adapted}billing_discount_plan (billing_account_id, discount_plan_id) SELECT id, discount_plan_id FROM ${db.schema.adapted}billing_billing_account;</sql>
    </changeSet>

    <changeSet id="#3705_20181019 - Set the discount plan to null" author="EdwardPLegaspi">
        <update tableName="billing_billing_account">
            <column name="discount_plan_id"></column>
        </update>
    </changeSet>


    <changeSet id="#3765_20181106" author="AndriusKarpavicius">
        <addColumn tableName="crm_provider">
            <column name="invoice_config_id" type="bigint" />
            <column name="gdpr_config_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_provider_invoice_config" referencedTableName="billing_invoice_configuration" baseColumnNames="invoice_config_id" baseTableName="crm_provider"
            referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_provider_gdpr_config" referencedTableName="adm_gdpr_configuration" baseColumnNames="gdpr_config_id" baseTableName="crm_provider"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#3765_20181106-migration-P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}crm_provider set invoice_config_id = billing_invoice_configuration.id from ${db.schema.adapted}billing_invoice_configuration where
            crm_provider.id=billing_invoice_configuration.provider_id
        </sql>
        <sql>update ${db.schema.adapted}crm_provider set gdpr_config_id = adm_gdpr_configuration.id from ${db.schema.adapted}adm_gdpr_configuration where
            crm_provider.id=adm_gdpr_configuration.provider_id
        </sql>
    </changeSet>

    <changeSet id="#3765_20181106-migration-M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}crm_provider join ${db.schema.adapted}billing_invoice_configuration on crm_provider.id=billing_invoice_configuration.provider_id set crm_provider.invoice_config_id =
            billing_invoice_configuration.id
        </sql>
        <sql>update ${db.schema.adapted}crm_provider join ${db.schema.adapted}adm_gdpr_configuration on crm_provider.id=adm_gdpr_configuration.provider_id set crm_provider.gdpr_config_id =
            adm_gdpr_configuration.id
        </sql>
        <dropForeignKeyConstraint baseTableName="billing_invoice_configuration" constraintName="provider_invoice_configuration_fk" />
        <!-- does't exist
            <dropIndex tableName="billing_invoice_configuration" indexName="provider_invoice_configuration_fk" />
        -->
        <dropUniqueConstraint tableName="billing_invoice_configuration" constraintName="uk_billing_invoice_configuration" />
        <dropForeignKeyConstraint baseTableName="adm_gdpr_configuration" constraintName="fk_crm_provider_adm_gdpr_conf" />
        <dropIndex tableName="adm_gdpr_configuration" indexName="fk_crm_provider_adm_gdpr_conf" />
    </changeSet>

    <changeSet id="#3765_20181106-end" author="AndriusKarpavicius">
        <dropColumn tableName="billing_invoice_configuration" columnName="provider_id" />
        <dropColumn tableName="adm_gdpr_configuration" columnName="provider_id" />
    </changeSet>

    <changeSet id="#3770_20181108" author="AmineBenAicha">
        <addColumn tableName="ar_payment_schedule_tmpl">
    		<column name="script_instance_id" type="bigint" />
    	</addColumn>
    	<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_payment_schedule_tmpl" constraintName="fk_ps_script_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    </changeSet>
    
    <changeSet id="#3731_20181113" author="EdwardPLegaspi">
    	<dropForeignKeyConstraint baseTableName="billing_invoice_agregate" constraintName="fk_icmfsev8m5n386ifttcgelv40"/>
    	<addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_invoice_agregate" constraintName="fk_icmfsev8m5n386ifttcgelv40" deferrable="false" initiallyDeferred="false"
            onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>
    
    <changeSet author="SaidRamli" id="#3791_20181119">
        <modifyDataType columnName="sync_status"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="async_status"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="error_type"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="operation_category"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="payment_method_type"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="payment_method_name"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
    </changeSet>

    <changeSet id="#3823_20181125 - the invoice(s) that was paid when the payment are rejected" author="anasseh">
    		<addColumn tableName="ar_account_operation">
            <column name="rejected_payment_id" type="bigint" />
        </addColumn>
         <addForeignKeyConstraint constraintName="fk_ao_rejected_payment_id" referencedTableName="ar_account_operation" baseColumnNames="rejected_payment_id" baseTableName="ar_account_operation" referencedColumnNames="id"/>
    </changeSet>
	<changeSet author="hznibar" id="#3699_20181109_2" dbms="mysql">
        <createTable tableName="cat_calendar_holiday_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_calendar_holiday_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}cat_calendar_holiday_seq values(1)</sql>
    </changeSet>
    <changeSet author="hznibar" id="#3699_20181109">
    	<createSequence sequenceName="cat_calendar_holiday_seq" />
        <createTable tableName="cat_calendar_holiday">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_calendar_holiday_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="holiday_begin" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="holiday_end" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="calendar_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addColumn tableName="cat_calendar">
        	<column name="start_date" type="date" />
            <column name="end_date" type="date" />     
            <column name="weekend_begin" type="int4" />
            <column name="weekend_end" type="int4" />
        </addColumn>
    </changeSet>
    
    
    <changeSet id="#3607_20181125" author="AndriusKarpavicius">
        <modifyDataType tableName="crm_custom_field_tmpl" columnName="index_type" newDataType="varchar(17)"/>
    </changeSet>
    
     <changeSet id="#3711_20181112" author="anasseh">
        <addColumn tableName="ar_payment_schedule_inst">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_inst">
            <column name="cf_values" type="${type.json}"></column>
        </addColumn>   
        <addColumn tableName="ar_payment_schedule_inst">
             <column name="uuid" type="varchar(60)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ar_payment_schedule_inst set uuid = id</sql>
        <addNotNullConstraint columnName="uuid" columnDataType="varchar(60)" tableName="ar_payment_schedule_inst"/>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="amount_el" type="varchar(2000)" />
        </addColumn>  
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="filter_el" type="varchar(2000)" />
        </addColumn>          
    </changeSet>   
    
    <changeSet id="#3793_20181119" author="anasseh">
     	<renameColumn newColumnName="payment_day_in_month" oldColumnName="due_date_days" columnDataType="int" tableName="ar_payment_schedule_inst"/>
     	<renameColumn newColumnName="payment_day_in_month" oldColumnName="due_date_days" columnDataType="int" tableName="ar_payment_schedule_tmpl"/>
     	<renameColumn newColumnName="payment_day_in_month_ps" oldColumnName="due_date_days_ps" columnDataType="int" tableName="billing_service_instance"/>
    </changeSet>
    
    <changeSet id="#3577_20181128" author="AndriusKarpavicius">
        <addColumn tableName="cat_offer_template">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#3767_20181112 - Discount fields refactor -" author="EdwardPLegaspi">
    	<sql>UPDATE ${db.schema.adapted}cat_discount_plan_item SET discount_percent=discount_amount WHERE discount_percent is null;</sql>
    </changeSet>
    
    <changeSet id="#3767_20181112 - Discount fields refactor" author="EdwardPLegaspi">
        <sql><![CDATA[ALTER TABLE ${db.schema.adapted}cat_discount_plan_item DROP CONSTRAINT cat_discount_plan_item_discount_percent_check;]]></sql>
        <renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent" newColumnName="discount_value" columnDataType="numeric(23, 12)"/>
    	<dropColumn tableName="cat_discount_plan_item">
    		<column name="discount_amount"></column>
    	</dropColumn>
	    <renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent_el" newColumnName="discount_value_el" columnDataType="varchar(2000)"/>
	    <renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent_el_sp" newColumnName="discount_value_el_sp" columnDataType="varchar(2000)"/>    	
    </changeSet>
    
    <changeSet id="#3769_20181116 - Refactor discount effectivity dates" author="EdwardPLegaspi">
    	<dropColumn tableName="cat_discount_plan_item">
    		<column name="start_date"></column>
    		<column name="end_date"></column>
    		<column name="default_duration"></column>
    		<column name="duration_unit"></column>
    	</dropColumn>
    	<addColumn tableName="cat_discount_plan">
    		<column name="start_date" type="date" />
            <column name="end_date" type="date" />
            <column name="default_duration" type="int4" />
            <column name="duration_unit" type="varchar(50)" />
   		</addColumn>
    </changeSet>
    <changeSet id="#3792_20181116 - Convert discount tables to CF entity" author="EdwardPLegaspi">
    	<addColumn tableName="cat_discount_plan">
    		<column name="uuid" type="varchar(60)">
			</column>
			<column name="cf_values" type="${type.json}" />
			<column name="cf_values_accum" type="${type.json}"></column>
    	</addColumn>
    	<addColumn tableName="cat_discount_plan_item">
    		<column name="uuid" type="varchar(60)">
			</column>
			<column name="cf_values" type="${type.json}" />
			<column name="cf_values_accum" type="${type.json}"></column>
    	</addColumn>
    </changeSet>
    <changeSet id="#3792_20181116 - Convert discount tables to CF entity - add constraints" author="EdwardPLegaspi">
    	<sql>UPDATE ${db.schema.adapted}cat_discount_plan SET uuid=concat(code, '_', id)</sql>
    	<sql>UPDATE ${db.schema.adapted}cat_discount_plan_item SET uuid=concat(code, '_', id)</sql>
    	<addNotNullConstraint tableName="cat_discount_plan" columnName="uuid" columnDataType="varchar(60)" />
    	<addNotNullConstraint tableName="cat_discount_plan_item" columnName="uuid" columnDataType="varchar(60)" />
    </changeSet>
    <changeSet id="#3799_20181119 - Create discount plan instance table" author="EdwardPLegaspi">    
    	<createTable tableName="billing_discount_plan_instance">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_discount_plan_instance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="discount_plan_id" type="bigint">
            	<constraints nullable="false"/>
            </column>
            <column name="billing_account_id" type="bigint">
            	<constraints nullable="false"/>
            </column>
            <column name="start_date" type="date" />
            <column name="end_date" type="date" />
		</createTable>
		<createSequence sequenceName="billing_discount_plan_instance_seq" />
		<addForeignKeyConstraint constraintName="billing_discount_plan_instance_dp_fk" referencedTableName="cat_discount_plan" baseColumnNames="discount_plan_id" baseTableName="billing_discount_plan_instance" referencedColumnNames="id"/>
		<addForeignKeyConstraint constraintName="billing_discount_plan_instance_ba_fk" referencedTableName="billing_billing_account" baseColumnNames="billing_account_id" baseTableName="billing_discount_plan_instance" referencedColumnNames="id"/>
    	<dropTable tableName="billing_discount_plan"/>
    	<dropForeignKeyConstraint baseTableName="billing_billing_account" constraintName="fk_l94b1bb8vfvkotp95by0j2amg"/>
    	<dropColumn tableName="billing_billing_account">
    		<column name="discount_plan_id"></column>
    	</dropColumn>
    </changeSet>
    <changeSet author="EdwardPLegaspi" id="#3799_20181119 - Sequence for mysql - M" dbms="mysql">
    	<createTable tableName="billing_discount_plan_instance_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_discount_plan_instance_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_discount_plan_instance_seq values(1)</sql>
	</changeSet>
    
    <changeSet author="EdwardPLegaspi" id="20181126_3630 - RUM Sequence for PaymentGateway">
        <createTable tableName="ar_payment_gateway_rum_sequence">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_ar_payment_gateway_rum_sequence" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="prefix" type="varchar(255)" />
            <column name="sequence_size" type="bigint" />
            <column name="current_sequence_nb" type="bigint" />
            <column name="payment_gateway_id" type="bigint" />
        </createTable>
        <createSequence sequenceName="ar_payment_gateway_rum_sequence_seq" />
        <addForeignKeyConstraint constraintName="fk_ar_payment_gateway_rum_sequence" referencedTableName="ar_payment_gateway" baseColumnNames="payment_gateway_id" baseTableName="ar_payment_gateway_rum_sequence" referencedColumnNames="id"/>
    </changeSet>
    <changeSet author="EdwardPLegaspi" id="#20181126_3630 - RUM Sequence for PaymentGateway in case Mysql" dbms="mysql">
    	<createTable tableName="ar_payment_gateway_rum_sequence_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_payment_gateway_rum_sequence_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}ar_payment_gateway_rum_sequence_seq values(1)</sql>
	</changeSet>
    <changeSet id="#3790_20181128 - Subscription rating group" author="EdwardPLegaspi">
    	<addColumn tableName="billing_subscription">
    		<column name="rating_group" type="varchar(50)"></column>
    	</addColumn>
    	<createIndex tableName="billing_subscription" indexName="idx_subscription_rating_group">
    		<column name="rating_group"></column>
    	</createIndex>
    </changeSet>
    <changeSet id="20181204 - Add multilingual description field to measurable quantity entity" author="abdelkader.bouazza">
        <addColumn tableName="dwh_measurable_quant">
            <column name="description_i18n" type="${type.json}"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#3543_27092018" author="AbdellatifBari">
        <addColumn tableName="cat_serv_rec_charge_template">
            <column name="counter_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_recurring_charge_inst">
            <column name="counter_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_serv_rec_charge_template" constraintName="fk_serv_rec_charge_template_counter_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />
        <addForeignKeyConstraint baseColumnNames="counter_id" baseTableName="billing_recurring_charge_inst" constraintName="fk_serv_rec_charge_template_billing_counter" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_counter" />
     </changeSet>
    <changeSet id="#3898_20181214 - auto_renew_date" author="MounirBahije">
        <addColumn tableName="cat_service_template">
            <column name="auto_renew_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="auto_renew_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="auto_renew_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="auto_renew_date" type="datetime"/>
        </addColumn>
    </changeSet>

    <changeSet id="#3896_13122018" author="abdelkader.bouazza">
        <renameColumn tableName="wf_workflow" oldColumnName="enable_hostory" newColumnName="enable_history" columnDataType="${type.boolean}"/>
    </changeSet>
    <changeSet id="#3850_20181206" author="EdwardPLegaspi">
		<addColumn tableName="billing_discount_plan_instance">
    		<column name="uuid" type="varchar(60)">
			</column>
			<column name="cf_values" type="${type.json}" />
			<column name="cf_values_accum" type="${type.json}"></column>
    	</addColumn>
	</changeSet>
	
	<changeSet id="#3652_26112018" author="anasseh">
        <addColumn tableName="ar_ddrequest_lot_op">
            <column name="payment_or_refund" type="varchar(30)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ar_ddrequest_lot_op set payment_or_refund='PAYMENT'</sql>
        <addColumn tableName="ar_ddrequest_lot">
            <column name="payment_or_refund" type="varchar(30)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ar_ddrequest_lot set payment_or_refund='PAYMENT'</sql>   
        <addColumn tableName="ar_ddrequest_item">
            <column name="refund_id" type="bigint" />
        </addColumn>
         <addForeignKeyConstraint constraintName="fk_dd_item_refund_id" referencedTableName="ar_account_operation" baseColumnNames="refund_id" baseTableName="ar_ddrequest_item" referencedColumnNames="id"/>     
    </changeSet>
  
	<changeSet id="#3673_29112018" author="anasseh">
	     <addColumn tableName="ar_ddrequest_lot_op"> 
	      	<column name="seller_id" type="bigint" />
         </addColumn>
         <addForeignKeyConstraint constraintName="fk_dd_item_sell_id" referencedTableName="crm_seller" baseColumnNames="seller_id" baseTableName="ar_ddrequest_lot_op" referencedColumnNames="id"/>     
   
        <addColumn tableName="ar_payment_gateway">            
            <column name="account_number" type="varchar(11)" />
            <column name="account_owner" type="varchar(50)" />
            <column name="bank_code" type="varchar(5)" />
            <column name="bank_id" type="varchar(50)" />
            <column name="bank_name" type="varchar(50)" />
            <column name="bic" type="varchar(11)" />
            <column name="branch_code" type="varchar(5)" />
            <column name="iban" type="varchar(34)" />
            <column name="ics" type="varchar(35)" />
            <column name="issuer_name" type="varchar(50)" />
            <column name="issuer_number" type="varchar(50)" /> 
            <column name="hash_key" type="varchar(2)" />
        </addColumn>
        	<addColumn tableName="ar_payment_gateway"> 
	      	<column name="seller_id" type="bigint" />
         </addColumn>
         <addForeignKeyConstraint constraintName="fk_sell_id_pg" referencedTableName="crm_seller" baseColumnNames="seller_id" baseTableName="ar_payment_gateway" referencedColumnNames="id"/>     
      	<addColumn tableName="ar_account_operation"> 
	      	<column name="seller_id" type="bigint" />
         </addColumn>
         <addForeignKeyConstraint constraintName="fk_sell_id_ao" referencedTableName="crm_seller" baseColumnNames="seller_id" baseTableName="ar_account_operation" referencedColumnNames="id"/>     
   <addColumn tableName="ar_ddrequest_lot"> 
	      	<column name="seller_id" type="bigint" />
         </addColumn>
         <addForeignKeyConstraint constraintName="fk_sell_id_dd_lot" referencedTableName="crm_seller" baseColumnNames="seller_id" baseTableName="ar_ddrequest_lot" referencedColumnNames="id"/>     
   
   
   
    </changeSet>

	<changeSet id="#3629_20181210 - Price plan el vars" author="EdwardPLegaspi">
    	<addColumn tableName="cat_price_plan_matrix">
    		<column name="total_amount_el" type="${type.text}" />
    		<column name="minimum_amount_el" type="${type.text}" />
    		<column name="total_amount_el_sp" type="${type.text}" />
    		<column name="minimum_amount_el_sp" type="${type.text}" />
    	</addColumn>

    	<sql>
    		<![CDATA[
			update ${db.schema.adapted}cat_price_plan_matrix set total_amount_el=coalesce(rating_el_without_tax, rating_el_with_tax);
			update ${db.schema.adapted}cat_price_plan_matrix set total_amount_el_sp=coalesce(rating_el_without_tax_sp, rating_el_with_tax_sp);
			update ${db.schema.adapted}cat_price_plan_matrix set minimum_amount_el=coalesce(minimum_amount_without_tax_el, minimum_amount_with_tax_el);
			update ${db.schema.adapted}cat_price_plan_matrix set minimum_amount_el_sp=coalesce(minimum_amount_without_tax_el_sp, minimum_amount_with_tax_el_sp);
			]]>
    	</sql>

    	<dropColumn tableName="cat_price_plan_matrix" columnName="rating_el_with_tax"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="rating_el_with_tax_sp"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="rating_el_without_tax"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="rating_el_without_tax_sp"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="minimum_amount_without_tax_el"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="minimum_amount_without_tax_el_sp"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="minimum_amount_with_tax_el"></dropColumn>
    	<dropColumn tableName="cat_price_plan_matrix" columnName="minimum_amount_with_tax_el_sp"></dropColumn>
    </changeSet>
    <changeSet id="#3840_27122018" author="abdelkader.bouazza">
        <addColumn tableName="crm_customer_category">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_crm_customer_category_accounting_code" referencedTableName="billing_accounting_code"
                                 baseColumnNames="accounting_code_id" baseTableName="crm_customer_category" referencedColumnNames="id" />
    </changeSet>

     <changeSet  id="#3514_20180101" author="hznibar">
		<createSequence sequenceName="billing_general_ledger_seq" />
		<createSequence sequenceName="ar_other_transaction_seq" />
		<createSequence sequenceName="ar_payment_ventilation_seq" />

		<createTable tableName="billing_general_ledger">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_general_ledger_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_general_ledger_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_general_ledger" />

        <createTable tableName="ar_other_transaction">
        	<column name="transaction_type" type="varchar(31)">
                <constraints nullable="false" />
            </column>
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_other_transaction_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="description" type="varchar(255)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="amount" type="numeric(23, 12)" />
            <column name="due_date" type="date" />
            <column name="matching_amount" type="numeric(23, 12)" />
            <column name="matching_status" type="varchar(255)" />
            <column name="occ_code" type="varchar(255)" />
            <column name="occ_description" type="varchar(255)" />
            <column name="reference" type="varchar(255)" />
            <column name="transaction_category" type="varchar(255)" />
            <column name="transaction_date" type="date" />
            <column name="un_matching_amount" type="numeric(23, 12)" />
            <column name="bank_lot" type="varchar(255)" />
            <column name="bank_reference" type="varchar(255)" />
            <column name="payment_method" type="varchar(255)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="billing_account_name" type="varchar(255)" />
            <column name="invoice_date" type="date" />
            <column name="payment_info" type="varchar(255)" />
            <column name="payment_info1" type="varchar(255)" />
            <column name="payment_info2" type="varchar(255)" />
            <column name="payment_info3" type="varchar(255)" />
            <column name="payment_info4" type="varchar(255)" />
            <column name="payment_info5" type="varchar(255)" />
            <column name="payment_info6" type="varchar(255)" />
            <column name="payment_info7" type="varchar(255)" />
            <column name="tax_amount" type="numeric(23, 12)" />
            <column name="operation_date" type="datetime" />
            <column name="bank_collection_date" type="datetime" />
            <column name="deposit_date" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" />
            </column>
            <column name="order_num" type="varchar(500)" />
            <column name="cf_values" type="${type.json}"/>
            <column name="cf_values_accum" type="${type.json}"></column>
			<column name="general_ledger_id" type="bigint" />
            <column name="accounting_code_id" type="bigint"></column>
        </createTable>
    	<addForeignKeyConstraint constraintName="fk_ar_other_transaction_general_ledger" referencedTableName="billing_general_ledger" referencedColumnNames="id" baseTableName="ar_other_transaction" baseColumnNames="general_ledger_id" />
    	<addForeignKeyConstraint constraintName="fk_ar_other_transaction_accounting_code" referencedTableName="billing_accounting_code" referencedColumnNames="id" baseTableName="ar_other_transaction" baseColumnNames="accounting_code_id" />

		<addColumn tableName="crm_seller">
            <column name="general_ledger_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_crm_seller_general_ledger" referencedTableName="billing_general_ledger" referencedColumnNames="id" baseTableName="crm_seller" baseColumnNames="general_ledger_id" />

        <createTable tableName="ar_payment_ventilation">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_payment_ventilation_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)" />
            <column name="ventilation_amount" type="numeric(23, 12)" />
            <column name="ventilation_date" type="date" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="customer_account_id" type="bigint" />
            <column name="original_ot_id" type="bigint" />
            <column name="new_ot_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
            <column name="ventilation_action_status" type="varchar(255)" />
        </createTable>
        <addForeignKeyConstraint constraintName="fk_ar_payment_ventilation_ar_customer_account" referencedTableName="ar_customer_account" referencedColumnNames="id" baseTableName="ar_payment_ventilation" baseColumnNames="customer_account_id" />
        <addForeignKeyConstraint constraintName="fk_ar_payment_ventilation_ar_other_transaction_origin" referencedTableName="ar_other_transaction" referencedColumnNames="id" baseTableName="ar_payment_ventilation" baseColumnNames="original_ot_id" />
        <addForeignKeyConstraint constraintName="fk_ar_payment_ventilation_ar_other_transaction" referencedTableName="ar_other_transaction" referencedColumnNames="id" baseTableName="ar_payment_ventilation" baseColumnNames="new_ot_id" />
        <addForeignKeyConstraint constraintName="fk_ar_payment_ventilation_ar_account_operation" referencedTableName="ar_account_operation" referencedColumnNames="id" baseTableName="ar_payment_ventilation" baseColumnNames="account_operation_id" />
    </changeSet>

    <changeSet id="#3650_20181220" author="AmineBenAicha">
        <createSequence sequenceName="wf_generic_workflow_seq" />
        <createTable tableName="wf_generic_workflow">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_generic_workflow_pk" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_wf_generic_workflow_code"/>
            </column>
            <column name="description" type="varchar(255)" />
            <column name="target_entity_class" type="varchar(255)">
            	<constraints nullable="false" />
            </column>
            <column name="enable_history" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="transition_script_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="transition_script_id" baseTableName="wf_generic_workflow" constraintName="fk_wf_transition_script" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />

        <createSequence sequenceName="wf_status_seq" />
		<createTable tableName="wf_status">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_status_pk" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="uuid" type="varchar(60)">
            	<constraints nullable="false" />
            </column>
            <column name="generic_wf_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="generic_wf_id" baseTableName="wf_status" constraintName="fk_status_generic_wf" deferrable="false" initiallyDeferred="false"
            onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="wf_generic_workflow" />
        <addUniqueConstraint columnNames="generic_wf_id, code" constraintName="uk_generic_wf_id_code_status" deferrable="false" disabled="false" initiallyDeferred="false"
        	tableName="wf_status" />

        <createSequence sequenceName="wf_instance_seq" />
		<createTable tableName="wf_instance">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_instance_pk" />
            </column>
            <column name="version" type="int4" />
            <column name="entity_instance_code" type="varchar(255)" />
            <column name="generic_wf_id" type="bigint" />
            <column name="wf_status_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="generic_wf_id" baseTableName="wf_instance" constraintName="fk_instance_generic_wf" deferrable="false" initiallyDeferred="false"
            onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="wf_generic_workflow" />
         <addForeignKeyConstraint baseColumnNames="wf_status_id" baseTableName="wf_instance" constraintName="fk_instance_wf_status" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_status" />

        <createSequence sequenceName="wf_instance_history_seq" />
		<createTable tableName="wf_instance_history">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_instance_history_pk" />
            </column>
            <column name="version" type="int4" />
            <column name="wf_status_from" type="bigint" />
            <column name="wf_status_to" type="bigint" />
            <column name="action_date" type="datetime" />
            <column name="event" type="varchar(255)" />
            <column name="wf_instance_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="wf_status_from" baseTableName="wf_instance_history" constraintName="fk_history_wf_status_from" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_status" />
        <addForeignKeyConstraint baseColumnNames="wf_status_to" baseTableName="wf_instance_history" constraintName="fk_history_wf_status_to" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_status" />
        <addForeignKeyConstraint baseColumnNames="wf_instance_id" baseTableName="wf_instance_history" constraintName="fk_history_wf_instance" deferrable="false" initiallyDeferred="false"
            onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="wf_instance" />
    </changeSet>

    <changeSet id="#3970 - Change of RT description database field from varchar to text" author="mounir.boukayoua">
        <modifyDataType tableName="billing_rated_transaction" columnName="description" newDataType="${type.text}"/>
    </changeSet>
    
    <changeSet id="#3842_20190111 - Trigger next charge" author="EdwardPLegaspi">
        <addColumn tableName="cat_usage_charge_template">
            <column name="trigger_next_charge" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="trigger_next_charge_el" type="${type.text}"/>
        </addColumn>
    </changeSet>
</databaseChangeLog>
