<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="#3644_04102018" author="AbdellatifBari">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="display_format" type="varchar(80)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3735_20181031_add_legal_information_seller" author="Khalid HORRI">
        <addColumn tableName="crm_seller">
            <column name="vat_no" type="varchar(100)"></column>
            <column name="registration_no" type="varchar(100)"></column>
            <column name="legal_text" type="text"></column>
            <column name="legal_type" type="varchar(255)"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#3464_20180522" author="AndriusKarpavicius">
        <addColumn tableName="crm_provider">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="account_entity">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="adm_user">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_cat">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_sub_cat">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_tax">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="crm_seller">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="medina_access">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="meveo_job_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="meveo_filter">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cust_cei">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="cat_offer_template_category">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_product_instance">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ord_order">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ord_quote">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_gateway">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="billing_invoice_type">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_ddrequest_builder">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>

        <sql>update ${db.schema.adapted}crm_provider set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}account_entity set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}adm_user set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_account_operation set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_cycle set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_cat set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_sub_cat set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_service_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_subscription set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_tax set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_charge_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_offer_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_price_plan_matrix set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_service_template set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}crm_seller set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}medina_access set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}meveo_filter set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cust_cei set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}cat_offer_template_category set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_product_instance set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ord_order set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ord_quote set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_payment_gateway set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_billing_run set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}dwh_report_extract set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}billing_invoice_type set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_ddrequest_builder set cf_values_accum=cf_values</sql>
        <sql>update ${db.schema.adapted}ar_payment_schedule_tmpl set cf_values_accum=cf_values</sql>
    </changeSet>

    <changeSet id="#3464_20180701" author="AndriusKarpavicius">
        <addColumn tableName="cat_usage_charge_template">
            <column name="filter_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="cat_triggered_edr">
            <column name="condition_el_sp" type="${type.text}" />
            <column name="subscription_el_sp" type="${type.text}" />
            <column name="param_1_el_sp" type="${type.text}" />
            <column name="param_2_el_sp" type="${type.text}" />
            <column name="param_3_el_sp" type="${type.text}" />
            <column name="param_4_el_sp" type="${type.text}" />
            <column name="quantity_el_sp" type="${type.text}" />
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="criteria_el_sp" type="varchar(2000)" />
            <column name="rating_el_with_tax_sp" type="${type.text}" />
            <column name="rating_el_without_tax_sp" type="varchar(2000)" />
            <column name="minimum_amount_without_tax_el_sp" type="${type.text}" />
            <column name="minimum_amount_with_tax_el_sp" type="${type.text}" />
            <column name="amount_without_tax_el_sp" type="${type.text}" />
            <column name="amount_with_tax_el_sp" type="${type.text}" />
            <column name="wo_description_el_sp" type="${type.text}" />
        </addColumn>
        <addColumn tableName="crm_customer_category">
            <column name="exoneration_tax_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_inv_sub_cat_country">
            <column name="tax_code_el_sp" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3577_20180727" author="AndriusKarpavicius">
        <addColumn tableName="ord_order">
            <column name="order_number " type="varchar(255)" />
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order set order_number = case when external_id is not null then external_id else code end where order_number is null</sql>
        <addColumn tableName="billing_billing_account">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="charge_instance_id" type="bigint" />
            <column name="tax_id" type="bigint" />
            <column name="tax_percent" type="numeric(23, 12)" />
            <column name="user_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_rt_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="account_entity" />
        <addColumn tableName="billing_wallet_operation">
            <column name="tax_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addColumn tableName="billing_cycle">
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
            <column name="invoice_type_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="due_date_delay_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="order_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="billing_invoice" constraintName="fk_inv_subscription" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_invoice" constraintName="fk_inv_order" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ord_order" />
        <addColumn tableName="cat_discount_plan_item">
            <column name="expression_el_sp" type="varchar(2000)" />
            <column name="discount_percent_el_sp" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_invoice_agregate">
            <column name="discount_plan_item_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_invoice_agregate" constraintName="fk_ia_dpi" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
        <addDefaultValue columnName="rounding_mode" tableName="crm_provider" defaultValue="NEAREST" />
        <addDefaultValue columnName="invoice_rounding_mode" tableName="crm_provider" defaultValue="NEAREST" />
        <sql>update ${db.schema.adapted}crm_provider set rounding_mode='NEAREST' where rounding_mode is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set invoice_rounding_mode='NEAREST' where invoice_rounding_mode is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set rating_rounding=2 where rating_rounding is null</sql>
        <sql>update ${db.schema.adapted}crm_provider set invoice_rounding=2 where invoice_rounding is null</sql>
        <addNotNullConstraint tableName="crm_provider" columnName="rounding_mode" columnDataType="varchar(50)" />
        <addNotNullConstraint tableName="crm_provider" columnName="invoice_rounding_mode" columnDataType="varchar(50)" />
        <addNotNullConstraint tableName="crm_provider" columnName="rating_rounding" columnDataType="int4" />
        <addNotNullConstraint tableName="crm_provider" columnName="invoice_rounding" columnDataType="int4" />
    </changeSet>

    <changeSet id="#3577_20180727_migration_P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_rated_transaction set charge_instance_id = billing_wallet_operation.charge_instance_id, seller_id = billing_wallet_operation.seller_id from
            ${db.schema.adapted}billing_wallet_operation where
            billing_rated_transaction.wallet_operation_id=billing_wallet_operation.id and
            billing_rated_transaction.wallet_operation_id is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate set discount_plan_item_id = cat_discount_plan_item.id from ${db.schema.adapted}cat_discount_plan_item where
            cat_discount_plan_item.code=billing_invoice_agregate.discount_plan_item_code and
            billing_invoice_agregate.discount_plan_item_code is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate set tax_id = billing_invoice_agregate_taxes.tax_id from ${db.schema.adapted}billing_invoice_agregate_taxes where
            billing_invoice_agregate.id=billing_invoice_agregate_taxes.sub_cat_invoice_aggregat_id and billing_invoice_agregate.tax_id is null
        </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_wallet.user_account_id from ${db.schema.adapted}billing_wallet where
            billing_rated_transaction.wallet_id=billing_wallet.id
            and
            billing_rated_transaction.wallet_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_subscription.user_account_id from ${db.schema.adapted}billing_subscription where
            billing_rated_transaction.subscription_id=billing_subscription.id and
            billing_rated_transaction.subscription_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set user_account_id = billing_charge_instance.user_account_id from ${db.schema.adapted}billing_charge_instance where
            billing_rated_transaction.charge_instance_id=billing_charge_instance.id and
            billing_rated_transaction.charge_instance_id is not null and billing_rated_transaction.user_account_id is null
        </sql>
    </changeSet>

    <changeSet id="#3577_20180727_migration_M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_wallet_operation
            on billing_rated_transaction.wallet_operation_id=billing_wallet_operation.id
            set billing_rated_transaction.charge_instance_id = billing_wallet_operation.charge_instance_id,
            billing_rated_transaction.seller_id = billing_wallet_operation.seller_id
            where billing_rated_transaction.wallet_operation_id is not null</sql>
        <sql>update ${db.schema.adapted}billing_invoice_agregate join ${db.schema.adapted}cat_discount_plan_item
            on cat_discount_plan_item.code=billing_invoice_agregate.discount_plan_item_code
            set billing_invoice_agregate.discount_plan_item_id = cat_discount_plan_item.id
            where billing_invoice_agregate.discount_plan_item_code is not null</sql>

        <sql>update ${db.schema.adapted}billing_invoice_agregate join ${db.schema.adapted}billing_invoice_agregate_taxes
            on billing_invoice_agregate.id=billing_invoice_agregate_taxes.sub_cat_invoice_aggregat_id set
            billing_invoice_agregate.tax_id = billing_invoice_agregate_taxes.tax_id where billing_invoice_agregate.tax_id is null</sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_wallet
            on billing_rated_transaction.wallet_id=billing_wallet.id
            set billing_rated_transaction.user_account_id = billing_wallet.user_account_id
            where billing_rated_transaction.wallet_id is not null and billing_rated_transaction.user_account_id is null </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_charge_instance
            on billing_rated_transaction.charge_instance_id=billing_charge_instance.id
            set billing_rated_transaction.user_account_id = billing_charge_instance.user_account_id
            where billing_rated_transaction.charge_instance_id is not null and billing_rated_transaction.user_account_id is null </sql>

        <sql>update ${db.schema.adapted}billing_rated_transaction join ${db.schema.adapted}billing_subscription
            on billing_rated_transaction.subscription_id=billing_subscription.id
            set billing_rated_transaction.user_account_id = billing_subscription.user_account_id
            where billing_rated_transaction.subscription_id is not null and billing_rated_transaction.user_account_id is null </sql>
    </changeSet>

    <changeSet id="#3577_20180827" author="AndriusKarpavicius">
        <addNotNullConstraint tableName="billing_rated_transaction" columnName="seller_id" columnDataType="bigint" />
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="seller_id" columnDataType="bigint" />
        <dropTable tableName="billing_invoice_agregate_taxes" />
    </changeSet>

    <changeSet id="spark_P" author="AndriusKarpavicius" dbms="postgresql">
        <addDefaultValue tableName="job_execution" columnName="id" defaultValueSequenceNext="job_execution_seq" />
        <addDefaultValue tableName="rating_edr" columnName="id" defaultValueSequenceNext="rating_edr_seq" />
        <addDefaultValue tableName="billing_rated_transaction" columnName="id" defaultValueSequenceNext="billing_rated_transaction_seq" />
        <addDefaultValue tableName="billing_invoice" columnName="id" defaultValueSequenceNext="billing_invoice_seq" />
        <addDefaultValue tableName="billing_invoice_agregate" columnName="id" defaultValueSequenceNext="billing_invoice_agregate_seq" />
    </changeSet>

    <changeSet id="#3755_20181031" author="MounirBahije">
        <addColumn tableName="ar_payment_gateway">
            <column name="webhooks_secret_key" type="varchar(255)" />
        </addColumn>
        <addColumn tableName="ar_payment_gateway">
            <column name="webhooks_key_id" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3705_20181019 - Create discount plan bridge table" author="EdwardPLegaspi">
        <dropUniqueConstraint tableName="cat_discount_plan_item" constraintName="uk_1q0ayvmttpoo254r1v8hl0kjn" />
        <addUniqueConstraint columnNames="discount_plan_id, code" constraintName="uk_1q0ayvmttpoo254r1v8hl0kjn" deferrable="false" disabled="false" initiallyDeferred="false" tableName="cat_discount_plan_item" />

        <addColumn tableName="cat_discount_plan_item">
            <column name="discount_plan_item_type" type="varchar(25)" />
            <column name="discount_amount" type="numeric(23, 12)" />
            <column name="start_date" type="date" />
            <column name="end_date" type="date" />
            <column name="default_duration" type="int4" />
            <column name="duration_unit" type="varchar(50)" />
        </addColumn>

        <update tableName="cat_discount_plan_item">
            <column name="discount_plan_item_type" value="PERCENTAGE"></column>
        </update>

        <createTable tableName="billing_discount_plan">
            <column name="billing_account_id" type="bigint"></column>
            <column name="discount_plan_id" type="bigint"></column>
        </createTable>

        <addForeignKeyConstraint constraintName="fk_billing_discount_plan_ba" referencedTableName="billing_billing_account" baseColumnNames="billing_account_id" baseTableName="billing_discount_plan"
            referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_billing_discount_plan_dp" referencedTableName="cat_discount_plan" baseColumnNames="discount_plan_id" baseTableName="billing_discount_plan"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#3705_20181019 - Migrate discount plan from ba to new table" author="EdwardPLegaspi" dbms="postgresql">
        <sql>INSERT INTO billing_discount_plan (billing_account_id, discount_plan_id) SELECT id, discount_plan_id FROM billing_billing_account;</sql>
    </changeSet>

    <changeSet id="#3705_20181019 - Migrate discount plan from ba to new table" author="EdwardPLegaspi" dbms="mysql">
        <sql>INSERT INTO ${db.schema.adapted}billing_discount_plan (billing_account_id, discount_plan_id) SELECT id, discount_plan_id FROM ${db.schema.adapted}billing_billing_account;</sql>
    </changeSet>

    <changeSet id="#3705_20181019 - Set the discount plan to null" author="EdwardPLegaspi">
        <update tableName="billing_billing_account">
            <column name="discount_plan_id"></column>
        </update>
    </changeSet>

    <changeSet id="#3680 - Extend FtpAdapterJob to support file export and SFTP-P" author="mboukayoua" dbms="postgresql">
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_localDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_removeOriginalFile')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_ftpInputDirectory', 'FtpAdapterJob_remoteDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, '}]}', '}],&quot;FtpAdapterJob_operation&quot;:[{&quot;string&quot;:&quot;IMPORT&quot;}]}')" />
        </update>
        <renameColumn tableName="ftp_imported_file" oldColumnName="import_date" newColumnName="transfer_date" columnDataType="datetime"/>
        <addColumn tableName="ftp_imported_file">
            <column name="operation" type="varchar(100)" value="IMPORT" defaultValue="IMPORT" />
        </addColumn>
        <renameTable oldTableName="ftp_imported_file" newTableName="ftp_transferred_file" />
        <sql><![CDATA[
            ALTER INDEX ftp_imported_file_pkey RENAME TO ftp_transferred_file_pkey;
            ALTER SEQUENCE ftp_imported_file_seq RENAME TO ftp_transferred_file_seq;
        ]]>
        </sql>
        <delete tableName="crm_custom_field_tmpl">
            <where>applies_to='JOB_FtpAdapterJob' AND
                code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory')
            </where>
        </delete>
    </changeSet>

    <changeSet id="#3680 - Extend FtpAdapterJob to support file export and SFTP-M" author="mboukayoua" dbms="mysql">
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_localDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_removeOriginalFile')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, 'FtpAdapterJob_ftpInputDirectory', 'FtpAdapterJob_remoteDirectory')" />
        </update>
        <update tableName="meveo_job_instance">
            <column name="cf_values" valueComputed="replace(cf_values, '}]}', '}],&quot;FtpAdapterJob_operation&quot;:[{&quot;string&quot;:&quot;IMPORT&quot;}]}')" />
        </update>
        <renameColumn tableName="ftp_imported_file" oldColumnName="import_date" newColumnName="transfer_date" columnDataType="datetime"/>
        <addColumn tableName="ftp_imported_file">
            <column name="operation" type="varchar(100)" value="IMPORT" defaultValue="IMPORT" />
        </addColumn>
        <renameTable oldTableName="ftp_imported_file" newTableName="ftp_transferred_file" />
        <createIndex tableName="ftp_transferred_file" indexName="ftp_transferred_file_pkey">
            <column name="id" type="bigint"/>
        </createIndex>
        <createSequence sequenceName="ftp_transferred_file_seq" startValue="1"/>
        <dropSequence sequenceName="ftp_imported_file_seq"/>
        <delete tableName="crm_custom_field_tmpl">
            <where>applies_to='JOB_FtpAdapterJob' AND
                code IN ('FtpAdapterJob_removeDistantFile', 'FtpAdapterJob_distDirectory', 'FtpAdapterJob_ftpInputDirectory')
            </where>
        </delete>
    </changeSet>
    <changeSet id="#3765_20181106" author="AndriusKarpavicius">
        <addColumn tableName="crm_provider">
            <column name="invoice_config_id" type="bigint" />
            <column name="gdpr_config_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_provider_invoice_config" referencedTableName="billing_invoice_configuration" baseColumnNames="invoice_config_id" baseTableName="crm_provider"
            referencedColumnNames="id" />
        <addForeignKeyConstraint constraintName="fk_provider_gdpr_config" referencedTableName="adm_gdpr_configuration" baseColumnNames="gdpr_config_id" baseTableName="crm_provider"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#3765_20181106-migration-P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}crm_provider set invoice_config_id = billing_invoice_configuration.id from ${db.schema.adapted}billing_invoice_configuration where
            crm_provider.id=billing_invoice_configuration.provider_id
        </sql>
        <sql>update ${db.schema.adapted}crm_provider set gdpr_config_id = adm_gdpr_configuration.id from ${db.schema.adapted}adm_gdpr_configuration where
            crm_provider.id=adm_gdpr_configuration.provider_id
        </sql>
    </changeSet>

    <changeSet id="#3765_20181106-migration-M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}crm_provider join ${db.schema.adapted}billing_invoice_configuration on crm_provider.id=billing_invoice_configuration.provider_id set crm_provider.invoice_config_id =
            billing_invoice_configuration.id
        </sql>
        <sql>update ${db.schema.adapted}crm_provider join ${db.schema.adapted}adm_gdpr_configuration on crm_provider.id=adm_gdpr_configuration.provider_id set crm_provider.gdpr_config_id =
            adm_gdpr_configuration.id
        </sql>
        <dropForeignKeyConstraint baseTableName="billing_invoice_configuration" constraintName="provider_invoice_configuration_fk" />
        <!-- does't exist
            <dropIndex tableName="billing_invoice_configuration" indexName="provider_invoice_configuration_fk" />
        -->
        <dropUniqueConstraint tableName="billing_invoice_configuration" constraintName="uk_billing_invoice_configuration" />
        <dropForeignKeyConstraint baseTableName="adm_gdpr_configuration" constraintName="fk_crm_provider_adm_gdpr_conf" />
        <dropIndex tableName="adm_gdpr_configuration" indexName="fk_crm_provider_adm_gdpr_conf" />
    </changeSet>

    <changeSet id="#3765_20181106-end" author="AndriusKarpavicius">
        <dropColumn tableName="billing_invoice_configuration" columnName="provider_id" />
        <dropColumn tableName="adm_gdpr_configuration" columnName="provider_id" />
    </changeSet>

    <changeSet id="#3770_20181108" author="AmineBenAicha">
        <addColumn tableName="ar_payment_schedule_tmpl">
    		<column name="script_instance_id" type="bigint" />
    	</addColumn>
    	<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_payment_schedule_tmpl" constraintName="fk_ps_script_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    </changeSet>
    
    <changeSet id="#3731_20181113" author="EdwardPLegaspi">
    	<dropForeignKeyConstraint baseTableName="billing_invoice_agregate" constraintName="fk_icmfsev8m5n386ifttcgelv40"/>
    	<addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_invoice_agregate" constraintName="fk_icmfsev8m5n386ifttcgelv40" deferrable="false" initiallyDeferred="false"
            onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>

    <changeSet id="#3767_20181112 - Discount fields refactor -" author="EdwardPLegaspi">
    	<sql>UPDATE ${db.schema.adapted}cat_discount_plan_item SET discount_percent=discount_amount WHERE discount_percent is null;</sql>
    </changeSet>
    <changeSet author="SaidRamli" id="#3791_20181119">
        <modifyDataType columnName="sync_status"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="async_status"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="error_type"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="operation_category"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="payment_method_type"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
        <modifyDataType columnName="payment_method_name"
                        newDataType="VARCHAR(255)"
                        tableName="ar_payment_history"/>
    </changeSet>
    
    <changeSet id="#3767_20181112 - Discount fields refactor" author="EdwardPLegaspi">
	    	<renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent" newColumnName="discount_value" columnDataType="numeric(23, 12)"/>
    	<dropColumn tableName="cat_discount_plan_item">
    		<column name="discount_amount"></column>
    	</dropColumn>
	    	<renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent_el" newColumnName="discount_value_el" columnDataType="varchar(2000)"/>
	    	<renameColumn tableName="cat_discount_plan_item" oldColumnName="discount_percent_el_sp" newColumnName="discount_value_el_sp" columnDataType="varchar(2000)"/>    	
    </changeSet>


    <changeSet id="#3823_20181125 - the invoice(s) that was paid when the payment are rejected" author="anasseh">
    		<addColumn tableName="ar_account_operation">
            <column name="rejected_payment_id" type="bigint" />
        </addColumn>
         <addForeignKeyConstraint constraintName="fk_ao_rejected_payment_id" referencedTableName="ar_account_operation" baseColumnNames="rejected_payment_id" baseTableName="ar_account_operation" referencedColumnNames="id"/>
    </changeSet>
	<changeSet author="hznibar" id="#3699_20181109_2" dbms="mysql">
        <createTable tableName="cat_calendar_holiday_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_calendar_holiday_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}cat_calendar_holiday_seq values(1)</sql>
    </changeSet>
    <changeSet author="hznibar" id="#3699_20181109">
    	<createSequence sequenceName="cat_calendar_holiday_seq" />
        <createTable tableName="cat_calendar_holiday">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_calendar_holiday_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="holiday_begin" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="holiday_end" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="calendar_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addColumn tableName="cat_calendar">
        	<column name="start_date" type="date" />
            <column name="end_date" type="date" />     
            <column name="weekend_begin" type="int4" />
            <column name="weekend_end" type="int4" />
        </addColumn>
    </changeSet>
    
    
    <changeSet id="#3607_20181125" author="AndriusKarpavicius">
        <modifyDataType tableName="crm_custom_field_tmpl" columnName="index_type" newDataType="varchar(17)"/>
    </changeSet>
    
     <changeSet id="#3711_20181112" author="anasseh">
        <addColumn tableName="ar_payment_schedule_inst">
            <column name="cf_values_accum" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_inst">
            <column name="cf_values" type="${type.json}"></column>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_inst">
             <column name="uuid" type="varchar(60)" />
        </addColumn>
        <sql>update ${db.schema.adapted}ar_payment_schedule_inst set uuid = id</sql>
        <addNotNullConstraint columnName="uuid" columnDataType="varchar(60)" tableName="ar_payment_schedule_inst"/>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="amount_el" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="filter_el" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3793_20181119" author="anasseh">
     	<renameColumn newColumnName="payment_day_in_month" oldColumnName="due_date_days" columnDataType="int" tableName="ar_payment_schedule_inst"/>
     	<renameColumn newColumnName="payment_day_in_month" oldColumnName="due_date_days" columnDataType="int" tableName="ar_payment_schedule_tmpl"/>
     	<renameColumn newColumnName="payment_day_in_month_ps" oldColumnName="due_date_days_ps" columnDataType="int" tableName="billing_service_instance"/>
    </changeSet>

</databaseChangeLog>

