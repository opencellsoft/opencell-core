<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="#4303_300520191" author="mohamed.el.youssoufi" dbms="postgresql">
		<sql>ALTER TABLE ${db.schema.adapted}ar_account_operation RENAME COLUMN occ_code TO code;</sql>
		<sql>ALTER TABLE ${db.schema.adapted}ar_account_operation RENAME COLUMN occ_description TO description;</sql>
    </changeSet>

    <changeSet id="#4303_300520192" author="mohamed.el.youssoufi" dbms="mysql">
	    <sql>ALTER TABLE ${db.schema.adapted}ar_account_operation CHANGE occ_code code varchar(255);</sql>
	    <sql>ALTER TABLE ${db.schema.adapted}ar_account_operation CHANGE occ_description description varchar(255);</sql>
	</changeSet>

    <changeSet id="#4322_20190612 - Add a filter to GenericWorkflow" author="MounirBahije">
        <addColumn tableName="wf_generic_workflow">
            <column name="filter_id" type="bigint"/>
        </addColumn>
    </changeSet>

        <changeSet id="#4054_201917061 - Encryption" author="MohamedElYoussoufi" dbms="postgresql">
    	<sql>
			alter table ${db.schema.adapted}crm_provider alter column bic type character varying(100);
			alter table ${db.schema.adapted}crm_provider alter column iban type character varying(100);

			alter table ${db.schema.adapted}ar_payment_token alter column bic type character varying(100);
			alter table ${db.schema.adapted}ar_payment_token alter column iban type character varying(100);

			alter table ${db.schema.adapted}ar_payment_gateway alter column bic type character varying(100);
			alter table ${db.schema.adapted}ar_payment_gateway alter column iban type character varying(100);

			alter table ${db.schema.adapted}crm_seller alter column phone type character varying(100);
			alter table ${db.schema.adapted}crm_seller alter column mobile type character varying(100);

			alter table ${db.schema.adapted}account_entity alter column phone type character varying(100);
			alter table ${db.schema.adapted}account_entity alter column mobile type character varying(100);

			alter table ${db.schema.adapted}adm_user alter column firstname type character varying(100);
			alter table ${db.schema.adapted}adm_user alter column lastname type character varying(100);

			alter table ${db.schema.adapted}account_entity alter column firstname type character varying(100);
			alter table ${db.schema.adapted}account_entity alter column lastname type character varying(100);
    	</sql>
    </changeSet>

    <changeSet id="#4054_201917062 - Encryption" author="mohamed.el.youssoufi" dbms="mysql">
    		<sql> alter table ${db.schema.adapted}crm_provider modify bic varchar(100);
			alter table ${db.schema.adapted}crm_provider modify iban varchar(100);

			alter table ${db.schema.adapted}ar_payment_token modify bic varchar(100);
			alter table ${db.schema.adapted}ar_payment_token modify iban varchar(100);

			alter table ${db.schema.adapted}ar_payment_gateway modify bic varchar(100);
			alter table ${db.schema.adapted}ar_payment_gateway modify iban varchar(100);

			alter table ${db.schema.adapted}crm_seller modify phone varchar(100);
			alter table ${db.schema.adapted}crm_seller modify mobile varchar(100);

			alter table ${db.schema.adapted}account_entity modify phone varchar(100);
			alter table ${db.schema.adapted}account_entity modify mobile varchar(100);

			alter table ${db.schema.adapted}adm_user modify firstname varchar(100);
			alter table ${db.schema.adapted}adm_user modify lastname varchar(100);

			alter table ${db.schema.adapted}account_entity modify firstname varchar(100);
			alter table ${db.schema.adapted}account_entity modify lastname varchar(100); </sql>
    </changeSet>


    <changeSet id="#4371_20190620_1" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="adm_file_format_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_format_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}adm_file_format_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4371_20190620_2" author="AbdellatifBARI">
        <createSequence sequenceName="adm_file_format_seq" startValue="1" />
        <createTable tableName="adm_file_format">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_format_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="file_name_pattern" type="varchar(255)" />
            <column name="file_type" type="varchar(255)" />
            <column name="configuration_template" type="text" />
            <column name="record_name" type="varchar(255)" />
            <column name="input_directory" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="output_directory" type="varchar(255)" />
            <column name="reject_directory" type="varchar(255)" />
            <column name="archive_directory" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari5xp8" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_format" />
    </changeSet>


    <changeSet id="#4371_20190620_3" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="flat_file_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="flat_file_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}flat_file_seq values(1)</sql>
    </changeSet>

	<changeSet id="#4371_20190620_4" author="AbdellatifBARI">
        <createSequence sequenceName="flat_file_seq" startValue="1" />
        <createTable tableName="flat_file">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="flat_file_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="file_name" type="varchar(255)" />
            <column name="status" type="varchar(255)" />
            <column name="file_format_id" type="bigint" />
            <column name="processed" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="error_message" type="text" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari6yr9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="flat_file" />
        <addForeignKeyConstraint baseColumnNames="file_format_id" baseTableName="flat_file" constraintName="fk_d4iavkklx1qg1ani36bari5o5i" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_format" />
    </changeSet>

    <!--<changeSet id="#3510_20190712_4" author="Mohammed_EL-AZZOUZI">

        <sql>INSERT INTO ${db.schema.adapted}cat_unit_of_measure(id, version, code, created, symbol, description)
                (SELECT nextval( 'cat_unit_of_measure_seq'), 0, FR.rating_unit_description, current_date, FR.rating_unit_description, FR.rating_unit_description||' MIG-R ' FROM (SELECT DISTINCT rating_unit_description
                    FROM ${db.schema.adapted}cat_charge_template CT where rating_unit_description is not null) FR);</sql>
        <sql>INSERT INTO ${db.schema.adapted}cat_unit_of_measure(id, version, code, created, symbol, description, multiplicator, parent_id)
                (SELECT nextval( 'cat_unit_of_measure_seq'), 0, FR.input_unit_description, current_date, FR.input_unit_description, FR.input_unit_description||' MIG-I ', FR.unit_multiplicator,
                         (select id from ${db.schema.adapted}cat_unit_of_measure UOM where UOM.code=FR.rating_unit_description AND UOM.description=UOM.code||' MIG-R ' )
                 FROM (SELECT DISTINCT input_unit_description, rating_unit_description, unit_multiplicator FROM ${db.schema.adapted}cat_charge_template CT where input_unit_description is not null and unit_multiplicator is not null) FR);</sql>
        <sql>UPDATE ${db.schema.adapted}cat_charge_template CT SET rating_unitofmeasure = (SELECT UOM.id FROM ${db.schema.adapted}cat_unit_of_measure UOM
                WHERE UOM.code=CT.rating_unit_description AND UOM.description=UOM.code||' MIG-R ' ) WHERE rating_unitofmeasure IS null AND rating_unit_description IS NOT null;</sql>
        <sql>UPDATE ${db.schema.adapted}cat_charge_template CT SET input_unitofmeasure = (SELECT UOM.id FROM ${db.schema.adapted}cat_unit_of_measure UOM
                WHERE UOM.code=CT.input_unit_description AND UOM.description=UOM.code||' MIG-I ' ) WHERE input_unitofmeasure IS null AND input_unit_description IS NOT null;</sql>
    </changeSet>-->
    <changeSet id="#4371_20190620_5" author="AbdellatifBARI" dbms="postgresql">
        <sql>CREATE INDEX flat_file_code_index ON ${db.schema.adapted} flat_file(lower(code))</sql>
    </changeSet>

    <changeSet id="#4160_20190105 - Accounting Writing" author="MounirBOUKAYOUA">
        <createTable tableName="ar_accounting_writing">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_ar_accounting_writing_seq" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="origin_writing_id" type="bigint" />
            <column name="tax_id" type="bigint" />
            <column name="invoice_category_id" type="bigint" />
            <column name="accounting_code_id" type="bigint" />
            <column name="event_date" type="date" />
            <column name="export_date" type="date" />
            <column name="amount" type="numeric(23, 12)" />
            <column name="event_type" type="varchar(255)" />
            <column name="extra_param_1" type="varchar(255)" />
            <column name="extra_param_2" type="varchar(255)" />
            <column name="extra_param_3" type="varchar(255)" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="origin_writing_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_origin_writing" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_accounting_writing" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_tax" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="invoice_category_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_invoice_category" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_cat" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <createSequence sequenceName="ar_accounting_writing_seq"/>

        <createTable tableName="ar_accounting_writing_acc_operations">
            <column name="accounting_writing_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="accounting_writing_id, account_operation_id" constraintName="ar_accounting_writing_acc_operations_pkey" tableName="ar_accounting_writing_acc_operations" />
    </changeSet>
    <changeSet id="##4160_20190105 - Accounting Writing - MYSQL sequence" author="MounirBOUKAYOUA" dbms="mysql">
        <createTable tableName="ar_accounting_writing_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_accounting_writing_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}ar_accounting_writing_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4337_20190710" author="MohammedELAZZOUZI">
    	<addColumn tableName="ar_account_operation">
        	<column name="invoice_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="ar_account_operation" constraintName="fk_billing_invoice" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
    	<sql>
            UPDATE ${db.schema.adapted}ar_account_operation AO SET invoice_id=(SELECT id FROM ${db.schema.adapted}billing_invoice BI WHERE BI.invoice_number=AO.reference)
            WHERE AO.transaction_type='I'
        </sql>
    </changeSet>

    <changeSet id="#4372_20190715" author="RedaDebbache">
    	<addColumn tableName="crm_custom_field_tmpl">
        	<column name="unique_constraint" type="${type.boolean}" defaultValue="0"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#4372_20190723" author="RedaDebbache">
    	<addColumn tableName="cust_cet">
        	<column name="unique_constraint_name" type="varchar(120)" defaultValue="0"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#4458_20190626_1" author="AbdellatifBARI">
        <dropUniqueConstraint constraintName="uk_9fnf93rp352nkw2kpdbari5xp8" tableName="adm_file_format"/>
        <dropColumn tableName="adm_file_format">
            <column name="code"></column>
        </dropColumn>
        <dropColumn tableName="adm_file_format">
            <column name="file_type"></column>
        </dropColumn>

        <addColumn tableName="adm_file_format">
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
        </addColumn>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari4xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_format" />
    </changeSet>

    <changeSet id="#4458_20190626_2" author="AbdellatifBARI">
        <createTable tableName="adm_file_format_file_type">
            <column name="file_format_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="file_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="file_format_id, file_type_id" constraintName="adm_file_format_file_type_pkey" tableName="adm_file_format_file_type" />
        <addForeignKeyConstraint baseColumnNames="file_format_id" baseTableName="adm_file_format_file_type" constraintName="fk_4au8lqa3bc46gks4dmpbbari4h4l6" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_format" />
    </changeSet>

    <changeSet id="#4458_20190626_3" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="adm_file_type_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_type_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}adm_file_type_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4458_20190626_4" author="AbdellatifBARI">
        <createSequence sequenceName="adm_file_type_seq" startValue="1" />
        <createTable tableName="adm_file_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_type_pkey" />
            </column>

            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari5yr8" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_type" />
        <addForeignKeyConstraint baseColumnNames="file_type_id" baseTableName="adm_file_format_file_type" constraintName="fk_s1wxui3m4sv9x5mbyi8gpbari77hu" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_type" />
        <sql>CREATE INDEX adm_file_type_code_index ON ${db.schema.adapted}adm_file_type(code)</sql>
    </changeSet>

    <changeSet id="#4468_20190631_1" author="AbdellatifBARI">
        <addColumn tableName="flat_file">
            <column name="lines_in_success" type="int4" />
            <column name="lines_in_warning" type="int4" />
            <column name="lines_in_error" type="int4" />
            <column name="processing_attempts" type="int4" />
            <column name="flat_file_job_code" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#4326_20190709" author="AndriusKarpavicius" failOnError="false">
        <dropForeignKeyConstraint baseTableName="billing_wallet_operation" constraintName="fk_wallet_operation_rated_transaction"/>
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_rated_transaction"/>
    </changeSet>

    <changeSet id="#4457_20190728" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl_val set listvalues='Rollback', listvalues_key='ROLLBACK' where listvalues_key='ROLLBBACK'</sql>
    </changeSet>

	<changeSet id="#4472_20190807" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_MediationJob'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_mcols where cft_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob'</sql>
    </changeSet>
    <changeSet id="#4392_20190625" author="AndriusKarpavicius" dbms="postgres">
        <sql>update ${db.schema.adapted}meveo_script_instance set reuse=0 where reuse is null</sql>
        <sql>update ${db.schema.adapted}meveo_script_instance set is_error=0 where is_error is null</sql>
        <sql>update ${db.schema.adapted}adm_notification set run_async=0 where run_async is null</sql>
        <addNotNullConstraint tableName="meveo_script_instance" columnName="reuse" columnDataType="${type.boolean}"/>
        <addNotNullConstraint tableName="meveo_script_instance" columnName="is_error" columnDataType="${type.boolean}"/>
        <addNotNullConstraint tableName="adm_notification" columnName="run_async" columnDataType="${type.boolean}"/>
    </changeSet>
    <!-- addNotNullConstraint generates SQL with the default numeric value missing, which blocks the insertions-->
    <changeSet id="#4392_20190625-UPDATED-20190827" author="MohamedSTITANE" dbms="mysql">
        <sql>update ${db.schema.adapted}meveo_script_instance set reuse=0 where reuse is null</sql>
        <sql>update ${db.schema.adapted}meveo_script_instance set is_error=0 where is_error is null</sql>
        <sql>update ${db.schema.adapted}adm_notification set run_async=0 where run_async is null</sql>
        <sql>ALTER TABLE ${db.schema.adapted}meveo_script_instance MODIFY `reuse` INT NOT NULL DEFAULT 0</sql>
        <sql>ALTER TABLE ${db.schema.adapted}meveo_script_instance MODIFY is_error INT NOT NULL DEFAULT 0</sql>
        <sql>ALTER TABLE ${db.schema.adapted}adm_notification MODIFY run_async INT NOT NULL DEFAULT 0;</sql>
    </changeSet>

    <changeSet id="#4326_20190811" author="AndriusKarpavicius">
    	<addColumn tableName="billing_invoice">
    		<column name="prepaid" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
    	</addColumn>
    </changeSet>


    <changeSet id="#4512_20190819" author="AbdellatifBARI">
        <dropColumn tableName="flat_file">
            <column name="file_name"></column>
        </dropColumn>

        <addColumn tableName="flat_file">
            <column name="file_original_name" type="varchar(255)" />
            <column name="file_current_name" type="varchar(255)" />
        </addColumn>
    </changeSet>

 	<changeSet id="#4480_250919" author="MohammedElAzzouzi">
		<sql>UPDATE ${db.schema.adapted}billing_invoice SET payment_method_id=null WHERE payment_method_id IS NOT NULL AND payment_method_id NOT IN (SELECT APT.id FROM ${db.schema.adapted}ar_payment_token APT)</sql>
    </changeSet>
    <changeSet id="#4480_210819" author="SaidRamli">
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_invoice"
                                 constraintName="fk_invoice_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />
    </changeSet>

    <changeSet id="#4538_20190829" author="AbdellatifBARI">
        <addColumn tableName="flat_file">
            <column name="current_directory" type="varchar(255)" />
        </addColumn>
    </changeSet>
    <changeSet id="#4550_20190904" author="AbdellatifBARI">
        <dropColumn tableName="billing_trading_country">
            <column name="pr_description"></column>
        </dropColumn>
        <addColumn tableName="billing_trading_country">
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" defaultValue="Trading_Country_US">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#4313_17062019" author="mohamed.el.youssoufi">
		<addColumn tableName="wf_generic_workflow">
			<column name="cf_values_accum" type="${type.json}"></column>
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" />
		</addColumn>
	</changeSet>

	 <changeSet id="#3774_07102019" author="FranckValot">
		<addColumn tableName="adm_notification">
			<column name="save_successful_notif" type="${type.boolean}" defaultValueNumeric="1"></column>
		</addColumn>
	</changeSet>

	<changeSet id="#4064_11092019" author="AbdelmounaimAkadid">
		<addColumn tableName="billing_invoice">
			<column name="status" type="varchar(50)" />
		</addColumn>
	</changeSet>

   	<changeSet id="#4606_260919" author="AbdelmounaimAkadid">
     	<addColumn tableName="billing_subscription">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />

        <addColumn tableName="cat_offer_template">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="cat_offer_template" constraintName="fk_billing_cat_offer_template_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />

        <addColumn tableName="billing_billing_account">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_billing_account" constraintName="fk_billing_billing_account_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />

        <addColumn tableName="billing_service_instance">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_service_instance" constraintName="fk_billing_service_instance_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />

        <addColumn tableName="cat_service_template">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="cat_service_template" constraintName="fk_billing_cat_service_template_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
    </changeSet>

    <changeSet id="#4555_20190903" author="AndriusKarpavicius">
        <addColumn tableName="cat_charge_template">
            <column name="charge_type" type="varchar(5)" />

            <column name="filter_expression" type="varchar(2000)" />
            <column name="filter_param_1" type="varchar(255)" />
            <column name="filter_param_2" type="varchar(255)" />
            <column name="filter_param_3" type="varchar(255)" />
            <column name="filter_param_4" type="varchar(255)" />
            <column name="filter_el_sp" type="varchar(2000)" />
            <column  name="priority" type="int4" defaultValueNumeric="1" />
            <column name="trigger_next_charge" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="trigger_next_charge_el" type="varchar(2000)" />

            <column name="apply_in_advance" type="${type.boolean}" />
            <column name="duration_term_in_month" type="int4" />
            <column name="recurrence_type" type="varchar(255)" />
            <column name="share_level" type="varchar(20)" />
            <column name="subscription_prorata" type="${type.boolean}" />
            <column name="termination_prorata" type="${type.boolean}" />
            <column name="calendar_id" type="bigint" />
            <column name="subscription_prorata_el" type="varchar(2000)" />
            <column name="termination_prorata_el" type="varchar(2000)" />
            <column name="apply_in_advance_el" type="varchar(2000)" />
            <column name="duration_term_in_month_el" type="varchar(2000)" />
            <column name="calendar_code_el" type="varchar(2000)" />

            <column name="immediate_invoicing" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="type" type="varchar(255)" />
        </addColumn>

        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='U', filter_expression = cat_usage_charge_template.filter_expression, filter_param_1 = cat_usage_charge_template.filter_param_1,
            filter_param_2 = cat_usage_charge_template.filter_param_2, filter_param_3 = cat_usage_charge_template.filter_param_3, filter_param_4 = cat_usage_charge_template.filter_param_4,
            filter_el_sp = cat_usage_charge_template.filter_el_sp, priority = cat_usage_charge_template.priority, trigger_next_charge = cat_usage_charge_template.trigger_next_charge, trigger_next_charge_el =
            cat_usage_charge_template.trigger_next_charge_el
            from ${db.schema.adapted}cat_usage_charge_template where cat_charge_template.id=cat_usage_charge_template.id
        </sql>

        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='R', filter_expression = cat_recurring_charge_templ.filter_expression,
            apply_in_advance = cat_recurring_charge_templ.apply_in_advance, duration_term_in_month = cat_recurring_charge_templ.duration_term_in_month, recurrence_type = cat_recurring_charge_templ.recurrence_type, share_level = cat_recurring_charge_templ.share_level,
            subscription_prorata = cat_recurring_charge_templ.subscription_prorata, termination_prorata = cat_recurring_charge_templ.termination_prorata, calendar_id = cat_recurring_charge_templ.calendar_id, subscription_prorata_el = cat_recurring_charge_templ.subscription_prorata_el,
            termination_prorata_el = cat_recurring_charge_templ.termination_prorata_el, apply_in_advance_el = cat_recurring_charge_templ.apply_in_advance_el, duration_term_in_month_el = cat_recurring_charge_templ.duration_term_in_month_el,
            calendar_code_el = cat_recurring_charge_templ.calendar_code_el
            from ${db.schema.adapted}cat_recurring_charge_templ where cat_charge_template.id=cat_recurring_charge_templ.id
        </sql>

        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='P', filter_expression = cat_product_charge_templ.filter_expression
            from ${db.schema.adapted}cat_product_charge_templ where cat_charge_template.id=cat_product_charge_templ.id
        </sql>

        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='O', filter_expression = cat_one_shot_charge_templ.filter_expression,
            immediate_invoicing = cat_one_shot_charge_templ.immediate_invoicing, type = cat_one_shot_charge_templ.type
            from ${db.schema.adapted}cat_one_shot_charge_templ where cat_charge_template.id=cat_one_shot_charge_templ.id
        </sql>

        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_usage_charge_template on ct.id=cat_usage_charge_template.id set charge_type='U', filter_expression = cat_usage_charge_template.filter_expression, filter_param_1 = cat_usage_charge_template.filter_param_1,
            filter_param_2 = cat_usage_charge_template.filter_param_2, filter_param_3 = cat_usage_charge_template.filter_param_3, filter_param_4 = cat_usage_charge_template.filter_param_4,
            filter_el_sp = cat_usage_charge_template.filter_el_sp, priority = cat_usage_charge_template.priority, trigger_next_charge = cat_usage_charge_template.trigger_next_charge, trigger_next_charge_el =
            cat_usage_charge_template.trigger_next_charge_el
        </sql>

        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_recurring_charge_templ on ct.id=cat_recurring_charge_templ.id set charge_type='R', filter_expression = cat_recurring_charge_templ.filter_expression,
            apply_in_advance = cat_recurring_charge_templ.apply_in_advance, duration_term_in_month = cat_recurring_charge_templ.duration_term_in_month, recurrence_type = cat_recurring_charge_templ.recurrence_type, share_level = cat_recurring_charge_templ.share_level,
            subscription_prorata = cat_recurring_charge_templ.subscription_prorata, termination_prorata = cat_recurring_charge_templ.termination_prorata, calendar_id = cat_recurring_charge_templ.calendar_id, subscription_prorata_el = cat_recurring_charge_templ.subscription_prorata_el,
            termination_prorata_el = cat_recurring_charge_templ.termination_prorata_el, apply_in_advance_el = cat_recurring_charge_templ.apply_in_advance_el, duration_term_in_month_el = cat_recurring_charge_templ.duration_term_in_month_el,
            calendar_code_el = cat_recurring_charge_templ.calendar_code_el
        </sql>

        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_product_charge_templ on ct.id=cat_product_charge_templ.id set
            charge_type='P', filter_expression = cat_product_charge_templ.filter_expression
        </sql>

        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_one_shot_charge_templ on ct.id=cat_one_shot_charge_templ.id set
            charge_type='O', filter_expression = cat_one_shot_charge_templ.filter_expression,
            immediate_invoicing = cat_one_shot_charge_templ.immediate_invoicing, type = cat_one_shot_charge_templ.type
        </sql>

        <dropForeignKeyConstraint baseTableName="cat_serv_usage_charge_template" constraintName="fk_443th9siwouj4fg746sgyfqtv"/>
        <dropForeignKeyConstraint baseTableName="cat_usage_charge_template" constraintName="fk_8x4c8il5glegqu0g1scpi469h"/>
        <dropForeignKeyConstraint baseTableName="cat_recurring_charge_templ" constraintName="fk_ailcl9mls5y7bjr9yur52767h" />
        <dropForeignKeyConstraint baseTableName="cat_serv_rec_charge_template" constraintName="fk_foohp8o0xupxmxcwblexcfqpp"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl"/>
        <dropForeignKeyConstraint baseTableName="cat_offer_template" constraintName="fk_cat_off_tpl_prod_chrg_tpl"/>
        <dropForeignKeyConstraint baseTableName="cat_product_templ_charge_templ" constraintName="fk_prd_templ_ct_pct_id"/>
        <dropForeignKeyConstraint baseTableName="cat_serv_sub_charge_template" constraintName="fk_3yhjbdockv9jvyw9iqmqlha63"/>
        <dropForeignKeyConstraint baseTableName="cat_serv_trm_charge_template" constraintName="fk_5ehn1daxca6x6t7pvdpuo4n6m"/>

    </changeSet>

    <changeSet id="#4555_20190903-M" author="AndriusKarpavicius" dbms="mysql">

        <dropIndex tableName="cat_serv_usage_charge_template" indexName="fk_443th9siwouj4fg746sgyfqtv"/>
        <dropIndex tableName="cat_usage_charge_template" indexName="fk_8x4c8il5glegqu0g1scpi469h"/>
        <dropIndex tableName="cat_recurring_charge_templ" indexName="fk_ailcl9mls5y7bjr9yur52767h" />
        <dropIndex tableName="cat_serv_rec_charge_template" indexName="fk_foohp8o0xupxmxcwblexcfqpp"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodchrgtempl"/>
        <dropIndex tableName="cat_offer_template" indexName="fk_cat_off_tpl_prod_chrg_tpl"/>
        <dropIndex tableName="cat_product_templ_charge_templ" indexName="fk_prd_templ_ct_pct_id"/>
        <dropIndex tableName="cat_serv_sub_charge_template" indexName="fk_3yhjbdockv9jvyw9iqmqlha63"/>
        <dropIndex tableName="cat_serv_trm_charge_template" indexName="fk_5ehn1daxca6x6t7pvdpuo4n6m"/>

    </changeSet>

    <changeSet id="#4555_20190903-end" author="AndriusKarpavicius">
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_usage_charge_template" constraintName="fk_443th9siwouj4fg746sgyfqtv" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="calendar_id" baseTableName="cat_charge_template" constraintName="fk_ailcl9mls5y7bjr9yur52767h" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_rec_charge_template" constraintName="fk_foohp8o0xupxmxcwblexcfqpp" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="recurring_chrg_tmpl_id" baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="product_chrg_tmpl_id" baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="product_charge_tmpl_id" baseTableName="cat_offer_template" constraintName="fk_cat_off_tpl_prod_chrg_tpl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="product_charge_template_id" baseTableName="cat_product_templ_charge_templ" constraintName="fk_prd_templ_ct_pct_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_sub_charge_template" constraintName="fk_3yhjbdockv9jvyw9iqmqlha63" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_trm_charge_template" constraintName="fk_5ehn1daxca6x6t7pvdpuo4n6m" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />

        <dropTable tableName="cat_usage_charge_template"/>
        <dropTable tableName="cat_recurring_charge_templ"/>
        <dropTable tableName="cat_product_charge_templ"/>
        <dropTable tableName="cat_one_shot_charge_templ"/>

    </changeSet>

    <changeSet id="#4555_20190905" author="AndriusKarpavicius">

        <addColumn tableName="billing_charge_instance">
            <column name="charge_type" type="varchar(5)" />

            <column name="quantity" type="numeric(23, 12)"/>
            <column name="product_instance_id" type="bigint" />
            <column name="next_charge_date" type="datetime" />
            <column name="subscription_date" type="datetime" />
            <column name="service_instance_id" type="bigint" />
            <column name="counter_id" type="bigint" />
            <column name="rating_unit_description" type="varchar(20)" />
            <column name="priority" type="int4" defaultValueNumeric="1"/>
        </addColumn>

        <dropColumn tableName="billing_charge_instance" columnName="pr_description"/>

        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='S', service_instance_id = billing_one_shot_charge_inst.subs_serv_inst_id,
            quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.subs_serv_inst_id is not null
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='T', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id,
            quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.term_serv_inst_id is not null
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='O', quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.subs_serv_inst_id is null and billing_one_shot_charge_inst.term_serv_inst_id is null
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='P', product_instance_id = billing_product_charge_inst.product_instance_id,
            quantity = billing_product_charge_inst.quantity, charge_template_id = billing_product_charge_inst.product_chrg_tmpl_id
            from ${db.schema.adapted}billing_product_charge_inst where billing_charge_instance.id=billing_product_charge_inst.id
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='R',
            next_charge_date = billing_recurring_charge_inst.next_charge_date, subscription_date = billing_recurring_charge_inst.subscription_date, charge_template_id = billing_recurring_charge_inst.recurring_chrg_tmpl_id,
            service_instance_id = billing_recurring_charge_inst.service_instance_id, quantity = billing_recurring_charge_inst.quantity, counter_id = billing_recurring_charge_inst.counter_id
            from ${db.schema.adapted}billing_recurring_charge_inst where billing_charge_instance.id=billing_recurring_charge_inst.id
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='U',
            counter_id = billing_usage_charge_inst.counter_id, service_instance_id = billing_usage_charge_inst.service_instance_id,
            rating_unit_description = billing_usage_charge_inst.rating_unit_description, priority = billing_usage_charge_inst.priority
            from ${db.schema.adapted}billing_usage_charge_inst where billing_charge_instance.id=billing_usage_charge_inst.id
        </sql>

        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='S', service_instance_id = billing_one_shot_charge_inst.subs_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.subs_serv_inst_id is not null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='T', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.term_serv_inst_id is not null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='O', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.term_serv_inst_id is null and  billing_one_shot_charge_inst.subs_serv_inst_id is null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_product_charge_inst on ci.id=billing_product_charge_inst.id set
            charge_type='P', product_instance_id = billing_product_charge_inst.product_instance_id,
            quantity = billing_product_charge_inst.quantity, charge_template_id = billing_product_charge_inst.product_chrg_tmpl_id
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_recurring_charge_inst on ci.id=billing_recurring_charge_inst.id set
            charge_type='R', next_charge_date = billing_recurring_charge_inst.next_charge_date, subscription_date = billing_recurring_charge_inst.subscription_date, charge_template_id = billing_recurring_charge_inst.recurring_chrg_tmpl_id,
            service_instance_id = billing_recurring_charge_inst.service_instance_id, quantity = billing_recurring_charge_inst.quantity, counter_id = billing_recurring_charge_inst.counter_id
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_usage_charge_inst on ci.id=billing_usage_charge_inst.id set
            charge_type='U', counter_id = billing_usage_charge_inst.counter_id, service_instance_id = billing_usage_charge_inst.service_instance_id,
            rating_unit_description = billing_usage_charge_inst.rating_unit_description, priority = billing_usage_charge_inst.priority
        </sql>


        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_5q5wxh2nq7gbd9bcds59egh3e"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_c1v9rho8f7dl45kbmexjh0fkf"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_c9rnk3vjujvmqe8j13yxoq70g"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_eht7f5na7vthrcu8pdbhwn4hi"/>
        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_j1o935sww9tme69o1t5yqgce6"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_jsatpdoxjhluj5mbgg19c8vpa"/>
        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_n5h6xvrtm2a2av5jik9vr0cp5"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_serv_rec_charge_template_billing_counter"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_ofm7i3gubvpf3qu8hh03kkpxo"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodins"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl"/>

        <dropIndex tableName="billing_recurring_charge_inst" indexName="billing_recurring_charge_inst_index"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="billing_one_shot_charge_inst_subs_serv_inst_id"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="term_serv_inst_id_index"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="billing_usage_charge_inst_index"/>

    </changeSet>


    <changeSet id="#4555_20190905-M" author="AndriusKarpavicius" dbms="mysql">

        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_5q5wxh2nq7gbd9bcds59egh3e"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_c1v9rho8f7dl45kbmexjh0fkf"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_c9rnk3vjujvmqe8j13yxoq70g"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_eht7f5na7vthrcu8pdbhwn4hi"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_j1o935sww9tme69o1t5yqgce6"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_jsatpdoxjhluj5mbgg19c8vpa"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_n5h6xvrtm2a2av5jik9vr0cp5"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_serv_rec_charge_template_billing_counter"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_ofm7i3gubvpf3qu8hh03kkpxo"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodins"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodchrgtempl"/>

    </changeSet>

    <changeSet id="#4555_20190905-end" author="AndriusKarpavicius">

        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_charge_instance" constraintName="fk_5q5wxh2nq7gbd9bcds59egh3e" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="counter_id" baseTableName="billing_charge_instance" constraintName="fk_n5h6xvrtm2a2av5jik9vr0cp5" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_counter" />
        <addForeignKeyConstraint baseColumnNames="product_instance_id" baseTableName="billing_charge_instance" constraintName="fk_productci_prodins" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_product_instance" />

        <sql>CREATE INDEX billing_charge_serv_inst_index ON ${db.schema.adapted}billing_charge_instance(service_instance_id)</sql>

        <dropTable tableName="billing_one_shot_charge_inst"/>
        <dropTable tableName="billing_product_charge_inst"/>
        <dropTable tableName="billing_recurring_charge_inst"/>
        <dropTable tableName="billing_usage_charge_inst"/>

    </changeSet>

    <changeSet id="#4511_20190919-M" author="AndriusKarpavicius" dbms="mysql">

        <dropColumn tableName="billing_wallet_operation" columnName="created"/>
        <dropColumn tableName="billing_wallet_operation" columnName="creator"/>
        <dropColumn tableName="billing_wallet_operation" columnName="updater"/>
        <dropColumn tableName="billing_wallet_operation" columnName="aggregate_serv_id"/>

        <dropColumn tableName="billing_rated_transaction" columnName="aggregate_id_r"/>
        <dropColumn tableName="billing_rated_transaction" columnName="aggregate_id_t"/>

        <addColumn tableName="billing_rated_transaction">
            <column name="updated" type="datetime" />
        </addColumn>

        <dropIndex tableName="billing_rated_transaction" indexName="rt_ba_invoice_open_serv_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_ba_invoice_open_sub_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_sub_invoice_open_serv_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_invoice_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_order_index"/>

        <sql>CREATE INDEX rating_edr_sub_id_index ON ${db.schema.adapted}rating_edr (subscription_id, id)</sql>

        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction (billing_account__id, service_instance_id)</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON ${db.schema.adapted}billing_rated_transaction (billing_account__id, subscription_id)</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction (subscription_id, service_instance_id)</sql>
        <sql>CREATE INDEX rt_invoice_index ON ${db.schema.adapted}billing_rated_transaction (invoice_id)</sql>
        <sql>CREATE INDEX rt_order_index ON ${db.schema.adapted}billing_rated_transaction (order_number, status)</sql>
    </changeSet>

    <changeSet id="#4511_20190919-P" author="AndriusKarpavicius" dbms="postgresql">

        <sql>alter table ${db.schema.adapted}rating_edr alter column id drop default</sql>
        <sql>alter table ${db.schema.adapted}billing_wallet_operation alter column id drop default</sql>
        <sql>alter table ${db.schema.adapted}billing_rated_transaction alter column id drop default</sql>

        <sql>alter table ${db.schema.adapted}rating_edr rename to rating_edr_tmp</sql>
        <sql>alter table ${db.schema.adapted}billing_wallet_operation rename to billing_wallet_operation_tmp</sql>
        <sql>alter table ${db.schema.adapted}billing_rated_transaction rename to billing_rated_transaction_tmp</sql>

        <sql>
            CREATE TABLE ${db.schema.adapted}rating_edr (
              id bigint NOT NULL DEFAULT nextval('rating_edr_seq'),
              version integer,
              created timestamp without time zone,
              event_date timestamp without time zone,
              last_updated timestamp without time zone,
              origin_batch character varying(255),
              origin_record character varying(255),
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              parameter_4 character varying(255),
              quantity numeric(23,12),
              reject_reason text,
              status character varying(255),
              subscription_id bigint NOT NULL,
              parameter_5 character varying(255),
              parameter_6 character varying(255),
              parameter_7 character varying(255),
              parameter_8 character varying(255),
              parameter_9 character varying(255),
              date_parameter_1 timestamp without time zone,
              date_parameter_2 timestamp without time zone,
              date_parameter_3 timestamp without time zone,
              date_parameter_4 timestamp without time zone,
              date_parameter_5 timestamp without time zone,
              decimal_parameter_1 numeric(23,12),
              decimal_parameter_2 numeric(23,12),
              decimal_parameter_3 numeric(23,12),
              decimal_parameter_4 numeric(23,12),
              decimal_parameter_5 numeric(23,12),
              access_code character varying(255),
              header_edr_id bigint,
              extra_parameter text,
              CONSTRAINT rating_edr_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>

        <sql>
            CREATE TABLE ${db.schema.adapted}billing_wallet_operation (
              id bigint NOT NULL DEFAULT nextval('billing_wallet_operation_seq'),
              operation_type character varying(31) NOT NULL,
              version integer,
              created timestamp without time zone,
              updated timestamp without time zone,
              code character varying(255) NOT NULL,
              description character varying(255),
              amount_tax numeric(23,12),
              amount_with_tax numeric(23,12),
              amount_without_tax numeric(23,12),
              end_date timestamp without time zone,
              offer_code character varying(255),
              operation_date timestamp without time zone,
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              quantity numeric(23,12),
              start_date timestamp without time zone,
              status character varying(255),
              subscription_date timestamp without time zone,
              tax_percent numeric(23,12) NOT NULL,
              credit_debit_flag character varying(255),
              unit_amount_tax numeric(23,12),
              unit_amount_with_tax numeric(23,12),
              unit_amount_without_tax numeric(23,12),
              charge_instance_id bigint NOT NULL,
              counter_id bigint,
              currency_id bigint,
              priceplan_id bigint,
              reratedwalletoperation_id bigint,
              seller_id bigint NOT NULL,
              wallet_id bigint,
              reservation_id bigint,
              invoicing_date timestamp without time zone,
              input_quantity numeric(23,12),
              input_unit_description character varying(20),
              rating_unit_description character varying(20),
              edr_id bigint,
              order_number character varying(100),
              parameter_extra text,
              raw_amount_without_tax numeric(23,12),
              raw_amount_with_tax numeric(23,12),
              invoice_sub_category_id bigint,
              subscription_id bigint,
              tax_id bigint NOT NULL,
              rated_transaction_id bigint,
              service_instance_id bigint,
              offer_id bigint,
              CONSTRAINT billing_wallet_operation_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>

        <sql>
            CREATE TABLE ${db.schema.adapted}billing_rated_transaction (
              id bigint NOT NULL DEFAULT nextval('billing_rated_transaction_seq'),
              version integer,
              amount_tax numeric(23,12),
              amount_with_tax numeric(23,12),
              amount_without_tax numeric(23,12),
              code character varying(255),
              description text,
              do_not_trigger_invoicing integer NOT NULL DEFAULT 0,
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              quantity numeric(23,12),
              status character varying(255),
              unit_amount_tax numeric(23,12),
              unit_amount_with_tax numeric(23,12),
              unit_amount_without_tax numeric(23,12),
              unity_description character varying(20),
              usage_date timestamp without time zone,
              billing_account__id bigint,
              billing_run_id bigint,
              invoice_id bigint,
              aggregate_id_f bigint,
              invoice_sub_category_id bigint,
              priceplan_id bigint,
              wallet_id bigint,
              edr_id bigint,
              adjusted_rated_tx bigint,
              order_number character varying(100),
              rating_unit_description character varying(20),
              parameter_extra text,
              start_date timestamp without time zone,
              end_date timestamp without time zone,
              subscription_id bigint,
              seller_id bigint NOT NULL,
              charge_instance_id bigint,
              tax_id bigint NOT NULL,
              tax_percent numeric(23,12) NOT NULL,
              user_account_id bigint,
              offer_id bigint,
              service_instance_id bigint,
              updated timestamp without time zone,
              CONSTRAINT billing_rated_transaction_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>

        <sql>create table ${db.schema.adapted}rating_edr_open partition of ${db.schema.adapted}rating_edr for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}rating_edr_other partition of ${db.schema.adapted}rating_edr default</sql>

        <sql>create table ${db.schema.adapted}billing_wallet_operation_open partition of ${db.schema.adapted}billing_wallet_operation for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}billing_wallet_operation_other partition of ${db.schema.adapted}billing_wallet_operation default</sql>

        <sql>create table ${db.schema.adapted}billing_rated_transaction_open  partition of ${db.schema.adapted}billing_rated_transaction for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}billing_rated_transaction_other partition of ${db.schema.adapted}billing_rated_transaction default</sql>

        <sql>insert into ${db.schema.adapted}rating_edr (id,version,created,event_date,last_updated,origin_batch,origin_record,parameter_1,parameter_2,parameter_3,parameter_4,quantity,reject_reason,status,subscription_id,parameter_5,parameter_6,parameter_7,parameter_8,parameter_9,date_parameter_1,date_parameter_2,date_parameter_3,date_parameter_4,date_parameter_5,decimal_parameter_1,decimal_parameter_2,decimal_parameter_3,decimal_parameter_4,decimal_parameter_5,access_code,header_edr_id,extra_parameter)
                (select id,version,created,event_date,last_updated,origin_batch,origin_record,parameter_1,parameter_2,parameter_3,parameter_4,quantity,reject_reason,status,subscription_id,parameter_5,parameter_6,parameter_7,parameter_8,parameter_9,date_parameter_1,date_parameter_2,date_parameter_3,date_parameter_4,date_parameter_5,decimal_parameter_1,decimal_parameter_2,decimal_parameter_3,decimal_parameter_4,decimal_parameter_5,access_code,header_edr_id,extra_parameter from ${db.schema.adapted}rating_edr_tmp) </sql>
        <sql>insert into ${db.schema.adapted}billing_wallet_operation (id,operation_type,version,created,updated,code,description,amount_tax,amount_with_tax,amount_without_tax,end_date,offer_code,operation_date,parameter_1,parameter_2,parameter_3,quantity,start_date,status,subscription_date,tax_percent,credit_debit_flag,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,charge_instance_id,counter_id,currency_id,priceplan_id,reratedwalletoperation_id,seller_id,wallet_id,reservation_id,invoicing_date,input_quantity,input_unit_description,rating_unit_description,edr_id,order_number,parameter_extra,raw_amount_without_tax,raw_amount_with_tax,invoice_sub_category_id,subscription_id,tax_id,rated_transaction_id,service_instance_id,offer_id)
                (select id,operation_type,version,created,updated,code,description,amount_tax,amount_with_tax,amount_without_tax,end_date,offer_code,operation_date,parameter_1,parameter_2,parameter_3,quantity,start_date,status,subscription_date,tax_percent,credit_debit_flag,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,charge_instance_id,counter_id,currency_id,priceplan_id,reratedwalletoperation_id,seller_id,wallet_id,reservation_id,invoicing_date,input_quantity,input_unit_description,rating_unit_description,edr_id,order_number,parameter_extra,raw_amount_without_tax,raw_amount_with_tax,invoice_sub_category_id,subscription_id,tax_id,rated_transaction_id,service_instance_id,offer_id from ${db.schema.adapted}billing_wallet_operation_tmp)</sql>
        <sql>insert into ${db.schema.adapted}billing_rated_transaction (id,version,amount_tax,amount_with_tax,amount_without_tax,code,description,do_not_trigger_invoicing,parameter_1,parameter_2,parameter_3,quantity,status,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,unity_description,usage_date,billing_account__id,billing_run_id,invoice_id,aggregate_id_f,invoice_sub_category_id,priceplan_id,wallet_id,edr_id,adjusted_rated_tx,order_number,rating_unit_description,parameter_extra,start_date,end_date,subscription_id,seller_id,charge_instance_id,tax_id,tax_percent,user_account_id,offer_id,service_instance_id, updated)
                (select id,version,amount_tax,amount_with_tax,amount_without_tax,code,description,do_not_trigger_invoicing,parameter_1,parameter_2,parameter_3,quantity,status,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,unity_description,usage_date,billing_account__id,billing_run_id,invoice_id,aggregate_id_f,invoice_sub_category_id,priceplan_id,wallet_id,edr_id,adjusted_rated_tx,order_number,rating_unit_description,parameter_extra,start_date,end_date,subscription_id,seller_id,charge_instance_id,tax_id,tax_percent,user_account_id,offer_id,service_instance_id, ${db.current.time} from ${db.schema.adapted}billing_rated_transaction_tmp)</sql>

    </changeSet>

    <changeSet id="#4511_20190919-P-end" author="AndriusKarpavicius" dbms="postgresql">


        <sql>ALTER SEQUENCE ${db.schema.adapted}rating_edr_seq OWNED BY ${db.schema.adapted}rating_edr.id</sql>
        <sql>ALTER SEQUENCE ${db.schema.adapted}billing_wallet_operation_seq OWNED BY ${db.schema.adapted}billing_wallet_operation.id</sql>
        <sql>ALTER SEQUENCE ${db.schema.adapted}billing_rated_transaction_seq OWNED BY ${db.schema.adapted}billing_rated_transaction.id</sql>

        <dropForeignKeyConstraint baseTableName="billing_reservation" constraintName="fk_reservation_edr"/>
<!--         <addForeignKeyConstraint baseColumnNames="origin_edr_id" baseTableName="billing_reservation" constraintName="fk_reservation_edr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" -->
<!--             onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="rating_edr" /> -->

        <dropTable tableName="billing_wallet_operation_tmp"/>
        <dropTable tableName="billing_rated_transaction_tmp"/>
        <dropTable tableName="rating_edr_tmp"/>

        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="rating_edr" constraintName="fk_f5tulmo519cm4il45bhborgq1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
<!--         <addForeignKeyConstraint baseColumnNames="header_edr_id" baseTableName="rating_edr" constraintName="fk_headeredrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" />               -->

        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_batch, origin_record)</sql>
<!--         <sql>CREATE INDEX rating_edr_status_index ON ${db.schema.adapted}rating_edr(status)</sql> -->
        <sql>CREATE INDEX rating_edr_sub_id_index ON ${db.schema.adapted}rating_edr_open (subscription_id, id)</sql>


        <addForeignKeyConstraint baseColumnNames="reservation_id" baseTableName="billing_wallet_operation" constraintName="fk_32r2ed0015tnd2pp5196vcqpy" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_reservation" />
        <addForeignKeyConstraint baseColumnNames="wallet_id" baseTableName="billing_wallet_operation" constraintName="fk_5htics7k9v44an8ap11wivraf" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet" />
        <addForeignKeyConstraint baseColumnNames="counter_id" baseTableName="billing_wallet_operation" constraintName="fk_60qrdadyj5wvmyii1einfb2lo" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_counter" />
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_75hyldnus6ti0y40vwcl49ued" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_billing_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="priceplan_id" baseTableName="billing_wallet_operation" constraintName="fk_f0v21kf4sbdcq1wwqsxmb5tsk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="billing_wallet_operation" constraintName="fk_hg1a5impet68w8a37dehlnib0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
<!--         <addForeignKeyConstraint baseColumnNames="reratedwalletoperation_id" baseTableName="billing_wallet_operation" constraintName="fk_j3ntuqkj79m0fgdwa3anib1nk" deferrable="false" initiallyDeferred="false" -->
<!--             onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet_operation" /> -->
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_rt_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="billing_wallet_operation" constraintName="fk_t98kqb1prnfw6scvudimx1u0q" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />
        <addForeignKeyConstraint constraintName="fk_wallet_operation_service_instance" baseColumnNames="service_instance_id" baseTableName="billing_wallet_operation"
            referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_tax" />
<!--         <addForeignKeyConstraint baseColumnNames="edr_id" baseTableName="billing_wallet_operation" constraintName="fk_wopedrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" /> -->

        <sql>CREATE INDEX billing_wallet_operation_index ON ${db.schema.adapted}billing_wallet_operation(wallet_id, charge_instance_id)</sql>
<!--         <sql>CREATE INDEX billing_wallet_operation_status_index ON ${db.schema.adapted}billing_wallet_operation(status)</sql> -->

        <addForeignKeyConstraint baseColumnNames="wallet_id" baseTableName="billing_rated_transaction" constraintName="fk_anslvrbm465ossqx8surjyu22" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet" />
        <addForeignKeyConstraint baseColumnNames="billing_account__id" baseTableName="billing_rated_transaction" constraintName="fk_bbnhg8vn7jkttghphr65iwug5" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_crm_seller" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="priceplan_id" baseTableName="billing_rated_transaction" constraintName="fk_eucl7of9ovyut1c4r2jkf01u6" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_rated_transaction" constraintName="fk_gq86s178gc3orumcl8symk4nn" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
        <addForeignKeyConstraint baseColumnNames="billing_run_id" baseTableName="billing_rated_transaction" constraintName="fk_o2mp1mqcyi2l7q2b1p88h20dw" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_run" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_rated_transaction" constraintName="fk_o5yu3c0bnac626w755w5f0voc" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="aggregate_id_f" baseTableName="billing_rated_transaction" constraintName="fk_rjpm9k6xsumg297fxefffyryh" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_agregate" />
<!--         <addForeignKeyConstraint baseColumnNames="edr_id" baseTableName="billing_rated_transaction" constraintName="fk_ropedrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" /> -->
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_service_instance" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="account_entity" />

        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction_open (billing_account__id, service_instance_id) where service_instance_id is not null</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON ${db.schema.adapted}billing_rated_transaction_open (billing_account__id, subscription_id)</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction_open (subscription_id, service_instance_id) where subscription_id is not null</sql>
        <sql>CREATE INDEX rt_invoice_index ON ${db.schema.adapted}billing_rated_transaction_other (invoice_id)</sql>
        <sql>CREATE INDEX rt_order_index ON ${db.schema.adapted}billing_rated_transaction (order_number) where order_number is not null</sql>

        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}create_partitions</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}detach_partitions</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}drop_all_table_indexes</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}rename_all_table_pks</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}create_all_table_indexes</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_rated_transaction_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_rated_transaction_to_partition</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_wallet_operation_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_wallet_operation_to_partition</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_rating_edr_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_rating_edr_to_partition</sql>

    </changeSet>


    <changeSet id="#4490_31102019" author="AbdelmounaimAkadid">
		<addColumn tableName="billing_charge_instance">
			<column name="cf_values_accum" type="${type.json}"></column>
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" />
		</addColumn>
	</changeSet>

    <changeSet author="abdelkader.bouazza" id="#4523-Changing-amount-for-a-service-instance-with-prorating">
        <addColumn tableName="cat_charge_template">
            <column name="prorata_on_price_change" type="${type.boolean}" defaultValueNumeric="0"></column>
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="validity_from" type="datetime"></column>
            <column name="validity_date" type="datetime"></column>
        </addColumn>
    </changeSet>

        <changeSet id="#3510_20190516" author="MounirBahije">
        <createTable tableName="cat_unit_of_measure">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_unit_of_measure_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
<!--            <column name="multiplicator" type="bigint" />-->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="symbol" type="varchar(100)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(100)">
                <constraints nullable="true" />
            </column>
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="multiplicator" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="parent_id" type="bigint" />
        </createTable>

        <addColumn tableName="cat_charge_template">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
            <column name="input_unit_el" type="varchar(2000)"/>
            <column name="output_unit_el" type="varchar(2000)"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="cat_charge_template" constraintName="fk_input_cat_charge_template_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="cat_charge_template" constraintName="fk_rating_cat_charge_template_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addColumn tableName="billing_wallet_operation">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="billing_wallet_operation" constraintName="fk_input_billing_wallet_operation_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="billing_wallet_operation" constraintName="fk_rating_billing_wallet_operation_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />


        <addNotNullConstraint columnDataType="bigint" tableName="cat_unit_of_measure" columnName="multiplicator"/>
        <addDefaultValue tableName="cat_unit_of_measure" columnName="multiplicator" defaultValueNumeric="1"/>

    </changeSet>

    <changeSet id="#4766_20191111" author="MohammedELAZZOUZI">
    	<addNotNullConstraint tableName="adm_currency" columnName="currency_code" columnDataType="varchar(3)"/>
    	<addNotNullConstraint tableName="adm_currency" columnName="description_en" columnDataType="varchar(255)"/>
    	<addNotNullConstraint tableName="adm_language" columnName="description_en" columnDataType="varchar(255)"/>
    	<addNotNullConstraint tableName="adm_language" columnName="language_code" columnDataType="varchar(3)"/>
        <addUniqueConstraint columnNames="language_code" constraintName="UniqueConstraint_adm__language_code" tableName="adm_language" />
        <addUniqueConstraint columnNames="description_en" constraintName="UniqueConstraint_adm_language__description_en" tableName="adm_language" />
        <addUniqueConstraint columnNames="description_en" constraintName="UniqueConstraint_adm_currency__description_en" tableName="adm_currency" />
    </changeSet>

    <changeSet id="#4765_20191112" author="MohammedELAZZOUZI">
    	<update tableName="billing_cycle">
	        <column name="billing_cycle_type" value="BILLINGACCOUNT"/>
	        <where>billing_cycle_type is null</where>
    	</update>
        <addNotNullConstraint columnName="billing_cycle_type" tableName="billing_cycle" columnDataType="varchar(256)"/>
    </changeSet>

    <changeSet id="#4783_20191118" author="MohamedSTITANE" dbms="postgresql">
        <sql>CREATE INDEX wo_operation_date_index ON ${db.schema.adapted}billing_wallet_operation ((operation_date::DATE))</sql>
        <sql>CREATE INDEX edr_event_date_index ON ${db.schema.adapted}rating_edr ((event_date::DATE))</sql>
        <sql>CREATE INDEX rt_usage_date_index ON ${db.schema.adapted}billing_rated_transaction ((usage_date::DATE))</sql>
    </changeSet>

    <changeSet id="#4412_20191125" author="MohammedELAZZOUZI">
    	<dropColumn tableName="billing_invoice_configuration" columnName="display_charges_periods"></dropColumn>
    	<addColumn tableName="billing_invoice_configuration">
    		<column name="display_wallet_operations" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>

    <changeSet id="#4795_221119" author="Mohammed_ElAzzouzi">
        <sql>create index billing_invoice_agregate_tax_invoice_agregate_idx on ${db.schema.adapted}billing_invoice_agregate (tax_invoice_agregate)</sql>
        <sql>create index billing_invoice_agregate_sub_cat_invoice_agregate_id_idx on ${db.schema.adapted}billing_invoice_agregate (sub_cat_invoice_agregate_id)</sql>
        <sql>create index ar_account_operation_cat_inv_agregate_id_idx on ${db.schema.adapted}ar_account_operation (cat_inv_agregate_id)</sql>
        <sql>create index ar_account_operation_sub_cat_inv_agregate_id_idx on ${db.schema.adapted}ar_account_operation (sub_cat_inv_agregate_id)</sql>
    </changeSet>

    <changeSet author="abdelkader.bouazza" id="#4494-Enable_a_subscription_to_have_the_same_access_point_in_two_or_more_different_periods_of_time">
        <dropUniqueConstraint tableName="medina_access" constraintName="uk_lca62y5gn9qo1e6jr84i9w3lr"/>
        <addUniqueConstraint columnNames="acces_user_id, subscription_id, start_date, end_date" constraintName="uk_lca62y5gn9qo1e6jr84i9w3lr" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="medina_access"/>
    </changeSet>
    <changeSet id="#4712_20191223" author="khalidHORRI">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="custom_table_code_el" type="varchar(2000)"/>
            <column name="data_filter_el" type="varchar(2000)"/>
            <column name="fields_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4791_20200113" author="KhalidHORRI">

        <addColumn tableName="cat_counter_template">
            <column name="is_accumulator" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="cat_serv_trm_charge_template">
            <column name="counter_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_serv_trm_charge_template" constraintName="fk_serv_trm_charge_template_counter_template"
                                 deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template"/>
        <addColumn tableName="cat_serv_sub_charge_template">
            <column name="counter_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_serv_sub_charge_template" constraintName="fk_serv_sub_charge_template_counter_template"
                                 deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template"/>
        <addColumn tableName="billing_counter">
            <column name="customer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_counter_customer_id" referencedTableName="crm_customer"
                                 baseColumnNames="customer_id" baseTableName="billing_counter" referencedColumnNames="id"/>
        <addColumn tableName="billing_counter">
            <column name="customer_account_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_counter_customer_account_id" referencedTableName="ar_customer_account"
                                 baseColumnNames="customer_account_id" baseTableName="billing_counter" referencedColumnNames="id"/>

        <addColumn tableName="billing_counter_period">
            <column name="is_accumulator" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <!--    one shot migration of sellers -->
    <changeSet id="4745_20200108" author="MohamedSTITANE" >
        <sql dbms="postgresql" endDelimiter="$$" splitStatements="false">
            <![CDATA[DO $$
DECLARE
	oldSeller RECORD;
	seqId integer;
	sellId integer;
BEGIN
	 FOR sellId IN SELECT id FROM public.crm_seller
	 LOOP
		BEGIN
			seqId := nextval('account_entity_seq');
			-- get freshly record because parent seller has changed
			select * into oldSeller from public.crm_seller where id = sellId;
			-- Inserted new account entity with id
			INSERT INTO account_entity (id, version ,created ,updated ,code ,description ,address_1 ,address_2 ,address_3,
				address_city ,address_country_id ,address_state ,address_zipcode ,creator, updater ,uuid ,bam_id ,
				cf_values ,cf_values_accum ,email ,fax ,mobile ,phone ,vat_no, registration_no , account_type)
					VALUES (seqId, oldSeller.version, oldSeller.created, oldSeller.updated, oldSeller.code, oldSeller.description,
							oldSeller.address_1, oldSeller.address_2, oldSeller.address_3, oldSeller.address_city, oldSeller.address_country_id,
							oldSeller.address_state, oldSeller.address_zipcode, oldSeller.creator, oldSeller.updater, oldSeller.uuid ,
							oldSeller.bam_id, oldSeller.cf_values, oldSeller.cf_values_accum, oldSeller.email, oldSeller.fax,
							oldSeller.mobile, oldSeller.phone, oldSeller.vat_no, oldSeller.registration_no, 'ACCT_S');

			--update code to prevent uk constraint
			update public.crm_seller set code = concat(code,'_OLD') where id = oldSeller.id;

			-- Insert a seller entity with new id
			INSERT INTO public.crm_seller(
				id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode,
				creator, updater, parent_seller_id, trading_country_id, trading_currency_id, trading_language_id, credit_note_prefix, current_credit_note_nb,
				credit_note_sequence_size, uuid, bam_id, cf_values, cf_values_accum, email, fax, mobile, phone, vat_no, registration_no, legal_text, legal_type, general_ledger_id)
				VALUES (seqId, oldSeller.version, oldSeller.created, oldSeller.updated, oldSeller.code, oldSeller.description, oldSeller.address_1, oldSeller.address_2,
				oldSeller.address_3, oldSeller.address_city, oldSeller.address_country_id, oldSeller.address_state, oldSeller.address_zipcode, oldSeller.creator,
				oldSeller.updater, oldSeller.parent_seller_id, oldSeller.trading_country_id, oldSeller.trading_currency_id, oldSeller.trading_language_id,
				oldSeller.credit_note_prefix, oldSeller.current_credit_note_nb, oldSeller.credit_note_sequence_size, oldSeller.uuid, oldSeller.bam_id, oldSeller.cf_values,
				 oldSeller.cf_values_accum, oldSeller.email, oldSeller.fax, oldSeller.mobile, oldSeller.phone, oldSeller.vat_no, oldSeller.registration_no,
				 oldSeller.legal_text, oldSeller.legal_type, oldSeller.general_ledger_id);

			-- Update a parent seller entity with new id
			update public.crm_seller set parent_seller_id = seqId where parent_seller_id = oldSeller.id;

			-- Update table billing_charge_instance fk
			update public.billing_charge_instance set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table crm_customer fk
			update public.crm_customer set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_invoice fk
			update public.billing_invoice set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_product_instance  fk
			update public.billing_product_instance set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_rated_transaction fk
			update public.billing_rated_transaction set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_subscription fk
			update public.billing_subscription  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_wallet_operation fk
			update public.billing_wallet_operation  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_account_operation fk
			update public.ar_account_operation  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_seq_invtyp_sell fk
			update public.billing_seq_invtyp_sell set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table cat_price_plan_matrix fk
			update public.cat_price_plan_matrix set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_ddrequest_lot fk
			update public.ar_ddrequest_lot set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_payment_gateway fk
			update public.ar_payment_gateway set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_ddrequest_lot_op fk
			update public.ar_ddrequest_lot_op set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table crm_customer_sequence fk
			update public.crm_customer_sequence set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table cat_product_offer_seller  fk
			update public.cat_product_offer_seller set seller_id = seqId where seller_id = oldSeller.id;

			-- delete old seller
			delete from public.crm_seller where id = oldSeller.id;

		EXCEPTION when others then
			RAISE INFO '%', concat('Error ', SQLSTATE, ' : ', SQLERRM, ' for seller ' , oldSeller.code);
        END;
	END LOOP;
END $$;]]>
        </sql>
        <dropColumn tableName="crm_seller">
            <column name="version"/>
            <column name="created"/>
            <column name="updated"/>
            <column name="code"/>
            <column name="description"/>
            <column name="address_1"/>
            <column name="address_2"/>
            <column name="address_3"/>
            <column name="address_city"/>
            <column name="address_country_id"/>
            <column name="address_state"/>
            <column name="address_zipcode"/>
            <column name="creator"/>
            <column name="updater"/>
            <column name="uuid"/>
            <column name="bam_id"/>
            <column name="cf_values"/>
            <column name="cf_values_accum"/>
            <column name="email"/>
            <column name="fax"/>
            <column name="mobile"/>
            <column name="phone"/>
            <column name="vat_no"/>
        </dropColumn>
    </changeSet>


    <changeSet id="#4906_Creation_CDR_Table_1" author="anasseh" dbms="mysql">
            <createTable tableName="rating_cdr_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="rating_cdr_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}rating_cdr_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4906_Creation_CDR_Table_2" author="anasseh">
   		<createSequence sequenceName="rating_cdr_seq" />
   		<createTable tableName="rating_cdr">
	         <column name="id" type="bigint" autoIncrement="${id.auto}">
	             <constraints nullable="false" primaryKey="true" primaryKeyName="rating_cdr_pkey" />
	         </column>
	         <column name="version" type="int4" />
	         <column name="created" type="datetime" />
	         <column name="event_date" type="datetime" />
	         <column name="last_updated" type="datetime" />
	         <column name="origin_batch" type="varchar(255)" />
	         <column name="origin_record" type="varchar(255)" />
	         <column name="quantity" type="numeric" />
	         <column name="reject_reason" type="${type.text}" />
	         <column name="status" type="varchar(255)" />
	         <column name="status_date" type="datetime" />
	         <column name="parameter_1" type="varchar(255)" />
	         <column name="parameter_2" type="varchar(255)" />
	         <column name="parameter_3" type="varchar(255)" />
	         <column name="parameter_4" type="varchar(255)" />
	         <column name="parameter_5" type="varchar(255)" />
	         <column name="parameter_6" type="varchar(255)" />
	         <column name="parameter_7" type="varchar(255)" />
	         <column name="parameter_8" type="varchar(255)" />
	         <column name="parameter_9" type="varchar(255)" />
	         <column name="date_parameter_1" type="datetime" />
	         <column name="date_parameter_2" type="datetime" />
	         <column name="date_parameter_3" type="datetime" />
	         <column name="date_parameter_4" type="datetime" />
	         <column name="date_parameter_5" type="datetime" />
	         <column name="decimal_parameter_1" type="numeric" />
	         <column name="decimal_parameter_2" type="numeric" />
	         <column name="decimal_parameter_3" type="numeric" />
	         <column name="decimal_parameter_4" type="numeric" />
	         <column name="decimal_parameter_5" type="numeric" />
	         <column name="access_code" type="varchar(255)" />
	         <column name="header_edr_id" type="bigint">
	             <constraints nullable="true" />
	         </column>
	         <column name="extra_parameter" type="text" />
    	</createTable>
        <sql>CREATE INDEX rating_cdr_index ON ${db.schema.adapted}rating_cdr(origin_batch, origin_record)</sql>
        <sql>CREATE INDEX rating_cdr_status ON ${db.schema.adapted}rating_cdr(status)</sql>
    </changeSet>

    <changeSet id="#4933_20200117" author="AbdellatifBARI">
        <addNotNullConstraint tableName="adm_file_format" columnName="configuration_template" columnDataType="varchar(255)"/>
        <addColumn tableName="adm_file_format">
            <column name="job_code" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3743_20190414" author="HatimOudad">
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'PaymentJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'PaymentScheduleProcessingJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'SepaDirectDebitJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'SepaRejectedTransactionsJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'CheckPaymentScheduleCallbackJob'
        </sql>
    </changeSet>

    <changeSet id="#500X_20200218" author="mohamed.el.youssoufi" dbms="postgresql">
        <sql>CREATE INDEX rt_edr_id ON ${db.schema.adapted}billing_rated_transaction (edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX resa_origin_edr_id ON ${db.schema.adapted}billing_reservation (origin_edr_id ASC NULLS LAST)
        </sql>
        <sql>CREATE INDEX wo_edr_id ON ${db.schema.adapted}billing_wallet_operation (edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX cdr_header_edr_id ON ${db.schema.adapted}rating_cdr (header_edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX edr_header_edr_id ON ${db.schema.adapted}rating_edr (header_edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX rt_adjusted_rated_tx ON ${db.schema.adapted}billing_rated_transaction (adjusted_rated_tx ASC
            NULLS LAST)
        </sql>
        <sql>CREATE INDEX wo_rt_id ON ${db.schema.adapted}billing_wallet_operation (rated_transaction_id ASC NULLS
            LAST)
        </sql>
        <sql>CREATE INDEX wo_rerated_wo ON ${db.schema.adapted}billing_wallet_operation (reratedwalletoperation_id ASC
            NULLS LAST)
        </sql>
    </changeSet>
    <changeSet id="#4787_20200224" author="khalidHORRI">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="override_prorata" type="varchar(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="#4096_2020-02-07_1" author="AndriusKarpavicius" dbms="mysql">
        <createTable tableName="billing_tax_category_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_category_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_category_seq values(1)</sql>

        <createTable tableName="billing_tax_class_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_class_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_class_seq values(1)</sql>

        <createTable tableName="billing_tax_mapping_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_mapping_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_mapping_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4096_2020-02-07_2" author="AndriusKarpavicius">
        <createSequence sequenceName="billing_tax_category_seq" startValue="1" />
        <createTable tableName="billing_tax_category">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_category_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="${type.json}" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_tax_category_code" deferrable="false" disabled="false" initiallyDeferred="false"
            tableName="billing_tax_category" />

        <createSequence sequenceName="billing_tax_class_seq" startValue="1" />
        <createTable tableName="billing_tax_class">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_class_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="${type.json}" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_tax_class_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_tax_class" />

        <createSequence sequenceName="billing_tax_mapping_seq" startValue="1" />
        <createTable tableName="billing_tax_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="tax_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tax_class_id" type="bigint" />
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="seller_country_id" type="bigint" />
            <column name="buyer_country_id" type="bigint" />
            <column name="filter_el" type="varchar(2000)" />
            <column name="filter_el_sp" type="varchar(2000)" />
            <column name="tax_id" type="bigint" />
            <column name="tax_el" type="varchar(2000)" />
            <column name="tax_el_sp" type="varchar(2000)" />
            <column name="tax_script_id" type="bigint" />
            <column name="priority" type="int4" defaultValueNumeric="0" />
            <column name="source" type="varchar(2000)" />
            <column name="origin_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />
        <addForeignKeyConstraint baseColumnNames="seller_country_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_seller_country_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />
        <addForeignKeyConstraint baseColumnNames="buyer_country_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_buyer_country_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="tax_script_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_script_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />


        <addColumn tableName="crm_customer_category">
            <column name="tax_category_id" type="bigint" />
            <column name="tax_category_el" type="varchar(2000)" />
            <column name="tax_category_el_sp" type="varchar(2000)" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="crm_customer_category" constraintName="fk_crm_customer_category_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />

        <addColumn tableName="billing_billing_account">
            <column name="tax_category_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="billing_billing_account" constraintName="fk_billing_account_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />

        <addColumn tableName="cat_charge_template">
            <column name="tax_class_id" type="bigint" />
            <column name="tax_class_el" type="varchar(2000)" />
            <column name="tax_class_el_sp" type="varchar(2000)" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="cat_charge_template" constraintName="fk_cat_charge_template_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

        <addColumn tableName="billing_wallet_operation">
            <column name="tax_class_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

        <addColumn tableName="billing_rated_transaction">
            <column name="tax_class_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

    </changeSet>

    <changeSet id="#4096_2020-02-07_3" author="AndriusKarpavicius">
        <insert tableName="billing_tax_category">
            <column name="id" valueNumeric="-1"/>
            <column name="version" valueNumeric="0"/>
            <column name="created" valueDate="2020-02-08 00:03:59.983" />
            <column name="version" valueNumeric="0" />
            <column name="code" value="Tax category"/>
            <column name="uuid" value="tax_category_1"/>
        </insert>

        <sql>insert into ${db.schema.adapted}billing_tax_class (id, version, created, uuid, code, description) (select id, 0, created, 'tax_class_'||id, code, description from ${db.schema.adapted}billing_invoice_sub_cat isc where isc.id in (select distinct invoice_sub_category_id from ${db.schema.adapted}billing_inv_sub_cat_country))</sql>
        <sql>insert into ${db.schema.adapted}billing_tax_mapping (id, version, created, tax_category_id, tax_class_id, seller_country_id, buyer_country_id, filter_el, tax_id, tax_el, tax_el_sp, valid_from, valid_to) (select nextval('billing_tax_mapping_seq'), 0, created, -1, invoice_sub_category_id, selling_country_id, trading_country_id, filter_el, tax_id, tax_code_el, tax_code_el_sp, start_validity_date, end_validity_date from ${db.schema.adapted}billing_inv_sub_cat_country)</sql>
        <sql>update ${db.schema.adapted}billing_tax_mapping set tax_script_id = (select tax_script_instance_id from ${db.schema.adapted}billing_invoice_sub_cat where billing_tax_mapping.id=billing_invoice_sub_cat.id and tax_script_instance_id is not null)</sql>

        <sql>update ${db.schema.adapted}billing_wallet_operation set tax_class_id = invoice_sub_category_id</sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set tax_class_id = invoice_sub_category_id</sql>
        <sql>update ${db.schema.adapted}cat_charge_template set tax_class_id = invoice_sub_category </sql>
        <sql>update ${db.schema.adapted}crm_customer_category set tax_category_id = -1 where exonerated_from_taxes=0 </sql>

        <addNotNullConstraint tableName="cat_charge_template" columnName="tax_class_id" columnDataType="bigint"/>

        <dropTable tableName="billing_inv_sub_cat_country"/>

    </changeSet>
    <changeSet id="#4201_20200225" author="khalidHORRI">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="reimburse_oneshots" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="#4071_20200227" author="khalidHORRI">
        <addColumn tableName="cat_charge_template">
            <column name="drop_zero_wo" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>


    <changeSet author="abdelkader.bouazza"  id="#4894-Additional_fields_in_RT">
        <addColumn tableName="billing_rated_transaction">
            <column name="input_quantity" type="numeric(23, 12)" />
            <column name="raw_amount_without_tax" type="numeric(23, 12)" />
            <column name="raw_amount_with_tax" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet author="abdelkader.bouazza"  id="#4893-Add-custom-field-support-to-WalletOperation">
        <addColumn tableName="billing_wallet_operation">
            <column name="uuid" type="varchar(60)"/>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
        <sql>update ${db.schema.adapted}billing_wallet_operation set uuid = 'wo'||id</sql>
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="uuid"/>
    </changeSet>

    <changeSet id="#4892_2020-03-04" author="AndriusKarpavicius">
        <addColumn tableName="cat_charge_template">
            <column name="rating_script_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="rating_script_id" baseTableName="cat_charge_template" constraintName="fk_charge_template_rating_script_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    </changeSet>

    <changeSet id="#5038_2020-03-06" author="AndriusKarpavicius">
        <dropNotNullConstraint tableName="meveo_script_instance" columnName="script"/>
    </changeSet>

    <changeSet id="#5064_2020-03-15" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob'</sql>
    </changeSet>
    <changeSet author="abdelkader.bouazza" id="#4891-Copy-recurrence-calendar-and-applyInAdvance-to-RecurringChargeInstance-from-a-RecurringChargeTemplate">
        <addColumn tableName="billing_charge_instance">
            <column name="calendar_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_charge_instance">
            <column name="apply_in_advance" type="${type.boolean}" />
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}billing_charge_instance AS bci
            SET calendar_id = cct.calendar_id,
            apply_in_advance = cct.apply_in_advance
            FROM ${db.schema.adapted}cat_charge_template AS cct
            WHERE bci.charge_template_id = cct.id
        </sql>
    </changeSet>
    <changeSet author="khalid.horri" id="#4757_20191118">
        <addColumn tableName="account_entity">
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="crm_customer">
            <column name="minimum_target_account_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="minimum_target_account_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="minimum_target_account_id" baseTableName="crm_customer"
                                 constraintName="fk_customer_minimum_target_account_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="billing_billing_account"/>
        <addForeignKeyConstraint baseColumnNames="minimum_target_account_id" baseTableName="ar_customer_account"
                                 constraintName="fk_ca_minimum_target_account_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="billing_billing_account"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="account_entity"
                                 constraintName="fk_ca_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_subscription"
                                 constraintName="fk_su_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_service_instance"
                                 constraintName="fk_si_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="cat_offer_template"
                                 constraintName="fk_ot_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="cat_service_template"
                                 constraintName="fk_st_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
    </changeSet>
    <changeSet id="#4924_20200219" author="anasseh">
        <addColumn tableName="billing_invoice">
            <column name="external_ref" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#5085_20200330 - triggeredNextCharge has an incorrect value" author="Mohammed_ELAZZOUZI">
		<update tableName="cat_charge_template">
			<column name="trigger_next_charge" valueNumeric="0"></column>
			<where>trigger_next_charge is null</where>
		</update>
	</changeSet>

    <changeSet id="#4903_GDPR_Anonymize_CF" author="Mounir_BOUKAYOUA">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="anonymize_gdpr" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#4879_20190121" author="AmineBENAICHA">
       <addColumn tableName="cat_counter_template">
           <column name="calendar_code_el" type="varchar(2000)" />
       </addColumn>
    </changeSet>

    <changeSet id="#5052_20200323" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_rated_transaction">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="billing_rated_transaction" constraintName="fk_input_billing_rated_transaction_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />
        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="billing_rated_transaction" constraintName="fk_rating_billing_rated_transaction_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />
    </changeSet>


    <changeSet id="#5014_20200313" author="khalidHORRI">
        <addColumn tableName="crm_customer">
            <column name="invoicing_threshold" type="numeric(23, 12)"/>
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="invoicing_threshold" type="numeric(23, 12)"/>
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="#5014_20200402" author="khalidHORRI">
        <dropDefaultValue tableName="ar_customer_account" columnName="check_threshold"/>
        <sql>update ${db.schema.adapted}ar_customer_account set check_threshold = null</sql>
    </changeSet>
    <changeSet id="#5125_20200407" author="khalidHORRI">
        <sql>update ${db.schema.adapted}cat_counter_template set is_accumulator = 0 where is_accumulator = null</sql>
        <createTable tableName="cat_serv_usage_counter_template">
            <column name="service_usage_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_usage_templt_id, indx" constraintName="cat_serv_usage_counter_template_pkey" tableName="cat_serv_usage_counter_template"/>
        <createTable tableName="cat_serv_rec_counter_template">
            <column name="service_rec_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_rec_templt_id, indx" constraintName="cat_serv_rec_counter_template_pkey" tableName="cat_serv_rec_counter_template"/>
        <createTable tableName="cat_serv_sub_counter_template">
            <column name="service_sub_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_sub_templt_id, indx" constraintName="cat_serv_sub_counter_template_pkey" tableName="cat_serv_sub_counter_template"/>
        <createTable tableName="cat_serv_trm_counter_template">
            <column name="service_trm_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_trm_templt_id, indx" constraintName="cat_serv_trm_counter_template_pkey" tableName="cat_serv_trm_counter_template"/>
        <createTable tableName="billing_chrg_inst_counter">
            <column name="chrg_instance_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_instance_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="chrg_instance_id, indx" constraintName="billing_chrg_inst_counter_pkey" tableName="billing_chrg_inst_counter"/>

    </changeSet>

    <changeSet id="#2447_20200421" author="khalidHORRI">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="parameter1_el" type="varchar(2000)"/>
            <column name="parameter2_el" type="varchar(2000)"/>
            <column name="parameter3_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5130_20200414" author="khalidHORRI">
    <addColumn tableName="cat_counter_template">
        <column name="accumulator_type" type="varchar(35)"/>
        <column name="filter_el" type="varchar(2000)"/>
        <column name="key_el" type="varchar(2000)"/>
        <column name="value_el" type="varchar(2000)"/>
    </addColumn>
    <addColumn tableName="billing_counter_period">
        <column name="accumulator_type" type="varchar(35)"/>
        <column name="filter_el" type="varchar(2000)"/>
        <column name="key_el" type="varchar(2000)"/>
        <column name="value_el" type="varchar(2000)"/>
    </addColumn>
    <createTable tableName="billing_counter_period_values">
        <column name="counter_key" type="varchar(255)">
            <constraints nullable="false"/>
        </column>
        <column name="counter_value" type="numeric(19,2)">
            <constraints nullable="false"/>
        </column>
        <column name="counterperiod_id" type="bigint">
            <constraints nullable="false"/>
        </column>

    </createTable>
        <addPrimaryKey tableName="billing_counter_period_values" columnNames="counterperiod_id,counter_key" constraintName="billing_counter_period_values_pkey"/>
        <addForeignKeyConstraint baseTableName="billing_counter_period_values" baseColumnNames="counterperiod_id"
                                 constraintName="billing_counter_period_values_counterperiod_id_fk" referencedTableName="billing_counter_period"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="MohammedELAZZOUZI"  id="#4004_ Add_CustomField_to_OrderItem">
        <addColumn tableName="ord_order_item">
            <column name="uuid" type="varchar(60)"/>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order_item set uuid = 'oi'||id</sql>
        <addNotNullConstraint tableName="ord_order_item" columnName="uuid"/>
    </changeSet>

    <changeSet id="#40167_20200407" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_wallet_operation">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <sql>update ${db.schema.adapted}billing_wallet_operation  set accounting_code_id = iv.accounting_code_id from billing_invoice_sub_cat iv where invoice_sub_category_id = iv.id and invoice_sub_category_id is not null </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction  set accounting_code_id = iv.accounting_code_id from billing_invoice_sub_cat iv where invoice_sub_category_id = iv.id and invoice_sub_category_id is not null </sql>
    </changeSet>

    <changeSet id="#5163_20200415" author="AndriusKarpavicius">
        <addColumn tableName="billing_charge_instance">
            <column name="charged_to_date" type="datetime"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5174_20200423" author="AbdelmounaimAkadid">
    	<addColumn tableName="ord_order_item">
    		<column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime" />
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
    </changeSet>

    <changeSet id="#5193_20200428" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_mcols where cft_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%'</sql>
    </changeSet>

    <changeSet id="#5174_20200504" author="AbdelmounaimAkadid">
    	<sql>update ${db.schema.adapted}ord_order_item set code = id where code is null</sql>
    	<addUniqueConstraint columnNames="code" constraintName="uk_order_item_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="ord_order_item" />
    </changeSet>

    <changeSet id="#4792_20200504" author="khalidHORRI">
        <addColumn tableName="billing_invoice_sub_cat">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="billing_wallet_operation">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="sort_index_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>


    <changeSet id="#5172_20200426" author="anasseh">
         <addColumn tableName="ar_account_operation">
            <column name="payment_history_id" type="bigint"></column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="payment_history_id" baseTableName="ar_account_operation" constraintName="fk_pay_hisyo" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_history" />

     </changeSet>

     <changeSet id="#5206_20200505" author="AndriusKarpavicius" dbms="postgresql" >
        <sql>drop index adm_file_type_code_index</sql>
        <sql>drop index flat_file_code_index</sql>

        <sql>CREATE UNIQUE INDEX adm_file_type_code_index ON ${db.schema.adapted}adm_file_type(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_file_format_code_index ON ${db.schema.adapted}adm_file_format(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX flat_file_code_index ON ${db.schema.adapted}flat_file(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_language_code_index ON ${db.schema.adapted}adm_language(lower(language_code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_category_code_index ON ${db.schema.adapted}billing_tax_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_class_code_index ON ${db.schema.adapted}billing_tax_class(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_order_item_code_index ON ${db.schema.adapted}ord_order_item(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX wf_generic_workflow_code_index ON ${db.schema.adapted}wf_generic_workflow(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_template_filename_index ON ${db.schema.adapted}billing_invoice_template(lower(file_name))</sql>
        <sql>CREATE UNIQUE INDEX adm_notification_code_index ON ${db.schema.adapted}adm_notification(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_discount_plan_code_index ON ${db.schema.adapted}cat_discount_plan(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_price_plan_matrix_code_index ON ${db.schema.adapted}cat_price_plan_matrix(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_contact_coords_code_index ON ${db.schema.adapted}com_contact_coords(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_subscrip_termin_reason_code_index ON ${db.schema.adapted}billing_subscrip_termin_reason(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_cycle_code_index ON ${db.schema.adapted}billing_cycle(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_currency_code_index ON ${db.schema.adapted}adm_currency(lower(currency_code))</sql>
        <sql>CREATE UNIQUE INDEX cat_triggered_edr_code_index ON ${db.schema.adapted}cat_triggered_edr(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_sender_config_code_index ON ${db.schema.adapted}com_sender_config(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_code_index ON ${db.schema.adapted}billing_tax(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX crm_provider_code_index ON ${db.schema.adapted}crm_provider(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_inbound_request_code_index ON ${db.schema.adapted}adm_inbound_request(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_campaign_code_index ON ${db.schema.adapted}com_campaign(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_msg_var_value_code_index ON ${db.schema.adapted}com_msg_var_value(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_msg_tmpl_variable_code_index ON ${db.schema.adapted}com_msg_tmpl_variable(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_template_code_index ON ${db.schema.adapted}billing_invoice_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_wallet_template_code_index ON ${db.schema.adapted}cat_wallet_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_calendar_code_index ON ${db.schema.adapted}cat_calendar(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_user_username_index ON ${db.schema.adapted}adm_user(lower(username))</sql>
        <sql>CREATE UNIQUE INDEX crm_provider_contact_code_index ON ${db.schema.adapted}crm_provider_contact(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX rm_service_param_template_code_index ON ${db.schema.adapted}rm_service_param_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_counter_template_code_index ON ${db.schema.adapted}cat_counter_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ar_occ_template_code_index ON ${db.schema.adapted}ar_occ_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX dwh_chart_code_index ON ${db.schema.adapted}dwh_chart(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_sub_cat_code_index ON ${db.schema.adapted}billing_invoice_sub_cat(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_cat_code_index ON ${db.schema.adapted}billing_invoice_cat(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_message_template_code_index ON ${db.schema.adapted}com_message_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX dwh_measurable_quant_code_index ON ${db.schema.adapted}dwh_measurable_quant(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX bi_job_name_index ON ${db.schema.adapted}bi_job(lower(name))</sql>
        <sql>CREATE UNIQUE INDEX ar_credit_category_code_index ON ${db.schema.adapted}ar_credit_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_filter_code_index ON ${db.schema.adapted}meveo_filter(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_script_instance_code_index ON ${db.schema.adapted}meveo_script_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_meveo_instance_code_index ON ${db.schema.adapted}com_meveo_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_job_instance_code_index ON ${db.schema.adapted}meveo_job_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_timer_code_index ON ${db.schema.adapted}meveo_timer(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_module_code_index ON ${db.schema.adapted}meveo_module(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_offer_template_category_code_index ON ${db.schema.adapted}cat_offer_template_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_type_code_index ON ${db.schema.adapted}billing_invoice_type(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX wf_workflow_code_index ON ${db.schema.adapted}wf_workflow(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_channel_code_index ON ${db.schema.adapted}cat_channel(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_order_code_index ON ${db.schema.adapted}ord_order(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_digital_resource_code_index ON ${db.schema.adapted}cat_digital_resource(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_quote_code_index ON ${db.schema.adapted}ord_quote(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cust_cet_code_index ON ${db.schema.adapted}cust_cet(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_accounting_code_code_index ON ${db.schema.adapted}billing_accounting_code(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_contact_email_index ON ${db.schema.adapted}com_contact(lower(email))</sql>
        <sql>CREATE UNIQUE INDEX billing_finance_segment_code_index ON ${db.schema.adapted}billing_finance_segment(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_general_ledger_code_index ON ${db.schema.adapted}billing_general_ledger(lower(code))</sql>


        <sql>CREATE UNIQUE INDEX hierarchy_entity_code_index ON ${db.schema.adapted}hierarchy_entity(lower(code), hierarchy_type)</sql>
        <sql>CREATE UNIQUE INDEX account_entity_code_index ON ${db.schema.adapted}account_entity(lower(code), account_type)</sql>

    </changeSet>

    <changeSet id="#5257_20200527" author="AndriusKarpavicius" dbms="postgresql" >
        <addColumn tableName="billing_wallet_operation">
            <column name="reject_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4895_20200515" author="MohammedAmineTazi">
       <createSequence sequenceName="cat_fixed_date_seq"/>
        <createTable tableName="cat_fixed_date">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_fixed_date_pkey" />
            </column>
            <column name="start_date" type="datetime" >
            	<constraints nullable="false" />
            </column>
         	<column name="end_date" type="datetime" >
            	<constraints nullable="false" />
            </column>
            <column name="cat_calendar_id" type="bigint" >
            	<constraints nullable="false" />
            </column>
            <column name="version" type="int4" />
        </createTable>
        <addForeignKeyConstraint constraintName="cat_fixed_date_cat_calendar_fk" baseColumnNames="cat_calendar_id" baseTableName="cat_fixed_date" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
    </changeSet>

    <changeSet id="#5279_20200608_Cancellation of a billing run is impossible" author="anasseh">
        <sql>CREATE INDEX ao_inv_idx ON ${db.schema.adapted}ar_account_operation  (invoice_id)</sql>
        <sql>CREATE INDEX rt_argr_f_idx ON ${db.schema.adapted}billing_rated_transaction  (aggregate_id_f)</sql>
    </changeSet>

    <changeSet id="#5266_20200622" author="AbdelmounaimAkadid">
        <dropColumn tableName="billing_counter_period">
            <column name="filter_el"></column>
            <column name="key_el"></column>
            <column name="value_el"></column>
        </dropColumn>
     </changeSet>

    <changeSet id="#5319_20200703" author="Mohammed_EL-AZZOUZI">
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="quantity" columnDataType="numeric(23, 12)"/>
    </changeSet>


    <changeSet id="#5331_20190630" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_RecurringRatingJob'</sql>
    </changeSet>

        <changeSet id="#5295_20200626" author="anasseh">
         <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="tax_class_id" type="bigint"></column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="ar_payment_schedule_tmpl" constraintName="fk_tax_class_pst" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

            <sql>update ${db.schema.adapted}ar_payment_schedule_tmpl set is_generate_adv_pay_inv=1</sql>

     </changeSet>


    <changeSet id="#5330_20190630" author="AndriusKarpavicius">
        <addColumn tableName="cat_calendar">
            <column name="init_date_el" type="varchar(2000)"/>
            <column name="init_date_el_sp" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5372_20190630" author="AndriusKarpavicius">
        <addColumn tableName="billing_cycle">
            <column name="transaction_date_delay_el" type="varchar(2000)"/>
            <column name="invoice_date_production_delay_el" type="varchar(2000)"/>
            <column name="invoice_date_delay_el" type="varchar(2000)"/>
            <column name="transaction_date_el" type="varchar(2000)"/>
        </addColumn>

        <sql>update ${db.schema.adapted}billing_cycle set billing_template_name_el = billing_template_name where billing_template_name_el is null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set due_date_delay_el = due_date_delay where due_date_delay_el is null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set transaction_date_delay_el = transaction_date_delay where transaction_date_delay is not null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set invoice_date_production_delay_el = invoice_date_production_delay where invoice_date_production_delay is not null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set invoice_date_delay_el = invoice_date_delay where invoice_date_delay is not null</sql>

        <dropColumn tableName="billing_cycle" columnName="transaction_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="invoice_date_production_delay"/>
        <dropColumn tableName="billing_cycle" columnName="invoice_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="due_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="billing_template_name"/>
    </changeSet>


    <changeSet id="#5372_20200711" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}billing_invoice_type set billing_template_name_el = billing_template_name where billing_template_name_el is null</sql>
        <dropColumn tableName="billing_invoice_type" columnName="billing_template_name"/>
    </changeSet>

    <changeSet id="#5303_20200629" author="hznibar" >
        <addColumn tableName="rating_cdr">
            <column name="times_tried" type="int4"/>
            <column name="type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5241_20200622" author="khalidHORRI">
        <createTable tableName="wo_aggregation_line">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wo_aggregation_line_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="field" type="varchar(255)"/>
            <column name="action" type="varchar(25)"/>
            <column name="value" type="varchar(255)"/>
            <column name="required" type="${type.boolean}"/>
            <column name="is_custom_field" type="${type.boolean}"/>
            <column name="group_by" type="varchar(25)"/>
            <column name="group_by_parameter" type="varchar(25)"/>
            <column name="alias" type="varchar(255)"/>
            <column name="wo_aggregation_settings_id" type="bigint"/>
        </createTable>
        <createTable tableName="wo_aggregation_settings">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wo_aggregation_matrix_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)"/>
            <column name="global_aggregation" type="${type.boolean}"/>
            <column name="period_aggregation" type="${type.boolean}"/>
            <column name="period_end_date_included" type="${type.boolean}"/>
            <column name="wallet_operation_filter_id" type="bigint"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="wo_aggregation_settings" baseColumnNames="wallet_operation_filter_id"
                                 constraintName="wallet_operation_filter_id_fk" referencedTableName="meveo_filter"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="wo_aggregation_line" baseColumnNames="wo_aggregation_settings_id"
                                 constraintName="wo_aggregation_settings_id_fk" referencedTableName="wo_aggregation_settings"
                                 referencedColumnNames="id"/>
        <createSequence sequenceName="wo_aggregation_line_seq" startValue="1"/>
        <createSequence sequenceName="wo_aggregation_matrix_seq" startValue="1"/>
        <addColumn tableName="billing_rated_transaction">
            <column name="cf_values_accum" type="${type.json}"/>
            <column name="cf_values" type="${type.json}"/>
            <column name="uuid" type="varchar(60)"/>
        </addColumn>
    </changeSet>

     <changeSet id="#5241_20200721" author="khalidHORRI">
        <addColumn tableName="wo_aggregation_settings">
            <column name="aggregation_rounding" type="int4" defaultValueNumeric="2"/>
            <column name="aggregation_rounding_mode" type="varchar(50)" defaultValue="NEAREST"/>
        </addColumn>
     </changeSet>

    <changeSet id="#5388_20200715" author="AndriusKarpavicius">
        <modifyDataType tableName="adm_notification" columnName="event_type_filter" newDataType="varchar(25)"/>
    </changeSet>

    <changeSet id="#FEAT-777_20200728j" author="AbdelkaderBouazza">
        <createTable tableName="document" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="document_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="file_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="creation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="file_name"  type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="tags"  type="varchar(255)"/>
            <column name="linked_account_entity_id" type="bigint" />
            <column name="document_category_id" type="bigint" />
            <column name="document_status" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </createTable>

        <createTable tableName="document_category" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="document_category_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="relative_path"  type="varchar(2000)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </createTable>
        <createTable tableName="document_tags">
            <column name="document_id"  type="bigint"/>
            <column name="tags"  type="varchar(60)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="document" baseColumnNames="linked_account_entity_id"
                                 constraintName="document_account_entity_id_fk" referencedTableName="account_entity"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="document" baseColumnNames="document_category_id"
                                 constraintName="document_category_id_fk" referencedTableName="document_category"
                                 referencedColumnNames="id"/>

        <createSequence sequenceName="document_seq" startValue="1"/>
        <createSequence sequenceName="document_category_seq" startValue="1"/>
    </changeSet>

    <changeSet id="#4764_20200720" author="MohammedELAZZOUZI">
        <addColumn tableName="cat_wallet_template">
            <column name="low_balance_level_el" type="varchar(2000)"/>
            <column name="reject_level_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5408_20200724" author="AbdellatifBARI">
        <addColumn tableName="adm_file_format">
            <column name="file_name_uniqueness" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5405_20190723" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_ReportExtractJob'</sql>
    </changeSet>

    <changeSet id="#5404_20200728" author="khalidHORRI">
        <addColumn tableName="wo_aggregation_settings">
            <column name="additional_order_by" type="varchar(255)"/>
        </addColumn>
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o ) o WHERE o.status='OPEN'
        </createView>
    </changeSet>
    <changeSet id="#5400_23072020" author="KhalidHORRI">
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="payment_day_in_month_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4156_20120719" author="anasseh">
		<addColumn tableName="meveo_filter">
			<column name="polling_query" type="text"/>
		</addColumn>
		<sql>CREATE INDEX ar_ao_dd_item_idx  ON ${db.schema.adapted}ar_account_operation USING btree (ddrequest_item_id)</sql>
    </changeSet>

    <changeSet id="#4906_Creation_CDR_Table" author="MohammedAmineTazi">
        <addColumn tableName="rating_cdr">
            <column name="line" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5372_20190813" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}billing_billing_run set last_transaction_date = process_date where last_transaction_date is null</sql>
        <addNotNullConstraint tableName="billing_billing_run" columnName="last_transaction_date"/>
    </changeSet>

    <changeSet id="#5442_CET_ES" author="AndriusKarpavicius">
        <addColumn tableName="cust_cet">
            <column name="store_in_es" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <addNotNullConstraint tableName="cust_cet" columnName="store_in_es"/>
    </changeSet>
    <changeSet id="#5454_20200824" author="khalidHORRI">
        <dropView viewName="billing_wallet_operation_period"/>
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>


    <changeSet id="#5303_Update_CDR_Table_20200826" author="MohammedAmineTazi">
        <addColumn tableName="rating_cdr">
        	<column name="updater" type="varchar(100)"/>
        </addColumn>
    </changeSet>
      
    <changeSet id="#CORE-5215_11082020" author="AbdelkaderBouazza">
        <addColumn tableName="billing_subscription">
            <column name="payment_method_id"  type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_subscription"
                                 constraintName="fk_subscription_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <addColumn tableName="billing_billing_account">
            <column name="payment_method_id"  type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_billing_account"
                                 constraintName="fk_billing_account_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <addColumn tableName="billing_cycle">
            <column name="split_per_payment_method" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
	<changeSet id="#5303_20200831" author="hznibar" >
        <addColumn tableName="rating_edr">
            <column name="times_tried" type="int4"/>
        </addColumn>
    </changeSet>

	<changeSet id="#5461_20200901" author="Mohammed_EL-AZZOUZI">
        <addColumn tableName="crm_customer">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5460_BA_fields" author="AndriusKarpavicius">
        <sql>UPDATE ${db.schema.adapted}account_entity as ae SET minimum_amount_el = ba.minimum_amount_el, minimum_amount_el_sp = ba.minimum_amount_el_sp, minimum_label_el = ba.minimum_label_el, minimum_label_el_sp=ba.minimum_label_el_sp FROM ${db.schema.adapted}billing_billing_account AS ba WHERE ba.id=ae.id</sql>

        <dropColumn tableName="billing_billing_account" columnName="minimum_amount_el"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_amount_el_sp"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_label_el"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_label_el_sp"/>
    </changeSet>

    <changeSet id="#CORE-5457_20200825" author="AbdelkaderBouazza">
        <addColumn tableName="ar_payment_token">
            <column name="document_id"  type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="ar_payment_token" baseColumnNames="document_id"
                                 constraintName="document_ar_payment_token_id_fk" referencedTableName="document"
                                 referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="#5303_20200902" author="hznibar" >
        <addColumn tableName="rating_cdr">
            <column name="source" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5471-2020-09-07" author="AndriusKarpavicius">
        <createTable tableName="job_execution_error" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="job_execution_error_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="job_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="entity_id" type="bigint"/>
            <column name="period_from" type="datetime"/>
            <column name="period_to" type="datetime"/>

            <column name="error_reason"  type="varchar(2000)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="job_execution_error" baseColumnNames="job_instance_id"
                                 constraintName="job_execution_error_job_instance_fk" referencedTableName="meveo_job_instance"
                                 referencedColumnNames="id"/>

        <createSequence sequenceName="job_execution_error_seq" startValue="1"/>
    </changeSet>

    <changeSet id="#5489-2020-09-14" author="AndriusKarpavicius">
        <addColumn tableName="billing_charge_instance">
            <column name="charge_to_date_on_termination" type="datetime"/>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="apply_terminated_charge_to_date_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5510_20200923" author="anasseh">
		<sql>CREATE INDEX ao_ref_idx ON ${db.schema.adapted}ar_account_operation USING btree (reference)</sql>
    </changeSet>

    <changeSet id="#5534_20200929" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FilteringJob'</sql>
    </changeSet>

    <changeSet id="#5471_20200930" author="AndriusKarpavicius">
        <addColumn tableName="meveo_filter">
            <column name="entity_class" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="zbariki" id="#3402_20201007">
        <addColumn tableName="cat_calendar">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_channel">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="adm_currency">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="adm_language">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="crm_customer_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="ar_credit_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_offer_template_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_offer_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_serv_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_product_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5556_20201006" author="AndriusKarpavicius">
        <modifyDataType tableName="account_entity" columnName="email" newDataType="varchar(2000)"/>
    </changeSet>

    <changeSet id="#5501_20201007" author="MohammedELAZZOUZI">
        <sql>create index billing_subscription_minimum_amount_el_index on ${db.schema.adapted}billing_subscription(minimum_amount_el) where minimum_amount_el is not null</sql>
    	<sql>create index billing_service_instance_minimum_amount_el_index on ${db.schema.adapted}billing_service_instance(minimum_amount_el) where minimum_amount_el is not null</sql>
    </changeSet>


     <changeSet id="#5155_20200928" author="Mbarek-Ay">
        <addColumn tableName="cust_cet">
            <column name="disableable" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="cust_cet">
            <column name="versioned" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5546_20201023" author="AbdelmounaimAkadid" dbms="postgresql">
        <sql>DROP INDEX IF EXISTS agregate_index_category_invoice_agregate</sql>
        <sql>DROP INDEX IF EXISTS billing_user_account_id_index</sql>
        <sql>DROP INDEX IF EXISTS cat_st_serv_mod_id_index</sql>
        <sql>DROP INDEX IF EXISTS ar_credit_category_id_key</sql>
		<sql>DROP INDEX IF EXISTS rated_transaction_number</sql>
		<sql>DROP INDEX IF EXISTS adm_file_type_code_index</sql>
		<sql>DROP INDEX IF EXISTS ord_quote_index_upper_code</sql>
		<sql>DROP INDEX IF EXISTS customer_code</sql>
    </changeSet>

    <changeSet id="#5621_20201104_offer_template_fix" author="NabilOUACHI" failOnError="false">
        <addColumn tableName="billing_subscription">
            <column name="valid_from" type="datetime"/>
            <column name="valid_to" type="datetime"/>
        </addColumn>
        <dropUniqueConstraint tableName="billing_subscription" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9"/>
        <addUniqueConstraint columnNames="code, valid_from, valid_to" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_subscription" />

        <addColumn tableName="cat_offer_template">
            <column name="is_offer_change_restricted" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <createTable tableName="cat_offer_allowed_offer_change">
            <column name="offer_tmpl_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="allowed_offer_change_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="offer_tmpl_id, allowed_offer_change_id" constraintName="cat_offer_allowed_offer_change_pkey" tableName="cat_offer_allowed_offer_change" />
        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="offer_tmpl_id"
                                 constraintName="cat_offer_allowed_offer_change_fk1" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="allowed_offer_change_id"
                                 constraintName="cat_offer_allowed_offer_change_fk2" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#5621_20201104_offer_template" author="NabilOUACHI" failOnError="false">
        <addColumn tableName="billing_subscription">
            <column name="valid_from" type="datetime"/>
            <column name="valid_to" type="datetime"/>
        </addColumn>
        <dropUniqueConstraint tableName="billing_subscription" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9"/>
        <addUniqueConstraint columnNames="code, valid_from, valid_to" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_subscription" />

        <addColumn tableName="cat_offer_template">
            <column name="is_offer_change_restricted" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="offer_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_offer_template" baseColumnNames="offer_template_id"
                                 constraintName="offer_template_offer_template_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#5975_20210225_offer_template_allowed_offer_change_should_be_many_to_many" author="MounirBOUKAYOUA" failOnError="false">
        <dropColumn tableName="cat_offer_template">
            <column name="offer_template_id"></column>
        </dropColumn>

        <createTable tableName="cat_offer_allowed_offer_change">
            <column name="offer_tmpl_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="allowed_offer_change_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>

        <addPrimaryKey columnNames="offer_tmpl_id, allowed_offer_change_id" constraintName="cat_offer_allowed_offer_change_pkey" tableName="cat_offer_allowed_offer_change" />

        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="offer_tmpl_id"
                                 constraintName="cat_offer_allowed_offer_change_fk1" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="allowed_offer_change_id"
                                 constraintName="cat_offer_allowed_offer_change_fk2" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet id="#5599_20201029" author="AndriusKarpavicius">
        <createTable tableName="billing_invoice_agr_amount">
            <column name="aggr_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="tax_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="amountwithouttax" type="numeric(23, 12)" />
            <column name="amounttax" type="numeric(23, 12)" />
            <column name="amountwithtax" type="numeric(23, 12)" />
        </createTable>

    </changeSet>
   <changeSet id="#5416_20120809" author="anasseh">
       <createTable tableName="ar_ao_payment_histories">
           <column name="ao_id" type="bigint"/>
           <column name="history_id" type="bigint"/>
       </createTable>
       <addForeignKeyConstraint
               baseColumnNames="ao_id" baseTableName="ar_ao_payment_histories"
               constraintName="fk_ao_id" deferrable="false" initiallyDeferred="false"
               onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
               referencedTableName="ar_account_operation"/>
       <addForeignKeyConstraint
               baseColumnNames="history_id" baseTableName="ar_ao_payment_histories"
               constraintName="fk_histo_id" deferrable="false"
               initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
               referencedColumnNames="id" referencedTableName="ar_payment_history"/>

        <sql>insert into ${db.schema.adapted}ar_ao_payment_histories (ao_id,history_id)  select id,payment_history_id from ${db.schema.adapted}ar_account_operation where payment_history_id is not null</sql>
	    <dropColumn tableName="ar_account_operation">
            <column name="payment_history_id"></column>
        </dropColumn>
	</changeSet>
    <changeSet id="#5610-2020-11-05 - Dunning workflow" author="NabilOUACHI">
        <addColumn tableName="dunning_document">
            <column name="status" type="varchar(25)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5587_20201021" author="ZBariki">
        <createSequence sequenceName="bi_data_collector_seq" startValue="1" />
        <createTable tableName="bi_data_collector" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="data_collector_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="sql_query" type="text" >
                <constraints nullable="false" />
            </column>
            <column name="custom_table_code" type="varchar(255)" >
                <constraints nullable="false" />
            </column>
            <column name="aliases" type="text" >
                <constraints nullable="false" />
            </column>
            <column name="last_run_date" type="datetime" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_bi_data_collector_code" deferrable="false"
                             disabled="false" initiallyDeferred="false" tableName="bi_data_collector" />
    </changeSet>

    <changeSet author="#5512_20201113" id="AbdelkaderBouazza" failOnError="false">
        <addUniqueConstraint tableName="ar_payment_token" columnNames="customer_account_id, iban" constraintName="customer_account_id_iban_unique"/>
    </changeSet>

    <changeSet id="#5587_20201125" author="ZBariki" failOnError="false">
        <addColumn tableName="bi_data_collector">
            <column name="parameters" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="#5214_20201117" author="ZBariki">
        <createSequence sequenceName="wf_generic_action_seq" startValue="1" />
        <createTable tableName="wf_generic_action" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_generic_action_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="description" type="varchar(255)" />
            <column name="uuid" type="varchar(255)" />
            <column name="priority" type="int4" />
            <column name="condition_el" type="varchar(2000)" />
            <column name="value_el" type="varchar(2000)" />
            <column name="type" type="varchar(255)" />
            <column name="log_level" type="varchar(255)" />
            <column name="field_to_update" type="varchar(255)" />
            <column name="is_asynchronous" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="action_script_id" type="bigint" />
            <column name="notification_id" type="bigint" />
            <column name="transition_id" type="bigint" />
        </createTable>
        <addUniqueConstraint columnNames="uuid" constraintName="uk_wf_generic_action_uuid" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="wf_generic_action" />

        <addForeignKeyConstraint baseColumnNames="transition_id" baseTableName="wf_generic_action" constraintName="fk_wf_generic_action_transition_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="wf_generic_transition" />

        <addForeignKeyConstraint baseColumnNames="notification_id" baseTableName="wf_generic_action"
                                 constraintName="fk_wf_generic_action_notification_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_notification" />

        <addForeignKeyConstraint baseColumnNames="action_script_id" baseTableName="wf_generic_action" constraintName="fk_wf_generic_action_script_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />

    </changeSet>

    <changeSet id="5687_20203011" author="khalidHORRI">
        <addColumn tableName="billing_cycle">
            <column name="compute_dates_validation" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="compute_dates_validation" type="BOOLEAN"/>
        </addColumn>
    </changeSet>
    <changeSet id="5697_20201208" author="khalidHORRI">
        <addColumn tableName="ar_payment_schedule_inst_item">
            <column name="amount" type="numeric(23, 12)"/>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="use_banking_calender" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>

    </changeSet>


    <changeSet id="#5632_20201207_RT_TYPE" author="NabilOUACHI">
        <addColumn tableName="billing_rated_transaction">
            <column name="type" type="VARCHAR(25)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4427_20201202" author="ZBariki">
        <createSequence sequenceName="generic_sequence_seq" startValue="1" />
        <createTable tableName="generic_sequence" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="generic_sequence_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="sequence_type" type="varchar(255)" />
            <column name="sequence_size" type="int" />
            <column name="current_number" type="bigint" />
            <column name="sequence_pattern" type="varchar(255)" />
        </createTable>
        <addColumn tableName="billing_seq_invoice">
            <column name="sequence_type" type="varchar(255)"/>
            <column name="sequence_pattern" type="varchar(255)"/>
        </addColumn>
        <renameColumn tableName="billing_seq_invoice" newColumnName="current_number" oldColumnName="current_invoice_nb"
                      columnDataType="bigint"/>
        <addColumn tableName="adm_custom_generic_entity_code">
            <column name="format_el" type="varchar(2000)"/>
            <column name="sequence_id" type="bigint"/>
        </addColumn>
        <dropColumn columnName="sequence_size" tableName="adm_custom_generic_entity_code" />
        <dropColumn columnName="sequence_current_value" tableName="adm_custom_generic_entity_code" />
        <addForeignKeyConstraint baseColumnNames="sequence_id" baseTableName="adm_custom_generic_entity_code"
                                 constraintName="fk_dm_custom_generic_entity_code_sequence_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="generic_sequence" />
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1, 'order_quote_sequence', 'Order and Quote', 'UUID') </sql>
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type, sequence_size, current_number)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1, 'seller_sequence', 'Seller sequence', 'SEQUENCE', 9, 0)</sql>
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type, sequence_size, current_number)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1,'customer_sequence', 'Customer sequence', 'SEQUENCE', 5, 0) </sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Quote', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'order_quote_sequence'))</sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Order', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'order_quote_sequence'))</sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Seller', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'seller_sequence'))</sql>
        <sql>UPDATE ${db.schema.adapted}adm_custom_generic_entity_code
            SET sequence_id = (select id from ${db.schema.adapted}generic_sequence where code = 'customer_sequence')
            WHERE entity_class = 'Customer'</sql>
    </changeSet>
    <changeSet id="#4427_20201216" author="ZBariki">
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type)
            VALUES (nextval('generic_sequence_seq'),
            ${db.current.time}, 1, 'subscription_sequence', 'subscription', 'SEQUENCE') </sql>
        <sql>UPDATE ${db.schema.adapted}adm_custom_generic_entity_code
            SET sequence_id = (select id from ${db.schema.adapted}generic_sequence where code = 'subscription_sequence')
            WHERE entity_class = 'Subscription'</sql>
    </changeSet>

    <changeSet id="#5627_20210107" author="AndriusKarpavicius">
        <addDefaultValue columnName="skip_validation_script" tableName="billing_billing_run" defaultValueNumeric="0"/>
        <sql>update ${db.schema.adapted}billing_billing_run set skip_validation_script=0 where skip_validation_script is null</sql>
    </changeSet>

    <changeSet id="#5680_20201126" author="khalidHORRI">
        <addColumn tableName="billing_invoice">
            <column name="initial_collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="collection_date_delay_el" type="varchar(2000)"/>
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_invoice set initial_collection_date = due_date;
            update ${db.schema.adapted}ar_account_operation set collection_date = due_date;
        </sql>
    </changeSet>
    <!-- for MediaPost -->

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-seq">
        <createSequence sequenceName="cpq_product_seq" />
        <createSequence sequenceName="cpq_product_line_seq" />
        <createSequence sequenceName="cpq_product_version_seq" />
        <createSequence sequenceName="cpq_tag_seq" />
        <createSequence sequenceName="cpq_tag_filter_seq" />
        <createSequence sequenceName="cpq_tag_type_seq" />
        <createSequence sequenceName="cpq_media_seq" />
        <createSequence sequenceName="cpq_offer_component_seq" />
        <createSequence sequenceName="cpq_commercial_rule_header_seq" />
        <createSequence sequenceName="cpq_commercial_rule_item_seq" />
        <createSequence sequenceName="cpq_commercial_rule_line_seq" />
        <createSequence sequenceName="cpq_grouped_service_seq" />
        <createSequence sequenceName="cpq_product_mapping_seq" />
        <createSequence sequenceName="cpq_accounting_article_seq" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-01">
        <createTable tableName="cpq_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="status" type="varchar(255)" />
            <column name="status_date" type="datetime" />
            <column name="product_line_id" type="bigint" />
            <column name="customer_brand_id" type="bigint" />
            <column name="reference" type="varchar(50)"/>
            <column name="model" type="varchar(20)"/>
            <column name="discount_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="package_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
    </changeSet>




    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-04">
        <createTable tableName="cpq_product_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="long_description" type="text" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
            <column name="parent_line" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-05">
        <createTable tableName="cpq_product_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_version_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="version" type="int4" />
            <column name="status" type="varchar(255)" />
            <column name="status_date" type="datetime" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="short_description" type="varchar(255)" />
            <column name="long_description" type="text" />
            <column name="start_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="product_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="current_version" type="int4" >
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-06">
        <createTable tableName="cpq_tag">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
            <column name="name" type="varchar(255)" />
            <column name="tag_type_id" type="bigint" />
            <column name="parent_tag_id" type="bigint" />
            <column name="filter_el" type="varchar(2000)"/>
            <column name="attribute_id" type="bigint" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-07">
        <createTable tableName="cpq_tag_filter">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_filter_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="tag_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="entity" type="varchar(255)" />
            <column name="field" type="varchar(255)" />
            <column name="comparaison" type="varchar(255)" />
            <column name="value" type="varchar(255)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-08">
        <createTable tableName="cpq_tag_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_type_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-10">
        <createTable tableName="cpq_media">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_media_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="media_name" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="main" type="${type.boolean}" defaultValueNumeric="1">
                <constraints nullable="false" />
            </column>
            <column name="media_type" type="varchar(50)" />
            <column name="media_path" type="varchar(50)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-13">
        <createTable tableName="cpq_offer_component">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_offer_component_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-14">
        <createTable tableName="cpq_commercial_rule_header">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_header_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="rule_type" type="varchar(50)" />
            <column name="offer_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
            <column name="grouped_service_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="target_attribute_value" type="varchar(255)" />
            <column name="tag_id" type="bigint" />
            <column name="rule_el" type="varchar(2000)" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-15">
        <createTable tableName="cpq_commercial_rule_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_item_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="commercial_rule_header_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="rule_item_el" type="varchar(2000)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-16">
        <createTable tableName="cpq_commercial_rule_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_template_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="commercial_rule_item_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="tag_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="source_attribute_value" type="varchar(255)" />
            <column name="source_grouped_attribute_value" type="varchar(255)" />
            <column name="value" type="varchar(255)" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-19">
        <createTable tableName="cpq_offer_component_tags">
            <column name="offer_component_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_offer_component_tags_pkey" tableName="cpq_offer_component_tags" />

        <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="offer_component_id"
                                 constraintName="cpq_offer_component_tags_offer_component_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_component_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-20">
        <createTable tableName="cpq_grouped_service">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_grouped_service_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="product_version_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false" />
            </column>
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false" />
            </column>
            <column name="sequence" type="INT4" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-29">
        <createTable tableName="cpq_product_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_product_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="service1Value" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="product_id" type="bigint" />
            <column name="attribute_1" type="bigint" />
            <column name="attribute_1_value" type="varchar(100)" />
            <column name="attribute_2" type="bigint" />
            <column name="attribute_2_value" type="varchar(100)" />
            <column name="attribute_3" type="bigint" />
            <column name="attribute_3_value" type="varchar(100)" />
            <column name="accounting_article_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />

        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-30">
        <createTable tableName="cpq_accounting_article">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_accounting_article_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-01">
        <addForeignKeyConstraint baseColumnNames="product_line_id" baseTableName="cpq_product" constraintName="fk_1y8p1q0o8tw5u0vcodfukdbez" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
    </changeSet>
    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-02">
        <addForeignKeyConstraint baseColumnNames="customer_brand_id" baseTableName="cpq_product" constraintName="fk_5iap1p3o8tw5u0vcodazokdub" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer_brand" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-03">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_product_line" constraintName="fk_1ykj5q0o8tw5u0vcodpoqljca" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-04">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag_type" constraintName="fk_9axk5q0o8nddo2vcodpoqlopq" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-05">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag" constraintName="fk_oop625q0o8tw5u0vcodospq5c" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-06">
        <addForeignKeyConstraint baseColumnNames="parent_line" baseTableName="cpq_product_line" constraintName="fk_bnrqyk9sqqcnt5m298cpbfrqo3" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-07">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_version" constraintName="fk_pomyp8vq0o8t5u0vcodpoaopq" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-08">
        <addForeignKeyConstraint baseColumnNames="tag_type_id" baseTableName="cpq_tag" constraintName="fk_pomyppo52t5u0vcodpolcm" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag_type" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-09">
        <addForeignKeyConstraint baseColumnNames="parent_tag_id" baseTableName="cpq_tag" constraintName="fk_pomjqq6n5u0vcodkopm" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-10">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovooi1" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-11">
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_media" constraintName="fk_op1zppqjdn5vabcipq5" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-17">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_offer_component" constraintName="fk_sspl5q1jj6jdakklqp" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-19">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_iw510u1o6ndaphf4" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-20">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_ii50ihu1qzsqikh2bo" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-21">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_nh50ihuoo32sqijo5v" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-22">
        <addForeignKeyConstraint baseColumnNames="commercial_rule_item_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_rule_item_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_item" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-23">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_nhi85o6nnipl087" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_commercial_rule_header_rule_item">
        <addForeignKeyConstraint baseColumnNames="commercial_rule_header_id" baseTableName="cpq_commercial_rule_item" constraintName="fk_commercial_rule_header_rule_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_header" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-24">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_ggi871iihn0ii77" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-25">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_omk25ihukik058ijj20" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-26">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_hhokb05o32yhp50" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet id="21112020-540-23-entity-quoteCustomerService" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_lot">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_lot_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="quote_version" type="int4" >
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(50)" />
            <column name="duration" type="int4" />
            <column name="execution_date" type="datetime" />
            <column name="cpq_quote_version_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>




    <changeSet id="21112020-540-23-entity-quoteProduct" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_product_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="quote_version_id" type="bigint" />
            <column name="quote_lot_id" type="bigint" />
            <column name="offer_component_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="product_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="numeric(23, 12)" />
            <column name="cpq_quote_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet id="21112020-540-23-entity-quoteVersion" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_version_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="cpq_quote_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quote_version" type="int4" >
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(20)"  >
                <constraints nullable="false"/>
            </column>
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="billing_plan_code" type="varchar(20)" />
        </createTable>
    </changeSet>


    <changeSet id="22112020-540-23-entity-contract" author="TarikFAKHOURI">
        <createTable tableName="cpq_contract">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="seller_id" type="bigint" />
            <column name="billing_account_id" type="bigint" />
            <column name="customer_account_id" type="bigint" />
            <column name="customer_id" type="bigint" />
            <column name="status" type="varchar(20)" >
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="contract_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="begin_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="end_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="renewal" type="${type.boolean}">
                <constraints nullable="false" />
            </column>
            <column name="contract_duration" type="int4" />
        </createTable>
    </changeSet>


    <changeSet id="22112020-540-23-entity-contract-item" author="TarikFAKHOURI">
        <createTable tableName="cpq_contract_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_item_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="cpq_contract_id" type="bigint" />
            <column name="offer_template_id" type="bigint" />
            <column name="cpq_product_id" type="bigint" />
            <column name="price_plan_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="rate" type="${type.float}" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
        </createTable>
    </changeSet>

    <changeSet id="540-30_20201023_PricePlanMatrixItem" author="TarikF">
        <createTable tableName="cpq_price_plan_matrix_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_item_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="dim1_value" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="dim2_value" type="varchar(50)" />
            <column name="dim3_value" type="varchar(50)" />
            <column name="price_without_tax" type="numeric(23, 12)" />
        </createTable>
    </changeSet>

    <changeSet id="540-31_20201023_PricePlanVersion" author="TarikF">
        <createTable tableName="cpq_price_plan_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_version_pkey" />
            </column>
            <column name="label" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="current_version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="ppm_id" type="bigint" />
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_el" type="varchar(255)" />
            <column name="amount_with_tax_el" type="varchar(255)" />
            <column name="is_matrix" type="${type.boolean}"/>
            <column name="priority" type="int4" defaultValueNumeric="0"/>
        </createTable>
    </changeSet>

    <changeSet id="540-15_20201019_servicetype" author="TarikF">
        <createTable tableName="cpq_service_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_service_type_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="service_type" type="varchar(100)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>



    <changeSet id="current-str-fk-32" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_product" constraintName="fk_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
    </changeSet>

    <changeSet id="current-str-fk-33" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="offer_component_id" baseTableName="cpq_quote_product" constraintName="fk_offer_component_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_offer_component" />
    </changeSet>

    <changeSet id="current-str-fk-34" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_quote_product" constraintName="fk_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="current-str-fk-43" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet id="current-str-fk-44" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
    </changeSet>

    <changeSet id="current-str-fk-45" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />
    </changeSet>

    <changeSet id="current-str-fk-46" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="customer_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer" />
    </changeSet>


    <changeSet id="current-str-fk-47" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="cpq_contract_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />
    </changeSet>
    <changeSet id="current-str-fk-48" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>
    <changeSet id="current-str-fk-49" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="cpq_product_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>
    <changeSet id="current-str-fk-50" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="price_plan_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_price_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>
    <changeSet id="current-str-fk-51" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_charge_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
    </changeSet>
    <changeSet id="current-str-fk-52" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-28">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_service" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-29">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_mapping" constraintName="fk-product-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-30">
        <addForeignKeyConstraint baseColumnNames="attribute_1" baseTableName="cpq_product_mapping" constraintName="fk1-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>
    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-31">
        <addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk2-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-32">
        <addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk3-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-33">
        <addForeignKeyConstraint baseColumnNames="attribute_3" baseTableName="cpq_product_mapping" constraintName="fk4-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-35">
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_mapping" constraintName="fk-charge_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-36">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_tag_filter" constraintName="fk-tag-tag_filter" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-40">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_cpq_tag_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet author="NabilOuachi" id="rebuild-mediapost-fk-41">
        <addForeignKeyConstraint baseColumnNames="ppm_id" baseTableName="cpq_price_plan_version" constraintName="fk_cpq_price_pla_version_price_plan_matrix" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>

    <changeSet id="#5595_20201023" author="Mbarek-Ay">
        <addColumn tableName="cat_service_template">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="product_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="grouped_service_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="service_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="mandatory" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="priority" type="int4" defaultValueNumeric="0" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="param" type="text" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="material" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="accounting_article_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_service_template" constraintName="fk-product-service_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_service_template" constraintName="fk-product-offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="grouped_service_id" baseTableName="cat_service_template" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_service" />


        <addForeignKeyConstraint baseColumnNames="service_type_id" baseTableName="cat_service_template" constraintName="fk-product-service_type" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_service_type" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_service_template" constraintName="fk-product-accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_accounting_article" />


    </changeSet>

    <changeSet id="#5595_#32_20201023" author="Mbarek-Ay">
        <addColumn tableName="cat_charge_template">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="product_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="service_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="price_plan_matrix_id" type="bigint" />
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="recurrence_duration_enum" type="varchar(20)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="duration_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="recurrence_calendar" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="calendar_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="usage_service_template_id" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="surcharge" type="${type.boolean}"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="price_matrix" type="${type.boolean}"/>
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="param1" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param1_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param2" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param2_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param3" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param3_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param4" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param4_service_id" type="bigint"/>
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_service" type="bigint" />
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_service" type="bigint" />
        </addColumn>


        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_charge_template" constraintName="fk-product-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_charge_template" constraintName="fk-offer_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cat_charge_template" constraintName="fk1-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_charge_template" constraintName="fk-price_plan-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />

        <addForeignKeyConstraint baseColumnNames="duration_service" baseTableName="cat_charge_template" constraintName="fk2-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="recurrence_calendar" baseTableName="cat_charge_template" constraintName="fk-cat_calendar-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />


        <addForeignKeyConstraint baseColumnNames="calendar_service" baseTableName="cat_charge_template" constraintName="fk3-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="usage_service_template_id" baseTableName="cat_charge_template" constraintName="fk4-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param1_service_id" baseTableName="cat_charge_template" constraintName="fk5-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk6-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk7-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="param3_service_id" baseTableName="cat_charge_template" constraintName="fk8-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="param4_service_id" baseTableName="cat_charge_template" constraintName="fk9-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim1_matrix_service" baseTableName="cat_charge_template" constraintName="fk10-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim2_matrix_service" baseTableName="cat_charge_template" constraintName="fk11-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim3_matrix_service" baseTableName="cat_charge_template" constraintName="fk12-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet id="#5595_18_20201102" author="Mbarek-Ay">
        <addColumn tableName="cat_offer_template">
            <column name="product_status" type="varchar(50)"/>
            <column name="status_date" type="datetime" />
        </addColumn>
    </changeSet>

    <changeSet id="#5595-36-20201103" author="Mbarek-Ay">
        <addColumn tableName="cpq_tag">
            <column name="product_version_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="service_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_tag" constraintName="fk_product_version_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_tag" constraintName="fk_service_template_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_tag" constraintName="fk_offer_template_version_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet id="#5595_49_20201118" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_version">
            <column name="short_description" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="#43-20201113">
        <createTable tableName="cpq_offer_template_tags">
            <column name="offer_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="offer_template_id"
                                 constraintName="cpq_offer_template_tags_offer_template_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <createTable tableName="cpq_service_template_tags">
            <column name="service_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="service_template_id,tag_id" constraintName="service_template_tag_pkey" tableName="cpq_service_template_tags" />

        <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="service_template_id"
                                 constraintName="cpq_service_template_tags_offer_template_id_fk" referencedTableName="cat_service_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_service_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <createTable tableName="cpq_product_version_tags">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="product_version_id"
                                 constraintName="cpq_product_version_tags_offer_template_id_fk" referencedTableName="cpq_product_version"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_product_version_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <dropColumn tableName="cpq_tag">
            <column name="product_version_id"></column>
            <column name="service_template_id"></column>
            <column name="offer_template_id"></column>
        </dropColumn>

    </changeSet>
    <changeSet id="#5596-20201113" author="Rachid.AIT">
        <createTable tableName="cpq_product_discount_plan">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="discount_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="cpq_product_version_services">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="service_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="cpq_product_model_children">
            <column name="product_id" type="bigint" />
            <column name="model_chlidren" type="varchar(100)" />
        </createTable>
        <addPrimaryKey columnNames="product_id,model_chlidren" constraintName="cpq_product_model_children_pkey" tableName="cpq_product_model_children" />

        <addUniqueConstraint columnNames="product_id,discount_id" constraintName="cpq_product_discount_plan_pkey" tableName="cpq_product_discount_plan" />
        <addUniqueConstraint columnNames="product_version_id,service_template_id" constraintName="cpq_product_services_pkey" tableName="cpq_product_version_services" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

    </changeSet>

    <changeSet id="#5569_54052_20201117" author="TarikFAKHOURI">

        <createSequence sequenceName="cpq_quote_article_line_seq" />

        <createTable tableName="cpq_quote_article_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_article_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="billable_account_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="quantity" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
            <column name="service_quantity" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addColumn tableName="cat_service_template">
            <column name="sequence" type="INT4" />
            <column name="display" type="${type.boolean}" />
        </addColumn>

    </changeSet>


    <changeSet author="Mbarek-Ay" id="#51-20201123">
        <dropColumn tableName="cpq_quote_product">
            <column name="offer_component_id"/>
        </dropColumn>

    </changeSet>

    <changeSet id="#65-20201127" author="TarikFAKHOURI">

        <createSequence sequenceName="quote_offer_seq" />

        <createTable tableName="quote_offer">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_offer_seq" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="offer_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="billable_account_id" type="bigint" />
            <column name="quote_version_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="quote_customer_service_id" type="bigint" />
            <column name="sequence" type="INT4" />
            <column name="contract_code" type="varchar(50)" />
            <column name="position" type="int4" />

        </createTable>

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="quote_offer" constraintName="fk_quote_offer_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="quote_offer" constraintName="fk_quote_offer_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
        <addForeignKeyConstraint baseColumnNames="quote_customer_service_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_customer_service_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />

        <addColumn tableName="cpq_quote_product">
            <column name="offer_quote_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="offer_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_offer_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
    </changeSet>

    <changeSet id="540-66-20201201" author="TarikFA">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_component" constraintName="fk_cpq_offer_component_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet id="540-69-20201202" author="TarikFA">

        <createSequence sequenceName="cpq_attribute_seq" />
        <createSequence sequenceName="cpq_grouped_attributes_seq" />

        <createTable tableName="cpq_attribute">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute" />
            </column>
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="disabled" type="${type.boolean}">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="parent_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="sequence" type="int4" />
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_type" type="varchar(100)" />
            <column name="unit_nb_decimal" type="int4" />
        </createTable>

        <createTable tableName="cpq_grouped_attributes">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_grouped_attributes" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="product_version_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="sequence" type="int4" />
        </createTable>

        <createTable tableName="cpq_attribute_allowed_values">
            <column name="attribute_id" type="bigint" />
            <column name="allowed_values" type="varchar(100)" />
        </createTable>

        <createTable tableName="cpq_product_version_attributes">
            <column name="product_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="cpq_service_template_attributes">
            <column name="service_template_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>




        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_grouped_attributes_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_parent_attributes_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_attributes" constraintName="fk_cpq_grouped_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addPrimaryKey columnNames="attribute_id,allowed_values" constraintName="cpq_attribute_allowed_values_pkey" tableName="cpq_attribute_allowed_values" />
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_allowed_values" constraintName="fk_cpq_attribute_allowed_values_attribute_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />


        <addPrimaryKey columnNames="service_template_id,attribute_id" constraintName="cpq_service_template_attributes_pkey" tableName="cpq_service_template_attributes" />
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_serviceTemplate_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

    </changeSet>

    <changeSet id="540-75-20201203" author="TarikFA">

        <createSequence sequenceName="cpq_quote_seq" />

        <createTable tableName="cpq_quote">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" />
            <column name="contract_id" type="bigint" />
            <column name="status_version" type="int4" />
            <column name="status" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime" />
            <column name="send_date" type="datetime" />
            <column name="quote_date" type="datetime" />
            <column name="prestation_date_begin" type="datetime" />
            <column name="prestation_duration" type="int4" />
            <column name="opportunity_ref" type="varchar(50)" />
            <column name="customer_ref" type="varchar(50)" />
            <column name="customer_name" type="varchar(52)" />
            <column name="contact_name" type="varchar(52)" />
            <column name="register_number" type="varchar(50)" />
            <column name="sales_person_name" type="varchar(52)" />
            <column name="billable_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="applicant_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="quote_number" type="varchar(50)" />
            <column name="invoice_type_id" type="bigint" />
            <column name="pdf_filename" type="varchar(255)" />
            <column name="xml_filename" type="varchar(255)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="applicant_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_applicant_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_product" constraintName="fk_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_version_id" baseTableName="cpq_quote_lot" constraintName="fk_cpq_quote_lot_cpq_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />

    </changeSet>

    <changeSet id="#5569_124_20200118" author="NabilOUACHI">


        <createSequence sequenceName="cpq_quote_price_seq" startValue="1" />
        <createTable tableName="cpq_quote_price">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_price" />
            </column>
            <!-- Auditable Start -->
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="quote_article_line_id" type="bigint" />
            <column name="quote_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="price_level" type="varchar(50)" />
            <column name="price_type" type="varchar(50)" />

            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="unit_price_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
            <column name="tax_amount" type="numeric(23, 12)" />
            <column name="tax_rate" type="numeric(23, 12)" />

            <column name="price_over_charged" type="${type.boolean}" />


            <column name="currency_code" type="varchar(25)" />

            <column name="recurrence_duration" type="int8" />


            <column name="recurrence_periodicity" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="quote_article_line_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_article_Line" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_article_line" />
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_version" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />


    </changeSet>

    <changeSet id="current-str-fk-35" author="TarikFAKHOURI">


        <createSequence sequenceName="cpq_quote_attribute_seq" />

        <createTable tableName="cpq_quote_attribute">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote_attribute" />
            </column>
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="cpq_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="cpq_quote_product_id" type="bigint" />
            <column name="string_value" type="varchar(255)" />
            <column name="double_value" type="${type.float}" />
            <column name="date_value" type="datetime" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_product_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="540-84-20201209" author="TarikFa">
        <!-- 	    	<addUniqueConstraint columnNames="cpq_attribute_id,cpq_quote_product_id" tableName="cpq_quote_attribute" constraintName="uniquekey_attribute_quote_product_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <!-- 	    	<addUniqueConstraint columnNames="offer_template_id,quote_version_id" tableName="quote_offer" constraintName="uniquekey_offer_template_quote_version_id_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <!-- 	    	<addUniqueConstraint columnNames="product_version_id,offer_quote_id" tableName="cpq_quote_product" constraintName="uniquekey_product_version_offer_quote_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <addUniqueConstraint columnNames="cpq_quote_id,quote_version" tableName="cpq_quote_version" constraintName="uniquekey_pquote_id_cpq_quote_id,quote_version" deferrable="false" initiallyDeferred="false" disabled="false"/>

    </changeSet>

    <changeSet id="540-83-20201211" author="Mbarek-Ay">
        <createTable
                tableName="cpq_product_version_grouped_attributes">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="grouped_attributes_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey
                columnNames="product_version_id,grouped_attributes_id"
                constraintName="cpq_product_version_grouped_attributes_pkey"
                tableName="cpq_product_version_grouped_attributes" />
        <addForeignKeyConstraint
                baseColumnNames="grouped_attributes_id"
                baseTableName="cpq_product_version_grouped_attributes"
                constraintName="cpq_product_version_grouped__attribute_id"
                deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                onUpdate="NO ACTION" referencedColumnNames="id"
                referencedTableName="cpq_grouped_attributes" />

        <addForeignKeyConstraint
                baseColumnNames="product_version_id"
                baseTableName="cpq_product_version_grouped_attributes"
                constraintName="cpq_product_version_grouped_attributes_product_version_id"
                deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                onUpdate="NO ACTION" referencedColumnNames="id"
                referencedTableName="cpq_product_version" />

        <addColumn tableName="cpq_product_version">
            <column name="valid_from" type="datetime"></column>
            <column name="valid_to" type="datetime"></column>
        </addColumn>
    </changeSet>
    <!-- end MediaPost -->
    <changeSet id = "#FEAT-761-2020-10-19" author = "ZBariki">
        <createSequence sequenceName="billing_accounting_article_seq" startValue="1" />
        <createTable tableName="billing_accounting_article" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name ="analytic_code_1" type="varchar(255)"></column>
            <column name ="analytic_code_2" type="varchar(255)"></column>
            <column name ="analytic_code_3" type="varchar(255)"></column>
            <column name="tax_class_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_sub_category_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_id" type="bigint"/>
            <column name="accounting_code_id" type="bigint" />
            <column name="description_i18n" type="${type.json}"></column>

            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>

        <createSequence sequenceName="billing_article_family_seq" startValue="1" />
        <createTable tableName="billing_article_family" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_family_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)" />
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="accounting_code_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_ref_id" type="bigint" />
            <column name="cf_values" type="${type.json}"/>
            <column name="cf_values_accum" type="${type.json}"/>
            <column name="description_i18n" type="${type.json}"></column>
        </createTable>

        <createSequence sequenceName="billing_article_mapping_seq" startValue="1" />
        <createTable tableName="billing_article_mapping" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mapping_script_id" type="bigint" />
        </createTable>

        <createSequence sequenceName="billing_article_mapping_line_seq" startValue="1" />
        <createTable tableName="billing_article_mapping_line">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_line_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="code" type="varchar(50)" />
            <column name="description" type="varchar(255)" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>
            <column name="article_mapping_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="offer_template_id" type="bigint"></column>
            <column name="charge_template_id" type="bigint"></column>
            <column name="product_id" type="bigint"></column>

            <column name="parameter_1" type="varchar(255)"/>
            <column name="parameter_2" type="varchar(255)"/>
            <column name="parameter_3" type="varchar(255)"/>
            <column name="mapping_key_el" type="varchar(255)"/>
        </createTable>

        <createSequence sequenceName="billing_attribute_mapping_seq" startValue="1" />
        <createTable tableName="billing_attribute_mapping">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_attribute_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>

            <column name="article_mapping_line_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="attribute" type="varchar(30)"/>
            <column name="attribute_value" type="varchar(255)"/>
        </createTable>


        <addColumn tableName="billing_rated_transaction">
            <column name="article_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_tax_class" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax_class" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_invoice_sub_category" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="article_family_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_article_family" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="article_family_ref_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_article_family_ref" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />

        <addForeignKeyConstraint baseColumnNames="mapping_script_id" baseTableName="billing_article_mapping"
                                 constraintName="fk_billing_article_mapping_mapping_script" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />

        <addForeignKeyConstraint baseColumnNames="article_mapping_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article_mapping" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_mapping" />

        <addForeignKeyConstraint baseColumnNames="article_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_charge_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_charge_template" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_service_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_product_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="article_id"
                                 constraintName="rated_transaction_article_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="article_mapping_line_id"
                                 constraintName="attribute_mapping_article_mapping_line_fk" referencedTableName="billing_article_mapping_line"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="attribute_id"
                                 constraintName="attribute_mapping_attribute_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-">
        <createTable tableName="cpq_billing_account_tags">
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_billing_account_tags_pkey" tableName="cpq_offer_component_tags" />
        <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="billing_account_id"
                                 constraintName="cpq_billing_account_tags_billing_account_id_fk" referencedTableName="billing_billing_account"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_billing_account_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="current-mediapost-tbl-charge_attribute">
        <createTable tableName="cpq_attribute_charge">
            <column name="charge_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="attribute_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="charge_id,attribute_id" constraintName="cpq_attribute_charge_pkey" tableName="cpq_attribute_charge" />
        <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="charge_id"
                                 constraintName="cpq_attribute_charge_charge_id_fk" referencedTableName="cat_charge_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="attribute_id"
                                 constraintName="cpq_attribute_charge_attribute_id_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet id="#REF_INV_20201223" author="MohammedELAZZOUZI">
        <addColumn tableName="cat_discount_plan_item">
            <column name="accounting_article_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_discount_plan_item" constraintName="fk__cat_discount_plan_item__accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addColumn tableName="cat_discount_plan_item">
            <column name="priorty" type="bigint"></column>
        </addColumn>

        <addColumn tableName="quote_offer">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="quote_offer" constraintName="fk__quote_offer__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote" constraintName="fk__ord_quote__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote_product">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_product" constraintName="fk__cpq_quote_product__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-27">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovoo51" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-41">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_attribute_trade_rule_header" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-39">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_attribute_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_grouped_attributes_commercial_rule_line">
        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_grouped_attributes_commercial_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
    </changeSet>

    <changeSet id="540-103-add-swagger-docs-to-All-ChargeTemplates" author="TarikFA.">
        <createTable tableName="cpq_offer_attributes">
            <column name="offer_template_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
        </createTable>

        <addPrimaryKey columnNames="offer_template_id,attribute_id," tableName="cpq_offer_attributes"/>

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>


    <changeSet id="#540-100-20201225" author="TarikFA">

        <createSequence sequenceName="cpq_commercial_order_seq" />
        <createSequence sequenceName="cpq_order_type_seq" />
        <createSequence sequenceName="cpq_order_item_seq" />
        <createSequence sequenceName="cpq_order_product_seq" />
        <createSequence sequenceName="cpq_order_lot_seq" />
        <createSequence sequenceName="cpq_order_offer_seq" />
        <createSequence sequenceName="order_article_line_seq" />
        <createSequence sequenceName="cpq_order_invoice_seq" />
        <createSequence sequenceName="cpq_invoice_line_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_item_seq" />

        <createTable tableName="cpq_commercial_order">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_commercial_order" />
            </column>
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_number" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="billing_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="cpq_quote_id" type="bigint" />
            <column name="contract_id" type="bigint" />
            <column name="status" type="varchar(50)" >
                <constraints nullable="false"/>
            </column>
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="order_progress" type="int" >
                <constraints nullable="false"/>
            </column>
            <column name="progress_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="order_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="realisation_date" type="datetime" />
            <column name="customer_service_begin" type="datetime" />
            <column name="customer_service_duration" type="int" />
            <column name="external_reference" type="varchar(50)" />
            <column name="order_parent_id" type="bigint" />
            <column name="order_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoicing_plan_id" type="bigint" />
            <column name="invoice_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="user_account_id" type="bigint" />
            <column name="access_id" type="bigint" />
        </createTable>

        <createTable tableName="cpq_commercial_order_billing_invoice">
            <column name="commercial_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="commercial_order_id,invoice_id" tableName="cpq_commercial_order_billing_invoice"/>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />


        <createTable tableName="cpq_invoicing_plan">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
        </createTable>
        <createTable tableName="cpq_order_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_type" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
        </createTable>


        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

        <addForeignKeyConstraint baseColumnNames="order_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_type" />

        <addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoicing_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

        <addForeignKeyConstraint baseColumnNames="order_parent_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_parent_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


        <createTable tableName="cpq_order_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_item" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->


            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_lot_id" type="bigint" />
            <column name="order_product_id" type="bigint" />
            <column name="access_point" type="varchar(20)" />
            <column name="attribute_id" type="bigint" />

            <column name="string_value" type="varchar(255)" />
            <column name="date_value" type="datetime" />
            <column name="double_value" type="${type.float}" />

        </createTable>

        <createTable tableName="cpq_order_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_product" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_service_commercial_id" type="bigint" />
            <column name="order_offer_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="product_version_id" type="bigint" />
            <column name="quantity" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="cpq_order_lot">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_lot" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_lot_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_service_commercial_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="order_product_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_product" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <createTable tableName="cpq_order_offer">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_offer" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="offer_template_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <!-- foreign key for Order Product  Start -->

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_service_commercial_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_service_commercial_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_offer_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <!-- foreign key for Order Product  End -->

        <!--  Creation table order_article_Line (OrderArticleLine) -->
        <createTable tableName="order_article_line">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_article_line" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_customer_service_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="numeric(23, 12)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_service" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="os_unit_price_without_tax" type="numeric(23, 12)" />
            <column name="os_price_without_tax" type="numeric(23, 12)" />
            <column name="os_tax_code" type="numeric(23, 12)" />
            <column name="os_tax_rate" type="int" />
            <column name="os_price_with_tax" type="numeric(23, 12)" />
            <column name="rc_unit_price_without_tax" type="numeric(23, 12)" />
            <column name="rc_price_without_tax" type="numeric(23, 12)" />
            <column name="rc_tax_code" type="numeric(23, 12)" />
            <column name="rc_tax_rate" type="int" />
            <column name="rc_price_with_tax" type="numeric(23, 12)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_customer_service_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_customer_service_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_accounting_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <createSequence sequenceName="order_price_seq" startValue="1" />
        <createTable tableName="order_price">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_price" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_article_line_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="price_level" type="varchar(50)" />
            <column name="price_type" type="varchar(50)" />

            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="unit_price_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
            <column name="tax_amount" type="numeric(23, 12)" />
            <column name="tax_rate" type="numeric(23, 12)" />

            <column name="price_over_charged" type="${type.boolean}" />


            <column name="currency_code" type="varchar(25)" />

            <column name="recurrence_duration" type="int8" />


            <column name="recurrence_periodicity" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_article_line_id" baseTableName="order_price" constraintName="fk_order_price_order_article_Line" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_article_line" />
        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_price" constraintName="fk_order_price_order_commercial_order" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <createTable tableName="cpq_order_invoice">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_invoice" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="billing_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_ref" type="varchar(20)" />
            <column name="status" type="varchar(20)" />
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="due_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="begin_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="amount_without_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_with_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="payment_method_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="pdf_link" type="varchar(255)" />
            <column name="commercial_order_id" type="bigint" />
        </createTable>

        <createTable tableName="cpq_order_invoice_access_point_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="access_point_list" type="varchar(100)" />
        </createTable>

        <createTable tableName="cpq_order_invoice_order_ref_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="order_ref_list" type="varchar(100)" />
        </createTable>

        <addPrimaryKey columnNames="order_invoice_id,access_point_list" constraintName="cpq_order_invoice_access_point_list_pkey" tableName="cpq_order_invoice_access_point_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_access_point_list" constraintName="fk_cpq_order_invoice_access_point_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />


        <addPrimaryKey columnNames="order_invoice_id,order_ref_list" constraintName="cpq_order_invoice_order_ref_list_pkey" tableName="cpq_order_invoice_order_ref_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_order_ref_list" constraintName="fk_cpq_order_invoice_order_ref_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_payment_method_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <createTable tableName="cpq_invoice_line">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoice_line" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="invoice_id" type="bigint" />
            <column name="prestation" type="varchar(255)" />
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="offer_service_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="begin_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="quantity" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="discount_rate" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="amount_without_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="tax_rate" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_with_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_tax" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="discount_plan_id" type="bigint"  />
            <column name="tax_id" type="bigint"  />
            <column name="order_ref" type="varchar(20)"  />
            <column name="access_point" type="varchar(20)"  />
            <column name="commercial_order_id" type="bigint"  />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="offer_service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_offer_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_serv_templates" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_tax_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <createTable tableName="cpq_invoicing_plan_item">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan_item" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="billing_plan_id" type="bigint" >
                <constraints nullable="false" />
            </column>

            <column name="advancement" type ="int4">
                <constraints nullable="false" />
            </column>
            <column name="rate_to_bill" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
        </createTable>


        <addForeignKeyConstraint baseColumnNames="billing_plan_id" baseTableName="cpq_invoicing_plan_item" constraintName="fk_cpq_invoicing_plan_item_billing_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

        <addColumn tableName="billing_subscription">
            <column name="commercial_order_id" type="bigint" />
            <column name="prestation" type="varchar(255)" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


        <addColumn tableName="billing_wallet_operation">
            <column name="order_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" />
            <column name="order_lot_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
        </addColumn>


        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addColumn tableName="billing_rated_transaction">
            <column name="order_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" />
            <column name="order_lot_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
        </addColumn>



        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

    </changeSet>

    <changeSet id="20201230_pricematrix" author="NabilOuachi">
        <createSequence sequenceName="cpq_price_plan_matrix_column_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_column">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_column_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="ppm_version_id" type="bigint" />
            <column name="position" type ="int4"/>
            <column name="type" type="varchar(255)"/>

            <column name="el_value" type="varchar(255)"/>

            <column name="product_id" type="bigint" />
            <column name="offer_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="is_range" type="${type.boolean}" defaultValueNumeric="0"/>
        </createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_value_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_value">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_value_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="ppm_column_id" type="bigint" />

            <column name="ppml_id" type="bigint" />

            <column name="long_value" type ="int8"/>
            <column name="double_value" type ="${type.float}"/>
            <column name="string_value" type="varchar(255)"/>

            <column name="date_value" type="datetime"/>
            <column name="from_date_value" type="datetime"/>
            <column name="to_date_value" type="datetime"/>

            <column name="from_double_value" type ="${type.float}"/>
            <column name="to_double_value" type ="${type.float}"/>

        </createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_line_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_price_plan_matrix_line" />
            </column>
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="version" type="int4" />

            <column name="ppm_version_id" type="bigint" />
            <column name="priority" type="int4" defaultValueNumeric="0"/>

            <column name="description" type="varchar(255)"/>
            <column name="price_without_tax" type="numeric(23, 12)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_ppm_version" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_attribute" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="ppm_column_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_column" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_column" />

        <addForeignKeyConstraint baseColumnNames="ppml_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_line" />

        <addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_line" constraintName="fk_price_plan_matrix_line_price_plan_matrix_version" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

    </changeSet>

    <changeSet id="20201230-ticket5870" author="NabilOUACHI">
        <createSequence sequenceName="cpq_product_charge_template_mapping_seq" startValue="1" />

        <createTable tableName="cat_product_wallet_template_1">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="wallet_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, wallet_template_id" constraintName="cat_product_wallet_template_1_pkey" tableName="cat_product_wallet_template_1" />

        <createTable tableName="cat_product_counter_template">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, counter_template_id" constraintName="cat_product_counter_template_pkey" tableName="cat_product_counter_template" />

        <createTable tableName="cpq_product_charge_template_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_charge_template_mapping_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="product_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="counter_template_id" type="bigint" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_product" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_counter" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="wallet_template_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_wallet_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_wallet_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_cat_counter_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />
    </changeSet>

    <changeSet id="540-112-20210107" author="TarikF">
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>
    <changeSet id="20210113" author="TarikF">

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />


        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_product_mapping" constraintName="fk-accounting_article-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-attribute_tag">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_tag" constraintName="fk_tag_attribute" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet id="540-139-20012020" author="NabilOUACHI">


        <createSequence sequenceName="cpq_attribute_instance_seq" />

        <createTable tableName="cpq_attribute_instance">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute_instance" />
            </column>
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="cpq_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="service_instance_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="subscription_id" type="bigint" >
                <constraints nullable="false"/>
            </column>

            <column name="string_value" type="varchar(255)" />
            <column name="double_value" type="${type.float}" />
            <column name="date_value" type="datetime" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_service_instance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />

        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_subscription_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
    </changeSet>
    <changeSet id="#20210121-540-128" author="TarikFA">

        <addColumn tableName="cpq_quote_article_line">
            <column name="quote_product_id" type="bigint" />
            <column name="quote_lot_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
        <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
    </changeSet>
    <changeSet id="#20210122-540-128" author="TarikFA">

        <addColumn tableName="billing_service_instance">
            <column name="product_version_id" type="bigint" />
            <column name="quote_product_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
        <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_product_serviceInstance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="#20210127-540-190" author="TarikFA">
        <addForeignKeyConstraint baseColumnNames="access_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_access_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="medina_access" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>

    <changeSet id="Invoice_lines_job_20200114" author="ZBariki">
        <addColumn tableName="cpq_invoice_line">
            <column name="billing_run_id" type="bigint"/>
            <column name="billing_account_id" type="bigint"/>
            <column name="label" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="raw_amount" type="numeric">
                <constraints nullable="false"/>
            </column>
            <column name="value_date" type="datetime" />
            <column name="order_number" type="varchar(255)" />
            <column name="discount_amount" type="numeric">
                <constraints nullable="false"/>
            </column>
            <column name="subscription_id" type="bigint"/>
            <column name="service_instance_id" type="bigint"/>
            <column name="offer_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_run_id"
                                 constraintName="billing_invoice_line_billing_run_id_fk"
                                 referencedTableName="billing_billing_run" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_account_id"
                                 constraintName="billing_billing_account_id_fk"
                                 referencedTableName="billing_billing_account" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="service_instance_id"
                                 constraintName="billing_service_instance_id_fk"
                                 referencedTableName="billing_service_instance" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="subscription_id"
                                 constraintName="billing_subscription_id_fk"
                                 referencedTableName="billing_subscription" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="offer_template_id"
                                 constraintName="billing_offer_template_id_fk"
                                 referencedTableName="cat_offer_template" referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="#5916_20210128" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_invoice_line">
            <column name="order_lot_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="order_lot_id"
                                 constraintName="cpq_invoice_line__order_lot__fk"
                                 referencedTableName="cpq_order_lot" referencedColumnNames="id"/>
        <addColumn tableName="cpq_invoice_line">
            <column name="product_version_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="product_version_id"
                                 constraintName="cpq_invoice_line__product_version__fk"
                                 referencedTableName="cpq_product_version" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#5937_20210204" author="TarikFA">
        <addColumn tableName="cat_charge_template">
            <column name="attribute_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_id"
                                 constraintName="fk_cat_charge_template_attribute_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#214_20210203" author="NabilOUACHI">
        <addColumn tableName="cpq_quote_price">
            <column name="charge_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_quote_price" baseColumnNames="charge_template_id"
                                 constraintName="fk_cpq_quote_price_charge_template_id"
                                 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
        <addColumn tableName="order_price">
            <column name="charge_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="order_price" baseColumnNames="charge_template_id"
                                 constraintName="fk_order_price_charge_template_id"
                                 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
        <addColumn tableName="order_article_line">
            <column name="order_product_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="order_article_line" baseColumnNames="order_product_id"
                                 constraintName="fk_order_article_line_order_product_id"
                                 referencedTableName="cpq_order_product" referencedColumnNames="id"/>

        <addColumn tableName="cpq_commercial_order">
            <column name="rate_invoiced" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>
            <![CDATA[
				alter table cpq_invoice_line alter column invoice_id drop not null;
				alter table cpq_quote_price alter column quote_article_line_id drop not null;
				alter table cpq_order_item drop column code;
				alter table cpq_order_item drop column description;
				alter table cpq_order_item rename column attribute_id to cpq_attribute_id;
			]]>
        </sql>
    </changeSet>

    <changeSet id="20210204_540" author="TarikFA">
        <addColumn tableName="cat_charge_template">
            <column name="attribute_duration_id" type="bigint"/>
            <column name="attribute_calendar_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_duration_id"
                                 constraintName="fk_cat_charge_templat_attribute_duration_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_calendar_id"
                                 constraintName="fk_cat_charge_template_attribute_calendar_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>

    </changeSet>
    <changeSet id="Invoice_lines_job_202001145" author="ZBariki">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="fk_cpq_invoice_line_invoice_id"/>
        </preConditions>
        <dropForeignKeyConstraint baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id"/>
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line"
                                 constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>
    <changeSet id="Invoicing_job_20210205_45" author="ZBariki">
        <addColumn tableName="cpq_invoice_line">
            <column name="status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="invoice_line_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoice_line_id" baseTableName="billing_rated_transaction"
                                 constraintName="fk_billing_rated_transaction_invoice_line_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
    </changeSet>
    <changeSet id="#20210205_540_223" author="TarikFA">
        <modifyDataType tableName="cpq_media" columnName="media_path" newDataType="varchar(255)"/>
        <modifyDataType tableName="cpq_media" columnName="media_name" newDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="#5938_20210205" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_invoice">
            <column name="new_invoicing_process" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#20210209_540177" author="TarikFA">
        <addColumn tableName="cpq_product">
            <column name="product_version_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product"
                                 constraintName="fk_cpq_product_product_version_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="#20210215-248" author="NabilOUACHI">
        <addColumn tableName="cpq_attribute_instance">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_quote_attribute">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_order_item">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute_instance"
                                 constraintName="fk_cpq_attribute_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_attribute_instance" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_quote_attribute"
                                 constraintName="fk_cpq_quote_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_quote_attribute" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_order_item"
                                 constraintName="fk_cpq_order_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_order_item" />

    </changeSet>

    <changeSet id="#20210212_540238" author="TarikFA">
        <addUniqueConstraint columnNames="code,ppm_version_id" tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
    </changeSet>

    <changeSet id="#5950_20210210" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_billing_run">
            <column name="minimum_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="threshold_checked" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="discount_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>


    <changeSet id="#246_20210212" author="Mbarek-Ay">
        <addColumn tableName="cpq_invoicing_plan">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_commercial_order">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_product_line">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote_lot">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_order_lot">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_contract_item">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_contract">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_grouped_attributes">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_invoicing_plan_item">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="quote_offer">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote_product">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>


        <addColumn tableName="cpq_order_product">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>


        <addColumn tableName="cpq_order_offer">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_media">
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
    </changeSet>

    <changeSet id="#248_20210215" author="NabilOuachi">
        <sql>
            <![CDATA[
					alter table cpq_order_offer drop column code;
					alter table cpq_order_offer drop column description;
					alter table cpq_order_product drop column code;
					alter table cpq_order_product drop column description;
					alter table cpq_order_item alter column order_id drop not null;
					alter table cpq_attribute_instance alter column service_instance_id drop not null;
					alter table cpq_attribute_instance alter column subscription_id drop not null;
				]]>
        </sql>
    </changeSet>

    <changeSet id="#20200215-247" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_attribute">
            <column name="cpq_quote_offer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="#20210217_260" author="TarikFA">
        <dropTable tableName="cpq_product_mapping"/>
    </changeSet>

    <changeSet id="#5952_20210210" author="ZBariki">
        <addColumn tableName="crm_customer">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_user_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="crm_customer"
                                 constraintName="fk_crm_customer_iminimum_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="ar_customer_account"
                                 constraintName="fk_ar_customer_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_billing_account"
                                 constraintName="fk_billing_billing_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_user_account"
                                 constraintName="fk_billing_user_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_subscription"
                                 constraintName="fk_billing_subscription_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_service_instance"
                                 constraintName="fk_billing_service_instance_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="cat_offer_template"
                                 constraintName="fk_cat_offer_template_minimum_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
    </changeSet>

    <changeSet id="#268_20210219_cpq_structure" author="Mbarek-Ay">
        <dropNotNullConstraint columnName="tax_class_id" tableName="cat_charge_template"/>
    </changeSet>


    <changeSet id="#222_20210219" author="Mbarek-Ay">
        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-26, 0, 0, ${db.current.time}, 'org.meveo.api.billing.QuoteValidation', 'QuoteValidation', 'JAVA', '
package org.meveo.api.billing;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.meveo.admin.exception.BusinessException;
import org.meveo.model.billing.BillingAccount;
import org.meveo.model.cpq.CpqQuote;
import org.meveo.model.cpq.QuoteAttribute;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.CommercialOrderEnum;
import org.meveo.model.cpq.commercial.OrderArticleLine;
import org.meveo.model.cpq.commercial.OrderAttribute;
import org.meveo.model.cpq.commercial.OrderLot;
import org.meveo.model.cpq.commercial.OrderOffer;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.model.cpq.commercial.OrderType;
import org.meveo.model.cpq.offer.QuoteOffer;
import org.meveo.model.quote.QuoteArticleLine;
import org.meveo.model.quote.QuoteLot;
import org.meveo.model.quote.QuoteProduct;
import org.meveo.model.quote.QuoteVersion;
import org.meveo.security.CurrentUser;
import org.meveo.security.MeveoUser;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.cpq.QuoteVersionService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderArticleLineService;
import org.meveo.service.cpq.order.OrderAttributeService;
import org.meveo.service.cpq.order.OrderLotService;
import org.meveo.service.cpq.order.OrderOfferService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.cpq.order.OrderProductService;
import org.meveo.service.cpq.order.OrderTypeService;
import org.meveo.service.cpq.order.QuotePriceService;
import org.meveo.service.crm.impl.CurrentUserProducer;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class QuoteValidation extends ModuleScript {

	private final static Logger LOGGER = LoggerFactory.getLogger(QuoteVersionService.class);

	private QuoteVersionService quoteVersionService = (QuoteVersionService) getServiceInterface(QuoteVersionService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private OrderOfferService orderOfferService = (OrderOfferService) getServiceInterface(OrderOfferService.class.getSimpleName());
    private OrderProductService orderProductService = (OrderProductService) getServiceInterface(OrderProductService.class.getSimpleName());
    private OrderAttributeService orderAttributeService = (OrderAttributeService) getServiceInterface(OrderAttributeService.class.getSimpleName());
    private OrderLotService orderCustomerServiceService = (OrderLotService) getServiceInterface(OrderLotService.class.getSimpleName());
    private OrderArticleLineService orderArticleLineService = (OrderArticleLineService) getServiceInterface(OrderArticleLineService.class.getSimpleName());
    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private QuotePriceService quotePriceService = (QuotePriceService) getServiceInterface(QuotePriceService.class.getSimpleName());
    private OrderTypeService orderTypeService = (OrderTypeService) getServiceInterface(OrderTypeService.class.getSimpleName());
    private MeveoUser currentUser = ((CurrentUserProducer) getServiceInterface(CurrentUserProducer.class.getSimpleName())).getCurrentUser();


	@Override
	public void execute(Map<String, Object> methodContext) throws BusinessException {
		final CpqQuote cpqQuote = (CpqQuote) methodContext.get("cpqQuote");
		if(cpqQuote == null)
			throw new BusinessException("No Quote found");
		LOGGER.info("start creation order from quote code {}", cpqQuote.getCode());
		var quotesVersions = quoteVersionService.findByQuoteIdAndStatusActive(cpqQuote.getId());
		if(quotesVersions.size() > 1)
			throw new BusinessException("More than one quote version is published !!");
		var quoteVersion = quotesVersions.get(0);
		var orderByBillingAccount = new Hashtable<String, List<QuoteOffer>>();
		var billingAccount = new Hashtable<String, BillingAccount>();
		quoteVersion.getQuoteOffers().forEach(quoteOffer -> {
			if(quoteOffer.getBillableAccount() == null) {
				quoteOffer.setBillableAccount(cpqQuote.getBillableAccount());
			}
			List<QuoteOffer> offers = new ArrayList<>();
			if(orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode()) != null) {
				offers = orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode());
			}
			offers.add(quoteOffer);
			orderByBillingAccount.put(quoteOffer.getBillableAccount().getCode(), offers);
			billingAccount.put(quoteOffer.getBillableAccount().getCode(), quoteOffer.getBillableAccount());

		});
		orderByBillingAccount.keySet().forEach(ba -> {
			List<QuoteOffer> offers = orderByBillingAccount.get(ba);
			BillingAccount billableAccount = billingAccount.get(ba);
			CommercialOrder order = processCommercialOrder(cpqQuote, quoteVersion, billableAccount);
			offers.forEach(offer -> {
				processOrderOffer(offer, order);
				OrderLot orderLot = processOrderCustomerService(offer.getQuoteLot(), order);
				OrderOffer orderOffer = processOrderOffer(offer, order);
				offer.getQuoteProduct().forEach(quoteProduct -> {
					processOrderProduct(quoteProduct, order, orderLot, orderOffer);
				});
			});
		});
		LOGGER.info("End creation order from quote code {}, number of order created is {}", cpqQuote.getCode(), orderByBillingAccount.size());


	}
	private CommercialOrder processCommercialOrder(CpqQuote cpqQuote, QuoteVersion quoteVersion, BillingAccount account) {
		CommercialOrder order = new CommercialOrder();
		order.setSeller(cpqQuote.getSeller());
		order.setBillingAccount(account);
		order.setQuote(cpqQuote);
		order.setContract(cpqQuote.getContract());
		order.setCustomerServiceBegin(quoteVersion.getStartDate());
		order.setStatus(CommercialOrderEnum.DRAFT.toString());
		Date now = Calendar.getInstance().getTime();
		order.setStatusDate(now);
		order.setOrderDate(now);
		order.setCustomerServiceDuration(cpqQuote.getQuoteLotDuration());
		order.setExternalReference(null);
		order.setInvoicingPlan(quoteVersion.getInvoicingPlan());
		order.setOrderType(createOrderTypeTemp()); //TODO: how to map order type
		order.setOrderProgress(0);
		order.setOrderInvoiceType(invoiceTypeService.getDefaultCommercialOrder());
		order.setProgressDate(Calendar.getInstance().getTime());
		order.setUserAccount(account.getUsersAccounts().size() > 0 ? account.getUsersAccounts().get(0) : null);
		order.setDiscountPlan(cpqQuote.getDiscountPlan());
		commercialOrderService.create(order);
		return order;
	}

	private OrderType createOrderTypeTemp() {
		final String TEMP_CODE = "COMMERCIAL";
		OrderType orderType = orderTypeService.findByCode(TEMP_CODE);
		if(orderType == null) {
			orderType = new OrderType();
			orderType.setCode(TEMP_CODE);
			orderType.setDescription("generated on quote validation  script");
			orderTypeService.create(orderType);
		}
		return orderType;
	}

	private OrderOffer processOrderOffer(QuoteOffer quoteOffer, CommercialOrder order) {
		OrderOffer offer = new OrderOffer();
		offer.setOrder(order);
		offer.setOfferTemplate(quoteOffer.getOfferTemplate());
		offer.setDiscountPlan(quoteOffer.getDiscountPlan());
		orderOfferService.create(offer);
		return offer;
	}

	private OrderProduct processOrderProduct(QuoteProduct product, CommercialOrder commercialOrder, OrderLot orderLot, OrderOffer orderOffer) {
		OrderProduct orderProduct = new OrderProduct();
		orderProduct.setOrder(commercialOrder);
		orderProduct.setOrderServiceCommercial(orderLot);
		orderProduct.setProductVersion(product.getProductVersion());
		orderProduct.setQuantity(product.getQuantity());
		orderProduct.setDiscountPlan(product.getDiscountPlan());
		orderProduct.setOrderOffer(orderOffer);

		orderProductService.create(orderProduct);

		product.getQuoteAttributes().forEach(quoteAttribute -> {
			processOrderAttribute(quoteAttribute, commercialOrder, orderLot, orderProduct);
		});

		product.getQuoteArticleLines().forEach(quoteArticleLine -> {
			OrderArticleLine orderArticleLine = processOrderArticleLine(quoteArticleLine, commercialOrder, orderLot, orderProduct);
			processOrderPrice(quoteArticleLine.getId(), orderArticleLine, commercialOrder, product.getQuoteOffer().getQuoteVersion());
		});


		return orderProduct;
	}

	private void processOrderAttribute(QuoteAttribute quoteAttribute, CommercialOrder commercialOrder, OrderLot orderLot, OrderProduct orderProduct) {
		OrderAttribute orderAttribute = new OrderAttribute(quoteAttribute, currentUser);
		orderAttribute.setCommercialOrder(commercialOrder);
		orderAttribute.setOrderLot(orderLot);
		orderAttribute.setOrderProduct(orderProduct);
		orderAttribute.setAccessPoint(null);
		orderAttributeService.create(orderAttribute);
	}

	private OrderLot processOrderCustomerService(QuoteLot quoteLot, CommercialOrder commercialOrder) {
		OrderLot orderCustomer = new OrderLot();
		orderCustomer.setCode(UUID.randomUUID().toString());
		orderCustomer.setCode(orderCustomerServiceService.findDuplicateCode(orderCustomer));
		orderCustomer.setOrder(commercialOrder);
		orderCustomerServiceService.create(orderCustomer);
		return orderCustomer;
	}

	private OrderArticleLine processOrderArticleLine(QuoteArticleLine quoteArticleLine, CommercialOrder commercialOrder, OrderLot orderCustomerService, OrderProduct orderProduct) {
		OrderArticleLine articleLine = new OrderArticleLine();
		articleLine.setCode(orderArticleLineService.findDuplicateCode(articleLine));
		articleLine.setOrder(commercialOrder);
		articleLine.setOrderCustomerService(orderCustomerService);
		articleLine.setQuantity(quoteArticleLine.getQuantity());
		articleLine.setQuantityService(quoteArticleLine.getServiceQuantity());
		articleLine.setAccountingArticle(quoteArticleLine.getAccountingArticle());
		articleLine.setOrderProduct(orderProduct);
		orderArticleLineService.create(articleLine);
		return articleLine;
	}

	private void processOrderPrice(Long quoteArticleLineId, OrderArticleLine orderArticleLine, CommercialOrder commercialOrder, QuoteVersion quoteVersion) {
		var quotePrices = quotePriceService.findByQuoteArticleLineIdandQuoteVersionId(quoteArticleLineId, quoteVersion.getId());
		quotePrices.forEach( price -> {
			OrderPrice orderPrice = new OrderPrice();
			orderPrice.setCode(UUID.randomUUID().toString());
			orderPrice.setCode(orderPriceService.findDuplicateCode(orderPrice));
			orderPrice.setOrderArticleLine(orderArticleLine);
			orderPrice.setOrder(commercialOrder);
			orderPrice.setPriceLevelEnum(price.getPriceLevelEnum());
			orderPrice.setAmountWithTax(price.getAmountWithTax());
			orderPrice.setUnitPriceWithoutTax(price.getUnitPriceWithoutTax());
			orderPrice.setAmountWithoutTax(price.getAmountWithoutTax());
			orderPrice.setAmountWithoutTaxWithDiscount(price.getAmountWithoutTaxWithDiscount());
			orderPrice.setTaxAmount(price.getTaxAmount());
			orderPrice.setTaxRate(price.getTaxRate());
			orderPrice.setPriceOverCharged(price.getPriceOverCharged());
			orderPrice.setCurrencyCode(price.getCurrencyCode());
			orderPrice.setRecurrenceDuration(price.getRecurrenceDuration());
			orderPrice.setRecurrencePeriodicity(price.getRecurrencePeriodicity());
			orderPrice.setChargeTemplate(price.getChargeTemplate());
			orderPriceService.create(orderPrice);
		});
	}

}

	');
        ]]></sql>



        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-27, 0, 0, ${db.current.time}, 'org.meveo.api.billing.OrderAdvancement', 'OrderAdvancement', 'JAVA', '
  package org.meveo.api.billing;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import org.meveo.admin.exception.BusinessException;
import org.meveo.api.cpq.CommercialOrderApi;
import org.meveo.api.exception.EntityDoesNotExistsException;
import org.meveo.commons.utils.ParamBean;
import org.meveo.model.article.AccountingArticle;
import org.meveo.model.billing.Invoice;
import org.meveo.model.billing.InvoiceType;
import org.meveo.model.catalog.ChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplateTypeEnum;
import org.meveo.model.cpq.Attribute;
import org.meveo.model.cpq.AttributeValue;
import org.meveo.model.cpq.Product;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.InvoiceLine;
import org.meveo.model.cpq.commercial.InvoicingPlanItem;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.service.billing.impl.InvoiceLinesService;
import org.meveo.service.billing.impl.InvoiceService;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.billing.impl.article.AccountingArticleService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class OrderAdvancement extends ModuleScript {

    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private CommercialOrderApi commercialOrderApi = (CommercialOrderApi) getServiceInterface(CommercialOrderApi.class.getSimpleName());
    private AccountingArticleService accountingArticleService = (AccountingArticleService) getServiceInterface(AccountingArticleService.class.getSimpleName());
    private InvoiceLinesService invoiceLinesService = (InvoiceLinesService) getServiceInterface(InvoiceLinesService.class.getSimpleName());
    private InvoiceService invoiceService = (InvoiceService) getServiceInterface(InvoiceService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private Logger log = LoggerFactory.getLogger(this.getClass());


    @Override
    public void execute(Map<String, Object> methodContext) throws BusinessException {
        CommercialOrder commercialOrder = (CommercialOrder) methodContext.get("commercialOrder");
        if(commercialOrder == null) {
            throw new BusinessException("No Commercial order is found");
        }
        Integer orderProgress = commercialOrder.getOrderProgress();

        if (commercialOrder.getInvoicingPlan() != null) {

            Date nextDay = java.sql.Date.valueOf(LocalDate.now().plusDays(1));
            Date firstTransactionDate = java.sql.Date.valueOf(LocalDate.now().minusDays(1));
            Date invoiceDate = new Date();
            List<OrderPrice> pricesToBill = orderPriceService.findByOrder(commercialOrder).stream()
                    .filter(this::isPriceRelatedToOneShotChargeTemplateOfTypeOther)
                    .collect(Collectors.toList());

            if (pricesToBill.isEmpty()) {
                log.info("No order prices to bill related to a one shot charge were found for commercial order: "+ commercialOrder.getId());
                return;
            }

            AccountingArticle defaultAccountingArticle = getDefaultAccountingArticle();

            BigDecimal totalAmountWithoutTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithoutTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalAmountWithTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTax = pricesToBill.stream()
                    .map(OrderPrice::getTaxAmount)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTaxRate = pricesToBill.stream()
                    .map(OrderPrice::getTaxRate)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            OrderProduct orderProduct = pricesToBill.get(0).getOrderArticleLine().getOrderProduct();

            if(orderProgress == 100) {
                if(commercialOrder.getRateInvoiced() < 100) {
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                    commercialOrder.setOrderProgressTmp(orderProgress);
                    commercialOrder.setRateInvoiced(100);
                }
                commercialOrderApi.validateOrder(commercialOrder, true);
            } else {
                List<InvoicingPlanItem> itemsToBill = commercialOrder.getInvoicingPlan().getInvoicingPlanItems().stream()
                        .filter(item -> item.getAdvancement() == orderProgress)
                        .collect(Collectors.toList());

                if (itemsToBill.isEmpty()) {
                    log.info("No invoicing plan item found for the order progress: " + orderProgress + " commercial order id: " + commercialOrder.getId());
                    return;
                } else if (itemsToBill.size() > 1)
                    throw new BusinessException("Many invoicing plan items are set for the advancement: " + orderProgress + " using the invoicing plan: " + commercialOrder.getInvoicingPlan().getCode());

                InvoicingPlanItem invoicingPlanItem = itemsToBill.get(0);

                BigDecimal newRateInvoiced = invoicingPlanItem.getRateToBill().add(BigDecimal.valueOf(commercialOrder.getRateInvoiced()));
                if (newRateInvoiced.compareTo(BigDecimal.valueOf(100)) > 0) {
                    throw new BusinessException("the invoicing plan rate is grater than remaining rate to invoice");
                }
                if(newRateInvoiced.compareTo(BigDecimal.valueOf(100)) == 0){
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                }else {
                    BigDecimal amountWithoutTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithoutTax);
                    BigDecimal amountWithTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithTax);
                    BigDecimal taxAmountToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalTax);

                    createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
                    List<Invoice> invoices=invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,true);
                }
                commercialOrder.setRateInvoiced(newRateInvoiced.intValue());
                commercialOrder.setOrderProgressTmp(orderProgress);
                commercialOrderService.update(commercialOrder);
            }
        }


    }

    private void generateGlobalInvoice(CommercialOrder commercialOrder, Date nextDay, Date firstTransactionDate, Date invoiceDate, AccountingArticle defaultAccountingArticle, BigDecimal totalAmountWithoutTax, BigDecimal totalAmountWithTax, BigDecimal totalTax, BigDecimal totalTaxRate, OrderProduct orderProduct) {
        Map<String, Object> attributes = new HashMap<String, Object>();
        List<AttributeValue> orderAttributes = orderProduct.getOrderAttributes().stream().map(oa -> (AttributeValue)oa).collect(Collectors.toList());
        for (AttributeValue orderAttribute : orderAttributes) {
            Attribute attribute = orderAttribute.getAttribute();
            Object value = attribute.getAttributeType().getValue(orderAttribute);
            if (value != null) {
                attributes.put(orderAttribute.getAttribute().getCode(), value);
            }
        }
        Product product = orderProduct.getProductVersion().getProduct();
        Optional<AccountingArticle> accountingArticle = accountingArticleService.getAccountingArticle(product, attributes);
        if (!accountingArticle.isPresent())
            throw new BusinessException("No accounting article found for product code: " + product.getCode() + " and attributes: " + attributes.toString());

        List<InvoiceLine> accounts = invoiceLinesService.findByCommercialOrder(commercialOrder);
        for(InvoiceLine account : accounts){
            createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, account.getAmountWithoutTax().negate(), account.getAmountWithTax().negate(), account.getAmountTax().negate(), account.getTaxRate());
        }

        createInvoiceLine(commercialOrder, accountingArticle.get(), orderProduct, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate);
        invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,false);

    }

    private AccountingArticle getDefaultAccountingArticle() {
        String articleCode = ParamBean.getInstance().getProperty("advancePayment.accountingArticleCode", "ACT-STD");

        AccountingArticle accountingArticle = accountingArticleService.findByCode(articleCode);
        if (accountingArticle == null)
            throw new EntityDoesNotExistsException(AccountingArticle.class, articleCode);
        return accountingArticle;
    }

    private void createInvoiceLine(CommercialOrder commercialOrder, AccountingArticle accountingArticle, OrderProduct orderProduct, BigDecimal amountWithoutTaxToBeInvoiced, BigDecimal amountWithTaxToBeInvoiced, BigDecimal taxAmountToBeInvoiced, BigDecimal totalTaxRate) {
        invoiceLinesService.createInvoiceLine(commercialOrder, accountingArticle, orderProduct.getProductVersion(),orderProduct.getOrderServiceCommercial(), amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
    }

    private boolean isPriceRelatedToOneShotChargeTemplateOfTypeOther(OrderPrice price) {
        return price.getChargeTemplate().getChargeMainType() == ChargeTemplate.ChargeMainTypeEnum.ONESHOT
                && ((OneShotChargeTemplate) price.getChargeTemplate()).getOneShotChargeTemplateType() == OneShotChargeTemplateTypeEnum.OTHER;
    }


}



	');
        ]]></sql>

    </changeSet>

    <changeSet id="#270_20210222" author="Mbarek-Ay">
        <addColumn tableName="cpq_media">
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
        </addColumn>
        <dropColumn tableName="cpq_media">
            <column name="product_id"></column>
            <column name="offer_id"></column>
            <column name="attribute_id"></column>
            <column name="service_template_id"></column>
        </dropColumn>

        <createTable tableName="cpq_offer_template_media">
            <column name="offer_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_template_id,media_id" constraintName="cpq_offer_template_media_pkey" tableName="cpq_offer_template_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_offer_template_media"
                baseColumnNames="offer_template_id"
                constraintName="cpq_offer_template_media_offer_template_id_fk"
                referencedTableName="cat_offer_template" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_offer_template_media" baseColumnNames="media_id"
                constraintName="cpq_offer_template_media_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />


        <createTable tableName="cpq_product_media">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="product_id,media_id" constraintName="cpq_product_media_pkey" tableName="cpq_product_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_product_media"
                baseColumnNames="product_id"
                constraintName="cpq_product_media_product_id_fk"
                referencedTableName="cpq_product" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_product_media" baseColumnNames="media_id"
                constraintName="cpq_product_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />


        <createTable tableName="cpq_attribute_media">
            <column name="attribute_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="attribute_id,media_id" constraintName="cpq_attribute_media_pkey" tableName="cpq_attribute_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_attribute_media"
                baseColumnNames="attribute_id"
                constraintName="cpq_attribute_media_attribute_id_fk"
                referencedTableName="cpq_attribute" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_attribute_media" baseColumnNames="media_id"
                constraintName="cpq_attribute_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />

    </changeSet>


    <changeSet id="#20210222_540_269" author="TarikFA.">
        <dropColumn tableName="cpq_grouped_attributes">
            <column name="product_version_id"></column>
        </dropColumn>

        <dropColumn tableName="cpq_attribute">
            <column name="grouped_attributes_id"></column>
        </dropColumn>

        <createTable tableName="cpq_grouped_attributes_attribute">
            <column name="grouped_attributes" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="grouped_attributes" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_groupedattribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
    </changeSet>

    <changeSet id="#20210123_540_280" author="TarikFA.">

        <addColumn tableName="adm_secured_entity">
            <column name="disable" type="boolean" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="adm_role_secured_entity">
            <column name="disable" type="boolean" defaultValueNumeric="0" >
                <constraints nullable="false" />
            </column>
        </addColumn>

    </changeSet>


    <changeSet   id="#20210123_540_281" author="TarikFA.">
        <addColumn tableName="adm_role">
            <column name="uuid" type="varchar(60)" defaultValue="" />
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="created" type="datetime" defaultValueDate="${db.current.time}">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
        <sql>update ${db.schema.adapted}adm_role set uuid = 'role'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
    </changeSet>

    <changeSet id="#20210224_5868" author="Mbarek-Ay">
        <addColumn tableName="cpq_commercial_order">
            <column name="oneshot_total_amount" type="numeric(23, 12)" />
        </addColumn>
        <dropForeignKeyConstraint baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id"/>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
    </changeSet>

    <changeSet id="#20210222_907" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="has_taxes" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="has_discounts" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="has_minimum" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20210302_540" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id"/>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="#20210303_540305" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="cat_service_template" constraintName="fk-product-accounting_article"/>
        <dropColumn tableName="cat_service_template">
            <column name="accounting_article_id" />
        </dropColumn>
        <dropTable tableName="cpq_accounting_article"/>
        <dropSequence sequenceName="cpq_accounting_article_seq"/>
    </changeSet>

    <changeSet id="#20210304_540320" author="TarikFA.">

        <addColumn tableName="cpq_quote_attribute">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_quote_attribute set uuid = 'quote_attribute'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_order_item">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_order_item set uuid = 'order_item'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_attribute_instance">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_attribute_instance set uuid = 'attribute_instance'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="ar_payment_token">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}ar_payment_token set uuid = 'payment_token'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_attribute">
            <column name="read_only" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="account_entity">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="com_sender_config">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="crm_provider">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="crm_provider_contact">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="ord_order_item">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="cpq_offer_component">
            <column name="sequence" type="int4" defaultValueNumeric="0"/>
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="display" type="${type.boolean}" />
        </addColumn>

    </changeSet>


    <changeSet id="#20210304-312" author="Mbarek-Ay">
        <addColumn tableName="cpq_order_item">
            <column name="cpq_order_offer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_order_offer_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_cpq_order_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>


    <changeSet id="#20210310-342" author="Mbarek-Ay">
        <addColumn tableName="billing_invoice">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cat_discount_plan">
            <column name="expression_el" type="varchar(2000)" />
        </addColumn>

        <createTable tableName="discount_plan_item_articles">
            <column name="discount_plan_item_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="accounting_article_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="discount_plan_item_id"
                                 constraintName="discount_plan_item_articles_discount_plan_item_id_fk" referencedTableName="cat_discount_plan_item"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="accounting_article_id"
                                 constraintName="discount_plan_item_articles_accounting_article_id_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="#20210315-329" author="Mbarek-Ay">
        <dropForeignKeyConstraint baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id"/>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_product_version_serviceInstance_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version"/>
    </changeSet>


    <changeSet id="#20210316-356" author="Mbarek-Ay">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_product_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product"/>

        <addForeignKeyConstraint baseColumnNames="discount_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_discount_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

    </changeSet>

    <changeSet id="#20210316-356-2" author="Mbarek-Ay">
        <addColumn tableName="cat_discount_plan_item">
            <column name="price_plan_matrix_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_discount_plan_item" constraintName="fk_cat_discount_plan_item_price_plan_matrix_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>

    <changeSet id="#20210317_M540_16" author="TarikFA.">
        <dropColumn tableName="cpq_tag">
            <column name="attribute_id" />
        </dropColumn>

        <createTable tableName="cpq_attribute_tag">
            <column name="tag_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="tag_id,attribute_id" tableName="cpq_attribute_tag"/>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_tag_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />

    </changeSet>

    <changeSet id="#2020317-342" author="Mbarek-Ay">
        <addColumn tableName="cpq_order_product">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>

        <addColumn tableName="cpq_order_offer">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>


        <addColumn tableName="cpq_quote_version">
            <column name="invoicing_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_invoicing_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan"/>
    </changeSet>

    <changeSet id="#20210322_377" author="TarikFA.">
        <addColumn tableName="cpq_attribute">
            <column name="default_value" type="varchar(255)"></column>
        </addColumn>
        <addColumn tableName="cpq_offer_component">
            <column name="quantity_min" type="int4" />
            <column name="quantity_max" type="int4" />
            <column name="quantity_default" type="int4" />
        </addColumn>
    </changeSet>

    <changeSet id="#20210323_380" author="TarikFA.">
        <addColumn tableName="cat_discount_plan_item">
            <column name="description" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20210323-382" author="Mbarek-Ay">
        <addColumn tableName="cpq_contract_item">
            <column name="rate_type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20220325_360" author="TarikFA.">
        <createTable tableName="cpq_commercial_order_order_lot">
            <column name="commercial_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="order_lot_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="commercial_order_id,order_lot_id" tableName="cpq_commercial_order_order_lot"/>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_order_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

    </changeSet>
    <changeSet id="#20210329_399" author="TarikFA.">
        <renameTable newTableName="cpq_order_attribute" oldTableName="cpq_order_item"/>
    </changeSet>
    <changeSet id="#20210401_402" author="TarikFA.">
        <addColumn tableName="account_entity">
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="account_entity" constraintName="fk_account_entity_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
    </changeSet>

    <changeSet id="#20210406_opencell-portal-593" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_service_template"/>
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>





    <changeSet id="rebuild-str-fk_6012_20210323" author="MohamedAliHammal">
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa"/>
        <addForeignKeyConstraint baseColumnNames="inbound_request_id" baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
    </changeSet>
    <changeSet id="rebuild_5621_20201104_offer_template" author="NabilOUACHI">
        <addColumn tableName="cat_offer_template">
            <column name="offer_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_offer_template" baseColumnNames="offer_template_id"
                                 constraintName="offer_template_offer_template_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#20210415-435" author="Mbarek-Ay">
        <addColumn tableName="billing_invoice">
            <column name="commercial_order_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
    </changeSet>

    <changeSet id="#20210416_441" author="TarikFA.">
        <addColumn tableName="cpq_offer_component">
            <column name="product_set" type="varchar(250)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#470_20210422" author="Mbarek-Ay">
        <addColumn tableName="cat_offer_template">
            <column name="is_model" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="cpq_product">
            <column name="is_model" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <!-- end media post -->

	<changeSet id="#5627_20201212" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_billing_run">
            <column name="skip_validation_script" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="suspect_auto_action" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="reject_auto_action" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="next_billing_run_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="billing_invoice">
            <column name="reject_reason" type="varchar(255)"/>
        </addColumn>

        <addColumn tableName="billing_cycle">
            <column name="billing_run_validation_script_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_invoice_type">
            <column name="invoice_validation_script_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="next_billing_run_id" baseTableName="billing_billing_run" constraintName="fk_billing_billing_run_next_billing_run"
                                 referencedColumnNames="id" referencedTableName="billing_billing_run"/>
        <addForeignKeyConstraint baseColumnNames="billing_run_validation_script_id" baseTableName="billing_cycle" constraintName="fk_billing_cycle_billing_run_validation_script"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance"/>
        <addForeignKeyConstraint baseColumnNames="invoice_validation_script_id" baseTableName="billing_invoice_type"
                                 constraintName="fk_billing_invoice_type_invoice_validation_script"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance"/>
    </changeSet>

    <changeSet id="#5627_20210112" author="MohammedELAZZOUZI">
        <addDefaultValue columnName="skip_validation_script" tableName="billing_billing_run" defaultValueNumeric="0"/>
        <sql>UPDATE ${db.schema.adapted}billing_billing_run SET skip_validation_script=0 WHERE skip_validation_script IS NULL</sql>
    </changeSet>
    
    <changeSet id="#5884_20210119" author="MohammedELAZZOUZI">
    	<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="billing_invoice" columnName="status_date" />
	       </not>
		</preConditions>

        <addColumn tableName="billing_invoice">
            <column name="status_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="xml_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="pdf_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="email_sent_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="payment_status" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="payment_status_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="start_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="end_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="raw_amount" type="numeric(23, 12)">
                <!--  <constraints nullable="false"/>  -->
            </column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="discount_amount" type="numeric(23, 12)">
                <!--  <constraints nullable="false"/>  -->
            </column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="discount_rate" type="numeric(3, 3)">
            </column>
        </addColumn>

        <addColumn tableName="billing_invoice">
            <column name="is_already_applied_minimum" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="is_already_added_discount" type="${type.boolean}"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5946_20210110" author="KhalidHORRI">
    	<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="cat_discount_plan" columnName="status" />
	       </not>
		</preConditions>
        <addColumn tableName="cat_discount_plan">
            <column name="status" type="varchar(50)"/>
            <column name="status_date" type="datetime"/>
            <column name="initial_quantity" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="used_quantity" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="application_limit" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="application_filter_el" type="varchar(2000)"/>
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cat_discount_plan"
                                 constraintName="fk_discount_plan_id"
                                 referencedColumnNames="id" referencedTableName="cat_discount_plan"/>
        <addColumn tableName="cat_discount_plan_item">
            <column name="allow_to_negate" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_discount_plan_instance">
            <column name="status" type="varchar(50)"/>
            <column name="status_date" type="datetime"/>
            <column name="application_count" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}cat_discount_plan set status='DRAFT', status_date= ${db.current.time}WHERE status IS NULL</sql>
        <createTable tableName="cat_discount_applicable_entity">
            <column name="disount_plan_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_class" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="disount_plan_id, code, entity_class" constraintName="cat_discount_applicable_entity_pkey" tableName="cat_discount_applicable_entity"/>
    </changeSet>

    <changeSet id="#5951_20210209_structure" author="AbdelmounaimAkadid">
	    <dropNotNullConstraint columnName="tax_category_id" tableName="billing_tax_mapping"/>
	    <dropNotNullConstraint columnName="tax_class_id" tableName="billing_tax_mapping"/>
	</changeSet>

    <changeSet id="#5872_20210104" author="AmineBENAICHA" dbms="postgresql">
    	<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other_tmp AS
			SELECT
			*
			FROM
				${db.schema.adapted}rating_edr_other
		</sql>

		<dropTable tableName="rating_edr_other"/>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other (
			  id bigint NOT NULL DEFAULT nextval('rating_edr_seq'),
			  version integer,
			  created timestamp without time zone,
			  event_date timestamp without time zone,
			  last_updated timestamp without time zone,
			  origin_batch character varying(255),
			  origin_record character varying(255),
			  parameter_1 character varying(255),
			  parameter_2 character varying(255),
			  parameter_3 character varying(255),
			  parameter_4 character varying(255),
			  quantity numeric(23,12),
			  reject_reason text,
			  status character varying(255) NOT NULL,
			  subscription_id bigint NOT NULL,
			  parameter_5 character varying(255),
			  parameter_6 character varying(255),
			  parameter_7 character varying(255),
			  parameter_8 character varying(255),
			  parameter_9 character varying(255),
			  date_parameter_1 timestamp without time zone,
			  date_parameter_2 timestamp without time zone,
			  date_parameter_3 timestamp without time zone,
			  date_parameter_4 timestamp without time zone,
			  date_parameter_5 timestamp without time zone,
			  decimal_parameter_1 numeric(23,12),
			  decimal_parameter_2 numeric(23,12),
			  decimal_parameter_3 numeric(23,12),
			  decimal_parameter_4 numeric(23,12),
			  decimal_parameter_5 numeric(23,12),
			  access_code character varying(255),
			  header_edr_id bigint,
			  extra_parameter text,
			  times_tried int4
			) partition by list (status)
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_rejected PARTITION OF ${db.schema.adapted}rating_edr_other
				FOR VALUES IN ('REJECTED')
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_duplicated PARTITION OF ${db.schema.adapted}rating_edr_other
				FOR VALUES IN ('DUPLICATED')
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other_default PARTITION OF ${db.schema.adapted}rating_edr_other DEFAULT
		</sql>

		<sql>
			ALTER TABLE ${db.schema.adapted}rating_edr ATTACH PARTITION ${db.schema.adapted}rating_edr_other DEFAULT
		</sql>

		<sql>insert into ${db.schema.adapted}rating_edr
		     (select *
				from ${db.schema.adapted}rating_edr_other_tmp
			  )
		</sql>

		<dropTable tableName="rating_edr_other_tmp"/>
    </changeSet>

    <changeSet id="#5700_20210118" author="AmineBENAICHA" dbms="postgresql">
    	<sql>
    		update meveo_job_instance
			set cf_values=
				case
					when cf_values is not null then (cf_values::jsonb || ('{"AccountOperationsGenerationJob_excludeInvoicesWithoutAmount": [{"boolean": ' || exclude_inv_without_amount::boolean || '}]}')::jsonb)::text
					else '{"AccountOperationsGenerationJob_excludeInvoicesWithoutAmount": [{"boolean": ' || exclude_inv_without_amount::boolean || '}]}'
				end
			where (id=-14 or code='AO_Job')
    	</sql>
    </changeSet>

    <changeSet id="#5909_20210118" author="AndriusKarpavicius">
        <sql>CREATE INDEX audit_field_changes_history_index on ${db.schema.adapted}audit_field_changes_history (lower(entity_class), entity_id)</sql>
    </changeSet>

    <changeSet id="#5904_20210129" author="AmineBENAICHA">
    	<addColumn tableName="meveo_job_instance">
    		<column name="stop_on_error" type="${type.boolean}"
    			defaultValueNumeric="0" />
		</addColumn>
    </changeSet>

    <changeSet id="#5960_20210212" author="AndriusKarpavicius">
        <sql>CREATE INDEX flat_file_orig_name_index on ${db.schema.adapted}flat_file (lower(file_original_name))</sql>
        <sql>CREATE INDEX job_execution_job_id_index on ${db.schema.adapted}job_execution (job_instance_id)</sql>
        <sql>CREATE INDEX medina_access_lower_uid_index on ${db.schema.adapted}medina_access (lower(acces_user_id))</sql>
        <sql>CREATE INDEX ord_order_status_index on ${db.schema.adapted}ord_order (status)</sql>
        <sql>CREATE INDEX billing_service_instance_st_index on ${db.schema.adapted}billing_service_instance (service_template_id)</sql>
        <sql>CREATE INDEX billing_wallet_operation_sub_index on ${db.schema.adapted}billing_wallet_operation (subscription_id)</sql>
    </changeSet>

    <changeSet id="#5993_20210304" author="HatimOUDAD">
        <addUniqueConstraint columnNames="country_code" constraintName="UniqueConstraint_adm__country_code" tableName="adm_country" />
    </changeSet>

    <changeSet id="#5863_22122020" author="AbdelmounaimAkadid">
		<addColumn tableName="ar_ddrequest_lot_op">
            <column name="generate_payment_lines" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="payment_status" type="varchar(25)" />
        </addColumn>
	</changeSet>

    <changeSet id="#5999_20210305" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_invoice_br_index on ${db.schema.adapted}billing_invoice (billing_run_id)</sql>
        <sql>CREATE INDEX billing_invoice_agregate_br_index on ${db.schema.adapted}billing_invoice_agregate (billing_run_id)</sql>
        <sql>CREATE INDEX rt_br_index ON billing_rated_transaction (billing_run_id) where status='BILLED'</sql>
    </changeSet>

    <changeSet id="#6040_20210323" author="amineTazi">
        <addColumn tableName="dwh_report_extract">
            <column name="file_separator" type="varchar(1)" defaultValue=","/>
        </addColumn>
    </changeSet>

    <changeSet id="#6012_20210323" author="MohamedAliHammal">
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa"/>
        <addForeignKeyConstraint baseColumnNames="inbound_request_id" baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
    </changeSet>
    <changeSet id="4756_20191104" author="Andrius">
        <!-- <dropColumn tableName="job_execution" columnName="job_done"/>  -->
        <addColumn tableName="job_execution">
            <column name="job_status" type="varchar(14)"/>
        </addColumn>
    </changeSet>

    <changeSet id="4756_20210311" author="Andrius">
    	<addColumn tableName="meveo_job_instance">
    		<column name="job_speed" type="varchar(10)" defaultValue="NORMAL" />
    	</addColumn>
    	<sql>update ${db.schema.adapted}job_execution set job_launcher='TRIGGER' where job_launcher='TRIGER'</sql>
    </changeSet>


    <changeSet id="6055_20210330" author="Andrius" dbms="postgresql">
    	<sql>CREATE OPERATOR ^|(
			  PROCEDURE = jsonb_exists_any,
			  LEFTARG = jsonb,
			  RIGHTARG = _text,
			  RESTRICT = contsel,
			  JOIN = contjoinsel)</sql>

		<sql>CREATE OPERATOR CLASS jsonb_ops_custom
			   FOR TYPE jsonb USING gin AS
			   OPERATOR 10  ^|(jsonb, _text),
			   FUNCTION 1  gin_compare_jsonb(text, text),
			   FUNCTION 2  gin_extract_jsonb(jsonb, internal, internal),
			   FUNCTION 3  gin_extract_jsonb_query(jsonb, internal, smallint, internal, internal, internal, internal),
			   FUNCTION 4  gin_consistent_jsonb(internal, smallint, jsonb, integer, internal, internal, internal, internal),
			   FUNCTION 6  gin_triconsistent_jsonb(internal, smallint, jsonb, integer, internal, internal, internal);
			   </sql>
    </changeSet>


    <changeSet id="#5622_20210406" author="AbdelmounaimAkadid">
	    <sql>
            ALTER TABLE ${db.schema.adapted}billing_wallet_operation ALTER COLUMN charge_instance_id DROP NOT NULL
        </sql>
    </changeSet>

    <changeSet id="#5214_20200415_migration" author="AbdelmounaimAkadid">
    	<sql>INSERT INTO ${db.schema.adapted}wf_generic_action(id, version, priority, action_script_id, type, condition_el, transition_id)
        		SELECT nextval('wf_generic_action_seq'), 0, 0, action_script_id, 'ACTION_SCRIPT', '#{true}', id from wf_generic_transition</sql>

        <sql>update ${db.schema.adapted}wf_generic_action set uuid = id</sql>

    	<dropColumn columnName="action_script_id" tableName="wf_generic_transition" />
    </changeSet>

    <changeSet id="#4742_20191030" author="MohamedSTITANE">
    	<preConditions onFail="MARK_RAN">
	       <not>
			<sequenceExists sequenceName="meveo_metrics_config_seq" />
	       </not>
		</preConditions>
        <createSequence sequenceName="meveo_metrics_config_seq" />
        <createTable tableName="meveo_metrics_config">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="meveo_metrics_config_id_pk" />
            </column>
            <column name="code" type="varchar(100)">
                <constraints unique="true" uniqueConstraintName="meveo_metrics_config_code_unique" nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="full_path" type="text"/>
            <column name="method" type="text"/>
            <column name="metrics_type" type="text"/>
            <column name="metrics_unit" type="text"/>
            <column name="version" type="int4"/>
            <column name="updated" type="datetime"/>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
    </changeSet>

    <changeSet id="#6076_20210419" author="Zbariki">
        <addColumn tableName="dwh_report_extract">
            <column name="custom_table_code" type="varchar(255)" />
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="accumulate" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="decimal_separator" type="character" defaultValue="."/>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="generate_empty_report" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="maximum_line" type="bigint" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="07042021-540-423" author="NabilOuachi">
        <sql>
            <![CDATA[
				update billing_tax_class set version = 0 where code = 'NO_TAX';
                update billing_tax_class set version = 0 where code = 'NORMAL';
                update billing_tax_class set version = 0 where code = 'REDUCED';
			]]>
        </sql>
    </changeSet>

	<changeSet id="#5991_20210224" author="HatimOUDAD">
		<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="billing_invoice_configuration" columnName="default_invoice_subcategory_id" />
	       </not>
		</preConditions>
		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_subcategory_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_invoice_subcategory_id"
			referencedTableName="billing_invoice_sub_cat"
			baseColumnNames="default_invoice_subcategory_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_generic_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_generic_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_generic_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_discount_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_discount_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_discount_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_advanced_payment_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_advanced_payment_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_advanced_payment_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_minimum_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_invoice_minimum_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_invoice_minimum_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />
	</changeSet>

	<changeSet id="#5623_20210427" author="Mbarek">
		<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="cpq_order_offer" columnName="quote_offer_id" />
	       </not>
		</preConditions>
       <addColumn tableName="cpq_order_offer">
            <column name="quote_offer_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_offer_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />

      <addColumn tableName="cpq_order_product">
            <column name="quote_product_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />

      <addColumn tableName="cpq_order_lot">
            <column name="quote_lot_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_order_lot" constraintName="fk_cpq_order_lot_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
    </changeSet>

	<changeSet id="#cpq_add_missing_migration" author="AbdelmounaimAkadid">
		<preConditions onFail="MARK_RAN">
	       <not>
			<sequenceExists sequenceName="cpq_price_plan_version_seq" />
	       </not>
		</preConditions>
		<createSequence sequenceName="cpq_price_plan_version_seq" />
        <createSequence sequenceName="cpq_price_plan_matrix_item_seq" />
        <createSequence sequenceName="cpq_quote_version_seq" />
        <createSequence sequenceName="cpq_quote_product_seq" />
        <createSequence sequenceName="cpq_quote_lot_seq" />
        <createSequence sequenceName="cpq_contract_seq" />
        <createSequence sequenceName="cpq_contract_item_seq" />

        <addColumn tableName="cat_discount_plan">
            <column name="discount_plan_type" type="varchar(50)" />
        </addColumn>
   	</changeSet>


    <changeSet id="#5937_20210428" author="Mbarek-Ay">
      <preConditions onFail="MARK_RAN">
        <columnExists tableName="cpq_invoice_line" columnName="code"/>
        <columnExists tableName="cpq_invoice_line" columnName="description"/>
      </preConditions>
      <dropColumn tableName="cpq_invoice_line" columnName="code"/>
      <dropColumn tableName="cpq_invoice_line" columnName="description"/>
    </changeSet>

    <changeSet id="#5595_540498_20210430" author="TarikFA.">
    	<addColumn tableName="cat_offer_template">
    		<column name="offer_model_id" type="bigint"/>
    	</addColumn>

      <addForeignKeyConstraint baseColumnNames="offer_model_id" baseTableName="cat_offer_template" constraintName="fk_offer_template_offer_model_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
	</changeSet>

      <changeSet id="#5595_540499_20210430" author="TarikFA.">
        <addColumn tableName="cpq_product">
            <column name="product_model_id" type="bigint"/>
        </addColumn>

      <addForeignKeyConstraint baseColumnNames="product_model_id" baseTableName="cpq_product" constraintName="fk_cpq_product_model_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet id="#5595_540504_20210503" author="TarikFA.">
        <addColumn tableName="cpq_quote_version">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>
        <addUniqueConstraint columnNames="uuid" constraintName="cpq_quote_version_uuid_unique" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="cpq_quote_version" />
        <sql>update ${db.schema.adapted}cpq_quote_version set uuid = id</sql>
		<dropColumn tableName="cpq_quote">
			<column name="cf_values"/>
            <column name="cf_values_accum"/>
            <column name="uuid" />
		</dropColumn>
    </changeSet>

    <changeSet id="#6076_20210504" author="Zbariki">
        <modifyDataType columnName="decimal_separator" newDataType="varchar(1)" tableName="dwh_report_extract"/>
    </changeSet>

    <changeSet id="#5595_20210506" author="NabilOuachi">
        <addColumn tableName="cpq_quote">
            <column name="previews_status" type="varchar(20)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5595_20210512" author="RachidAityaazza">
       <renameColumn tableName="cpq_quote" newColumnName="previous_status" oldColumnName="previews_status"
                      columnDataType="varchar(20)"/>
        <sql>update ${db.schema.adapted}cpq_quote set previous_status='IN_PROGRESS' where previous_status is null</sql>
    </changeSet>

    <changeSet id="#6122_20210517" author="AbdelmounaimAkadid">
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_added_discount = 0;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_added_discount = 1 where invoice_id in (select invoice_id from billing_invoice_agregate where discount_aggregate = 1);</sql>

    	<sql>update ${db.schema.adapted}billing_invoice set is_already_applied_minimum = 0;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_applied_minimum = 1 where invoice_id in (select invoice_id from billing_rated_transaction where type = 'MINIMUM' group by invoice_id);</sql>

    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = 'NONE';</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = 'PENDING' where recorded_invoice_id IS NOT NULL;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = status where status IN ('PAID', 'PPAID', 'UNPAID', 'ABANDONED', 'REFUNDED', 'DISPUTED');</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set status = 'VALIDATED' where status IN ('GENERATED', 'PAID', 'PPAID', 'UNPAID', 'ABANDONED', 'REFUNDED', 'DISPUTED');</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set status = 'NEW' where status = 'CREATED';</sql>

    	<sql>UPDATE ${db.schema.adapted}crm_custom_field_tmpl SET field_type = 'CHECKBOX_LIST', value_required = 0, default_value = 'VALIDATED', storage_type = 'LIST'
    		WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code ='invoicesToProcess';</sql>


		<sql>DELETE FROM ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (
								SELECT id FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess');</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'New', 'NEW' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Draft', 'DRAFT' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Canceled', 'CANCELED' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Suspect', 'SUSPECT' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Validated', 'VALIDATED' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Rejected', 'REJECTED' FROM crm_custom_field_tmpl
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

    </changeSet>


    <changeSet id="#5257_20210519" author="AndriusKarpavicius">
        <addColumn tableName="billing_wallet_operation">
            <column name="refunds_wo_id" type="bigint"/>
        </addColumn>
    </changeSet>

	<changeSet id="#5623-562-20210520" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		 <column name="quote_offer_id" type="bigint" />
		</addColumn>

		<addColumn tableName="order_price">
		<column name="order_offer_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			baseColumnNames="quote_offer_id" baseTableName="cpq_quote_price" constraintName="fk_cpq_quote_price_quote_offer" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="quote_offer" />

		<addForeignKeyConstraint
			baseColumnNames="order_offer_id" baseTableName="order_price" constraintName="fk_order_price_order_offer" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="cpq_order_offer" />
	</changeSet>

    <changeSet id="#5869_20210521" author="NabilOuachi">
        <addColumn tableName="cpq_quote_version">
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
        <sql>
            update ${db.schema.adapted}cpq_quote_version set created=${db.current.time} where created is null;
            update ${db.schema.adapted}cpq_quote_version set creator='applicationInitializer' where creator is null;
        </sql>
        <addNotNullConstraint tableName="cpq_quote_version" columnName="created"/>
    </changeSet>

    <changeSet id="#6122_20210524" author="AbdelmounaimAkadid" dbms="postgresql">
    	<sql>UPDATE ${db.schema.adapted}meveo_job_instance set cf_values = REPLACE(cf_values::TEXT, '"string":"DraftOnly"', '"listString":["DRAFT"]')::jsonb where job_template = 'XMLInvoiceGenerationJob';</sql>
    	<sql>UPDATE ${db.schema.adapted}meveo_job_instance set cf_values = REPLACE(cf_values::TEXT, '"string":"FinalOnly"', '"listString":["VALIDATED"]')::jsonb where job_template = 'XMLInvoiceGenerationJob';</sql>
   	</changeSet>

   	<changeSet   id="#20210123_540_281_1" author="TarikFA.">
        <sql>update ${db.schema.adapted}adm_role set uuid = 'role'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_2" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_quote_attribute set uuid = 'quote_attribute'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_3" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_order_attribute  set uuid = 'order_item'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_4" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_attribute_instance set uuid = 'attribute_instance'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_5" author="TarikFA.">
        <sql>update ${db.schema.adapted}ar_payment_token set uuid = 'payment_token'||id where uuid is null</sql>
    </changeSet>


    <changeSet id="#5599_20210526" author="AbdelmounaimAkadid">
    	<sql>CREATE INDEX idx_billing_invoice_agr_amount_on_aggr_id  ON billing_invoice_agr_amount (aggr_id)</sql>
    </changeSet>

    <changeSet id="#5416_20210526" author="AbdelmounaimAkadid">
    	<sql>CREATE INDEX idx_ar_ao_payment_histories__ao_id ON ar_ao_payment_histories(ao_id)</sql>
    </changeSet>

    <changeSet id="#533_20210526" author="NabilOuachi">
        <addColumn tableName="cpq_commercial_order">
            <column name="code" type="varchar(50)" />
            <column name="description" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#6147_20210530" author="anasseh">
	    <sql>CREATE INDEX idx_ar_payment_history_external_payment_id   ON ${db.schema.adapted}ar_payment_history (external_payment_id );</sql>
    </changeSet>

    <changeSet id="#559_20210603" author="TarikFA.">
    	<sql>update crm_customer_category set tax_category_id = -1 where tax_category_id is null</sql>
    	<addNotNullConstraint tableName="crm_customer_category" columnName="tax_category_id"/>
    </changeSet>

    <changeSet id="#20210608-540-527" author="Rachid.Aityaazza">
        <addColumn tableName="cpq_commercial_order">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>
    </changeSet>
        <changeSet id="#20210611-540-637" author="Rachid.Aityaazza">
        <addColumn tableName="cpq_quote_article_line">
            <column name="quote_version_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_article_line" constraintName="fk_quote_article_line_quote_version_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version"/>
    </changeSet>

 <changeSet id="#20210614_540_update_script_quotation_and_order" author="TarikFA.">

     <sql><![CDATA[update ${db.schema.adapted}meveo_script_instance
     			set script = 'package org.meveo.service.quote.script;

	public class QuoteValidation extends QuoteValidationScript {}'
	where code = 'org.meveo.api.billing.QuoteValidation'
        ]]></sql>

     <sql><![CDATA[update ${db.schema.adapted}meveo_script_instance
     			set script = 'package org.meveo.service.quote.script;

	public class OrderAdvancement extends OrderAdvancementScript {}'
	where code = 'org.meveo.api.billing.OrderAdvancement'
        ]]></sql>
    </changeSet>

    <changeSet id="#INTRD-242_20210623" author="ZBariki">
        <addColumn tableName="billing_billing_run">
            <column name="filters" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <dropNotNullConstraint columnDataType="datetime" columnName="last_transaction_date" tableName="billing_billing_run"/>
    </changeSet>

    <changeSet id="#20210622-INTRD-272" author="TarikFA.">
    	<sql>update ${db.schema.adapted}billing_tax_category set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_invoice_cat set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax_mapping set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax_class set version = 0 where version is null</sql>
    </changeSet>

    <changeSet id="#20210623-INTRD-277-quoteValidationScript" author="TarikFA.">
    	<preConditions onFail="MARK_RAN" onSqlOutput="TEST">
    		<sqlCheck expectedResult="0">select count(*) from ${db.schema.adapted}meveo_script_instance where code = 'org.meveo.service.quote.script.QuoteValidation'</sqlCheck>
    	</preConditions>
    	<sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-32, 0, 0, ${db.current.time}, 'org.meveo.service.quote.script.QuoteValidation', 'quote validation', 'JAVA', '
            package org.meveo.service.quote.script;
            public class QuoteValidation extends QuoteValidationScript {}
            ');]]>
        </sql>

        <insert tableName="adm_notification">
        	<column name="id" value="-55" />
        	<column name="version" value="0"/>
        	<column name="disabled" value="0"/>
        	<column name="created" value="${db.current.time}"/>
        	<column name="code" value="NOTIF_QUOTE_VALIDATION"/>
        	<column name="class_name_filter" value="org.meveo.model.cpq.CpqQuote"/>
        	<column name="event_expression_filter" value="#{event.status == 'ACCEPTED' }"/>
        	<column name="event_type_filter" value="STATUS_UPDATED"/>
        	<column name="creator" value="opencell.admin"/>
        	<column name="script_instance_id" value="-32"/>
        	<column name="uuid" value="GENERIC_UUID_CPQUOTE"/>
        	<column name="priority" value="0"/>
        	<column name="run_async" value="0"/>
        	<column name="save_successful_notif" value="1"/>
        </insert>

        <insert tableName="adm_notification_params">
        	<column name="notification_id" value="-55" />
        	<column name="params" value="#{event}" />
        	<column name="params_key" value="cpqQuote" />
        </insert>

        <insert tableName="adm_script_notification">
        	<column name="id" value="-55"/>
        </insert>

    </changeSet>

    <changeSet id="#20210623-INTRD-277-orderAdvacementScript" author="TarikFA.">
    	<preConditions onFail="MARK_RAN" onSqlOutput="TEST">
    		<sqlCheck expectedResult="0">select count(*) from ${db.schema.adapted}meveo_script_instance where code = 'org.meveo.service.quote.script.OrderAdvancement'</sqlCheck>
    	</preConditions>

    		<sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-33, 0, 0, ${db.current.time}, 'org.meveo.service.quote.script.OrderAdvancement', 'order advancemnt script', 'JAVA', '
            package org.meveo.service.quote.script;
            public class OrderAdvancement extends OrderAdvancementScript {}
            ');]]></sql>

            <insert tableName="adm_notification">
            	<column name="id" value="-56" />
            	<column name="version" value="0"/>
            	<column name="disabled" value="0"/>
            	<column name="created" value="${db.current.time}"/>
            	<column name="code" value="NOTIF_ORDER_ADVANCEMENT"/>
            	<column name="class_name_filter" value="org.meveo.model.cpq.commercial.CommercialOrder"/>
            	<column name="event_type_filter" value="ADVT_RATE_INCREASED"/>
            	<column name="creator" value="opencell.admin"/>
            	<column name="script_instance_id" value="-33"/>
            	<column name="uuid" value="GENERIC_UUID_ORDER"/>
            	<column name="priority" value="0"/>
            	<column name="run_async" value="0"/>
            	<column name="save_successful_notif" value="1"/>
            </insert>

            <insert tableName="adm_notification_params">
            	<column name="notification_id" value="-56" />
            	<column name="params" value="#{event}" />
            	<column name="params_key" value="commercialOrder" />
            </insert>

            <insert tableName="adm_script_notification">
            	<column name="id" value="-56"/>
            </insert>

    </changeSet>

    <changeSet id="#INTRD-339_20210625" author="ZBariki" failOnError="false">
        <addUniqueConstraint columnNames="code" constraintName="uk_genericSeq_9fnf93rp352nkw2kpdbari17yr"
                             deferrable="false" disabled="false" initiallyDeferred="false" tableName="generic_sequence" />
    </changeSet>

    <changeSet id="#INTRD-257_20210625" author="ZBariki" failOnError="false">
        <createSequence sequenceName="cust_query_seq" startValue="1" />
        <createTable tableName="cust_query">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cust_query_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="target_entity" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="visibility" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="filters" type="text" />
            <column name="generated_query" type="text" />
        </createTable>
        <addUniqueConstraint columnNames="code, creator, visibility" constraintName="uk_cust_query_composed"
                             deferrable="false" disabled="false" initiallyDeferred="false" tableName="cust_query" />

        <createTable tableName="custom_query_fields">
            <column name="id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="field" type="varchar(255)" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="custom_query_fields"
                                 constraintName="fk_custom_query_fields_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cust_query"/>
    </changeSet>
<!--
    <changeSet id="#INTRD-339_20210625" author="ZBariki">
        <addUniqueConstraint columnNames="code" constraintName="uk_genericSeq_9fnf93rp352nkw2kpdbari17yr"
                             deferrable="false" disabled="false" initiallyDeferred="false" tableName="generic_sequence" />
    </changeSet>
-->

    <changeSet id="#6168_20210624" author="HatimOUDAD">
        <addColumn tableName="com_meveo_instance">
            <column name="client_id" type="varchar(60)" />
            <column name="client_secret" type="varchar(60)" />
            <column name="authentication_type" type="varchar(60)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-257_20210706" author="ZBariki" failOnError="false">
        <dropForeignKeyConstraint baseTableName="custom_query_fields" constraintName="fk_custom_query_fields_id" />
        <dropUniqueConstraint tableName="custom_query_fields" constraintName="uk_cust_query_composed"
                              uniqueColumns="code, creator, visibility" />
        <renameTable newTableName="report_query" oldTableName="cust_query" />
        <renameTable newTableName="report_query_fields" oldTableName="custom_query_fields" />
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="report_query_fields"
                                 constraintName="fk_report_query_fields_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="report_query"/>
        <renameSequence newSequenceName="report_query_seq" oldSequenceName="cust_query_seq" />
        <addUniqueConstraint columnNames="code, creator, visibility" constraintName="uk_report_query_composed"
                             deferrable="false" disabled="false" initiallyDeferred="false" tableName="report_query" />
    </changeSet>

    <changeSet id="#INTRD-248_30062021" author="Mounir_BOUKAYOUA">
        <addColumn tableName="billing_charge_instance">
            <column name="reactivation_date" type="datetime" />
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="reactivation_date" type="datetime" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-682_20210707" author="HatimOUDAD" failOnError="false">
    	<createSequence sequenceName="query_scheduler_seq" startValue="1" />
        <createTable tableName="query_scheduler">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="query_scheduler_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="file_format" type="varchar(255)" />
            <column name="year" type="varchar(255)" />
            <column name="month" type="varchar(255)" />
            <column name="every_month" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="day_month" type="varchar(255)" />
            <column name="every_day_month" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="day_week" type="varchar(255)" />
            <column name="every_day_week" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="hour" type="varchar(255)" />
            <column name="every_hour" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="minute" type="varchar(255)" />
            <column name="every_minute" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="second" type="varchar(255)" />
            <column name="every_second" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="job_instance_id" type="bigint" />
            <column name="report_query_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="report_query_id" baseTableName="query_scheduler" constraintName="fk_report_query_scheduler" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="cust_query" />
        <addForeignKeyConstraint baseColumnNames="job_instance_id" baseTableName="query_scheduler" constraintName="fk_job_instance_scheduler" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="meveo_job_instance" />

        <createSequence sequenceName="query_result_seq" startValue="1" />
        <createTable tableName="query_scheduler_users">
			<column name="query_scheduler_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="user_id" type="bigint">
                <constraints nullable="false" />
            </column>
		</createTable>
		<addPrimaryKey columnNames="query_scheduler_id, user_id" constraintName="adm_query_scheduler_user_pkey" tableName="query_scheduler_users" />
        <addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="query_scheduler_users" constraintName="fk_query_scheduler_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="query_scheduler" />
        <addForeignKeyConstraint baseColumnNames="user_id" baseTableName="query_scheduler_users" constraintName="fk_user_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
        						onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_user" />


        <createTable tableName="query_scheduler_emails">
            <column name="query_scheduler_id"  type="bigint"/>
            <column name="emails"  type="varchar(100)"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="query_scheduler_emails" constraintName="fk_query_scheduler_emails" deferrable="false"
            initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="query_scheduler" />

        <createSequence sequenceName="query_execution_result_seq" startValue="1" />
        <createTable tableName="query_execution_result">
        <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="query_result_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
			<column name="start_date" type="datetime" />
			<column name="end_date" type="datetime" />
			<column name="execution_duration" type="bigint"/>
			<column name="file_path" type="varchar(255)" />
			<column name="line_count" type="int4"/>
			<column name="error_message" type="varchar(255)"/>
			<column name="status" type="varchar(255)">
	           <constraints nullable="false" />
	        </column>
	        <column name="query_execution_mode" type="varchar(255)">
	           <constraints nullable="false" />
	        </column>
	        <column name="query_scheduler_id" type="bigint" />
	        <column name="report_query_id" type="bigint" />
		</createTable>
		<addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="query_execution_result" constraintName="fk_scheduler_result" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="query_scheduler" />
        <addForeignKeyConstraint baseColumnNames="report_query_id" baseTableName="query_execution_result" constraintName="fk_report_query_execution" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="cust_query" />
    </changeSet>
    <changeSet id="#INTRD-634_20210706" author="Mbarek-Ay" failOnError="false">
        <createSequence sequenceName="dunning_settings_seq" startValue="1" />
        <createSequence sequenceName="dunning_pause_reasons_seq" startValue="1" />
        <createSequence sequenceName="dunning_stop_reasons_seq" startValue="1" />
        <createSequence sequenceName="dunning_collection_plan_statuses_seq" startValue="1" />
        <createSequence sequenceName="invoice_dunning_statuses_seq" startValue="1" />
        <createSequence sequenceName="dunning_collection_management_seq" startValue="1" />
        <createSequence sequenceName="dunning_payment_retries_seq" startValue="1" />

        <createTable tableName="dunning_settings">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_settings_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="dunning_mode" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="max_dunning_levels" type="int"/>
            <column name="max_days_outstanding" type="int"/>
            <column name="allow_interest_for_delay" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="interest_for_delay_rate" type="numeric(23, 12)" />
            <column name="allow_dunning_charges" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="apply_dunning_charge_fx_exchange_rate" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="accounting_article_id" type="bigint" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_dunning_settings" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_settings" />
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="dunning_settings"
                                 constraintName="fk_dunning_settings_accounting_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article"/>

         <createTable tableName="dunning_pause_reasons">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_pause_reasons_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>

            <column name="language" type="varchar(50)" />
            <column name="pause_reason" type="varchar(1000)" />
            <column name="description" type="varchar(255)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="dunning_pause_reasons"
                                 constraintName="fk_dunning_settings_pause_reasons_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

         <createTable tableName="dunning_stop_reasons">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_stop_reasons_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>

            <column name="language" type="varchar(50)" />
            <column name="stop_reason" type="varchar(1000)" />
            <column name="description" type="varchar(255)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="dunning_stop_reasons"
                                 constraintName="fk_dunning_settings_stop_reasons_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

        <createTable tableName="dunning_collection_plan_statuses">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_collection_plan_statuses_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>

            <column name="language" type="varchar(50)" />
            <column name="status" type="varchar(50)" />
            <column name="context" type="varchar(255)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="dunning_collection_plan_statuses"
                                 constraintName="fk_dunning_settings_collection_plan_statuses_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

         <createTable tableName="invoice_dunning_statuses">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="invoice_dunning_statuses_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>

            <column name="language" type="varchar(50)" />
            <column name="status" type="varchar(50)" />
            <column name="context" type="varchar(255)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="invoice_dunning_statuses"
                                 constraintName="fk_dunning_settings_invoice_statuses_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

         <createTable tableName="dunning_collection_management">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_collection_management_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
             <column name="include_collection_agency" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="email_collection_agency" type="varchar(100)" />
            <column name="agent_first_name_item" type="varchar(100)" />
            <column name="agent_last_name_item" type="varchar(100)" />
            <column name="agent_email_item" type="varchar(100)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="dunning_collection_management"
                                 constraintName="fk_dunning_settings_collection_management_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

       <createTable tableName="dunning_payment_retries">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_payment_retries_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
           <column name="payment_method" type="varchar(100)" >
               <constraints nullable="false" />
           </column>
            <column name="psp" type="varchar(255)" />
           <column name="num_pay_retries" type="int4" >
               <constraints nullable="false" />
           </column>
           <column name="pay_retry_frequency_unit" type="varchar(255)" >
               <constraints nullable="false" />
           </column>
           <column name="pay_retry_frequency" type="int4" >
               <constraints nullable="false" />
           </column>
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="dunning_payment_retries"
                                 constraintName="fk_dunning_settings_payment_retries_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>

 	</changeSet>

 	<changeSet id="#FIX-INTRD-634_20210706" author="AkadidAbdelmounaim" failOnError="false">
        <addColumn tableName="dunning_payment_retries">
            <column name="pay_retry_frequency" type="int4" defaultValueNumeric="0">
             	<constraints nullable="false" />
           	</column>
        </addColumn>
    </changeSet>

    <changeSet id="#FIX2-INTRD-634_20210706" author="AkadidAbdelmounaim" failOnError="false">
    	<createTable tableName="invoice_dunning_statuses">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="invoice_dunning_statuses_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>

            <column name="language" type="varchar(50)" />
            <column name="status" type="varchar(50)" />
            <column name="context" type="varchar(255)" />
            <column name="dunning_settings_id" type="bigint" >
                <constraints nullable="false" />
            </column>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_settings_id" baseTableName="invoice_dunning_statuses"
                                 constraintName="fk_dunning_settings_invoice_statuses_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_settings"/>
    </changeSet>

    <changeSet id="#INTRD-254_20210706" author="AmineBENAICHA">
        <addColumn tableName="billing_wallet_operation">
            <column name="old_wallet_id" type="bigint" />
        </addColumn>
        <!-- recreate view billing_wallet_operation_period that depends on billing_wallet_operation -->
        <dropView viewName="billing_wallet_operation_period"/>
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>

    <changeSet id="#INTRD-828_20210817" author="AndriusKarpavicius">
        <renameColumn tableName="cat_offer_template_category" oldColumnName="level" newColumnName="order_level"/>
        <renameColumn tableName="adm_notif_webhooks" oldColumnName="password" newColumnName="pswd"/>
        <renameColumn tableName="ar_customer_account" oldColumnName="password" newColumnName="pswd"/>
        <renameColumn tableName="com_sender_config" oldColumnName="password" newColumnName="pswd"/>
    </changeSet>

    <!--  Fix for ERROR: cannot alter type of a column used by a view or rule (drop) -->
    <changeSet id="#INTRD-828-drop-view" author="AbdelmounaimAkadid">
    	<dropView viewName="billing_wallet_operation_period"/>
    </changeSet>

    <changeSet id="#INTRD-828_20210824" author="AndriusKarpavicius" dbms="postgresql">
        <sql>alter table account_entity alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table adm_notification alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table adm_role alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table adm_user alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_account_operation alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_ddrequest_builder alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_other_transaction alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_payment_gateway alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_payment_schedule_inst alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_payment_schedule_tmpl alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ar_payment_token alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_accounting_article alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_article_family alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_billing_run alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_charge_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_cycle alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_discount_plan_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_invoice alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_invoice_cat alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_invoice_sub_cat alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_invoice_type alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_product_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_rated_transaction alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_service_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_subscription alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_tax alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_tax_category alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_tax_class alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_trading_country alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table billing_wallet_operation alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_charge_template alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_discount_plan alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_discount_plan_item alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_offer_template alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_offer_template_category alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_price_plan_matrix alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cat_service_template alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_attribute alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_attribute_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_commercial_order alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_contract alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_contract_item alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_grouped_attributes alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_invoicing_plan alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_invoicing_plan_item alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_media alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_order_attribute alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_order_lot alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_order_offer alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_order_product alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_product alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_product_line alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_quote_attribute alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_quote_lot alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_quote_product alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cpq_quote_version alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table crm_customer_category alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table crm_provider alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table cust_cei alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table document alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table document_category alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table dwh_report_extract alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table medina_access alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table meveo_filter alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table meveo_job_instance alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ord_order alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ord_order_item alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table ord_quote alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table quote_offer alter column cf_values type jsonb using cf_values::jsonb</sql>
        <sql>alter table wf_generic_workflow alter column cf_values type jsonb using cf_values::jsonb</sql>
    </changeSet>

    <changeSet id="#INTRD-828_20210902" author="AbdelmounaimAkadid" dbms="postgresql">
        <sql>alter table report_query alter column filters type jsonb using filters::jsonb</sql>
        <sql>alter table billing_billing_run alter column filters type jsonb using filters::jsonb</sql>
       	<sql>alter table bi_data_collector alter column parameters type jsonb using parameters::jsonb</sql>
       	<sql>alter table bi_data_collector alter column aliases type jsonb using aliases::jsonb</sql>
       	<sql>alter table cat_offer_template alter column long_description_i18n type jsonb using long_description_i18n::jsonb</sql>
       	<sql>alter table crm_custom_action alter column label_i18n type jsonb using label_i18n::jsonb</sql>
       	<sql>alter table adm_currency alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_accounting_article alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_article_family alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_cycle alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table adm_country alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_invoice_cat alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_invoice_sub_cat alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table adm_language alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_subscrip_termin_reason alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_tax alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_business_offer_model alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_business_product_model alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_business_serv_model alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_calendar alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_channel alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_charge_template alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_offer_template_category alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_price_plan_matrix alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_offer_template alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_service_template alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table cat_unit_of_measure alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table crm_customer_category alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table crm_custom_field_tmpl alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table document alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table document_category alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table dwh_measurable_quant alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table ar_credit_category alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table adm_title alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_tax_category alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table billing_tax_class alter column description_i18n type jsonb using description_i18n::jsonb</sql>
       	<sql>alter table adm_role_secured_entity alter column disable DROP DEFAULT</sql>
       	<sql>alter table adm_role_secured_entity alter column disable type ${type.boolean} using disable::${type.boolean}</sql>
       	<sql>alter table adm_role_secured_entity alter column disable SET DEFAULT 0</sql>
       	<sql>alter table adm_secured_entity alter column disable DROP DEFAULT</sql>
       	<sql>alter table adm_secured_entity alter column disable type ${type.boolean} using disable::${type.boolean}</sql>
       	<sql>alter table adm_secured_entity alter column disable SET DEFAULT 0</sql>
       	<sql>alter table billing_billing_run alter column compute_dates_validation DROP DEFAULT</sql>
       	<sql>alter table billing_billing_run alter column compute_dates_validation type ${type.boolean} using compute_dates_validation::${type.boolean}</sql>
       	<sql>alter table billing_billing_run alter column compute_dates_validation SET DEFAULT 0</sql>
       	<sql>alter table dwh_report_extract_execution alter column status type ${type.boolean} using status::${type.boolean}</sql>
   	</changeSet>

    <changeSet id="#INTRD-828_20210824-accum" author="AndriusKarpavicius">
        <sql>alter table account_entity drop column cf_values_accum</sql>
        <sql>alter table adm_notification drop column cf_values_accum</sql>
        <sql>alter table adm_role drop column cf_values_accum</sql>
        <sql>alter table adm_user drop column cf_values_accum</sql>
        <sql>alter table ar_account_operation drop column cf_values_accum</sql>
        <sql>alter table ar_ddrequest_builder drop column cf_values_accum</sql>
        <sql>alter table ar_other_transaction drop column cf_values_accum</sql>
        <sql>alter table ar_payment_gateway drop column cf_values_accum</sql>
        <sql>alter table ar_payment_schedule_inst drop column cf_values_accum</sql>
        <sql>alter table ar_payment_schedule_tmpl drop column cf_values_accum</sql>
        <sql>alter table ar_payment_token drop column cf_values_accum</sql>
        <sql>alter table billing_accounting_article drop column cf_values_accum</sql>
        <sql>alter table billing_article_family drop column cf_values_accum</sql>
        <sql>alter table billing_billing_run drop column cf_values_accum</sql>
        <sql>alter table billing_charge_instance drop column cf_values_accum</sql>
        <sql>alter table billing_cycle drop column cf_values_accum</sql>
        <sql>alter table billing_discount_plan_instance drop column cf_values_accum</sql>
        <sql>alter table billing_invoice drop column cf_values_accum</sql>
        <sql>alter table billing_invoice_cat drop column cf_values_accum</sql>
        <sql>alter table billing_invoice_sub_cat drop column cf_values_accum</sql>
        <sql>alter table billing_invoice_type drop column cf_values_accum</sql>
        <sql>alter table billing_product_instance drop column cf_values_accum</sql>
        <sql>alter table billing_rated_transaction drop column cf_values_accum</sql>
        <sql>alter table billing_service_instance drop column cf_values_accum</sql>
        <sql>alter table billing_subscription drop column cf_values_accum</sql>
        <sql>alter table billing_tax drop column cf_values_accum</sql>
        <sql>alter table billing_tax_category drop column cf_values_accum</sql>
        <sql>alter table billing_tax_class drop column cf_values_accum</sql>
        <sql>alter table billing_trading_country drop column cf_values_accum</sql>
        <sql>alter table billing_wallet_operation drop column cf_values_accum</sql>
        <sql>alter table cat_charge_template drop column cf_values_accum</sql>
        <sql>alter table cat_discount_plan drop column cf_values_accum</sql>
        <sql>alter table cat_discount_plan_item drop column cf_values_accum</sql>
        <sql>alter table cat_offer_template drop column cf_values_accum</sql>
        <sql>alter table cat_offer_template_category drop column cf_values_accum</sql>
        <sql>alter table cat_price_plan_matrix drop column cf_values_accum</sql>
        <sql>alter table cat_service_template drop column cf_values_accum</sql>
        <sql>alter table cpq_attribute drop column cf_values_accum</sql>
        <sql>alter table cpq_attribute_instance drop column cf_values_accum</sql>
        <sql>alter table cpq_commercial_order drop column cf_values_accum</sql>
        <sql>alter table cpq_contract drop column cf_values_accum</sql>
        <sql>alter table cpq_contract_item drop column cf_values_accum</sql>
        <sql>alter table cpq_grouped_attributes drop column cf_values_accum</sql>
        <sql>alter table cpq_invoicing_plan drop column cf_values_accum</sql>
        <sql>alter table cpq_invoicing_plan_item drop column cf_values_accum</sql>
        <sql>alter table cpq_media drop column cf_values_accum</sql>
        <sql>alter table cpq_order_attribute drop column cf_values_accum</sql>
        <sql>alter table cpq_order_lot drop column cf_values_accum</sql>
        <sql>alter table cpq_order_offer drop column cf_values_accum</sql>
        <sql>alter table cpq_order_product drop column cf_values_accum</sql>
        <sql>alter table cpq_product drop column cf_values_accum</sql>
        <sql>alter table cpq_product_line drop column cf_values_accum</sql>
        <sql>alter table cpq_quote_attribute drop column cf_values_accum</sql>
        <sql>alter table cpq_quote_lot drop column cf_values_accum</sql>
        <sql>alter table cpq_quote_product drop column cf_values_accum</sql>
        <sql>alter table cpq_quote_version drop column cf_values_accum</sql>
        <sql>alter table crm_customer_category drop column cf_values_accum</sql>
        <sql>alter table crm_provider drop column cf_values_accum</sql>
        <sql>alter table cust_cei drop column cf_values_accum</sql>
        <sql>alter table document drop column cf_values_accum</sql>
        <sql>alter table document_category drop column cf_values_accum</sql>
        <sql>alter table dwh_report_extract drop column cf_values_accum</sql>
        <sql>alter table medina_access drop column cf_values_accum</sql>
        <sql>alter table meveo_filter drop column cf_values_accum</sql>
        <sql>alter table meveo_job_instance drop column cf_values_accum</sql>
        <sql>alter table ord_order drop column cf_values_accum</sql>
        <sql>alter table ord_order_item drop column cf_values_accum</sql>
        <sql>alter table ord_quote drop column cf_values_accum</sql>
        <sql>alter table quote_offer drop column cf_values_accum</sql>
        <sql>alter table wf_generic_workflow drop column cf_values_accum</sql>
    </changeSet>

    <!--  Fix for ERROR: cannot alter type of a column used by a view or rule (recreation) -->
    <changeSet author="AbdelmounaimAkadid" id="#INTRD-828-create-view-fix" dbms="postgresql">
    	<createView replaceIfExists="true" viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>
    <changeSet author="AbdelmounaimAkadid" id="#INTRD-828-create-view-oracle" dbms="oracle">
    	<createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (trunc(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id)) = trunc(o.start_date)) then 0 else 1 end) as flag
            FROM billing_wallet_operation o
            WHERE o.status = 'OPEN') o
        </createView>
    </changeSet>


    <changeSet id="#INTRD-264_20210714" author="HatimOUDAD">
    	<addColumn tableName="query_scheduler">
           <column name="code" type="varchar(255)"/>
           <column name="description" type="varchar(255)" />
       </addColumn>
    </changeSet>

    <changeSet id="#INTRD-1090_20210714" author="ZBariki">
        <addColumn tableName="cpq_invoice_line">
            <column name="aggregate_id_f" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="aggregate_id_f" baseTableName="cpq_invoice_line"
                                 constraintName="fk_il_aggregate_id_f" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice_agregate" />
    </changeSet>

    <changeSet id="#INTRD-1441_20210728" author="TarikFA.">
    	<createTable tableName="cpq_quote_media">
    		<column name="quote_id" type="bigint" />
    		<column name="media_id" type="bigint" />
    	</createTable>

    	<addPrimaryKey columnNames="quote_id, media_id" tableName="cpq_quote_media"/>
        <addForeignKeyConstraint baseColumnNames="quote_id" baseTableName="cpq_quote_media"
                                 constraintName="fk_cpq_quote_media_quote_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_quote"/>
        <addForeignKeyConstraint baseColumnNames="media_id" baseTableName="cpq_quote_media"
                                 constraintName="fk_cpq_quote_media_media_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_media"/>

    </changeSet>

    <changeSet id="#5595_540582_20210528" author="TarikFA.">
    	 <dropColumn tableName="cpq_attribute">
            <column name="sequence"/>
        </dropColumn>

        <addColumn tableName="cpq_attribute_instance">
        	<column name="boolean_value" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cpq_order_attribute">
        	<column name="boolean_value" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cpq_quote_attribute">
        	<column name="boolean_value" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cpq_price_plan_matrix_value">
        	<column name="boolean_value" type="${type.boolean}" />
        </addColumn>
    </changeSet>
   <changeSet id="#5595_540582_20210528_2" author="TarikFA.">
   		<preConditions onSqlOutput="TEST" onFail="MARK_RAN">
   			<not>
   				<columnExists tableName="cpq_product_version_attributes" columnName="sequence"/>
   			</not>
   		</preConditions>
        <createSequence sequenceName="cpq_product_version_attribute_seq" />
        <addColumn tableName="cpq_product_version_attributes">
            <column name="sequence" type="INT4" defaultValue="0" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int4" defaultValue="0" />
        </addColumn>
        <sql>ALTER TABLE  ${db.schema.adapted}cpq_product_version_attributes ADD COLUMN id SERIAL PRIMARY KEY</sql>
        <sql>ALTER TABLE  ${db.schema.adapted}cpq_product_version_attributes ALTER COLUMN id TYPE int8 USING id::int8;</sql>
    </changeSet>

    <changeSet id="#INTRD-754_20210727" author="AmineBENAICHA">
        <addColumn tableName="meveo_job_instance">
            <column name="query_scheduler_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="meveo_job_instance" constraintName="fk_query_scheduler_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="query_scheduler" />
    </changeSet>

    <changeSet id="INTRD-1221_20210803" author="TarikFA.">
    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_SUBSCRIPTION" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'SUBSCRIPTION')</where>
    	</update>

    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_TERMINATION" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'TERMINATION')</where>
    	</update>

    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_OTHER" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'OTHER')</where>
    	</update>

    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_OTHER" />
    		<where>charge_template_id  is null</where>
    	</update>
    </changeSet>

    <changeSet id="#INTRD-1174_20210802" author="ZBariki">
        <addColumn tableName="report_query">
            <column name="sort_by" type="varchar(255)" />
            <column name="sort_order" type="varchar(15)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-760_13072021" author="MohammedELAZZOUZI">
    	<addColumn tableName="billing_billing_run">
            <column name="invoice_type_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="billing_billing_run" constraintName="fk__billing_billing_run__invoice_type" deferrable="false"
            initiallyDeferred="false" onDelete="CASCADE" onUpdate="CASCADE" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>

	<changeSet id="#INTRD-1291_20210804" author="HatimOUDAD">
    	<createSequence sequenceName="accounting_period_seq" startValue="1" />
        <createTable tableName="accounting_period">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="accounting_period_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="accounting_period_year" type="int4" />
            <column name="status" type="varchar(255)"/>
            <column name="sub_accounting_period_type" type="varchar(255)"/>
            <column name="sub_accounting_period_progress" type="varchar(255)"/>
            <column name="ongoing_sub_accounting_periods" type="varchar(255)"/>
        </createTable>

        <createSequence sequenceName="sub_accounting_period_seq" startValue="1" />
        <createTable tableName="sub_accounting_period">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="sub_accounting_period_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="number" type="int4" />
            <column name="start_date" type="datetime" />
			<column name="end_date" type="datetime" />
            <column name="regular_users_sub_period_status" type="varchar(255)"/>
            <column name="regular_users_closed_date" type="datetime"/>
            <column name="effective_closed_date" type="datetime"/>
            <column name="accounting_period_id" type="bigint"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="accounting_period_id" baseTableName="sub_accounting_period" constraintName="fk_accounting_period" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="accounting_period" />
	</changeSet>

	<changeSet id="#INTRD-1275_20210805" author="ZBariki">
        <addColumn tableName="ar_account_operation">
            <column name="status" type="varchar(20)" />
            <column name="reason" type="varchar(30)" />
            <column name="accounting_export_file" type="varchar(255)" />
        </addColumn>
    </changeSet>
   <changeSet id="INTRD-1310_050821" author="Mbarek-Ay">
     <addColumn tableName="billing_subscription">
            <column name="order_offer_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_order_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>
	<changeSet id="#INTRD-1313_20210809" author="HatimOUDAD">
    	<createSequence sequenceName="journal_seq" startValue="1" />
        <createTable tableName="journal">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="journal_pkey" />
            </column>
           	<column name="code" type="varchar(255)"/>
         	<column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

        </createTable>
        <addColumn tableName="ar_occ_template">
            <column name="journal_id" type="bigint" />
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="journal_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="journal_id" baseTableName="ar_occ_template" constraintName="fk_journal_template_scheduler" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="journal" />
        <addForeignKeyConstraint baseColumnNames="journal_id" baseTableName="ar_account_operation" constraintName="fk_journal_account_operation_scheduler" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="journal" />
		</changeSet>

	<changeSet id="#INTRD-1357_10082021" author="AmineBENAICHA">
    	<addColumn tableName="ar_account_operation">
            <column name="accounting_date" type="datetime"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-1380_11082021" author="AmineBENAICHA">
    	<addColumn tableName="accounting_period">
            <column name="accounting_operation_action" type="varchar(255)" />
            <column name="regular_user_lock_option" type="varchar(255)" />
            <column name="custom_lock_number_days" type="int4" />
            <column name="custom_lock_option" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-1277_20210810" author="AmineBENAICHA">
    	<addNotNullConstraint tableName="accounting_period" columnName="accounting_period_year" columnDataType="int4"/>
        <addUniqueConstraint tableName="accounting_period" columnNames="accounting_period_year" constraintName="uc_accounting_period_year" />
    </changeSet>

     <changeSet id="#INTRD-1365-12082021" author="Mbarek-Ay">
        <addDefaultValue  tableName="cpq_quote_price" columnName="price_over_charged" defaultValueNumeric="0" />
    </changeSet>

    <changeSet id="#INTRD-1396_20210812" author="ZBariki">
        <addColumn tableName="cpq_attribute">
            <column name="validation_type" type="varchar(10)" />
            <column name="validation_pattern" type="varchar(2000)" />
            <column name="validation_label" type="varchar(255)" />
        </addColumn>
    </changeSet>
	<changeSet id="#INTRD-1384_17082021" author="YoussefIZEM">
		<addColumn tableName="billing_billing_run">
			<column name="run_type" type="varchar(255)" />
		</addColumn>
		<update tableName="billing_billing_run">
			<column name="run_type" value="EXCEPTIONAL"/>
			<where>billing_cycle_id is null</where>
		</update>
		<update tableName="billing_billing_run">
			<column name="run_type" value="CYCLE"/>
			<where>billing_cycle_id is not null</where>
		</update>
	</changeSet>
	<changeSet id="#INTRD-689_20210818" author="RAityaazza">
        <addColumn tableName="sub_accounting_period">
            <column name="all_users_sub_period_status" type="varchar(255)"/>
        </addColumn>
    </changeSet>
	<changeSet id="#INTRD-1461_20210820" author="MohammedELAZZOUZI">
		<sql>alter table ${db.schema.adapted}accounting_period alter column accounting_period_year type character varying(20);</sql>
		<addColumn tableName="accounting_period">
            <column name="end_date" type="datetime"><constraints nullable="false" unique="true"/></column>
            <column name="use_sub_accounting_cycles" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD_1609_20210902" author="TarikFA.">
    	<addColumn tableName="accounting_period">
    		<column name="force_option" type="varchar(50)" />
    		<column name="force_custom_day" type="int4" />
    	</addColumn>
    </changeSet>

	<changeSet id="#INTRD-1386_05092021" author="Mbarek-Ay">

	 <preConditions onFail="MARK_RAN">
     <foreignKeyConstraintExists foreignKeyName="fk__ord_quote__cat_discount_plan"/>
     <foreignKeyConstraintExists foreignKeyName="fk_cpq_quote_contract_id"/>
     <tableExists tableName="cpq_quote_media"/>
      </preConditions>

	<addColumn tableName="cpq_quote_version">
	<column name="discount_plan_id" type="bigint"/>
	<column name="xml_filename" type="varchar(255)" />
	<column name="pdf_filename" type="varchar(255)" />
	<column name="contract_id" type="bigint"/>
	</addColumn>

	<createTable tableName="cpq_quote_version_media">
	<column name="cpq_quote_version_id" type="bigint" />
	<column name="cpq_media_id" type="bigint" />
	</createTable>

	<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_discount_plan" deferrable="false" initiallyDeferred="false"
	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

	<addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_contract_id" deferrable="false" initiallyDeferred="false"
	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />


	<addPrimaryKey columnNames="cpq_quote_version_id, cpq_media_id" tableName="cpq_quote_version_media"/>
	        <addForeignKeyConstraint baseColumnNames="cpq_quote_version_id" baseTableName="cpq_quote_version_media"
	                                 constraintName="fk_cpq_quote_version_media_id" deferrable="false"
	                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
	                                 referencedColumnNames="id" referencedTableName="cpq_quote_version"/>
	        <addForeignKeyConstraint baseColumnNames="cpq_media_id" baseTableName="cpq_quote_version_media"
	                                 constraintName="fk_cpq_media_quote_version_id" deferrable="false"
	                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
	                                 referencedColumnNames="id" referencedTableName="cpq_media"/>

	<sql>update ${db.schema.adapted}cpq_quote_version  set discount_plan_id=q.discount_plan_id from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.discount_plan_id is not null</sql>

	<sql>update ${db.schema.adapted}cpq_quote_version  set xml_filename=q.xml_filename from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.xml_filename is not null</sql>

	<sql>update ${db.schema.adapted}cpq_quote_version  set pdf_filename=q.pdf_filename from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.pdf_filename is not null</sql>

	<sql>update ${db.schema.adapted}cpq_quote_version  set contract_id=q.contract_id from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.contract_id is not null</sql>

	<sql>INSERT INTO  ${db.schema.adapted}cpq_quote_version_media(cpq_quote_version_id, cpq_media_id) SELECT quote_id, media_id FROM cpq_quote_media </sql>



	 <dropColumn tableName="cpq_quote">
     <column name="discount_plan_id"></column>
     <column name="xml_filename"></column>
     <column name="pdf_filename"></column>
     <column name="contract_id"></column>
     </dropColumn>

     <dropForeignKeyConstraint baseTableName="cpq_quote" constraintName="fk__ord_quote__cat_discount_plan"/>
     <dropForeignKeyConstraint baseTableName="cpq_quote" constraintName="fk_cpq_quote_contract_id"/>
     <dropTable tableName="cpq_quote_media"/>


   </changeSet>
    <changeSet id="#INTRD-1654_20210902" author="AndriusKarpavicius">
	   <dropColumn tableName="billing_cycle" columnName="due_date_delay_el_sp"/>
       <dropColumn tableName="billing_cycle" columnName="invoice_type_el_sp"/>
       <dropColumn tableName="billing_service_instance" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="billing_service_instance" columnName="minimum_label_el_sp"/>
       <dropColumn tableName="cat_service_template" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="cat_service_template" columnName="minimum_label_el_sp"/>
       <dropColumn tableName="billing_subscription" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="billing_subscription" columnName="minimum_label_el_sp"/>
       <dropColumn tableName="account_entity" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="account_entity" columnName="minimum_label_el_sp"/>
       <dropColumn tableName="cat_offer_template" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="cat_offer_template" columnName="minimum_label_el_sp"/>
       <dropColumn tableName="billing_tax_mapping" columnName="filter_el_sp"/>
       <dropColumn tableName="billing_tax_mapping" columnName="tax_el_sp"/>
       <dropColumn tableName="ar_customer_account" columnName="due_date_delay_el_sp"/>
       <dropColumn tableName="ord_order" columnName="due_date_delay_el_sp"/>
       <dropColumn tableName="crm_customer_category" columnName="exoneration_tax_el_sp"/>
       <dropColumn tableName="crm_customer_category" columnName="tax_category_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="subscription_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="condition_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="quantity_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="param_1_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="param_2_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="param_3_el_sp"/>
       <dropColumn tableName="cat_triggered_edr" columnName="param_4_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="criteria_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="amount_without_tax_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="amount_with_tax_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="wo_description_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="total_amount_el_sp"/>
       <dropColumn tableName="cat_price_plan_matrix" columnName="minimum_amount_el_sp"/>
       <dropColumn tableName="cat_discount_plan_item" columnName="expression_el_sp"/>
       <dropColumn tableName="cat_discount_plan_item" columnName="discount_value_el_sp"/>
       <dropColumn tableName="cat_charge_template" columnName="filter_el_sp"/>
       <dropColumn tableName="cat_charge_template" columnName="tax_class_el_sp"/>
       <dropColumn tableName="cat_calendar" columnName="init_date_el_sp"/>
    </changeSet>

     <changeSet author="TarikFA." id="INTRD_1687_20210906">
          <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_subscription_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
          <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_charge_instance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
    </changeSet>

	<changeSet id="#INTRD-1651_03092021" author="HatimOUDAD">
    	<addColumn tableName="sub_accounting_period">
            <column name="regularusers_reopening_reason" type="varchar(2000)" />
            <column name="allusers_reopening_reason" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#6149_20210531" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction">
            <column name="invoicing_date" type="datetime" />
        </addColumn>
        <sql>update ${db.schema.adapted}billing_rated_transaction set invoicing_date = wo.invoicing_date from ${db.schema.adapted}billing_wallet_operation wo where wo.rated_transaction_id=billing_rated_transaction.id and wo.invoicing_date is not null </sql>
    </changeSet>


    <changeSet id="#6117_20210608" author="AndriusKarpavicius">
        <createTable tableName="billing_rated_transaction_pending" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_rt_pending_pk"/>
            </column>
            <column name="aggregate_id_f" type="bigint" />
            <column name="invoice_id" type="bigint" />
            <column name="billing_run_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet id="#INTRD-1581_20210902" author="AbdelkaderBouazza">
        <addColumn tableName="billing_subscription">
            <column name="version_number" type="int" defaultValue="1"/>
            <column name="next_version" type="bigint">
                <constraints nullable="true" />
            </column>
            <column name="previous_version" type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_next_subscription_id" referencedTableName="billing_subscription"
                                 baseColumnNames="next_version" baseTableName="billing_subscription" referencedColumnNames="id"/>
        <addForeignKeyConstraint constraintName="fk_billing_previous_subscription_id" referencedTableName="billing_subscription"
                                 baseColumnNames="previous_version" baseTableName="billing_subscription" referencedColumnNames="id"/>
    </changeSet>


    <changeSet id="INTRD_1629_20210914" author="TarikFA.">

        <preConditions onFail="MARK_RAN">
            <tableExists tableName="collection_plan_status"/>
        </preConditions>


	    <createSequence sequenceName="collection_plan_status_seq"/>
	    	<createTable tableName="collection_plan_status">
	            <column name="id" type="bigint" autoIncrement="${id.auto}">
	                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_collection_plan_status" />
	            </column>
	            <column name="created" type="datetime">
	                <constraints nullable="false" />
	            </column>
	            <column name="updated" type="datetime" />
	            <column name="creator" type="varchar(100)" />
	            <column name="updater" type="varchar(100)" />
	            <column name="version" type="int4" />
	            <column name="dunning_settings_id" type="bigint" />
	            <column name="language" type="${type.json}" />
	            <column name="status" type="varchar(255)" >
	            	<constraints unique="true"/>
	            </column>
	            <column name="context" type="varchar(255)" />
	    	</createTable>
	    	<addForeignKeyConstraint constraintName="fk_collection_plan_status_dunning_settings_id"
	    							 referencedTableName="dunning_settings"
	    							 baseColumnNames="dunning_settings_id"
	    							 baseTableName="collection_plan_status"
	    							 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-1707_20210917" author="AbdelkaderBouazza">
        <addColumn tableName="ar_account_operation">
            <column name="operation_action" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="INTRD_1782_20210913" author="TarikFA.">
    	<addColumn tableName="cpq_product_version_attributes">
    		<column name="mandatorwith_el" type="varchar(255)"/>
    	</addColumn>
    </changeSet>

    <changeSet id="INTRD_1794_20210917" author="TarikFA.">
    	<preConditions onFail="MARK_RAN" onSqlOutput="TEST">
    			<columnExists tableName="cpq_product_version_attributes" columnName="mandatory"/>
    	</preConditions>
    	<dropColumn tableName="cpq_product_version_attributes">
    		<column name="mandatory" />
    		<column name="priority" />
    		<column name="display" />
    	</dropColumn>
    </changeSet>

    <changeSet id="INTRD-1901_20210920" author="TarikFA.">
    	<createSequence sequenceName="offer_template_attribute_seq"/>
    	<createTable tableName="offer_template_attribute">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_offer_template_attribute_pk"/>
            </column>
            <column name="version" type="int4" defaultValue="0" />
    		<column name="mandatorwith_el" type="varchar(255)"/>
            <column name="offer_template_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="sequence" type="INT4" defaultValue="0" />
    	</createTable>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="offer_template_attribute" constraintName="offer_template_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="offer_template_attribute" constraintName="offer_template_attribute_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

    </changeSet>

    <changeSet id="INTRD-1924_20210922" author="TarikFA.">
    	<addColumn tableName="cpq_product_version_attributes">
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="false"/>
            </column>
            <column name="read_only" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="display" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="default_value" type="varchar(255)" />
            <column name="validation_type" type="varchar(10)" />
            <column name="validation_pattern" type="varchar(2000)" />
            <column name="validation_label" type="varchar(255)" />
    	</addColumn>
    </changeSet>

    <changeSet id="INTRD-1925_20210922" author="TarikFA.">
    	<addColumn tableName="offer_template_attribute">
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="false"/>
            </column>
            <column name="read_only" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="display" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="default_value" type="varchar(255)" />
            <column name="validation_type" type="varchar(10)" />
            <column name="validation_pattern" type="varchar(2000)" />
            <column name="validation_label" type="varchar(255)" />
    	</addColumn>

        <sql>INSERT INTO ${db.schema.adapted}offer_template_attribute
             (id, attribute_id, offer_template_id, mandatory, read_only, sequence,
              display, default_value, validation_label, validation_pattern, validation_type)
            SELECT nextval('offer_template_attribute_seq') as next_id,att.id as attribute_id, coa.offer_template_id,
                    att.mandatory, att.read_only, att.sequence,
                    att.display, att.default_value, att.validation_label, att.validation_pattern, att.validation_type
             FROM ${db.schema.adapted}cpq_attribute att left join ${db.schema.adapted}cpq_offer_attributes coa
                 on att.id = coa.attribute_id
             WHERE att.id = coa.attribute_id;</sql>
        <sql>UPDATE ${db.schema.adapted}cpq_product_version_attributes cpva
             SET display = att.display,
                 read_only = att.read_only,
                 mandatory = att.mandatory,
                 default_value = att.default_value,
                 validation_type = att.validation_type,
                 validation_pattern = att.validation_pattern,
                 validation_label = att.validation_label
                 FROM ${db.schema.adapted}cpq_attribute att
             WHERE cpva.attribute_id = att.id;</sql>
		<dropColumn tableName="cpq_attribute">
			<column name="mandatory"/>
			<column name="read_only"/>
			<column name="display"/>
			<column name="default_value"/>
			<column name="validation_pattern"/>
			<column name="validation_label"/>
		</dropColumn>

    </changeSet>
   <changeSet id="INTRD_1985_20210923" author="TarikFA.">
   		<addColumn tableName="quote_offer">
			<column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
   		</addColumn>
   		<addUniqueConstraint columnNames="code, quote_version_id" tableName="quote_offer"/>

   		<addColumn tableName="cpq_order_offer">
			<column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
   		</addColumn>
   		<addUniqueConstraint columnNames="code, order_id" tableName="cpq_order_offer"/>
   </changeSet>


    <changeSet id="#INTRD-1692_20210906" author="AndriusKarpavicius">
        <addColumn tableName="billing_wallet_operation">
            <column name="user_account_id" type="bigint" />
            <column name="billing_account_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-1692_20210906-pg" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_wallet_operation set user_account_id = wi.user_account_id from ${db.schema.adapted}billing_wallet wi where wallet_id=wi.id and wallet_id is not null</sql>
        <sql>update ${db.schema.adapted}billing_wallet_operation set billing_account_id = ua.billing_account_id from ${db.schema.adapted}billing_user_account ua where user_account_id=ua.id and user_account_id is not null</sql>
    </changeSet>

    <changeSet id="#INTRD-1692_20210907" author="AndriusKarpavicius">
        <createTable tableName="billing_wallet_operation_pending" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_wo_pending_pk"/>
            </column>
            <column name="rated_transaction_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet id="#INTRD-1692_20210908" author="AndriusKarpavicius">
        <alterSequence sequenceName="billing_rated_transaction_seq" incrementBy="500"/>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_RatedTransactionsJob' and code='batchSize'</sql>
    </changeSet>


    <changeSet id="#INTRD-754_20210915" author="AndriusKarpavicius" dbms="postgresql">
        <dropForeignKeyConstraint baseTableName="meveo_job_instance" constraintName="fk_query_scheduler_id"/>
        <addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="meveo_job_instance" constraintName="fk_job_query_scheduler_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="query_scheduler" />
        <dropForeignKeyConstraint baseTableName="query_scheduler_users" constraintName="fk_query_scheduler_id"/>
        <addForeignKeyConstraint baseColumnNames="query_scheduler_id" baseTableName="query_scheduler_users" constraintName="fk_usr_query_scheduler_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="query_scheduler" />

    </changeSet>

    <changeSet id="#INTRD-1994_20210923" author="AndriusKarpavicius">
        <alterSequence sequenceName="rating_edr_seq" incrementBy="500"/>
        <alterSequence sequenceName="rating_cdr_seq" incrementBy="500"/>
    </changeSet>

     <changeSet id="INTRD-2046_20210927" author="Mbarek-Ay">
     <addColumn tableName="cpq_invoice_line">
            <column name="cpq_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />
    </changeSet>

    <changeSet id="#INTRD-2184_20211004" author="MohamedSTITANE">
        <addColumn tableName="query_scheduler">
            <column name="is_query_scheduler" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="#6117_20210622" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction_pending" >
            <column name="unit_amount_without_tax" type="numeric(23, 12)" />
            <column name="unit_amount_with_tax" type="numeric(23, 12)" />
            <column name="unit_amount_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="amount_tax" type="numeric(23, 12)" />
            <column name="tax_id" type="bigint" />
            <column name="tax_percent" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-1275_20211011" author="anasseh">
    	<sql>update  ${db.schema.adapted}ar_account_operation set status ='POSTED' where status is null;</sql>
        <sql>update  ${db.schema.adapted}ar_account_operation set accounting_date =created where accounting_date is null;</sql>
    </changeSet>
	<changeSet id="#2374_20211012" author="HatimOUDAD">
        <addColumn tableName="billing_service_instance" >
            <column name="delivery_date" type="datetime" />
        </addColumn>
        <addColumn tableName="cpq_order_product" >
            <column name="delivery_date" type="datetime" />
        </addColumn>
        <addColumn tableName="cpq_order_offer" >
            <column name="delivery_date" type="datetime" />
        </addColumn>
        <addColumn tableName="cpq_quote_product" >
            <column name="delivery_date" type="datetime" />
        </addColumn>
        <addColumn tableName="quote_offer" >
            <column name="delivery_date" type="datetime" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-2364-create_data_model" author="AbdelkaderBouazza">
        <createSequence sequenceName="ar_dunning_action_seq" startValue="1" />
        <createTable tableName="dunning_action_notification_template">
            <column name="dunning_action_id"  type="bigint"/>
            <column name="action_notification_template"  type="varchar(200)"/>
        </createTable>
        <createTable tableName="ar_dunning_level">
            <column name="level_id" type="bigint" />
            <column name="related_levels" type="varchar(255)" />
        </createTable>
        <createTable tableName="ar_dunning_action">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_dunning_action_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="action_name" type="varchar(255)" >
                <constraints nullable="false"/>
            </column>
            <column name="action_description" type="varchar(255)" />
            <column name="is_action_active" type="${type.boolean}" defaultValueNumeric="1"/>
            <column name="action_type" type="varchar(255)" >
                <constraints nullable="false"/>
            </column>
            <column name="action_mode" type="varchar(255)" >
                <constraints nullable="false"/>
            </column>
            <column name="action_channel" type="varchar(255)"/>
            <column name="related_levels" type="varchar(255)"/>
            <column name="script_instance_id" type="bigint"/>
            <column name="action_notification_template" type="varchar(255)"/>
            <column name="attach_overdue_invoices" type="${type.boolean}" defaultValueNumeric="1"/>
            <column name="attach_due_invoices" type="${type.boolean}" defaultValueNumeric="0"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_dunning_action" constraintName="fk_ar_dunning_action_meveo_script_instance"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
        <addPrimaryKey columnNames="dunning_action_id, action_notification_template" constraintName="dunning_action_notification_template_pkey" tableName="dunning_action_notification_template" />
    </changeSet>

    <changeSet id="INTRD-2412_20211015" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_attribute">
            <column name="attribute_category" type="varchar(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="INTRD-2252_20211006" author="TarikFA.">
    	<dropNotNullConstraint tableName="billing_article_mapping_line" columnName="article_mapping_id"/>
    </changeSet>

    <changeSet id="INTRD-2431_20211014" author="AbdelkaderBouazza">

        <addForeignKeyConstraint constraintName="fk_dunning_collection_management_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_collection_management" referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_dunning_collection_plan_statuses_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_collection_plan_statuses" referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_dunning_pause_reasons_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_pause_reasons" referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_dunning_payment_retries_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_payment_retries" referencedColumnNames="id" />

        <addForeignKeyConstraint constraintName="fk_invoice_dunning_statuses_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="invoice_dunning_statuses" referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-2322-20211018" author="khalidHORRI" failOnError="true">
		<dropTable tableName="dunning_level" />
        <createSequence sequenceName="dunning_level_seq" startValue="1" />
        <createTable tableName="dunning_level">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_level_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)" />
            <column name="reminder" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="active" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="days_overdue" type="int4" >
                <constraints nullable="false"/>
            </column>
            <column name="soft_decline" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="min_balance" type="numeric(23, 12)" />
            <column name="min_balance_currency_id" type="bigint" />
            <column name="charge_type" type="varchar(255)" />
            <column name="charge_value" type="numeric(23, 12)" />
            <column name="charge_currency_id" type="bigint" />
            <column name="end_dunning_level" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="min_balance_currency_id" baseTableName="dunning_level" constraintName="fk_dunning_level_min_balance_currency"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />
        <addForeignKeyConstraint baseColumnNames="charge_currency_id" baseTableName="dunning_level" constraintName="fk_dunning_level_charge_currency"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />


        <createTable tableName="dunning_level_dunning_action">
            <column name="dunning_level_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="dunning_action_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="dunning_level_id, dunning_action_id" constraintName="dunning_level_dunning_action_pkey" tableName="dunning_level_dunning_action" />


        <createSequence sequenceName="dunning_policy_level_seq" startValue="1" />
        <createTable tableName="dunning_policy_level">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_policy_level_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="sequence" type="int4" >
                <constraints nullable="false"/>
            </column>
            <column name="dunning_level_id" type="bigint" />
            <column name="collection_plan_status_id" type="bigint" />
            <column name="invoice_dunning_statuses_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_level_id" baseTableName="dunning_policy_level" constraintName="fk_dunning_policy_level_dunning_level"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_level" />
        <addForeignKeyConstraint baseColumnNames="collection_plan_status_id" baseTableName="dunning_policy_level" constraintName="fk_dunning_policy_level_collection_plan_status"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="collection_plan_status" />
        <addForeignKeyConstraint baseColumnNames="invoice_dunning_statuses_id" baseTableName="dunning_policy_level" constraintName="fk_dunning_policy_level_invoice_dunning_statuses"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="invoice_dunning_statuses" />
    </changeSet>

    <changeSet id="INTRD-2444_20211018" author="ZBariki">
        <createSequence sequenceName="dunning_policy_seq" startValue="1" />
        <createTable tableName="dunning_policy">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_policy_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="policy_name" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="policy_description" type="varchar(2000)">
                <constraints nullable="false" />
            </column>
            <column name="interest_for_delay_sequence" type="int4" />
            <column name="min_balance_trigger" type="${type.float}" defaultValue="0" >
                <constraints nullable="false" />
            </column>
            <column name="include_due_invoices_in_threshold" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="total_dunning_levels" type="int4" />
            <column name="include_pay_reminder" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="attach_invoices_to_emails" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="policy_priority" type="int4" />
            <column name="is_default_policy" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="is_active_policy" type="${type.boolean}" defaultValueNumeric="1" />
        </createTable>
        <createTable tableName="dunning_min_balance_trigger_currency">
            <column name="id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="min_balance_trigger_currency" type="varchar(255)" />
        </createTable>
        <createTable tableName="dunning_determine_level_by">
            <column name="id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="determine_level_by" type="varchar(255)" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="dunning_min_balance_trigger_currency"
                                 constraintName="fk_dunning_min_balance_trigger_currency_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_policy"/>
        <addForeignKeyConstraint baseColumnNames="id" baseTableName="dunning_determine_level_by"
                                 constraintName="fk_dunning_determine_level_by_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_policy"/>
        <createSequence sequenceName="dunning_policy_rule_seq" startValue="1" />
        <createTable tableName="dunning_policy_rule">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_policy_rule_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="rule_joint" type="varchar(255)" />
            <column name="dunning_policy_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_policy_id" baseTableName="dunning_policy_rule"
                                 constraintName="fk_dunning_determine_level_by_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_policy"/>
        <createSequence sequenceName="dunning_policy_rule_line_seq" startValue="1" />
        <createTable tableName="dunning_policy_rule_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_policy_rule_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="policy_condition_operator" type="varchar(255)" />
            <column name="policy_condition_target" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="policy_condition_target_value" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="dunning_policy_rule_id" type="bigint" />
            <column name="rule_line_joint" type="varchar(255)" defaultValue="AND"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="dunning_policy_rule_id" baseTableName="dunning_policy_rule_line"
                                 constraintName="fk_dunning_policy_rule_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_policy_rule"/>
    </changeSet>
    <changeSet id="INTRD-2444_20211019" author="ZBariki">
        <addColumn tableName="dunning_policy_level">
            <column name="dunning_policy_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="dunning_policy_id" baseTableName="dunning_policy_level"
                                 constraintName="fk_dunning_policy_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="dunning_policy"/>
    </changeSet>

     <changeSet id="INTRD-2431_20211021" author="AbdelkaderBouazza" failOnError="false">
       <renameColumn tableName="ar_dunning_action" oldColumnName="action_name" newColumnName="code"/>
        <renameColumn tableName="ar_dunning_action" oldColumnName="action_description" newColumnName="description"/>
        <dropColumn tableName="ar_dunning_action" columnName="action_notification_template"/>
        <addColumn tableName="ar_dunning_action">
            <column name="action_notification_template" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="action_notification_template_id" baseTableName="ar_dunning_action" constraintName="fk_ar_dunning_action_email_template"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="com_message_template" />
    </changeSet>

    <changeSet id="INTRD-2498_20211019" author="Mbarek-Ay">
     <addColumn tableName="cpq_invoice_line">
            <column name="quote_offer_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="quote_offer_id" baseTableName="cpq_invoice_line" constraintName="fk_invoice_line_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />

       <addColumn tableName="cpq_invoice_line">
         <column name="order_offer_id" type="bigint" />
     </addColumn>
     <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="cpq_invoice_line" constraintName="fk_invoice_line_order_offer_id" deferrable="false" initiallyDeferred="false"
                              onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>

    <changeSet id="INTRD-2535_20211021" author="NabilOuachi">
        <addColumn tableName="cpq_commercial_rule_header">
            <column name="scope_type" type="varchar(25)" />
        </addColumn>
    </changeSet>


    <changeSet id="INTRD-2431_20211021_fix" author="AbdelkaderBouazza" failOnError="false">
        <dropColumn tableName="ar_dunning_action" columnName="action_notification_template"/>
        <addColumn tableName="ar_dunning_action">
            <column name="action_notification_template_id" type="bigint"/>
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-2529_20211021" author="AmineBENAICHA">
	    <renameColumn tableName="dunning_collection_management" newColumnName="external" oldColumnName="include_collection_agency" />
	    <renameColumn tableName="dunning_collection_management" newColumnName="collection_agency" oldColumnName="email_collection_agency" />
    </changeSet>
    <changeSet id="INTRD-2547-2480-2482-2478_20211021" author="khalidHORRI" failOnError="false">
        <modifyDataType columnName="pause_reason" newDataType="varchar(255)" tableName="dunning_pause_reasons"/>
        <modifyDataType columnName="stop_reason" newDataType="varchar(255)" tableName="dunning_stop_reasons"/>
        <modifyDataType columnName="status" newDataType="varchar(255)" tableName="invoice_dunning_statuses"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="pause_reason" tableName="dunning_pause_reasons"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="stop_reason" tableName="dunning_stop_reasons"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="status" tableName="invoice_dunning_statuses"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="context" tableName="invoice_dunning_statuses"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="status" tableName="dunning_collection_plan_statuses"/>
        <addNotNullConstraint columnDataType="varchar(255)" columnName="context" tableName="dunning_collection_plan_statuses"/>
        <dropColumn columnName="language" tableName="dunning_pause_reasons"/>
        <dropColumn columnName="language" tableName="dunning_stop_reasons"/>
        <dropColumn columnName="language" tableName="invoice_dunning_statuses"/>
        <dropColumn columnName="language" tableName="dunning_collection_plan_statuses"/>
        <addColumn tableName="dunning_pause_reasons">
            <column name="language_id" type="bigint"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}dunning_pause_reasons set language_id = -1
        </sql>
        <addNotNullConstraint columnName="language_id" tableName="dunning_pause_reasons"/>
        <addColumn tableName="dunning_stop_reasons">
            <column name="language_id" type="bigint"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}dunning_stop_reasons set language_id = -1
        </sql>
        <addNotNullConstraint columnName="language_id" tableName="dunning_stop_reasons"/>
        <addColumn tableName="invoice_dunning_statuses">
            <column name="language_id" type="bigint"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}invoice_dunning_statuses set language_id = -1
        </sql>
        <addNotNullConstraint columnName="language_id" tableName="invoice_dunning_statuses"/>
        <addColumn tableName="dunning_collection_plan_statuses">
            <column name="language_id" type="bigint"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}dunning_collection_plan_statuses set language_id = -1
        </sql>
        <addNotNullConstraint columnName="language_id" tableName="dunning_collection_plan_statuses"/>
        <addUniqueConstraint columnNames="pause_reason, dunning_settings_id, language_id" tableName="dunning_pause_reasons"/>
        <addUniqueConstraint columnNames="stop_reason, dunning_settings_id, language_id" tableName="dunning_stop_reasons"/>
        <addUniqueConstraint columnNames="payment_method, psp" tableName="dunning_payment_retries"/>
        <addForeignKeyConstraint baseTableName="dunning_pause_reasons"
                                 baseColumnNames="language_id"
                                 constraintName="fk_dunning_pause_reasons_trading_language"
                                 referencedTableName="billing_trading_language"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="dunning_stop_reasons"
                                 baseColumnNames="language_id"
                                 constraintName="fk_dunning_stop_reasons_trading_language"
                                 referencedTableName="billing_trading_language"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="invoice_dunning_statuses"
                                 baseColumnNames="language_id"
                                 constraintName="fk_invoice_dunning_statuses_trading_language"
                                 referencedTableName="billing_trading_language"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="dunning_collection_plan_statuses"
                                 baseColumnNames="language_id"
                                 constraintName="fk_dunning_collection_plan_statuses_trading_language"
                                 referencedTableName="billing_trading_language"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="INTRD-2366_20211021" author="AbdelkaderBouazza">
        <dropColumn tableName="ar_dunning_action" columnName="related_levels"/>
    </changeSet>

    <changeSet id="INTRD-2445_20211021" author="ZBariki">
        <addUniqueConstraint columnNames="policy_name" constraintName="uk_dp_dunning_policy_name"
                         deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_policy" />
    </changeSet>

    <changeSet id="INTRD-2596_20211022" author="AmineBENAICHA">
        <addColumn tableName="accounting_period" >
            <column name="start_date" type="datetime" />
        </addColumn>
        <sql>
    		update ${db.schema.adapted}accounting_period set start_date = created
        </sql>
        <addDefaultValue tableName="accounting_period" columnName="start_date" defaultValueDate="${db.current.time}" />
        <addUniqueConstraint columnNames="start_date" constraintName="uk_ap_start_date" deferrable="false" disabled="false" initiallyDeferred="false" tableName="accounting_period" />
    </changeSet>
    <changeSet id="#INTRD-2628-20211025" author="AbdelkaderBouazza">
        <addForeignKeyConstraint baseTableName="dunning_level_dunning_action" baseColumnNames="dunning_level_id"
                                 constraintName="dunning_level_dunning_action_pkey_const" referencedTableName="dunning_level"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="dunning_level_dunning_action" baseColumnNames="dunning_action_id"
                                 constraintName="dunning_action_dunning_level_pkey_const" referencedTableName="ar_dunning_action"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="INTRD-2511-1_20211029" author="Mohammed_ElAzzouzi" failOnError="false">
    	<dropUniqueConstraint tableName="cpq_price_plan_version" constraintName="cpq_price_plan_version_UNIC" />
    </changeSet>
    <changeSet id="INTRD-2511-2_20211029" author="Mohammed_ElAzzouzi">
		<sql>update cpq_price_plan_version ppv set current_version = id where ppv.ppm_id in
				(select d.ppm_id from (select count(*), current_version, ppm_id from cpq_price_plan_version
				group by current_version, ppm_id having count(*)>1) d)</sql>
	    <addUniqueConstraint columnNames="current_version,ppm_id" constraintName="cpq_price_plan_version_UNIC" tableName="cpq_price_plan_version" />
	</changeSet>

	<changeSet id="#INTRD-2421_20211012" author="AndriusKarpavicius">
        <addColumn tableName="ar_customer_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <addColumn tableName="billing_billing_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_user_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <renameColumn tableName="com_contact" oldColumnName="company" newColumnName="company_name" columnDataType="varchar(200)"/>

        <addColumn tableName="com_contact">
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="fax" type="varchar(50)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <addColumn tableName="crm_customer">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="crm_seller">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
            <column name="minimum_article_id" type="bigint" />
        </addColumn>

        <dropAllForeignKeyConstraints baseTableName="account_entity"/>
        <dropForeignKeyConstraint baseTableName="crm_customer" constraintName="fk_rylbq2w5ij2o2lbubhv99m4ox"/>
        <dropForeignKeyConstraint baseTableName="ar_customer_account" constraintName="fk_9i811xvc40e19t613cmpvwmu9" />
        <dropForeignKeyConstraint baseTableName="billing_billing_account" constraintName="fk_fky4ah96o9fohkx7u569phxxr" />
        <dropForeignKeyConstraint baseTableName="billing_user_account" constraintName="fk_alpl7r5p2nm43w0ro26ckcqnb" />

        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_rt_ua"/>
        <dropForeignKeyConstraint baseTableName="document" constraintName="document_account_entity_id_fk"/>

    </changeSet>

    <changeSet id="#INTRD-2421_20211012-pg" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}crm_seller set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where crm_seller.id=ae.id and ae.account_type='ACCT_S'</sql>

        <sql>update ${db.schema.adapted}crm_customer set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where crm_customer.id=ae.id and ae.account_type='ACCT_CUST'</sql>

        <sql>update ${db.schema.adapted}ar_customer_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where ar_customer_account.id=ae.id and ae.account_type='ACCT_CA'</sql>

        <sql>update ${db.schema.adapted}billing_billing_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where billing_billing_account.id=ae.id and ae.account_type='ACCT_BA'</sql>

        <sql>update ${db.schema.adapted}billing_user_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where billing_user_account.id=ae.id and ae.account_type='ACCT_UA'</sql>

        <sql>update ${db.schema.adapted}com_contact set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where com_contact.id=ae.id and ae.account_type='ACCT_CTACT'</sql>
    </changeSet>

    <changeSet id="#INTRD-2421_20211012-end" author="AndriusKarpavicius">

        <addNotNullConstraint tableName="crm_seller" columnName="created"/>
        <addNotNullConstraint tableName="crm_seller" columnName="code"/>
        <addNotNullConstraint tableName="crm_seller" columnName="uuid"/>
        <addNotNullConstraint tableName="crm_customer" columnName="created"/>
        <addNotNullConstraint tableName="crm_customer" columnName="code"/>
        <addNotNullConstraint tableName="crm_customer" columnName="uuid"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="created"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="code"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="uuid"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="created"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="code"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="uuid"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="created"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="code"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="uuid"/>
        <addNotNullConstraint tableName="com_contact" columnName="created"/>
        <addNotNullConstraint tableName="com_contact" columnName="code"/>
        <addNotNullConstraint tableName="com_contact" columnName="uuid"/>

        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="crm_seller" constraintName="fk_seller_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="crm_customer" constraintName="fk_cust_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="ar_customer_account" constraintName="fk_ca_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="billing_billing_account" constraintName="fk_ba_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="billing_user_account" constraintName="fk_ua_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="com_contact" constraintName="fk_com_contact_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />


        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="crm_seller" constraintName="fk_seller_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="crm_customer" constraintName="fk_cust_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="ar_customer_account" constraintName="fk_ca_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="billing_billing_account" constraintName="fk_ba_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="billing_user_account" constraintName="fk_ua_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="com_contact" constraintName="fk_com_contact_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />

        <addForeignKeyConstraint baseTableName="crm_seller" constraintName="fk_seller_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="crm_customer" constraintName="fk_cust_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="ar_customer_account" constraintName="fk_ca_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_billing_account" constraintName="fk_ba_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_user_account" constraintName="fk_ua_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />

        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_seller" constraintName="fk_seller_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_customer" constraintName="fk_cust_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="ar_customer_account" constraintName="fk_ca_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="billing_billing_account" constraintName="fk_ba_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="billing_user_account" constraintName="fk_ua_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="com_contact" constraintName="fk_com_contact_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />


        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />


        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="crm_seller"
            constraintName="fk_seller_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="crm_customer"
            constraintName="fk_cust_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="ar_customer_account"
            constraintName="fk_ca_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_billing_account"
            constraintName="fk_ba_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_user_account"
            constraintName="fk_ua_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />



        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="crm_seller" constraintName="fk_seller_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="crm_customer" constraintName="fk_cust_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="ar_customer_account" constraintName="fk_ca_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="billing_billing_account" constraintName="fk_ba_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="billing_user_account" constraintName="fk_ua_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="com_contact" constraintName="fk_com_contact_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />

        <sql>CREATE INDEX crm_seller_ctb_index ON ${db.schema.adapted}crm_seller(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX crm_customer_ctb_index ON ${db.schema.adapted}crm_customer(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX ar_customer_account_ctb_index ON ${db.schema.adapted}ar_customer_account(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX billing_billing_account_ctb_index ON ${db.schema.adapted}billing_billing_account(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX billing_user_account_ctb_index ON ${db.schema.adapted}billing_user_account(primary_contact, title_id, bam_id)</sql>

        <dropIndex tableName="crm_customer" indexName="crm_customer_primary_contact_index"/>
        <dropIndex tableName="ar_customer_account" indexName="ar_customer_account_index"/>
        <dropIndex tableName="account_entity" indexName="customer_code"/>
        <dropIndex tableName="billing_user_account" indexName="billing_user_account_index"/>
        <dropIndex tableName="billing_billing_account" indexName="billing_billing_account_index"/>


        <sql>CREATE INDEX crm_seller_bam_id_index ON ${db.schema.adapted}crm_seller(bam_id);</sql>
        <sql>CREATE INDEX crm_customer_bam_id_index ON ${db.schema.adapted}crm_customer(bam_id);</sql>
        <sql>CREATE INDEX ar_customer_account_bam_id_index ON ${db.schema.adapted}ar_customer_account(bam_id);</sql>
        <sql>CREATE INDEX billing_billing_account_bam_id_index ON ${db.schema.adapted}billing_billing_account(bam_id);</sql>
        <sql>CREATE INDEX billing_user_account_bam_id_index ON ${db.schema.adapted}billing_user_account(bam_id);</sql>

        <sql>CREATE INDEX crm_seller_title_id_index ON ${db.schema.adapted}crm_seller(title_id);</sql>
        <sql>CREATE INDEX crm_customer_title_id_index ON ${db.schema.adapted}crm_customer(title_id);</sql>
        <sql>CREATE INDEX ar_customer_account_title_id_index ON ${db.schema.adapted}ar_customer_account(title_id);</sql>
        <sql>CREATE INDEX billing_billing_account_title_id_index ON ${db.schema.adapted}billing_billing_account(title_id);</sql>
        <sql>CREATE INDEX billing_user_account_title_id_index ON ${db.schema.adapted}billing_user_account(title_id);</sql>
        <sql>CREATE INDEX com_contact_title_id_index ON ${db.schema.adapted}com_contact(title_id);</sql>

        <sql>CREATE INDEX crm_seller_primary_contact_index ON ${db.schema.adapted}crm_seller(primary_contact);</sql>
        <sql>CREATE INDEX crm_customer_primary_contact_index ON ${db.schema.adapted}crm_customer(primary_contact);</sql>
        <sql>CREATE INDEX ar_customer_account_primary_contact_index ON ${db.schema.adapted}ar_customer_account(primary_contact);</sql>
        <sql>CREATE INDEX billing_billing_account_primary_contact_index ON ${db.schema.adapted}billing_billing_account(primary_contact);</sql>
        <sql>CREATE INDEX billing_user_account_primary_contact_index ON ${db.schema.adapted}billing_user_account(primary_contact);</sql>
        <sql>CREATE INDEX com_contact_primary_contact_index ON ${db.schema.adapted}com_contact(primary_contact);</sql>

        <sql>CREATE INDEX crm_customer_cust_category_index ON ${db.schema.adapted}crm_customer(customer_category_id);</sql>

        <sql>CREATE INDEX seller_code ON ${db.schema.adapted}crm_seller(lower(code));</sql>
        <sql>CREATE INDEX customer_code ON ${db.schema.adapted}crm_customer(lower(code));</sql>
        <sql>CREATE INDEX ca_code ON ${db.schema.adapted}ar_customer_account(lower(code));</sql>
        <sql>CREATE INDEX ba_code ON ${db.schema.adapted}billing_billing_account(lower(code));</sql>
        <sql>CREATE INDEX ua_code ON ${db.schema.adapted}billing_user_account(lower(code));</sql>
        <sql>CREATE INDEX com_contact_code ON ${db.schema.adapted}com_contact(lower(code));</sql>

        <sql>CREATE INDEX seller_upper_code ON ${db.schema.adapted}crm_seller(UPPER(code));</sql>
        <sql>CREATE INDEX customer_upper_code ON ${db.schema.adapted}crm_customer(UPPER(code));</sql>
        <sql>CREATE INDEX ca_upper_code ON ${db.schema.adapted}ar_customer_account(UPPER(code));</sql>
        <sql>CREATE INDEX ba_upper_code ON ${db.schema.adapted}billing_billing_account(UPPER(code));</sql>
        <sql>CREATE INDEX ua_upper_code ON ${db.schema.adapted}billing_user_account(UPPER(code));</sql>
        <sql>CREATE INDEX com_contact_upper_code ON ${db.schema.adapted}com_contact(UPPER(code));</sql>

        <sql>CREATE INDEX ar_customer_account_credit_cat_index ON ${db.schema.adapted}ar_customer_account(credit_category_id)</sql>
        <sql>CREATE INDEX billing_user_account_ba_index ON ${db.schema.adapted}billing_user_account(billing_account_id)</sql>
        <sql>CREATE INDEX billing_billing_account_ca_index ON ${db.schema.adapted}billing_billing_account(customer_account_id)</sql>

        <dropTable tableName="account_entity" />
    </changeSet>

    <changeSet id="#INTRD-2421_2021012-reports" author="AndriusKarpavicius">
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT
                    TO_CHAR(ao.invoice_date,'MM') AS "Mois",
                    TO_CHAR(ao.invoice_date,'DD/MM/YYYY') AS "Date facture",
                    text('HG') AS "Code comptable",
                    ae.code AS "Client factur?",
                    text('MAI') AS "Type article",
                    split_part(bac.code, ',', 6) AS "Famille statistique",
                    split_part(bac.code, ',', 2) AS "Article",
                    trim(TO_CHAR(ia.amount_without_tax,'9999990D00')) AS "Montant HT",
                    trim(TO_CHAR(ia.quantity,'9999990')) AS "Qt? factur?e",
                    ao.reference AS "No facture",
                    ao.occ_description AS "Cat?gorie facture",
                    ao.occ_code AS "Type de pi?ce",
                    text('VEN') AS "Journal"
                FROM
                    ar_customer_account ae
                INNER JOIN ar_account_operation ao ON ao.customer_account_id = ae.id
                INNER JOIN billing_invoice i ON i.invoice_number = ao.reference
                INNER JOIN billing_invoice_agregate ia ON (ia.invoice_id = i.id AND type = 'F')
                LEFT JOIN billing_accounting_code bac ON bac.id = ia.accounting_code_id
                WHERE :START_DATE<>:END_DATE
                AND ao.invoice_date >= to_date('01/' || TO_CHAR(CURRENT_DATE,'MM/YYYY'),'DD/MM/YYYY') + interval '-12 month'
                AND ao.invoice_date <= to_date('01/' || TO_CHAR(CURRENT_DATE,'MM/YYYY'),'DD/MM/YYYY') + interval '0 month'
                ORDER BY
                    ae.code,
                    occ_code,
                    split_part(bac.code, ',', 6),
                    split_part(bac.code, ',', 2)
                ]]>
            </column>
            <where>code='SALES_JOURNAL'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
    , s.description AS "Seller description"
    , coalesce(c.code, '') AS "Customer code"
    , coalesce(replace(c.description, ',', ' '), '') AS "Customer description"
    , coalesce(ca.code, '') AS "Customer Account code"
    , coalesce(replace(ca.description, ',', ' '), '') AS "Customer Account description"
    , coalesce(ba.code, '') AS "Billing Account code"
    , coalesce(replace(ba.description, ',', ' '), '') AS "Billing Account description"
    , coalesce(ua.code, '') AS "User Account code"
    , coalesce(replace(ua.description, ',', ' '), '') AS "User Account description"
    , coalesce(su.code, '') AS "Subscription code"
    , coalesce(replace(su.description, ',', ' '), '') AS "Subscription description"
    , coalesce(ap.acces_user_id, '') AS "Access Point id"
from  crm_seller s left
    OUTER JOIN crm_customer c  on c.seller_id = s.id left
    OUTER JOIN ar_customer_account ca  on ca.customer_id = c.id left
    OUTER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id left
    OUTER JOIN billing_user_account ua  on ua.billing_account_id = ba.id left
    OUTER JOIN billing_subscription su  on su.user_account_id = ua.id left
    OUTER JOIN medina_access ap  on ap.subscription_id = su.id
where s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%'
    || :SEARCH_CRITERION || '%'  or c.code ilike '%' || :SEARCH_CRITERION
    || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  or ca.code ilike '%'
    || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%'
    || :SEARCH_CRITERION || '%'  or ua.code ilike '%' || :SEARCH_CRITERION
    || '%'  or ua.description ilike '%' || :SEARCH_CRITERION || '%'  or su.code ilike '%'
    || :SEARCH_CRITERION || '%'  or su.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ap.acces_user_id ilike '%' || :SEARCH_CRITERION || '%'
order by s.code
    ,c.code
    ,ca.code
    ,ba.code
    ,ua.code
    ,su.code
    ,ap.acces_user_id]]>
            </column>
            <where>code='FULL_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
                            , s.description AS "Seller description"
                            , coalesce(c.code, '') AS "Customer code"
                            , coalesce(replace(c.description, ',', ' '), '') AS "Customer description"
                    from  crm_seller s left
                            OUTER JOIN crm_customer c  on c.seller_id = s.id
                    where(  s.code ilike '%' || :SEARCH_CRITERION
                            || '%'  or s.description ilike '%' || :SEARCH_CRITERION || '%'  or c.code ilike '%'
                            || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
                    and (  s.code ilike '%' || :SELLER || '%'  or s.description ilike '%' || :SELLER || '%'  )
                    order by s.code
                            ,c.code]]>
            </column>
            <where>code='CUSTOMERS_PER_SELLER'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , s.code AS "Seller code"
    , s.description AS "Seller description"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION
    || '%'  or c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION
    || '%'  )  group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , s.code
    , s.description
    , c.code
    , c.description
    , ca.code
    , ca.description
    , ba.code
    , ba.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , s.code
    , c.code
    , ca.code
    , ba.code]]>
            </column>
            <where>code='INVOICED_BA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , ba.code
    , ba.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , ba.code]]>
            </column>
            <where>code='INVOICED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , ca.code
    , ca.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , ca.code]]>
            </column>
            <where>code='INVOICED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , c.code
    , c.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , c.code]]>
            </column>
            <where>code='INVOICED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,s.code AS "Seller code"
    ,s.description AS "Seller description"
    ,c.code AS "Customer code"
    ,c.description AS "Customer description"
    ,ca.code AS "Customer Account code"
    ,ca.description AS "Customer Account description"
    ,ba.code AS "Billing Account code"
    ,ba.description AS "Billing Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN billing_billing_account ba ON ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i ON i.billing_account_id = ba.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
        AND ao.reference = i.invoice_number
        AND ao.invoice_date = i.invoice_date
        AND ao.amount = abs(i.amount_with_tax)
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        s.code ilike '%' || :SEARCH_CRITERION || '%'
        OR s.description ilike '%' || :SEARCH_CRITERION || '%'
        OR c.code ilike '%' || :SEARCH_CRITERION || '%'
        OR c.description ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.description ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,s.code
    ,s.description
    ,c.code
    ,c.description
    ,ca.code
    ,ca.description
    ,ba.code
    ,ba.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,s.code
    ,c.code
    ,ca.code
    ,ba.code]]>
            </column>
            <where>code='RECORDED_BA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,ba.code AS "Billing Account code"
    ,ba.description AS "Billing Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN billing_billing_account ba ON ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i ON i.billing_account_id = ba.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
        AND ao.reference = i.invoice_number
        AND ao.invoice_date = i.invoice_date
        AND ao.amount = abs(i.amount_with_tax)
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        ba.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,ba.code
    ,ba.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,ba.code]]>
            </column>
            <where>code='RECORDED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,ca.code AS "Customer Account code"
    ,ca.description AS "Customer Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        ca.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,ca.code
    ,ca.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,ca.code]]>
            </column>
            <where>code='RECORDED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,c.code AS "Customer code"
    ,c.description AS "Customer description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        c.code ilike '%' || :SEARCH_CRITERION || '%'
        OR c.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,c.code
    ,c.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,c.code]]>
            </column>
            <where>code='RECORDED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
                    , s.description AS "Seller description"
                    , c.code AS "Customer code"
                    , c.description AS "Customer description"
                    , ca.code AS "Customer Account code"
                    , ca.description AS "Customer Account description"
                    , ba.code AS "Billing Account code"
                    , ba.description AS "Billing Account description"
                    , ua.code AS "User Account code"
                    , ua.description AS "User Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION || '%'  or c.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  or ca.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  or ba.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  or ua.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ua.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by s.code
                    , s.description
                    , c.code
                    , c.description
                    , ca.code
                    , ca.description
                    , ba.code
                    , ba.description
                    , ua.code
                    , ua.description order by s.code
                    , c.code
                    , ca.code
                    , ba.code
                    , ua.code
                ]]>
            </column>
            <where>code='UNBILLED_UA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ua.code AS "User Account code"
                    , ua.description AS "User Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (   wo.STATUS = 'TREATED'
                    and EXISTS (   select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id
                and rt.STATUS = 'OPEN'   )  )  )  and(  ua.code ilike '%' || :SEARCH_CRITERION || '%'  or ua.description ilike '%'
                    || :SEARCH_CRITERION || '%'  )
                group by ua.code
                    , ua.description
                order by ua.code
                ]]>
            </column>
            <where>code='UNBILLED_UA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ba.code AS "Billing Account code"
                    , ba.description AS "Billing Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                    and(  ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by ba.code, ba.description
                order by ba.code
                ]]>
            </column>
            <where>code='UNBILLED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ca.code AS "Customer Account code"
                    , ca.description AS "Customer Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                and(  ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by ca.code, ca.description
                order by ca.code
                ]]>
            </column>
            <where>code='UNBILLED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select c.code AS "Customer code"
                    , c.description AS "Customer description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (   wo.STATUS = 'TREATED'
                    and EXISTS (   select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN'   )  )  )
                and(  c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by c.code, c.description
                order by c.code
                ]]>
            </column>
            <where>code='UNBILLED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , to_char(i.invoice_date, 'YYYY-MM-DD') AS "Invoice date"
    , i.invoice_number AS "Invoice number"
    , to_char(i.amount_without_tax, '9999999990.00') AS "Amount without tax"
    , to_char(i.amount_with_tax, '9999999990.00') AS "Amount with tax"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , s.code AS "Seller code"
    , s.description AS "Seller description"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION
    || '%'  or c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION
    || '%'  )
order by date_trunc('month', i.invoice_date) DESC
    , i.invoice_date DESC
    , it.code
    , i.invoice_number]]>
            </column>
            <where>code='INVOICES'</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-2421_20211018-reports" author="AndriusKarpavicius">
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
                package org.meveo.service.script.presale; import java.io.File; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.apache.commons.lang.time.DateUtils; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh */ public class KPIAgedBalanceReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(KPIAgedBalanceReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); String query = "Select count(distinct ao.customerAccount.id) " + "from AccountOperation ao where ao.transactionCategory = 'DEBIT'  and  ao.dueDate <=:dateTo and ao.dueDate >:dateFrom "; Map<String, Object> params = new HashMap<String, Object>(); params.put("dateFrom", DateUtils.addDays(new Date(), -30)); params.put("dateTo", new Date()); List<Long> count_now_30 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", DateUtils.addDays(new Date(), -60)); params.put("dateTo", DateUtils.addDays(new Date(), -30)); List<Long> count_30_60 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", DateUtils.addDays(new Date(), -90)); params.put("dateTo", DateUtils.addDays(new Date(), -60)); List<Long> count_60_90 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", new Date(1)); params.put("dateTo", DateUtils.addDays(new Date(), -90)); List<Long> count_90_up = (List<Long>) customerAccountService.executeSelectQuery(query, params); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "DEBT_TIER", "Number of accounts" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); csvBuilder.appendValue("0_30_days"); csvBuilder.appendValue("" + count_now_30.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("30_60_days"); csvBuilder.appendValue("" + count_30_60.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("60_90_days"); csvBuilder.appendValue("" + count_60_90.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("90_days_up"); csvBuilder.appendValue("" + count_90_up.get(0)); csvBuilder.startNewLine(); csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on AgedBalanceReporting:", e); throw new BusinessException(e.getMessage()); } } }
                ]]>
            </column>
            <where>id=-16</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
                package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * */ public class KPICustomerRevenuReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(KPICustomerRevenuReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Date startDate = (Date) executeContext.get(ReportExtractScript.START_DATE); Date endDate = (Date) executeContext.get(ReportExtractScript.END_DATE); Map<String, Object> params = new HashMap<String, Object>(); params.put("startDateIN", startDate); params.put("endDateIN", endDate); String query = "Select ao.customerAccount.id , sum (ao.amount) as sum_amount from AccountOperation ao where ao.transactionCategory = 'DEBIT' and ao.dueDate >=:startDateIN " + "and ao.dueDate <:endDateIN  group by ao.customerAccount order by sum_amount "; List<Object[]> rows = (List<Object[]>) customerAccountService.executeSelectQuery(query, params); log.debug("execute columns size:{}", rows == null ? null : rows.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(KPICustomerRevenuReporting.FILENAME)); long cpt0_50000 = 0; long cpt50000_100000 = 0; long cpt100000_500000 = 0; long cpt500000_1000000 = 0; long cpt1000000Up = 0; CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "RANGE", "NB_CUSTOMERS" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] row : rows) { log.info("(BigDecimal) row[1]:"+(BigDecimal) row[1]); if (((BigDecimal) row[1]).compareTo(new BigDecimal(50000)) < 0) { cpt0_50000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(100000)) < 0) { cpt50000_100000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(500000)) < 0) { cpt100000_500000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(1000000)) < 0) { cpt500000_1000000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(1000000)) >= 0) { cpt1000000Up++; continue; } } csvBuilder.appendValue("0<50000"); csvBuilder.appendValue("" + cpt0_50000); csvBuilder.startNewLine(); csvBuilder.appendValue("50000<100000"); csvBuilder.appendValue("" + cpt50000_100000); csvBuilder.startNewLine(); csvBuilder.appendValue("100000<500000"); csvBuilder.appendValue("" + cpt100000_500000); csvBuilder.startNewLine(); csvBuilder.appendValue("500000<1000000"); csvBuilder.appendValue("" + cpt500000_1000000); csvBuilder.startNewLine(); csvBuilder.appendValue("1000000<"); csvBuilder.appendValue("" + cpt1000000Up); csvBuilder.startNewLine(); csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on KPICustomerRevenuReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if (amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }
                ]]>
            </column>
            <where>id=-17</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.apache.commons.lang.time.DateUtils; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.model.payments.CustomerAccount; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * @corrector jpviegas */ public class AgedBalanceReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(AgedBalanceReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Map<String, Object> params = new HashMap<String, Object>(); params.put("sysdate30", DateUtils.addDays(new Date(), -30)); params.put("sysdate60", DateUtils.addDays(new Date(), -60)); params.put("sysdate90", DateUtils.addDays(new Date(), -90)); String query = "Select ao.customerAccount.id , " + "sum (case when ao.dueDate <= current_date() and ao.dueDate >:sysdate30 then  ao.amount else 0 end ) as sum_0_30, " + "sum (case when ao.dueDate <=:sysdate30 and ao.dueDate >:sysdate60 then  ao.amount else 0 end ) as sum_30_60, " + "sum (case when ao.dueDate <=:sysdate60 and ao.dueDate >:sysdate90 then  ao.amount else 0 end ) as sum_60_90, " + "sum (case when ao.dueDate <=:sysdate90  then  ao.amount else 0 end ) as sum_90_up " + "from AccountOperation ao where ao.transactionCategory = 'DEBIT'  group by ao.customerAccount"; List<Object[]> rows = (List<Object[]>)  customerAccountService.executeSelectQuery(query,params); log.debug("execute rows size:{}", rows == null ? null : rows.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "CA_DESC", "C_DESC","DEBT_TIER_0_30_DAYS","DEBT_TIER_30_60_DAYS","DEBT_TIER_60_90_DAYS","DEBT_TIER_90_DAYS" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] row : rows) { CustomerAccount ca = customerAccountService.findById(((Long)row[0])); csvBuilder.appendValue(ca.getDescription()); csvBuilder.appendValue(ca.getCustomer().getDescription()); csvBuilder.appendValue(round((BigDecimal)row[1])); csvBuilder.appendValue(round((BigDecimal)row[2])); csvBuilder.appendValue(round((BigDecimal)row[3])); csvBuilder.appendValue(round((BigDecimal)row[4])); csvBuilder.startNewLine(); } csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on AgedBalanceReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if(amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }]]>
            </column>
            <where>id=-12</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.model.payments.CustomerAccount; import org.meveo.service.payments.impl.AccountOperationService; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * */ public class CustomerRevenuReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(CustomerRevenuReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Date startDate = (Date) executeContext.get(ReportExtractScript.START_DATE); Date endDate = (Date) executeContext.get(ReportExtractScript.END_DATE); Map<String, Object> params = new HashMap<String, Object>(); params.put("startDateIN", startDate); params.put("endDateIN", endDate); String query = "Select ao.customerAccount.id , sum (ao.amount) as sum_amount from AccountOperation ao where ao.transactionCategory = 'DEBIT' and ao.dueDate >=:startDateIN " + "and ao.dueDate <:endDateIN  group by ao.customerAccount order by sum_amount desc"; List<Object[]> aos = (List<Object[]>)  customerAccountService.executeSelectQuery(query,params); log.debug("execute aos size:{}", aos == null ? null : aos.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(CustomerRevenuReporting.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "CA_DESC", "C_DESC","SUM_REVENUE" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] ao : aos) { CustomerAccount ca = customerAccountService.findById(((Long)ao[0])); csvBuilder.appendValue(ca.getDescription()); csvBuilder.appendValue(ca.getCustomer().getDescription()); csvBuilder.appendValue(round((BigDecimal)ao[1])); csvBuilder.startNewLine(); } csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on CustomerRevenuReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if(amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }]]>
            </column>
            <where>id=-13</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-1166_20211018_Business_attributes_default_value" author="MohammedELAZZOUZI">
    	<update tableName="cpq_attribute">
    		<column name="attribute_category" value="REGULAR"></column>
            <where>attribute_category is null</where>
    	</update>
    	<addColumn tableName="cpq_attribute">
    		<column name="el_value" type="varchar(255)"/>
    	</addColumn>
    	<addNotNullConstraint tableName="cpq_attribute" columnName="attribute_category"/>
    </changeSet>
	<changeSet id="INTRD-2548_20211027" author="YoussefIZEM">
		<addColumn tableName="com_message_template">
			<column name="channel" type="varchar(255)"/>
			<column name="trading_language_id" type="bigint"/>
			<column name="is_active" type="${type.boolean}" defaultValueNumeric="1"/>
		</addColumn>
        <addForeignKeyConstraint baseColumnNames="trading_language_id" baseTableName="com_message_template" constraintName="fk_language_message_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_language" />
	</changeSet>
    <changeSet id="INTRD-2679_20211027" author="khalidHORRI">
        <dropColumn columnName="language_id" tableName="dunning_pause_reasons"/>
        <dropColumn columnName="language_id" tableName="dunning_stop_reasons"/>
        <dropColumn columnName="language_id" tableName="invoice_dunning_statuses"/>
        <dropColumn columnName="language_id" tableName="dunning_collection_plan_statuses"/>
        <addUniqueConstraint columnNames="pause_reason, dunning_settings_id" tableName="dunning_pause_reasons"/>
        <addUniqueConstraint columnNames="stop_reason, dunning_settings_id" tableName="dunning_stop_reasons"/>
    </changeSet>

    <changeSet id="INTRD-2601_20211102" author="AmineBENAICHA" failOnError="false">
    	<dropForeignKeyConstraint baseTableName="dunning_collection_management" constraintName="fk_dunning_collection_management_dunning_settings"/>
	    <dropPrimaryKey constraintName="dunning_collection_management_pkey" tableName="dunning_collection_management"/>
    </changeSet>

    <changeSet id="#FIX-INTRD-2601_20211102-changeset" author="AbdelmounaimAkadid" failOnError="false">
    	<renameTable oldTableName="dunning_collection_management" newTableName="dunning_agent"/>
		<renameSequence oldSequenceName="dunning_collection_management_seq" newSequenceName="dunning_agent_seq" />
    	<!--  <addPrimaryKey columnNames="id" constraintName="dunning_agent_pkey" tableName="dunning_agent" />  -->
		<addForeignKeyConstraint constraintName="fk_dunning_agent_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_agent" referencedColumnNames="id" />
		<addColumn tableName="ar_dunning_action">
			<column name="dunning_agent_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_dunning_action_agent"
			baseColumnNames="dunning_agent_id" baseTableName="ar_dunning_action"
            referencedColumnNames="id" referencedTableName="dunning_agent"
			deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>
    
    <changeSet id="#2333_20211021" author="anasseh">
        <addColumn tableName="ar_payment_token">
            <column name="token_3ds_id" type="varchar(250)"/>
   		</addColumn>
    </changeSet>
    <changeSet id="#INTRD-1254" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_order_offer">
            <column name="user_account_id" type="bigint"/>
   		</addColumn>
   		<addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_user_account" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>
    
    <changeSet id="INTRD-2868_20211105" author="TarikFA.">
    	<addColumn tableName="crm_provider">
    		<column name="cdr_deduplicationkey_el" type="varchar(500)" />
    	</addColumn>
    </changeSet>

	<changeSet id="#INTRD-2764-20211104" author="HatimOUDAD">
        
        <createSequence sequenceName="dunning_collection_plan_seq" startValue="1" />
        <createTable tableName="dunning_collection_plan">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_collection_plan_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
            <column name="collection_plan_number" type="varchar(255)" />
            <column name="related_policy_id" type="bigint" />
            <column name="initial_collection_plan_id" type="bigint" />
            <column name="billing_account_id" type="bigint" />
            <column name="related_invoice_id" type="bigint" />
            <column name="pause_reason_id" type="bigint" />
            <column name="stop_reason_id" type="bigint" />
            
            <column name="current_dunning_level_sequence" type="int4" />
            
            
            
            <column name="start_date" type="datetime" />
            <column name="days_open" type="int4" />
             <column name="close_date" type="datetime" />
            
            <column name="status_id" type="bigint" />
            <column name="paused_until_date" type="datetime" />
            <column name="balance" type="numeric(23, 12)"/>
            <column name="retry_payment_on_resume_date" type="${type.boolean}" defaultValueNumeric="0"/>
            
            <column name="next_action" type="varchar(255)" />
            <column name="next_action_date" type="datetime" />
            <column name="last_action" type="varchar(255)" />
            <column name="last_action_date" type="datetime" />
            <column name="total_dunning_levels" type="int4" />
            <column name="pause_duration" type="int4" />
            
            
        </createTable>
        
        
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_billing_account"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        						 
		<addForeignKeyConstraint baseColumnNames="pause_reason_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_pause_reason"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_pause_reasons" /> 
        						        
        <addForeignKeyConstraint baseColumnNames="stop_reason_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_stop_reason"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_stop_reasons" /> 
        						 
        <addForeignKeyConstraint baseColumnNames="related_policy_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_related_policy"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_policy" /> 
        
        <addForeignKeyConstraint baseColumnNames="status_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_plan_status"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan_statuses" />
                                 
        <addForeignKeyConstraint baseColumnNames="initial_collection_plan_id" baseTableName="dunning_collection_plan" constraintName="fk_initial_collection_plan"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
                                 
        <addForeignKeyConstraint baseColumnNames="related_invoice_id" baseTableName="dunning_collection_plan" constraintName="fk_collection_plan_related_invoice"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />                        
        
    </changeSet>
    <changeSet id="INTRD-30_2021114" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="dunning_min_balance_trigger_currency"
                                  constraintName="fk_dunning_min_balance_trigger_currency_id"/>
        <dropForeignKeyConstraint baseTableName="dunning_determine_level_by"
                                  constraintName="fk_dunning_determine_level_by_id"/>
        <dropTable tableName="dunning_min_balance_trigger_currency"/>
        <dropTable tableName="dunning_determine_level_by"/>
        <addColumn tableName="dunning_policy">
            <column name="min_balance_trigger_currency_id" type="bigint"/>
            <column name="determine_level_by" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="min_balance_trigger_currency_id" baseTableName="dunning_policy"
                                 constraintName="fk_dunning_min_balance_currency_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="adm_currency"/>
    </changeSet>

    <changeSet id="INTRD-2449_2021114" author="ZBariki">
        <dropDefaultValue columnName="rule_line_joint" tableName="dunning_policy_rule_line"/>
	</changeSet>

    <changeSet id="INTRD-2418_20211105" author="TarikFA.">
    	<dropForeignKeyConstraint baseTableName="dunning_policy_level" constraintName="fk_dunning_policy_level_collection_plan_status"/>
		<addForeignKeyConstraint baseTableName="dunning_policy_level"
								baseColumnNames="collection_plan_status_id"
								constraintName="fk_dunning_policy_level_collection_plan_status"
								deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
								onUpdate="NO ACTION" referencedColumnNames="id"
								referencedTableName="dunning_collection_plan_statuses" />
		<dropTable tableName="collection_plan_status"/>
    </changeSet>
    <changeSet id="#INTRD-2800_04112021" author="AbdelkaderBouazza">
        <addColumn tableName="crm_provider">
            <column name="payment_deferral" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="payment_plan" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
      <changeSet id="INTRD-2959_11082021" author="Mbarek-Ay">
     <addColumn tableName="cpq_quote">
            <column name="user_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
                                 
      <addColumn tableName="quote_offer">
      <column name="user_account_id" type="bigint" />
      </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="quote_offer" constraintName="fk_quote_offer_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" /> 
    </changeSet>

    <changeSet author="MohammedELAZZOUZI"  id="#INTRD-1889">
        <addColumn tableName="cat_charge_template">
            <column name="status" type="varchar(255)"/>
        </addColumn>
    	<update tableName="cat_charge_template">
	        <column name="status" value="ACTIVE"/>
	        <where>status is null</where>
    	</update>
        <addNotNullConstraint columnName="status" tableName="cat_charge_template"/>
    </changeSet>

	<changeSet id="#INTRD-1419_20211108" author="HHanine">
	    <addColumn tableName="crm_provider">
	        <column name="maximum_delay" type="int4" />
	        <column name="maximum_deferral_per_invoice" type="int4" />
	    </addColumn>
	</changeSet>
	<changeSet id="#INTRD-1418_20211202" author="HHanine">
	    <createTable tableName="crm_provider_payment_plan_policy_pay_methods">
            <column name="provider_id" type="BIGINT" />
            <column name="payment_method" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="provider_id, payment_method" constraintName="uk_prov_paym_plan_policy_pay_meth" tableName="crm_provider_payment_plan_policy_pay_methods" />
	   	<addColumn tableName="ar_credit_category">
			<column name="provider_id" type="BIGINT" />
	    </addColumn>	    
	    <addColumn tableName="crm_provider">	    
	   		<column name="dunning_default_pause_reason_id" type="BIGINT" />
			<column name="min_allowed_receivable_amount" type="numeric(23, 12)" />
			<column name="max_allowed_receivable_amount" type="numeric(23, 12)" />
			<column name="min_installment_amount" type="numeric(23, 12)" />
			<column name="theres_hold_for_approval" type="numeric(23, 12)" />
			<column name="max_payment_plan_duration" type="int4" />
			<column name="default_installment_count" type="int4" />
			<column name="default_fee_per_installment_plan" type="int4" defaultValueNumeric="0" />
			<column name="installment_amount_rounding" type="int4" defaultValueNumeric="2" />
			<column name="split_evenly" type="${type.boolean}" defaultValueNumeric="1">
				<constraints nullable="false" />
			</column>	
			<column name="allow_custom_installment_plan" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="add_interest_rate" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="add_installment_fee" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="default_block_payments" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="require_internal_approval" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="default_interest_rate" type="int4" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="default_recurrence_unit" type="varchar(255)" />
			<column name="action_on_remaining_amount" type="varchar(255)" />
			<column name="clearing_priority" type="varchar(255)" />
	    </addColumn>
		<addForeignKeyConstraint baseColumnNames="dunning_default_pause_reason_id" baseTableName="crm_provider" constraintName="fk_dunning_default_pause_reason_provider" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_pause_reasons" />	
	    <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="ar_credit_category" constraintName="fk_acc_id_payment_token" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
	</changeSet>

    <changeSet id="#INTRD-2963_20211109" author="AbdelkaderBouazza">
        <dropTable tableName="invoice_dunning_statuses" cascadeConstraints="true"/>
    </changeSet>
    
    <changeSet id="#INTRD-2961_20211109" author="AmineBENAICHA">
		<renameColumn tableName="dunning_collection_plan_statuses"
			newColumnName="description" oldColumnName="context"
			columnDataType="varchar(255)" />
	    <addColumn tableName="dunning_collection_plan_statuses">
	        <column name="color_code" type="varchar(50)" />
	    </addColumn>
	</changeSet>

	<changeSet id="#INTRD-2973_20211110" author="AmineBENAICHA">
		<createSequence sequenceName="dunning_level_instance_seq" startValue="1" />
	    <createTable tableName="dunning_level_instance">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_level_instance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
			<column name="sequence" type="int4">
				<constraints nullable="false" />
			</column>
			<column name="days_overdue" type="int4" >
                <constraints nullable="false" />
            </column>
            <column name="dunning_policy_level_id" type="bigint" />
            <column name="dunning_collection_plan_id" type="bigint" />
            <column name="dunning_collection_plan_status_id" type="bigint"/>
            <column name="level_status" type="varchar(255)" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="dunning_policy_level_id" baseTableName="dunning_level_instance"
			constraintName="fk_dunning_policy_level" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_policy_level" />

        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_id" baseTableName="dunning_level_instance"
        	constraintName="fk_dunning_level_instance_collection_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />

        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_status_id" baseTableName="dunning_level_instance"
        	constraintName="fk_dunning_collection_plan_statuses" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan_statuses" />

		<createSequence sequenceName="dunning_action_instance_seq" startValue="1" />
		<createTable tableName="dunning_action_instance">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_action_instance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
			<column name="action_type" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="code" type="varchar(255)" />
			<column name="description" type="varchar(255)" />
			<column name="action_mode" type="varchar(255)" >
                <constraints nullable="false" />
            </column>
            <column name="dunning_agent_id" type="bigint" />
            <column name="action_restult" type="varchar(255)" />
            <column name="action_status" type="varchar(255)" />
            <column name="dunning_collection_plan_id" type="bigint" />
            <column name="dunning_level_instance_id" type="bigint" />
		</createTable>

		<addUniqueConstraint columnNames="code" constraintName="uk_dunning_action_instance_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_action_instance" />
            
        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_action_instance_collection_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
            
        <addForeignKeyConstraint baseColumnNames="dunning_level_instance_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_level_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_level_instance" />
	</changeSet>

	<changeSet id="#INTRD-3250part2_20211123" author="AmineBENAICHA" failOnError="false">
		<addForeignKeyConstraint baseColumnNames="dunning_agent_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_action_instance_agent" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_agent" />
	</changeSet>
	
	<changeSet id="#INTRD-3250_20211123" author="HatimOUDAD">
	    <addColumn tableName="dunning_action_instance">
	        <column name="dunning_action_id" type="bigint" />
	    </addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-3307_20211125" author="AmineBENAICHA">
	    <addColumn tableName="dunning_level_instance">
	        <column name="dunning_level_id" type="bigint" />
	    </addColumn>
	    <addForeignKeyConstraint baseColumnNames="dunning_level_id" baseTableName="dunning_level_instance" constraintName="fk_dunning_level_instance_dunning_level"
        	deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_level" />
	</changeSet>

    <changeSet id="#INTRD-3426_202112012" author="ZBariki">
        <modifyDataType columnName="start_date" newDataType="date" tableName="sub_accounting_period"/>
        <modifyDataType columnName="end_date" newDataType="date" tableName="sub_accounting_period"/>
    </changeSet>
	
	 <changeSet id="INTRD-2425_20211014" author="Mbarek-Ay">
     <addColumn tableName="billing_invoice">
            <column name="cpq_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />
    </changeSet>
    <changeSet id="INTRD-1421-Payment_deferral" author="AbdelkaderBouazza">
        <addColumn tableName="ar_account_operation">
            <column name="payment_action" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="payment_deferral_count" type="int4">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

	<changeSet id="INTRD-3610_20211210" author="TarikRabeh">
	    <addColumn tableName="billing_accounting_article">
	        <column name ="unit_price" type="numeric(23, 12)" />
	    </addColumn>
	</changeSet>

	<changeSet id="INTRD-3721_20211216" author="AmineBENAICHA">
	    <addColumn tableName="cpq_order_offer">
	        <column name ="order_line_type" type="varchar(10)" />
	    </addColumn>
	    <addColumn tableName="quote_offer">
	        <column name ="quote_line_type" type="varchar(10)" />
	    </addColumn>
	</changeSet>
    
    <changeSet id="INTRD-3781_20211217" author="hichamElHaloui">
        <createSequence sequenceName="security_deposit_settings_seq" startValue="1" />
        <createTable tableName="security_deposit_settings">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_settings_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="use_security_deposit" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="max_amount_security_deposit" type="numeric(23, 12)"  />
            <column name="max_amount_consumer" type="numeric(23, 12)"  />
            <column name="auto_refund" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_renew" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_transfer" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
    </changeSet>

    <changeSet id="INTRD-3707_20211216" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="dunning_level_instance" constraintName="fk_dunning_policy_level"/>
        <dropColumn tableName="dunning_level_instance">
            <column name="dunning_policy_level_id" />
        </dropColumn>
    </changeSet>
    <changeSet id="INTRD-3807_20211227" author="HHanine">
 		<addColumn tableName="billing_accounting_article">
            <column name="invoice_type_el" type="varchar(255)" />
            <column name="invoice_type_id" type="bigint" />
	    </addColumn>
		<addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="billing_accounting_article"
            constraintName="fk_billing_accounting_article_invoice_type" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>


    <changeSet id="#INTRD-3461_20212128" author="hichamElHaloui">

        <createSequence sequenceName="security_deposit_templat_seq" startValue="1" />

        <createTable tableName="security_deposit_templat">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_templat_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="template_name" type="varchar(100)" />
            <column name="currency_id" type="bigint" />
            <column name="allow_validity_date" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_validity_period" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="min_amount" type="numeric(23, 12)" />
            <column name="max_amount" type="numeric(23, 12)" />
            <column name="status" type="varchar(255)" />
            <column name="number_instantiation" type="int" />
        </createTable>

            <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="security_deposit_templat"
			constraintName="fk_adm_currency_security_deposit_templat" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />


		<createSequence sequenceName="security_deposit_seq" startValue="1" />

        <createTable tableName="security_deposit">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="cf_values" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}" />
            <column name="templat_id" type="bigint" />
            <column name="currency_id" type="bigint" />
            <column name="customer_account_id" type="bigint"/>
            <column name="validity_date" type="date" />
            <column name="validity_period" type="int4" />
            <column name="validity_period_unit" type="varchar(255)" />
            <column name="amount" type="numeric(23, 12)" />
            <column name="current_balance" type="numeric(23, 12)" />
            <column name="status" type="varchar(255)" />
            <column name="product_instance" type="varchar(255)"/>
            <column name="subscription_id" type="bigint"/>
            <column name="product_id" type="bigint"/>
            <column name="external_reference" type="varchar(255)"/>

		</createTable>

	<addForeignKeyConstraint baseColumnNames="templat_id" baseTableName="security_deposit"
			constraintName="fk_security_deposit_templat_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="security_deposit_templat" />

    <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="security_deposit"
			constraintName="fk_adm_currency_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />

    <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="security_deposit"
			constraintName="fk_ar_customer_account_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

    <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="security_deposit"
			constraintName="fk_billing_subscription_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

     <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="security_deposit"
			constraintName="fk_cpq_product_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

    </changeSet>
    
    <changeSet id="#INTRD-4072_20211229" author="AmineBENAICHA">
    	<renameTable newTableName="finance_settings" oldTableName="security_deposit_settings"/>
    	<renameSequence newSequenceName="finance_settings_seq" oldSequenceName="security_deposit_settings_seq" />

    	<dropPrimaryKey constraintName="security_deposit_settings_pkey"  
            schemaName="public"
            tableName="finance_settings"/>
        <addPrimaryKey columnNames="id" constraintName="finance_settings_pkey" tableName="finance_settings" />
    </changeSet>
    
    <changeSet id="#INTRD-4178_20220106" author="AmineBENAICHA">
    	<dropUniqueConstraint constraintName="uk_dunning_action_instance_code" tableName="dunning_action_instance"/>
    	<addUniqueConstraint columnNames="code, dunning_level_instance_id" constraintName="uk_dunning_action_instance_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_action_instance" />
    </changeSet>

    <changeSet id="#INTRD-4457_20220117" author="hichamElHaloui">
        <dropForeignKeyConstraint baseTableName="security_deposit" constraintName="fk_cpq_product_security_deposit"/>
        <dropColumn tableName="security_deposit">
            <column name="product_instance"></column>
            <column name="product_id"></column>
        </dropColumn>
        <addColumn tableName="security_deposit">
            <column name="invoice_receipt_number" type="varchar(255)" />
            <column name="service_instance_id" type="bigint"/>
        </addColumn>

         <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="security_deposit"
			constraintName="fk_billing_service_instance_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />

    </changeSet>

     <changeSet id="#INTRD-4454_20220117" author="hichamElHaloui">
         <dropColumn tableName="finance_settings">
            <column name="allow_renew"  />
            <column name="allow_transfer"  />
        </dropColumn>
     </changeSet>

    <changeSet id="#INTRD-4410_20220117" author="IlyassTalal">
    	<addColumn tableName="billing_user_account">
            <column name="parent_useraccount_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="parent_useraccount_id" baseTableName="billing_user_account" constraintName="fk_user_account_parent" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>
    
    <changeSet id="#INTRD-4677_20220125" author="hatimOUDAD">
        <addColumn tableName="billing_user_account">
            <column name="is_consumer" type="${type.boolean}" defaultValueNumeric="1">
            </column>
        </addColumn>
     </changeSet>

    <changeSet id="#INTRD-4705_20220127" author="AbdelmounaimAkadid">
	  	<createIndex indexName="billing_wallet_operation_charge_instance_idx" tableName="billing_wallet_operation">
	      	<column name="charge_instance_id"/>
	  	</createIndex>
	</changeSet>

	<changeSet id="#INTRD-4705-cpq_20220127" author="AbdelmounaimAkadid">
		<createIndex indexName="cpq_attribute_instance_service_instance_idx" tableName="cpq_attribute_instance">
	      	<column name="service_instance_id"/>
	  	</createIndex>
	</changeSet>
	<changeSet id="#INTRD-5636-20220318" author="hhanine">
		<createSequence sequenceName="exchange_rate_seq" startValue="1" />
		<createTable tableName="exchange_rate">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
			    <constraints nullable="false" primaryKey="true" primaryKeyName="exchange_rate_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
			    <constraints nullable="false" />
			</column>
			<column name="created" type="datetime">
			    <constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="trading_currency_id" type="bigint" />
			<column name="exchange_rate" type="numeric(23, 6)" />
			<column name="from_date" type="datetime" />
			<column name="current_rate" type="${type.boolean}" defaultValueNumeric="0">
			<constraints nullable="false" />
			</column>
		</createTable>
		<addForeignKeyConstraint baseColumnNames="trading_currency_id" baseTableName="exchange_rate" constraintName="fk_exchange_rate_trading_currency" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
	            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
	</changeSet>
	<changeSet id="#INTRD-4654_20220203" author="AbdelmounaimAkadid">
		<addColumn tableName="security_deposit">
			<column name="refund_reason" type="varchar(255)"/>
			<column name="cancel_reason" type="varchar(255)"/>
		</addColumn>
		<createSequence sequenceName="security_deposit_transaction_seq" startValue="1" />
		
		<createTable tableName="security_deposit_transaction">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_transaction_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="code" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="varchar(255)" />
		
			<column name="security_deposit_id" type="bigint" />
			<column name="account_operation_id" type="bigint" />
			<column name="security_deposit_operation" type="varchar(255)" />	            
			<column name="amount" type="numeric(23, 12)" />
			<column name="transactionDate" type="date" />
			<column name="transaction_category" type="varchar(255)" />
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="security_deposit_id" baseTableName="security_deposit_transaction"
			constraintName="fk_security_deposit_security_deposit_transaction" deferrable="false" initiallyDeferred="false"
			onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="security_deposit" />
			
		<addForeignKeyConstraint baseColumnNames="account_operation_id" baseTableName="security_deposit_transaction"
			constraintName="fk_ar_account_operation_security_deposit_transaction" deferrable="false" initiallyDeferred="false"
			onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
	
	</changeSet>
	
	<changeSet id="#INTRD-4654_20220203_2" author="HanineHicham">
	    <dropColumn tableName="security_deposit_transaction">
            <column name="transactionDate"></column>
        </dropColumn>
        <addColumn tableName="security_deposit_transaction">
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
			<column name="transaction_date" type="date" />
		</addColumn>
	</changeSet>

     <changeSet id="#INTRD-4777_20220208" author="hichamELHALOUI">
		<addUniqueConstraint columnNames="template_name" constraintName="uk_security_deposit_template_name" deferrable="false" disabled="false" initiallyDeferred="false" tableName="security_deposit_templat" />
	</changeSet>
    <changeSet id="#4065_2022" author="Mounir_BOUKAYOUA">
        <addColumn tableName="crm_customer">
            <column name="anonymization_date" type="datetime" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-4950-20220209" author="MohammedSTITANE">
        <createSequence sequenceName="ar_accounting_scheme_seq" startValue="1" />
        <createTable tableName="ar_accounting_scheme">
            <column name="id" type="${cast.long}" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_accounting_scheme_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="ar_accounting_scheme_pkey_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="long_description" type="varchar(2000)"/>
            <column name="script_instance_id" type="${cast.long}"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_accounting_scheme" constraintName="fk_acc_scheme_script_inst_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="meveo_script_instance"/>

        <addColumn tableName="ar_occ_template">
            <column name="accounting_scheme_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_scheme_id" baseTableName="ar_occ_template" constraintName="fk_occ_tmplt_accnt_scheme_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="ar_accounting_scheme"/>
    </changeSet>
    
     <changeSet id="#INTRD-4682_20220209" author="AndriusKarpavicius">
        <renameColumn tableName="adm_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="${type.boolean}"/>
        <renameColumn tableName="adm_role_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="${type.boolean}"/>
     </changeSet>
    <changeSet id="#INTRD-5200_2022-02-08" author="MohammedSTITANE">
	    <!--  comment is reserved word in oracle database-->
	    <renameColumn  oldColumnName="comment" newColumnName="comment_text" tableName="billing_invoice"/>
	    <renameColumn  oldColumnName="comment" newColumnName="comment_text" tableName="ar_account_operation"/>
	</changeSet>
	<changeSet id="#INTRD-5274_2022-02-22" author="HichamHANINE">
	    <dropForeignKeyConstraint baseTableName="billing_accounting_article" constraintName="fk_billing_accounting_article_invoice_type"/>
		<addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="billing_accounting_article"
            constraintName="fk_billing_accounting_article_invoice_type" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_invoice_type" />
	</changeSet>

    <changeSet id="#INTRD-5286_2022-02_23" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="amount_without_tax_before_discount" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8743_20220802" author="HichamHANINE">
		<addColumn tableName="billing_rated_transaction">
            <column name="reject_reason" type="varchar(4000)" />
            <column name="origin_billing_account" type="bigint" />
        </addColumn>

		<addForeignKeyConstraint baseColumnNames="origin_billing_account" baseTableName="billing_rated_transaction" constraintName="fk_billing_rt_origin_ba" deferrable="false" referencedColumnNames="id" referencedTableName="billing_billing_account" />
	</changeSet>

    <changeSet id="#INTRD-5306_2022-02_24" author="hichamELHALOUI">
        <addColumn tableName="crm_provider">
            <column name="functional_currency_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5343_2022-02_25" author="hichamELHALOUI">
        <addColumn tableName="billing_trading_currency">
            <column name="symbol" type="varchar(255)" />
            <column name="decimal_places" type="int" defaultValueNumeric="2" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5380_2022_02_28" author="ZBariki">
        <update tableName="billing_tax_mapping">
            <column name="version" value="0"/>
            <where>version is null</where>
        </update>
    </changeSet>



    <changeSet id="#INTRD-4798_20220303" author="MohamedSTITANE">
        <sql>
            create index cpq_commercial_rule_item_header_id_index on ${db.schema.adapted}cpq_commercial_rule_item (commercial_rule_header_id);
            create index cpq_tag_seller_id_index on ${db.schema.adapted}cpq_tag (seller_id);
            create index cpq_tag_tag_type_id_index on ${db.schema.adapted}cpq_tag (tag_type_id);
            create index cpq_tag_type_seller_id_index on ${db.schema.adapted}cpq_tag_type (seller_id);
            create index cpq_commercial_rule_header_attribute_id_index on ${db.schema.adapted}cpq_commercial_rule_header (attribute_id);
            create index cpq_commercial_rule_header_grouped_attributes_id_index on ${db.schema.adapted}cpq_commercial_rule_header (grouped_attributes_id);
            create index cpq_commercial_rule_header_grouped_service_id_index on ${db.schema.adapted}cpq_commercial_rule_header (grouped_service_id);
            create index cpq_commercial_rule_header_offer_template_id_index on ${db.schema.adapted}cpq_commercial_rule_header (offer_template_id);
            create index cpq_commercial_rule_header_product_id_index on ${db.schema.adapted}cpq_commercial_rule_header (product_id);
            create index cpq_commercial_rule_header_product_version_id_index on ${db.schema.adapted}cpq_commercial_rule_header (product_version_id);
            create index cpq_commercial_rule_header_service_template_id_index on ${db.schema.adapted}cpq_commercial_rule_header (service_template_id);
            create index cpq_commercial_rule_header_tag_id_index on ${db.schema.adapted}cpq_commercial_rule_header (tag_id);
        </sql>
    </changeSet>

     <changeSet id="#INTRD-5385_20220228" author="TarikFA.">
	     <addColumn tableName="cpq_quote_price">
	     	<column name="quantity" type="numeric(19,2)"/>
	     </addColumn>
	     <addColumn tableName="cpq_quote_price">
	     	<column name="discounted_quote_price" type="bigint"/>
	     </addColumn>
	     <renameColumn tableName="cpq_quote_price" oldColumnName="amount_without_tax_with_discount" newColumnName="amount_without_tax_without_discount"/>
	     <addForeignKeyConstraint baseColumnNames="discounted_quote_price" baseTableName="cpq_quote_price" constraintName="fk_discounted_quote_price" deferrable="false"
	     											initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_price" />
      </changeSet>
      
      <changeSet id="#INTRD-5529_20220304" author="TarikFA.">
      	<addColumn tableName="cpq_invoice_line">
	     	<column name="discounted_invoice_line" type="bigint"/>
      	</addColumn>
	     <addForeignKeyConstraint baseColumnNames="discounted_invoice_line" baseTableName="cpq_invoice_line" constraintName="fk_discounted_invoice_line" deferrable="false" 
	     											initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
      </changeSet>
      

    <changeSet id="#INTRD-5458_20220304" author="TarikRabeh">
    	<addColumn tableName="billing_invoice_configuration">
    		<column name="display_user_account_hierarchy" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>


    <changeSet id="#INTRD-5276_2022-02-24_PG" author="MohammedSTITANE" dbms="postgresql">
        <modifyDataType columnName="description" newDataType="varchar(4000)" tableName="billing_rated_transaction" />
    </changeSet>
    <changeSet id="#INTRD-5276_2022-02-24_ORACLE" author="MohammedSTITANE" dbms="oracle">
        <!-- fixing compatibility problem with oracle-->
        <renameColumn newColumnName="long_description" oldColumnName="description" tableName="billing_rated_transaction"/>
        <addColumn tableName="billing_rated_transaction">
            <column name="description" type="varchar(4000)"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_rated_transaction
            set description = DBMS_LOB.SUBSTR(long_description, 4000, 1)
            where long_description is not null ;
        </sql>
        <dropColumn columnName="long_description" tableName="billing_rated_transaction" />
    </changeSet>

    <changeSet id="#INTRD-5533_2022_03_07" author="ZBariki">
        <update tableName="billing_invoice_type">
            <column name="use_self_sequence" value="0"/>
            <where>use_self_sequence is null</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-4590-20220308" author="HatimOUDAD" failOnError="false">
        <createSequence sequenceName="cpq_order_amendement_seq" startValue="1" />
        <createTable tableName="cpq_order_amendement">
            <column name="id" type="${cast.long}" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_order_amendement_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="cpq_order_amendement_pkey_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="subscription_id" type="bigint"/>
            <column name="user_account_id" type="bigint" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_order_amendement"
			constraintName="fk_billing_subscription_order_amendement" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_order_amendement" constraintName="fk_order_amendement_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_suspend_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_suspend_id" baseTableName="cpq_order_product" constraintName="fk_prd_suspend_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_reactivate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_reactivate_id" baseTableName="cpq_order_product" constraintName="fk_prd_reactivate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_terminate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_terminate_id" baseTableName="cpq_order_product" constraintName="fk_prd_terminate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_activate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_activate_id" baseTableName="cpq_order_product" constraintName="fk_prd_activate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_restart_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_restart_id" baseTableName="cpq_order_product" constraintName="fk_prd_restart_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_offer">
            <column name="order_amendement_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_id" baseTableName="cpq_order_offer" constraintName="fk_offer_order_amd_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>


    </changeSet>

    <changeSet id="#INTRD-5419-20220308" author="HichamELHALOUI">
        <createSequence sequenceName="open_order_setting_seq" startValue="1" />
        <createTable tableName="open_order_setting">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="open_order_setting_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="code" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="varchar(255)" />
            <column name="use_open_orders" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="apply_maximum_validity" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="apply_maximum_validity_value" type="int" />
            <column name="apply_maximum_validity_unit" type="varchar(6)" />
            <column name="define_maximum_validity" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="define_maximum_validity_value" type="int" />
            <column name="use_managment_validation_for_oo_quotation" type="${type.boolean}" defaultValueNumeric="0" />

        </createTable>
    </changeSet>

    <changeSet id="#FIX-delete-tax" author="AbdelmounaimAkadid">
    	 <update tableName="billing_tax_mapping">
            <column name="version" value="0"/>
            <where>version is null</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-5628_2022-03_11" author="hichamELHALOUI">
        <addColumn tableName="billing_trading_currency">
            <column name="current_rate" type="numeric(23, 12)" />
            <column name="current_rate_from_date" type="datetime" />
            <column name="current_rate_updater" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5310-20220310" author="HichamELHALOUI">
        <createSequence sequenceName="open_order_threshold_seq" startValue="1"/>
        <createSequence sequenceName="open_order_template_seq" startValue="1"/>
        <createTable tableName="open_order_threshold">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="open_order_threshold_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="sequence" type="int"/>
            <column name="percentage" type="int"/>
            <column name="open_order_template_id" type="bigint"/>
        </createTable>

        <createTable tableName="open_order_threshold_recipients">
            <column name="threshold_id" type="bigint"/>
            <column name="recipient" type="varchar(100)"/>
        </createTable>

        <createTable tableName="open_order_template">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="open_order_template_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="open_order_type" type="varchar(50)"/>
        </createTable>
        <createTable tableName="open_order_template_tags">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="open_order_template_products">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="open_order_template_articles">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="threshold_id, recipient" constraintName="open_order_threshold_recipients_pkey"
                       tableName="open_order_threshold_recipients"/>
        <addPrimaryKey columnNames="open_order_template_id,tag_id"
                       constraintName="open_order_template_tags_pkey"
                             tableName="open_order_template_tags"/>
         <addPrimaryKey columnNames="open_order_template_id,product_id"
                             constraintName="open_order_template_products_pkey"
                             tableName="open_order_template_products"/>
         <addPrimaryKey columnNames="open_order_template_id,article_id"
                             constraintName="open_order_template_articles_pkey"
                             tableName="open_order_template_articles"/>

    </changeSet>

	<changeSet id="#INTRD-5341_20220307" author="aelmalki">
        <renameTable oldTableName="cpq_invoice_line" newTableName="billing_invoice_line"/>
        <renameSequence oldSequenceName="cpq_invoice_line_seq" newSequenceName="billing_invoice_line_seq" />

        <sql>ALTER TABLE ${db.schema.adapted}billing_invoice_line RENAME CONSTRAINT pk_cpq_invoice_line TO pk_billing_invoice_line;</sql>

        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_cpq_quote_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_accounting_article_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_offer_service_template_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_product_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_service_template_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_discount_plan_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_tax_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_commercial_order_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="cpq_invoice_line__order_lot__fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="cpq_invoice_line__product_version__fk"/>

        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="offer_service_template_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_offer_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_serv_templates" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_tax_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseTableName="billing_invoice_line" baseColumnNames="order_lot_id"
                                 constraintName="billing_invoice_line__order_lot__fk" referencedTableName="cpq_order_lot"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_invoice_line" baseColumnNames="product_version_id"
                                 constraintName="billing_invoice_line__product_version__fk"
                                 referencedTableName="cpq_product_version" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-4852-18032022" author="AbdelkaderBouazza">
        <dropNotNullConstraint tableName="cpq_commercial_order" columnName="order_type_id" />
    </changeSet>


    <changeSet id="#INTRD-5777_2022-03-17_PG" author="MohammedSTITANE" dbms="postgresql">
        <createView viewName="all_sequences_view" replaceIfExists="true">
            <![CDATA[
                select nextVal(quote_ident(sequencename))::text as seq_val, sequencename as seq_code
                FROM pg_catalog.pg_sequences
            ]]>
        </createView>
    </changeSet>
    <changeSet id="#INTRD-5777_2022-03-17_ORACLE" author="MohammedSTITANE" dbms="oracle">
        <sql endDelimiter="/">
            CREATE OR REPLACE FUNCTION get_next_val (seq_name IN VARCHAR2) RETURN VARCHAR AS
                v_seq_id number(38);
                sql_stmt VARCHAR(2000);
            BEGIN
                sql_stmt := 'select ' || seq_name || '.nextval from dual';
                execute immediate sql_stmt into v_seq_id ;
                DBMS_OUTPUT.PUT_LINE(seq_name || ' => ' || v_seq_id);
                RETURN to_char(v_seq_id);
            END;
            /
        </sql>
        <createView viewName="all_sequences_view" replaceIfExists="true">
            select get_next_val(SEQUENCE_NAME) as seq_val, lower(SEQUENCE_NAME) as seq_code FROM ${db.schema.adapted}user_sequences s
        </createView>
    </changeSet>



    <changeSet id="#INTRD-5804-20220321" author="HatimOUDAD">

    	<dropForeignKeyConstraint baseTableName="cpq_order_offer" constraintName="fk_offer_order_amd_id"/>
    	<dropColumn tableName="cpq_order_offer">
            <column name="order_amendement_id"></column>
        </dropColumn>

    	<dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_restart_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_restart_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_activate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_activate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_terminate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_terminate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_reactivate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_reactivate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_suspend_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_suspend_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_amendement" constraintName="fk_order_amendement_user_account_id"/>
    	<dropForeignKeyConstraint baseTableName="cpq_order_amendement" constraintName="fk_billing_subscription_order_amendement"/>
    	<dropTable tableName="cpq_order_amendement"/>

    	<addColumn tableName="cpq_order_product">
            <column name="production_action_type" type="varchar(10)" />
            <column name="termination_date" type="datetime" />
            <column name="sub_termin_reason_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_order_product" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbd" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />

        <addColumn tableName="cpq_order_offer">
            <column name="subscription_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_order_offer" constraintName="fk_dwdlb9d5mlvdddm3yowwa9uembd" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

    </changeSet>


    <changeSet id="#INTRD-4702-20220321" author="ZBariki">
        <addColumn tableName="ar_occ_template">
            <column name="contra_accounting_code_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="contra_accounting_code_id" baseTableName="ar_occ_template"
                                     constraintName="fk_contra_accounting_code_id" deferrable="false"
                                     initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                     referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet author="TarikRabeh" id="#INTRD-5841-21032022">
        <addColumn tableName="billing_billing_account">
            <column name="trading_currency_id" type="bigint" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-5921-20220324" author="AmineBENAICHA">
        <addColumn tableName="audit_log">
            <column name="source" type="VARCHAR(200)" />
        </addColumn>
    </changeSet>

	<changeSet author="TarikRabeh" id="#INTRD-5846-24032022">
    	<sql>update ${db.schema.adapted}billing_billing_account bba
    		set trading_currency_id = (select aca.trading_currency_id from ${db.schema.adapted}ar_customer_account aca where aca.id = bba.customer_account_id )
    		where bba.trading_currency_id is null
    	</sql>
        <addNotNullConstraint tableName="billing_billing_account" columnName="trading_currency_id"/>
        <addForeignKeyConstraint baseColumnNames="trading_currency_id" baseTableName="billing_billing_account" constraintName="fk_trading_currency_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
	</changeSet>

    <changeSet id="#INTRD-5881_20220322" author="aelmalki">
        <createSequence sequenceName="accounting_journal_entry_seq"/>
        <createTable tableName="accounting_journal_entry">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_accounting_journal_entry" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <!-- Dependencies -->
            <column name="accounting_operation_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="accounting_code_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="seller_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="customer_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tax_id" type="bigint" />

            <!-- Simple fields -->
            <column name="direction" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="amount" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="analytic_code_1" type="varchar(255)" />
            <column name="analytic_code_2" type="varchar(255)" />
            <column name="analytic_code_3" type="varchar(255)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_operation_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_account_operation" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />

        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_seller" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_customer_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_tax" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>

    <changeSet id="#INTRD-5994-20220328" author="HichamELHALOUI">
        <addColumn tableName="ar_occ_template">
            <column name="commission_accounting_code_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="commission_accounting_code_id" baseTableName="ar_occ_template"
                                 constraintName="fk_commission_accounting_code_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

    </changeSet>

	<changeSet id="#INTRD-5908-20220330" author="AmineBENAICHA">
		<createSequence sequenceName="global_settings_seq" startValue="1"/>
        <createTable tableName="global_settings">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="global_settings_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="quote_default_validity_delay" type="int" defaultValueNumeric="30">
            	<constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="#INTRD-6160-20220401" author="HichamELHALOUI">
        <dropForeignKeyConstraint baseTableName="ar_occ_template" constraintName="fk_commission_accounting_code_id"/>
        <renameColumn tableName="ar_occ_template" newColumnName="contra_accounting_code2_id" oldColumnName="commission_accounting_code_id"
                      columnDataType="bigint"/>
        <addForeignKeyConstraint baseColumnNames="contra_accounting_code2_id" baseTableName="ar_occ_template"
                                 constraintName="fk_contra_accounting_code2_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet id="#INTRD-6298_20220405" author="aelmalki">
        <addColumn tableName="ar_accounting_scheme">
            <column name="long_description_i18n" type="${type.json}" defaultValue='{"FRA":"", "ENG":""}'>
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6136-20220406" author="HatimOUDAD">
         <addColumn tableName="cpq_order_offer">
            <column name="termination_date" type="datetime" />
            <column name="sub_termin_reason_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_order_offer" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbdafs" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />
    </changeSet>

    <changeSet id="#INTRD-6263_20220406" author="AmineBENAICHA">
        <addColumn tableName="billing_billing_run">
            <column name="xml_job_execution_result_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6264_20220406" author="AmineBENAICHA">
        <addColumn tableName="billing_billing_run">
            <column name="pdf_job_execution_result_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6453_20220411" author="TarikRabeh">
        <addColumn tableName="billing_invoice_line">
            <column name="functional_unit_price" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6056_20220413" author="HatimOUDAD">
	    <addColumn tableName="cpq_quote_product">
	            <column name="product_action_type" type="varchar(10)" />
	            <column name="termination_date" type="datetime" />
	            <column name="sub_termin_reason_id" type="bigint" />
	    </addColumn>

	        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_quote_product" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbdcc" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />

	        <addColumn tableName="quote_offer">
	            <column name="subscription_id" type="bigint" />
	        </addColumn>
	        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="quote_offer" constraintName="fk_dwdlb9d5mlvdddm3yowwa9uembdcc" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
     </changeSet>

    <changeSet id="INTRD-6474-13042022" author="Abdelkader.Bouazza">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="charge_template_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_price_plan_matrix"
                                 constraintName="fk_cat_price_plan_matrix_cat_charge_template"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <sql>UPDATE ${db.schema.adapted}cat_price_plan_matrix SET charge_template_id = (SELECT id FROM ${db.schema.adapted}cat_charge_template WHERE code = event_code)</sql>
    </changeSet>

    <changeSet id="#INTRD-6562_20220414" author="aelmalki">
        <createSequence sequenceName="accounting_accountingcode_mapping_seq"/>
        <createTable tableName="accounting_accountingcode_mapping">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_accounting_accountingcode_mapping"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>

            <!-- Dependencies -->
            <column name="accounting_article_id" type="bigint"/>
            <column name="billing_country_id" type="bigint"/>
            <column name="billing_currency_id" type="bigint"/>
            <column name="seller_country_id" type="bigint"/>
            <column name="seller_id" type="bigint"/>

            <!-- Simple fields -->
            <column name="criteria_el" type="varchar(500)"/>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="billing_country_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_billing_country" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />

        <addForeignKeyConstraint baseColumnNames="billing_currency_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_trading_currency" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />

        <addForeignKeyConstraint baseColumnNames="seller_country_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_seller_country" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_seller" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet id="#INTRD-6562_20220414-new-field" author="aelmalki">
        <addColumn tableName="billing_accounting_article">
            <column name="accountingcode_el" type="varchar(500)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-5859_20220321" author="TarikFA.">
    	<addColumn tableName="billing_discount_plan_instance">
    		<column name="service_instance_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_discount_plan_instance" constraintName="fk_discount_instance_service_instance" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
    </changeSet>
    
     <changeSet id="#INTRD-5872_20220322" author="TarikFA.">
    	<addColumn tableName="billing_wallet_operation">
    		<column name="discounted_wallet_operation_id" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_wallet_operation" constraintName="fk_discount_plan_id_wallet_operation" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_rated_transaction" constraintName="fk_discount_plan_id_rated_transaction" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="cpq_quote_price">
			<column name="uuid" type="varchar(60)"/>
		</addColumn>
                                 
    </changeSet>
    
     <changeSet id="#INTRD-5872_20220326" author="R.AITYAAZZA">
    	<addColumn tableName="cpq_quote_price">
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_price" constraintName="fk_discount_plan_id_quote_price" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                
       <addColumn tableName="billing_rated_transaction">
    		<column name="discounted_ratedtransaction_id" type="bigint" />
    	</addColumn>                          
    </changeSet>
    
     <changeSet id="#INTRD-6108_20220330" author="TarikFA.">
    	<addColumn tableName="order_price">
    		<column name="quantity" type="numeric(19,2)" />
    		<column name="discounted_order_price" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discounted_order_price" baseTableName="order_price" constraintName="fk_order_price_discounted_order" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_price" />
                                 
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="order_price" constraintName="fk_order_price_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
    </changeSet>
     <changeSet id="#20220404_M540_6296" author="Mbarek-Ay">
	
		<addColumn tableName="cpq_quote_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_wallet_operation">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_invoice_line">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn> 
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
        
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_wallet_operation" constraintName="fk_wallet_operation_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
      
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_invoice_line" constraintName="fk_invoice_line_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
      </changeSet>

    <changeSet id="#20220407_ADHOC" author="NabilOuachi">
        <addColumn tableName="cat_discount_plan">
            <column name="applicable_on_overridden_price" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6631_20220419" author="TarikRabeh">
        <addColumn tableName="accounting_journal_entry">
            <column name="operation_number" type="bigint" />
            <column name="seller_code" type="varchar(255)" />
            <column name="client_unique_id" type="varchar(100)" />
            <column name="currency" type="varchar(3)" />
            <column name="supporting_document_ref" type="bigint" />
            <column name="supporting_document_type" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6633_20220420" author="TarikRabeh">
        <sql>
	        update ${db.schema.adapted}accounting_journal_entry set
		        seller_code = (select code from crm_seller cs where cs.id = seller_id),
		        client_unique_id = (select acc.registration_no from ar_customer_account acc where acc.id = customer_account_id),
		        currency = (select ac.currency_code from adm_currency ac, crm_provider pr where ac.id = pr.currency_id),
		        supporting_document_ref = (select aco.invoice_id from ar_account_operation aco where aco.id = accounting_operation_id),
		        supporting_document_type = (select bt.code from billing_invoice_type bt, billing_invoice inv,ar_account_operation aco where bt.id = inv.invoice_type_id and inv.id = aco.invoice_id and aco.id = accounting_operation_id)
        </sql>
        <addNotNullConstraint tableName="accounting_journal_entry" columnName="seller_code"/>
        <addNotNullConstraint tableName="accounting_journal_entry" columnName="currency"/>
    </changeSet>


    <changeSet id="#INTRD-6614_20220418" author="AmineBENAICHA">
    	<createSequence sequenceName="account_operation_number_seq" startValue="1" />
        <addColumn tableName="ar_account_operation">
            <column name="operation_number" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6664_20220420" author="aelmalki">
        <dropNotNullConstraint tableName="accounting_journal_entry" columnName="seller_id"/>
    </changeSet>

    <changeSet id="#INTRD-6536_20220419-change-on-field" author="aelmalki">
        <addColumn tableName="billing_accounting_article">
            <column name="column_criteria_el" type="varchar(500)"/>
        </addColumn>
        <addColumn tableName="accounting_accountingcode_mapping">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <renameColumn tableName="accounting_accountingcode_mapping" newColumnName="criteria_el_value" oldColumnName="criteria_el" />
    </changeSet>

    <changeSet id="#INTRD-6536_20220419-new-fk" author="aelmalki">
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet id="#INTRD-6668_20220421" author="TarikRabeh">
        <addColumn tableName="adm_currency">
            <column name="symbol" type="varchar(255)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-6672_20220511" author="HichamHANINE">
        <addColumn tableName="billing_invoice_line">
            <column name="target_tax_id" type="bigint" />
			<column name="target_tax_rate" type="numeric(23, 12)" />
        </addColumn>
		<addForeignKeyConstraint baseColumnNames="target_tax_id" baseTableName="billing_invoice_line" constraintName="fk_billing_invoice_line_target_tax_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>
    
    <changeSet id="#INTRD-7244_20220517" author="HichamHANINE">
        <addColumn tableName="billing_invoice_line">
            <column name="tax_mode" type="varchar(50)" />
        </addColumn>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_billing_invoice_line_target_tax_id"/>
		<dropColumn columnName="target_tax_id" tableName="billing_invoice_line" />
		<dropColumn columnName="target_tax_rate" tableName="billing_invoice_line" />
    </changeSet>

    <changeSet id="#INTRD-6616_20220421" author="AmineBENAICHA" dbms="postgres">
		<sql>
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;

			update ${db.schema.adapted}ar_account_operation
			set operation_number = nextval('account_operation_number_seq')
			from (select ap.start_date, ap.end_date
					 from accounting_period ap
					 where accounting_period_year='2022-2023') as current_ap
			where accounting_date between current_ap.start_date and current_ap.end_date;

			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;
		</sql>
	</changeSet>

	<changeSet id="INTRD-6608_20220420" author="AkadidAbdelmounaim">
    	<dropView viewName="billing_wallet_operation_period"/>
    	<renameColumn newColumnName="parameter_extra_old" oldColumnName="parameter_extra" tableName="billing_wallet_operation"/>
    	<renameColumn newColumnName="parameter_extra_old" oldColumnName="parameter_extra" tableName="billing_rated_transaction"/>
    	<addColumn tableName="billing_wallet_operation">
            <column name="parameter_extra" type="varchar(4000)"/>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="parameter_extra" type="varchar(4000)"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_wallet_operation
            set parameter_extra = parameter_extra_old
            where parameter_extra_old is not null;
        </sql>
        <sql>
            update ${db.schema.adapted}billing_rated_transaction
            set parameter_extra = parameter_extra_old
            where parameter_extra_old is not null;
        </sql>
        <dropColumn columnName="parameter_extra_old" tableName="billing_wallet_operation" />
        <dropColumn columnName="parameter_extra_old" tableName="billing_rated_transaction" />
    </changeSet>
        
    <changeSet id="INTRD-6608_20220420_pg" author="AkadidAbdelmounaim" dbms="postgres">
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>
    <changeSet id="INTRD-6608_20220420_oracle" author="AkadidAbdelmounaim" dbms="oracle">
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (trunc(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id)) = trunc(o.start_date)) then 0 else 1 end) as flag
            FROM billing_wallet_operation o WHERE o.status = 'OPEN') o
        </createView>
    </changeSet>

    <changeSet id="INTRD-6012-07042022" author="Abdelkader.Bouazza">
        <addColumn tableName="global_settings">
            <column name="activate_dunning" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-7179_20220524" author="HichamHANINE">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price_el" type="varchar(255)" />
        </addColumn>
		<addColumn tableName="cpq_price_plan_matrix_line">
            <column name="price_el" type="varchar(255)" />
        </addColumn>
        <sql>UPDATE cpq_price_plan_version SET price_el = amount_with_tax_el WHERE amount_with_tax_el is not null</sql>
		<sql>UPDATE cpq_price_plan_version SET price_el = amount_without_tax_el WHERE amount_without_tax_el is not null</sql>
		<dropColumn columnName="amount_without_tax_el" tableName="cpq_price_plan_version" />
        <dropColumn columnName="amount_with_tax_el" tableName="cpq_price_plan_version" />
    </changeSet>

    <changeSet id="#INTRD-10188_20220928" author="MehdiBOURRAS">
        <renameColumn tableName="cpq_price_plan_matrix_line" newColumnName="value_el" oldColumnName="price_el"
                      columnDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="#INTRD-6777_20220427" author="AmineBENAICHA" dbms="postgres">
		<sql>
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;

			UPDATE ${db.schema.adapted}ar_account_operation
			SET operation_number = null;

			UPDATE ${db.schema.adapted}ar_account_operation
			SET operation_number = nextval('account_operation_number_seq')
			FROM (select ap.start_date, ap.end_date
					 from accounting_period ap
					 where accounting_period_year='2022-2023') as current_ap
			WHERE accounting_date between current_ap.start_date and current_ap.end_date;

			ALTER TABLE ${db.schema.adapted}ar_account_operation ALTER COLUMN operation_number SET DEFAULT nextval('account_operation_number_seq');
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq OWNED BY ar_account_operation.operation_number;
		</sql>
	</changeSet>

    <changeSet id="#INTRD-6779_2022_04_28" author="ZBariki">
        <dropColumn tableName="billing_rated_transaction" columnName="accounting_article_id"/>
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction"
                                  constraintName="rated_transaction_article_fk"/>
        <renameColumn columnDataType="bigint" newColumnName="accounting_article_id"
                      oldColumnName="article_id" tableName="billing_rated_transaction"/>
        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="accounting_article_id"
                                 constraintName="fk_billing_rated_transaction_accounting_article_id"
                                 referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-6899_20220502" author="aelmalki">
        <dropNotNullConstraint tableName="accounting_journal_entry" columnName="customer_account_id"/>
    </changeSet>

    <changeSet id="#INTRD-6895_20220504" author="HichamHANINE">
		<sql>
			<![CDATA[
				ALTER SEQUENCE account_operation_number_seq RESTART WITH 1;
				update ar_account_operation as t
				set operation_number = nextval('account_operation_number_seq')
				from (select * 
						from ar_account_operation
						where accounting_date >= (select ap.start_date from accounting_period ap where accounting_period_year='2022-2023')
						and accounting_date <= (select ap.end_date from accounting_period ap where accounting_period_year='2022-2023')
						order by created) as s
				where s.id = t.id;
				ALTER SEQUENCE account_operation_number_seq RESTART WITH 1;
            ]]>			
		</sql>
	</changeSet>

    <changeSet id="#INTRD-7273_20220517" author="HichamHANINE">
		<sql>
			UPDATE billing_invoice_line set tax_mode = 'ARTICLE' where tax_mode is null
		</sql>
	</changeSet>

	<changeSet id="#INTRD-6923_20220505" author="hatimOUDAD">
        <dropNotNullConstraint tableName="cpq_commercial_order" columnName="order_type_id"/>
    </changeSet>


    <changeSet id="INTRD-7006_09052022" author="TarikRabeh">
        <addColumn tableName="accounting_journal_entry">
            <column name="trading_amount" type="numeric(23, 12)" />
            <column name="trading_currency" type="varchar(3)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="INTRD-7038_11052022" author="TarikRabeh">
        <addColumn tableName="billing_billing_run">
            <column name="is_quarantine" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="description" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7149_20220511" author="ZBariki">
        <addColumn tableName="accounting_journal_entry">
            <column name="auxiliary_account_code" type="varchar(255)" />
            <column name="auxiliary_account_label" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-6024-13052022" author="Abdelkader.Bouazza">
        <addColumn tableName="billing_invoice">
            <column name="is_reminder_level_triggered" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7099_2022051Z" author="ZBariki">
        <addColumn tableName="crm_provider">
            <column name="default_starting_date_of_plan" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-5806_20220516" author="HichamELHALOUI">
        <addColumn tableName="finance_settings">
            <column name="open_order_settings_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="finance_settings" baseColumnNames="open_order_settings_id"
                                 constraintName="fk_finance_settings_open_order_setting_id" referencedTableName="open_order_setting"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-7192_20220518" author="ZBariki">
        <addColumn tableName="finance_settings">
            <column name="use_auxiliary_accounting" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="auxiliary_account_code_el" type="varchar(2000)" />
            <column name="auxiliary_account_label_el" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-5311_20220518" author="HichamELHALOUI">

        <dropColumn tableName="open_order_threshold">
            <column name="created" />
            <column name="updated" />
            <column name="creator" />
            <column name="updater" />
            <column name="code" />
            <column name="description" type="varchar(255)"/>
        </dropColumn>
        <addUniqueConstraint columnNames="code" constraintName="uk_open_order_template_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="open_order_template" />

    </changeSet>

    <!--  fix for forgotten FK in current -->
    <changeSet id="INTRD-5311_20220518-fix" author="AkadidAbdelmounaim" failOnError="false">
    	<addForeignKeyConstraint baseTableName="open_order_threshold" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_threshold_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id" onDelete="CASCADE" onUpdate="CASCADE"/>


        <addForeignKeyConstraint baseTableName="open_order_template_tags" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_tags_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_tags" baseColumnNames="tag_id"
                                 constraintName="open_order_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_products_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="product_id"
                                 constraintName="open_order_template_products_product_id_fk"
                                 referencedTableName="cpq_product"
                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_articles_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="article_id"
                                 constraintName="open_order_template_articles_article_id_fk"
                                 referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="INTRD-5312_20220518" author="HichamELHALOUI">
        <addColumn tableName="open_order_template">
            <column name="status" type="varchar(255)" />
        </addColumn>
    </changeSet>
    <changeSet id="INTRD-7031-18052022" author="Abdelkader.Bouazza">
        <addColumn tableName="billing_invoice">
            <column name="related_dunning_collection_plan_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="related_dunning_collection_plan_id" baseTableName="billing_invoice" constraintName="fk_invoice_related_collection_plan"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
    </changeSet>

    <!--  was split to deblock deploy -->
    <changeSet id="INTRD-7031-18052022-split" author="AbdelmounaimAkadid" failOnError="false">
        <sql>update ${db.schema.adapted}billing_invoice as invoice set related_dunning_collection_plan_id = (SELECT dc.id FROM dunning_collection_plan as dc WHERE dc.related_invoice_id=invoice.id)
        </sql>
    </changeSet>


    <changeSet id="INTRD-7040_18052022" author="TarikRabeh">
        <dropColumn tableName="billing_billing_run">
            <column name="description"></column>
        </dropColumn>
        <addColumn tableName="billing_billing_run">
            <column name="description_i18n" type="${type.json}" defaultValue='{"FRA":"", "ENG":""}'>
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-7039_23052022" author="TarikRabeh">
        <sql>
            <![CDATA[
				alter table billing_billing_run alter column description_i18n drop not null;
			]]>
        </sql>
    </changeSet>

    <changeSet id="#INTRD-7157_20220523" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="dunning_collection_plan_triggered" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-5725_20220524" author="HichamELHALOUI" >
        <addColumn tableName="open_order_template">
            <column name="number_instantiation" type="int" />
              <column name="template_name" type="varchar(100)" />
        </addColumn>

    </changeSet>

    <changeSet id="#INTRD-7422_20220525" author="ZBariki">
        <addColumn tableName="ar_customer_account">
            <column name="general_client_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="general_client_account_id" baseTableName="ar_customer_account"
                                 constraintName="fk_general_client_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>


    <changeSet id="#INTRD-7537_20220531" author="TarikRabeh">
        <addColumn tableName="billing_billing_run">
            <column name="origin_billing_run_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="origin_billing_run_id" baseTableName="billing_billing_run" constraintName="fk_billing_billing_run_origin_billing_run"
              					 referencedColumnNames="id" referencedTableName="billing_billing_run"/>
    </changeSet>

    <changeSet id="INTRD-5570_20220601" author="AbdelmounaimAkadid">
     	<addColumn tableName="billing_invoice">
            <column name="last_applied_rate" type="numeric(23, 12)" />
            <column name="last_applied_rate_date" type="datetime" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7428_20220601" author="ZBariki">
        <addDefaultValue tableName="finance_settings" columnName="auxiliary_account_code_el"
                         defaultValue="#{gca.code.substring(0, 3)}#{ca.description}"/>
        <addDefaultValue tableName="finance_settings" columnName="auxiliary_account_label_el"
                         defaultValue="#{ca.description}"/>
    </changeSet>

    <changeSet id="#INTRD-7629_20220603" author="HatimOUDAD">
    	<addColumn tableName="cpq_order_product">
            <column name="instance_status" type="varchar(10)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-7479_20220603" author="AndriusKarpavicius">
        <renameColumn tableName="sub_accounting_period" oldColumnName="number" newColumnName="period_number"/>
    </changeSet>

    <changeSet id="#INTRD-7642_20220603" author="ZBariki">
        <createSequence sequenceName="billing_invoice_line_conversion_seq"/>
        <createSequence sequenceName="billing_invoice_conversion_seq"/>

        <createTable tableName="billing_invoice_line_conversion">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_invoice_line_conversion"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="invoice_line_id" type="bigint"/>
            <column name="invoice_id" type="bigint"/>
            <column name="invoice_conversion_id" type="bigint"/>
            <column name="applied_rate" type="numeric(23, 12)"/>
            <column name="applied_rate_date" type="datetime"/>
            <column name="invoice_currency_id" type="bigint"/>
            <column name="unit_price" type="numeric(23, 12)"/>
            <column name="amount_with_tax" type="numeric(23, 12)"/>
            <column name="amount_without_tax" type="numeric(23, 12)"/>
            <column name="amount_tax" type="numeric(23, 12)"/>
            <column name="discount_amount" type="numeric(23, 12)"/>
            <column name="raw_amount" type="numeric(23, 12)"/>
        </createTable>

        <createTable tableName="billing_invoice_conversion">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_invoice_conversion"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="invoice_id" type="bigint"/>
            <column name="applied_rate" type="numeric(23, 12)"/>
            <column name="applied_rate_date" type="datetime"/>
            <column name="invoice_currency_id" type="bigint"/>
            <column name="amount_with_tax" type="numeric(23, 12)"/>
            <column name="amount_without_tax" type="numeric(23, 12)"/>
            <column name="amount_tax" type="numeric(23, 12)"/>
            <column name="discount_amount" type="numeric(23, 12)"/>
            <column name="raw_amount" type="numeric(23, 12)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_line_id"
                                 constraintName="billing_invoice_line_conversion_invoice_line_id_fk"
                                 referencedTableName="billing_invoice_line"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_id"
                                 constraintName="billing_invoice_line_conversion_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_conversion_id"
                                 constraintName="billing_invoice_line_conversion_invoice_conversion_id_fk"
                                 referencedTableName="billing_invoice_conversion"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_currency_id"
                                 constraintName="billing_invoice_line_conversion_invoice_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_invoice_conversion" baseColumnNames="invoice_id"
                                 constraintName="billing_invoice_conversion_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_conversion" baseColumnNames="invoice_currency_id"
                                 constraintName="billing_invoice_conversion_invoice_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-7399_20220603" author="aelmalki" failOnError="false">
        <createSequence sequenceName="ar_payment_plan_seq"/>
        <createTable tableName="ar_payment_plan">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_ar_payment_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="ar_payment_plan_code_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            <column name="amount_to_recover" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="amount_per_installment" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="remaining_amount" type="numeric(23, 12)" />
            <column name="action_on_remaining_amount" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="number_of_installments" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="start_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="end_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="recurring_unit" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <!-- Dependencies -->
            <column name="customer_account_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="ar_payment_plan"
                                 constraintName="fk_payment_plan_customer_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

        <createTable tableName="ar_payment_plan_created_aos">
            <column name="payment_plan_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="payment_plan_id, account_operation_id" constraintName="ar_payment_plan_created_aos_pkey" tableName="ar_payment_plan_created_aos" />

        <createTable tableName="ar_payment_plan_targeted_aos">
            <column name="payment_plan_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="payment_plan_id, account_operation_id" constraintName="ar_payment_plan_targeted_aos_pkey" tableName="ar_payment_plan_targeted_aos" />
    </changeSet>

    <changeSet id="#INTRD-7644_20220606" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_line_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_conversion_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_currency_id_fk"/>

        <dropForeignKeyConstraint baseTableName="billing_invoice_conversion"
                                  constraintName="billing_invoice_conversion_invoice_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_conversion"
                                  constraintName="billing_invoice_conversion_invoice_currency_id_fk"/>

        <dropSequence sequenceName="billing_invoice_conversion_seq"/>
        <dropSequence sequenceName="billing_invoice_line_conversion_seq"/>

        <dropTable tableName="billing_invoice_conversion"/>
        <dropTable tableName="billing_invoice_line_conversion"/>

        <dropColumn tableName="billing_invoice_line">
            <column name="functional_unit_price" />
        </dropColumn>

        <addColumn tableName="billing_invoice_line">
            <column name="converted_unit_price" type="numeric(23, 12)" />
            <column name="converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="converted_amount_with_tax" type="numeric(23, 12)" />
            <column name="converted_tax_rate" type="numeric(23, 12)" />
            <column name="converted_discount_rate" type="numeric(23, 12)" />
            <column name="converted_amount_tax" type="numeric(23, 12)" />
            <column name="converted_discount_amount" type="numeric(23, 12)" />
            <column name="converted_raw_amount" type="numeric(23, 12)" />
        </addColumn>

        <addColumn tableName="billing_invoice">
            <column name="converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="converted_amount_with_tax" type="numeric(23, 12)" />
            <column name="converted_amount_tax" type="numeric(23, 12)" />
            <column name="converted_net_to_pay" type="numeric(23, 12)" />
            <column name="converted_raw_amount" type="numeric(23, 12)" />
            <column name="converted_discount_rate" type="numeric(23, 12)" />
            <column name="converted_discount_amount" type="numeric(23, 12)" />
            <column name="converted_amount_without_tax_before_discount" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-7663_20220613" author="ZBariki">
		<sql>UPDATE billing_invoice SET last_applied_rate = 1, last_applied_rate_date = created
                       WHERE last_applied_rate IS NULL</sql>

		<sql>UPDATE billing_invoice SET converted_amount_without_tax = amount_without_tax
                       WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_with_tax = amount_with_tax
                       WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_tax = amount_tax WHERE converted_amount_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_net_to_pay = net_to_pay WHERE converted_net_to_pay IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_raw_amount = raw_amount WHERE converted_raw_amount IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_discount_rate = discount_rate
                       WHERE converted_discount_rate IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_discount_amount = discount_amount
                       WHERE converted_discount_amount IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_without_tax_before_discount = amount_without_tax_before_discount
                       WHERE converted_amount_without_tax_before_discount IS NULL</sql>

		<sql>UPDATE billing_invoice_line SET converted_unit_price = unit_price WHERE converted_unit_price IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_without_tax = amount_without_tax
                            WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_with_tax = amount_with_tax
                            WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_tax_rate = tax_rate WHERE converted_tax_rate IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_discount_rate = discount_rate
                            WHERE converted_tax_rate IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_tax = amount_tax WHERE converted_amount_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_discount_amount = discount_amount
                            WHERE converted_discount_amount IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_raw_amount = raw_amount WHERE converted_raw_amount IS NULL</sql>
	</changeSet>

     <changeSet id="#INTRD-7352_20220614" author="HatimOUDAD" >
         <dropColumn tableName="open_order_template">
            <column name="number_instantiation" />
        </dropColumn>
	</changeSet>
	
    <changeSet id="#INTRD-7124-130622" author="AbdelkaderBouazza">
        <addColumn tableName="dunning_policy">
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7770_20220613" author="aelmalki">
        <addColumn tableName="billing_invoice">
            <column name="payment_plan_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_plan_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_payment_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_plan" />
    </changeSet>

    <changeSet id="#INTRD-4424_20220221" author="Mounir_BOUKAYOUA">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="invoice_agreement_immediately" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <sql>update ${db.schema.adapted}billing_subscrip_termin_reason set invoice_agreement_immediately = 0</sql>
    </changeSet>
    
    <changeSet id="#INTRD-7954_20220616" author="AbdelmounaimAkadid">
     	<createIndex indexName="idx_billing_invoice_line__invoice_id" tableName="billing_invoice_line">
	      	<column name="invoice_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx_billing_user_account__parent_useraccount_id" tableName="billing_user_account">
	      	<column name="parent_useraccount_id"/>
	  	</createIndex>
    </changeSet>

    <changeSet id="#INTRD-7872_20220615" author="ZBariki">
        <addColumn tableName="billing_invoice_agregate">
            <column name="converted_amount_without_tax" type="numeric(23, 12)"/>
            <column name="converted_amount_with_tax" type="numeric(23, 12)"/>
            <column name="converted_amount_tax" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7872_20220615-data" author="ZBariki">
		<sql>UPDATE billing_invoice_agregate SET converted_amount_without_tax = amount_without_tax
                                WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_agregate SET converted_amount_with_tax = amount_with_tax
                                WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_agregate SET converted_amount_tax = amount_tax
                                WHERE converted_amount_tax IS NULL</sql>
	</changeSet>

    <changeSet id="#INTRD-7605_20220617" author="TarikRabeh">
        <addColumn tableName="cpq_product">
            <column name="price_version_date_setting" type="varchar(255)" defaultValue="DELIVERY">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="price_version_date_setting" type="varchar(255)" />
            <column name="price_version_date" type="datetime" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-7722_20220618" author="ZBariki">
        <dropSequence sequenceName="generic_sequence_seq"/>
    </changeSet>

    
    <changeSet id="#INTRD-8026_20220621" author="HatimOUDAD">
        <addColumn tableName="open_order_threshold">
            <column name="external_recipient" type="varchar(100)"/>
        </addColumn>
    </changeSet>
    

    <changeSet id="#INTRD-8055_20220621" author="AbdelkaderBouazza">
        <addColumn tableName="ar_occ_template">
            <column name="manual_creation_enabled" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <update tableName="ar_occ_template" >
            <column name="manual_creation_enabled" value="0"/>
            <where>code in ('CRD_SD', 'CRD_TRS', 'DBT_TRS', 'DEB_SD', 'INV_CRN', 'INV_DIS', 'INV_REB', 'INV_STD', 'PAY_BATCH', 'PAY_DEP', 'PPL_CREATION', 'PPL_INSTALLMENT', 'REF_SD', 'TAX_VAT_00', 'TAX_VAT_05', 'TAX_VAT_10', 'TAX_VAT_20')</where>
        </update>
    </changeSet>
    
    <changeSet id="#INTRD-8036-20220621" author="hichamhanine">
        <createSequence sequenceName="invoice_sub_totals_seq" startValue="1" />
        <createTable tableName="invoice_sub_totals">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="invoice_sub_totals_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />            

            <column name="sub_total_el" type="varchar(2000)" />
            <column name="label" type="varchar(50)" />
            <column name="invoice_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="label_i18n" type="${type.json}" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="invoice_sub_totals" constraintName="fk_invoice_sub_totals_invoice_type" deferrable="false" initiallyDeferred="false"
				onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>
    
    <changeSet id="#INTRD-8026_20220622" author="HatimOUDAD">
        <createSequence sequenceName="open_order_quote_seq"/>
        <createTable tableName="open_order_quote">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_quote" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_quote_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

           
            <column name="external_reference" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="open_order_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_number" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="max_amount" type="numeric">
                <constraints nullable="false" />
            </column>
            <column name="currency_id" type="bigint">
                <constraints nullable="false" />
            </column>     
            <column name="end_validity_date" type="datetime">
                <constraints nullable="true" />
            </column>
            <column name="activation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_quote"
                                 constraintName="fk_open_order_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
     	<addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="open_order_quote"
                                 constraintName="fk_currency_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="open_order_quote"
                                 constraintName="fk_billing_account_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
                                 
                                 
        <addColumn tableName="open_order_threshold">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="open_order_threshold" constraintName="fk_threshold_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="cpq_product">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="cpq_product" constraintName="fk_cpq_product_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="billing_accounting_article">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="billing_accounting_article" constraintName="fk_billing_accounting_article_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="cpq_tag">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="cpq_tag" constraintName="fk_tag_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
    </changeSet>
    
	<changeSet author="hichamhanine" id="#INTRD-7850-20220622">
    	<dropUniqueConstraint tableName="ar_payment_token" uniqueColumns="customer_account_id, iban" constraintName="customer_account_id_iban_unique"/>
    </changeSet>

    <changeSet id="#INTRD-8109_20220622" author="ZBariki">
        <createIndex indexName="accounting_journal_entry_auxiliary_accounting_code_idx"
                     tableName="accounting_journal_entry">
            <column name="auxiliary_account_code"/>
        </createIndex>
    </changeSet>
    
	<changeSet id="#INTRD-8158_20220624" author="TarikFA.">
    	<createSequence sequenceName="edr_versioning_rule_seq"/>
    	<createSequence sequenceName="mediation_setting_seq"/>
    	
    	<createTable tableName="mediation_setting">
    	 	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_mediation_setting" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
    		<column name="enable_edr_versioning" type="${type.boolean}" defaultValueNumeric="0" />
    	</createTable>
    	
    	<createTable tableName="edr_versioning_rule">
    	 	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_edr_versioning_rule" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
    		<column name="priority" type="int4" >
    			<constraints nullable="false" />
    		</column>
    		<column name="criterial_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="key_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="is_new_version_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="mediation_setting_id" type="bigint" >
    			<constraints nullable="false" />
    		</column>
    	</createTable>
    	
    	
        <addForeignKeyConstraint baseColumnNames="mediation_setting_id" baseTableName="edr_versioning_rule" constraintName="fk_edr_versioning_rule_mediation_setting" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="mediation_setting" />
    </changeSet>

    <changeSet id="#INTRD-8147_20220624" author="anas.rouaguebe">
        <addColumn tableName="accounting_journal_entry">
            <column name="journal_code" type="varchar(50)" />
            <column name="category" type="varchar(50)" />
            <column name="account" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="customer_code" type="varchar(50)" />
            <column name="customer_name" type="varchar(255)" />
            <column name="seller_name" type="varchar(255)" />
            <column name="reference" type="varchar(50)" />
            <column name="document_type" type="varchar(50)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-8211_20220626" author="anas.rouaguebe">
		<addDefaultValue tableName="com_meveo_instance" columnName="version" defaultValueNumeric="0" />
		<update tableName="com_meveo_instance" >
            <column name="version" value="0" />
            <where>version is null</where>
        </update>
    </changeSet>

	<changeSet id="#INTRD-8067_20220627" author="anas.rouaguebe">
		<addDefaultValue tableName="billing_tax_mapping" columnName="version" defaultValueNumeric="0" />
		<update tableName="billing_tax_mapping">
			<column name="version" valueNumeric="0" />
			<where>version is null</where>
		</update>
	</changeSet>

    <changeSet id="#INTRD-8077_20220625" author="ZBariki">
        <addColumn tableName="billing_accounting_article">
            <column name="ignore_aggregation" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-8022_20220624" author="HatimOUDAD" >
        <createSequence sequenceName="open_order_article_seq"/>
        <createTable tableName="open_order_article">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_article_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_article_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            
            <column name="active" type="${type.boolean}"/>
            

            <!-- Dependencies -->
            <column name="accounting_article_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="open_order_article"
                                 constraintName="fk_open_billing_accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />
                                 
        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_article"
                                 constraintName="fk_open_order_template_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
		
		<createSequence sequenceName="open_order_product_seq"/>
        <createTable tableName="open_order_product">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_product_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_product_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            
            <column name="active" type="${type.boolean}"/>
            

            <!-- Dependencies -->
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="open_order_product"
                                 constraintName="fk_product_open_order_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
                                 
        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_product"
                                 constraintName="fk_open_order_template_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
		
      	</changeSet>

      	<changeSet id="#INTRD-8023_20220624-fk1" author="HatimOUDAD" failOnError="false">
        	<dropForeignKeyConstraint baseTableName="open_order_template_products"
	                               constraintName="open_order_template_products_product_id_fk"/>

	        <dropForeignKeyConstraint baseTableName="open_order_template_articles"
	                               constraintName="open_order_template_articles_article_id_fk"/>
        </changeSet>

      	<changeSet id="#INTRD-8023_20220624" author="HatimOUDAD" >

		    <dropPrimaryKey constraintName="open_order_template_articles_pkey" tableName="open_order_template_articles"/>
		    <dropPrimaryKey constraintName="open_order_template_products_pkey" tableName="open_order_template_products"/>
		    <dropColumn tableName="open_order_template_products">
	            <column name="product_id" />
	        </dropColumn>

	        <dropColumn tableName="open_order_template_articles">
	            <column name="article_id" />
	        </dropColumn>

	        <addColumn tableName="open_order_template_products">
		        <column name="open_product_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </addColumn>

	        <addColumn tableName="open_order_template_articles">
	        <column name="open_article_id" type="bigint">
	            <constraints nullable="false"/>
	        </column>
	        </addColumn>


	        <addPrimaryKey columnNames="open_order_template_id,open_article_id"
		            constraintName="open_order_template_articles_pkey"
		            tableName="open_order_template_articles"/>
	        <addPrimaryKey columnNames="open_order_template_id,open_product_id"
		            constraintName="open_order_template_products_pkey"
		            tableName="open_order_template_products"/>

        </changeSet>

        <changeSet id="#INTRD-8023_20220624-fk2" author="HatimOUDAD" failOnError="false">
        	<addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="open_product_id"
	                               constraintName="open_order_template_products_product_id_fk"
	                               referencedTableName="open_order_product"
	                               referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="open_article_id"
	                               constraintName="open_order_template_articles_article_id_fk"
	                               referencedTableName="open_order_article"
	                               referencedColumnNames="id"/>
        </changeSet>

		<changeSet id="#INTRD-8219_20220627" author="HatimOUDAD" >

			<dropForeignKeyConstraint baseTableName="cpq_product"
	                               constraintName="fk_cpq_product_open_quote"/>
	        <dropColumn tableName="cpq_product">
	            <column name="open_order_quote_id" />
	        </dropColumn>

	        <dropForeignKeyConstraint baseTableName="billing_accounting_article"
	                               constraintName="fk_billing_accounting_article_open_quote"/>
	        <dropColumn tableName="billing_accounting_article">
	            <column name="open_order_quote_id" />
	        </dropColumn>

	        <dropForeignKeyConstraint baseTableName="cpq_tag"
	                               constraintName="fk_tag_open_quote"/>
	        <dropColumn tableName="cpq_tag">
	            <column name="open_order_quote_id" />
	        </dropColumn>


	        <createTable tableName="open_order_quote_tags">
	           <column name="open_order_quote_id" type="bigint">
	               <constraints nullable="false"/>
	           </column>
	           <column name="tag_id" type="bigint">
	               <constraints nullable="false"/>
	           </column>
	        </createTable>
	        <createTable tableName="open_order_quote_products">
	            <column name="open_order_quote_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	            <column name="open_product_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </createTable>
	        <createTable tableName="open_order_quote_articles">
	            <column name="open_order_quote_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	            <column name="open_article_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </createTable>

	        <addPrimaryKey columnNames="open_order_quote_id,tag_id"
	                       constraintName="open_order_quote_tags_pkey"
	                             tableName="open_order_quote_tags"/>
	         <addPrimaryKey columnNames="open_order_quote_id,open_product_id"
	                             constraintName="open_order_quote_products_pkey"
	                             tableName="open_order_quote_products"/>
	         <addPrimaryKey columnNames="open_order_quote_id,open_article_id"
	                             constraintName="open_order_quote_articles_pkey"
	                             tableName="open_order_quote_articles"/>

	         <addForeignKeyConstraint baseTableName="open_order_quote_tags" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_tags_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_tags" baseColumnNames="tag_id"
	                                 constraintName="open_order_quote_tags_tag_id_fk" referencedTableName="cpq_tag"
	                                 referencedColumnNames="id"/>


	        <addForeignKeyConstraint baseTableName="open_order_quote_products" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_products_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_products" baseColumnNames="open_product_id"
		                                 constraintName="open_order_quote_products_product_id_fk"
		                                 referencedTableName="open_order_product"
		                                 referencedColumnNames="id"/>


	        <addForeignKeyConstraint baseTableName="open_order_quote_articles" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_articles_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_articles" baseColumnNames="open_article_id"
		                                 constraintName="open_order_quote_articles_article_id_fk"
		                                 referencedTableName="open_order_article"
		                                 referencedColumnNames="id"/>


		</changeSet>

		<changeSet id="#INTRD-8132_20220628" author="anas.rouaguebe" >
			<addColumn tableName="billing_invoice">
				<column name="open_order_number" type="varchar(255)" />
			</addColumn>
			<addColumn tableName="billing_invoice_line">
				<column name="open_order_number" type="varchar(255)" />
			</addColumn>
		</changeSet>

    <changeSet id="#INTRD-8117_20220629" author="ZBariki">
        <createSequence sequenceName="open_order_seq"/>
        <createTable tableName="open_order">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_code_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="external_reference" type="varchar(255)"/>
            <column name="type" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(25)">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_number" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="initial_amount" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="currency_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_quote_id" type="bigint"/>
            <column name="end_of_validity_date" type="datetime"/>
            <column name="activation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="balance" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="billing_account_id"
                                 constraintName="open_order_billing_account_id_fk"
                                 referencedTableName="billing_billing_account"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="currency_id"
                                 constraintName="open_order_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="open_order_quote_id"
                                 constraintName="open_order_open_order_quote_id_fk"
                                 referencedTableName="open_order_quote"
                                 referencedColumnNames="id"/>

        <addColumn tableName="open_order_threshold">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_product">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_accounting_article">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="open_order_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="open_order_threshold" baseColumnNames="open_order_id"
                                 constraintName="open_order_threshold_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_product" baseColumnNames="open_order_id"
                                 constraintName="cpq_product_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_accounting_article" baseColumnNames="open_order_id"
                                 constraintName="billing_accounting_article_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_tag" baseColumnNames="open_order_id"
                                 constraintName="cpq_tag_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-8106_20220630" author="TarikFA.">
    	<addColumn tableName="rating_edr">
            <column name="event_key" type="varchar(100)" />
            <column name="event_version" type="int4" />
    	</addColumn>
    </changeSet>

        <changeSet id="#INTRD-8027_20220629" author="aelmalki">
            <dropColumn tableName="open_order_product" columnName="code" />
            <dropColumn tableName="open_order_product" columnName="description" />
            <dropColumn tableName="open_order_article" columnName="code" />
            <dropColumn tableName="open_order_article" columnName="description" />
        </changeSet>

    <changeSet id="#INTRD-8580_20220714" author="aelmalki">
        <renameColumn tableName="open_order_quote" newColumnName="quote_number" oldColumnName="open_order_number"/>
        <addColumn tableName="open_order_quote">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_id" baseTableName="open_order_quote"
                                 constraintName="fk_open_order" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order" />
    </changeSet>

    <changeSet id="#20220326_M540_178" author="Mbarek-Ay">

        <createTable tableName="cpq_assigned_attributes">
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="assigned_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="attribute_id,assigned_attribute_id" tableName="cpq_assigned_attributes"/>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="assigned_attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_assigned_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

    </changeSet>

     <changeSet id="#20220408_M540_6296" author="Rachid.Aityaazza">
        <addColumn tableName="cat_discount_plan_item">
            <column name="apply_by_article" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20220412_M540_172" author="Mbarek-Ay">

		<addColumn tableName="order_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>

        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="order_price" constraintName="fk_order_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
      </changeSet>

	<changeSet id="#20220412_M540_6533" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
		<addColumn tableName="order_price">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
		<addColumn tableName="billing_charge_instance">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
	</changeSet>


       <changeSet id="#20220415_M540_6609" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
		<addColumn tableName="billing_charge_instance">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
      </changeSet>

      <changeSet id="#20220415_M540_6296" author="Rachid.Aityaazza">
		<dropNotNullConstraint columnDataType="bigint" columnName="order_article_line_id" tableName="order_price" />
	</changeSet>


	<changeSet id="#20220415_M540_6931" author="Mbarek-Ay">
		<addColumn tableName="cat_discount_plan">
		<column name="applicable_on_discounted_price" type="${type.boolean}"/>
		<column name="sequence" type="int4"/>
		</addColumn>

	   	<addColumn tableName="crm_provider">
		<column name="activate_cascading_discounts" type="${type.boolean}" defaultValueNumeric="1"/>
		</addColumn>

		<addColumn tableName="cat_discount_plan_item">
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="billing_wallet_operation">
		<column name="discounted_amount" type="numeric(23,12)"/>
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="cpq_quote_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>

		<addColumn tableName="order_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>

		<addColumn tableName="billing_rated_transaction">
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="billing_invoice_line">
		<column name="sequence" type="int4"/>
		</addColumn>

		<createSequence sequenceName="discount_plan_sequence_seq" />
		<sql>
		alter sequence ${db.schema.adapted}discount_plan_sequence_seq RESTART WITH 1;
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='PRODUCT';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='OFFER';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='QUOTE';
		</sql>

      </changeSet>

      <changeSet id="#20220519_M540_7341" author="Mbarek-Ay">
      <addColumn tableName="cat_discount_plan_item">
		<column name="last_discount" type="${type.boolean}"/>
		</addColumn>
	 </changeSet>

    <changeSet id="#INTRD-4681_20220407" author="AndriusKarpavicius">
        <addColumn tableName="dwh_chart">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}dwh_chart set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="dwh_chart" columnName="role_id"/>

        <addColumn tableName="adm_script_exec_role">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}adm_script_exec_role set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="adm_script_exec_role" columnName="role_id"/>

        <createSequence sequenceName="adm_secured_entity_seq" startValue="1" />

        <addColumn tableName="adm_script_sourc_role">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}adm_script_sourc_role set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="adm_script_sourc_role" columnName="role_id"/>

        <addColumn tableName="adm_secured_entity">
            <column name="id" type="bigint"/>
            <column name="user_name" type="varchar(255)"/>
            <column name="role_name" type="varchar(255)"/>
            <column name="entity_id" type="bigint"/>
            <column name="permission" type="varchar(6)"/>
        </addColumn>

        <renameColumn tableName="adm_secured_entity" oldColumnName="code" newColumnName="entity_code" columnDataType="varchar(255)"/>

        <sql>update ${db.schema.adapted}adm_secured_entity set id=nextval('adm_secured_entity_seq'), permission ='DELETE', user_name= (select u.username from ${db.schema.adapted}adm_user u where u.id=user_id)</sql>
        <sql>insert into ${db.schema.adapted}adm_secured_entity (id, role_name, entity_code, entity_class, permission, disabled) (select nextval('adm_secured_entity_seq'), r.role_name, se.code, se.entity_class, 'DELETE', disabled from ${db.schema.adapted}adm_role r join ${db.schema.adapted}adm_role_secured_entity se on r.id=se.role_id)</sql>

        <dropColumn tableName="adm_secured_entity" columnName="user_id"/>
        <addNotNullConstraint tableName="adm_secured_entity" columnName="id"/>

        <sql>CREATE INDEX adm_secured_entity_username_index ON ${db.schema.adapted}adm_secured_entity(lower(user_name))</sql>
        <sql>CREATE INDEX adm_secured_entity_rolename_index ON ${db.schema.adapted}adm_secured_entity(role_name)</sql>

        <dropTable tableName="adm_role_secured_entity"/>
        <dropTable tableName="adm_user_role"/>
        <dropTable tableName="adm_role_permission"/>
        <dropTable tableName="adm_permission"/>
        <dropTable tableName="adm_role_role"/>

        <addColumn tableName="ord_order">
            <column name="routed_to_user_group" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order set routed_to_user_group=(select code from ${db.schema.adapted}hierarchy_entity he where he.id=routed_to_user_group_id)</sql>
        <dropColumn tableName="ord_order" columnName="routed_to_user_group_id"/>

        <addColumn tableName="ord_quote">
            <column name="routed_to_user_group" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}ord_quote set routed_to_user_group=(select code from ${db.schema.adapted}hierarchy_entity he where he.id=routed_to_user_group_id)</sql>
        <dropColumn tableName="ord_quote" columnName="routed_to_user_group_id"/>

        <dropColumn tableName="adm_user" columnName="email"/>
        <dropColumn tableName="adm_user" columnName="firstname"/>
        <dropColumn tableName="adm_user" columnName="lastname"/>
        <dropColumn tableName="adm_user" columnName="title_id"/>
        <dropColumn tableName="adm_user" columnName="hierarchy_level_id"/>
        <dropColumn tableName="adm_user" columnName="last_login_date"/>
        <dropColumn tableName="adm_user" columnName="crm_address_book_id"/>
        <dropColumn tableName="adm_role" columnName="role_description"/>

    </changeSet>

    <changeSet id="#INTRD-8689_20220727" author="ZBariki">
        <dropColumn tableName="billing_invoice_line" columnName="converted_tax_rate"/>
        <dropColumn tableName="billing_invoice_line" columnName="converted_discount_rate"/>
        <dropColumn tableName="billing_invoice" columnName="converted_discount_rate"/>
    </changeSet>

	<changeSet id="#INTRD-8753_20220727_001" author="anas.rouaguebe">
		<createSequence sequenceName="cpq_billing_rule_seq" startValue="1" />
		<createTable tableName="cpq_billing_rule">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_rule_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="contract_id" type="bigint" />
            <column name="priority" type="int4">
            	<constraints nullable="false" />
            </column>
            <column name="criteria_el" type="varchar(2000)">
            	<constraints nullable="false" />
            </column>
            <column name="invoice_ba_code_el" type="varchar(2000)">
			    <constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

    <changeSet id="#INTRD-8700_20220728" author="ZBariki">
        <addColumn tableName="billing_tax">
            <column name="composite" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="main_tax_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="main_tax_id" baseTableName="billing_tax"
                                 constraintName="fk_billing_tax_main_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>

    <changeSet id="#INTRD-8812_20220729" author="ZBariki">
        <dropUniqueConstraint constraintName="open_order_article_unique" tableName="open_order_article"/>
        <dropColumn tableName="open_order_article" columnName="code"/>
        <dropColumn tableName="open_order_article" columnName="description"/>
    </changeSet>

    <changeSet id="#INTRD-8719_20220727" author="TarikRabeh">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price"  type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8721_20220728" author="TarikRabeh">
        <sql>update cpq_price_plan_version set price = amount_without_tax where 1 in (select cp.entreprise from crm_provider cp)</sql>
		<sql>update cpq_price_plan_version set price = amount_with_tax where 0 in (select cp.entreprise from crm_provider cp)</sql>
        <dropColumn tableName="cpq_price_plan_version" columnName="amount_without_tax"/>
        <dropColumn tableName="cpq_price_plan_version" columnName="amount_with_tax"/>
    </changeSet>

	<changeSet id="#INTRD-8777_20220728" author="aelmalki">
		<createTable tableName="billing_run_job_execution">
			<column name="billing_run_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="job_execution_id" type="bigint">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="billing_run_job_execution" baseColumnNames="billing_run_id"
								 constraintName="billing_run_job_execution_billing_run_id_fk" referencedTableName="billing_billing_run"
								 referencedColumnNames="id"/>

		<addForeignKeyConstraint baseTableName="billing_run_job_execution" baseColumnNames="job_execution_id"
								 constraintName="billing_run_job_execution_job_execution_id_fk" referencedTableName="job_execution"
								 referencedColumnNames="id"/>

	</changeSet>

    <changeSet id="#INTRD-8701_20220801" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="billing_tax"
                                  constraintName="fk_billing_tax_main_tax_id"/>
        <dropColumn tableName="billing_tax" columnName="main_tax_id"/>
        <createTable tableName="billing_tax_composition">
            <column name="main_tax_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="sub_tax_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="main_tax_id, sub_tax_id"
                       constraintName="billing_tax_composition_pkey" tableName="billing_tax_composition" />
        <addForeignKeyConstraint baseColumnNames="main_tax_id" baseTableName="billing_tax_composition"
                                 constraintName="fk_billing_tax_composition_main_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="sub_tax_id" baseTableName="billing_tax_composition"
                                 constraintName="fk_billing_tax_composition_sub_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>
    <changeSet id="#INTRD-8252_20220628" author="Abdelkader.Bouazza">
        <addColumn tableName="com_contact">
            <column name="reference" type="varchar(80)" />
            <column name="comment" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8706_20220812" author="TarikFA." dbms="oracle" >
    	<dropUniqueConstraint tableName="billing_invoice" constraintName="uk_billing_invoice"/>
    </changeSet>

	<changeSet id="#INTRD-9117_20220811" author="aelmalki">
		<createTable tableName="open_order_products">
			<column name="open_order_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="open_product_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<createTable tableName="open_order_articles">
			<column name="open_order_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="open_article_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		 <addPrimaryKey columnNames="open_order_id,open_product_id"
							 constraintName="open_order_products_pkey"
							 tableName="open_order_products"/>
		 <addPrimaryKey columnNames="open_order_id,open_article_id"
							 constraintName="open_order_articles_pkey"
							 tableName="open_order_articles"/>

        <addForeignKeyConstraint baseTableName="open_order_products" baseColumnNames="open_order_id"
                                 constraintName="open_order_products_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_products" baseColumnNames="open_product_id"
	                                 constraintName="open_order_products_product_id_fk"
	                                 referencedTableName="open_order_product"
	                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_articles" baseColumnNames="open_order_id"
                                 constraintName="open_order_articles_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_articles" baseColumnNames="open_article_id"
	                                 constraintName="open_order_articles_article_id_fk"
	                                 referencedTableName="open_order_article"
	                                 referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="#INTRD-9117_20220814-remove-oo-ids" author="aelmalki">
		<dropColumn tableName="billing_accounting_article" columnName="open_order_id" />
		<dropColumn tableName="cpq_product" columnName="open_order_id" />
	</changeSet>

    <changeSet id="#INTRD-86_20220815" author="AbdellatifBARI">
        <addColumn tableName="billing_invoice_configuration">
            <column name="display_tax_details" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7301_20220820_order" author="zelmeliani">
        <addColumn tableName="cpq_commercial_order">
            <column name="sales_person_name" type="varchar(52)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7301_20220820_subscription" author="zelmeliani">
        <addColumn tableName="billing_subscription">
            <column name="sales_person_name" type="varchar(52)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-9232_20220819" author="aelmalki">
        <addColumn tableName="billing_article_mapping_line">
            <column name="attribute_operator" type="varchar(10)" defaultValue="AND">
                <constraints nullable="false"/>
			</column>
        </addColumn>
        <addColumn tableName="billing_attribute_mapping">
            <column name="operator" type="varchar(50)" defaultValue="EQUAL">
                <constraints nullable="false"/>
			</column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8867_20220817-" author="KHorri">
        <addColumn tableName="open_order">
            <column name="cancel_reason" type="varchar(4000)"/>
        </addColumn>
    </changeSet>

    <changeSet  id="#INTRD-7950_20220816" author="Abdelkader.Bouazza">
         <update tableName="crm_provider">
            <column name="email" value="billing@opencellsoft.com" type="varchar(100)"/>
            <where>email is null</where>
         </update>
         <addNotNullConstraint tableName="crm_provider" columnName="email" columnDataType="varchar(100)"/>
	</changeSet>

    <changeSet id="#INTRD-9451_20220902" author="KhalidHORRI" >

        <createTable tableName="open_order_tags">
            <column name="open_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="open_order_id,tag_id"
                       constraintName="open_order_tags_pkey"
                       tableName="open_order_tags"/>

        <addForeignKeyConstraint baseTableName="open_order_tags" baseColumnNames="open_order_id"
                                 constraintName="open_order_tags_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_tags" baseColumnNames="tag_id"
                                 constraintName="open_order_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
        <dropForeignKeyConstraint baseTableName="cpq_tag"
                                  constraintName="cpq_tag_open_order_id_fk"/>
        <dropColumn tableName="cpq_tag">
            <column name="open_order_id" />
        </dropColumn>
    </changeSet>

    
    

    <changeSet id="#INTRD-9442_20220831" author="HichamHANINE">
		<addColumn tableName="billing_rated_transaction">
            <column name="rules_contract_id" type="bigint" />
        </addColumn>
		<addColumn tableName="billing_wallet_operation">
            <column name="rules_contract_id" type="bigint" />
        </addColumn>
		<addForeignKeyConstraint baseColumnNames="rules_contract_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rt_rules_contract" deferrable="false" referencedColumnNames="id" referencedTableName="cpq_contract" />
		<addForeignKeyConstraint baseColumnNames="rules_contract_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wa_op_rules_contract" deferrable="false" referencedColumnNames="id" referencedTableName="cpq_contract" />
	</changeSet>

    <changeSet id="#INTRD-9331_20220824_rt_migration" author="anas.rouaguebe">
        <sql>update ${db.schema.adapted}billing_rated_transaction set origin_billing_account = billing_account__id where origin_billing_account is null</sql>
    </changeSet>

    <changeSet id="#INTRD-7303_20220824_sales_person_name_migration" author="zelmeliani">
        <sql>
        	update ${db.schema.adapted}cpq_quote set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_quote.creator) = lower(adm_user.username)
			and (cpq_quote.sales_person_name is null or cpq_quote.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_quote set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_quote.creator) = lower(adm_user.username)
			and (cpq_quote.sales_person_name is null or cpq_quote.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_commercial_order set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_commercial_order.creator) = lower(adm_user.username)
			and (cpq_commercial_order.sales_person_name is null or cpq_commercial_order.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_commercial_order set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_commercial_order.creator) = lower(adm_user.username)
			and (cpq_commercial_order.sales_person_name is null or cpq_commercial_order.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}billing_subscription set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(billing_subscription.creator) = lower(adm_user.username)
			and (billing_subscription.sales_person_name is null or billing_subscription.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}billing_subscription set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(billing_subscription.creator) = lower(adm_user.username)
			and (billing_subscription.sales_person_name is null or billing_subscription.sales_person_name = '');
		</sql>
	</changeSet>
    <changeSet id="#INTRD-9383-20220830" author="Abdelkader.Bouazza">
        <modifyDataType tableName="ar_customer_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="billing_billing_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="billing_user_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="com_contact" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="com_sender_config" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_customer" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_provider" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_provider_contact" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_seller" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="ord_order_item" columnName="address_zipcode" newDataType="varchar(20)" />
    </changeSet>

    <changeSet id="#INTRD-9535-20220902" author="Abdelkader.Bouazza">
        <createTable tableName="crm_address_book_contact">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="crm_address_book_contact_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="address_book_id" type="bigint" />
            <column name="contact_id" type="bigint" />
            <column name="position" type="varchar(30)" />
            <column name="main_contact" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
        <addForeignKeyConstraint baseTableName="crm_address_book_contact" baseColumnNames="address_book_id"
                                 constraintName="address_book_contact_address_book_fk"
                                 referencedTableName="crm_address_book"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="crm_address_book_contact" baseColumnNames="contact_id"
                                 constraintName="address_book_contact_contact_fk"
                                 referencedTableName="com_contact"
                                 referencedColumnNames="id"/>
        <addUniqueConstraint columnNames="id,address_book_id,contact_id" constraintName="id_address_book_id_contact_id_UNIQUE" tableName="crm_address_book_contact" />
        <addColumn tableName="com_contact">
            <column name="entreprise" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-9383-20220905" author="Abdelkader.Bouazza">
        <modifyDataType tableName="ar_customer_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="billing_billing_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="billing_user_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="com_contact" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="com_sender_config" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_customer" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_provider" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_provider_contact" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_seller" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="ord_order_item" columnName="address_city" newDataType="varchar(100)" />
    </changeSet>

	<changeSet id="#INTRD-9583-20220906-br-generateao" author="a.rouaguebe">
		<addColumn tableName="billing_billing_run">
            <column name="generate_ao" type="${type.boolean}" defaultValueNumeric="0">
            	<constraints nullable="false" />
            </column>
        </addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-9581_20200907" author="TarikFA.">
		<addColumn tableName="billing_wallet_operation">
			<column name="price_plan_matrix_version_id" type="bigint" />
			<column name="price_plan_matrix_line_id" type="bigint" />
			<column name="contract_id" type="bigint" />
		</addColumn>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_version_id_fk" 
								 referencedTableName="cpq_price_plan_version" 
								 baseColumnNames="price_plan_matrix_version_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_line_fk" 
								 referencedTableName="cpq_price_plan_matrix_line" 
								 baseColumnNames="price_plan_matrix_version_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
		
		<addForeignKeyConstraint constraintName="contract_id_fk" 
								 referencedTableName="cpq_contract" 
								 baseColumnNames="contract_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
	</changeSet>
    <changeSet id="INTRD-9535-20220908" author="Abdelkader.bouazza">
        <addColumn tableName="crm_address_book">
            <column name="customer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="address_book_crm_customer_id_fk"
                                 baseColumnNames="customer_id"
                                 baseTableName="crm_address_book"
                                 referencedTableName="crm_customer"
                                 referencedColumnNames="id" />
        <sql>update crm_address_book ab set customer_id=(select customer.id from crm_customer customer where customer.address_book_id = ab.id)</sql>
    </changeSet>

    <changeSet id="#INTRD-9598-20220909-contact-category" author="a.rouaguebe">
        <createTable tableName="com_contact_category">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="com_contact_category_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_com_contact_category_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="com_contact_category" />
    </changeSet>
    <changeSet id="#INTRD-9684-20220909" author="khalidHORRI">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price_version_type" type="varchar(255)" defaultValue="FIXED">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <renameColumn tableName="cpq_price_plan_matrix_line" oldColumnName="price_without_tax" newColumnName="value"/>
    </changeSet>

    <changeSet id="#INTRD-9854-20220915-contact-category-many-to-many" author="a.rouaguebe">
    	<createTable tableName="com_contact_category_contact">
            <column name="contact_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="contact_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
    	</createTable>

    	<addUniqueConstraint columnNames="contact_id,contact_category_id" constraintName="com_contact_category_contact_pk" tableName="com_contact_category_contact" />

        <addForeignKeyConstraint constraintName="contact_category_id_fk"
                                 baseColumnNames="contact_category_id"
                                 baseTableName="com_contact_category_contact"
                                 referencedTableName="com_contact_category"
                                 referencedColumnNames="id" />

		<addForeignKeyConstraint constraintName="contact_id_fk"
                                 baseColumnNames="contact_id"
                                 baseTableName="com_contact_category_contact"
                                 referencedTableName="com_contact"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-9786-20220915" author="HichamHANINE">
        <addColumn tableName="crm_provider">
            <column name="rgaa_message" type="varchar(500)" >
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-10283_20220930" author="HichamHANINE">
        <addColumn tableName="security_deposit">
            <column name="billing_account_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="security_deposit"
			constraintName="fk_billing_account_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
    </changeSet>
    
    <changeSet id="#INTRD-9946_20220920" author="HichamHANINE">
        <addColumn tableName="security_deposit">
            <column name="sd_invoice_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="sd_invoice_id" baseTableName="security_deposit" constraintName="fk_security_deposit_invoice"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>
    
    <changeSet id="#INTRD-10581_20221018" author="HichamHANINE">
        <addColumn tableName="meveo_script_instance">
            <column name="description_i18n" type="${type.json}"></column>
        </addColumn>
    </changeSet>
    
	<changeSet id="#INTRD-9871_20220919" author="TarikFA.">
	
		<dropForeignKeyConstraint constraintName="price_plan_matrix_line_fk"  baseTableName="billing_wallet_operation"/>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_line_fk" 
								 referencedTableName="cpq_price_plan_matrix_line" 
								 baseColumnNames="price_plan_matrix_line_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
	</changeSet>
    
    <changeSet id="#INTRD-9804-20220915" author="khalidHORRI">
        <modifyDataType tableName="cpq_contract_item" columnName="rate" newDataType="${type.float}"/>
    </changeSet>
    
    <changeSet id="#INTRD-10097_202000926" author="TarikFA.">
    	<addColumn tableName="cat_offer_template">
            <column name="generate_quote_edr_per_product" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>
    
     <changeSet id="#INTRD-10135_28092022" author="Mbarek-Ay">
		<update tableName="cpq_attribute"><column name="attribute_type" value="NUMERIC"/><where>id=-9</where></update>
		<update tableName="cpq_attribute"><column name="attribute_type" value="NUMERIC"/><where>id=-10</where></update>
		<update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getActivationDate()}"/><where>id=-1</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getQuantity()}"/><where>id=-2</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getEventDate()}"/><where>id=-3</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getQuantity()}"/><where>id=-4</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getRenewalDate()}"/><where>id=-5</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getDeliveryDate()}"/><where>id=-6</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{quote.getValidationDate()}"/><where>id=-7</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{quote.getValidationDate()}"/><where>id=-8</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getSubscriptionMonthsAge()}"/><where>id=-9</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getSubscriptionDaysAge()}"/><where>id=-10</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter1()}"/><where>id=-11</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter2()}"/><where>id=-12</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter3()}"/><where>id=-13</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter4()}"/><where>id=-14</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter5()}"/><where>id=-15</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter6()}"/><where>id=-16</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter7()}"/><where>id=-17</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter8()}"/><where>id=-18</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter9()}"/><where>id=-19</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam1()}"/><where>id=-21</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam2()}"/><where>id=-22</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam3()}"/><where>id=-23</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam4()}"/><where>id=-24</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam5()}"/><where>id=-25</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam1()}"/><where>id=-31</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam2()}"/><where>id=-32</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam3()}"/><where>id=-33</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam4()}"/><where>id=-34</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam5()}"/><where>id=-35</where></update>
	</changeSet>
	
	<changeSet id="#INTRD-10163_20220930" author="TarikFA.">
		<createSequence sequenceName="billing_invoice_advance_mapping_seq" startValue="1"/>
		<createTable tableName="billing_invoice_advance_mapping">
			 <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="advance_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name= "advance_invoice_id" type="bigint" />
            <column name= "invoice_id" type="bigint" />
            <column name= "amount" type="numeric(23, 12)" />
		</createTable>
		
        <addForeignKeyConstraint baseTableName="billing_invoice_advance_mapping" 
        						baseColumnNames="advance_invoice_id"
                                 constraintName="advance_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
                                 
        <addForeignKeyConstraint baseTableName="billing_invoice_advance_mapping" 
        						baseColumnNames="invoice_id"
                                 constraintName="invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
                                 
		<addColumn tableName="billing_invoice">
            <column name= "invoice_balance" type="numeric(23, 12)" />
        </addColumn>
	</changeSet>

	<changeSet id="#INTRD-9796_30092022_exclude_aged_balance" author="a.rouaguebe">
		<addColumn tableName="billing_invoice_type">
			<column name="exclude_from_aged_trial_balance" type="${type.boolean}" defaultValueNumeric="0">
		    	<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

    <changeSet id="#INTRD-8158_20220915" author="AndriusKarpavicius" >
        <modifyDataType tableName="edr_versioning_rule" columnName="criterial_el" newDataType="varchar(2000)"/>
        <modifyDataType tableName="edr_versioning_rule" columnName="key_el" newDataType="varchar(2000)"/>
        <modifyDataType tableName="edr_versioning_rule" columnName="is_new_version_el" newDataType="varchar(2000)"/>
    </changeSet>

    <changeSet id="#INTRD-4681_20220929" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}adm_secured_entity set entity_class = reverse(split_part(reverse(entity_class),'.',1))</sql>
    </changeSet>
    
    <changeSet id="#INTRD-10274_20221003" author="AndriusKarpavicius">
        <dropPrimaryKey tableName="adm_secured_entity" constraintName="adm_secured_entity_pkey"/>
        <dropNotNullConstraint tableName="adm_secured_entity" columnName="user_name"/>
        <addPrimaryKey columnNames="id" tableName="adm_secured_entity"/>
    </changeSet>
	
	<changeSet id="#INTRD-9766_20221011_EDR_new_fields" author="aelmalki">
		<addColumn tableName="rating_edr">
			<column name="wallet_operation_id" type="bigint"/>
		</addColumn>
	</changeSet>
    
    <changeSet id="#INTRD-10540_20221013" author="TarikFA.">
    	<dropTable tableName="billing_invoice_advance_mapping"/>
    </changeSet>
    
    <changeSet id="INTRD-10603_20221113" author="AbdelmounaimAkadid">	
		<modifyDataType tableName="adm_inbound_req_cookies" columnName="coockies" newDataType="varchar(500)" />
		<modifyDataType tableName="adm_inbound_req_cookies" columnName="coockies_key" newDataType="varchar(500)" />
	</changeSet>	
	
	<changeSet id="#INTRD-10607_20221014" author="AdilElJaouhari">
		<addColumn tableName="billing_invoice">
            <column name="use_current_rate" type="${type.boolean}" defaultValueNumeric="0">
            	<constraints nullable="false" />
            </column>
        </addColumn>
	</changeSet>

    <changeSet id="#INTRD-10541_20221013" author="TarikFA.">
	    <addColumn tableName="billing_linked_invoices">
	            <column name="amount" type="numeric(23, 12)" />
	            <column name="type" type="varchar(50)" />
	    </addColumn>
	    
		<addForeignKeyConstraint constraintName="invoice_id_fk"
                                 baseColumnNames="id"
                                 baseTableName="billing_linked_invoices"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id" />
                                 
		<addForeignKeyConstraint constraintName="linked_invoice_id_fk"
                                 baseColumnNames="linked_invoice_id"
                                 baseTableName="billing_linked_invoices"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id" />
    	
    </changeSet>
	
	<changeSet id="#INTRD-10522_20221017_matchingCode-journal-entry" author="aelmalki">
		<addColumn tableName="accounting_journal_entry">
			<column name="matching_code" type="varchar(255)" />
		</addColumn>
		<addColumn tableName="crm_provider">
			<column name="current_matching_code" type="varchar(255)" />
		</addColumn>
	</changeSet>
    <changeSet id="#INTRD-10693_20221019-sd-adjustment" author="a.rouaguebe">
        <addColumn tableName="security_deposit">
            <column name="sd_adjustment_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="security_deposit"
                                 baseColumnNames="sd_adjustment_id"
                                 constraintName="fk_security_adjustment_invoice"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>

    <changeSet id="#10629_20221018" author="zelmeliani">
        <addColumn tableName="billing_invoice_line">
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-10673_20221025" author="AbdellatifBARI">
        <addColumn tableName="finance_settings">
            <column name="activate_dunning" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
     <changeSet id="#INTRD-10957_20221026" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_version">
            <column name="comment" type="varchar(2000)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-10577_20221020" author="HichamHANINE">
        <addColumn tableName="meveo_script_instance_cat">
            <column name="description_i18n" type="${type.json}">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-10768-20221108-validationrule" author="a.rouaguebe">
        <createSequence sequenceName="billing_invoice_validation_rule_seq" startValue="1" />
        <createTable tableName="billing_invoice_validation_rule">
            <column name="id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="invoice_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="type" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="fail_status" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="validation_script" type="${type.text}" />
            <column name="validation_el" type="${type.text}" />
        </createTable>
    </changeSet>
    
    
    <changeSet author="AndriusKarpavicius" id="#INTRD-10253_20221027" dbms="oracle">
        <createProcedure>
          create or replace type listagg_clob_t as object
            ( t_varchar2 varchar2(32767)
            , t_clob clob
            , static function odciaggregateinitialize( sctx in out listagg_clob_t )
              return number
            , member function odciaggregateiterate
                ( self in out listagg_clob_t
                , a_val varchar2
                )
              return number
            , member function odciaggregateterminate
                ( self in out listagg_clob_t
                , returnvalue out clob
                , flags in number
                )
              return number
            , member function odciaggregatemerge
                ( self in out listagg_clob_t
                , ctx2 in out listagg_clob_t
                )
              return number
            );
        </createProcedure>
        <createProcedure>
            create or replace type body listagg_clob_t
                is
                  static function odciaggregateinitialize( sctx in out listagg_clob_t )
                  return number
                  is
                  begin
                    sctx := listagg_clob_t( null, null );
                    return odciconst.success;
                  end;
                --
                  member function odciaggregateiterate
                    ( self in out listagg_clob_t
                    , a_val varchar2
                    )
                  return number
                  is
                    procedure add_val( p_val varchar2 )
                    is
                    begin
                      if nvl( lengthb( self.t_varchar2 ), 0 ) + lengthb( p_val ) &lt;= 4000
                -- Strange limit, the max size of self.t_varchar2 is 29993
                -- If you exceeds this number you get ORA-22813: operand value exceeds system limits
                -- with 29993 you get JSON-output as large 58894 bytes
                -- with 4000 you get JSON-output as large 1063896 bytes, probably max more
                      then
                        if self.t_varchar2 is null then
                          self.t_varchar2 := self.t_varchar2 || p_val;
                        else
                          self.t_varchar2 := self.t_varchar2 || ',' || p_val;
                        end if;
                      else
                        if self.t_clob is null
                        then
                          dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                          dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                        else
                          dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), ','||self.t_varchar2 );
                        end if;
                        self.t_varchar2 := p_val;
                      end if;
                    end;
                  begin
                    add_val( a_val );
                    return odciconst.success;
                  end;
                --
                  member function odciaggregateterminate
                    ( self in out listagg_clob_t
                    , returnvalue out clob
                    , flags in number
                    )
                  return number
                  is
                  begin
                    if self.t_clob is null
                    then
                      dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                    end if;
                    if self.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                    end if;
                    returnvalue := self.t_clob;
                    return odciconst.success;
                  end;
                --
                  member function odciaggregatemerge
                    ( self in out listagg_clob_t
                    , ctx2 in out listagg_clob_t
                    )
                  return number
                  is
                  begin
                    if self.t_clob is null
                    then
                      dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                    end if;
                    if self.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                    end if;
                    if ctx2.t_clob is not null
                    then
                      dbms_lob.append( self.t_clob, ctx2.t_clob );
                      dbms_lob.freetemporary( ctx2.t_clob );
                    end if;
                    if ctx2.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( ctx2.t_varchar2 ), ctx2.t_varchar2 );
                      ctx2.t_varchar2 := null;
                    end if;
                    return odciconst.success;
                  end;
                --
                end;        
        </createProcedure>
        <createProcedure>
            create or replace function listagg_clob( agg varchar2 )
            return clob
            parallel_enable aggregate using listagg_clob_t;        
        </createProcedure>
    </changeSet>
    
    <changeSet id="#INTRD-11162_20221107" author="HatimOUDAD">
        <addColumn tableName="billing_invoice_line">
            <column name="adjustment_status" type="varchar(50)">
            </column>
        </addColumn>
    </changeSet>
    
   
    
    <changeSet id="INTRD-11433_20221110" author="AbdelmounaimAkadid">
        <modifyDataType tableName="dwh_report_extract_execution" columnName="file_path" newDataType="varchar(256)"/>
    </changeSet>

    <changeSet id="#INTRD-11310_20221110" author="ZBariki">
        <renameColumn tableName="crm_provider"
                      newColumnName="portal_message"
                      oldColumnName="rgaa_message"
                      columnDataType="varchar(500)"/>
    </changeSet>
    
    <changeSet id="#INTRD-10683_20221107" author="AdilElJaouhari">
        <createSequence sequenceName="meveo_script_parameter_seq"/>
        <createTable tableName="meveo_script_parameter">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_meveo_script_parameter" />
            </column>
            <column name="version" type="int4" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="script_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="description_i18n" type="${type.json}">
                <constraints nullable="true" />
            </column>
            <column name="class_name" type="varchar(255)" defaultValue="java.lang.String">
                <constraints nullable="false" />
            </column>
            <column name="default_value" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
             <column name="allowed_values" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="values_separator" type="varchar(20)" defaultValue="|">
                <constraints nullable="false" />
            </column>
            <column name="collection" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            
        </createTable>

        <addForeignKeyConstraint baseTableName="meveo_script_parameter" baseColumnNames="script_instance_id"
                                 constraintName="script_parameter_script_instance_id_fk"
                                 referencedTableName="meveo_script_instance"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="#INTRD-8859_20220802" author="hichamELHALOUI">
        <addColumn tableName="dwh_report_extract">
            <column name="include_headers" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>

    </changeSet>


    <changeSet id="#INTRD-11775_20221120" author="hichamELHALOUI">
        <addColumn tableName="cpq_commercial_order">
           <column name="billing_cycle_id" type="bigint" />
            <column name="billing_run_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_commercial_order"
                                 baseColumnNames="billing_cycle_id"
                                 constraintName="fk_cpq_commercial_order_billing_cycle"
                                 referencedTableName="billing_cycle"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="cpq_commercial_order"
                                 baseColumnNames="billing_run_id"
                                 constraintName="fk_cpq_commercial_order_billing_run"
                                 referencedTableName="billing_billing_run"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />

    </changeSet>

	<changeSet id="#INTRD-242_20221121" author="AdilElJaouhari">
		<addColumn tableName="billing_cycle">
			<column name="filters" type="${type.json}">
				<constraints nullable="true" />
			</column>
		</addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-11780_20221128" author="AdilElJaouhari">
	 	<addPrimaryKey columnNames="id" tableName="billing_invoice_validation_rule"/>
        <addColumn tableName="billing_invoice">
            <column name="invoice_validation_rule_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="billing_invoice"
                                 baseColumnNames="invoice_validation_rule_id"
                                 constraintName="fk_billing_invoice_validation_rule"
                                 referencedTableName="billing_invoice_validation_rule"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>
    
    <changeSet id="#INTRD-12043_20221121" author="HatimOUDAD">
		<addColumn tableName="billing_invoice_validation_rule">
			<column name="rule_values" type="${type.json}">
			</column>
		</addColumn>
	</changeSet>

    <changeSet id="INTRD-11732_20221130" author="MehdiBOURRAS">
        <addColumn tableName="com_message_template">
            <column name="textcontent_i18n" type="${type.json}"/>
            <column name="subject_i18n" type="${type.json}"/>
            <column name="htmlcontent_i18n" type="${type.json}"/>
        </addColumn>
    </changeSet>
    
	<changeSet id="INTRD_12001_20221205" author="TarikFA.">
		<modifyDataType tableName="meveo_script_instance" columnName="description" newDataType="varchar(1000)"/>
	</changeSet>

    <changeSet id="#12201_20221212" author="zelmeliani">
        <renameTable newTableName="billing_redirection_rule" oldTableName="cpq_billing_rule"/>
    </changeSet>

	<changeSet id="#INTR-112153_20221209_new_field" author="a.rouaguebe">
		<addColumn tableName="cat_charge_template">
            <column name="internal_note" type="${type.longtext}" />
        </addColumn>
	</changeSet>
	
	 <changeSet id="#2038-20221130" author="Mbarek-Ay">
       <createSequence sequenceName="crm_address_book_contact_seq" startValue="1" />
    </changeSet>

	<changeSet id="#INTR-12252_20221212_agreement_date" author="a.rouaguebe">
		<addColumn tableName="cpq_product">
            <column name="agreement_date_setting" type="varchar(20)"/>
        </addColumn>
	</changeSet>
	
	<changeSet id="#INTR-12382_20221219" author="HichamHANINE">
		<addColumn tableName="cat_offer_template">
            <column name="sequence" type="INT4" defaultValue="0" />
			<column name="display" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
	</changeSet>

    <changeSet id="#INTRD-11841_20221214-reports" author="HichamHANINE">
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
package org.meveo.service.script.presale;
import java.io.File;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Collections;
import java.math.RoundingMode;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.*;
import static java.math.BigDecimal.ZERO;
import static java.util.Optional.ofNullable;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.PENDING;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.PPAID;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.UNPAID;
import static org.meveo.model.billing.InvoiceStatusEnum.VALIDATED;
import static org.meveo.model.shared.DateUtils.setDateToEndOfDay;
import org.meveo.commons.utils.StringUtils;
import org.meveo.model.shared.DateUtils;
import org.meveo.commons.utils.QueryBuilder;
import org.meveo.admin.exception.BusinessException;
import org.meveo.commons.utils.CsvBuilder;
import org.meveo.model.payments.CustomerAccount;
import org.meveo.service.payments.impl.CustomerAccountService;
import org.meveo.service.script.finance.ReportExtractScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory; 
import org.meveo.admin.util.pagination.PaginationConfiguration;
import static java.util.Arrays.asList;
import org.meveo.model.payments.RecordedInvoice;
import org.meveo.model.payments.MatchingStatusEnum;
import org.meveo.api.dto.AgedReceivableDto;
import org.meveo.model.shared.Name;
import org.meveo.model.admin.Currency;
import org.meveo.model.crm.Provider;
import org.meveo.service.crm.impl.ProviderService;
import org.meveo.commons.utils.EjbUtils;
public class AgedBalanceReporting extends ReportExtractScript {
    private static final Logger log = LoggerFactory.getLogger(AgedBalanceReporting.class);
  	private static Provider appProvider;
    private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName());
    @Override public void execute(Map < String, Object > executeContext) throws BusinessException {
        try {    
          	appProvider = ((ProviderService) EjbUtils.getServiceInterface("ProviderService")).getProvider();
          	String currencyCode = "";
          	Map < String, Object > paramsProvider = new HashMap < String, Object > ();
          	paramsProvider.put("code", appProvider.getCode());
           	String queryProvider = "Select pr.currency.currencyCode, pr.id FROM Provider pr where lower(pr.code)=lower(:code)";
			List < Object[] > rowsProvider = (List < Object[] > ) customerAccountService.executeSelectQuery(queryProvider, paramsProvider);
          	for (Object[] row: rowsProvider) {
                currencyCode = row[0] + "";
            }
          
          	List<String> fetchFields = asList("fields");
          	PaginationConfiguration paginationConfiguration = new PaginationConfiguration(0, 50, null, null, fetchFields, "dueDate", "DESCENDING");
          	int numberOfPeriods = 4;
          	String query = getAgedReceivables(null, null, new Date(), null, null, paginationConfiguration, 30, numberOfPeriods, null, null, null, null, null);
          
            log.debug("execute executeContext:{}", executeContext);
            Map < String, Object > params = new HashMap < String, Object > ();
               
          	List < Object[] > rows = (List < Object[] > ) customerAccountService.executeSelectQuery(query, params);
          	List<AgedReceivableDto> listAgedReceivable = buildDynamicResponse(rows, numberOfPeriods);
            
            log.debug("execute rows size:{}", rows == null ? null : rows.size());
            String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR));
            String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME));
            CsvBuilder csvBuilder = new CsvBuilder(";", false);
            String[] header = {
                "Customer description", "Customer", "Invoice Number",
               	"Total current", "0_30_DAYS","30_60_DAYS","60_90_DAYS","90_DAYS",
                "Total overdue","Total",
                "Currency","Amount billed","Billing currency"
            };
            csvBuilder.appendValues(header);
            csvBuilder.startNewLine();
            for (AgedReceivableDto agedReceivableDto: listAgedReceivable) {
                csvBuilder.appendValue(agedReceivableDto.getCustomerAccountDescription());
                csvBuilder.appendValue(agedReceivableDto.getCustomerAccountCode());
                csvBuilder.appendValue(agedReceivableDto.getInvoiceNumber());
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getNotYetDue()));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(0)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(1)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(2)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(3)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getGeneralTotal()));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getGeneralTotal()));
                csvBuilder.appendValue(currencyCode);
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getBilledAmount()));
                csvBuilder.appendValue(agedReceivableDto.getTradingCurrency());
              
                csvBuilder.startNewLine();
            }
            csvBuilder.toFile(dirOutput + File.separator + filename);
            log.debug("execute file generated:{}", dirOutput + File.separator + filename);
        } catch (Exception e) {
            log.error("Error on AgedBalanceReporting:", e);
            throw new BusinessException(e.getMessage());
        }
    }
    private String round(BigDecimal amount) {
        if (amount == null) {
            return "";
        }
        if (amount.scale() > 4) {
            String amountAsString = "" + amount;
            amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4));
        }
        amount = amount.setScale(2, RoundingMode.UP);
        return amount.toPlainString();
    }
  
  public String getAgedReceivables(String customerAccountCode, String sellerCode, Date startDate, Date startDueDate, Date endDueDate, PaginationConfiguration paginationConfiguration,
                                             Integer stepInDays, Integer numberOfPeriods, String invoiceNumber, String customerAccountDescription, String sellerDescription, String tradingCurrency, String functionalCurrency) {        
    	String datePattern = "yyyy-MM-dd";
        StringBuilder query = new StringBuilder("Select ao.customerAccount.id, sum (case when ao.dueDate >= '")
                .append(DateUtils.formatDateWithPattern(startDate, datePattern))
                .append("'  then  ao.unMatchingAmount else 0 end ) as notYetDue,");
    	if(stepInDays != null && numberOfPeriods != null) {
    	    String alias;
    	    int step;
    	    if(numberOfPeriods > 1) {
                query.append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_1_" + stepInDays + ",")
                        .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_1_" + stepInDays + "_awt,")
                        .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.taxAmount else 0 end ) as sum_1_" + stepInDays + "_tax,");
                for (int iteration = 1; iteration < numberOfPeriods - 1; iteration++) {
                    step = iteration * stepInDays;
                    alias = "as sum_"+ (stepInDays * iteration + 1) + "_" + (step * 2);
                    query.append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then ao.amountWithoutTax else 0 end ) ")
                            .append(alias).append(" , ")
                            .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then ao.unMatchingAmount  else 0 end ) ")
                            .append(alias).append("_awt, ")
                            .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then  ao.taxAmount else 0 end ) ")
                            .append(alias).append("_tax, ");
                }
            }
            step = numberOfPeriods > 1  ? stepInDays * (numberOfPeriods - 1) : stepInDays;
            query.append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"'  then ao.amountWithoutTax else 0 end ) as sum_" + step + "_up,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"'  then ao.unMatchingAmount else 0 end ) as sum_" + step + "_up_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' then ao.taxAmount else 0 end ) as sum_" + step + "_up_tax,");
        } else {
    	    query.append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_1_30,")
    	            .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_1_30_awt,")
    	            .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.taxAmount else 0 end ) as sum_1_30_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.amountWithoutTax  else 0 end ) as sum_31_60,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_31_60_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.taxAmount else 0 end ) as sum_31_60_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_61_90,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_61_90_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.taxAmount else 0 end ) as sum_61_90_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.amountWithoutTax else 0 end ) as sum_90_up,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.unMatchingAmount else 0 end ) as sum_90_up_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.taxAmount else 0 end ) as sum_90_up_tax,");
        }
        query.append(" ao.customerAccount.dunningLevel, ao.customerAccount.name, ao.customerAccount.description, ao.seller.description, ao.seller.code, ao.dueDate, ao.invoice.tradingCurrency.currency.currencyCode, ao.invoice.id, ao.invoice.invoiceNumber, ao.invoice.amountWithTax, ao.customerAccount.code, ao.invoice.convertedAmountWithTax, ao.invoice.billingAccount.id ")
                .append("from ")
                .append(RecordedInvoice.class.getSimpleName())
                .append(" as ao");
        QueryBuilder qb = new QueryBuilder(query.toString());
        qb.addSql("(ao.matchingStatus='"+MatchingStatusEnum.O+"' or ao.matchingStatus='"+MatchingStatusEnum.P+"') ");
        qb.addSql("ao.invoice.invoiceType.excludeFromAgedTrialBalance = false");
        ofNullable(customerAccountCode).ifPresent(ca -> qb.addSql("UPPER(ao.customerAccount.code) like '%" + customerAccountCode.toUpperCase() +"%'"));
        ofNullable(customerAccountDescription).ifPresent(caDescription -> qb.addSql("UPPER(ao.customerAccount.description) like '%" + caDescription.toUpperCase() +"%'"));
        ofNullable(sellerDescription).ifPresent(sDescription -> qb.addSql("UPPER(ao.seller.description) like ('%" + sDescription.toUpperCase() +"%')"));
        ofNullable(sellerCode).ifPresent(sel -> qb.addSql("UPPER(ao.seller.code) like '%" + sellerCode.toUpperCase() +"%'"));
        ofNullable(invoiceNumber).ifPresent(invNumber -> qb.addSql("ao.invoice.invoiceNumber = '" + invNumber +"'"));
        ofNullable(tradingCurrency).ifPresent(fc -> qb.addSql("ao.invoice.tradingCurrency.currency.currencyCode = '" + fc + "'"));
        if (startDueDate != null && endDueDate != null) {
            qb.addSql("(ao.dueDate >= '" + DateUtils.formatDateWithPattern(startDueDate, datePattern)
                    + "' and ao.dueDate <= '" + DateUtils.formatDateWithPattern(endDueDate, datePattern) + "')");
        }
        if (DateUtils.compare(startDate, new Date()) < 0) {
            qb.addSql("ao.invoice.status = '" + VALIDATED + "' and ao.invoice.invoiceDate <= '"
                    + DateUtils.formatDateWithPattern(setDateToEndOfDay(startDate), "yyyy-MM-dd HH:mm:ss") + "'");
            qb.addSql("(ao.invoice.paymentStatus = '" + PENDING + "' or ao.invoice.paymentStatus = '" + PPAID + "' or ao.invoice.paymentStatus ='" + UNPAID + "')");
        }
        qb.addGroupCriterion("ao.customerAccount.id, ao.customerAccount.dunningLevel, ao.customerAccount.name, ao.customerAccount.description, ao.seller.description, ao.seller.code, ao.dueDate, ao.amount, ao.invoice.tradingCurrency.currency.currencyCode, ao.invoice.id, ao.invoice.invoiceNumber, ao.invoice.amountWithTax, ao.customerAccount.code, ao.invoice.convertedAmountWithTax, ao.invoice.billingAccount.id ");
        qb.addPaginationConfiguration(paginationConfiguration);
          return qb.getSqlString();
    }
  
  public List<AgedReceivableDto> buildDynamicResponse(List<Object[]> agedReceivables, int numberOfPeriods) {
		List<AgedReceivableDto> responseDto = new  ArrayList<>();
		for (int index = 0; index < agedReceivables.size(); index++) {
			Object[] agedReceivable = agedReceivables.get(index);
			AgedReceivableDto agedReceivableDto = new AgedReceivableDto();
			agedReceivableDto.setNotYetDue((BigDecimal) agedReceivable[1]);
			int sumIndex;
			int startingSumIndex = 2;
			agedReceivableDto.setNetAmountByPeriod(new ArrayList<>());
			agedReceivableDto.setTotalAmountByPeriod(new ArrayList<>());
			agedReceivableDto.setTaxAmountByPeriod(new ArrayList<>());
			for (sumIndex = 0; sumIndex < numberOfPeriods; sumIndex++) {
				agedReceivableDto.getNetAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex]);
				agedReceivableDto.getTotalAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex + 1]);
				agedReceivableDto.getTaxAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex + 2]);
				startingSumIndex += 3;
			}
			agedReceivableDto.setCustomerAccountName(agedReceivable[++startingSumIndex] == null ? null : getName((Name) agedReceivable[startingSumIndex]));
			agedReceivableDto.setCustomerAccountDescription((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setSellerDescription((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setSellerCode((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setDueDate(agedReceivable[++startingSumIndex] == null ? null : ((Date) agedReceivable[startingSumIndex]));
			agedReceivableDto.setTradingCurrency((String) agedReceivable[++startingSumIndex]);
			BigDecimal generalTotal = agedReceivableDto.getTotalAmountByPeriod().stream().reduce(ZERO, BigDecimal::add);
			agedReceivableDto.setGeneralTotal(generalTotal);
			agedReceivableDto.setInvoiceId((Long) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setInvoiceNumber((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setBilledAmount((BigDecimal) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setCustomerAccountCode((String) agedReceivable[++startingSumIndex]);
			if(agedReceivable[++startingSumIndex] != null)
				agedReceivableDto.setBilledAmount((BigDecimal) agedReceivable[startingSumIndex]);
			agedReceivableDto.setCustomerId((Long) agedReceivable[++startingSumIndex]);
			responseDto.add(agedReceivableDto);
		}
		return responseDto;
	}
  
  	private String getName(Name name) {
		return (name.getFirstName() != null ? name.getFirstName() : "")
				+ (name.getLastName() != null ? " " + name.getLastName() : "");
	}
}
				]]>
            </column>
            <where>id=-12</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-12466_20222012" author="bourras">
        <update tableName="global_settings">
            <column name="activate_dunning" value="1"/>
            <where>id=1</where>
        </update>
    </changeSet>

	<changeSet id="#INTRD-12478_20221226" author="AdilElJaouhari">
		<addColumn tableName="billing_cycle">
			<column name="priority" type="int4" defaultValueNumeric="0" />
		</addColumn>
	</changeSet>

	<changeSet id="#INTRD-12677_20221229" author="AdilElJaouhari">
		<createTable tableName="crm_provider_order_line_type">
			<column name="provider_id" type="bigint" />
			<column name="order_line_type" type="varchar(20)" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="crm_provider_order_line_type"
			baseColumnNames="provider_id"
			constraintName="crm_provider_order_line_type_provider_fk"
			referencedTableName="crm_provider" referencedColumnNames="id" />

		<addUniqueConstraint
			columnNames="provider_id, order_line_type"
			constraintName="crm_provider_order_line_type_uk"
			tableName="crm_provider_order_line_type" />
	</changeSet>
	
	<changeSet id="#INTRD-10544_20221207" author="HatimOUDAD"> 
        <createSequence sequenceName="iso_icd_seq" startValue="1" />
        <createTable tableName="iso_icd">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iso_icd" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_icd_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="scheme_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        
        <createSequence sequenceName="untdid_unit_seq" startValue="1" />
        <createTable tableName="untdid_unit">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_untdid_unit" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
            </column>

            <!-- Simple fields -->           
            <column name="source" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_1001_invoice_code_type_seq" startValue="1" />
        <createTable tableName="untdid_1001_invoice_code_type">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_1001_invoice_type" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_1001_code_type_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="en16931_interpretation" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="true" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_2475_vat_payment_option_seq" startValue="1" />
        <createTable tableName="untdid_2475_vat_payment_option">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_2475_vat_payment" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

             <!-- Simple fields -->           
            <column name="code_2005" type="varchar(10)">
                <constraints nullable="false" />
            </column>
             <column name="value_2005" type="varchar(500)">
                <constraints nullable="false" />
            </column>
             <column name="code_2475" type="varchar(10)">
                <constraints nullable="false" />
            </column>
             <column name="value_2475" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_4451_invoice_subject_code_seq" startValue="1" />
        <createTable tableName="untdid_4451_invoice_subject_code">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_4451_invoice_subject" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_4451_subject_code_unique"/>
            </column>

            <!-- Simple fields -->    
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_5305_taxation_category_seq" startValue="1" />
        <createTable tableName="untdid_5305_taxation_category">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_5305_taxation_category" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_5305_taxation_category_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="semantic_model" type="varchar(500)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_vatex_seq" startValue="1" />
        <createTable tableName="untdid_vatex">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_untdid_vatex" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_vatex_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="remark" type="varchar(500)">
                <constraints nullable="true" />
            </column>
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_4461_payment_means_seq" startValue="1" />
        <createTable tableName="untdid_4461_payment_means">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_4461_payment_means" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_4461_payment_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="usage_in_EN16931" type="varchar(500)">
                <constraints nullable="true" />
            </column>
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_5189_allowance_code_seq" startValue="1" />
         <createTable tableName="untdid_5189_allowance_code">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_5189_allowance_code" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(10)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_5189_allowance_code_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="description" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <sql>INSERT INTO ${db.schema.adapted}untdid_5305_taxation_category(id,version,created,updated,creator,updater,code,semantic_model,name) VALUES (1, 0, now(), NULL, 'opencell.admin', NULL, 'S', 'Standard rate', 'Standard rate');
			INSERT INTO ${db.schema.adapted}untdid_2475_vat_payment_option(id,version,created,updated,creator,updater,code_2005,value_2005,code_2475,value_2475) VALUES (1, 0, now(), NULL, 'opencell.admin', NULL, '3', 'Invoice document issue date time', '5', 'Date of invoice');
		</sql>
			
        <addColumn tableName="billing_tax">
            <column name="taxation_category_id" type="bigint" defaultValueNumeric="1">
             <constraints nullable="false" />
            </column>
            <column name="vatex_id" type="bigint">
            </column>
        </addColumn>
         <addColumn tableName="billing_invoice_type">
            <column name="invoice_code_type_id" type="bigint">
            </column>
             <column name="vat_payment_option_id" type="bigint" defaultValueNumeric="1">
             <constraints nullable="false" />
            </column>
        </addColumn>
        
        <addForeignKeyConstraint baseTableName="billing_tax"
                                 baseColumnNames="taxation_category_id"
                                 constraintName="fk_billing_tax_5305_taxation_category"
                                 referencedTableName="UNTDID_5305_TAXATION_CATEGORY"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_tax"
                                 baseColumnNames="vatex_id"
                                 constraintName="fk_billing_tax_vatex"
                                 referencedTableName="UNTDID_VATEX"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
                                 
        <addForeignKeyConstraint baseTableName="BILLING_INVOICE_TYPE"
                                 baseColumnNames="invoice_code_type_id"
                                 constraintName="fk_billing_invoice_1001_invoice"
                                 referencedTableName="UNTDID_1001_INVOICE_CODE_TYPE"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="BILLING_INVOICE_TYPE"
                                 baseColumnNames="vat_payment_option_id"
                                 constraintName="fk_billing_invoice_2475_vat"
                                 referencedTableName="UNTDID_2475_VAT_PAYMENT_OPTION"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        
        
    </changeSet>
    

    
    <changeSet id="#INTRD-12668-20230102" author="AmineBENAICHA">
		<addColumn tableName="billing_cycle">
            <column name="disable_aggregation" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="use_accounting_article_label" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="date_aggregation" type="varchar(255)" defaultValue="NO_DATE_AGGREGATION" />
            <column name="aggregate_unit_amounts" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="ignore_subscriptions" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="ignore_orders" type="${type.boolean}" defaultValueNumeric="1" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-12544_20230102" author="bourras">
        <addColumn tableName="cat_offer_template">
            <column name="document_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="document_id" baseTableName="cat_offer_template"
                                 constraintName="fk_document_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="document"/>
    </changeSet>
    
    <changeSet id="#INTRD-12794-20230102-counter_instance" author="a.rouaguebe">
    	<dropPrimaryKey tableName="billing_chrg_inst_counter" constraintName="billing_chrg_inst_counter_pkey" />
    	<addPrimaryKey columnNames="chrg_instance_id, counter_instance_id" constraintName="billing_chrg_inst_counter_pkey" tableName="billing_chrg_inst_counter" />
    </changeSet>

    <changeSet id="#INTRD-12766_20230105" author="bourras">
        <addColumn tableName="billing_invoice">
            <column name="converted_invoice_balance" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-12720-20221230-query_report" author="a.rouaguebe">
        <addColumn tableName="report_query">
        	<column name="query_parameters" type="${type.json}" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-12047-20230112" author="AbdelmounaimAkadid">
    	<createIndex indexName="idx__cpq_attribute_instance__subscription_id" tableName="cpq_attribute_instance">
	      	<column name="subscription_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__cpq_attribute_instance__parent_id" tableName="cpq_attribute_instance">
	      	<column name="parent_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__origin_billing_account" tableName="billing_rated_transaction">
	      	<column name="origin_billing_account"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__rules_contract_id" tableName="billing_rated_transaction">
	      	<column name="rules_contract_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__service_instance_id" tableName="billing_rated_transaction">
	      	<column name="service_instance_id"/>
	  	</createIndex>
    </changeSet>   

    <changeSet id="#INTRD-12766_20230106" author="bourras">
        <addColumn tableName="billing_linked_invoices">
            <column name="converted_amount" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-13065_20230112" author="AdilElJaouhari">
		<dropColumn columnName="validation_script" tableName="billing_invoice_validation_rule" />
		<addColumn tableName="billing_invoice_validation_rule">
			<column name="script_instance_id" type="bigint" />
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="billing_invoice_validation_rule"
                                 constraintName="fk_validation_rule_meveo_script_instance" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />
	</changeSet>
	
	<changeSet id="#INTRD-12819-20221220-qb_advanced_query" author="a.rouaguebe">
        <addColumn tableName="report_query">
        	<column name="advanced_query" type="${type.json}" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-12651-20230123" author="AdilElJaouhari">
        <modifyDataType tableName="cpq_order_offer" columnName="order_line_type" newDataType="varchar(20)" />
    </changeSet>

	<changeSet id="#INTRD-12405_20221226" author="HichamHANINE">
		<addColumn tableName="crm_provider">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_billing_account">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_user_account">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="ar_payment_token">
			<column name="payment_means" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_invoice_type">
			<column name="invoice_subject_code" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_accounting_article">
			<column name="allowance_code" type="bigint"></column>
		</addColumn>
	
		<addForeignKeyConstraint baseTableName="billing_billing_account"
								 baseColumnNames="icd_id"
								 constraintName="fk_billing_account_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="billing_user_account"
								 baseColumnNames="icd_id"
								 constraintName="fk_user_account_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="crm_seller"
								 baseColumnNames="icd_id"
								 constraintName="fk_seller_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="crm_provider"
								 baseColumnNames="icd_id"
								 constraintName="fk_provider_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />							 
		<addForeignKeyConstraint baseTableName="billing_invoice_type"
								 baseColumnNames="invoice_subject_code"
								 constraintName="fk_invoice_type_untdid_4451_invoice_subject"
								 referencedTableName="untdid_4451_invoice_subject_code"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="ar_payment_token"
								 baseColumnNames="payment_means"
								 constraintName="fk_payment_token_untdid_4461_payment_means"
								 referencedTableName="untdid_4461_payment_means"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="billing_accounting_article"
								 baseColumnNames="allowance_code"
								 constraintName="fk_accounting_article_untdid_5189_allowance_code"
								 referencedTableName="untdid_5189_allowance_code"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<dropColumn tableName="untdid_4461_payment_means">
            <column name="usage_in_EN16931"></column>
        </dropColumn>
        <addColumn tableName="untdid_4461_payment_means">
			<column name="usage_in_en16931" type="varchar(500)">
                <constraints nullable="true" />
            </column>
		</addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-13646_20230131" author="AdilElJaouhari">
        <dropNotNullConstraint tableName="billing_tax" columnName="taxation_category_id"/>
    </changeSet>

    <changeSet id="#INTRD-13220_20230203" author="AbdellatifBARI">
        <addColumn tableName="cpq_order_product">
            <column name="service_instance_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="cpq_order_product"
                                 constraintName="fk_cpq_order_product_service_instance_id"
                                 referencedColumnNames="id"
                                 referencedTableName="billing_service_instance"/>
    </changeSet>
    
    <changeSet id="#INTRD-13453_20230207" author="Mbarek-Ay">
		<addColumn tableName="cpq_contract_item">
			<column name="separate_discount" type="${type.boolean}" defaultValueNumeric="0"></column>
		</addColumn>
	</changeSet>

    <changeSet id="#INTRD-12972" author="bourras">
        <dropNotNullConstraint tableName="cpq_contract" columnName="contract_date"/>
    </changeSet>
    
    <changeSet id="#INTRD-13957-20230214" author="houdad">
        <sql>
        DELETE FROM untdid_unit;
        DROP TABLE untdid_unit;
        </sql>
    </changeSet>

    <changeSet id="#INTRD-13883_20230208" author="hichamELHALOUI">
        <addColumn tableName="cat_discount_plan">
            <column name="allowance_code_id" type="bigint">
            </column>
		</addColumn>
        <update tableName="cat_discount_plan">
			<column name="allowance_code_id" valueComputed="(SELECT id from untdid_5189_allowance_code where code = '95')"></column>
			<where>allowance_code_id is null</where>
		</update>
        <addNotNullConstraint tableName="cat_discount_plan" columnName="allowance_code_id" />
        <addForeignKeyConstraint baseTableName="cat_discount_plan"
								 baseColumnNames="allowance_code_id"
								 constraintName="fk_discount_plan_untdid_5189_allowance_code"
								 referencedTableName="untdid_5189_allowance_code"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>


    <changeSet author="ZBariki" id="#INTRD-14208_20230224" dbms="oracle">
        <dropProcedure procedureName="listagg_clob_t" />
        <createProcedure>
            create or replace type listagg_clob_t as object
            (
                t_varchar2 VARCHAR2 (32767),
                t_clob CLOB,
                STATIC FUNCTION odciaggregateinitialize (sctx IN OUT listagg_clob_t)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregateiterate (self    IN OUT listagg_clob_t,
                                                      a_val          VARCHAR2)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregateterminate (self          IN OUT listagg_clob_t,
                                                        returnvalue      OUT CLOB,
                                                        flags         IN     NUMBER)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregatemerge (self   IN OUT listagg_clob_t,
                                                    ctx2   IN OUT listagg_clob_t)
                    RETURN NUMBER
            );
        </createProcedure>
        <createProcedure>
            CREATE OR REPLACE TYPE BODY OPENCELL."LISTAGG_CLOB_T"
            IS
                STATIC FUNCTION odciaggregateinitialize (sctx IN OUT listagg_clob_t)
                    RETURN NUMBER
                    IS
                BEGIN
                    sctx := listagg_clob_t (NULL, NULL);
                    RETURN odciconst.success;
                END;
                member function odciaggregateiterate
                ( self in out listagg_clob_t
                , a_val varchar2
                )
                    return number
                    is
                    procedure add_val( p_val varchar2 )
                        is
                    begin
                        if nvl( lengthb( self.t_varchar2 ), 0 ) + lengthb( p_val ) &lt;= 4000
                        THEN
                            IF self.t_varchar2 IS NULL
                            THEN
                                self.t_varchar2 := self.t_varchar2 || p_val;
                            ELSE
                                self.t_varchar2 := self.t_varchar2 || ',' || p_val;
                            END IF;
                        ELSE
                            IF self.t_clob IS NULL
                            THEN
                                DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);
                                DBMS_LOB.writeappend (self.t_clob,
                                                      LENGTH (self.t_varchar2),
                                                      self.t_varchar2);
                            ELSE
                                DBMS_LOB.writeappend (self.t_clob,
                                                      LENGTH (self.t_varchar2) + 1,
                                                      ',' || self.t_varchar2);
                            END IF;

                            self.t_varchar2 := p_val;
                        END IF;
                    END;
                BEGIN
                    add_val (a_val);
                    RETURN odciconst.success;
                END;

                MEMBER FUNCTION odciaggregateterminate (self          IN OUT listagg_clob_t,
                                                        returnvalue      OUT CLOB,
                                                        flags         IN     NUMBER)
                    RETURN NUMBER
                    IS
                BEGIN
                    IF self.t_clob IS NULL
                    THEN
                        DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);

                        IF self.t_varchar2 IS NOT NULL
                        THEN
                            DBMS_LOB.writeappend (self.t_clob,
                                                  LENGTH (self.t_varchar2) ,
                                                  self.t_varchar2);
                        END IF;
                    ELSE
                        IF self.t_varchar2 IS NOT NULL
                        THEN
                            DBMS_LOB.writeappend (self.t_clob,
                                                  LENGTH (self.t_varchar2) + 1,
                                                  ',' || self.t_varchar2);
                        END IF;
                    END IF;

                    returnvalue := self.t_clob;
                    RETURN odciconst.success;
                END;

                MEMBER FUNCTION odciaggregatemerge (self   IN OUT listagg_clob_t,
                                                    ctx2   IN OUT listagg_clob_t)
                    RETURN NUMBER
                    IS
                BEGIN
                    IF self.t_clob IS NULL
                    THEN
                        DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);
                    END IF;

                    IF self.t_varchar2 IS NOT NULL
                    THEN
                        DBMS_LOB.writeappend (self.t_clob,
                                              LENGTH (self.t_varchar2),
                                              self.t_varchar2);
                    END IF;

                    IF ctx2.t_clob IS NOT NULL
                    THEN
                        DBMS_LOB.append (self.t_clob, ctx2.t_clob);
                        DBMS_LOB.freetemporary (ctx2.t_clob);
                    END IF;

                    IF ctx2.t_varchar2 IS NOT NULL
                    THEN
                        DBMS_LOB.writeappend (self.t_clob,
                                              LENGTH (ctx2.t_varchar2),
                                              ctx2.t_varchar2);
                        ctx2.t_varchar2 := NULL;
                    END IF;

                    RETURN odciconst.success;
                END;
            END;
        </createProcedure>
        <createProcedure>
            create or replace function listagg_clob( agg varchar2 )
                RETURN CLOB
                PARALLEL_ENABLE
                AGGREGATE USING listagg_clob_t;
        </createProcedure>
    </changeSet>
    
    <changeSet id="#INTRD-14743_20230313" author="TarikFA.">
        <createIndex tableName="rating_edr" indexName="rating_edr_eventKey_index_idx">
            <column name="event_key"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="#INTRD-14743_20230315" author="TarikFA.">
        <sql>CREATE INDEX rt_customer_id_contract_index ON ${db.schema.adapted}cpq_contract (customer_id) where status='ACTIVE'</sql>
        <sql>CREATE INDEX rt_billing_account_id_contract_index ON ${db.schema.adapted}cpq_contract (billing_account_id) where status='ACTIVE'</sql>
        <sql>CREATE INDEX rt_customer_account_contract_index ON ${db.schema.adapted}cpq_contract (customer_account_id) where status='ACTIVE'</sql>
    </changeSet>
    
    <changeSet id="#INTRD-14743_20230316" author="TarikFA.">
        <sql>CREATE INDEX cpq_price_plan_matrix_value__ppml_id__idx ON cpq_price_plan_matrix_value(ppml_id)</sql>
        <sql>CREATE INDEX cpq_price_plan_matrix_line__ppm_version_id__idx ON cpq_price_plan_matrix_line(ppm_version_id)</sql>
    </changeSet>
    
    <changeSet id="#5882_20220325" author="MohammedELAZZOUZI">
     	<addColumn tableName="billing_invoice_line">
            <column name="user_account_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_invoice_line" constraintName="fk_InvoiceLine_userAccount" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
   	</changeSet> 

    <changeSet id="#INTRD-14743_20230331" author="AndriusKarpavicius">
        <alterSequence sequenceName="rating_cdr_seq" incrementBy="5000"/>
        <alterSequence sequenceName="rating_edr_seq" incrementBy="5000"/>
        <alterSequence sequenceName="billing_wallet_operation_seq" incrementBy="5000"/>
        <alterSequence sequenceName="billing_rated_transaction_seq" incrementBy="5000"/>
    </changeSet>
    
    <changeSet id="#INTRD-15733_20230426" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_dpi_si_index ON ${db.schema.adapted}billing_discount_plan_instance(service_instance_id)</sql>
        <sql>CREATE INDEX billing_redirection_rule_contract_index  ON ${db.schema.adapted}billing_redirection_rule(contract_id)</sql>
        <dropUniqueConstraint tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
        <addUniqueConstraint columnNames="ppm_version_id,code" tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
        <dropUniqueConstraint tableName="cpq_price_plan_version" constraintName="cpq_price_plan_version_UNIC"/>
        <addUniqueConstraint columnNames="ppm_id,current_version" constraintName="cpq_price_plan_version_UNIC" tableName="cpq_price_plan_version" />
    </changeSet>
    
    <changeSet id="#INTRD-14264_20230222" author="TarikFA.">
    	<addColumn tableName="billing_rated_transaction">
    		<column name="origin_ratedtransaction_id" type="bigint" />
    	</addColumn>
    </changeSet>

    <changeSet id="#INTRD-15691_20230421" author="AbdellatifBARI">
        <addColumn tableName="billing_rated_transaction">
            <column name="discounted_amount" type="numeric(23,12)" />
        </addColumn>
    </changeSet>

   
    <changeSet id="#INTRD-15233_20230425" author="AndriusKarpavicius">
        <sql>CREATE INDEX cpq_contract_item_code_index ON ${db.schema.adapted}cpq_contract_item(lower(code));</sql>
        <sql>CREATE INDEX cpq_contract_item_contract_index ON ${db.schema.adapted}cpq_contract_item(cpq_contract_id);</sql>
    </changeSet>
    
    <changeSet id="#INTRD-15729_20230425" author="AndriusKarpavicius">
        <dropIndex tableName="rating_cdr" indexName="rating_cdr_index"/>
        <sql>CREATE INDEX rating_cdr_ob_index ON ${db.schema.adapted}rating_cdr(origin_batch)</sql>
        <sql>CREATE INDEX rating_cdr_or_index ON ${db.schema.adapted}rating_cdr(origin_record)</sql>
        <dropIndex tableName="rating_edr" indexName="rating_edr_index"/>
        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_record)</sql>
    </changeSet>
    
    <changeSet id="#INTRD-15733_20230425" author="AndriusKarpavicius">
        <sql>CREATE INDEX rating_edr_wo_index ON ${db.schema.adapted}rating_edr(wallet_operation_id)</sql>
    </changeSet>
    

    <changeSet id="#INTRD-4064_20211218" author="AndriusKarpavicius">
        <addColumn tableName="meveo_job_instance">
            <column name="cluster_behavior" type="varchar(25)" defaultValue="LIMIT_TO_SINGLE_NODE"/>
        </addColumn>
        <sql>update ${db.schema.adapted}meveo_job_instance set cluster_behavior = 'RUN_IN_PARALLEL' where single_node=0</sql>
        <dropColumn tableName="meveo_job_instance">
            <column name="single_node" />
        </dropColumn>
        <addColumn tableName="job_execution">
            <column name="parent_job_result_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-15938_20230503" author="AndriusKarpavcius">
        <addColumn tableName="cpq_price_plan_matrix_line">
            <column name="accuracy" type="int" defaultValueNumeric="0">
                 <constraints nullable="false" />
            </column>
        </addColumn>
        <sql>delete from ${db.schema.adapted}cpq_price_plan_matrix_value where long_value is null and double_value is null and string_value is null and date_value is null and from_date_value is null and to_date_value is null and from_double_value is null and to_double_value is null and boolean_value is null</sql>
        <sql>update ${db.schema.adapted}cpq_price_plan_matrix_line set accuracy = (select count(*) from ${db.schema.adapted}cpq_price_plan_matrix_value where ppml_id=cpq_price_plan_matrix_line.id)</sql>
    </changeSet>

    <changeSet id="#INTRD-16140_20230510" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_wo_disc_wo_index ON ${db.schema.adapted}billing_wallet_operation(discounted_wallet_operation_id)</sql>
    </changeSet>


    <changeSet id="#INTRD-15938_20230511" author="AndriusKarpavicius">
        <dropIndex tableName="cat_price_plan_matrix" indexName="cat_price_plan_event_c_index"/>
        <sql>CREATE INDEX cat_price_plan_event_c_index ON ${db.schema.adapted}cat_price_plan_matrix(event_code, priority, id)</sql>
        <dropIndex tableName="cpq_price_plan_matrix_line" indexName="cpq_price_plan_matrix_line__ppm_version_id__idx"/>
        <sql>CREATE INDEX cpq_ppl_ppVersion_index ON ${db.schema.adapted}cpq_price_plan_matrix_line(ppm_version_id, priority, accuracy)</sql>
    </changeSet>


    <changeSet id="INTRD-15501_20230413" author="ThangNguyen">
        <addColumn tableName="billing_billing_run">
            <column name="incremental_invoice_lines" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-16050_20230515" author="ThangNguyen">
        <addColumn tableName="billing_cycle">
            <column name="incremental_invoice_lines" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-16636_20230610" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction_pending">
            <column name="invoice_line_id" type="bigint" />
        </addColumn>
        <alterSequence sequenceName="billing_invoice_line_seq" incrementBy="5000"/>
    </changeSet>    

    <changeSet id="INTRD-16780_20230614_pg" author="a.rouaguebe" dbms="postgres">
        <dropView viewName="billing_wallet_operation_period" />
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
                  FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>
    <changeSet id="INTRD-16780_20230614_oracle" author="a.rouaguebe" dbms="oracle">
        <dropView viewName="billing_wallet_operation_period" />
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (trunc(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id)) = trunc(o.start_date)) then 0 else 1 end) as flag
                  FROM billing_wallet_operation o WHERE o.status = 'OPEN') o
        </createView>
    </changeSet>
    
    <changeSet id="#INTRD-17084_20230623" author="AndriusKarpavicius">
        <sql>CREATE INDEX idx__billing_wo__rules_contract_id ON ${db.schema.adapted}billing_wallet_operation USING btree (rules_contract_id)</sql>
        <sql>CREATE INDEX idx__billing_wo__contract_id ON ${db.schema.adapted}billing_wallet_operation USING btree (contract_id)</sql>
    </changeSet>
    
    <changeSet id="#INTRD-17222_20231005" author="AndriusKarpavicius">
        <addColumn tableName="job_execution">
            <column name="node" type="varchar(25)"/>
        </addColumn>
        <addColumn tableName="meveo_job_instance">
            <column name="status_report_freq" type="int" defaultValueNumeric="60" />
        </addColumn>
        <dropColumn tableName="meveo_job_instance" columnName="job_speed" />
    </changeSet>

    <changeSet id="#INTRD-17500_20230726" author="AbdellatifBARI">
        <sql>CREATE INDEX rating_edr_subscription_index ON ${db.schema.adapted}rating_edr(subscription_id)</sql>
    </changeSet>

    <changeSet id="#INTRD-17592-rt-indexes" author="a.rouaguebe">
        <sql>create index idx__billing_rating_transaction__id_desc on ${db.schema.adapted}billing_rated_transaction (id desc)</sql>
        <sql>create index idx__billing_rating_transaction__usage_date_desc on ${db.schema.adapted}billing_rated_transaction (usage_date desc)</sql>
    </changeSet>
	
	<changeSet id="#INTRD-14263_20200304" author="TarikFA." failOnError="false">
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_origin_ratedtransaction_id" />
    </changeSet>

    <changeSet id="#INTRD-17581-wo-indexes" author="a.rouaguebe">
        <sql>create index idx__billing_wo__billing_account_id on ${db.schema.adapted}billing_wallet_operation(billing_account_id)</sql>

        <sql>create index idx__charge_instance__lower_description on ${db.schema.adapted}billing_charge_instance(lower(description))</sql>
    </changeSet>

    <changeSet id="#INTRD-17987_20230826_discount_agg" author="a.rouaguebe">
        <addColumn tableName="billing_billing_run">
            <column name="disable_aggregation" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="false" />
            </column>
            <column name="use_accounting_article_label" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="false" />
            </column>
            <column name="date_aggregation" type="varchar(255)" defaultValue="NO_DATE_AGGREGATION" >
                <constraints nullable="false" />
            </column>
            <column name="aggregate_unit_amounts" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="false" />
            </column>
            <column name="ignore_subscriptions" type="${type.boolean}" defaultValueNumeric="1" >
                <constraints nullable="false" />
            </column>
            <column name="ignore_orders" type="${type.boolean}" defaultValueNumeric="1" >
                <constraints nullable="false" />
            </column>
        </addColumn>
        <!--  Existing BC should be NO_AGGREGATION -->
        <sql>UPDATE ${db.schema.adapted}billing_cycle set discount_aggregation = 'NO_AGGREGATION' </sql>
        
        <sql dbms="postgresql">update ${db.schema.adapted}billing_billing_run set discount_aggregation = bc.discount_aggregation, disable_aggregation = bc.disable_aggregation, use_accounting_article_label = bc.use_accounting_article_label,
            date_aggregation = bc.date_aggregation, aggregate_unit_amounts = bc.aggregate_unit_amounts, ignore_subscriptions = bc.ignore_subscriptions, ignore_orders = bc.ignore_orders, incremental_invoice_lines = bc.incremental_invoice_lines
            from ${db.schema.adapted}billing_cycle bc where bc.id=billing_billing_run.billing_cycle_id
        </sql>
        <sql dbms="oracle">UPDATE (SELECT br.discount_aggregation, br.disable_aggregation, br.use_accounting_article_label, br.date_aggregation, br.aggregate_unit_amounts, br.ignore_subscriptions, br.ignore_orders, br.incremental_invoice_lines,
              bc.discount_aggregation, bc.disable_aggregation, bc.use_accounting_article_label, bc.date_aggregation, bc.aggregate_unit_amounts, bc.ignore_subscriptions, bc.ignore_orders, bc.incremental_invoice_lines
              FROM {h-schema}billing_billing_run br, {h-schema}billing_cycle bc WHERE bc.id=br.billing_cycle_id) 
              SET br.discount_aggregation = bc.discount_aggregation, br.disable_aggregation = bc.disable_aggregation, br.use_accounting_article_label = bc.use_accounting_article_label, br.date_aggregation = bc.date_aggregation,
              br.aggregate_unit_amounts = bc.aggregate_unit_amounts, br.ignore_subscriptions = bc.ignore_subscriptions, br.ignore_orders = bc.ignore_orders, br.incremental_invoice_lines = bc.incremental_invoice_lines"),
         </sql>
    </changeSet>

    <changeSet id="#INTRD-17987_20230825_discount_agg_cherry-pick" author="a.rouaguebe">
        <addColumn tableName="billing_billing_run">
            <column name="discount_aggregation" type="varchar(17)" />
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="discount_aggregation" type="varchar(17)" />
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}billing_billing_run set discount_aggregation = 'NO_AGGREGATION' where discount_aggregation is null</sql>
        <sql>UPDATE ${db.schema.adapted}billing_cycle set discount_aggregation = 'NO_AGGREGATION' where discount_aggregation is null</sql>
        <sql>ALTER TABLE ${db.schema.adapted}billing_cycle ALTER COLUMN discount_aggregation SET DEFAULT 'FULL_AGGREGATION';</sql>
        <sql>ALTER TABLE ${db.schema.adapted}billing_cycle ALTER COLUMN discount_aggregation SET NOT NULL</sql>
	 </changeSet>
    
    <changeSet id="#INTRD-18004_2023-09-04" author="hatimOUDAD">
        <addColumn tableName="finance_settings">
            <column name="entities_with_huge_volume" type="${type.json}"/>
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-16640_20230724" author="AndriusKarpavicius">
        <sql>CREATE INDEX idx__billing_invoice_line_il_job ON ${db.schema.adapted}billing_invoice_line USING btree (billing_run_id, billing_account_id, offer_template_id, accounting_article_id, tax_id) where status='OPEN'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_InvoiceLinesJob' ) </sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_InvoiceLinesJob'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_ArticleMappingJob' ) </sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_ArticleMappingJob'</sql>


        
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__billing_account_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__offer_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__tax_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__infoOrder_productVersion_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__accountingArticle_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__discountedRatedTransaction</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__subscription_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__order_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__order_number</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__description</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__tax_percent</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_rated_transaction__charge_instance</sql>
        
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__billing_account_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__billing_run</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__status</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__accounting_article</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__offer_template_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__tax_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__product_version_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__discounted_invoice_line</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__subscription_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__service_instance_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__commercial_order_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__order_number</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__label</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_invoice_line__taxRate</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_subscription__order_id</sql>

        <sql>DROP INDEX IF EXISTS idx__billing_billing_account__lower_code</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_wo__charge_instance_id</sql>
        <sql>DROP INDEX IF EXISTS idx__billing_wo__subscription_id</sql>
        <sql>DROP INDEX IF EXISTS idx__charge_instance__lower_code</sql>

    </changeSet>
    
   	<changeSet id="USAGE_RERATE_RT_JOB" author="Mohammed_ElAzzouzi">
            <sql>create index billing_redirection_rule__idx_contract_id_priority on ${db.schema.adapted}billing_redirection_rule using btree (contract_id, priority)</sql>
            <sql>create index cpq_attribute_instance__service_instance_index on ${db.schema.adapted}cpq_attribute_instance using btree (service_instance_id)</sql>
            <sql>create index idx_subscription_id_charge_type on ${db.schema.adapted}billing_charge_instance using btree (subscription_id, charge_type)</sql>
    </changeSet>
    
     <changeSet id="#INTRD-18792_advanced_settings" author="Mohammed_ElAzzouzi">
     <createSequence sequenceName="advanced_settings_seq" startValue="1" />
    	<createTable tableName="advanced_settings">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="advanced_settings_pk" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="unique_advanced_settings_code" />
            </column>
            <column name="description" type="varchar(255)" />
	        <column name="origin" type="varchar(100)"/>
	        <column name="category" type="varchar(100)"/>
	        <column name="property_group" type="varchar(100)"/>
	        <column name="property_value" type="VARCHAR(255)"/>
	        <column name="property_type" type="VARCHAR(255)"/>
	    </createTable>
	</changeSet>
    
    <changeSet id="#INTRD-16881_20230816" author="Mohammed_ElAzzouzi">
		  <sql>CREATE INDEX idx__billing_rated_transaction__charge_instance ON ${db.schema.adapted}billing_rated_transaction USING btree (charge_instance_id) WHERE status= 'OPEN' and accounting_article_id is null </sql>
	</changeSet>
	
	<changeSet id="#INTRD-18140_20230904" author="AdilElJaouhari">
		<addColumn tableName="cat_charge_template">
			<column name="business_key_el" type="varchar(2000)" />
			<column name="business_key_description" type="VARCHAR(255)" defaultValue="Business key"/>
			<column name="business_key_translated_descriptions" type="${type.json}" defaultValue='{"FRA":"Cl mtier", "ENG":"Business key"}'>
                <constraints nullable="false" />
            </column>
			<column name="business_key_translated_long_descriptions" type="${type.json}" defaultValue='{"FRA":"La cl mtier est calcul  la valorisation en utilisant une formule personnalis enregistre sur la charge", "ENG":"Business key is computed at rating using a custom expression set on the charge"}'>
                <constraints nullable="false" />
            </column>
            <column name="business_key_format" type="VARCHAR(50)" defaultValue="TEXT">
	            <constraints nullable="false" />
            </column>
			<column name="business_key_is_mandatory" type="${type.boolean}" defaultValueNumeric="0" />
			<column name="business_key_is_hidden" type="${type.boolean}" defaultValueNumeric="0" />
		</addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-18146_20230904" author="AdilElJaouhari">
		<addColumn tableName="billing_wallet_operation">
			<column name="business_key" type="VARCHAR(255)" />
		</addColumn>
		<addColumn tableName="rating_edr">
			<column name="business_key" type="VARCHAR(255)" />
		</addColumn>
		<addColumn tableName="billing_rated_transaction">
			<column name="business_key" type="VARCHAR(255)" />
		</addColumn>
	</changeSet>

	<changeSet id="INTRD-17830_20231108" author="AbdelmounaimAkadid">
        <sql>CREATE INDEX idx_rating_edr__business_key ON ${db.schema.adapted}rating_edr using btree(business_key)</sql>
        <sql>CREATE INDEX idx_billing_rated_transaction__business_key ON billing_rated_transaction using btree(business_key)</sql>
        <sql>CREATE INDEX idx_rating_wo__business_key ON billing_wallet_operation using btree(business_key)</sql>
    </changeSet>

    <changeSet id="#INTRD-19124_wo_partitioning" author="a.rouaguebe">
        <addColumn tableName="finance_settings">
            <column name="wo_partition_range_months" type="int4">
                <constraints nullable="true" />
            </column>
            <column name="rt_partition_range_months" type="int4">
                <constraints nullable="true" />
            </column>
            <column name="edr_partition_range_months" type="int4">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
</databaseChangeLog>