<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="#4140_08042019" author="hznibar">
			<modifyDataType tableName="wf_history_action" columnName="result" newDataType="varchar(2000)" />
	</changeSet>
	
	<changeSet id="#4127_10042019" author="AbdelmounaimAkadid">
		<addColumn tableName="dwh_report_extract">
            <column name="output_dir" type="varchar(255)" />
        </addColumn>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = concat('reports/', category) where category is not null or category != ''
        </sql>
        <sql>update ${db.schema.adapted}dwh_report_extract set output_dir = 'reports' where category is null or category = ''
        </sql>
	</changeSet>

    <changeSet id="#4089_20190404" author="AbdellatifBARI">
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl set applies_to = case

            when applies_to = 'PROVIDER'                then 'Provider'
            when applies_to = 'PRODUCT'                 then 'ProductTemplate'
            when applies_to = 'PRODUCT_INSTANCE'        then 'ProductInstance'
            when applies_to = 'OFFER'                   then 'OfferTemplate'
            when applies_to = 'SELLER'                  then 'Seller'
            when applies_to = 'CUST'                    then 'Customer'
            when applies_to = 'CA'                      then 'CustomerAccount'
            when applies_to = 'BA'                      then 'BillingAccount'
            when applies_to = 'UA'                      then 'UserAccount'
            when applies_to = 'SERVICE'                 then 'ServiceTemplate'
            when applies_to = 'SERVICE_INSTANCE'        then 'ServiceInstance'
            when applies_to = 'SUB'                     then 'Subscription'
            when applies_to = 'ACC'                     then 'Access'
            when applies_to = 'CHARGE'                  then 'ChargeTemplate'
            when applies_to = 'PRICEPLAN'               then 'PricePlanMatrix'

            when applies_to = 'BILLING_CYCLE'           then 'BillingCycle'
            when applies_to = 'TAX'                     then 'Tax'
            when applies_to = 'INV_CAT'                 then 'InvoiceCategory'
            when applies_to = 'INVOICE'                 then 'Invoice'
            when applies_to = 'ACCT_CODE'               then 'AccountingCode'
            when applies_to = 'FILTER'                  then 'Filter'
            when applies_to = 'QUOTE'                   then 'Quote'
            when applies_to = 'ORDER'                   then 'Order'
            when applies_to = 'USER'                    then 'User'
            when applies_to = 'JOB'                     then 'JobInstance'
            when applies_to = 'DISCOUNT_PLAN_INSTANCE'  then 'DiscountPlanInstance'
            when applies_to = 'DISCOUNT_PLAN'           then 'DiscountPlan'
            when applies_to = 'OFFER_CATEGORY'          then 'OfferTemplateCategory'
            when applies_to = 'INV_SUB_CAT'             then 'InvoiceSubCategory'
            when applies_to = 'ACC_OP'                  then 'AccountOperation'

            when applies_to = 'BILLING_RUN'             then 'BillingRun'
            when applies_to = 'INVOICE_TYPE'            then 'InvoiceType'
            when applies_to = 'DISCOUNT_PLAN_ITEM'      then 'DiscountPlanItem'
            when applies_to = 'OTH_TR'                  then 'OtherTransaction'
            when applies_to = 'REPORT'                  then 'ReportExtract'
            when applies_to = 'BUNDLE'                  then 'BundleTemplate'
            when applies_to = 'PAYMENT_SCH_INSTANCE'    then 'PaymentScheduleInstance'
            when applies_to = 'DDREQ_BUILDER'           then 'DDRequestBuilder'
            when applies_to = 'PAYMENT_SCH'             then 'PaymentScheduleTemplate'

            when applies_to like 'JOB_%'                then  concat('JobInstance_', substring(applies_to, length('JOB_')+1, length(applies_to)))

            else applies_to

            end where applies_to is not null
        </sql>
    </changeSet>

	<changeSet id="#4107_20190515" author="EdwardPLegaspi">
		<createTable tableName="adm_role_secured_entity">
			<column name="role_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="code" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="entity_class" type="varchar(255)">
				<constraints nullable="false" />
			</column>
		</createTable>
		<addPrimaryKey columnNames="role_id, code, entity_class"
			constraintName="adm_role_secured_entity_pkey"
			tableName="adm_role_secured_entity" />
	</changeSet>
    
    <changeSet id="#4117_20190405" author="AmineBENAICHA">
    	<addColumn tableName="wf_instance">
            <column name="entity_instance_id" type="bigint" >
            	<constraints nullable="false" />
            </column>
        </addColumn>
        <createIndex tableName="wf_instance" indexName="wf_instance_entity_id_idx">
            <column name="entity_instance_id" type="bigint"/>
        </createIndex>
    </changeSet>

    <changeSet id="#4179_20190417" author="AndriusKarpavicius">
        <addColumn tableName="meveo_script_instance">
            <column name="reuse" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#4148_20190418 - Add runAsync on notification" author="EdwardPLegaspi">
    	<addColumn tableName="adm_notification">
            <column name="run_async" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#3683_20190415" author="YoussefIZEM">
         <addColumn tableName="adm_notif_email">
            <column name="email_template_id" type="bigint"></column>
        </addColumn>
         <addColumn tableName="adm_notification">
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </addColumn>
        <sql>update ${db.schema.adapted}adm_notification set uuid = id</sql>
        <sql dbms="postgres">update ${db.schema.adapted}adm_notif_email set email_template_id=NEXTVAL('${db.schema.adapted}com_msg_tmpl_seq')</sql>
        <sql dbms="mysql">update ${db.schema.adapted}adm_notif_email set email_template_id = (select max(next_val) from ${db.schema.adapted}com_msg_tmpl_seq);</sql>
        <sql>
            INSERT INTO ${db.schema.adapted}com_message_template(id, version, created, code, subject, textcontent, htmlcontent, media)   
            SELECT email_template_id, 0, now(), notif.code, email_subject, email_body, email_html_body, 'EMAIL' as media
            FROM ${db.schema.adapted}adm_notif_email email
            LEFT JOIN ${db.schema.adapted}adm_notification notif  on notif.id = email.id
        </sql>
        <addForeignKeyConstraint baseColumnNames="email_template_id" baseTableName="adm_notif_email" constraintName="fk_com_message_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="com_message_template" />
                    
        <dropColumn tableName="adm_notif_email">
            <column name="email_body"></column>
            <column name="email_html_body"></column>
            <column name="email_subject"></column>
        </dropColumn>
     </changeSet>
     
     <changeSet id="#4208_2019042601" author="MohamedElYoussoufi" dbms="postgresql" >
     	
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei((lower(cet_code)),(lower(code)));</sql>
        
     </changeSet>
     
     <changeSet id="#4208_2019042602" author="MohamedElYoussoufi" dbms="mysql">
     	
        <sql>CREATE INDEX cust_cei_cet_and_code_index ON ${db.schema.adapted}cust_cei(cet_code,code);</sql>
     	
     </changeSet>
     
     
     <changeSet id="#3692_20190426" author="AndriusKarpavicius">
        <modifyDataType tableName="ar_payment_gateway" columnName="iban" newDataType="varchar(80)" />
    </changeSet>
    
    <changeSet id="#4207_2019042901" author="MohamedElYoussoufi">
     	
     	<addColumn tableName="billing_rated_transaction">
            <column name="offer_id" type="bigint"></column>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
            
        <addColumn tableName="billing_wallet_operation">
            <column name="offer_id" type="bigint"></column>
        </addColumn>
        
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
            
        <sql>
        	update ${db.schema.adapted}billing_wallet_operation set offer_code = null where offer_code = 'NO_OFFER';
        </sql>
          
      </changeSet>
      
      <changeSet id="#4207_2019042902" author="MohamedElYoussoufi" dbms="postgresql">
      
        <sql>
        	 	update ${db.schema.adapted}billing_rated_transaction rt set offer_id = (select s.offer_id from ${db.schema.adapted}billing_subscription s where s.id=rt.subscription_id and rt.subscription_id is not null)
        </sql>
        
        <sql>
        		update ${db.schema.adapted}billing_wallet_operation wo set offer_id = (select s.offer_id from ${db.schema.adapted}billing_subscription s where s.id=wo.subscription_id and wo.subscription_id is not null)
        </sql>
      
      </changeSet>
      
      <changeSet id="#4207_2019042903" author="MohamedElYoussoufi" dbms="mysql">
      	<sql>
        	 update ${db.schema.adapted}billing_rated_transaction rt join ${db.schema.adapted}billing_subscription s on s.id=rt.subscription_id  set rt.offer_id = s.offer_id where rt.subscription_id is not null
        </sql>
        <sql>
        	update ${db.schema.adapted}billing_wallet_operation wo join ${db.schema.adapted}billing_subscription s on s.id=wo.subscription_id  set wo.offer_id = s.offer_id where wo.subscription_id is not null
		</sql>
      </changeSet>
      
      <changeSet id="#4207_2019042904" author="MohamedElYoussoufi">
      	<dropColumn tableName="billing_rated_transaction">
            <column name="offer_code"></column>
        </dropColumn>
      </changeSet>

	<changeSet id="#4156_20190423" author="EdwardPLegaspi">
		<addColumn tableName="meveo_job_instance">
			<column name="verbose_report" type="${type.boolean}"
				defaultValueNumeric="1" />
		</addColumn>

		<update tableName="meveo_job_instance">
			<column name="verbose_report" valueNumeric="1"></column>
		</update>
	</changeSet>
    
    <changeSet id="#4198_03052019" author="SaidRamli">
       <addColumn tableName="billing_invoice_type">
           <column name="invoice_accountable" type="${type.boolean}" defaultValueNumeric="1">
		        <constraints nullable="false" />
		    </column>
       </addColumn>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 1 where code not in ('QUOTE','DRAFT','PREPAID')</sql>
        <sql>update ${db.schema.adapted}billing_invoice_type set invoice_accountable = 0 where code in ('QUOTE','DRAFT','PREPAID')</sql>
    </changeSet>

    <changeSet id="#4156_08052019" author="AndriusKarpavicius">
        <addDefaultValue tableName="meveo_job_instance" columnName="exclude_inv_without_amount" defaultValueNumeric="0" />
        <sql>update ${db.schema.adapted}meveo_job_instance set exclude_inv_without_amount = 0 where exclude_inv_without_amount is null</sql>
    </changeSet>



    <changeSet id="#4282_20190520" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction">
            <column name="service_instance_id" type="bigInt"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_service_instance" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <sql>CREATE INDEX rt_subscription_index ON ${db.schema.adapted}billing_rated_transaction  (subscription_id, invoice_id, usage_date)</sql>
        <sql>CREATE INDEX rt_ba_invoice_index ON ${db.schema.adapted}billing_rated_transaction  (billing_account__id, invoice_id, usage_date)</sql>
        <sql dbms="postgres">CREATE INDEX billing_service_instance_min_index ON ${db.schema.adapted}billing_service_instance  (minimum_amount_el) WHERE minimum_amount_el IS NOT NULL</sql>
        <sql dbms="mysql">CREATE INDEX billing_service_instance_min_index ON ${db.schema.adapted}billing_service_instance  (minimum_amount_el)</sql>
        <sql dbms="postgres">CREATE INDEX billing_subscription_min_index ON ${db.schema.adapted}billing_subscription  (minimum_amount_el) WHERE minimum_amount_el IS NOT NULL</sql>
        <sql dbms="mysql">CREATE INDEX billing_subscription_min_index ON ${db.schema.adapted}billing_subscription  (minimum_amount_el)</sql>
    </changeSet>

    <changeSet id="#39262_20190604" author="TonyAlejandro">
        <addColumn tableName="billing_service_instance">
            <column name="calendar_init_active_id" type="bigint" />
            <column name="calendar_renew_for_id" type="bigint" />
            <column name="renewal_term_type" type="varchar(20)" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="calendar_init_active_id" type="bigint" />
            <column name="calendar_renew_for_id" type="bigint" />
            <column name="renewal_term_type" type="varchar(20)" />
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="calendar_init_active_id" type="bigint" />
            <column name="calendar_renew_for_id" type="bigint" />
            <column name="renewal_term_type" type="varchar(20)" />
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="calendar_init_active_id" type="bigint" />
            <column name="calendar_renew_for_id" type="bigint" />
            <column name="renewal_term_type" type="varchar(20)" />
        </addColumn>
        <addDefaultValue tableName="billing_service_instance" columnName="initial_term_type" defaultValue="RECURRING" />
        <addDefaultValue tableName="cat_service_template" columnName="initial_term_type" defaultValue="RECURRING" />
        <addDefaultValue tableName="cat_offer_template" columnName="initial_term_type" defaultValue="RECURRING" />
        <addDefaultValue tableName="billing_subscription" columnName="initial_term_type" defaultValue="RECURRING" />
        <addForeignKeyConstraint baseColumnNames="calendar_init_active_id" baseTableName="billing_service_instance" constraintName="fk_si_init_active" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_renew_for_id" baseTableName="billing_service_instance" constraintName="fk_si_renew_for" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_init_active_id" baseTableName="cat_service_template" constraintName="fk_st_init_active" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_renew_for_id" baseTableName="cat_service_template" constraintName="fk_st_renew_for" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_init_active_id" baseTableName="cat_offer_template" constraintName="fk_ot_init_active" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_renew_for_id" baseTableName="cat_offer_template" constraintName="fk_ot_renew_for" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_init_active_id" baseTableName="billing_subscription" constraintName="fk_bs_init_active" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="calendar_renew_for_id" baseTableName="billing_subscription" constraintName="fk_bs_renew_for" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />

    </changeSet>

    <changeSet id="#4282_20190524" author="AndriusKarpavicius" dbms="postgres">
        <sql>DROP INDEX rt_ba_invoice_index</sql>
        <sql>DROP INDEX rt_subscription_index</sql>
        <sql>DROP INDEX transaction_billing_index</sql>
        <sql>DROP INDEX rated_transaction_number</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON billing_rated_transaction (billing_account__id, usage_date, service_instance_id) where status='OPEN' and service_instance_id is not null</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON billing_rated_transaction (billing_account__id, usage_date, subscription_id) where status='OPEN'</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON billing_rated_transaction (subscription_id, usage_date, service_instance_id) where status='OPEN' and subscription_id is not null</sql>
        <sql>CREATE INDEX rt_invoice_index ON billing_rated_transaction (invoice_id, invoice_sub_category_id, wallet_id) where status='BILLED'</sql>
        <sql>CREATE INDEX rt_order_index ON billing_rated_transaction (order_number, status, usage_date) where order_number is not null</sql>
    </changeSet>
    <!-- MySQL currently doesn't support conditional indexes -->
    <changeSet id="#4282_20190524-MS" author="MohamedSTITANE" dbms="mysql">
        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON billing_rated_transaction (billing_account__id, usage_date, service_instance_id)</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON billing_rated_transaction (billing_account__id, usage_date, subscription_id)</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON billing_rated_transaction (subscription_id, usage_date, service_instance_id)</sql>
        <sql>CREATE INDEX rt_invoice_index ON billing_rated_transaction (invoice_id, invoice_sub_category_id, wallet_id)</sql>
        <sql>CREATE INDEX rt_order_index ON billing_rated_transaction (order_number, status, usage_date)</sql>
    </changeSet>

<!-- Takes many hours on 30M RT
    <changeSet id="#4282_20190520-P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_rated_transaction set service_instance_id = wo.service_instance_id from ${db.schema.adapted}billing_wallet_operation wo where
               wo.rated_transaction_id=billing_rated_transaction.id
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set service_instance_id =null where billing_rated_transaction.id in (select rated_transaction_id from ${db.schema.adapted}billing_wallet_operation where rated_transaction_id is not null group by rated_transaction_id having count(*)>1 ) </sql>
    </changeSet>

    <changeSet id="#4282_20190520-M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_rated_transaction rt join ${db.schema.adapted}billing_wallet_operation wo on wo.rated_transaction_id=rt.id set rt.service_instance_id = wo.service_instance_id where wo.service_instance_id is not null
        </sql>
    </changeSet>
 -->


    <changeSet id="#4290_20190520-P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_service_instance set minimum_amount_el = st.minimum_amount_el, minimum_label_el = st.minimum_label_el from ${db.schema.adapted}cat_service_template st where
               service_template_id = st.id and billing_service_instance.minimum_amount_el is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_service_instance set minimum_amount_el_sp = st.minimum_amount_el_sp, minimum_label_el_sp = st.minimum_label_el_sp from ${db.schema.adapted}cat_service_template st where
               service_template_id = st.id and billing_service_instance.minimum_amount_el_sp is not null
        </sql>
    </changeSet>

    <changeSet id="#4290_20190520-M" author="AndriusKarpavicius" dbms="mysql">
        <sql>update ${db.schema.adapted}billing_service_instance si join ${db.schema.adapted}cat_service_template st on si.service_template_id = st.id
                set si.minimum_amount_el = st.minimum_amount_el, si.minimum_label_el = st.minimum_label_el where si.minimum_amount_el is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_service_instance si join ${db.schema.adapted}cat_service_template st on si.service_template_id = st.id
                set si.minimum_amount_el_sp = st.minimum_amount_el_sp, si.minimum_label_el_sp = st.minimum_label_el_sp where si.minimum_amount_el_sp is not null
        </sql>
    </changeSet>
    
    <changeSet id="#4326_20190530-P" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}billing_wallet_operation set tax_id = t.id from ${db.schema.adapted}billing_tax t where
               tax_percent = t.tax_percentage and tax_id is null and tax_percent is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set tax_id = t.id from ${db.schema.adapted}billing_tax t where
               tax_percent = t.tax_percentage and tax_id is null and tax_percent is not null
        </sql>        
    </changeSet>
    
    <changeSet id="#4326_20190530-M" author="AndriusKarpavicius" dbms="mysql">
       <sql>update ${db.schema.adapted}billing_wallet_operation wo join ${db.schema.adapted}billing_tax t on wo.tax_percent = t.tax_percentage set wo.tax_id = t.id  where
               wo.tax_id is null and wo.tax_percent is not null
        </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction rt join ${db.schema.adapted}billing_tax t on rt.tax_percent = t.tax_percentage set rt.tax_id = t.id  where
               rt.tax_id is null and rt.tax_percent is not null
        </sql> 
    </changeSet>
    
    <changeSet id="#4326_20190530" author="AndriusKarpavicius">
        <addNotNullConstraint tableName="billing_tax" columnName="tax_percentage" columnDataType="numeric(23, 12)"/>
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="tax_id" columnDataType="bigInt"/>
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="tax_percent" columnDataType="numeric(23, 12)"/>
        <addNotNullConstraint tableName="billing_rated_transaction" columnName="tax_id" columnDataType="bigInt"/>
        <addNotNullConstraint tableName="billing_rated_transaction" columnName="tax_percent" columnDataType="numeric(23, 12)"/>    
    </changeSet>
    
    <changeSet id="#4278_20190520_partitions" author="mohamed.el.youssoufi" dbms="postgresql">
    
    	<createProcedure><![CDATA[
		
			DROP FUNCTION IF EXISTS create_partitions(text,text,text,integer);
            
			CREATE OR REPLACE FUNCTION create_partitions(table_name text, start_date text, frequency text, partitions_number int) RETURNS void AS $$
            -- Function to create partition tables for a given table
            -- Param1 : table_name => name of the table to be partitonned. Can include a schema name
            -- Param2 : start_date => date of the beginning of partitonning (input format YYYY_MM_DD)
            -- Param3 : frequency => interval of partionning ( Y for years, M for monthes, W for weeks)
            -- Param4 : partitions_number : number of partitions to create starting form param start_date

            -- Call Example : create_partitions('public.rating_edr','2019_03_01','M',5);

            DECLARE
                partition_date DATE;
                query text;
            BEGIN

                partition_date := to_date(start_date,'YYYY_MM_DD');
    
                FOR counter IN 1..partitions_number LOOP
    
                    query := 'CREATE TABLE ' || table_name || '_' || to_char(partition_date,'YYYY_MM_DD') || ' PARTITION OF ' || table_name || ' FOR VALUES FROM (''' || to_char(partition_date,'YYYY_MM_DD') || ''') TO (''';
        
                    IF frequency = 'M' THEN
                        partition_date := partition_date + interval '1 month';
                    END IF;
        
                    IF frequency = 'Y' THEN
                        partition_date := partition_date + interval '1 year';
                    END IF;
        
                    IF frequency = 'W' THEN
                        partition_date := partition_date + interval '1 week';
                    END IF;
        
                    query := query || to_char(partition_date,'YYYY_MM_DD') || ''');';
        
                    EXECUTE query;
        
                    --partition_date := partition_date + interval '1 day';
        
                    RAISE NOTICE 'partition created : %', table_name || '_' || to_char(partition_date,'YYYY_MM_DD');
    
                END LOOP;
            END;
            $$ LANGUAGE plpgsql;
			
			-- function detach all child partitions from parent
			-- param table_name = parent table name
			-- ------------------------------------------------

			CREATE OR REPLACE FUNCTION detach_partitions(table_name TEXT) RETURNS void AS $$

			DECLARE

			 partitions CURSOR(table_name TEXT) FOR SELECT distinct child.relname AS child FROM pg_inherits JOIN pg_class parent ON pg_inherits.inhparent = parent.oid JOIN pg_class child ON pg_inherits.inhrelid = child.oid JOIN pg_namespace nmsp_parent ON nmsp_parent.oid = parent.relnamespace JOIN pg_namespace nmsp_child ON nmsp_child.oid = child.relnamespace WHERE parent.relname=table_name;
			 query text;
			 
			BEGIN
				 
			   FOR row IN partitions(table_name) LOOP

					query := 'ALTER TABLE IF EXISTS ' || table_name || ' DETACH PARTITION ' || row.child;
					EXECUTE query;
					RAISE NOTICE 'partition % is detached', row.child;

				END LOOP;
			 
			END;
			$$ LANGUAGE plpgsql;
			
			-- function to drop all table indexes
			-- param table_name = target table name
			-- ------------------------------------

			CREATE OR REPLACE FUNCTION drop_all_table_indexes(table_name TEXT) RETURNS void AS $$

			DECLARE

			 cur_indexes CURSOR(table_name TEXT) FOR select indexname from pg_indexes where tablename = table_name and indexname not like '%_pkey' and indexname not like '%_pk';
			 query text;
			 
			BEGIN
				 
			   FOR row IN cur_indexes(table_name) LOOP

					query := 'DROP INDEX IF EXISTS ' || row.indexname || ' CASCADE';
					EXECUTE query;
					RAISE NOTICE 'index : %', row.indexname || ' is deleted';

				END LOOP;
			 
			END;
			$$ LANGUAGE plpgsql;

			-- function to rename all table pks (add _tmp to pk keys)
			-- param table_name = target table name
			-- ------------------------------------------------------

			CREATE OR REPLACE FUNCTION rename_all_table_pks(table_name TEXT) RETURNS void AS $$

			DECLARE

			 cur_indexes CURSOR(table_name TEXT) FOR select indexname from pg_indexes where tablename = table_name and (indexname like '%_pkey' or indexname  like '%_pk');
			 query text;
			 
			BEGIN
				 
			   FOR row IN cur_indexes(table_name) LOOP

					query := 'ALTER INDEX IF EXISTS ' || row.indexname || ' RENAME TO ' || row.indexname || '_tmp';
					EXECUTE query;
					RAISE NOTICE 'index : %', row.indexname || ' is renamed';

				END LOOP;
			 
			END;
			$$ LANGUAGE plpgsql;

			-- function to create all table indexes, from scripts stored in tmp_table_indexes table
			-- param table_name = target table name
			-- ------------------------------------------------------------------------------------

			CREATE OR REPLACE FUNCTION create_all_table_indexes(tablename TEXT) RETURNS void AS $$

			DECLARE

			 cur_indexes CURSOR(tablename TEXT) FOR select index_def from tmp_table_indexes where table_name = tablename;
			 query text;
			 
			BEGIN
				 
			   FOR row IN cur_indexes(tablename) LOOP

					query := row.index_def;
					RAISE NOTICE 'index is created';
					EXECUTE query;

				END LOOP;
			 
			END;
			$$ LANGUAGE plpgsql;

            ]]>
			
        </createProcedure>
    
		<createProcedure><![CDATA[
			CREATE OR REPLACE FUNCTION switch_billing_rated_transaction_to_partition(schema_owner text, schema_name text, frequency text, from_date date, to_date date) RETURNS void AS $$
			
			-- Function to replace billing_rated_transaction table with a partitioned table. Preserves existing data.
	        -- Param1 : schema_owner => name of the owner of the schema where table is located.
	        -- Param2 : schema_name => name of the schema where table is located.
	        -- Param3 : frequency => interval of partionning ( Y for years, M for monthes, W for weeks). If provided, partitions will be created to span the current data in a table
            -- Param4 : span of partitions - start date. DOES NOT filter the existing data. If not provided will use min and max usage_date field value as partition span start and end range.
            -- Param5 : span of partitions - end date. DOES NOT filter the existing data.
			
            DECLARE
			  _min_date date;
			  _max_date date;
			  _seq_value bigint;
			  _partitions_number int;
			
			BEGIN
			
			-- Find values for partition creation and sequence recreation                       
            
            IF from_date IS NULL THEN
                execute 'select min(usage_date), max(usage_date) from ' || schema_name || '.billing_rated_transaction ' into _min_date, _max_date;
            ELSE 
                _min_date := from_date;
                _max_date := CASE WHEN to_date IS NULL THEN now() ELSE to_date END;                
            END IF;
            
			execute 'select nextval(''' || schema_name || '.billing_rated_transaction_seq'')' into _seq_value;
			
			RAISE NOTICE 'min date is % max date is %', _min_date, _max_date;

			-- 1: Indexes : keep indexes creation scripts in a temporary table (tmp_table_indexes) before droping or renaming the target table :
			-------------------------------------------------------------------------------------------------------------------------------------
			
			-- create the temporary table for indexes scripts
			
			execute 'create table if not exists ' || schema_name || '.tmp_table_indexes (table_name text not null,index_name text not null,index_def text not null ) with (oids = false ) tablespace pg_default;';
			
			execute 'alter table ' || schema_name || '.tmp_table_indexes owner to ' || schema_owner || ';';
			
			execute 'truncate table ' || schema_name || '.tmp_table_indexes;';
			
			-- save indexes scripts in the temporary table
			
			execute 'insert into ' || schema_name || '.tmp_table_indexes (table_name, index_name, index_def) select tablename, indexname, indexdef from pg_indexes where indexname not like ''%_pk%'' and tablename = ''billing_rated_transaction'';';
			
			-- 2: Rename billing_rated_transaction to billing_rated_transaction_tmp to avoid data loss :
			--------------------------------------------------------------------------------------------
			
			execute 'alter table '||schema_name||'.billing_rated_transaction rename to billing_rated_transaction_tmp;';
			
			-- 3: Drop old table indexes :
			------------------------------
			
			execute 'select drop_all_table_indexes(''billing_rated_transaction_tmp'');';
			
			-- 4: Rename old table primary keys :
			-------------------------------------
			
			execute 'select rename_all_table_pks(''billing_rated_transaction_tmp'');';
			
			-- 5: Create the new table :
			----------------------------
			
			execute 'create table '||schema_name||'.billing_rated_transaction (
						  id bigint not null default nextval('''||schema_name||'.billing_rated_transaction_seq''::regclass),
						  version integer,
						  amount_tax numeric(23,12),
						  amount_with_tax numeric(23,12),
						  amount_without_tax numeric(23,12),
						  code character varying(255),
						  description text,
						  do_not_trigger_invoicing integer NOT NULL DEFAULT 0,
						  parameter_1 character varying(255),
						  parameter_2 character varying(255),
						  parameter_3 character varying(255),
						  quantity numeric(23,12),
						  status character varying(255),
						  unit_amount_tax numeric(23,12),
						  unit_amount_with_tax numeric(23,12),
						  unit_amount_without_tax numeric(23,12),
						  unity_description character varying(20),
						  usage_date timestamp without time zone,
						  billing_account__id bigint,
						  billing_run_id bigint,
						  invoice_id bigint,
						  aggregate_id_f bigint,
						  aggregate_id_r bigint,
						  aggregate_id_t bigint,
						  invoice_sub_category_id bigint,
						  priceplan_id bigint,
						  wallet_id bigint,
						  edr_id bigint,
						  adjusted_rated_tx bigint,
						  order_number character varying(100),
						  rating_unit_description character varying(20),
						  parameter_extra text,
						  start_date timestamp without time zone,
						  end_date timestamp without time zone,
						  subscription_id bigint,
						  seller_id bigint NOT NULL,
						  charge_instance_id bigint,
						  tax_id bigint NOT NULL,
						  tax_percent numeric(23,12) NOT NULL,
						  user_account_id bigint,
						  offer_id bigint,
                          service_instance_id bigint,
						  constraint billing_rated_transaction_pkey primary key (id, usage_date),
						  constraint fk_8g8jlmakt1wyw73oxs5yltlsd foreign key (aggregate_id_t)
							  references '||schema_name||'.billing_invoice_agregate (id) match simple
							  on update no action on delete no action,
						  constraint fk_amwacie0nqfumpd1sc7y9nv0p foreign key (aggregate_id_r)
							  references '||schema_name||'.billing_invoice_agregate (id) match simple
							  on update no action on delete no action,
						  constraint fk_anslvrbm465ossqx8surjyu22 foreign key (wallet_id)
							  references '||schema_name||'.billing_wallet (id) match simple
							  on update no action on delete no action,
						  constraint fk_bbnhg8vn7jkttghphr65iwug5 foreign key (billing_account__id)
							  references '||schema_name||'.billing_billing_account (id) match simple
							  on update no action on delete no action,
						  constraint fk_billing_rated_transaction_crm_seller foreign key (seller_id)
							  references '||schema_name||'.crm_seller (id) match simple
							  on update no action on delete no action,
						  constraint fk_billing_rated_transaction_offer_template foreign key (offer_id)
							  references '||schema_name||'.cat_offer_template (id) match simple
							  on update no action on delete no action,
						  constraint fk_eucl7of9ovyut1c4r2jkf01u6 foreign key (priceplan_id)
							  references '||schema_name||'.cat_price_plan_matrix (id) match simple
							  on update no action on delete no action,
						  constraint fk_gq86s178gc3orumcl8symk4nn foreign key (invoice_id)
							  references '||schema_name||'.billing_invoice (id) match simple
							  on update no action on delete no action,
						  constraint fk_o2mp1mqcyi2l7q2b1p88h20dw foreign key (billing_run_id)
							  references '||schema_name||'.billing_billing_run (id) match simple
							  on update no action on delete no action,
						  constraint fk_o5yu3c0bnac626w755w5f0voc foreign key (invoice_sub_category_id)
							  references '||schema_name||'.billing_invoice_sub_cat (id) match simple
							  on update no action on delete no action,
						  constraint fk_rjpm9k6xsumg297fxefffyryh foreign key (aggregate_id_f)
							  references '||schema_name||'.billing_invoice_agregate (id) match simple
							  on update no action on delete no action,
						  constraint fk_rt_tax foreign key (tax_id)
							  references '||schema_name||'.billing_tax (id) match simple
							  on update no action on delete no action,
						  constraint fk_rt_ua foreign key (user_account_id)
							  references '||schema_name||'.account_entity (id) match simple
							  on update no action on delete no action,
                          constraint fk_rt_service_instance foreign key (service_instance_id)
                              references '||schema_name||'.billing_service_instance (id) match simple
                              on update no action on delete no action
				) partition by range (usage_date)';
			
			execute 'ALTER TABLE ' ||schema_name|| '.billing_rated_transaction OWNER to ' || schema_owner || ';';
			
			-- 6: Change sequence owner to the new table :
			----------------------------------------------
			execute 'ALTER SEQUENCE ' ||schema_name|| '.billing_rated_transaction_seq OWNED BY ' ||schema_name|| '.billing_rated_transaction.id;';
			
			-- 7: Create index on partition column (will be automatically created for child partitions on pg 11) :
			------------------------------------------------------------------------------------------------------
			execute 'CREATE INDEX ON ' ||schema_name|| '.billing_rated_transaction (usage_date);';
			
			-- 8: create others indexes from stored scripts:
			------------------------------------------------
			execute 'select create_all_table_indexes(''billing_rated_transaction'');';
			
			-- 9: Create required partitions. Number of partitions is calculated between min and max partition date based on a frequency
			IF _min_date IS NOT NULL and frequency IS NOT NULL THEN
			
			  _partitions_number := _max_date - _min_date;
			  
			  IF frequency = 'M' THEN
				_partitions_number := _partitions_number/30;
			  END IF;
						
			  IF frequency = 'Y' THEN
				_partitions_number := _partitions_number/365;
			  END IF;
					
			  IF frequency = 'W' THEN
				_partitions_number := _partitions_number/7;
			  END IF;
			
			  PERFORM create_partitions(schema_name || '.billing_rated_transaction', to_char(_min_date,'YYYY_MM_DD'), frequency, _partitions_number+1);
			END IF;
			
			-- 10: create a default partition table:
			----------------------------------------
			execute 'create table '||schema_name||'.billing_rated_transaction_default partition of '||schema_name||'.billing_rated_transaction default;';
			execute 'ALTER TABLE ' ||schema_name||'.billing_rated_transaction_default OWNER to ' || schema_owner || ';';
				
			-- 11: populate the new table from old table:
			---------------------------------------------
			execute 'insert into '||schema_name||'.billing_rated_transaction select * from ' ||schema_name||'.billing_rated_transaction_tmp;';
			
			-- 12: Drop unused objects;
			
			execute 'drop table '||schema_name||'.tmp_table_indexes cascade;';
			execute 'drop table '||schema_name||'.billing_rated_transaction_tmp cascade;';
			
			    END;
			$$ LANGUAGE plpgsql;
			    
			        ]]>
        </createProcedure>
        
        <createProcedure><![CDATA[
			CREATE OR REPLACE FUNCTION switch_billing_wallet_operation_to_partition(schema_owner text, schema_name text, frequency text, from_date date, to_date date) RETURNS void AS $$
			
			-- Function to replace billing_wallet_operation table with a partitioned table. Preserves existing data.
            -- Param1 : schema_owner => name of the owner of the schema where table is located.
	        -- Param2 : schema_name => name of the schema where table is located.
	        -- Param3 : frequency => interval of partionning ( Y for years, M for monthes, W for weeks). If provided, partitions will be created to span the current data in a table
            -- Param4 : span of partitions - start date. DOES NOT filter the existing data. If not provided will use min and max operation_date field value as partition span start and end range.
            -- Param5 : span of partitions - end date. DOES NOT filter the existing data.
			
			DECLARE
			  _min_date date;
			  _max_date date;
			  _seq_value bigint;
			  _partitions_number int;
			
			BEGIN
			
			-- Find values for partition creation and sequence recreation
            IF from_date IS NULL THEN
    			execute 'select min(operation_date), max(operation_date) from ' || schema_name || '.billing_wallet_operation ' into _min_date, _max_date;
            ELSE 
                _min_date := from_date;
                _max_date := CASE WHEN to_date IS NULL THEN now() ELSE to_date END;                
            END IF;
	
    		execute 'select nextval(''' || schema_name || '.billing_wallet_operation_seq'')' into _seq_value;
			
			RAISE NOTICE 'min date is % max date is %', _min_date, _max_date;

			-- 1: Indexes : keep indexes creation scripts in a temporary table (tmp_table_indexes) before droping or renaming the target table :
			-------------------------------------------------------------------------------------------------------------------------------------
			
			-- create the temporary table for indexes scripts
			
			execute 'create table if not exists ' || schema_name || '.tmp_table_indexes (table_name text not null,index_name text not null,index_def text not null ) with (oids = false ) tablespace pg_default;';
			
			execute 'alter table ' || schema_name || '.tmp_table_indexes owner to ' || schema_owner || ';';
			
			execute 'truncate table ' || schema_name || '.tmp_table_indexes;';
			
			-- save indexes scripts in the temporary table
			
			execute 'insert into ' || schema_name || '.tmp_table_indexes (table_name, index_name, index_def) select tablename, indexname, indexdef from pg_indexes where indexname not like ''%_pk%'' and tablename = ''billing_wallet_operation'';';
			
			-- 2: Rename billing_wallet_operation to billing_wallet_operation_tmp to avoid data loss :
			--------------------------------------------------------------------------------------------
			
			execute 'alter table '||schema_name||'.billing_wallet_operation rename to billing_wallet_operation_tmp;';
			
			-- 3: Drop old table indexes :
			------------------------------
			
			execute 'select drop_all_table_indexes(''billing_wallet_operation_tmp'');';
			
			-- 4: Rename old table primary keys :
			-------------------------------------
			
			execute 'select rename_all_table_pks(''billing_wallet_operation_tmp'');';
			
			-- 5: Create the new table :
			----------------------------
			
			execute 'create table '||schema_name||'.billing_wallet_operation (
			operation_type character varying(31) NOT NULL,
			  id bigint NOT NULL,
			  version integer,
			  created timestamp without time zone NOT NULL,
			  updated timestamp without time zone,
			  code character varying(255) NOT NULL,
			  description character varying(255),
			  amount_tax numeric(23,12),
			  amount_with_tax numeric(23,12),
			  amount_without_tax numeric(23,12),
			  end_date timestamp without time zone,
			  offer_code character varying(255),
			  operation_date timestamp without time zone,
			  parameter_1 character varying(255),
			  parameter_2 character varying(255),
			  parameter_3 character varying(255),
			  quantity numeric(23,12),
			  start_date timestamp without time zone,
			  status character varying(255),
			  subscription_date timestamp without time zone,
			  tax_percent numeric(23,12) NOT NULL,
			  credit_debit_flag character varying(255),
			  unit_amount_tax numeric(23,12),
			  unit_amount_with_tax numeric(23,12),
			  unit_amount_without_tax numeric(23,12),
			  creator character varying(100),
			  updater character varying(100),
			  aggregate_serv_id bigint,
			  charge_instance_id bigint NOT NULL,
			  counter_id bigint,
			  currency_id bigint,
			  priceplan_id bigint,
			  reratedwalletoperation_id bigint,
			  seller_id bigint NOT NULL,
			  wallet_id bigint,
			  reservation_id bigint,
			  invoicing_date timestamp without time zone,
			  input_quantity numeric(23,12),
			  input_unit_description character varying(20),
			  rating_unit_description character varying(20),
			  edr_id bigint,
			  order_number character varying(100),
			  parameter_extra text,
			  raw_amount_without_tax numeric(23,12),
			  raw_amount_with_tax numeric(23,12),
			  invoice_sub_category_id bigint,
			  subscription_id bigint,
			  tax_id bigint NOT NULL,
			  rated_transaction_id bigint,
			  service_instance_id bigint,
			  offer_id bigint,
			  constraint billing_wallet_operation_pkey primary key (id, operation_date),
			  constraint fk_32r2ed0015tnd2pp5196vcqpy foreign key (reservation_id)
				  references '||schema_name||'.billing_reservation (id) match simple
				  on update no action on delete no action,
			  constraint fk_5htics7k9v44an8ap11wivraf foreign key (wallet_id)
				  references '||schema_name||'.billing_wallet (id) match simple
				  on update no action on delete no action,
			  constraint fk_60qrdadyj5wvmyii1einfb2lo foreign key (counter_id)
				  references '||schema_name||'.billing_counter (id) match simple
				  on update no action on delete no action,
			  constraint fk_75hyldnus6ti0y40vwcl49ued foreign key (charge_instance_id)
				  references '||schema_name||'.billing_charge_instance (id) match simple
				  on update no action on delete no action,
			  constraint fk_awekpkm39bhaqrf2k2gwvd4p5 foreign key (aggregate_serv_id)
				  references '||schema_name||'.billing_service_instance (id) match simple
				  on update no action on delete no action,
			  constraint fk_billing_wallet_operation_billing_invoice_sub_cat foreign key (invoice_sub_category_id)
				  references '||schema_name||'.billing_invoice_sub_cat (id) match simple
				  on update no action on delete no action,
			  constraint fk_billing_wallet_operation_offer_template foreign key (offer_id)
				  references '||schema_name||'.cat_offer_template (id) match simple
				  on update no action on delete no action,
			  constraint fk_f0v21kf4sbdcq1wwqsxmb5tsk foreign key (priceplan_id)
				  references '||schema_name||'.cat_price_plan_matrix (id) match simple
				  on update no action on delete no action,
			  constraint fk_hg1a5impet68w8a37dehlnib0 foreign key (seller_id)
				  references '||schema_name||'.crm_seller (id) match simple
				  on update no action on delete no action,
			  constraint fk_rt_charge foreign key (charge_instance_id)
				  references '||schema_name||'.billing_charge_instance (id) match simple
				  on update no action on delete no action,
			  constraint fk_t98kqb1prnfw6scvudimx1u0q foreign key (currency_id)
				  references '||schema_name||'.adm_currency (id) match simple
				  on update no action on delete no action,
			  constraint fk_wallet_operation_service_instance foreign key (service_instance_id)
				  references '||schema_name||'.billing_service_instance (id) match simple
				  on update no action on delete no action,
			  constraint fk_wo_tax foreign key (tax_id)
				  references '||schema_name||'.billing_tax (id) match simple
				  on update no action on delete no action
				) partition by range (operation_date)';
			
			execute 'ALTER TABLE ' ||schema_name|| '.billing_wallet_operation OWNER to ' || schema_owner || ';';
			
			-- 6: Change sequence owner to the new table :
			----------------------------------------------
			execute 'ALTER SEQUENCE ' ||schema_name|| '.billing_wallet_operation_seq OWNED BY ' ||schema_name|| '.billing_wallet_operation.id;';
			
			-- 7: Create index on partition column (will be automatically created for child partitions on pg 11) :
			------------------------------------------------------------------------------------------------------
			execute 'CREATE INDEX ON ' ||schema_name|| '.billing_wallet_operation (operation_date);';
			
			-- 8: create others indexes from stored scripts:
			------------------------------------------------
			execute 'select create_all_table_indexes(''billing_wallet_operation'');';
			
			-- 9: Create required partitions. Number of partitions is calculated between min and max partition date based on a frequency
			IF _min_date IS NOT NULL and frequency IS NOT NULL THEN
			
			  _partitions_number := _max_date - _min_date;
			  
			  IF frequency = 'M' THEN
				_partitions_number := _partitions_number/30;
			  END IF;
						
			  IF frequency = 'Y' THEN
				_partitions_number := _partitions_number/365;
			  END IF;
					
			  IF frequency = 'W' THEN
				_partitions_number := _partitions_number/7;
			  END IF;
			
			  PERFORM create_partitions(schema_name || '.billing_wallet_operation', to_char(_min_date,'YYYY_MM_DD'), frequency, _partitions_number+1);
			END IF;
			
			-- 10: create a default partition table:
			----------------------------------------
			execute 'create table '||schema_name||'.billing_wallet_operation_default partition of '||schema_name||'.billing_wallet_operation default;';
			execute 'ALTER TABLE ' ||schema_name||'.billing_wallet_operation_default OWNER to ' || schema_owner || ';';
				
			-- 11: populate the new table from old table:
			---------------------------------------------
			execute 'insert into '||schema_name||'.billing_wallet_operation select * from ' ||schema_name||'.billing_wallet_operation_tmp;';
			
			-- 12: Drop unused objects;
			
			execute 'drop table '||schema_name||'.tmp_table_indexes cascade;';
			execute 'drop table '||schema_name||'.billing_wallet_operation_tmp cascade;';
			
			    END;
			$$ LANGUAGE plpgsql;
			    
			        ]]>
        </createProcedure>
        
        <createProcedure><![CDATA[
			CREATE OR REPLACE FUNCTION switch_rating_edr_to_partition(schema_owner text, schema_name text, frequency text, from_date date, to_date date) RETURNS void AS $$
			
			-- Function to replace rating_edr table with a partitioned table. Preserves existing data.
			-- Param1 : schema_owner => name of the owner of the schema where table is located.
            -- Param2 : schema_name => name of the schema where table is located.
	        -- Param3 : frequency => interval of partionning ( Y for years, M for monthes, W for weeks). If provided, partitions will be created to span the current data in a table
            -- Param4 : span of partitions - start date. DOES NOT filter the existing data. If not provided will use min and max event_date field value as partition span start and end range.
            -- Param5 : span of partitions - end date. DOES NOT filter the existing data.
			
			DECLARE
			  _min_date date;
			  _max_date date;
			  _seq_value bigint;
			  _partitions_number int;
			
			BEGIN
			
			-- Find values for partition creation and sequence recreation
            IF from_date IS NULL THEN
	            execute 'select min(event_date), max(event_date) from ' || schema_name || '.rating_edr ' into _min_date, _max_date;
            ELSE 
                _min_date := from_date;
                _max_date := CASE WHEN to_date IS NULL THEN now() ELSE to_date END;                
            END IF;

			execute 'select nextval(''' || schema_name || '.rating_edr_seq'')' into _seq_value;
			
			RAISE NOTICE 'min date is % max date is %', _min_date, _max_date;

			-- 1: Indexes : keep indexes creation scripts in a temporary table (tmp_table_indexes) before droping or renaming the target table :
			-------------------------------------------------------------------------------------------------------------------------------------
			
			-- create the temporary table for indexes scripts
			
			execute 'create table if not exists ' || schema_name || '.tmp_table_indexes (table_name text not null,index_name text not null,index_def text not null ) with (oids = false ) tablespace pg_default;';
			
			execute 'alter table ' || schema_name || '.tmp_table_indexes owner to ' || schema_owner || ';';
			
			execute 'truncate table ' || schema_name || '.tmp_table_indexes;';
			
			-- save indexes scripts in the temporary table
			
			execute 'insert into ' || schema_name || '.tmp_table_indexes (table_name, index_name, index_def) select tablename, indexname, indexdef from pg_indexes where indexname not like ''%_pk%'' and tablename = ''rating_edr'';';
			
			-- 2: Rename rating_edr to rating_edr_tmp to avoid data loss :
			--------------------------------------------------------------------------------------------
			
			execute 'alter table '||schema_name||'.rating_edr rename to rating_edr_tmp;';
			
			-- 3: Drop old table indexes :
			------------------------------
			
			execute 'select drop_all_table_indexes(''rating_edr_tmp'');';
			
			-- 4: Rename old table primary keys :
			-------------------------------------
			
			execute 'select rename_all_table_pks(''rating_edr_tmp'');';
			
			-- 5: Create the new table :
			----------------------------
			
			execute 'create table '||schema_name||'.rating_edr (
			  id bigint not null default nextval('''||schema_name||'.rating_edr_seq''::regclass),
			  version integer,
			  created timestamp without time zone,
			  event_date timestamp without time zone,
			  last_updated timestamp without time zone,
			  origin_batch character varying(255),
			  origin_record character varying(255),
			  parameter_1 character varying(255),
			  parameter_2 character varying(255),
			  parameter_3 character varying(255),
			  parameter_4 character varying(255),
			  quantity numeric(23,12),
			  reject_reason text,
			  status character varying(255),
			  subscription_id bigint NOT NULL,
			  parameter_5 character varying(255),
			  parameter_6 character varying(255),
			  parameter_7 character varying(255),
			  parameter_8 character varying(255),
			  parameter_9 character varying(255),
			  date_parameter_1 timestamp without time zone,
			  date_parameter_2 timestamp without time zone,
			  date_parameter_3 timestamp without time zone,
			  date_parameter_4 timestamp without time zone,
			  date_parameter_5 timestamp without time zone,
			  decimal_parameter_1 numeric(23,12),
			  decimal_parameter_2 numeric(23,12),
			  decimal_parameter_3 numeric(23,12),
			  decimal_parameter_4 numeric(23,12),
			  decimal_parameter_5 numeric(23,12),
			  access_code character varying(255),
			  header_edr_id bigint,
			  extra_parameter text,
			  CONSTRAINT rating_edr_pkey PRIMARY KEY (id, event_date),
			  CONSTRAINT fk_f5tulmo519cm4il45bhborgq1 FOREIGN KEY (subscription_id)
				  REFERENCES public.billing_subscription (id) MATCH SIMPLE
				  ON UPDATE NO ACTION ON DELETE NO ACTION
			) partition by range (event_date)'; 
			
			execute 'ALTER TABLE ' ||schema_name|| '.rating_edr OWNER to ' || schema_owner || ';';
			
			-- 6: Change sequence owner to the new table :
			----------------------------------------------
			execute 'ALTER SEQUENCE ' ||schema_name|| '.rating_edr_seq OWNED BY ' ||schema_name|| '.rating_edr.id;';
			
			-- 7: Create index on partition column (will be automatically created for child partitions on pg 11) :
			------------------------------------------------------------------------------------------------------
			execute 'CREATE INDEX ON ' ||schema_name|| '.rating_edr (event_date);';
			
			-- 8: create others indexes from stored scripts:
			------------------------------------------------
			execute 'select create_all_table_indexes(''rating_edr'');';
			
			-- 9: Create required partitions. Number of partitions is calculated between min and max partition date based on a frequency
			IF _min_date IS NOT NULL and frequency IS NOT NULL THEN
			
			  _partitions_number := _max_date - _min_date;
			  
			  IF frequency = 'M' THEN
				_partitions_number := _partitions_number/30;
			  END IF;
						
			  IF frequency = 'Y' THEN
				_partitions_number := _partitions_number/365;
			  END IF;
					
			  IF frequency = 'W' THEN
				_partitions_number := _partitions_number/7;
			  END IF;
			
			  PERFORM create_partitions(schema_name || '.rating_edr', to_char(_min_date,'YYYY_MM_DD'), frequency, _partitions_number+1);
			END IF;
			
			-- 10: create a default partition table:
			----------------------------------------
			execute 'create table '||schema_name||'.rating_edr_default partition of '||schema_name||'.rating_edr default;';
			execute 'ALTER TABLE ' ||schema_name||'.rating_edr_default OWNER to ' || schema_owner || ';';
				
			-- 11: populate the new table from old table:
			---------------------------------------------
			execute 'insert into '||schema_name||'.rating_edr select * from ' ||schema_name||'.rating_edr_tmp;';
			
			-- 12: Drop unused objects;
			
			execute 'drop table '||schema_name||'.tmp_table_indexes cascade;';
			execute 'drop table '||schema_name||'.rating_edr_tmp cascade;';
			
			    END;
			$$ LANGUAGE plpgsql;
			    
			        ]]>
        </createProcedure>
    
    </changeSet>

    <changeSet author="mohamed.el.youssoufi" id="#4301_23052019 - empty tax amount">
    	<sql>update ${db.schema.adapted}billing_invoice set amount_tax = (amount_with_tax - amount_without_tax), pdf_filename = null, xml_filename = null where amount_tax = 0 and amount_with_tax != amount_without_tax and amount_tax != (amount_with_tax - amount_without_tax);</sql>
    </changeSet>

    <changeSet author="abdelkader.bouazza" id="#4026-Order-validation-enhancement">
        <dropNotNullConstraint tableName="ord_order_item" columnName="user_account_id" columnDataType="bigint" />
    </changeSet>
    <changeSet id="#4192_20190506 - add counter for subscription and service" author="KhalidHorri">
        <addColumn tableName="billing_counter">
            <column name="subscription_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_counter">
            <column name="service_instance_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_counter_subscription_id" referencedTableName="billing_subscription"
                                 baseColumnNames="subscription_id" baseTableName="billing_counter" referencedColumnNames="id"/>
        <addForeignKeyConstraint constraintName="fk_billing_counter_service_instance_id" referencedTableName="billing_service_instance"
                                 baseColumnNames="service_instance_id" baseTableName="billing_counter" referencedColumnNames="id"/>
    </changeSet>
    
    <changeSet id="#4303_300520191" author="mohamed.el.youssoufi" dbms="postgresql">
		<sql>ALTER TABLE ${db.schema.adapted}ar_account_operation RENAME COLUMN occ_code TO code;</sql>
		<sql>ALTER TABLE ${db.schema.adapted}ar_account_operation RENAME COLUMN occ_description TO description;</sql>
    </changeSet>
    
    <changeSet id="#4303_300520192" author="mohamed.el.youssoufi" dbms="mysql">
	    <sql>ALTER TABLE ${db.schema.adapted}ar_account_operation CHANGE occ_code code varchar(255);</sql>
	    <sql>ALTER TABLE ${db.schema.adapted}ar_account_operation CHANGE occ_description description varchar(255);</sql>
	</changeSet>

    <changeSet id="#4322_20190612 - Add a filter to GenericWorkflow" author="MounirBahije">
        <addColumn tableName="wf_generic_workflow">
            <column name="filter_id" type="bigint"/>
        </addColumn>
    </changeSet>
    
        <changeSet id="#4054_201917061 - Encryption" author="MohamedElYoussoufi" dbms="postgresql">
    	<sql>
			alter table ${db.schema.adapted}crm_provider alter column bic type character varying(100);
			alter table ${db.schema.adapted}crm_provider alter column iban type character varying(100);
			
			alter table ${db.schema.adapted}ar_payment_token alter column bic type character varying(100);
			alter table ${db.schema.adapted}ar_payment_token alter column iban type character varying(100);
			
			alter table ${db.schema.adapted}ar_payment_gateway alter column bic type character varying(100);
			alter table ${db.schema.adapted}ar_payment_gateway alter column iban type character varying(100);
			
			alter table ${db.schema.adapted}crm_seller alter column phone type character varying(100);
			alter table ${db.schema.adapted}crm_seller alter column mobile type character varying(100);
			
			alter table ${db.schema.adapted}account_entity alter column phone type character varying(100);
			alter table ${db.schema.adapted}account_entity alter column mobile type character varying(100);
			
			alter table ${db.schema.adapted}adm_user alter column firstname type character varying(100);
			alter table ${db.schema.adapted}adm_user alter column lastname type character varying(100);
			
			alter table ${db.schema.adapted}account_entity alter column firstname type character varying(100);
			alter table ${db.schema.adapted}account_entity alter column lastname type character varying(100);
    	</sql>
    </changeSet>
    
    <changeSet id="#4054_201917062 - Encryption" author="mohamed.el.youssoufi" dbms="mysql">
    		<sql> alter table ${db.schema.adapted}crm_provider modify bic varchar(100);
			alter table ${db.schema.adapted}crm_provider modify iban varchar(100);
			
			alter table ${db.schema.adapted}ar_payment_token modify bic varchar(100);
			alter table ${db.schema.adapted}ar_payment_token modify iban varchar(100);
			
			alter table ${db.schema.adapted}ar_payment_gateway modify bic varchar(100);
			alter table ${db.schema.adapted}ar_payment_gateway modify iban varchar(100);
			
			alter table ${db.schema.adapted}crm_seller modify phone varchar(100);
			alter table ${db.schema.adapted}crm_seller modify mobile varchar(100);
			
			alter table ${db.schema.adapted}account_entity modify phone varchar(100);
			alter table ${db.schema.adapted}account_entity modify mobile varchar(100);
			
			alter table ${db.schema.adapted}adm_user modify firstname varchar(100);
			alter table ${db.schema.adapted}adm_user modify lastname varchar(100);
			
			alter table ${db.schema.adapted}account_entity modify firstname varchar(100);
			alter table ${db.schema.adapted}account_entity modify lastname varchar(100); </sql>
    </changeSet>


    <changeSet id="#4371_20190620_1" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="adm_file_format_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_format_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}adm_file_format_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4371_20190620_2" author="AbdellatifBARI">
        <createSequence sequenceName="adm_file_format_seq" startValue="1" />
        <createTable tableName="adm_file_format">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_format_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="file_name_pattern" type="varchar(255)" />
            <column name="file_type" type="varchar(255)" />
            <column name="configuration_template" type="text" />
            <column name="record_name" type="varchar(255)" />
            <column name="input_directory" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="output_directory" type="varchar(255)" />
            <column name="reject_directory" type="varchar(255)" />
            <column name="archive_directory" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari5xp8" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_format" />
    </changeSet>


    <changeSet id="#4371_20190620_3" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="flat_file_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="flat_file_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}flat_file_seq values(1)</sql>
    </changeSet>

	<changeSet id="#4371_20190620_4" author="AbdellatifBARI">
        <createSequence sequenceName="flat_file_seq" startValue="1" />
        <createTable tableName="flat_file">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="flat_file_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="file_name" type="varchar(255)" />
            <column name="status" type="varchar(255)" />
            <column name="file_format_id" type="bigint" />
            <column name="processed" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="error_message" type="text" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari6yr9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="flat_file" />
        <addForeignKeyConstraint baseColumnNames="file_format_id" baseTableName="flat_file" constraintName="fk_d4iavkklx1qg1ani36bari5o5i" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_format" />
    </changeSet>

    <!--<changeSet id="#3510_20190712_4" author="Mohammed_EL-AZZOUZI">

        <sql>INSERT INTO ${db.schema.adapted}cat_unit_of_measure(id, version, code, created, symbol, description)
                (SELECT nextval( 'cat_unit_of_measure_seq'), 0, FR.rating_unit_description, current_date, FR.rating_unit_description, FR.rating_unit_description||' MIG-R ' FROM (SELECT DISTINCT rating_unit_description
                    FROM ${db.schema.adapted}cat_charge_template CT where rating_unit_description is not null) FR);</sql>
        <sql>INSERT INTO ${db.schema.adapted}cat_unit_of_measure(id, version, code, created, symbol, description, multiplicator, parent_id)
                (SELECT nextval( 'cat_unit_of_measure_seq'), 0, FR.input_unit_description, current_date, FR.input_unit_description, FR.input_unit_description||' MIG-I ', FR.unit_multiplicator,
                         (select id from ${db.schema.adapted}cat_unit_of_measure UOM where UOM.code=FR.rating_unit_description AND UOM.description=UOM.code||' MIG-R ' )
                 FROM (SELECT DISTINCT input_unit_description, rating_unit_description, unit_multiplicator FROM ${db.schema.adapted}cat_charge_template CT where input_unit_description is not null and unit_multiplicator is not null) FR);</sql>
        <sql>UPDATE ${db.schema.adapted}cat_charge_template CT SET rating_unitofmeasure = (SELECT UOM.id FROM ${db.schema.adapted}cat_unit_of_measure UOM
                WHERE UOM.code=CT.rating_unit_description AND UOM.description=UOM.code||' MIG-R ' ) WHERE rating_unitofmeasure IS null AND rating_unit_description IS NOT null;</sql>
        <sql>UPDATE ${db.schema.adapted}cat_charge_template CT SET input_unitofmeasure = (SELECT UOM.id FROM ${db.schema.adapted}cat_unit_of_measure UOM
                WHERE UOM.code=CT.input_unit_description AND UOM.description=UOM.code||' MIG-I ' ) WHERE input_unitofmeasure IS null AND input_unit_description IS NOT null;</sql>
    </changeSet>-->
    <changeSet id="#4371_20190620_5" author="AbdellatifBARI" dbms="postgresql">
        <sql>CREATE INDEX flat_file_code_index ON ${db.schema.adapted} flat_file(lower(code))</sql>
    </changeSet>

    <changeSet id="#4160_20190105 - Accounting Writing" author="MounirBOUKAYOUA">
        <createTable tableName="ar_accounting_writing">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_ar_accounting_writing_seq" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="origin_writing_id" type="bigint" />
            <column name="tax_id" type="bigint" />
            <column name="invoice_category_id" type="bigint" />
            <column name="accounting_code_id" type="bigint" />
            <column name="event_date" type="date" />
            <column name="export_date" type="date" />
            <column name="amount" type="numeric(23, 12)" />
            <column name="event_type" type="varchar(255)" />
            <column name="extra_param_1" type="varchar(255)" />
            <column name="extra_param_2" type="varchar(255)" />
            <column name="extra_param_3" type="varchar(255)" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="origin_writing_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_origin_writing" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_accounting_writing" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_tax" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="invoice_category_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_invoice_category" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_cat" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="ar_accounting_writing"
                                 constraintName="fk_accounting_writing_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <createSequence sequenceName="ar_accounting_writing_seq"/>

        <createTable tableName="ar_accounting_writing_acc_operations">
            <column name="accounting_writing_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="accounting_writing_id, account_operation_id" constraintName="ar_accounting_writing_acc_operations_pkey" tableName="ar_accounting_writing_acc_operations" />
    </changeSet>
    <changeSet id="##4160_20190105 - Accounting Writing - MYSQL sequence" author="MounirBOUKAYOUA" dbms="mysql">
        <createTable tableName="ar_accounting_writing_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_accounting_writing_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}ar_accounting_writing_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4337_20190710" author="MohammedELAZZOUZI">
    	<addColumn tableName="ar_account_operation">
        	<column name="invoice_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="ar_account_operation" constraintName="fk_billing_invoice" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
    	<sql>
            UPDATE ${db.schema.adapted}ar_account_operation AO SET invoice_id=(SELECT id FROM ${db.schema.adapted}billing_invoice BI WHERE BI.invoice_number=AO.reference)
            WHERE AO.transaction_type='I'
        </sql>   
    </changeSet>

    <changeSet id="#4372_20190715" author="RedaDebbache">
    	<addColumn tableName="crm_custom_field_tmpl">
        	<column name="unique_constraint" type="${type.boolean}" defaultValue="0"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#4372_20190723" author="RedaDebbache">
    	<addColumn tableName="cust_cet">
        	<column name="unique_constraint_name" type="varchar(120)" defaultValue="0"></column>
        </addColumn>
    </changeSet>

    <changeSet id="#4458_20190626_1" author="AbdellatifBARI">
        <dropUniqueConstraint constraintName="uk_9fnf93rp352nkw2kpdbari5xp8" tableName="adm_file_format"/>
        <dropColumn tableName="adm_file_format">
            <column name="code"></column>
        </dropColumn>
        <dropColumn tableName="adm_file_format">
            <column name="file_type"></column>
        </dropColumn>

        <addColumn tableName="adm_file_format">
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
        </addColumn>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari4xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_format" />
    </changeSet>

    <changeSet id="#4458_20190626_2" author="AbdellatifBARI">
        <createTable tableName="adm_file_format_file_type">
            <column name="file_format_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="file_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="file_format_id, file_type_id" constraintName="adm_file_format_file_type_pkey" tableName="adm_file_format_file_type" />
        <addForeignKeyConstraint baseColumnNames="file_format_id" baseTableName="adm_file_format_file_type" constraintName="fk_4au8lqa3bc46gks4dmpbbari4h4l6" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_format" />
    </changeSet>

    <changeSet id="#4458_20190626_3" author="AbdellatifBARI" dbms="mysql">
        <createTable tableName="adm_file_type_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_type_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}adm_file_type_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4458_20190626_4" author="AbdellatifBARI">
        <createSequence sequenceName="adm_file_type_seq" startValue="1" />
        <createTable tableName="adm_file_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="adm_file_type_pkey" />
            </column>

            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_9fnf93rp352nkw2kpdbari5yr8" deferrable="false" disabled="false" initiallyDeferred="false" tableName="adm_file_type" />
        <addForeignKeyConstraint baseColumnNames="file_type_id" baseTableName="adm_file_format_file_type" constraintName="fk_s1wxui3m4sv9x5mbyi8gpbari77hu" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_file_type" />
        <sql>CREATE INDEX adm_file_type_code_index ON ${db.schema.adapted}adm_file_type(code)</sql>
    </changeSet>

    <changeSet id="#4468_20190631_1" author="AbdellatifBARI">
        <addColumn tableName="flat_file">
            <column name="lines_in_success" type="int4" />
            <column name="lines_in_warning" type="int4" />
            <column name="lines_in_error" type="int4" />
            <column name="processing_attempts" type="int4" />
            <column name="flat_file_job_code" type="varchar(255)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#4326_20190709" author="AndriusKarpavicius" failOnError="false"> 
        <dropForeignKeyConstraint baseTableName="billing_wallet_operation" constraintName="fk_wallet_operation_rated_transaction"/>
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_rated_transaction"/>
    </changeSet>

    <changeSet id="#4457_20190728" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}crm_custom_field_tmpl_val set listvalues='Rollback', listvalues_key='ROLLBACK' where listvalues_key='ROLLBBACK'</sql>    
    </changeSet> 

	<changeSet id="#4472_20190807" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_MediationJob'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_mcols where cft_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob'</sql>           
    </changeSet> 
    <changeSet id="#4392_20190625" author="AndriusKarpavicius" dbms="postgres">
        <sql>update ${db.schema.adapted}meveo_script_instance set reuse=0 where reuse is null</sql>
        <sql>update ${db.schema.adapted}meveo_script_instance set is_error=0 where is_error is null</sql>
        <sql>update ${db.schema.adapted}adm_notification set run_async=0 where run_async is null</sql>
        <addNotNullConstraint tableName="meveo_script_instance" columnName="reuse" columnDataType="${type.boolean}"/>
        <addNotNullConstraint tableName="meveo_script_instance" columnName="is_error" columnDataType="${type.boolean}"/>
        <addNotNullConstraint tableName="adm_notification" columnName="run_async" columnDataType="${type.boolean}"/>
    </changeSet>
    <!-- addNotNullConstraint generates SQL with the default numeric value missing, which blocks the insertions-->
    <changeSet id="#4392_20190625-UPDATED-20190827" author="MohamedSTITANE" dbms="mysql">
        <sql>update ${db.schema.adapted}meveo_script_instance set reuse=0 where reuse is null</sql>
        <sql>update ${db.schema.adapted}meveo_script_instance set is_error=0 where is_error is null</sql>
        <sql>update ${db.schema.adapted}adm_notification set run_async=0 where run_async is null</sql>
        <sql>ALTER TABLE ${db.schema.adapted}meveo_script_instance MODIFY `reuse` INT NOT NULL DEFAULT 0</sql>
        <sql>ALTER TABLE ${db.schema.adapted}meveo_script_instance MODIFY is_error INT NOT NULL DEFAULT 0</sql>
        <sql>ALTER TABLE ${db.schema.adapted}adm_notification MODIFY run_async INT NOT NULL DEFAULT 0;</sql>
    </changeSet>

    <changeSet id="#4326_20190811" author="AndriusKarpavicius"> 
    	<addColumn tableName="billing_invoice">
    		<column name="prepaid" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
    	</addColumn>
    </changeSet>
   

    <changeSet id="#4512_20190819" author="AbdellatifBARI">
        <dropColumn tableName="flat_file">
            <column name="file_name"></column>
        </dropColumn>

        <addColumn tableName="flat_file">
            <column name="file_original_name" type="varchar(255)" />
            <column name="file_current_name" type="varchar(255)" />
        </addColumn>
    </changeSet>
    
 	<changeSet id="#4480_250919" author="MohammedElAzzouzi">
		<sql>UPDATE ${db.schema.adapted}billing_invoice SET payment_method_id=null WHERE payment_method_id IS NOT NULL AND payment_method_id NOT IN (SELECT APT.id FROM ${db.schema.adapted}ar_payment_token APT)</sql>
    </changeSet>
    <changeSet id="#4480_210819" author="SaidRamli">
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_invoice"
                                 constraintName="fk_invoice_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />
    </changeSet>                          

    <changeSet id="#4538_20190829" author="AbdellatifBARI">
        <addColumn tableName="flat_file">
            <column name="current_directory" type="varchar(255)" />
        </addColumn>
    </changeSet>
    <changeSet id="#4550_20190904" author="AbdellatifBARI">
        <dropColumn tableName="billing_trading_country">
            <column name="pr_description"></column>
        </dropColumn>
        <addColumn tableName="billing_trading_country">
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" defaultValue="Trading_Country_US">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="#4313_17062019" author="mohamed.el.youssoufi">
		<addColumn tableName="wf_generic_workflow">
			<column name="cf_values_accum" type="${type.json}"></column>
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" />
		</addColumn>
	</changeSet>

	 <changeSet id="#3774_07102019" author="FranckValot">
		<addColumn tableName="adm_notification">
			<column name="save_successful_notif" type="${type.boolean}" defaultValueNumeric="1"></column>
		</addColumn>
	</changeSet>

	<changeSet id="#4064_11092019" author="AbdelmounaimAkadid">
		<addColumn tableName="billing_invoice">
			<column name="status" type="varchar(50)" />
		</addColumn>
	</changeSet>

   	<changeSet id="#4606_260919" author="AbdelmounaimAkadid"> 	
     	<addColumn tableName="billing_subscription">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
            
        <addColumn tableName="cat_offer_template">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="cat_offer_template" constraintName="fk_billing_cat_offer_template_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
      
        <addColumn tableName="billing_billing_account">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_billing_account" constraintName="fk_billing_billing_account_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
          
        <addColumn tableName="billing_service_instance">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="billing_service_instance" constraintName="fk_billing_service_instance_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
            
        <addColumn tableName="cat_service_template">
            <column name="minimum_invoice_sub_category_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="minimum_invoice_sub_category_id" baseTableName="cat_service_template" constraintName="fk_billing_cat_service_template_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
    </changeSet>
    
    <changeSet id="#4555_20190903" author="AndriusKarpavicius">
        <addColumn tableName="cat_charge_template">        
            <column name="charge_type" type="varchar(5)" />

            <column name="filter_expression" type="varchar(2000)" />
            <column name="filter_param_1" type="varchar(255)" />
            <column name="filter_param_2" type="varchar(255)" />
            <column name="filter_param_3" type="varchar(255)" />
            <column name="filter_param_4" type="varchar(255)" />
            <column name="filter_el_sp" type="varchar(2000)" />
            <column  name="priority" type="int4" defaultValueNumeric="1" />
            <column name="trigger_next_charge" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="trigger_next_charge_el" type="varchar(2000)" />

            <column name="apply_in_advance" type="${type.boolean}" />
            <column name="duration_term_in_month" type="int4" />
            <column name="recurrence_type" type="varchar(255)" />
            <column name="share_level" type="varchar(20)" />
            <column name="subscription_prorata" type="${type.boolean}" />
            <column name="termination_prorata" type="${type.boolean}" />
            <column name="calendar_id" type="bigint" />
            <column name="subscription_prorata_el" type="varchar(2000)" />
            <column name="termination_prorata_el" type="varchar(2000)" />
            <column name="apply_in_advance_el" type="varchar(2000)" />
            <column name="duration_term_in_month_el" type="varchar(2000)" />
            <column name="calendar_code_el" type="varchar(2000)" />             
        
            <column name="immediate_invoicing" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="type" type="varchar(255)" />
        </addColumn>
    
        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='U', filter_expression = cat_usage_charge_template.filter_expression, filter_param_1 = cat_usage_charge_template.filter_param_1,
            filter_param_2 = cat_usage_charge_template.filter_param_2, filter_param_3 = cat_usage_charge_template.filter_param_3, filter_param_4 = cat_usage_charge_template.filter_param_4,
            filter_el_sp = cat_usage_charge_template.filter_el_sp, priority = cat_usage_charge_template.priority, trigger_next_charge = cat_usage_charge_template.trigger_next_charge, trigger_next_charge_el =
            cat_usage_charge_template.trigger_next_charge_el
            from ${db.schema.adapted}cat_usage_charge_template where cat_charge_template.id=cat_usage_charge_template.id
        </sql>
    
        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='R', filter_expression = cat_recurring_charge_templ.filter_expression,
            apply_in_advance = cat_recurring_charge_templ.apply_in_advance, duration_term_in_month = cat_recurring_charge_templ.duration_term_in_month, recurrence_type = cat_recurring_charge_templ.recurrence_type, share_level = cat_recurring_charge_templ.share_level, 
            subscription_prorata = cat_recurring_charge_templ.subscription_prorata, termination_prorata = cat_recurring_charge_templ.termination_prorata, calendar_id = cat_recurring_charge_templ.calendar_id, subscription_prorata_el = cat_recurring_charge_templ.subscription_prorata_el, 
            termination_prorata_el = cat_recurring_charge_templ.termination_prorata_el, apply_in_advance_el = cat_recurring_charge_templ.apply_in_advance_el, duration_term_in_month_el = cat_recurring_charge_templ.duration_term_in_month_el, 
            calendar_code_el = cat_recurring_charge_templ.calendar_code_el
            from ${db.schema.adapted}cat_recurring_charge_templ where cat_charge_template.id=cat_recurring_charge_templ.id
        </sql>
        
        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='P', filter_expression = cat_product_charge_templ.filter_expression
            from ${db.schema.adapted}cat_product_charge_templ where cat_charge_template.id=cat_product_charge_templ.id
        </sql>
        
        <sql dbms="postgresql">update ${db.schema.adapted}cat_charge_template set charge_type='O', filter_expression = cat_one_shot_charge_templ.filter_expression,
            immediate_invoicing = cat_one_shot_charge_templ.immediate_invoicing, type = cat_one_shot_charge_templ.type
            from ${db.schema.adapted}cat_one_shot_charge_templ where cat_charge_template.id=cat_one_shot_charge_templ.id
        </sql>
        
        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_usage_charge_template on ct.id=cat_usage_charge_template.id set charge_type='U', filter_expression = cat_usage_charge_template.filter_expression, filter_param_1 = cat_usage_charge_template.filter_param_1,
            filter_param_2 = cat_usage_charge_template.filter_param_2, filter_param_3 = cat_usage_charge_template.filter_param_3, filter_param_4 = cat_usage_charge_template.filter_param_4,
            filter_el_sp = cat_usage_charge_template.filter_el_sp, priority = cat_usage_charge_template.priority, trigger_next_charge = cat_usage_charge_template.trigger_next_charge, trigger_next_charge_el =
            cat_usage_charge_template.trigger_next_charge_el
        </sql>        
        
        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_recurring_charge_templ on ct.id=cat_recurring_charge_templ.id set charge_type='R', filter_expression = cat_recurring_charge_templ.filter_expression,
            apply_in_advance = cat_recurring_charge_templ.apply_in_advance, duration_term_in_month = cat_recurring_charge_templ.duration_term_in_month, recurrence_type = cat_recurring_charge_templ.recurrence_type, share_level = cat_recurring_charge_templ.share_level, 
            subscription_prorata = cat_recurring_charge_templ.subscription_prorata, termination_prorata = cat_recurring_charge_templ.termination_prorata, calendar_id = cat_recurring_charge_templ.calendar_id, subscription_prorata_el = cat_recurring_charge_templ.subscription_prorata_el, 
            termination_prorata_el = cat_recurring_charge_templ.termination_prorata_el, apply_in_advance_el = cat_recurring_charge_templ.apply_in_advance_el, duration_term_in_month_el = cat_recurring_charge_templ.duration_term_in_month_el, 
            calendar_code_el = cat_recurring_charge_templ.calendar_code_el
        </sql>
        
        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_product_charge_templ on ct.id=cat_product_charge_templ.id set
            charge_type='P', filter_expression = cat_product_charge_templ.filter_expression
        </sql>        
        
        <sql dbms="mysql">
            update ${db.schema.adapted}cat_charge_template ct join ${db.schema.adapted}cat_one_shot_charge_templ on ct.id=cat_one_shot_charge_templ.id set
            charge_type='O', filter_expression = cat_one_shot_charge_templ.filter_expression,
            immediate_invoicing = cat_one_shot_charge_templ.immediate_invoicing, type = cat_one_shot_charge_templ.type
        </sql> 
        
        <dropForeignKeyConstraint baseTableName="cat_serv_usage_charge_template" constraintName="fk_443th9siwouj4fg746sgyfqtv"/>
        <dropForeignKeyConstraint baseTableName="cat_usage_charge_template" constraintName="fk_8x4c8il5glegqu0g1scpi469h"/>
        <dropForeignKeyConstraint baseTableName="cat_recurring_charge_templ" constraintName="fk_ailcl9mls5y7bjr9yur52767h" />
        <dropForeignKeyConstraint baseTableName="cat_serv_rec_charge_template" constraintName="fk_foohp8o0xupxmxcwblexcfqpp"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl"/>
        <dropForeignKeyConstraint baseTableName="cat_offer_template" constraintName="fk_cat_off_tpl_prod_chrg_tpl"/>
        <dropForeignKeyConstraint baseTableName="cat_product_templ_charge_templ" constraintName="fk_prd_templ_ct_pct_id"/>
        <dropForeignKeyConstraint baseTableName="cat_serv_sub_charge_template" constraintName="fk_3yhjbdockv9jvyw9iqmqlha63"/>
        <dropForeignKeyConstraint baseTableName="cat_serv_trm_charge_template" constraintName="fk_5ehn1daxca6x6t7pvdpuo4n6m"/>
        
    </changeSet>         
        
    <changeSet id="#4555_20190903-M" author="AndriusKarpavicius" dbms="mysql">
    
        <dropIndex tableName="cat_serv_usage_charge_template" indexName="fk_443th9siwouj4fg746sgyfqtv"/>
        <dropIndex tableName="cat_usage_charge_template" indexName="fk_8x4c8il5glegqu0g1scpi469h"/>
        <dropIndex tableName="cat_recurring_charge_templ" indexName="fk_ailcl9mls5y7bjr9yur52767h" />
        <dropIndex tableName="cat_serv_rec_charge_template" indexName="fk_foohp8o0xupxmxcwblexcfqpp"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodchrgtempl"/>
        <dropIndex tableName="cat_offer_template" indexName="fk_cat_off_tpl_prod_chrg_tpl"/>
        <dropIndex tableName="cat_product_templ_charge_templ" indexName="fk_prd_templ_ct_pct_id"/>
        <dropIndex tableName="cat_serv_sub_charge_template" indexName="fk_3yhjbdockv9jvyw9iqmqlha63"/>
        <dropIndex tableName="cat_serv_trm_charge_template" indexName="fk_5ehn1daxca6x6t7pvdpuo4n6m"/>
       
    </changeSet>
    
    <changeSet id="#4555_20190903-end" author="AndriusKarpavicius">        
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_usage_charge_template" constraintName="fk_443th9siwouj4fg746sgyfqtv" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="calendar_id" baseTableName="cat_charge_template" constraintName="fk_ailcl9mls5y7bjr9yur52767h" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_rec_charge_template" constraintName="fk_foohp8o0xupxmxcwblexcfqpp" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />            
        <addForeignKeyConstraint baseColumnNames="recurring_chrg_tmpl_id" baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />        
        <addForeignKeyConstraint baseColumnNames="product_chrg_tmpl_id" baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />            
        <addForeignKeyConstraint baseColumnNames="product_charge_tmpl_id" baseTableName="cat_offer_template" constraintName="fk_cat_off_tpl_prod_chrg_tpl" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="product_charge_template_id" baseTableName="cat_product_templ_charge_templ" constraintName="fk_prd_templ_ct_pct_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_sub_charge_template" constraintName="fk_3yhjbdockv9jvyw9iqmqlha63" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_serv_trm_charge_template" constraintName="fk_5ehn1daxca6x6t7pvdpuo4n6m" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
                        
        <dropTable tableName="cat_usage_charge_template"/>
        <dropTable tableName="cat_recurring_charge_templ"/>
        <dropTable tableName="cat_product_charge_templ"/>
        <dropTable tableName="cat_one_shot_charge_templ"/>
        
    </changeSet> 
    
    <changeSet id="#4555_20190905" author="AndriusKarpavicius"> 
    
        <addColumn tableName="billing_charge_instance">        
            <column name="charge_type" type="varchar(5)" />    
    
            <column name="quantity" type="numeric(23, 12)"/>
            <column name="product_instance_id" type="bigint" />
            <column name="next_charge_date" type="datetime" />
            <column name="subscription_date" type="datetime" />
            <column name="service_instance_id" type="bigint" />
            <column name="counter_id" type="bigint" />
            <column name="rating_unit_description" type="varchar(20)" />
            <column name="priority" type="int4" defaultValueNumeric="1"/>
        </addColumn>
        
        <dropColumn tableName="billing_charge_instance" columnName="pr_description"/>
                
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='S', service_instance_id = billing_one_shot_charge_inst.subs_serv_inst_id,
            quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.subs_serv_inst_id is not null
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='T', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id,
            quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.term_serv_inst_id is not null
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='O', quantity = billing_one_shot_charge_inst.quantity
            from ${db.schema.adapted}billing_one_shot_charge_inst where billing_charge_instance.id=billing_one_shot_charge_inst.id and billing_one_shot_charge_inst.subs_serv_inst_id is null and billing_one_shot_charge_inst.term_serv_inst_id is null
        </sql>        
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='P', product_instance_id = billing_product_charge_inst.product_instance_id,
            quantity = billing_product_charge_inst.quantity, charge_template_id = billing_product_charge_inst.product_chrg_tmpl_id
            from ${db.schema.adapted}billing_product_charge_inst where billing_charge_instance.id=billing_product_charge_inst.id
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='R',  
            next_charge_date = billing_recurring_charge_inst.next_charge_date, subscription_date = billing_recurring_charge_inst.subscription_date, charge_template_id = billing_recurring_charge_inst.recurring_chrg_tmpl_id, 
            service_instance_id = billing_recurring_charge_inst.service_instance_id, quantity = billing_recurring_charge_inst.quantity, counter_id = billing_recurring_charge_inst.counter_id
            from ${db.schema.adapted}billing_recurring_charge_inst where billing_charge_instance.id=billing_recurring_charge_inst.id
        </sql>
        <sql dbms="postgresql">update ${db.schema.adapted}billing_charge_instance set charge_type='U',
            counter_id = billing_usage_charge_inst.counter_id, service_instance_id = billing_usage_charge_inst.service_instance_id,
            rating_unit_description = billing_usage_charge_inst.rating_unit_description, priority = billing_usage_charge_inst.priority 
            from ${db.schema.adapted}billing_usage_charge_inst where billing_charge_instance.id=billing_usage_charge_inst.id
        </sql> 
                
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='S', service_instance_id = billing_one_shot_charge_inst.subs_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.subs_serv_inst_id is not null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='T', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.term_serv_inst_id is not null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_one_shot_charge_inst on ci.id=billing_one_shot_charge_inst.id set
            charge_type='O', service_instance_id = billing_one_shot_charge_inst.term_serv_inst_id, quantity = billing_one_shot_charge_inst.quantity where billing_one_shot_charge_inst.term_serv_inst_id is null and  billing_one_shot_charge_inst.subs_serv_inst_id is null
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_product_charge_inst on ci.id=billing_product_charge_inst.id set
            charge_type='P', product_instance_id = billing_product_charge_inst.product_instance_id,
            quantity = billing_product_charge_inst.quantity, charge_template_id = billing_product_charge_inst.product_chrg_tmpl_id
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_recurring_charge_inst on ci.id=billing_recurring_charge_inst.id set
            charge_type='R', next_charge_date = billing_recurring_charge_inst.next_charge_date, subscription_date = billing_recurring_charge_inst.subscription_date, charge_template_id = billing_recurring_charge_inst.recurring_chrg_tmpl_id, 
            service_instance_id = billing_recurring_charge_inst.service_instance_id, quantity = billing_recurring_charge_inst.quantity, counter_id = billing_recurring_charge_inst.counter_id
        </sql>
        <sql dbms="mysql">
            update ${db.schema.adapted}billing_charge_instance ci join ${db.schema.adapted}billing_usage_charge_inst on ci.id=billing_usage_charge_inst.id set
            charge_type='U', counter_id = billing_usage_charge_inst.counter_id, service_instance_id = billing_usage_charge_inst.service_instance_id,
            rating_unit_description = billing_usage_charge_inst.rating_unit_description, priority = billing_usage_charge_inst.priority 
        </sql>    
        
        
        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_5q5wxh2nq7gbd9bcds59egh3e"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_c1v9rho8f7dl45kbmexjh0fkf"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_c9rnk3vjujvmqe8j13yxoq70g"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_eht7f5na7vthrcu8pdbhwn4hi"/>
        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_j1o935sww9tme69o1t5yqgce6"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_jsatpdoxjhluj5mbgg19c8vpa"/>
        <dropForeignKeyConstraint baseTableName="billing_usage_charge_inst" constraintName="fk_n5h6xvrtm2a2av5jik9vr0cp5"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_serv_rec_charge_template_billing_counter"/>
        <dropForeignKeyConstraint baseTableName="billing_recurring_charge_inst" constraintName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropForeignKeyConstraint baseTableName="billing_one_shot_charge_inst" constraintName="fk_ofm7i3gubvpf3qu8hh03kkpxo"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodins"/>
        <dropForeignKeyConstraint baseTableName="billing_product_charge_inst" constraintName="fk_productci_prodchrgtempl"/>        
        
        <dropIndex tableName="billing_recurring_charge_inst" indexName="billing_recurring_charge_inst_index"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="billing_one_shot_charge_inst_subs_serv_inst_id"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="term_serv_inst_id_index"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="billing_usage_charge_inst_index"/>        
        
    </changeSet>
    
    
    <changeSet id="#4555_20190905-M" author="AndriusKarpavicius" dbms="mysql">
    
        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_5q5wxh2nq7gbd9bcds59egh3e"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_c1v9rho8f7dl45kbmexjh0fkf"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_c9rnk3vjujvmqe8j13yxoq70g"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_eht7f5na7vthrcu8pdbhwn4hi"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_j1o935sww9tme69o1t5yqgce6"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_jsatpdoxjhluj5mbgg19c8vpa"/>
        <dropIndex tableName="billing_usage_charge_inst" indexName="fk_n5h6xvrtm2a2av5jik9vr0cp5"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_serv_rec_charge_template_billing_counter"/>
        <dropIndex tableName="billing_recurring_charge_inst" indexName="fk_nsieq8n0po08c1fflr5l0xwxl"/>
        <dropIndex tableName="billing_one_shot_charge_inst" indexName="fk_ofm7i3gubvpf3qu8hh03kkpxo"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodins"/>
        <dropIndex tableName="billing_product_charge_inst" indexName="fk_productci_prodchrgtempl"/>        
        
    </changeSet>
    
    <changeSet id="#4555_20190905-end" author="AndriusKarpavicius">        
    
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_charge_instance" constraintName="fk_5q5wxh2nq7gbd9bcds59egh3e" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="counter_id" baseTableName="billing_charge_instance" constraintName="fk_n5h6xvrtm2a2av5jik9vr0cp5" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_counter" />
        <addForeignKeyConstraint baseColumnNames="product_instance_id" baseTableName="billing_charge_instance" constraintName="fk_productci_prodins" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_product_instance" />
        
        <sql>CREATE INDEX billing_charge_serv_inst_index ON ${db.schema.adapted}billing_charge_instance(service_instance_id)</sql>
        
        <dropTable tableName="billing_one_shot_charge_inst"/>
        <dropTable tableName="billing_product_charge_inst"/>
        <dropTable tableName="billing_recurring_charge_inst"/>
        <dropTable tableName="billing_usage_charge_inst"/>    
    
    </changeSet>    
    
    <changeSet id="#4511_20190919-M" author="AndriusKarpavicius" dbms="mysql"> 
    
        <dropColumn tableName="billing_wallet_operation" columnName="created"/>
        <dropColumn tableName="billing_wallet_operation" columnName="creator"/>
        <dropColumn tableName="billing_wallet_operation" columnName="updater"/>
        <dropColumn tableName="billing_wallet_operation" columnName="aggregate_serv_id"/>
    
        <dropColumn tableName="billing_rated_transaction" columnName="aggregate_id_r"/>
        <dropColumn tableName="billing_rated_transaction" columnName="aggregate_id_t"/>
        
        <addColumn tableName="billing_rated_transaction">
            <column name="updated" type="datetime" />
        </addColumn>
    
        <dropIndex tableName="billing_rated_transaction" indexName="rt_ba_invoice_open_serv_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_ba_invoice_open_sub_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_sub_invoice_open_serv_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_invoice_index"/>
        <dropIndex tableName="billing_rated_transaction" indexName="rt_order_index"/>
        
        <sql>CREATE INDEX rating_edr_sub_id_index ON ${db.schema.adapted}rating_edr (subscription_id, id)</sql>
                
        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction (billing_account__id, service_instance_id)</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON ${db.schema.adapted}billing_rated_transaction (billing_account__id, subscription_id)</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction (subscription_id, service_instance_id)</sql>
        <sql>CREATE INDEX rt_invoice_index ON ${db.schema.adapted}billing_rated_transaction (invoice_id)</sql>
        <sql>CREATE INDEX rt_order_index ON ${db.schema.adapted}billing_rated_transaction (order_number, status)</sql>
    </changeSet>
        
    <changeSet id="#4511_20190919-P" author="AndriusKarpavicius" dbms="postgresql"> 
        
        <sql>alter table ${db.schema.adapted}rating_edr alter column id drop default</sql>
        <sql>alter table ${db.schema.adapted}billing_wallet_operation alter column id drop default</sql>
        <sql>alter table ${db.schema.adapted}billing_rated_transaction alter column id drop default</sql>
        
        <sql>alter table ${db.schema.adapted}rating_edr rename to rating_edr_tmp</sql>
        <sql>alter table ${db.schema.adapted}billing_wallet_operation rename to billing_wallet_operation_tmp</sql>
        <sql>alter table ${db.schema.adapted}billing_rated_transaction rename to billing_rated_transaction_tmp</sql>    
    
        <sql>
            CREATE TABLE ${db.schema.adapted}rating_edr (
              id bigint NOT NULL DEFAULT nextval('rating_edr_seq'),
              version integer,
              created timestamp without time zone,
              event_date timestamp without time zone,
              last_updated timestamp without time zone,
              origin_batch character varying(255),
              origin_record character varying(255),
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              parameter_4 character varying(255),
              quantity numeric(23,12),
              reject_reason text,
              status character varying(255),
              subscription_id bigint NOT NULL,
              parameter_5 character varying(255),
              parameter_6 character varying(255),
              parameter_7 character varying(255),
              parameter_8 character varying(255),
              parameter_9 character varying(255),
              date_parameter_1 timestamp without time zone,
              date_parameter_2 timestamp without time zone,
              date_parameter_3 timestamp without time zone,
              date_parameter_4 timestamp without time zone,
              date_parameter_5 timestamp without time zone,
              decimal_parameter_1 numeric(23,12),
              decimal_parameter_2 numeric(23,12),
              decimal_parameter_3 numeric(23,12),
              decimal_parameter_4 numeric(23,12),
              decimal_parameter_5 numeric(23,12),
              access_code character varying(255),
              header_edr_id bigint,
              extra_parameter text,
              CONSTRAINT rating_edr_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>
    
        <sql>
            CREATE TABLE ${db.schema.adapted}billing_wallet_operation (
              id bigint NOT NULL DEFAULT nextval('billing_wallet_operation_seq'),
              operation_type character varying(31) NOT NULL,
              version integer,
              created timestamp without time zone,
              updated timestamp without time zone,
              code character varying(255) NOT NULL,
              description character varying(255),
              amount_tax numeric(23,12),
              amount_with_tax numeric(23,12),
              amount_without_tax numeric(23,12),
              end_date timestamp without time zone,
              offer_code character varying(255),
              operation_date timestamp without time zone,
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              quantity numeric(23,12),
              start_date timestamp without time zone,
              status character varying(255),
              subscription_date timestamp without time zone,
              tax_percent numeric(23,12) NOT NULL,
              credit_debit_flag character varying(255),
              unit_amount_tax numeric(23,12),
              unit_amount_with_tax numeric(23,12),
              unit_amount_without_tax numeric(23,12),
              charge_instance_id bigint NOT NULL,
              counter_id bigint,
              currency_id bigint,
              priceplan_id bigint,
              reratedwalletoperation_id bigint,
              seller_id bigint NOT NULL,
              wallet_id bigint,
              reservation_id bigint,
              invoicing_date timestamp without time zone,
              input_quantity numeric(23,12),
              input_unit_description character varying(20),
              rating_unit_description character varying(20),
              edr_id bigint,
              order_number character varying(100),
              parameter_extra text,
              raw_amount_without_tax numeric(23,12),
              raw_amount_with_tax numeric(23,12),
              invoice_sub_category_id bigint,
              subscription_id bigint,
              tax_id bigint NOT NULL,
              rated_transaction_id bigint,
              service_instance_id bigint,
              offer_id bigint,
              CONSTRAINT billing_wallet_operation_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>       
        
        <sql>
            CREATE TABLE ${db.schema.adapted}billing_rated_transaction (
              id bigint NOT NULL DEFAULT nextval('billing_rated_transaction_seq'),
              version integer,
              amount_tax numeric(23,12),
              amount_with_tax numeric(23,12),
              amount_without_tax numeric(23,12),
              code character varying(255),
              description text,
              do_not_trigger_invoicing integer NOT NULL DEFAULT 0,
              parameter_1 character varying(255),
              parameter_2 character varying(255),
              parameter_3 character varying(255),
              quantity numeric(23,12),
              status character varying(255),
              unit_amount_tax numeric(23,12),
              unit_amount_with_tax numeric(23,12),
              unit_amount_without_tax numeric(23,12),
              unity_description character varying(20),
              usage_date timestamp without time zone,
              billing_account__id bigint,
              billing_run_id bigint,
              invoice_id bigint,
              aggregate_id_f bigint,
              invoice_sub_category_id bigint,
              priceplan_id bigint,
              wallet_id bigint,
              edr_id bigint,
              adjusted_rated_tx bigint,
              order_number character varying(100),
              rating_unit_description character varying(20),
              parameter_extra text,
              start_date timestamp without time zone,
              end_date timestamp without time zone,
              subscription_id bigint,
              seller_id bigint NOT NULL,
              charge_instance_id bigint,
              tax_id bigint NOT NULL,
              tax_percent numeric(23,12) NOT NULL,
              user_account_id bigint,
              offer_id bigint,
              service_instance_id bigint,
              updated timestamp without time zone,              
              CONSTRAINT billing_rated_transaction_p_pkey PRIMARY KEY (id, status)
            ) partition by list (status)
        </sql>
        
        <sql>create table ${db.schema.adapted}rating_edr_open partition of ${db.schema.adapted}rating_edr for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}rating_edr_other partition of ${db.schema.adapted}rating_edr default</sql>

        <sql>create table ${db.schema.adapted}billing_wallet_operation_open partition of ${db.schema.adapted}billing_wallet_operation for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}billing_wallet_operation_other partition of ${db.schema.adapted}billing_wallet_operation default</sql>

        <sql>create table ${db.schema.adapted}billing_rated_transaction_open  partition of ${db.schema.adapted}billing_rated_transaction for values in('OPEN')</sql>
        <sql>create table ${db.schema.adapted}billing_rated_transaction_other partition of ${db.schema.adapted}billing_rated_transaction default</sql>

        <sql>insert into ${db.schema.adapted}rating_edr (id,version,created,event_date,last_updated,origin_batch,origin_record,parameter_1,parameter_2,parameter_3,parameter_4,quantity,reject_reason,status,subscription_id,parameter_5,parameter_6,parameter_7,parameter_8,parameter_9,date_parameter_1,date_parameter_2,date_parameter_3,date_parameter_4,date_parameter_5,decimal_parameter_1,decimal_parameter_2,decimal_parameter_3,decimal_parameter_4,decimal_parameter_5,access_code,header_edr_id,extra_parameter) 
                (select id,version,created,event_date,last_updated,origin_batch,origin_record,parameter_1,parameter_2,parameter_3,parameter_4,quantity,reject_reason,status,subscription_id,parameter_5,parameter_6,parameter_7,parameter_8,parameter_9,date_parameter_1,date_parameter_2,date_parameter_3,date_parameter_4,date_parameter_5,decimal_parameter_1,decimal_parameter_2,decimal_parameter_3,decimal_parameter_4,decimal_parameter_5,access_code,header_edr_id,extra_parameter from ${db.schema.adapted}rating_edr_tmp) </sql>       
        <sql>insert into ${db.schema.adapted}billing_wallet_operation (id,operation_type,version,created,updated,code,description,amount_tax,amount_with_tax,amount_without_tax,end_date,offer_code,operation_date,parameter_1,parameter_2,parameter_3,quantity,start_date,status,subscription_date,tax_percent,credit_debit_flag,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,charge_instance_id,counter_id,currency_id,priceplan_id,reratedwalletoperation_id,seller_id,wallet_id,reservation_id,invoicing_date,input_quantity,input_unit_description,rating_unit_description,edr_id,order_number,parameter_extra,raw_amount_without_tax,raw_amount_with_tax,invoice_sub_category_id,subscription_id,tax_id,rated_transaction_id,service_instance_id,offer_id)
                (select id,operation_type,version,created,updated,code,description,amount_tax,amount_with_tax,amount_without_tax,end_date,offer_code,operation_date,parameter_1,parameter_2,parameter_3,quantity,start_date,status,subscription_date,tax_percent,credit_debit_flag,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,charge_instance_id,counter_id,currency_id,priceplan_id,reratedwalletoperation_id,seller_id,wallet_id,reservation_id,invoicing_date,input_quantity,input_unit_description,rating_unit_description,edr_id,order_number,parameter_extra,raw_amount_without_tax,raw_amount_with_tax,invoice_sub_category_id,subscription_id,tax_id,rated_transaction_id,service_instance_id,offer_id from ${db.schema.adapted}billing_wallet_operation_tmp)</sql>
        <sql>insert into ${db.schema.adapted}billing_rated_transaction (id,version,amount_tax,amount_with_tax,amount_without_tax,code,description,do_not_trigger_invoicing,parameter_1,parameter_2,parameter_3,quantity,status,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,unity_description,usage_date,billing_account__id,billing_run_id,invoice_id,aggregate_id_f,invoice_sub_category_id,priceplan_id,wallet_id,edr_id,adjusted_rated_tx,order_number,rating_unit_description,parameter_extra,start_date,end_date,subscription_id,seller_id,charge_instance_id,tax_id,tax_percent,user_account_id,offer_id,service_instance_id, updated) 
                (select id,version,amount_tax,amount_with_tax,amount_without_tax,code,description,do_not_trigger_invoicing,parameter_1,parameter_2,parameter_3,quantity,status,unit_amount_tax,unit_amount_with_tax,unit_amount_without_tax,unity_description,usage_date,billing_account__id,billing_run_id,invoice_id,aggregate_id_f,invoice_sub_category_id,priceplan_id,wallet_id,edr_id,adjusted_rated_tx,order_number,rating_unit_description,parameter_extra,start_date,end_date,subscription_id,seller_id,charge_instance_id,tax_id,tax_percent,user_account_id,offer_id,service_instance_id, now() from ${db.schema.adapted}billing_rated_transaction_tmp)</sql>
    
    </changeSet>
    
    <changeSet id="#4511_20190919-P-end" author="AndriusKarpavicius" dbms="postgresql">       
        

        <sql>ALTER SEQUENCE ${db.schema.adapted}rating_edr_seq OWNED BY ${db.schema.adapted}rating_edr.id</sql>
        <sql>ALTER SEQUENCE ${db.schema.adapted}billing_wallet_operation_seq OWNED BY ${db.schema.adapted}billing_wallet_operation.id</sql>
        <sql>ALTER SEQUENCE ${db.schema.adapted}billing_rated_transaction_seq OWNED BY ${db.schema.adapted}billing_rated_transaction.id</sql>

        <dropForeignKeyConstraint baseTableName="billing_reservation" constraintName="fk_reservation_edr"/>
<!--         <addForeignKeyConstraint baseColumnNames="origin_edr_id" baseTableName="billing_reservation" constraintName="fk_reservation_edr" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" -->
<!--             onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="rating_edr" /> -->

        <dropTable tableName="billing_wallet_operation_tmp"/>
        <dropTable tableName="billing_rated_transaction_tmp"/>
        <dropTable tableName="rating_edr_tmp"/>
        
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="rating_edr" constraintName="fk_f5tulmo519cm4il45bhborgq1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
<!--         <addForeignKeyConstraint baseColumnNames="header_edr_id" baseTableName="rating_edr" constraintName="fk_headeredrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" />               -->
            
        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_batch, origin_record)</sql>                  
<!--         <sql>CREATE INDEX rating_edr_status_index ON ${db.schema.adapted}rating_edr(status)</sql> -->
        <sql>CREATE INDEX rating_edr_sub_id_index ON ${db.schema.adapted}rating_edr_open (subscription_id, id)</sql>
               
        
        <addForeignKeyConstraint baseColumnNames="reservation_id" baseTableName="billing_wallet_operation" constraintName="fk_32r2ed0015tnd2pp5196vcqpy" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_reservation" />
        <addForeignKeyConstraint baseColumnNames="wallet_id" baseTableName="billing_wallet_operation" constraintName="fk_5htics7k9v44an8ap11wivraf" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet" />
        <addForeignKeyConstraint baseColumnNames="counter_id" baseTableName="billing_wallet_operation" constraintName="fk_60qrdadyj5wvmyii1einfb2lo" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_counter" />
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_75hyldnus6ti0y40vwcl49ued" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_billing_invoice_sub_cat" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />       
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="priceplan_id" baseTableName="billing_wallet_operation" constraintName="fk_f0v21kf4sbdcq1wwqsxmb5tsk" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="billing_wallet_operation" constraintName="fk_hg1a5impet68w8a37dehlnib0" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />            
<!--         <addForeignKeyConstraint baseColumnNames="reratedwalletoperation_id" baseTableName="billing_wallet_operation" constraintName="fk_j3ntuqkj79m0fgdwa3anib1nk" deferrable="false" initiallyDeferred="false" -->
<!--             onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet_operation" /> -->
        <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_wallet_operation" constraintName="fk_rt_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
        <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="billing_wallet_operation" constraintName="fk_t98kqb1prnfw6scvudimx1u0q" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />
        <addForeignKeyConstraint constraintName="fk_wallet_operation_service_instance" baseColumnNames="service_instance_id" baseTableName="billing_wallet_operation"
            referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_tax" />
<!--         <addForeignKeyConstraint baseColumnNames="edr_id" baseTableName="billing_wallet_operation" constraintName="fk_wopedrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" /> -->
            
        <sql>CREATE INDEX billing_wallet_operation_index ON ${db.schema.adapted}billing_wallet_operation(wallet_id, charge_instance_id)</sql>            
<!--         <sql>CREATE INDEX billing_wallet_operation_status_index ON ${db.schema.adapted}billing_wallet_operation(status)</sql> -->
                
        <addForeignKeyConstraint baseColumnNames="wallet_id" baseTableName="billing_rated_transaction" constraintName="fk_anslvrbm465ossqx8surjyu22" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_wallet" />
        <addForeignKeyConstraint baseColumnNames="billing_account__id" baseTableName="billing_rated_transaction" constraintName="fk_bbnhg8vn7jkttghphr65iwug5" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_crm_seller" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_offer_template" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="priceplan_id" baseTableName="billing_rated_transaction" constraintName="fk_eucl7of9ovyut1c4r2jkf01u6" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_rated_transaction" constraintName="fk_gq86s178gc3orumcl8symk4nn" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
        <addForeignKeyConstraint baseColumnNames="billing_run_id" baseTableName="billing_rated_transaction" constraintName="fk_o2mp1mqcyi2l7q2b1p88h20dw" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_run" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_rated_transaction" constraintName="fk_o5yu3c0bnac626w755w5f0voc" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="aggregate_id_f" baseTableName="billing_rated_transaction" constraintName="fk_rjpm9k6xsumg297fxefffyryh" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_agregate" />
<!--         <addForeignKeyConstraint baseColumnNames="edr_id" baseTableName="billing_rated_transaction" constraintName="fk_ropedrid" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" -->
<!--             referencedColumnNames="id" referencedTableName="rating_edr" /> -->
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_service_instance" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_tax" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="account_entity" />        
        
        <sql>CREATE INDEX rt_ba_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction_open (billing_account__id, service_instance_id) where service_instance_id is not null</sql>
        <sql>CREATE INDEX rt_ba_invoice_open_sub_index ON ${db.schema.adapted}billing_rated_transaction_open (billing_account__id, subscription_id)</sql>
        <sql>CREATE INDEX rt_sub_invoice_open_serv_index ON ${db.schema.adapted}billing_rated_transaction_open (subscription_id, service_instance_id) where subscription_id is not null</sql>
        <sql>CREATE INDEX rt_invoice_index ON ${db.schema.adapted}billing_rated_transaction_other (invoice_id)</sql>
        <sql>CREATE INDEX rt_order_index ON ${db.schema.adapted}billing_rated_transaction (order_number) where order_number is not null</sql>
        
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}create_partitions</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}detach_partitions</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}drop_all_table_indexes</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}rename_all_table_pks</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}create_all_table_indexes</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_rated_transaction_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_rated_transaction_to_partition</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_wallet_operation_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_billing_wallet_operation_to_partition</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_rating_edr_to_partition(text,text,text,date,date)</sql>
        <sql>DROP FUNCTION IF EXISTS ${db.schema.adapted}switch_rating_edr_to_partition</sql>       
        
    </changeSet>


    <changeSet id="#4490_31102019" author="AbdelmounaimAkadid">
		<addColumn tableName="billing_charge_instance">
			<column name="cf_values_accum" type="${type.json}"></column>
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" />
		</addColumn>
	</changeSet>

    <changeSet author="abdelkader.bouazza" id="#4523-Changing-amount-for-a-service-instance-with-prorating">
        <addColumn tableName="cat_charge_template">
            <column name="prorata_on_price_change" type="${type.boolean}" defaultValueNumeric="0"></column>
        </addColumn>
        <addColumn tableName="cat_price_plan_matrix">
            <column name="validity_from" type="datetime"></column>
            <column name="validity_date" type="datetime"></column>
        </addColumn>
    </changeSet>

        <changeSet id="#3510_20190516" author="MounirBahije">
        <createTable tableName="cat_unit_of_measure">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_unit_of_measure_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
<!--            <column name="multiplicator" type="bigint" />-->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="symbol" type="varchar(100)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(100)">
                <constraints nullable="true" />
            </column>
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="multiplicator" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="parent_id" type="bigint" />
        </createTable>

        <addColumn tableName="cat_charge_template">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
            <column name="input_unit_el" type="varchar(2000)"/>
            <column name="output_unit_el" type="varchar(2000)"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="cat_charge_template" constraintName="fk_input_cat_charge_template_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="cat_charge_template" constraintName="fk_rating_cat_charge_template_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addColumn tableName="billing_wallet_operation">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="billing_wallet_operation" constraintName="fk_input_billing_wallet_operation_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />

        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="billing_wallet_operation" constraintName="fk_rating_billing_wallet_operation_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />


        <addNotNullConstraint columnDataType="bigint" tableName="cat_unit_of_measure" columnName="multiplicator"/>
        <addDefaultValue tableName="cat_unit_of_measure" columnName="multiplicator" defaultValueNumeric="1"/>

    </changeSet>

    <changeSet id="#4766_20191111" author="MohammedELAZZOUZI">
    	<addNotNullConstraint tableName="adm_currency" columnName="currency_code" columnDataType="varchar(3)"/>
    	<addNotNullConstraint tableName="adm_currency" columnName="description_en" columnDataType="varchar(255)"/>
    	<addNotNullConstraint tableName="adm_language" columnName="description_en" columnDataType="varchar(255)"/>
    	<addNotNullConstraint tableName="adm_language" columnName="language_code" columnDataType="varchar(3)"/>
        <addUniqueConstraint columnNames="language_code" constraintName="UniqueConstraint_adm__language_code" tableName="adm_language" />
        <addUniqueConstraint columnNames="description_en" constraintName="UniqueConstraint_adm_language__description_en" tableName="adm_language" />
        <addUniqueConstraint columnNames="description_en" constraintName="UniqueConstraint_adm_currency__description_en" tableName="adm_currency" />
    </changeSet>
    
    <changeSet id="#4765_20191112" author="MohammedELAZZOUZI">
    	<update tableName="billing_cycle">
	        <column name="billing_cycle_type" value="BILLINGACCOUNT"/>
	        <where>billing_cycle_type is null</where>
    	</update>
        <addNotNullConstraint columnName="billing_cycle_type" tableName="billing_cycle" columnDataType="varchar(256)"/>
    </changeSet>

    <changeSet id="#4783_20191118" author="MohamedSTITANE" dbms="postgresql">
        <sql>CREATE INDEX wo_operation_date_index ON ${db.schema.adapted}billing_wallet_operation ((operation_date::DATE))</sql>
        <sql>CREATE INDEX edr_event_date_index ON ${db.schema.adapted}rating_edr ((event_date::DATE))</sql>
        <sql>CREATE INDEX rt_usage_date_index ON ${db.schema.adapted}billing_rated_transaction ((usage_date::DATE))</sql>
    </changeSet>

    <changeSet id="#4412_20191125" author="MohammedELAZZOUZI">
    	<dropColumn tableName="billing_invoice_configuration" columnName="display_charges_periods"></dropColumn>
    	<addColumn tableName="billing_invoice_configuration">
    		<column name="display_wallet_operations" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>

    <changeSet id="#4795_221119" author="Mohammed_ElAzzouzi">
        <sql>create index billing_invoice_agregate_tax_invoice_agregate_idx on ${db.schema.adapted}billing_invoice_agregate (tax_invoice_agregate)</sql>
        <sql>create index billing_invoice_agregate_sub_cat_invoice_agregate_id_idx on ${db.schema.adapted}billing_invoice_agregate (sub_cat_invoice_agregate_id)</sql>
        <sql>create index ar_account_operation_cat_inv_agregate_id_idx on ${db.schema.adapted}ar_account_operation (cat_inv_agregate_id)</sql>
        <sql>create index ar_account_operation_sub_cat_inv_agregate_id_idx on ${db.schema.adapted}ar_account_operation (sub_cat_inv_agregate_id)</sql>
    </changeSet>

    <changeSet author="abdelkader.bouazza" id="#4494-Enable_a_subscription_to_have_the_same_access_point_in_two_or_more_different_periods_of_time">
        <dropUniqueConstraint tableName="medina_access" constraintName="uk_lca62y5gn9qo1e6jr84i9w3lr"/>
        <addUniqueConstraint columnNames="acces_user_id, subscription_id, start_date, end_date" constraintName="uk_lca62y5gn9qo1e6jr84i9w3lr" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="medina_access"/>
    </changeSet>
    <changeSet id="#4712_20191223" author="khalidHORRI">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="custom_table_code_el" type="varchar(2000)"/>
            <column name="data_filter_el" type="varchar(2000)"/>
            <column name="fields_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4791_20200113" author="KhalidHORRI">

        <addColumn tableName="cat_counter_template">
            <column name="is_accumulator" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="cat_serv_trm_charge_template">
            <column name="counter_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_serv_trm_charge_template" constraintName="fk_serv_trm_charge_template_counter_template"
                                 deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template"/>
        <addColumn tableName="cat_serv_sub_charge_template">
            <column name="counter_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_serv_sub_charge_template" constraintName="fk_serv_sub_charge_template_counter_template"
                                 deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template"/>
        <addColumn tableName="billing_counter">
            <column name="customer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_counter_customer_id" referencedTableName="crm_customer"
                                 baseColumnNames="customer_id" baseTableName="billing_counter" referencedColumnNames="id"/>
        <addColumn tableName="billing_counter">
            <column name="customer_account_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="fk_billing_counter_customer_account_id" referencedTableName="ar_customer_account"
                                 baseColumnNames="customer_account_id" baseTableName="billing_counter" referencedColumnNames="id"/>

        <addColumn tableName="billing_counter_period">
            <column name="is_accumulator" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <!--    one shot migration of sellers -->
    <changeSet id="4745_20200108" author="MohamedSTITANE" >
        <sql dbms="postgresql" endDelimiter="$$" splitStatements="false">
            <![CDATA[DO $$
DECLARE
	oldSeller RECORD;
	seqId integer;
	sellId integer;
BEGIN
	 FOR sellId IN SELECT id FROM public.crm_seller
	 LOOP
		BEGIN
			seqId := nextval('account_entity_seq');
			-- get freshly record because parent seller has changed
			select * into oldSeller from public.crm_seller where id = sellId;
			-- Inserted new account entity with id
			INSERT INTO account_entity (id, version ,created ,updated ,code ,description ,address_1 ,address_2 ,address_3,
				address_city ,address_country_id ,address_state ,address_zipcode ,creator, updater ,uuid ,bam_id ,
				cf_values ,cf_values_accum ,email ,fax ,mobile ,phone ,vat_no, registration_no , account_type)
					VALUES (seqId, oldSeller.version, oldSeller.created, oldSeller.updated, oldSeller.code, oldSeller.description,
							oldSeller.address_1, oldSeller.address_2, oldSeller.address_3, oldSeller.address_city, oldSeller.address_country_id,
							oldSeller.address_state, oldSeller.address_zipcode, oldSeller.creator, oldSeller.updater, oldSeller.uuid ,
							oldSeller.bam_id, oldSeller.cf_values, oldSeller.cf_values_accum, oldSeller.email, oldSeller.fax,
							oldSeller.mobile, oldSeller.phone, oldSeller.vat_no, oldSeller.registration_no, 'ACCT_S');

			--update code to prevent uk constraint
			update public.crm_seller set code = concat(code,'_OLD') where id = oldSeller.id;

			-- Insert a seller entity with new id
			INSERT INTO public.crm_seller(
				id, version, created, updated, code, description, address_1, address_2, address_3, address_city, address_country_id, address_state, address_zipcode,
				creator, updater, parent_seller_id, trading_country_id, trading_currency_id, trading_language_id, credit_note_prefix, current_credit_note_nb,
				credit_note_sequence_size, uuid, bam_id, cf_values, cf_values_accum, email, fax, mobile, phone, vat_no, registration_no, legal_text, legal_type, general_ledger_id)
				VALUES (seqId, oldSeller.version, oldSeller.created, oldSeller.updated, oldSeller.code, oldSeller.description, oldSeller.address_1, oldSeller.address_2,
				oldSeller.address_3, oldSeller.address_city, oldSeller.address_country_id, oldSeller.address_state, oldSeller.address_zipcode, oldSeller.creator,
				oldSeller.updater, oldSeller.parent_seller_id, oldSeller.trading_country_id, oldSeller.trading_currency_id, oldSeller.trading_language_id,
				oldSeller.credit_note_prefix, oldSeller.current_credit_note_nb, oldSeller.credit_note_sequence_size, oldSeller.uuid, oldSeller.bam_id, oldSeller.cf_values,
				 oldSeller.cf_values_accum, oldSeller.email, oldSeller.fax, oldSeller.mobile, oldSeller.phone, oldSeller.vat_no, oldSeller.registration_no,
				 oldSeller.legal_text, oldSeller.legal_type, oldSeller.general_ledger_id);

			-- Update a parent seller entity with new id
			update public.crm_seller set parent_seller_id = seqId where parent_seller_id = oldSeller.id;

			-- Update table billing_charge_instance fk
			update public.billing_charge_instance set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table crm_customer fk
			update public.crm_customer set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_invoice fk
			update public.billing_invoice set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_product_instance  fk
			update public.billing_product_instance set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_rated_transaction fk
			update public.billing_rated_transaction set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_subscription fk
			update public.billing_subscription  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_wallet_operation fk
			update public.billing_wallet_operation  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_account_operation fk
			update public.ar_account_operation  set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table billing_seq_invtyp_sell fk
			update public.billing_seq_invtyp_sell set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table cat_price_plan_matrix fk
			update public.cat_price_plan_matrix set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_ddrequest_lot fk
			update public.ar_ddrequest_lot set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_payment_gateway fk
			update public.ar_payment_gateway set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table ar_ddrequest_lot_op fk
			update public.ar_ddrequest_lot_op set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table crm_customer_sequence fk
			update public.crm_customer_sequence set seller_id = seqId where seller_id = oldSeller.id;

			-- Update table cat_product_offer_seller  fk
			update public.cat_product_offer_seller set seller_id = seqId where seller_id = oldSeller.id;

			-- delete old seller
			delete from public.crm_seller where id = oldSeller.id;

		EXCEPTION when others then
			RAISE INFO '%', concat('Error ', SQLSTATE, ' : ', SQLERRM, ' for seller ' , oldSeller.code);
        END;
	END LOOP;
END $$;]]>
        </sql>
        <dropColumn tableName="crm_seller">
            <column name="version"/>
            <column name="created"/>
            <column name="updated"/>
            <column name="code"/>
            <column name="description"/>
            <column name="address_1"/>
            <column name="address_2"/>
            <column name="address_3"/>
            <column name="address_city"/>
            <column name="address_country_id"/>
            <column name="address_state"/>
            <column name="address_zipcode"/>
            <column name="creator"/>
            <column name="updater"/>
            <column name="uuid"/>
            <column name="bam_id"/>
            <column name="cf_values"/>
            <column name="cf_values_accum"/>
            <column name="email"/>
            <column name="fax"/>
            <column name="mobile"/>
            <column name="phone"/>
            <column name="vat_no"/>
        </dropColumn>
    </changeSet>


    <changeSet id="#4906_Creation_CDR_Table_1" author="anasseh" dbms="mysql">
            <createTable tableName="rating_cdr_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="rating_cdr_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}rating_cdr_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4906_Creation_CDR_Table_2" author="anasseh">
   		<createSequence sequenceName="rating_cdr_seq" />
   		<createTable tableName="rating_cdr">
	         <column name="id" type="bigint" autoIncrement="${id.auto}">
	             <constraints nullable="false" primaryKey="true" primaryKeyName="rating_cdr_pkey" />
	         </column>
	         <column name="version" type="int4" />
	         <column name="created" type="datetime" />
	         <column name="event_date" type="datetime" />
	         <column name="last_updated" type="datetime" />
	         <column name="origin_batch" type="varchar(255)" />
	         <column name="origin_record" type="varchar(255)" />
	         <column name="quantity" type="numeric" />
	         <column name="reject_reason" type="${type.text}" />
	         <column name="status" type="varchar(255)" />
	         <column name="status_date" type="datetime" />
	         <column name="parameter_1" type="varchar(255)" />
	         <column name="parameter_2" type="varchar(255)" />
	         <column name="parameter_3" type="varchar(255)" />
	         <column name="parameter_4" type="varchar(255)" />
	         <column name="parameter_5" type="varchar(255)" />
	         <column name="parameter_6" type="varchar(255)" />
	         <column name="parameter_7" type="varchar(255)" />
	         <column name="parameter_8" type="varchar(255)" />
	         <column name="parameter_9" type="varchar(255)" />
	         <column name="date_parameter_1" type="datetime" />
	         <column name="date_parameter_2" type="datetime" />
	         <column name="date_parameter_3" type="datetime" />
	         <column name="date_parameter_4" type="datetime" />
	         <column name="date_parameter_5" type="datetime" />
	         <column name="decimal_parameter_1" type="numeric" />
	         <column name="decimal_parameter_2" type="numeric" />
	         <column name="decimal_parameter_3" type="numeric" />
	         <column name="decimal_parameter_4" type="numeric" />
	         <column name="decimal_parameter_5" type="numeric" />
	         <column name="access_code" type="varchar(255)" />
	         <column name="header_edr_id" type="bigint">
	             <constraints nullable="true" />
	         </column>
	         <column name="extra_parameter" type="text" />
    	</createTable>
        <sql>CREATE INDEX rating_cdr_index ON ${db.schema.adapted}rating_cdr(origin_batch, origin_record)</sql>
        <sql>CREATE INDEX rating_cdr_status ON ${db.schema.adapted}rating_cdr(status)</sql>
    </changeSet>

    <changeSet id="#4933_20200117" author="AbdellatifBARI">
        <addNotNullConstraint tableName="adm_file_format" columnName="configuration_template" columnDataType="varchar(255)"/>
        <addColumn tableName="adm_file_format">
            <column name="job_code" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#3743_20190414" author="HatimOudad">
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'PaymentJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'PaymentScheduleProcessingJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'SepaDirectDebitJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'SepaRejectedTransactionsJob'
        </sql>
        <sql>update ${db.schema.adapted}meveo_job_instance set job_category = 'PAYMENT' where job_template =
            'CheckPaymentScheduleCallbackJob'
        </sql>
    </changeSet>

    <changeSet id="#500X_20200218" author="mohamed.el.youssoufi" dbms="postgresql">
        <sql>CREATE INDEX rt_edr_id ON ${db.schema.adapted}billing_rated_transaction (edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX resa_origin_edr_id ON ${db.schema.adapted}billing_reservation (origin_edr_id ASC NULLS LAST)
        </sql>
        <sql>CREATE INDEX wo_edr_id ON ${db.schema.adapted}billing_wallet_operation (edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX cdr_header_edr_id ON ${db.schema.adapted}rating_cdr (header_edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX edr_header_edr_id ON ${db.schema.adapted}rating_edr (header_edr_id ASC NULLS LAST)</sql>
        <sql>CREATE INDEX rt_adjusted_rated_tx ON ${db.schema.adapted}billing_rated_transaction (adjusted_rated_tx ASC
            NULLS LAST)
        </sql>
        <sql>CREATE INDEX wo_rt_id ON ${db.schema.adapted}billing_wallet_operation (rated_transaction_id ASC NULLS
            LAST)
        </sql>
        <sql>CREATE INDEX wo_rerated_wo ON ${db.schema.adapted}billing_wallet_operation (reratedwalletoperation_id ASC
            NULLS LAST)
        </sql>
    </changeSet>
    <changeSet id="#4787_20200224" author="khalidHORRI">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="override_prorata" type="varchar(255)"/>
        </addColumn>
    </changeSet>


    <changeSet id="#4096_2020-02-07_1" author="AndriusKarpavicius" dbms="mysql">
        <createTable tableName="billing_tax_category_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_category_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_category_seq values(1)</sql>

        <createTable tableName="billing_tax_class_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_class_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_class_seq values(1)</sql>

        <createTable tableName="billing_tax_mapping_seq">
            <column name="next_val" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_mapping_seq_pk" />
            </column>
        </createTable>
        <sql>insert into ${db.schema.adapted}billing_tax_mapping_seq values(1)</sql>
    </changeSet>

    <changeSet id="#4096_2020-02-07_2" author="AndriusKarpavicius">
        <createSequence sequenceName="billing_tax_category_seq" startValue="1" />
        <createTable tableName="billing_tax_category">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_category_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="${type.json}" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_tax_category_code" deferrable="false" disabled="false" initiallyDeferred="false"
            tableName="billing_tax_category" />

        <createSequence sequenceName="billing_tax_class_seq" startValue="1" />
        <createTable tableName="billing_tax_class">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_class_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="${type.json}" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_billing_tax_class_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_tax_class" />

        <createSequence sequenceName="billing_tax_mapping_seq" startValue="1" />
        <createTable tableName="billing_tax_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_tax_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="tax_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tax_class_id" type="bigint" />
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="seller_country_id" type="bigint" />
            <column name="buyer_country_id" type="bigint" />
            <column name="filter_el" type="varchar(2000)" />
            <column name="filter_el_sp" type="varchar(2000)" />
            <column name="tax_id" type="bigint" />
            <column name="tax_el" type="varchar(2000)" />
            <column name="tax_el_sp" type="varchar(2000)" />
            <column name="tax_script_id" type="bigint" />
            <column name="priority" type="int4" defaultValueNumeric="0" />
            <column name="source" type="varchar(2000)" />
            <column name="origin_id" type="bigint" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />
        <addForeignKeyConstraint baseColumnNames="seller_country_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_seller_country_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />
        <addForeignKeyConstraint baseColumnNames="buyer_country_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_buyer_country_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />
        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="tax_script_id" baseTableName="billing_tax_mapping" constraintName="fk_billing_tax_mapping_tax_script_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />


        <addColumn tableName="crm_customer_category">
            <column name="tax_category_id" type="bigint" />
            <column name="tax_category_el" type="varchar(2000)" />
            <column name="tax_category_el_sp" type="varchar(2000)" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="crm_customer_category" constraintName="fk_crm_customer_category_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />

        <addColumn tableName="billing_billing_account">
            <column name="tax_category_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_category_id" baseTableName="billing_billing_account" constraintName="fk_billing_account_tax_category_id"
            deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_category" />

        <addColumn tableName="cat_charge_template">
            <column name="tax_class_id" type="bigint" />
            <column name="tax_class_el" type="varchar(2000)" />
            <column name="tax_class_el_sp" type="varchar(2000)" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="cat_charge_template" constraintName="fk_cat_charge_template_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

        <addColumn tableName="billing_wallet_operation">
            <column name="tax_class_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

        <addColumn tableName="billing_rated_transaction">
            <column name="tax_class_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_tax_class_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

    </changeSet>

    <changeSet id="#4096_2020-02-07_3" author="AndriusKarpavicius">
        <insert tableName="billing_tax_category">
            <column name="id" valueNumeric="-1"/>
            <column name="version" valueNumeric="0"/>
            <column name="created" valueDate="2020-02-08 00:03:59.983" />
            <column name="version" valueNumeric="0" />
            <column name="code" value="Tax category"/>
            <column name="uuid" value="tax_category_1"/>
        </insert>

        <sql>insert into ${db.schema.adapted}billing_tax_class (id, version, created, uuid, code, description) (select id, 0, created, 'tax_class_'||id, code, description from ${db.schema.adapted}billing_invoice_sub_cat isc where isc.id in (select distinct invoice_sub_category_id from ${db.schema.adapted}billing_inv_sub_cat_country))</sql>
        <sql>insert into ${db.schema.adapted}billing_tax_mapping (id, version, created, tax_category_id, tax_class_id, seller_country_id, buyer_country_id, filter_el, tax_id, tax_el, tax_el_sp, valid_from, valid_to) (select nextval('billing_tax_mapping_seq'), 0, created, -1, invoice_sub_category_id, selling_country_id, trading_country_id, filter_el, tax_id, tax_code_el, tax_code_el_sp, start_validity_date, end_validity_date from ${db.schema.adapted}billing_inv_sub_cat_country)</sql>
        <sql>update ${db.schema.adapted}billing_tax_mapping set tax_script_id = (select tax_script_instance_id from ${db.schema.adapted}billing_invoice_sub_cat where billing_tax_mapping.id=billing_invoice_sub_cat.id and tax_script_instance_id is not null)</sql>

        <sql>update ${db.schema.adapted}billing_wallet_operation set tax_class_id = invoice_sub_category_id</sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction set tax_class_id = invoice_sub_category_id</sql>
        <sql>update ${db.schema.adapted}cat_charge_template set tax_class_id = invoice_sub_category </sql>
        <sql>update ${db.schema.adapted}crm_customer_category set tax_category_id = -1 where exonerated_from_taxes=0 </sql>

        <addNotNullConstraint tableName="cat_charge_template" columnName="tax_class_id" columnDataType="bigint"/>

        <dropTable tableName="billing_inv_sub_cat_country"/>

    </changeSet>
    <changeSet id="#4201_20200225" author="khalidHORRI">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="reimburse_oneshots" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="#4071_20200227" author="khalidHORRI">
        <addColumn tableName="cat_charge_template">
            <column name="drop_zero_wo" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>


    <changeSet author="abdelkader.bouazza"  id="#4894-Additional_fields_in_RT">
        <addColumn tableName="billing_rated_transaction">
            <column name="input_quantity" type="numeric(23, 12)" />
            <column name="raw_amount_without_tax" type="numeric(23, 12)" />
            <column name="raw_amount_with_tax" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet author="abdelkader.bouazza"  id="#4893-Add-custom-field-support-to-WalletOperation">
        <addColumn tableName="billing_wallet_operation">
            <column name="uuid" type="varchar(60)"/>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
        <sql>update ${db.schema.adapted}billing_wallet_operation set uuid = 'wo'||id</sql>
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="uuid"/>
    </changeSet>

    <changeSet id="#4892_2020-03-04" author="AndriusKarpavicius">
        <addColumn tableName="cat_charge_template">
            <column name="rating_script_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="rating_script_id" baseTableName="cat_charge_template" constraintName="fk_charge_template_rating_script_id" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="meveo_script_instance" />
    </changeSet>

    <changeSet id="#5038_2020-03-06" author="AndriusKarpavicius">
        <dropNotNullConstraint tableName="meveo_script_instance" columnName="script"/>
    </changeSet>

    <changeSet id="#5064_2020-03-15" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FlatFileProcessingJob'</sql>
    </changeSet>
    <changeSet author="abdelkader.bouazza" id="#4891-Copy-recurrence-calendar-and-applyInAdvance-to-RecurringChargeInstance-from-a-RecurringChargeTemplate">
        <addColumn tableName="billing_charge_instance">
            <column name="calendar_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_charge_instance">
            <column name="apply_in_advance" type="${type.boolean}" />
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}billing_charge_instance AS bci
            SET calendar_id = cct.calendar_id,
            apply_in_advance = cct.apply_in_advance
            FROM ${db.schema.adapted}cat_charge_template AS cct
            WHERE bci.charge_template_id = cct.id
        </sql>
    </changeSet>
    <changeSet author="khalid.horri" id="#4757_20191118">
        <addColumn tableName="account_entity">
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_amount_el_sp" type="varchar(2000)" />
            <column name="minimum_label_el_sp" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="crm_customer">
            <column name="minimum_target_account_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="minimum_target_account_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="minimum_charge_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="minimum_target_account_id" baseTableName="crm_customer"
                                 constraintName="fk_customer_minimum_target_account_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="billing_billing_account"/>
        <addForeignKeyConstraint baseColumnNames="minimum_target_account_id" baseTableName="ar_customer_account"
                                 constraintName="fk_ca_minimum_target_account_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="billing_billing_account"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="account_entity"
                                 constraintName="fk_ca_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_subscription"
                                 constraintName="fk_su_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_service_instance"
                                 constraintName="fk_si_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="cat_offer_template"
                                 constraintName="fk_ot_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="cat_service_template"
                                 constraintName="fk_st_minimum_charge_template_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cat_charge_template"/>
    </changeSet>
    <changeSet id="#4924_20200219" author="anasseh">
        <addColumn tableName="billing_invoice">
            <column name="external_ref" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#5085_20200330 - triggeredNextCharge has an incorrect value" author="Mohammed_ELAZZOUZI">
		<update tableName="cat_charge_template">
			<column name="trigger_next_charge" valueNumeric="0"></column>
			<where>trigger_next_charge is null</where>
		</update>
	</changeSet>

    <changeSet id="#4903_GDPR_Anonymize_CF" author="Mounir_BOUKAYOUA">
        <addColumn tableName="crm_custom_field_tmpl">
            <column name="anonymize_gdpr" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#4879_20190121" author="AmineBENAICHA">
       <addColumn tableName="cat_counter_template">
           <column name="calendar_code_el" type="varchar(2000)" />
       </addColumn>
    </changeSet>
    
    <changeSet id="#5052_20200323" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_rated_transaction">
            <column name="input_unitofmeasure" type="bigint"/>
            <column name="rating_unitofmeasure" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="input_unitofmeasure" baseTableName="billing_rated_transaction" constraintName="fk_input_billing_rated_transaction_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />
        <addForeignKeyConstraint baseColumnNames="rating_unitofmeasure" baseTableName="billing_rated_transaction" constraintName="fk_rating_billing_rated_transaction_cat_unit_of_measure" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_unit_of_measure" />
    </changeSet>


    <changeSet id="#5014_20200313" author="khalidHORRI">
        <addColumn tableName="crm_customer">
            <column name="invoicing_threshold" type="numeric(23, 12)"/>
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="invoicing_threshold" type="numeric(23, 12)"/>
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="check_threshold" type="varchar(25)">
            </column>
        </addColumn>
    </changeSet>
    <changeSet id="#5014_20200402" author="khalidHORRI">
        <dropDefaultValue tableName="ar_customer_account" columnName="check_threshold"/>
        <sql>update ${db.schema.adapted}ar_customer_account set check_threshold = null</sql>
    </changeSet>
    <changeSet id="#5125_20200407" author="khalidHORRI">
        <sql>update ${db.schema.adapted}cat_counter_template set is_accumulator = 0 where is_accumulator = null</sql>
        <createTable tableName="cat_serv_usage_counter_template">
            <column name="service_usage_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_usage_templt_id, indx" constraintName="cat_serv_usage_counter_template_pkey" tableName="cat_serv_usage_counter_template"/>
        <createTable tableName="cat_serv_rec_counter_template">
            <column name="service_rec_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_rec_templt_id, indx" constraintName="cat_serv_rec_counter_template_pkey" tableName="cat_serv_rec_counter_template"/>
        <createTable tableName="cat_serv_sub_counter_template">
            <column name="service_sub_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_sub_templt_id, indx" constraintName="cat_serv_sub_counter_template_pkey" tableName="cat_serv_sub_counter_template"/>
        <createTable tableName="cat_serv_trm_counter_template">
            <column name="service_trm_templt_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="service_trm_templt_id, indx" constraintName="cat_serv_trm_counter_template_pkey" tableName="cat_serv_trm_counter_template"/>
        <createTable tableName="billing_chrg_inst_counter">
            <column name="chrg_instance_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="counter_instance_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="chrg_instance_id, indx" constraintName="billing_chrg_inst_counter_pkey" tableName="billing_chrg_inst_counter"/>

    </changeSet>

    <changeSet id="#2447_20200421" author="khalidHORRI">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="parameter1_el" type="varchar(2000)"/>
            <column name="parameter2_el" type="varchar(2000)"/>
            <column name="parameter3_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5130_20200414" author="khalidHORRI">
    <addColumn tableName="cat_counter_template">
        <column name="accumulator_type" type="varchar(35)"/>
        <column name="filter_el" type="varchar(2000)"/>
        <column name="key_el" type="varchar(2000)"/>
        <column name="value_el" type="varchar(2000)"/>
    </addColumn>
    <addColumn tableName="billing_counter_period">
        <column name="accumulator_type" type="varchar(35)"/>
        <column name="filter_el" type="varchar(2000)"/>
        <column name="key_el" type="varchar(2000)"/>
        <column name="value_el" type="varchar(2000)"/>
    </addColumn>
    <createTable tableName="billing_counter_period_values">
        <column name="counter_key" type="varchar(255)">
            <constraints nullable="false"/>
        </column>
        <column name="counter_value" type="numeric(19,2)">
            <constraints nullable="false"/>
        </column>
        <column name="counterperiod_id" type="bigint">
            <constraints nullable="false"/>
        </column>

    </createTable>
        <addPrimaryKey tableName="billing_counter_period_values" columnNames="counterperiod_id,counter_key" constraintName="billing_counter_period_values_pkey"/>
        <addForeignKeyConstraint baseTableName="billing_counter_period_values" baseColumnNames="counterperiod_id"
                                 constraintName="billing_counter_period_values_counterperiod_id_fk" referencedTableName="billing_counter_period"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="MohammedELAZZOUZI"  id="#4004_ Add_CustomField_to_OrderItem">
        <addColumn tableName="ord_order_item">
            <column name="uuid" type="varchar(60)"/>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order_item set uuid = 'oi'||id</sql>
        <addNotNullConstraint tableName="ord_order_item" columnName="uuid"/>
    </changeSet>

    <changeSet id="#40167_20200407" author="AndriusKarpavicius">
        <addColumn tableName="billing_rated_transaction">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_wallet_operation">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_wallet_operation" constraintName="fk_wo_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <sql>update ${db.schema.adapted}billing_wallet_operation  set accounting_code_id = iv.accounting_code_id from billing_invoice_sub_cat iv where invoice_sub_category_id = iv.id and invoice_sub_category_id is not null </sql>
        <sql>update ${db.schema.adapted}billing_rated_transaction  set accounting_code_id = iv.accounting_code_id from billing_invoice_sub_cat iv where invoice_sub_category_id = iv.id and invoice_sub_category_id is not null </sql>
    </changeSet>

    <changeSet id="#5163_20200415" author="AndriusKarpavicius">
        <addColumn tableName="billing_charge_instance">
            <column name="charged_to_date" type="datetime"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5174_20200423" author="AbdelmounaimAkadid">
    	<addColumn tableName="ord_order_item">
    		<column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime" />
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
    </changeSet>

    <changeSet id="#5193_20200428" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl_mcols where cft_id in (select id from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%')</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%'</sql>
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to like 'JobInstance_%'</sql>
    </changeSet>

    <changeSet id="#5174_20200504" author="AbdelmounaimAkadid">
    	<sql>update ${db.schema.adapted}ord_order_item set code = id where code is null</sql>
    	<addUniqueConstraint columnNames="code" constraintName="uk_order_item_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="ord_order_item" />
    </changeSet>

    <changeSet id="#4792_20200504" author="khalidHORRI">
        <addColumn tableName="billing_invoice_sub_cat">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="billing_wallet_operation">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="sort_index" type="int4"/>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="sort_index_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>


    <changeSet id="#5172_20200426" author="anasseh">
         <addColumn tableName="ar_account_operation">
            <column name="payment_history_id" type="bigint"></column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="payment_history_id" baseTableName="ar_account_operation" constraintName="fk_pay_hisyo" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_history" />

     </changeSet>

     <changeSet id="#5206_20200505" author="AndriusKarpavicius" dbms="postgresql" >
        <sql>drop index adm_file_type_code_index</sql>
        <sql>drop index flat_file_code_index</sql>

        <sql>CREATE UNIQUE INDEX adm_file_type_code_index ON ${db.schema.adapted}adm_file_type(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_file_format_code_index ON ${db.schema.adapted}adm_file_format(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX flat_file_code_index ON ${db.schema.adapted}flat_file(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_language_code_index ON ${db.schema.adapted}adm_language(lower(language_code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_category_code_index ON ${db.schema.adapted}billing_tax_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_class_code_index ON ${db.schema.adapted}billing_tax_class(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_order_item_code_index ON ${db.schema.adapted}ord_order_item(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX wf_generic_workflow_code_index ON ${db.schema.adapted}wf_generic_workflow(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_template_filename_index ON ${db.schema.adapted}billing_invoice_template(lower(file_name))</sql>
        <sql>CREATE UNIQUE INDEX adm_notification_code_index ON ${db.schema.adapted}adm_notification(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_discount_plan_code_index ON ${db.schema.adapted}cat_discount_plan(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_price_plan_matrix_code_index ON ${db.schema.adapted}cat_price_plan_matrix(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_contact_coords_code_index ON ${db.schema.adapted}com_contact_coords(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_subscrip_termin_reason_code_index ON ${db.schema.adapted}billing_subscrip_termin_reason(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_cycle_code_index ON ${db.schema.adapted}billing_cycle(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_currency_code_index ON ${db.schema.adapted}adm_currency(lower(currency_code))</sql>
        <sql>CREATE UNIQUE INDEX cat_triggered_edr_code_index ON ${db.schema.adapted}cat_triggered_edr(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_sender_config_code_index ON ${db.schema.adapted}com_sender_config(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_tax_code_index ON ${db.schema.adapted}billing_tax(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX crm_provider_code_index ON ${db.schema.adapted}crm_provider(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_inbound_request_code_index ON ${db.schema.adapted}adm_inbound_request(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_campaign_code_index ON ${db.schema.adapted}com_campaign(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_msg_var_value_code_index ON ${db.schema.adapted}com_msg_var_value(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_msg_tmpl_variable_code_index ON ${db.schema.adapted}com_msg_tmpl_variable(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_template_code_index ON ${db.schema.adapted}billing_invoice_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_wallet_template_code_index ON ${db.schema.adapted}cat_wallet_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_calendar_code_index ON ${db.schema.adapted}cat_calendar(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX adm_user_username_index ON ${db.schema.adapted}adm_user(lower(username))</sql>
        <sql>CREATE UNIQUE INDEX crm_provider_contact_code_index ON ${db.schema.adapted}crm_provider_contact(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX rm_service_param_template_code_index ON ${db.schema.adapted}rm_service_param_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_counter_template_code_index ON ${db.schema.adapted}cat_counter_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ar_occ_template_code_index ON ${db.schema.adapted}ar_occ_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX dwh_chart_code_index ON ${db.schema.adapted}dwh_chart(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_sub_cat_code_index ON ${db.schema.adapted}billing_invoice_sub_cat(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_cat_code_index ON ${db.schema.adapted}billing_invoice_cat(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_message_template_code_index ON ${db.schema.adapted}com_message_template(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX dwh_measurable_quant_code_index ON ${db.schema.adapted}dwh_measurable_quant(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX bi_job_name_index ON ${db.schema.adapted}bi_job(lower(name))</sql>
        <sql>CREATE UNIQUE INDEX ar_credit_category_code_index ON ${db.schema.adapted}ar_credit_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_filter_code_index ON ${db.schema.adapted}meveo_filter(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_script_instance_code_index ON ${db.schema.adapted}meveo_script_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_meveo_instance_code_index ON ${db.schema.adapted}com_meveo_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_job_instance_code_index ON ${db.schema.adapted}meveo_job_instance(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_timer_code_index ON ${db.schema.adapted}meveo_timer(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX meveo_module_code_index ON ${db.schema.adapted}meveo_module(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_offer_template_category_code_index ON ${db.schema.adapted}cat_offer_template_category(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_invoice_type_code_index ON ${db.schema.adapted}billing_invoice_type(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX wf_workflow_code_index ON ${db.schema.adapted}wf_workflow(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_channel_code_index ON ${db.schema.adapted}cat_channel(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_order_code_index ON ${db.schema.adapted}ord_order(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cat_digital_resource_code_index ON ${db.schema.adapted}cat_digital_resource(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX ord_quote_code_index ON ${db.schema.adapted}ord_quote(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX cust_cet_code_index ON ${db.schema.adapted}cust_cet(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_accounting_code_code_index ON ${db.schema.adapted}billing_accounting_code(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX com_contact_email_index ON ${db.schema.adapted}com_contact(lower(email))</sql>
        <sql>CREATE UNIQUE INDEX billing_finance_segment_code_index ON ${db.schema.adapted}billing_finance_segment(lower(code))</sql>
        <sql>CREATE UNIQUE INDEX billing_general_ledger_code_index ON ${db.schema.adapted}billing_general_ledger(lower(code))</sql>


        <sql>CREATE UNIQUE INDEX hierarchy_entity_code_index ON ${db.schema.adapted}hierarchy_entity(lower(code), hierarchy_type)</sql>
        <sql>CREATE UNIQUE INDEX account_entity_code_index ON ${db.schema.adapted}account_entity(lower(code), account_type)</sql>

    </changeSet>
    
    <changeSet id="#5257_20200527" author="AndriusKarpavicius" dbms="postgresql" >
        <addColumn tableName="billing_wallet_operation">
            <column name="reject_reason" type="text"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4895_20200515" author="MohammedAmineTazi">        
       <createSequence sequenceName="cat_fixed_date_seq"/> 
        <createTable tableName="cat_fixed_date">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_fixed_date_pkey" />
            </column>
            <column name="start_date" type="datetime" >
            	<constraints nullable="false" />
            </column>
         	<column name="end_date" type="datetime" >
            	<constraints nullable="false" />
            </column>
            <column name="cat_calendar_id" type="bigint" >
            	<constraints nullable="false" />
            </column>           
            <column name="version" type="int4" />
        </createTable>
        <addForeignKeyConstraint constraintName="cat_fixed_date_cat_calendar_fk" baseColumnNames="cat_calendar_id" baseTableName="cat_fixed_date" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />  
    </changeSet>

    <changeSet id="#5279_20200608_Cancellation of a billing run is impossible" author="anasseh">
        <sql>CREATE INDEX ao_inv_idx ON ${db.schema.adapted}ar_account_operation  (invoice_id)</sql>
        <sql>CREATE INDEX rt_argr_f_idx ON ${db.schema.adapted}billing_rated_transaction  (aggregate_id_f)</sql>               
    </changeSet>
    
    <changeSet id="#5266_20200622" author="AbdelmounaimAkadid">
        <dropColumn tableName="billing_counter_period">
            <column name="filter_el"></column>
            <column name="key_el"></column>
            <column name="value_el"></column>
        </dropColumn>
     </changeSet>

    <changeSet id="#5319_20200703" author="Mohammed_EL-AZZOUZI">
        <addNotNullConstraint tableName="billing_wallet_operation" columnName="quantity" columnDataType="numeric(23, 12)"/>
    </changeSet>


    <changeSet id="#5331_20190630" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_RecurringRatingJob'</sql>
    </changeSet>

        <changeSet id="#5295_20200626" author="anasseh">
         <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="tax_class_id" type="bigint"></column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="ar_payment_schedule_tmpl" constraintName="fk_tax_class_pst" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax_class" />

            <sql>update ${db.schema.adapted}ar_payment_schedule_tmpl set is_generate_adv_pay_inv=1</sql>

     </changeSet>


    <changeSet id="#5330_20190630" author="AndriusKarpavicius">
        <addColumn tableName="cat_calendar">
            <column name="init_date_el" type="varchar(2000)"/>
            <column name="init_date_el_sp" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5372_20190630" author="AndriusKarpavicius">
        <addColumn tableName="billing_cycle">
            <column name="transaction_date_delay_el" type="varchar(2000)"/>
            <column name="invoice_date_production_delay_el" type="varchar(2000)"/>
            <column name="invoice_date_delay_el" type="varchar(2000)"/>
            <column name="transaction_date_el" type="varchar(2000)"/>
        </addColumn>
        
        <sql>update ${db.schema.adapted}billing_cycle set billing_template_name_el = billing_template_name where billing_template_name_el is null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set due_date_delay_el = due_date_delay where due_date_delay_el is null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set transaction_date_delay_el = transaction_date_delay where transaction_date_delay is not null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set invoice_date_production_delay_el = invoice_date_production_delay where invoice_date_production_delay is not null</sql>
        <sql>update ${db.schema.adapted}billing_cycle set invoice_date_delay_el = invoice_date_delay where invoice_date_delay is not null</sql>
                
        <dropColumn tableName="billing_cycle" columnName="transaction_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="invoice_date_production_delay"/>
        <dropColumn tableName="billing_cycle" columnName="invoice_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="due_date_delay"/>
        <dropColumn tableName="billing_cycle" columnName="billing_template_name"/>
    </changeSet>
    
    
    <changeSet id="#5372_20200711" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}billing_invoice_type set billing_template_name_el = billing_template_name where billing_template_name_el is null</sql>
        <dropColumn tableName="billing_invoice_type" columnName="billing_template_name"/>        
    </changeSet>
    
    <changeSet id="#5303_20200629" author="hznibar" >
        <addColumn tableName="rating_cdr">
            <column name="times_tried" type="int4"/>
            <column name="type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5241_20200622" author="khalidHORRI">
        <createTable tableName="wo_aggregation_line">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wo_aggregation_line_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="field" type="varchar(255)"/>
            <column name="action" type="varchar(25)"/>
            <column name="value" type="varchar(255)"/>
            <column name="required" type="${type.boolean}"/>
            <column name="is_custom_field" type="${type.boolean}"/>
            <column name="group_by" type="varchar(25)"/>
            <column name="group_by_parameter" type="varchar(25)"/>
            <column name="alias" type="varchar(255)"/>
            <column name="wo_aggregation_settings_id" type="bigint"/>
        </createTable>
        <createTable tableName="wo_aggregation_settings">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wo_aggregation_matrix_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)"/>
            <column name="global_aggregation" type="${type.boolean}"/>
            <column name="period_aggregation" type="${type.boolean}"/>
            <column name="period_end_date_included" type="${type.boolean}"/>
            <column name="wallet_operation_filter_id" type="bigint"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="wo_aggregation_settings" baseColumnNames="wallet_operation_filter_id"
                                 constraintName="wallet_operation_filter_id_fk" referencedTableName="meveo_filter"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="wo_aggregation_line" baseColumnNames="wo_aggregation_settings_id"
                                 constraintName="wo_aggregation_settings_id_fk" referencedTableName="wo_aggregation_settings"
                                 referencedColumnNames="id"/>
        <createSequence sequenceName="wo_aggregation_line_seq" startValue="1"/>
        <createSequence sequenceName="wo_aggregation_matrix_seq" startValue="1"/>
        <addColumn tableName="billing_rated_transaction">
            <column name="cf_values_accum" type="${type.json}"/>
            <column name="cf_values" type="${type.json}"/>
            <column name="uuid" type="varchar(60)"/>
        </addColumn>
    </changeSet>

     <changeSet id="#5241_20200721" author="khalidHORRI">
        <addColumn tableName="wo_aggregation_settings">
            <column name="aggregation_rounding" type="int4" defaultValueNumeric="2"/>
            <column name="aggregation_rounding_mode" type="varchar(50)" defaultValue="NEAREST"/>
        </addColumn>     
     </changeSet>
 
    <changeSet id="#5388_20200715" author="AndriusKarpavicius">
        <modifyDataType tableName="adm_notification" columnName="event_type_filter" newDataType="varchar(25)"/>
    </changeSet>

    <changeSet id="#FEAT-777_20200728j" author="AbdelkaderBouazza">
        <createTable tableName="document" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="document_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="file_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="creation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="file_name"  type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="tags"  type="varchar(255)"/>
            <column name="linked_account_entity_id" type="bigint" />
            <column name="document_category_id" type="bigint" />
            <column name="document_status" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </createTable>

        <createTable tableName="document_category" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="document_category_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
            <column name="relative_path"  type="varchar(2000)">
                <constraints nullable="false" />
            </column>
            <column name="cf_values_accum" type="${type.json}"></column>
            <column name="cf_values" type="${type.json}"></column>
            <column name="uuid" type="varchar(60)" />
        </createTable>
        <createTable tableName="document_tags">
            <column name="document_id"  type="bigint"/>
            <column name="tags"  type="varchar(60)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="document" baseColumnNames="linked_account_entity_id"
                                 constraintName="document_account_entity_id_fk" referencedTableName="account_entity"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="document" baseColumnNames="document_category_id"
                                 constraintName="document_category_id_fk" referencedTableName="document_category"
                                 referencedColumnNames="id"/>

        <createSequence sequenceName="document_seq" startValue="1"/>
        <createSequence sequenceName="document_category_seq" startValue="1"/>
    </changeSet>
    
    <changeSet id="#4764_20200720" author="MohammedELAZZOUZI">
        <addColumn tableName="cat_wallet_template">
            <column name="low_balance_level_el" type="varchar(2000)"/>
            <column name="reject_level_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5408_20200724" author="AbdellatifBARI">
        <addColumn tableName="adm_file_format">
            <column name="file_name_uniqueness" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5405_20190723" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_ReportExtractJob'</sql>
    </changeSet>

    <changeSet id="#5404_20200728" author="khalidHORRI">
        <addColumn tableName="wo_aggregation_settings">
            <column name="additional_order_by" type="varchar(255)"/>
        </addColumn>
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o ) o WHERE o.status='OPEN'
        </createView>
    </changeSet>
    <changeSet id="#5400_23072020" author="KhalidHORRI">
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="payment_day_in_month_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#4156_20120719" author="anasseh">
		<addColumn tableName="meveo_filter">
			<column name="polling_query" type="text"/>
		</addColumn>
		<sql>CREATE INDEX ar_ao_dd_item_idx  ON ${db.schema.adapted}ar_account_operation USING btree (ddrequest_item_id)</sql>
    </changeSet>

    <changeSet id="#4906_Creation_CDR_Table" author="MohammedAmineTazi">
        <addColumn tableName="rating_cdr">
            <column name="line" type="varchar(2000)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5372_20190813" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}billing_billing_run set last_transaction_date = process_date where last_transaction_date is null</sql>
        <addNotNullConstraint tableName="billing_billing_run" columnName="last_transaction_date"/>
    </changeSet>

    <changeSet id="#5442_CET_ES" author="AndriusKarpavicius">
        <addColumn tableName="cust_cet">
            <column name="store_in_es" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <addNotNullConstraint tableName="cust_cet" columnName="store_in_es"/>
    </changeSet>
    <changeSet id="#5454_20200824" author="khalidHORRI">
        <dropView viewName="billing_wallet_operation_period"/>
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>


    <changeSet id="#5303_Update_CDR_Table_20200826" author="MohammedAmineTazi">
        <addColumn tableName="rating_cdr">
        	<column name="updater" type="varchar(100)"/>
        </addColumn>
    </changeSet>
        <changeSet id="#5416_20120809" author="anasseh">
		<createTable tableName="ar_ao_payment_histories">
			<column name="ao_id" type="bigint" />
			<column name="history_id" type="bigint" />
		</createTable>
		<addForeignKeyConstraint
			baseColumnNames="ao_id" baseTableName="ar_ao_payment_histories"
			constraintName="fk_ao_id" deferrable="false" initiallyDeferred="false"
			onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="ar_account_operation" />
		<addForeignKeyConstraint
			baseColumnNames="history_id" baseTableName="ar_ao_payment_histories"
			constraintName="fk_histo_id" deferrable="false"
			initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="ar_payment_history" />

        <sql>insert into ${db.schema.adapted}ar_ao_payment_histories (ao_id,history_id)  select id,payment_history_id from ${db.schema.adapted}ar_account_operation where payment_history_id is not null</sql>
	    <dropColumn tableName="ar_account_operation">
            <column name="payment_history_id"></column>
        </dropColumn>
	</changeSet>
    <changeSet id="#CORE-5215_11082020" author="AbdelkaderBouazza">
        <addColumn tableName="billing_subscription">
            <column name="payment_method_id"  type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_subscription"
                                 constraintName="fk_subscription_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <addColumn tableName="billing_billing_account">
            <column name="payment_method_id"  type="bigint">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="billing_billing_account"
                                 constraintName="fk_billing_account_pm" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <addColumn tableName="billing_cycle">
            <column name="split_per_payment_method" type="${type.boolean}" defaultValueNumeric="0" >
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
	<changeSet id="#5303_20200831" author="hznibar" >
        <addColumn tableName="rating_edr">
            <column name="times_tried" type="int4"/>
        </addColumn>
    </changeSet>

	<changeSet id="#5461_20200901" author="Mohammed_EL-AZZOUZI">
        <addColumn tableName="crm_customer">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="threshold_per_entity" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5460_BA_fields" author="AndriusKarpavicius">
        <sql>UPDATE ${db.schema.adapted}account_entity as ae SET minimum_amount_el = ba.minimum_amount_el, minimum_amount_el_sp = ba.minimum_amount_el_sp, minimum_label_el = ba.minimum_label_el, minimum_label_el_sp=ba.minimum_label_el_sp FROM ${db.schema.adapted}billing_billing_account AS ba WHERE ba.id=ae.id</sql>

        <dropColumn tableName="billing_billing_account" columnName="minimum_amount_el"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_amount_el_sp"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_label_el"/>
        <dropColumn tableName="billing_billing_account" columnName="minimum_label_el_sp"/>
    </changeSet>

    <changeSet id="#CORE-5457_20200825" author="AbdelkaderBouazza">
        <addColumn tableName="ar_payment_token">
            <column name="document_id"  type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="ar_payment_token" baseColumnNames="document_id"
                                 constraintName="document_ar_payment_token_id_fk" referencedTableName="document"
                                 referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="#5303_20200902" author="hznibar" >
        <addColumn tableName="rating_cdr">
            <column name="source" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5471-2020-09-07" author="AndriusKarpavicius">
        <createTable tableName="job_execution_error" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="job_execution_error_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="job_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="entity_id" type="bigint"/>
            <column name="period_from" type="datetime"/>
            <column name="period_to" type="datetime"/>

            <column name="error_reason"  type="varchar(2000)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="job_execution_error" baseColumnNames="job_instance_id"
                                 constraintName="job_execution_error_job_instance_fk" referencedTableName="meveo_job_instance"
                                 referencedColumnNames="id"/>

        <createSequence sequenceName="job_execution_error_seq" startValue="1"/>
    </changeSet>

    <changeSet id="#5489-2020-09-14" author="AndriusKarpavicius">
        <addColumn tableName="billing_charge_instance">
            <column name="charge_to_date_on_termination" type="datetime"/>
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="apply_terminated_charge_to_date_el" type="varchar(2000)"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5510_20200923" author="anasseh">
		<sql>CREATE INDEX ao_ref_idx ON ${db.schema.adapted}ar_account_operation USING btree (reference)</sql>
    </changeSet>

    <changeSet id="#5534_20200929" author="AndriusKarpavicius">
        <sql>delete from ${db.schema.adapted}crm_custom_field_tmpl where applies_to='JobInstance_FilteringJob'</sql>
    </changeSet>

    <changeSet id="#5471_20200930" author="AndriusKarpavicius">
        <addColumn tableName="meveo_filter">
            <column name="entity_class" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="zbariki" id="#3402_20201007">
        <addColumn tableName="cat_calendar">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_channel">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="adm_currency">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="adm_language">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="crm_customer_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="ar_credit_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_offer_template_category">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_offer_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_serv_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="cat_business_product_model">
            <column name="description_i18n" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5556_20201006" author="AndriusKarpavicius">
        <modifyDataType tableName="account_entity" columnName="email" newDataType="varchar(2000)"/>
    </changeSet>

    <changeSet id="#5501_20201007" author="MohammedELAZZOUZI">
        <sql>create index billing_subscription_minimum_amount_el_index on ${db.schema.adapted}billing_subscription(minimum_amount_el) where minimum_amount_el is not null</sql>
    	<sql>create index billing_service_instance_minimum_amount_el_index on ${db.schema.adapted}billing_service_instance(minimum_amount_el) where minimum_amount_el is not null</sql>
    </changeSet>
    
    
     <changeSet id="#5155_20200928" author="Mbarek-Ay">
        <addColumn tableName="cust_cet">
            <column name="disableable" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
        <addColumn tableName="cust_cet">
            <column name="versioned" type="${type.boolean}" defaultValueNumeric="0">
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#5546_20201023" author="AbdelmounaimAkadid" dbms="postgresql">
        <sql>DROP INDEX IF EXISTS agregate_index_category_invoice_agregate</sql>
        <sql>DROP INDEX IF EXISTS billing_user_account_id_index</sql>
        <sql>DROP INDEX IF EXISTS cat_st_serv_mod_id_index</sql>
        <sql>DROP INDEX IF EXISTS ar_credit_category_id_key</sql>
		<sql>DROP INDEX IF EXISTS rated_transaction_number</sql>
		<sql>DROP INDEX IF EXISTS adm_file_type_code_index</sql>
		<sql>DROP INDEX IF EXISTS ord_quote_index_upper_code</sql>
		<sql>DROP INDEX IF EXISTS customer_code</sql>
    </changeSet>

    <changeSet id="#5621_20201104_offer_template_fix" author="NabilOUACHI" failOnError="false">
        <addColumn tableName="billing_subscription">
            <column name="valid_from" type="datetime"/>
            <column name="valid_to" type="datetime"/>
        </addColumn>
        <dropUniqueConstraint tableName="billing_subscription" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9"/>
        <addUniqueConstraint columnNames="code, valid_from, valid_to" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_subscription" />

        <addColumn tableName="cat_offer_template">
            <column name="is_offer_change_restricted" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <createTable tableName="cat_offer_allowed_offer_change">
            <column name="offer_tmpl_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="allowed_offer_change_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="offer_tmpl_id, allowed_offer_change_id" constraintName="cat_offer_allowed_offer_change_pkey" tableName="cat_offer_allowed_offer_change" />
        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="offer_tmpl_id"
                                 constraintName="cat_offer_allowed_offer_change_fk1" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="allowed_offer_change_id"
                                 constraintName="cat_offer_allowed_offer_change_fk2" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>
    
    <changeSet id="#5621_20201104_offer_template" author="NabilOUACHI" failOnError="false">
        <addColumn tableName="billing_subscription">
            <column name="valid_from" type="datetime"/>
            <column name="valid_to" type="datetime"/>
        </addColumn>
        <dropUniqueConstraint tableName="billing_subscription" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9"/>
        <addUniqueConstraint columnNames="code, valid_from, valid_to" constraintName="uk_9fnf93rp352nkw2kpd4oq5xp9" deferrable="false" disabled="false" initiallyDeferred="false" tableName="billing_subscription" />

        <addColumn tableName="cat_offer_template">
            <column name="is_offer_change_restricted" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="offer_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_offer_template" baseColumnNames="offer_template_id"
                                 constraintName="offer_template_offer_template_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>
    
    <changeSet id="#5975_20210225_offer_template_allowed_offer_change_should_be_many_to_many" author="MounirBOUKAYOUA" failOnError="false">
        <dropColumn tableName="cat_offer_template">
            <column name="offer_template_id"></column>
        </dropColumn>

        <createTable tableName="cat_offer_allowed_offer_change">
            <column name="offer_tmpl_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="allowed_offer_change_id" type="bigint">
                <constraints nullable="true" />
            </column>
        </createTable>

        <addPrimaryKey columnNames="offer_tmpl_id, allowed_offer_change_id" constraintName="cat_offer_allowed_offer_change_pkey" tableName="cat_offer_allowed_offer_change" />

        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="offer_tmpl_id"
                                 constraintName="cat_offer_allowed_offer_change_fk1" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cat_offer_allowed_offer_change" baseColumnNames="allowed_offer_change_id"
                                 constraintName="cat_offer_allowed_offer_change_fk2" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>   


    <changeSet id="#5599_20201029" author="AndriusKarpavicius">
        <createTable tableName="billing_invoice_agr_amount">
            <column name="aggr_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="tax_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="amountwithouttax" type="numeric(23, 12)" />
            <column name="amounttax" type="numeric(23, 12)" />
            <column name="amountwithtax" type="numeric(23, 12)" />
        </createTable>

    </changeSet>
   <changeSet id="#5416_20120809" author="anasseh">
       <createTable tableName="ar_ao_payment_histories">
           <column name="ao_id" type="bigint"/>
           <column name="history_id" type="bigint"/>
       </createTable>
       <addForeignKeyConstraint
               baseColumnNames="ao_id" baseTableName="ar_ao_payment_histories"
               constraintName="fk_ao_id" deferrable="false" initiallyDeferred="false"
               onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
               referencedTableName="ar_account_operation"/>
       <addForeignKeyConstraint
               baseColumnNames="history_id" baseTableName="ar_ao_payment_histories"
               constraintName="fk_histo_id" deferrable="false"
               initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
               referencedColumnNames="id" referencedTableName="ar_payment_history"/>

        <sql>insert into ${db.schema.adapted}ar_ao_payment_histories (ao_id,history_id)  select id,payment_history_id from ${db.schema.adapted}ar_account_operation where payment_history_id is not null</sql>
	    <dropColumn tableName="ar_account_operation">
            <column name="payment_history_id"></column>
        </dropColumn>
	</changeSet>
    <changeSet id="#5610-2020-11-05 - Dunning workflow" author="NabilOUACHI">
        <addColumn tableName="dunning_document">
            <column name="status" type="varchar(25)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#5587_20201021" author="ZBariki">
        <createSequence sequenceName="bi_data_collector_seq" startValue="1" />
        <createTable tableName="bi_data_collector" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="data_collector_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="sql_query" type="text" >
                <constraints nullable="false" />
            </column>
            <column name="custom_table_code" type="varchar(255)" >
                <constraints nullable="false" />
            </column>
            <column name="aliases" type="text" >
                <constraints nullable="false" />
            </column>
            <column name="last_run_date" type="datetime" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_bi_data_collector_code" deferrable="false"
                             disabled="false" initiallyDeferred="false" tableName="bi_data_collector" />
    </changeSet>

    <changeSet author="#5512_20201113" id="AbdelkaderBouazza" failOnError="false">
        <addUniqueConstraint tableName="ar_payment_token" columnNames="customer_account_id, iban" constraintName="customer_account_id_iban_unique"/>
    </changeSet>

    <changeSet id="#5587_20201125" author="ZBariki" failOnError="false">
        <addColumn tableName="bi_data_collector">
            <column name="parameters" type="text" />
        </addColumn>
    </changeSet>

    <changeSet id="#5214_20201117" author="ZBariki">
        <createSequence sequenceName="wf_generic_action_seq" startValue="1" />
        <createTable tableName="wf_generic_action" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="wf_generic_action_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="description" type="varchar(255)" />
            <column name="uuid" type="varchar(255)" />
            <column name="priority" type="int4" />
            <column name="condition_el" type="varchar(2000)" />
            <column name="value_el" type="varchar(2000)" />
            <column name="type" type="varchar(255)" />
            <column name="log_level" type="varchar(255)" />
            <column name="field_to_update" type="varchar(255)" />
            <column name="is_asynchronous" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="action_script_id" type="bigint" />
            <column name="notification_id" type="bigint" />
            <column name="transition_id" type="bigint" />
        </createTable>
        <addUniqueConstraint columnNames="uuid" constraintName="uk_wf_generic_action_uuid" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="wf_generic_action" />

        <addForeignKeyConstraint baseColumnNames="transition_id" baseTableName="wf_generic_action" constraintName="fk_wf_generic_action_transition_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="wf_generic_transition" />

        <addForeignKeyConstraint baseColumnNames="notification_id" baseTableName="wf_generic_action"
                                 constraintName="fk_wf_generic_action_notification_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_notification" />

        <addForeignKeyConstraint baseColumnNames="action_script_id" baseTableName="wf_generic_action" constraintName="fk_wf_generic_action_script_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />

    </changeSet>
    <changeSet id="#5680_20201126" author="khalidHORRI">
        <addColumn tableName="billing_invoice">
            <column name="initial_collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="collection_date_delay_el" type="varchar(2000)"/>
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_invoice set initial_collection_date = due_date;
            update ${db.schema.adapted}ar_account_operation set collection_date = due_date;
        </sql>
    </changeSet>

    <changeSet id="5687_20203011" author="khalidHORRI">
        <addColumn tableName="billing_cycle">
            <column name="compute_dates_validation" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="compute_dates_validation" type="BOOLEAN"/>
        </addColumn>
    </changeSet>
    <changeSet id="5697_20201208" author="khalidHORRI">
        <addColumn tableName="ar_payment_schedule_inst_item">
            <column name="amount" type="numeric(23, 12)"/>
        </addColumn>
        <addColumn tableName="ar_payment_schedule_tmpl">
            <column name="use_banking_calender" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>

    </changeSet>


    <changeSet id="#5632_20201207_RT_TYPE" author="NabilOUACHI">
        <addColumn tableName="billing_rated_transaction">
            <column name="type" type="VARCHAR(25)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#4427_20201202" author="ZBariki">
        <createSequence sequenceName="generic_sequence_seq" startValue="1" />
        <createTable tableName="generic_sequence" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="generic_sequence_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="sequence_type" type="varchar(255)" />
            <column name="sequence_size" type="int" />
            <column name="current_number" type="bigint" />
            <column name="sequence_pattern" type="varchar(255)" />
        </createTable>
        <addColumn tableName="billing_seq_invoice">
            <column name="sequence_type" type="varchar(255)"/>
            <column name="sequence_pattern" type="varchar(255)"/>
        </addColumn>
        <renameColumn tableName="billing_seq_invoice" newColumnName="current_number" oldColumnName="current_invoice_nb"
                      columnDataType="bigint"/>
        <addColumn tableName="adm_custom_generic_entity_code">
            <column name="format_el" type="varchar(2000)"/>
            <column name="sequence_id" type="bigint"/>
        </addColumn>
        <dropColumn columnName="sequence_size" tableName="adm_custom_generic_entity_code" />
        <dropColumn columnName="sequence_current_value" tableName="adm_custom_generic_entity_code" />
        <addForeignKeyConstraint baseColumnNames="sequence_id" baseTableName="adm_custom_generic_entity_code"
                                 constraintName="fk_dm_custom_generic_entity_code_sequence_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="generic_sequence" />
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1, 'order_quote_sequence', 'Order and Quote', 'UUID') </sql>
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type, sequence_size, current_number)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1, 'seller_sequence', 'Seller sequence', 'SEQUENCE', 9, 0)</sql>
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type, sequence_size, current_number)
            VALUES (nextval('generic_sequence_seq'),
            '12/09/2020', 1,'customer_sequence', 'Customer sequence', 'SEQUENCE', 5, 0) </sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Quote', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'order_quote_sequence'))</sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Order', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'order_quote_sequence'))</sql>
        <sql>INSERT INTO ${db.schema.adapted}adm_custom_generic_entity_code( id, entity_class, version, created, sequence_id)
            VALUES (nextval('adm_custom_generic_entity_code_seq'), 'Seller', 1, '12/09/2020',
            (select id from ${db.schema.adapted}generic_sequence where code = 'seller_sequence'))</sql>
        <sql>UPDATE ${db.schema.adapted}adm_custom_generic_entity_code
            SET sequence_id = (select id from ${db.schema.adapted}generic_sequence where code = 'customer_sequence')
            WHERE entity_class = 'Customer'</sql>
    </changeSet>
    <changeSet id="#4427_20201216" author="ZBariki">
        <sql>INSERT INTO ${db.schema.adapted}generic_sequence(id, created, version, code, description, sequence_type)
            VALUES (nextval('generic_sequence_seq'),
            NOW(), 1, 'subscription_sequence', 'subscription', 'SEQUENCE') </sql>
        <sql>UPDATE ${db.schema.adapted}adm_custom_generic_entity_code
            SET sequence_id = (select id from ${db.schema.adapted}generic_sequence where code = 'subscription_sequence')
            WHERE entity_class = 'Subscription'</sql>
    </changeSet>

    <changeSet id="#5627_20210112" author="MohammedELAZZOUZI">
        <addDefaultValue columnName="skip_validation_script" tableName="billing_billing_run" defaultValueNumeric="0"/>
        <sql>UPDATE ${db.schema.adapted}billing_billing_run SET skip_validation_script=0 WHERE skip_validation_script IS NULL</sql>
    </changeSet>

    <changeSet id="#5627_20210107" author="AndriusKarpavicius">
        <addDefaultValue columnName="skip_validation_script" tableName="billing_billing_run" defaultValueNumeric="0"/>
        <sql>update ${db.schema.adapted}billing_billing_run set skip_validation_script=0 where skip_validation_script is null</sql>
    </changeSet>
    <changeSet id="5687_20203011" author="khalidHORRI">
        <addColumn tableName="billing_cycle">
            <column name="compute_dates_validation" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="compute_dates_validation" type="BOOLEAN"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5680_20201126" author="khalidHORRI">
        <addColumn tableName="billing_invoice">
            <column name="initial_collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_cycle">
            <column name="collection_date_delay_el" type="varchar(2000)"/>
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="collection_date" type="datetime"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_invoice set initial_collection_date = due_date;
            update ${db.schema.adapted}ar_account_operation set collection_date = due_date;
        </sql>
    </changeSet>
    <!-- for MediaPost -->

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-seq">
        <createSequence sequenceName="cpq_product_seq" />
        <createSequence sequenceName="cpq_product_line_seq" />
        <createSequence sequenceName="cpq_product_version_seq" />
        <createSequence sequenceName="cpq_tag_seq" />
        <createSequence sequenceName="cpq_tag_filter_seq" />
        <createSequence sequenceName="cpq_tag_type_seq" />
        <createSequence sequenceName="cpq_media_seq" />
        <createSequence sequenceName="cpq_offer_component_seq" />
        <createSequence sequenceName="cpq_commercial_rule_header_seq" />
        <createSequence sequenceName="cpq_commercial_rule_item_seq" />
        <createSequence sequenceName="cpq_commercial_rule_line_seq" />
        <createSequence sequenceName="cpq_grouped_service_seq" />
        <createSequence sequenceName="cpq_product_mapping_seq" />
        <createSequence sequenceName="cpq_accounting_article_seq" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-01">
        <createTable tableName="cpq_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="status" type="varchar(255)" />
            <column name="status_date" type="datetime" />
            <column name="product_line_id" type="bigint" />
            <column name="customer_brand_id" type="bigint" />
            <column name="reference" type="varchar(50)"/>
            <column name="model" type="varchar(20)"/>
            <column name="discount_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="package_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>
    </changeSet>




    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-04">
        <createTable tableName="cpq_product_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="long_description" type="text" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
            <column name="parent_line" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-05">
        <createTable tableName="cpq_product_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_version_pkey" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="version" type="int4" />
            <column name="status" type="varchar(255)" />
            <column name="status_date" type="datetime" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="short_description" type="varchar(255)" />
            <column name="long_description" type="text" />
            <column name="start_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="product_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="current_version" type="int4" >
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-06">
        <createTable tableName="cpq_tag">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
            <column name="name" type="varchar(255)" />
            <column name="tag_type_id" type="bigint" />
            <column name="parent_tag_id" type="bigint" />
            <column name="filter_el" type="varchar(2000)"/>
            <column name="attribute_id" type="bigint" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-07">
        <createTable tableName="cpq_tag_filter">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_filter_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="tag_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="entity" type="varchar(255)" />
            <column name="field" type="varchar(255)" />
            <column name="comparaison" type="varchar(255)" />
            <column name="value" type="varchar(255)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-08">
        <createTable tableName="cpq_tag_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_tag_type_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="seller_id" type="bigint" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-10">
        <createTable tableName="cpq_media">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_media_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="media_name" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="main" type="${type.boolean}" defaultValueNumeric="1">
                <constraints nullable="false" />
            </column>
            <column name="media_type" type="varchar(50)" />
            <column name="media_path" type="varchar(50)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-13">
        <createTable tableName="cpq_offer_component">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_offer_component_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-14">
        <createTable tableName="cpq_commercial_rule_header">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_header_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="rule_type" type="varchar(50)" />
            <column name="offer_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
            <column name="grouped_service_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="target_attribute_value" type="varchar(255)" />
            <column name="tag_id" type="bigint" />
            <column name="rule_el" type="varchar(2000)" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-15">
        <createTable tableName="cpq_commercial_rule_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_item_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="commercial_rule_header_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="rule_item_el" type="varchar(2000)" />
        </createTable>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-16">
        <createTable tableName="cpq_commercial_rule_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_commercial_rule_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="offer_template_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="commercial_rule_item_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="tag_id" type="bigint" />
            <column name="operator" type="varchar(255)" />
            <column name="source_attribute_value" type="varchar(255)" />
            <column name="source_grouped_attribute_value" type="varchar(255)" />
            <column name="value" type="varchar(255)" />
        </createTable>
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-19">
        <createTable tableName="cpq_offer_component_tags">
            <column name="offer_component_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_offer_component_tags_pkey" tableName="cpq_offer_component_tags" />

        <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="offer_component_id"
                                 constraintName="cpq_offer_component_tags_offer_component_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_component_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_component_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-20">
        <createTable tableName="cpq_grouped_service">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_grouped_service_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="product_version_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false" />
            </column>
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false" />
            </column>
            <column name="sequence" type="INT4" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-29">
        <createTable tableName="cpq_product_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_product_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="service1Value" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="product_id" type="bigint" />
            <column name="attribute_1" type="bigint" />
            <column name="attribute_1_value" type="varchar(100)" />
            <column name="attribute_2" type="bigint" />
            <column name="attribute_2_value" type="varchar(100)" />
            <column name="attribute_3" type="bigint" />
            <column name="attribute_3_value" type="varchar(100)" />
            <column name="accounting_article_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />

        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-30">
        <createTable tableName="cpq_accounting_article">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true"
                             primaryKeyName="cpq_accounting_article_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-01">
        <addForeignKeyConstraint baseColumnNames="product_line_id" baseTableName="cpq_product" constraintName="fk_1y8p1q0o8tw5u0vcodfukdbez" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
    </changeSet>
    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-02">
        <addForeignKeyConstraint baseColumnNames="customer_brand_id" baseTableName="cpq_product" constraintName="fk_5iap1p3o8tw5u0vcodazokdub" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer_brand" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-03">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_product_line" constraintName="fk_1ykj5q0o8tw5u0vcodpoqljca" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-04">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag_type" constraintName="fk_9axk5q0o8nddo2vcodpoqlopq" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-05">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_tag" constraintName="fk_oop625q0o8tw5u0vcodospq5c" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-06">
        <addForeignKeyConstraint baseColumnNames="parent_line" baseTableName="cpq_product_line" constraintName="fk_bnrqyk9sqqcnt5m298cpbfrqo3" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_line" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-07">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_version" constraintName="fk_pomyp8vq0o8t5u0vcodpoaopq" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-08">
        <addForeignKeyConstraint baseColumnNames="tag_type_id" baseTableName="cpq_tag" constraintName="fk_pomyppo52t5u0vcodpolcm" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag_type" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-09">
        <addForeignKeyConstraint baseColumnNames="parent_tag_id" baseTableName="cpq_tag" constraintName="fk_pomjqq6n5u0vcodkopm" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-10">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovooi1" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-11">
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_media" constraintName="fk_op1zppqjdn5vabcipq5" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-17">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_offer_component" constraintName="fk_sspl5q1jj6jdakklqp" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>



    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-19">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_iw510u1o6ndaphf4" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-20">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_ii50ihu1qzsqikh2bo" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-21">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_nh50ihuoo32sqijo5v" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-22">
        <addForeignKeyConstraint baseColumnNames="commercial_rule_item_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_rule_item_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_item" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-23">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_nhi85o6nnipl087" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_commercial_rule_header_rule_item">
        <addForeignKeyConstraint baseColumnNames="commercial_rule_header_id" baseTableName="cpq_commercial_rule_item" constraintName="fk_commercial_rule_header_rule_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_rule_header" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-24">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_ggi871iihn0ii77" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-25">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_omk25ihukik058ijj20" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-26">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_hhokb05o32yhp50" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet id="21112020-540-23-entity-quoteCustomerService" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_lot">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_lot_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="quote_version" type="int4" >
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(50)" />
            <column name="duration" type="int4" />
            <column name="execution_date" type="datetime" />
            <column name="cpq_quote_version_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>




    <changeSet id="21112020-540-23-entity-quoteProduct" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_product_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="quote_version_id" type="bigint" />
            <column name="quote_lot_id" type="bigint" />
            <column name="offer_component_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="product_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="numeric(23, 12)" />
            <column name="cpq_quote_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet id="21112020-540-23-entity-quoteVersion" author="TarikFAKHOURI">
        <createTable tableName="cpq_quote_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_version_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="cpq_quote_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quote_version" type="int4" >
                <constraints nullable="false"/>
            </column>
            <column name="status" type="varchar(20)"  >
                <constraints nullable="false"/>
            </column>
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="start_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="billing_plan_code" type="varchar(20)" />
        </createTable>
    </changeSet>


    <changeSet id="22112020-540-23-entity-contract" author="TarikFAKHOURI">
        <createTable tableName="cpq_contract">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="seller_id" type="bigint" />
            <column name="billing_account_id" type="bigint" />
            <column name="customer_account_id" type="bigint" />
            <column name="customer_id" type="bigint" />
            <column name="status" type="varchar(20)" >
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="contract_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="begin_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="end_date" type="date">
                <constraints nullable="false" />
            </column>
            <column name="renewal" type="${type.boolean}">
                <constraints nullable="false" />
            </column>
            <column name="contract_duration" type="int4" />
        </createTable>
    </changeSet>


    <changeSet id="22112020-540-23-entity-contract-item" author="TarikFAKHOURI">
        <createTable tableName="cpq_contract_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_contract_item_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />

            <column name="cpq_contract_id" type="bigint" />
            <column name="offer_template_id" type="bigint" />
            <column name="cpq_product_id" type="bigint" />
            <column name="price_plan_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="rate" type="int4" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
        </createTable>
    </changeSet>

    <changeSet id="540-30_20201023_PricePlanMatrixItem" author="TarikF">
        <createTable tableName="cpq_price_plan_matrix_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_item_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="dim1_value" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="dim2_value" type="varchar(50)" />
            <column name="dim3_value" type="varchar(50)" />
            <column name="price_without_tax" type="numeric(23, 12)" />
        </createTable>
    </changeSet>

    <changeSet id="540-31_20201023_PricePlanVersion" author="TarikF">
        <createTable tableName="cpq_price_plan_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_version_pkey" />
            </column>
            <column name="label" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="current_version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="ppm_id" type="bigint" />
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_el" type="varchar(255)" />
            <column name="amount_with_tax_el" type="varchar(255)" />
            <column name="is_matrix" type="${type.boolean}"/>
            <column name="priority" type="int4" defaultValueNumeric="0"/>
        </createTable>
    </changeSet>

    <changeSet id="540-15_20201019_servicetype" author="TarikF">
        <createTable tableName="cpq_service_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_service_type_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="service_type" type="varchar(100)">
                <constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>



    <changeSet id="current-str-fk-32" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_product" constraintName="fk_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
    </changeSet>

    <changeSet id="current-str-fk-33" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="offer_component_id" baseTableName="cpq_quote_product" constraintName="fk_offer_component_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_offer_component" />
    </changeSet>

    <changeSet id="current-str-fk-34" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_quote_product" constraintName="fk_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="current-str-fk-43" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet id="current-str-fk-44" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
    </changeSet>

    <changeSet id="current-str-fk-45" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />
    </changeSet>

    <changeSet id="current-str-fk-46" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="customer_id" baseTableName="cpq_contract" constraintName="fk_cpq_contract_customer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_customer" />
    </changeSet>


    <changeSet id="current-str-fk-47" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="cpq_contract_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />
    </changeSet>
    <changeSet id="current-str-fk-48" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>
    <changeSet id="current-str-fk-49" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="cpq_product_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_cpq_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>
    <changeSet id="current-str-fk-50" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="price_plan_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_price_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>
    <changeSet id="current-str-fk-51" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_charge_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
    </changeSet>
    <changeSet id="current-str-fk-52" author="TarikFAKHOURI">
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_contract_item" constraintName="fk_cpq_contract_item_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-28">
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_service" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-29">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_mapping" constraintName="fk-product-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-30">
        <addForeignKeyConstraint baseColumnNames="attribute_1" baseTableName="cpq_product_mapping" constraintName="fk1-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>
    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-31">
        <addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk2-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-32">
        <addForeignKeyConstraint baseColumnNames="attribute_2" baseTableName="cpq_product_mapping" constraintName="fk3-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-33">
        <addForeignKeyConstraint baseColumnNames="attribute_3" baseTableName="cpq_product_mapping" constraintName="fk4-service_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-35">
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_mapping" constraintName="fk-charge_template-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-36">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_tag_filter" constraintName="fk-tag-tag_filter" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-40">
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_cpq_tag_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />
    </changeSet>

    <changeSet author="NabilOuachi" id="rebuild-mediapost-fk-41">
        <addForeignKeyConstraint baseColumnNames="ppm_id" baseTableName="cpq_price_plan_version" constraintName="fk_cpq_price_pla_version_price_plan_matrix" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>

    <changeSet id="#5595_20201023" author="Mbarek-Ay">
        <addColumn tableName="cat_service_template">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="product_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="grouped_service_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="service_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_service_template">
            <column name="mandatory" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="priority" type="int4" defaultValueNumeric="0" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="param" type="text" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="material" type="${type.boolean}" />
        </addColumn>

        <addColumn tableName="cat_service_template">
            <column name="accounting_article_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_service_template" constraintName="fk-product-service_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_service_template" constraintName="fk-product-offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="grouped_service_id" baseTableName="cat_service_template" constraintName="fk-product-grouped_service" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_service" />


        <addForeignKeyConstraint baseColumnNames="service_type_id" baseTableName="cat_service_template" constraintName="fk-product-service_type" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_service_type" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_service_template" constraintName="fk-product-accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_accounting_article" />


    </changeSet>

    <changeSet id="#5595_#32_20201023" author="Mbarek-Ay">
        <addColumn tableName="cat_charge_template">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="product_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="service_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_charge_template">
            <column name="price_plan_matrix_id" type="bigint" />
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="recurrence_duration_enum" type="varchar(20)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="duration_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="recurrence_calendar" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="calendar_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="usage_service_template_id" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="surcharge" type="${type.boolean}"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="price_matrix" type="${type.boolean}"/>
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="param1" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param1_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param2" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param2_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param3" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param3_service_id" type="bigint"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param4" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="param4_service_id" type="bigint"/>
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim1_matrix_service" type="bigint" />
        </addColumn>


        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim2_matrix_service" type="bigint" />
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix" type="varchar(50)"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_bystep" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="cat_charge_template">
            <column name="dim3_matrix_service" type="bigint" />
        </addColumn>


        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cat_charge_template" constraintName="fk-product-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cat_charge_template" constraintName="fk-offer_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cat_charge_template" constraintName="fk1-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_charge_template" constraintName="fk-price_plan-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />

        <addForeignKeyConstraint baseColumnNames="duration_service" baseTableName="cat_charge_template" constraintName="fk2-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="recurrence_calendar" baseTableName="cat_charge_template" constraintName="fk-cat_calendar-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_calendar" />


        <addForeignKeyConstraint baseColumnNames="calendar_service" baseTableName="cat_charge_template" constraintName="fk3-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="usage_service_template_id" baseTableName="cat_charge_template" constraintName="fk4-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param1_service_id" baseTableName="cat_charge_template" constraintName="fk5-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk6-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />


        <addForeignKeyConstraint baseColumnNames="param2_service_id" baseTableName="cat_charge_template" constraintName="fk7-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="param3_service_id" baseTableName="cat_charge_template" constraintName="fk8-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="param4_service_id" baseTableName="cat_charge_template" constraintName="fk9-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim1_matrix_service" baseTableName="cat_charge_template" constraintName="fk10-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim2_matrix_service" baseTableName="cat_charge_template" constraintName="fk11-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="dim3_matrix_service" baseTableName="cat_charge_template" constraintName="fk12-service_template-charge_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
    </changeSet>

    <changeSet id="#5595_18_20201102" author="Mbarek-Ay">
        <addColumn tableName="cat_offer_template">
            <column name="product_status" type="varchar(50)"/>
            <column name="status_date" type="datetime" />
        </addColumn>
    </changeSet>

    <changeSet id="#5595-36-20201103" author="Mbarek-Ay">
        <addColumn tableName="cpq_tag">
            <column name="product_version_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="service_template_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="offer_template_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_tag" constraintName="fk_product_version_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_tag" constraintName="fk_service_template_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_tag" constraintName="fk_offer_template_version_tag" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet id="#5595_49_20201118" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_version">
            <column name="short_description" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="#43-20201113">
        <createTable tableName="cpq_offer_template_tags">
            <column name="offer_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="offer_template_id"
                                 constraintName="cpq_offer_template_tags_offer_template_id_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_offer_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_offer_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <createTable tableName="cpq_service_template_tags">
            <column name="service_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="service_template_id,tag_id" constraintName="service_template_tag_pkey" tableName="cpq_service_template_tags" />

        <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="service_template_id"
                                 constraintName="cpq_service_template_tags_offer_template_id_fk" referencedTableName="cat_service_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_service_template_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_service_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <createTable tableName="cpq_product_version_tags">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="product_version_id"
                                 constraintName="cpq_product_version_tags_offer_template_id_fk" referencedTableName="cpq_product_version"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_product_version_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_product_version_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>

        <dropColumn tableName="cpq_tag">
            <column name="product_version_id"></column>
            <column name="service_template_id"></column>
            <column name="offer_template_id"></column>
        </dropColumn>

    </changeSet>
    <changeSet id="#5596-20201113" author="Rachid.AIT">
        <createTable tableName="cpq_product_discount_plan">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="discount_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <createTable tableName="cpq_product_version_services">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="service_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <createTable tableName="cpq_product_model_children">
            <column name="product_id" type="bigint" />
            <column name="model_chlidren" type="varchar(100)" />
        </createTable>
        <addPrimaryKey columnNames="product_id,model_chlidren" constraintName="cpq_product_model_children_pkey" tableName="cpq_product_model_children" />

        <addUniqueConstraint columnNames="product_id,discount_id" constraintName="cpq_product_discount_plan_pkey" tableName="cpq_product_discount_plan" />
        <addUniqueConstraint columnNames="product_version_id,service_template_id" constraintName="cpq_product_services_pkey" tableName="cpq_product_version_services" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_product_version_services" constraintName="fk_cpq_product_version_services_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

    </changeSet>

    <changeSet id="#5569_54052_20201117" author="TarikFAKHOURI">

        <createSequence sequenceName="cpq_quote_article_line_seq" />

        <createTable tableName="cpq_quote_article_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_quote_article_line_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
            <column name="billable_account_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="quantity" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
            <column name="service_quantity" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addColumn tableName="cat_service_template">
            <column name="sequence" type="INT4" />
            <column name="display" type="${type.boolean}" />
        </addColumn>

    </changeSet>


    <changeSet author="Mbarek-Ay" id="#51-20201123">
        <dropColumn tableName="cpq_quote_product">
            <column name="offer_component_id"/>
        </dropColumn>

    </changeSet>

    <changeSet id="#65-20201127" author="TarikFAKHOURI">

        <createSequence sequenceName="quote_offer_seq" />

        <createTable tableName="quote_offer">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_offer_seq" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="offer_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="billable_account_id" type="bigint" />
            <column name="quote_version_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="quote_customer_service_id" type="bigint" />
            <column name="sequence" type="INT4" />
            <column name="contract_code" type="varchar(50)" />
            <column name="position" type="int4" />

        </createTable>

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="quote_offer" constraintName="fk_quote_offer_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="quote_offer" constraintName="fk_quote_offer_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
        <addForeignKeyConstraint baseColumnNames="quote_customer_service_id" baseTableName="quote_offer" constraintName="fk_quote_offer_quote_customer_service_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />

        <addColumn tableName="cpq_quote_product">
            <column name="offer_quote_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="offer_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_offer_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
    </changeSet>

    <changeSet id="540-66-20201201" author="TarikFA">
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_component" constraintName="fk_cpq_offer_component_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>

    <changeSet id="540-69-20201202" author="TarikFA">

        <createSequence sequenceName="cpq_attribute_seq" />
        <createSequence sequenceName="cpq_grouped_attributes_seq" />

        <createTable tableName="cpq_attribute">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute" />
            </column>
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="disabled" type="${type.boolean}">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="parent_id" type="bigint" />
            <column name="grouped_attributes_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="sequence" type="int4" />
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_type" type="varchar(100)" />
            <column name="unit_nb_decimal" type="int4" />
        </createTable>

        <createTable tableName="cpq_grouped_attributes">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_grouped_attributes" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="product_version_id" type="bigint" />
            <column name="mandatory" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="display" type="${type.boolean}" >
                <constraints nullable="false"/>
            </column>
            <column name="sequence" type="int4" />
        </createTable>

        <createTable tableName="cpq_attribute_allowed_values">
            <column name="attribute_id" type="bigint" />
            <column name="allowed_values" type="varchar(100)" />
        </createTable>

        <createTable tableName="cpq_product_version_attributes">
            <column name="product_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="cpq_service_template_attributes">
            <column name="service_template_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>




        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_grouped_attributes_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute" constraintName="fk_cpq_attribute_parent_attributes_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_grouped_attributes" constraintName="fk_cpq_grouped_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addPrimaryKey columnNames="attribute_id,allowed_values" constraintName="cpq_attribute_allowed_values_pkey" tableName="cpq_attribute_allowed_values" />
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_allowed_values" constraintName="fk_cpq_attribute_allowed_values_attribute_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product_version_attributes" constraintName="cpq_product_version_attributes_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />


        <addPrimaryKey columnNames="service_template_id,attribute_id" constraintName="cpq_service_template_attributes_pkey" tableName="cpq_service_template_attributes" />
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_service_template_attributes" constraintName="cpq_service_template_attributes_serviceTemplate_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

    </changeSet>

    <changeSet id="540-75-20201203" author="TarikFA">

        <createSequence sequenceName="cpq_quote_seq" />

        <createTable tableName="cpq_quote">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" />
            <column name="contract_id" type="bigint" />
            <column name="status_version" type="int4" />
            <column name="status" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="status_date" type="datetime" />
            <column name="send_date" type="datetime" />
            <column name="quote_date" type="datetime" />
            <column name="prestation_date_begin" type="datetime" />
            <column name="prestation_duration" type="int4" />
            <column name="opportunity_ref" type="varchar(50)" />
            <column name="customer_ref" type="varchar(50)" />
            <column name="customer_name" type="varchar(52)" />
            <column name="contact_name" type="varchar(52)" />
            <column name="register_number" type="varchar(50)" />
            <column name="sales_person_name" type="varchar(52)" />
            <column name="billable_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="applicant_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="quote_number" type="varchar(50)" />
            <column name="invoice_type_id" type="bigint" />
            <column name="pdf_filename" type="varchar(255)" />
            <column name="xml_filename" type="varchar(255)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billable_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_billable_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="applicant_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_applicant_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_product" constraintName="fk_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_quote_product" constraintName="fk_cpq_quote_product_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_version_id" baseTableName="cpq_quote_lot" constraintName="fk_cpq_quote_lot_cpq_quote_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />

    </changeSet>

    <changeSet id="#5569_124_20200118" author="NabilOUACHI">


        <createSequence sequenceName="cpq_quote_price_seq" startValue="1" />
        <createTable tableName="cpq_quote_price">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_quote_price" />
            </column>
            <!-- Auditable Start -->
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="quote_article_line_id" type="bigint" />
            <column name="quote_version_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="price_level" type="varchar(50)" />
            <column name="price_type" type="varchar(50)" />

            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="unit_price_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
            <column name="tax_amount" type="numeric(23, 12)" />
            <column name="tax_rate" type="numeric(23, 12)" />

            <column name="price_over_charged" type="${type.boolean}" />


            <column name="currency_code" type="varchar(25)" />

            <column name="recurrence_duration" type="int8" />


            <column name="recurrence_periodicity" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="quote_article_line_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_article_Line" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_article_line" />
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_quote_version" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />


    </changeSet>

    <changeSet id="current-str-fk-35" author="TarikFAKHOURI">


        <createSequence sequenceName="cpq_quote_attribute_seq" />

        <createTable tableName="cpq_quote_attribute">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_quote_attribute" />
            </column>
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="cpq_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="cpq_quote_product_id" type="bigint" />
            <column name="string_value" type="varchar(255)" />
            <column name="double_value" type="float8" />
            <column name="date_value" type="datetime" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_product_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="540-84-20201209" author="TarikFa">
        <!-- 	    	<addUniqueConstraint columnNames="cpq_attribute_id,cpq_quote_product_id" tableName="cpq_quote_attribute" constraintName="uniquekey_attribute_quote_product_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <!-- 	    	<addUniqueConstraint columnNames="offer_template_id,quote_version_id" tableName="quote_offer" constraintName="uniquekey_offer_template_quote_version_id_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <!-- 	    	<addUniqueConstraint columnNames="product_version_id,offer_quote_id" tableName="cpq_quote_product" constraintName="uniquekey_product_version_offer_quote_ids" deferrable="false" initiallyDeferred="false" disabled="false"/> -->
        <addUniqueConstraint columnNames="cpq_quote_id,quote_version" tableName="cpq_quote_version" constraintName="uniquekey_pquote_id_cpq_quote_id,quote_version" deferrable="false" initiallyDeferred="false" disabled="false"/>

    </changeSet>

    <changeSet id="540-83-20201211" author="Mbarek-Ay">
        <createTable
                tableName="cpq_product_version_grouped_attributes">
            <column name="product_version_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="grouped_attributes_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey
                columnNames="product_version_id,grouped_attributes_id"
                constraintName="cpq_product_version_grouped_attributes_pkey"
                tableName="cpq_product_version_grouped_attributes" />
        <addForeignKeyConstraint
                baseColumnNames="grouped_attributes_id"
                baseTableName="cpq_product_version_grouped_attributes"
                constraintName="cpq_product_version_grouped__attribute_id"
                deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                onUpdate="NO ACTION" referencedColumnNames="id"
                referencedTableName="cpq_grouped_attributes" />

        <addForeignKeyConstraint
                baseColumnNames="product_version_id"
                baseTableName="cpq_product_version_grouped_attributes"
                constraintName="cpq_product_version_grouped_attributes_product_version_id"
                deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                onUpdate="NO ACTION" referencedColumnNames="id"
                referencedTableName="cpq_product_version" />

        <addColumn tableName="cpq_product_version">
            <column name="valid_from" type="datetime"></column>
            <column name="valid_to" type="datetime"></column>
        </addColumn>
    </changeSet>
    <!-- end MediaPost -->
    <changeSet id = "#FEAT-761-2020-10-19" author = "ZBariki">
        <createSequence sequenceName="billing_accounting_article_seq" startValue="1" />
        <createTable tableName="billing_accounting_article" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name ="analytic_code_1" type="varchar(255)"></column>
            <column name ="analytic_code_2" type="varchar(255)"></column>
            <column name ="analytic_code_3" type="varchar(255)"></column>
            <column name="tax_class_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_sub_category_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_id" type="bigint"/>
            <column name="accounting_code_id" type="bigint" />
            <column name="description_i18n" type="${type.json}"></column>

            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>

        <createSequence sequenceName="billing_article_family_seq" startValue="1" />
        <createTable tableName="billing_article_family" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_family_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="uuid" type="varchar(60)" />
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="accounting_code_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_family_ref_id" type="bigint" />
            <column name="cf_values" type="${type.json}"/>
            <column name="cf_values_accum" type="${type.json}"/>
            <column name="description_i18n" type="${type.json}"></column>
        </createTable>

        <createSequence sequenceName="billing_article_mapping_seq" startValue="1" />
        <createTable tableName="billing_article_mapping" >
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mapping_script_id" type="bigint" />
        </createTable>

        <createSequence sequenceName="billing_article_mapping_line_seq" startValue="1" />
        <createTable tableName="billing_article_mapping_line">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_article_mapping_line_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="code" type="varchar(50)" />
            <column name="description" type="varchar(255)" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>
            <column name="article_mapping_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="offer_template_id" type="bigint"></column>
            <column name="charge_template_id" type="bigint"></column>
            <column name="product_id" type="bigint"></column>

            <column name="parameter_1" type="varchar(255)"/>
            <column name="parameter_2" type="varchar(255)"/>
            <column name="parameter_3" type="varchar(255)"/>
            <column name="mapping_key_el" type="varchar(255)"/>
        </createTable>

        <createSequence sequenceName="billing_attribute_mapping_seq" startValue="1" />
        <createTable tableName="billing_attribute_mapping">
            <column name="id" type="bigint">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_attribute_mapping_pk"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="creator" type="varchar(50)"/>
            <column name="updater" type="varchar(50)"/>
            <column name="updated" type="datetime"/>

            <column name="article_mapping_line_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint">
                <constraints nullable="false"/>
            </column>

            <column name="attribute" type="varchar(30)"/>
            <column name="attribute_value" type="varchar(255)"/>
        </createTable>


        <addColumn tableName="billing_rated_transaction">
            <column name="article_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="tax_class_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_tax_class" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax_class" />
        <addForeignKeyConstraint baseColumnNames="invoice_sub_category_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_invoice_sub_category" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice_sub_cat" />
        <addForeignKeyConstraint baseColumnNames="article_family_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_article_family" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_accounting_article"
                                 constraintName="fk_billing_accounting_article_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_accounting_code" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />
        <addForeignKeyConstraint baseColumnNames="article_family_ref_id" baseTableName="billing_article_family"
                                 constraintName="fk_billing_article_family_article_family_ref" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_family" />

        <addForeignKeyConstraint baseColumnNames="mapping_script_id" baseTableName="billing_article_mapping"
                                 constraintName="fk_billing_article_mapping_mapping_script" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />

        <addForeignKeyConstraint baseColumnNames="article_mapping_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article_mapping" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_article_mapping" />

        <addForeignKeyConstraint baseColumnNames="article_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_article" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_charge_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_charge_template" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_service_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="billing_article_mapping_line"
                                 constraintName="fk_billing_article_mapping_line_product_template" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="article_id"
                                 constraintName="rated_transaction_article_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="article_mapping_line_id"
                                 constraintName="attribute_mapping_article_mapping_line_fk" referencedTableName="billing_article_mapping_line"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_attribute_mapping" baseColumnNames="attribute_id"
                                 constraintName="attribute_mapping_attribute_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-tbl-">
        <createTable tableName="cpq_billing_account_tags">
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_component_id,tag_id" constraintName="cpq_billing_account_tags_pkey" tableName="cpq_offer_component_tags" />
        <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="billing_account_id"
                                 constraintName="cpq_billing_account_tags_billing_account_id_fk" referencedTableName="billing_billing_account"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_billing_account_tags" baseColumnNames="tag_id"
                                 constraintName="cpq_billing_account_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet author="Mbarek-Ay" id="current-mediapost-tbl-charge_attribute">
        <createTable tableName="cpq_attribute_charge">
            <column name="charge_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="attribute_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="charge_id,attribute_id" constraintName="cpq_attribute_charge_pkey" tableName="cpq_attribute_charge" />
        <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="charge_id"
                                 constraintName="cpq_attribute_charge_charge_id_fk" referencedTableName="cat_charge_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cpq_attribute_charge" baseColumnNames="attribute_id"
                                 constraintName="cpq_attribute_charge_attribute_id_fk" referencedTableName="cpq_attribute"
                                 referencedColumnNames="id"/>
    </changeSet>


    <changeSet id="#REF_INV_20201223" author="MohammedELAZZOUZI">
        <addColumn tableName="cat_discount_plan_item">
            <column name="accounting_article_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cat_discount_plan_item" constraintName="fk__cat_discount_plan_item__accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addColumn tableName="cat_discount_plan_item">
            <column name="priorty" type="bigint"></column>
        </addColumn>

        <addColumn tableName="quote_offer">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="quote_offer" constraintName="fk__quote_offer__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote" constraintName="fk__ord_quote__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cpq_quote_product">
            <column name="discount_plan_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_product" constraintName="fk__cpq_quote_product__cat_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-27">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_media" constraintName="fk_co5zjq6jdn5vcovoo51" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-41">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_header" constraintName="fk_attribute_trade_rule_header" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-39">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_attribute_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>


    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk_grouped_attributes_commercial_rule_line">
        <addForeignKeyConstraint baseColumnNames="grouped_attributes_id" baseTableName="cpq_commercial_rule_line" constraintName="fk_grouped_attributes_commercial_rule_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />
    </changeSet>

    <changeSet id="540-103-add-swagger-docs-to-All-ChargeTemplates" author="TarikFA.">
        <createTable tableName="cpq_offer_attributes">
            <column name="offer_template_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
        </createTable>

        <addPrimaryKey columnNames="offer_template_id,attribute_id," tableName="cpq_offer_attributes"/>

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_offer_attributes" constraintName="fk_cpq_offer_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>


    <changeSet id="#540-100-20201225" author="TarikFA">

        <createSequence sequenceName="cpq_commercial_order_seq" />
        <createSequence sequenceName="cpq_order_type_seq" />
        <createSequence sequenceName="cpq_order_item_seq" />
        <createSequence sequenceName="cpq_order_product_seq" />
        <createSequence sequenceName="cpq_order_lot_seq" />
        <createSequence sequenceName="cpq_order_offer_seq" />
        <createSequence sequenceName="order_article_line_seq" />
        <createSequence sequenceName="cpq_order_invoice_seq" />
        <createSequence sequenceName="cpq_invoice_line_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_seq" />
        <createSequence sequenceName="cpq_invoicing_plan_item_seq" />

        <createTable tableName="cpq_commercial_order">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_commercial_order" />
            </column>
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="version" type="int" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_number" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="billing_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="cpq_quote_id" type="bigint" />
            <column name="contract_id" type="bigint" />
            <column name="status" type="varchar(50)" >
                <constraints nullable="false"/>
            </column>
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="order_progress" type="int" >
                <constraints nullable="false"/>
            </column>
            <column name="progress_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="order_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="realisation_date" type="datetime" />
            <column name="customer_service_begin" type="datetime" />
            <column name="customer_service_duration" type="int" />
            <column name="external_reference" type="varchar(50)" />
            <column name="order_parent_id" type="bigint" />
            <column name="order_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoicing_plan_id" type="bigint" />
            <column name="invoice_type_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="user_account_id" type="bigint" />
            <column name="access_id" type="bigint" />
        </createTable>

        <createTable tableName="cpq_commercial_order_billing_invoice">
            <column name="commercial_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="invoice_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="commercial_order_id,invoice_id" tableName="cpq_commercial_order_billing_invoice"/>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_commercial_order_billing_invoice" constraintName="fk_cpq_commercial_order_billing_invoice_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />


        <createTable tableName="cpq_invoicing_plan">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
        </createTable>
        <createTable tableName="cpq_order_type">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_type" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
        </createTable>


        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_contract_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />

        <addForeignKeyConstraint baseColumnNames="order_type_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_type" />

        <addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_invoicing_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

        <addForeignKeyConstraint baseColumnNames="order_parent_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_order_parent_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


        <createTable tableName="cpq_order_item">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_item" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->


            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_lot_id" type="bigint" />
            <column name="order_product_id" type="bigint" />
            <column name="access_point" type="varchar(20)" />
            <column name="attribute_id" type="bigint" />

            <column name="string_value" type="varchar(255)" />
            <column name="date_value" type="datetime" />
            <column name="double_value" type="float8" />

        </createTable>

        <createTable tableName="cpq_order_product">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_product" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_service_commercial_id" type="bigint" />
            <column name="order_offer_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="product_version_id" type="bigint" />
            <column name="quantity" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createTable tableName="cpq_order_lot">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_lot" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_lot_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_service_commercial_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="order_product_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_product" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_order_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <createTable tableName="cpq_order_offer">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_offer" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="offer_template_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <!-- foreign key for Order Product  Start -->

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_service_commercial_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_service_commercial_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_order_offer_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <!-- foreign key for Order Product  End -->

        <!--  Creation table order_article_Line (OrderArticleLine) -->
        <createTable tableName="order_article_line">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_article_line" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_customer_service_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="quantity" type="numeric(23, 12)">
                <constraints nullable="false"/>
            </column>
            <column name="quantity_service" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="os_unit_price_without_tax" type="numeric(23, 12)" />
            <column name="os_price_without_tax" type="numeric(23, 12)" />
            <column name="os_tax_code" type="numeric(23, 12)" />
            <column name="os_tax_rate" type="int" />
            <column name="os_price_with_tax" type="numeric(23, 12)" />
            <column name="rc_unit_price_without_tax" type="numeric(23, 12)" />
            <column name="rc_price_without_tax" type="numeric(23, 12)" />
            <column name="rc_tax_code" type="numeric(23, 12)" />
            <column name="rc_tax_rate" type="int" />
            <column name="rc_price_with_tax" type="numeric(23, 12)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="order_customer_service_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_order_customer_service_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="order_article_line" constraintName="fk_order_article_Line_accounting_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <createSequence sequenceName="order_price_seq" startValue="1" />
        <createTable tableName="order_price">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_order_price" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="order_article_line_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="order_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="price_level" type="varchar(50)" />
            <column name="price_type" type="varchar(50)" />

            <column name="amount_with_tax" type="numeric(23, 12)" />
            <column name="unit_price_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax" type="numeric(23, 12)" />
            <column name="amount_without_tax_with_discount" type="numeric(23, 12)" />
            <column name="tax_amount" type="numeric(23, 12)" />
            <column name="tax_rate" type="numeric(23, 12)" />

            <column name="price_over_charged" type="${type.boolean}" />


            <column name="currency_code" type="varchar(25)" />

            <column name="recurrence_duration" type="int8" />


            <column name="recurrence_periodicity" type="varchar(50)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="order_article_line_id" baseTableName="order_price" constraintName="fk_order_price_order_article_Line" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_article_line" />
        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="order_price" constraintName="fk_order_price_order_commercial_order" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <createTable tableName="cpq_order_invoice">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_order_invoice" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="seller_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="billing_account_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_ref" type="varchar(20)" />
            <column name="status" type="varchar(20)" />
            <column name="status_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="invoice_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="due_date" type="datetime" >
                <constraints nullable="false"/>
            </column>
            <column name="begin_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="amount_without_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_with_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="payment_method_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="pdf_link" type="varchar(255)" />
            <column name="commercial_order_id" type="bigint" />
        </createTable>

        <createTable tableName="cpq_order_invoice_access_point_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="access_point_list" type="varchar(100)" />
        </createTable>

        <createTable tableName="cpq_order_invoice_order_ref_list">
            <column name="order_invoice_id" type="bigint" />
            <column name="order_ref_list" type="varchar(100)" />
        </createTable>

        <addPrimaryKey columnNames="order_invoice_id,access_point_list" constraintName="cpq_order_invoice_access_point_list_pkey" tableName="cpq_order_invoice_access_point_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_access_point_list" constraintName="fk_cpq_order_invoice_access_point_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />


        <addPrimaryKey columnNames="order_invoice_id,order_ref_list" constraintName="cpq_order_invoice_order_ref_list_pkey" tableName="cpq_order_invoice_order_ref_list" />

        <addForeignKeyConstraint baseColumnNames="order_invoice_id" baseTableName="cpq_order_invoice_order_ref_list" constraintName="fk_cpq_order_invoice_order_ref_list_order_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_seller_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_billing_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />

        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="payment_method_id" baseTableName="cpq_order_invoice" constraintName="fk_cpq_order_invoice_payment_method_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_token" />

        <createTable tableName="cpq_invoice_line">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoice_line" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="invoice_id" type="bigint" />
            <column name="prestation" type="varchar(255)" />
            <column name="accounting_article_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="offer_service_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="service_template_id" type="bigint" />
            <column name="begin_date" type="datetime" />
            <column name="end_date" type="datetime" />
            <column name="quantity" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="unit_price" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="discount_rate" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="amount_without_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="tax_rate" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_with_tax" type="numeric(23, 12)" >
                <constraints nullable="false"/>
            </column>
            <column name="amount_tax" type="numeric(23, 12)"  >
                <constraints nullable="false"/>
            </column>
            <column name="discount_plan_id" type="bigint"  />
            <column name="tax_id" type="bigint"  />
            <column name="order_ref" type="varchar(20)"  />
            <column name="access_point" type="varchar(20)"  />
            <column name="commercial_order_id" type="bigint"  />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_invoice" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="offer_service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_offer_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_serv_templates" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_tax_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <createTable tableName="cpq_invoicing_plan_item">

            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_invoicing_plan_item" />
            </column>
            <!-- BusinessEntity Start -->
            <column name="code" type="varchar(255)" >
                <constraints nullable="false" unique="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <!-- BusinessEntity End -->
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="billing_plan_id" type="bigint" >
                <constraints nullable="false" />
            </column>

            <column name="advancement" type ="int4">
                <constraints nullable="false" />
            </column>
            <column name="rate_to_bill" type="numeric(23, 12)" >
                <constraints nullable="false" />
            </column>
        </createTable>


        <addForeignKeyConstraint baseColumnNames="billing_plan_id" baseTableName="cpq_invoicing_plan_item" constraintName="fk_cpq_invoicing_plan_item_billing_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan" />

        <addColumn tableName="billing_subscription">
            <column name="commercial_order_id" type="bigint" />
            <column name="prestation" type="varchar(255)" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />


        <addColumn tableName="billing_wallet_operation">
            <column name="order_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" />
            <column name="order_lot_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
        </addColumn>


        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wallet_operation_order_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

        <addColumn tableName="billing_rated_transaction">
            <column name="order_id" type="bigint" />
            <column name="accounting_article_id" type="bigint" />
            <column name="order_lot_id" type="bigint" />
            <column name="product_version_id" type="bigint" />
        </addColumn>



        <addForeignKeyConstraint baseColumnNames="order_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_product_version_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

    </changeSet>

    <changeSet id="20201230_pricematrix" author="NabilOuachi">
        <createSequence sequenceName="cpq_price_plan_matrix_column_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_column">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_column_pkey" />
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="ppm_version_id" type="bigint" />
            <column name="position" type ="int4"/>
            <column name="type" type="varchar(255)"/>

            <column name="el_value" type="varchar(255)"/>

            <column name="product_id" type="bigint" />
            <column name="offer_id" type="bigint" />
            <column name="attribute_id" type="bigint" />
            <column name="is_range" type="${type.boolean}" defaultValueNumeric="0"/>
        </createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_value_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_value">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_price_plan_matrix_value_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="ppm_column_id" type="bigint" />

            <column name="ppml_id" type="bigint" />

            <column name="long_value" type ="int8"/>
            <column name="double_value" type ="float8"/>
            <column name="string_value" type="varchar(255)"/>

            <column name="date_value" type="datetime"/>
            <column name="from_date_value" type="datetime"/>
            <column name="to_date_value" type="datetime"/>

            <column name="from_double_value" type ="float8"/>
            <column name="to_double_value" type ="float8"/>

        </createTable>

        <createSequence sequenceName="cpq_price_plan_matrix_line_sq" startValue="1" />
        <createTable tableName="cpq_price_plan_matrix_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_price_plan_matrix_line" />
            </column>
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->
            <column name="version" type="int4" />

            <column name="ppm_version_id" type="bigint" />
            <column name="priority" type="int4" defaultValueNumeric="0"/>

            <column name="description" type="varchar(255)"/>
            <column name="price_without_tax" type="numeric(23, 12)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_ppm_version" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_attribute" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="offer_id" baseTableName="cpq_price_plan_matrix_column" constraintName="fk_price_plan_matrix_column_offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />

        <addForeignKeyConstraint baseColumnNames="ppm_column_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_column" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_column" />

        <addForeignKeyConstraint baseColumnNames="ppml_id" baseTableName="cpq_price_plan_matrix_value" constraintName="fk_price_plan_matrix_value_price_plan_matrix_line" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_matrix_line" />

        <addForeignKeyConstraint baseColumnNames="ppm_version_id" baseTableName="cpq_price_plan_matrix_line" constraintName="fk_price_plan_matrix_line_price_plan_matrix_version" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_price_plan_version" />

    </changeSet>

    <changeSet id="20201230-ticket5870" author="NabilOUACHI">
        <createSequence sequenceName="cpq_product_charge_template_mapping_seq" startValue="1" />

        <createTable tableName="cat_product_wallet_template_1">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="wallet_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, wallet_template_id" constraintName="cat_product_wallet_template_1_pkey" tableName="cat_product_wallet_template_1" />

        <createTable tableName="cat_product_counter_template">
            <column name="product_templt_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="counter_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="indx" type="int4">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="product_templt_id, counter_template_id" constraintName="cat_product_counter_template_pkey" tableName="cat_product_counter_template" />

        <createTable tableName="cpq_product_charge_template_mapping">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_product_charge_template_mapping_pkey" />
            </column>
            <column name="version" type="int4" />

            <column name="product_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="counter_template_id" type="bigint" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_product" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_charge" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cpq_product_charge_template_mapping" constraintName="fk_product_charge_template_mapping_counter" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="wallet_template_id" baseTableName="cat_product_wallet_template_1" constraintName="fk_cat_product_wallet_template_product_wallet_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_wallet_template" />

        <addForeignKeyConstraint baseColumnNames="product_templt_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_product_charge_template_mapping" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_charge_template_mapping" />

        <addForeignKeyConstraint baseColumnNames="counter_template_id" baseTableName="cat_product_counter_template" constraintName="fk_cat_product_counter_template_cat_counter_template" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_counter_template" />
    </changeSet>

    <changeSet id="540-112-20210107" author="TarikF">
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_invoice_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>
    <changeSet id="20210113" author="TarikF">

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />


        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="cpq_product_mapping" constraintName="fk-accounting_article-product_mapping" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

    </changeSet>

    <changeSet author="Mbarek-Ay" id="rebuild-mediapost-fk-attribute_tag">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_tag" constraintName="fk_tag_attribute" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
    </changeSet>

    <changeSet id="540-139-20012020" author="NabilOUACHI">


        <createSequence sequenceName="cpq_attribute_instance_seq" />

        <createTable tableName="cpq_attribute_instance">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_cpq_attribute_instance" />
            </column>
            <column name="version" type="int4" />
            <!-- Auditable Start -->
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <!-- Auditable End -->

            <column name="cpq_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="service_instance_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="subscription_id" type="bigint" >
                <constraints nullable="false"/>
            </column>

            <column name="string_value" type="varchar(255)" />
            <column name="double_value" type="float8" />
            <column name="date_value" type="datetime" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="cpq_attribute_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_cpq_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_service_instance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />

        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_attribute_instance" constraintName="fk_cpq_attribute_instance_subscription_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
    </changeSet>
    <changeSet id="#20210121-540-128" author="TarikFA">

        <addColumn tableName="cpq_quote_article_line">
            <column name="quote_product_id" type="bigint" />
            <column name="quote_lot_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
        <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_quote_article_line" constraintName="fk_cpq_quote_article_line_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />
    </changeSet>
    <changeSet id="#20210122-540-128" author="TarikFA">

        <addColumn tableName="billing_service_instance">
            <column name="product_version_id" type="bigint" />
            <column name="quote_product_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version" />
        <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="billing_service_instance" constraintName="fk_cpq_quote_product_serviceInstance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="#20210127-540-190" author="TarikFA">
        <addForeignKeyConstraint baseColumnNames="access_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_access_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="medina_access" />
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>

    <changeSet id="Invoice_lines_job_20200114" author="ZBariki">
        <addColumn tableName="cpq_invoice_line">
            <column name="billing_run_id" type="bigint"/>
            <column name="billing_account_id" type="bigint"/>
            <column name="label" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="raw_amount" type="numeric">
                <constraints nullable="false"/>
            </column>
            <column name="value_date" type="datetime" />
            <column name="order_number" type="varchar(255)" />
            <column name="discount_amount" type="numeric">
                <constraints nullable="false"/>
            </column>
            <column name="subscription_id" type="bigint"/>
            <column name="service_instance_id" type="bigint"/>
            <column name="offer_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_run_id"
                                 constraintName="billing_invoice_line_billing_run_id_fk"
                                 referencedTableName="billing_billing_run" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="billing_account_id"
                                 constraintName="billing_billing_account_id_fk"
                                 referencedTableName="billing_billing_account" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="service_instance_id"
                                 constraintName="billing_service_instance_id_fk"
                                 referencedTableName="billing_service_instance" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="subscription_id"
                                 constraintName="billing_subscription_id_fk"
                                 referencedTableName="billing_subscription" referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="offer_template_id"
                                 constraintName="billing_offer_template_id_fk"
                                 referencedTableName="cat_offer_template" referencedColumnNames="id"/>
    </changeSet>
    <changeSet id="#5916_20210128" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_invoice_line">
            <column name="order_lot_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="order_lot_id"
                                 constraintName="cpq_invoice_line__order_lot__fk"
                                 referencedTableName="cpq_order_lot" referencedColumnNames="id"/>
        <addColumn tableName="cpq_invoice_line">
            <column name="product_version_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_invoice_line" baseColumnNames="product_version_id"
                                 constraintName="cpq_invoice_line__product_version__fk"
                                 referencedTableName="cpq_product_version" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#5937_20210204" author="TarikFA">
        <addColumn tableName="cat_charge_template">
            <column name="attribute_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_id"
                                 constraintName="fk_cat_charge_template_attribute_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#214_20210203" author="NabilOUACHI">
        <addColumn tableName="cpq_quote_price">
            <column name="charge_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_quote_price" baseColumnNames="charge_template_id"
                                 constraintName="fk_cpq_quote_price_charge_template_id"
                                 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
        <addColumn tableName="order_price">
            <column name="charge_template_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="order_price" baseColumnNames="charge_template_id"
                                 constraintName="fk_order_price_charge_template_id"
                                 referencedTableName="cat_charge_template" referencedColumnNames="id"/>
        <addColumn tableName="order_article_line">
            <column name="order_product_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="order_article_line" baseColumnNames="order_product_id"
                                 constraintName="fk_order_article_line_order_product_id"
                                 referencedTableName="cpq_order_product" referencedColumnNames="id"/>

        <addColumn tableName="cpq_commercial_order">
            <column name="rate_invoiced" type="int">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>
            <![CDATA[
				alter table cpq_invoice_line alter column invoice_id drop not null;
				alter table cpq_quote_price alter column quote_article_line_id drop not null;
				alter table cpq_order_item drop column code;
				alter table cpq_order_item drop column description;
				alter table cpq_order_item rename column attribute_id to cpq_attribute_id;
			]]>
        </sql>
    </changeSet>

    <changeSet id="20210204_540" author="TarikFA">
        <addColumn tableName="cat_charge_template">
            <column name="attribute_duration_id" type="bigint"/>
            <column name="attribute_calendar_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_duration_id"
                                 constraintName="fk_cat_charge_templat_attribute_duration_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="cat_charge_template" baseColumnNames="attribute_calendar_id"
                                 constraintName="fk_cat_charge_template_attribute_calendar_id"
                                 referencedTableName="cpq_attribute" referencedColumnNames="id"/>

    </changeSet>
    <changeSet id="Invoice_lines_job_202001145" author="ZBariki">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyName="fk_cpq_invoice_line_invoice_id"/>
        </preConditions>
        <dropForeignKeyConstraint baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id"/>
        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="cpq_invoice_line"
                                 constraintName="fk_cpq_invoice_line_invoice_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>
    <changeSet id="Invoicing_job_20210205_45" author="ZBariki">
        <addColumn tableName="cpq_invoice_line">
            <column name="status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="invoice_line_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoice_line_id" baseTableName="billing_rated_transaction"
                                 constraintName="fk_billing_rated_transaction_invoice_line_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
    </changeSet>
    <changeSet id="#20210205_540_223" author="TarikFA">
        <modifyDataType tableName="cpq_media" columnName="media_path" newDataType="varchar(255)"/>
        <modifyDataType tableName="cpq_media" columnName="media_name" newDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="#5938_20210205" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_invoice">
            <column name="new_invoicing_process" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#20210209_540177" author="TarikFA">
        <addColumn tableName="cpq_product">
            <column name="product_version_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_product"
                                 constraintName="fk_cpq_product_product_version_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="#20210215-248" author="NabilOUACHI">
        <addColumn tableName="cpq_attribute_instance">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_quote_attribute">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_order_item">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_attribute_instance"
                                 constraintName="fk_cpq_attribute_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_attribute_instance" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_quote_attribute"
                                 constraintName="fk_cpq_quote_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_quote_attribute" />

        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="cpq_order_item"
                                 constraintName="fk_cpq_order_instance_parent_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_order_item" />

    </changeSet>

    <changeSet id="#20210212_540238" author="TarikFA">
        <addUniqueConstraint columnNames="code,ppm_version_id" tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
    </changeSet>

    <changeSet id="#5950_20210210" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_billing_run">
            <column name="minimum_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="threshold_checked" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="discount_applied" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>


    <changeSet id="#246_20210212" author="Mbarek-Ay">
        <addColumn tableName="cpq_invoicing_plan">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_commercial_order">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_product_line">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote_lot">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_order_lot">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_contract_item">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_contract">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_grouped_attributes">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_invoicing_plan_item">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="disabled" type="${type.boolean}"
                    defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="quote_offer">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote_product">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>


        <addColumn tableName="cpq_order_product">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>


        <addColumn tableName="cpq_order_offer">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_quote">
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>

        <addColumn tableName="cpq_media">
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </addColumn>
    </changeSet>

    <changeSet id="#248_20210215" author="NabilOuachi">
        <sql>
            <![CDATA[
					alter table cpq_order_offer drop column code;
					alter table cpq_order_offer drop column description;
					alter table cpq_order_product drop column code;
					alter table cpq_order_product drop column description;
					alter table cpq_order_item alter column order_id drop not null;
					alter table cpq_attribute_instance alter column service_instance_id drop not null;
					alter table cpq_attribute_instance alter column subscription_id drop not null;
				]]>
        </sql>
    </changeSet>

    <changeSet id="#20200215-247" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_attribute">
            <column name="cpq_quote_offer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
    </changeSet>

    <changeSet id="#20210217_260" author="TarikFA">
        <dropTable tableName="cpq_product_mapping"/>
    </changeSet>

    <changeSet id="#5952_20210210" author="ZBariki">
        <addColumn tableName="crm_customer">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="ar_customer_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_billing_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_user_account">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_subscription">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>
        <addColumn tableName="cat_offer_template">
            <column name="minimum_article_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="crm_customer"
                                 constraintName="fk_crm_customer_iminimum_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="ar_customer_account"
                                 constraintName="fk_ar_customer_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_billing_account"
                                 constraintName="fk_billing_billing_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_user_account"
                                 constraintName="fk_billing_user_account_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_subscription"
                                 constraintName="fk_billing_subscription_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="billing_service_instance"
                                 constraintName="fk_billing_service_instance_minimum_article_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
        <addForeignKeyConstraint baseColumnNames="minimum_article_id" baseTableName="cat_offer_template"
                                 constraintName="fk_cat_offer_template_minimum_article_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_article" />
    </changeSet>

    <changeSet id="#268_20210219_cpq_structure" author="Mbarek-Ay">
        <dropNotNullConstraint columnName="tax_class_id" tableName="cat_charge_template"/>
    </changeSet>


    <changeSet id="#222_20210219" author="Mbarek-Ay">
        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-26, 0, 0, now(), 'org.meveo.api.billing.QuoteValidation', 'QuoteValidation', 'JAVA', '
package org.meveo.api.billing;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.Hashtable;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import org.meveo.admin.exception.BusinessException;
import org.meveo.model.billing.BillingAccount;
import org.meveo.model.cpq.CpqQuote;
import org.meveo.model.cpq.QuoteAttribute;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.CommercialOrderEnum;
import org.meveo.model.cpq.commercial.OrderArticleLine;
import org.meveo.model.cpq.commercial.OrderAttribute;
import org.meveo.model.cpq.commercial.OrderLot;
import org.meveo.model.cpq.commercial.OrderOffer;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.model.cpq.commercial.OrderType;
import org.meveo.model.cpq.offer.QuoteOffer;
import org.meveo.model.quote.QuoteArticleLine;
import org.meveo.model.quote.QuoteLot;
import org.meveo.model.quote.QuoteProduct;
import org.meveo.model.quote.QuoteVersion;
import org.meveo.security.CurrentUser;
import org.meveo.security.MeveoUser;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.cpq.QuoteVersionService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderArticleLineService;
import org.meveo.service.cpq.order.OrderAttributeService;
import org.meveo.service.cpq.order.OrderLotService;
import org.meveo.service.cpq.order.OrderOfferService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.cpq.order.OrderProductService;
import org.meveo.service.cpq.order.OrderTypeService;
import org.meveo.service.cpq.order.QuotePriceService;
import org.meveo.service.crm.impl.CurrentUserProducer;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class QuoteValidation extends ModuleScript {

	private final static Logger LOGGER = LoggerFactory.getLogger(QuoteVersionService.class);

	private QuoteVersionService quoteVersionService = (QuoteVersionService) getServiceInterface(QuoteVersionService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private OrderOfferService orderOfferService = (OrderOfferService) getServiceInterface(OrderOfferService.class.getSimpleName());
    private OrderProductService orderProductService = (OrderProductService) getServiceInterface(OrderProductService.class.getSimpleName());
    private OrderAttributeService orderAttributeService = (OrderAttributeService) getServiceInterface(OrderAttributeService.class.getSimpleName());
    private OrderLotService orderCustomerServiceService = (OrderLotService) getServiceInterface(OrderLotService.class.getSimpleName());
    private OrderArticleLineService orderArticleLineService = (OrderArticleLineService) getServiceInterface(OrderArticleLineService.class.getSimpleName());
    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private QuotePriceService quotePriceService = (QuotePriceService) getServiceInterface(QuotePriceService.class.getSimpleName());
    private OrderTypeService orderTypeService = (OrderTypeService) getServiceInterface(OrderTypeService.class.getSimpleName());
    private MeveoUser currentUser = ((CurrentUserProducer) getServiceInterface(CurrentUserProducer.class.getSimpleName())).getCurrentUser();


	@Override
	public void execute(Map<String, Object> methodContext) throws BusinessException {
		final CpqQuote cpqQuote = (CpqQuote) methodContext.get("cpqQuote");
		if(cpqQuote == null)
			throw new BusinessException("No Quote found");
		LOGGER.info("start creation order from quote code {}", cpqQuote.getCode());
		var quotesVersions = quoteVersionService.findByQuoteIdAndStatusActive(cpqQuote.getId());
		if(quotesVersions.size() > 1)
			throw new BusinessException("More than one quote version is published !!");
		var quoteVersion = quotesVersions.get(0);
		var orderByBillingAccount = new Hashtable<String, List<QuoteOffer>>();
		var billingAccount = new Hashtable<String, BillingAccount>();
		quoteVersion.getQuoteOffers().forEach(quoteOffer -> {
			if(quoteOffer.getBillableAccount() == null) {
				quoteOffer.setBillableAccount(cpqQuote.getBillableAccount());
			}
			List<QuoteOffer> offers = new ArrayList<>();
			if(orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode()) != null) {
				offers = orderByBillingAccount.get(quoteOffer.getBillableAccount().getCode());
			}
			offers.add(quoteOffer);
			orderByBillingAccount.put(quoteOffer.getBillableAccount().getCode(), offers);
			billingAccount.put(quoteOffer.getBillableAccount().getCode(), quoteOffer.getBillableAccount());

		});
		orderByBillingAccount.keySet().forEach(ba -> {
			List<QuoteOffer> offers = orderByBillingAccount.get(ba);
			BillingAccount billableAccount = billingAccount.get(ba);
			CommercialOrder order = processCommercialOrder(cpqQuote, quoteVersion, billableAccount);
			offers.forEach(offer -> {
				processOrderOffer(offer, order);
				OrderLot orderLot = processOrderCustomerService(offer.getQuoteLot(), order);
				OrderOffer orderOffer = processOrderOffer(offer, order);
				offer.getQuoteProduct().forEach(quoteProduct -> {
					processOrderProduct(quoteProduct, order, orderLot, orderOffer);
				});
			});
		});
		LOGGER.info("End creation order from quote code {}, number of order created is {}", cpqQuote.getCode(), orderByBillingAccount.size());


	}
	private CommercialOrder processCommercialOrder(CpqQuote cpqQuote, QuoteVersion quoteVersion, BillingAccount account) {
		CommercialOrder order = new CommercialOrder();
		order.setSeller(cpqQuote.getSeller());
		order.setBillingAccount(account);
		order.setQuote(cpqQuote);
		order.setContract(cpqQuote.getContract());
		order.setCustomerServiceBegin(quoteVersion.getStartDate());
		order.setStatus(CommercialOrderEnum.DRAFT.toString());
		Date now = Calendar.getInstance().getTime();
		order.setStatusDate(now);
		order.setOrderDate(now);
		order.setCustomerServiceDuration(cpqQuote.getQuoteLotDuration());
		order.setExternalReference(null);
		order.setInvoicingPlan(quoteVersion.getInvoicingPlan());
		order.setOrderType(createOrderTypeTemp()); //TODO: how to map order type
		order.setOrderProgress(0);
		order.setOrderInvoiceType(invoiceTypeService.getDefaultCommercialOrder());
		order.setProgressDate(Calendar.getInstance().getTime());
		order.setUserAccount(account.getUsersAccounts().size() > 0 ? account.getUsersAccounts().get(0) : null);
		order.setDiscountPlan(cpqQuote.getDiscountPlan());
		commercialOrderService.create(order);
		return order;
	}

	private OrderType createOrderTypeTemp() {
		final String TEMP_CODE = "COMMERCIAL";
		OrderType orderType = orderTypeService.findByCode(TEMP_CODE);
		if(orderType == null) {
			orderType = new OrderType();
			orderType.setCode(TEMP_CODE);
			orderType.setDescription("generated on quote validation  script");
			orderTypeService.create(orderType);
		}
		return orderType;
	}

	private OrderOffer processOrderOffer(QuoteOffer quoteOffer, CommercialOrder order) {
		OrderOffer offer = new OrderOffer();
		offer.setOrder(order);
		offer.setOfferTemplate(quoteOffer.getOfferTemplate());
		offer.setDiscountPlan(quoteOffer.getDiscountPlan());
		orderOfferService.create(offer);
		return offer;
	}

	private OrderProduct processOrderProduct(QuoteProduct product, CommercialOrder commercialOrder, OrderLot orderLot, OrderOffer orderOffer) {
		OrderProduct orderProduct = new OrderProduct();
		orderProduct.setOrder(commercialOrder);
		orderProduct.setOrderServiceCommercial(orderLot);
		orderProduct.setProductVersion(product.getProductVersion());
		orderProduct.setQuantity(product.getQuantity());
		orderProduct.setDiscountPlan(product.getDiscountPlan());
		orderProduct.setOrderOffer(orderOffer);

		orderProductService.create(orderProduct);

		product.getQuoteAttributes().forEach(quoteAttribute -> {
			processOrderAttribute(quoteAttribute, commercialOrder, orderLot, orderProduct);
		});

		product.getQuoteArticleLines().forEach(quoteArticleLine -> {
			OrderArticleLine orderArticleLine = processOrderArticleLine(quoteArticleLine, commercialOrder, orderLot, orderProduct);
			processOrderPrice(quoteArticleLine.getId(), orderArticleLine, commercialOrder, product.getQuoteOffer().getQuoteVersion());
		});


		return orderProduct;
	}

	private void processOrderAttribute(QuoteAttribute quoteAttribute, CommercialOrder commercialOrder, OrderLot orderLot, OrderProduct orderProduct) {
		OrderAttribute orderAttribute = new OrderAttribute(quoteAttribute, currentUser);
		orderAttribute.setCommercialOrder(commercialOrder);
		orderAttribute.setOrderLot(orderLot);
		orderAttribute.setOrderProduct(orderProduct);
		orderAttribute.setAccessPoint(null);
		orderAttributeService.create(orderAttribute);
	}

	private OrderLot processOrderCustomerService(QuoteLot quoteLot, CommercialOrder commercialOrder) {
		OrderLot orderCustomer = new OrderLot();
		orderCustomer.setCode(UUID.randomUUID().toString());
		orderCustomer.setCode(orderCustomerServiceService.findDuplicateCode(orderCustomer));
		orderCustomer.setOrder(commercialOrder);
		orderCustomerServiceService.create(orderCustomer);
		return orderCustomer;
	}

	private OrderArticleLine processOrderArticleLine(QuoteArticleLine quoteArticleLine, CommercialOrder commercialOrder, OrderLot orderCustomerService, OrderProduct orderProduct) {
		OrderArticleLine articleLine = new OrderArticleLine();
		articleLine.setCode(orderArticleLineService.findDuplicateCode(articleLine));
		articleLine.setOrder(commercialOrder);
		articleLine.setOrderCustomerService(orderCustomerService);
		articleLine.setQuantity(quoteArticleLine.getQuantity());
		articleLine.setQuantityService(quoteArticleLine.getServiceQuantity());
		articleLine.setAccountingArticle(quoteArticleLine.getAccountingArticle());
		articleLine.setOrderProduct(orderProduct);
		orderArticleLineService.create(articleLine);
		return articleLine;
	}

	private void processOrderPrice(Long quoteArticleLineId, OrderArticleLine orderArticleLine, CommercialOrder commercialOrder, QuoteVersion quoteVersion) {
		var quotePrices = quotePriceService.findByQuoteArticleLineIdandQuoteVersionId(quoteArticleLineId, quoteVersion.getId());
		quotePrices.forEach( price -> {
			OrderPrice orderPrice = new OrderPrice();
			orderPrice.setCode(UUID.randomUUID().toString());
			orderPrice.setCode(orderPriceService.findDuplicateCode(orderPrice));
			orderPrice.setOrderArticleLine(orderArticleLine);
			orderPrice.setOrder(commercialOrder);
			orderPrice.setPriceLevelEnum(price.getPriceLevelEnum());
			orderPrice.setAmountWithTax(price.getAmountWithTax());
			orderPrice.setUnitPriceWithoutTax(price.getUnitPriceWithoutTax());
			orderPrice.setAmountWithoutTax(price.getAmountWithoutTax());
			orderPrice.setAmountWithoutTaxWithDiscount(price.getAmountWithoutTaxWithDiscount());
			orderPrice.setTaxAmount(price.getTaxAmount());
			orderPrice.setTaxRate(price.getTaxRate());
			orderPrice.setPriceOverCharged(price.getPriceOverCharged());
			orderPrice.setCurrencyCode(price.getCurrencyCode());
			orderPrice.setRecurrenceDuration(price.getRecurrenceDuration());
			orderPrice.setRecurrencePeriodicity(price.getRecurrencePeriodicity());
			orderPrice.setChargeTemplate(price.getChargeTemplate());
			orderPriceService.create(orderPrice);
		});
	}

}

	');
        ]]></sql>



        <sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-27, 0, 0, now(), 'org.meveo.api.billing.OrderAdvancement', 'OrderAdvancement', 'JAVA', '
  package org.meveo.api.billing;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.time.LocalDate;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import org.meveo.admin.exception.BusinessException;
import org.meveo.api.cpq.CommercialOrderApi;
import org.meveo.api.exception.EntityDoesNotExistsException;
import org.meveo.commons.utils.ParamBean;
import org.meveo.model.article.AccountingArticle;
import org.meveo.model.billing.Invoice;
import org.meveo.model.billing.InvoiceType;
import org.meveo.model.catalog.ChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplate;
import org.meveo.model.catalog.OneShotChargeTemplateTypeEnum;
import org.meveo.model.cpq.Attribute;
import org.meveo.model.cpq.AttributeValue;
import org.meveo.model.cpq.Product;
import org.meveo.model.cpq.commercial.CommercialOrder;
import org.meveo.model.cpq.commercial.InvoiceLine;
import org.meveo.model.cpq.commercial.InvoicingPlanItem;
import org.meveo.model.cpq.commercial.OrderPrice;
import org.meveo.model.cpq.commercial.OrderProduct;
import org.meveo.service.billing.impl.InvoiceLinesService;
import org.meveo.service.billing.impl.InvoiceService;
import org.meveo.service.billing.impl.InvoiceTypeService;
import org.meveo.service.billing.impl.article.AccountingArticleService;
import org.meveo.service.cpq.order.CommercialOrderService;
import org.meveo.service.cpq.order.OrderPriceService;
import org.meveo.service.script.module.ModuleScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@SuppressWarnings("serial")
public class OrderAdvancement extends ModuleScript {

    private OrderPriceService orderPriceService = (OrderPriceService) getServiceInterface(OrderPriceService.class.getSimpleName());
    private CommercialOrderService commercialOrderService = (CommercialOrderService) getServiceInterface(CommercialOrderService.class.getSimpleName());
    private CommercialOrderApi commercialOrderApi = (CommercialOrderApi) getServiceInterface(CommercialOrderApi.class.getSimpleName());
    private AccountingArticleService accountingArticleService = (AccountingArticleService) getServiceInterface(AccountingArticleService.class.getSimpleName());
    private InvoiceLinesService invoiceLinesService = (InvoiceLinesService) getServiceInterface(InvoiceLinesService.class.getSimpleName());
    private InvoiceService invoiceService = (InvoiceService) getServiceInterface(InvoiceService.class.getSimpleName());
    private InvoiceTypeService invoiceTypeService = (InvoiceTypeService) getServiceInterface(InvoiceTypeService.class.getSimpleName());
    private Logger log = LoggerFactory.getLogger(this.getClass());


    @Override
    public void execute(Map<String, Object> methodContext) throws BusinessException {
        CommercialOrder commercialOrder = (CommercialOrder) methodContext.get("commercialOrder");
        if(commercialOrder == null) {
            throw new BusinessException("No Commercial order is found");
        }
        Integer orderProgress = commercialOrder.getOrderProgress();

        if (commercialOrder.getInvoicingPlan() != null) {

            Date nextDay = java.sql.Date.valueOf(LocalDate.now().plusDays(1));
            Date firstTransactionDate = java.sql.Date.valueOf(LocalDate.now().minusDays(1));
            Date invoiceDate = new Date();
            List<OrderPrice> pricesToBill = orderPriceService.findByOrder(commercialOrder).stream()
                    .filter(this::isPriceRelatedToOneShotChargeTemplateOfTypeOther)
                    .collect(Collectors.toList());

            if (pricesToBill.isEmpty()) {
                log.info("No order prices to bill related to a one shot charge were found for commercial order: " + commercialOrder.getId());
                return;
            }

            AccountingArticle defaultAccountingArticle = getDefaultAccountingArticle();

            BigDecimal totalAmountWithoutTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithoutTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalAmountWithTax = pricesToBill.stream()
                    .map(OrderPrice::getAmountWithTax)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTax = pricesToBill.stream()
                    .map(OrderPrice::getTaxAmount)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            BigDecimal totalTaxRate = pricesToBill.stream()
                    .map(OrderPrice::getTaxRate)
                    .reduce(BigDecimal.valueOf(0), BigDecimal::add);

            OrderProduct orderProduct = pricesToBill.get(0).getOrderArticleLine().getOrderProduct();

            if(orderProgress == 100) {
                if(commercialOrder.getRateInvoiced() < 100) {
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                    commercialOrder.setOrderProgressTmp(orderProgress);
                    commercialOrder.setRateInvoiced(100);
                }
                commercialOrderApi.validateOrder(commercialOrder, true);
            } else {
                List<InvoicingPlanItem> itemsToBill = commercialOrder.getInvoicingPlan().getInvoicingPlanItems().stream()
                        .filter(item -> item.getAdvancement() == orderProgress)
                        .collect(Collectors.toList());

                if (itemsToBill.isEmpty()) {
                    log.info("No invoicing plan item found for the order progress: " + orderProgress + " commercial order id: " + commercialOrder.getId());
                    return;
                } else if (itemsToBill.size() > 1)
                    throw new BusinessException("Many invoicing plan items are set for the advancement: " + orderProgress + " using the invoicing plan: " + commercialOrder.getInvoicingPlan().getCode());

                InvoicingPlanItem invoicingPlanItem = itemsToBill.get(0);

                BigDecimal newRateInvoiced = invoicingPlanItem.getRateToBill().add(BigDecimal.valueOf(commercialOrder.getRateInvoiced()));
                if (newRateInvoiced.compareTo(BigDecimal.valueOf(100)) > 0) {
                    throw new BusinessException("the invoicing plan rate is grater than remaining rate to invoice");
                }
                if(newRateInvoiced.compareTo(BigDecimal.valueOf(100)) == 0){
                    generateGlobalInvoice(commercialOrder, nextDay, firstTransactionDate, invoiceDate, defaultAccountingArticle, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate, orderProduct);
                }else {
                    BigDecimal amountWithoutTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithoutTax);
                    BigDecimal amountWithTaxToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalAmountWithTax);
                    BigDecimal taxAmountToBeInvoiced = invoicingPlanItem.getRateToBill().divide(BigDecimal.valueOf(100).setScale(8, RoundingMode.HALF_UP)).multiply(totalTax);

                    createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
                    List<Invoice> invoices=invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,true);
                }
                commercialOrder.setRateInvoiced(newRateInvoiced.intValue());
                commercialOrder.setOrderProgressTmp(orderProgress);
                commercialOrderService.update(commercialOrder);
            }
        }


    }

    private void generateGlobalInvoice(CommercialOrder commercialOrder, Date nextDay, Date firstTransactionDate, Date invoiceDate, AccountingArticle defaultAccountingArticle, BigDecimal totalAmountWithoutTax, BigDecimal totalAmountWithTax, BigDecimal totalTax, BigDecimal totalTaxRate, OrderProduct orderProduct) {
        Map<String, Object> attributes = new HashMap<String, Object>();
        List<AttributeValue> orderAttributes = orderProduct.getOrderAttributes().stream().map(oa -> (AttributeValue)oa).collect(Collectors.toList());
        for (AttributeValue orderAttribute : orderAttributes) {
            Attribute attribute = orderAttribute.getAttribute();
            Object value = attribute.getAttributeType().getValue(orderAttribute);
            if (value != null) {
                attributes.put(orderAttribute.getAttribute().getCode(), value);
            }
        }
        Product product = orderProduct.getProductVersion().getProduct();
        Optional<AccountingArticle> accountingArticle = accountingArticleService.getAccountingArticle(product, attributes);
        if (!accountingArticle.isPresent())
            throw new BusinessException("No accounting article found for product code: " + product.getCode() + " and attributes: " + attributes.toString());

        List<InvoiceLine> accounts = invoiceLinesService.findByCommercialOrder(commercialOrder);
        for(InvoiceLine account : accounts){
            createInvoiceLine(commercialOrder, defaultAccountingArticle, orderProduct, account.getAmountWithoutTax().negate(), account.getAmountWithTax().negate(), account.getAmountTax().negate(), account.getTaxRate());
        }

        createInvoiceLine(commercialOrder, accountingArticle.get(), orderProduct, totalAmountWithoutTax, totalAmountWithTax, totalTax, totalTaxRate);
        invoiceService.createAggregatesAndInvoiceWithIL(commercialOrder, null, null, invoiceDate, firstTransactionDate, nextDay, null, false, false,false);

    }

    private AccountingArticle getDefaultAccountingArticle() {
        String articleCode = ParamBean.getInstance().getProperty("advancePayment.accountingArticleCode", "ACT-STD");

        AccountingArticle accountingArticle = accountingArticleService.findByCode(articleCode);
        if (accountingArticle == null)
            throw new EntityDoesNotExistsException(AccountingArticle.class, articleCode);
        return accountingArticle;
    }

    private void createInvoiceLine(CommercialOrder commercialOrder, AccountingArticle accountingArticle, OrderProduct orderProduct, BigDecimal amountWithoutTaxToBeInvoiced, BigDecimal amountWithTaxToBeInvoiced, BigDecimal taxAmountToBeInvoiced, BigDecimal totalTaxRate) {
        invoiceLinesService.createInvoiceLine(commercialOrder, accountingArticle, orderProduct.getProductVersion(),orderProduct.getOrderServiceCommercial(), amountWithoutTaxToBeInvoiced, amountWithTaxToBeInvoiced, taxAmountToBeInvoiced, totalTaxRate);
    }

    private boolean isPriceRelatedToOneShotChargeTemplateOfTypeOther(OrderPrice price) {
        return price.getChargeTemplate().getChargeMainType() == ChargeTemplate.ChargeMainTypeEnum.ONESHOT
                && ((OneShotChargeTemplate) price.getChargeTemplate()).getOneShotChargeTemplateType() == OneShotChargeTemplateTypeEnum.OTHER;
    }


}



	');
        ]]></sql>

    </changeSet>

    <changeSet id="#270_20210222" author="Mbarek-Ay">
        <addColumn tableName="cpq_media">
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
        </addColumn>
        <dropColumn tableName="cpq_media">
            <column name="product_id"></column>
            <column name="offer_id"></column>
            <column name="attribute_id"></column>
            <column name="service_template_id"></column>
        </dropColumn>

        <createTable tableName="cpq_offer_template_media">
            <column name="offer_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="offer_template_id,media_id" constraintName="cpq_offer_template_media_pkey" tableName="cpq_offer_template_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_offer_template_media"
                baseColumnNames="offer_template_id"
                constraintName="cpq_offer_template_media_offer_template_id_fk"
                referencedTableName="cat_offer_template" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_offer_template_media" baseColumnNames="media_id"
                constraintName="cpq_offer_template_media_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />


        <createTable tableName="cpq_product_media">
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="product_id,media_id" constraintName="cpq_product_media_pkey" tableName="cpq_product_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_product_media"
                baseColumnNames="product_id"
                constraintName="cpq_product_media_product_id_fk"
                referencedTableName="cpq_product" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_product_media" baseColumnNames="media_id"
                constraintName="cpq_product_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />


        <createTable tableName="cpq_attribute_media">
            <column name="attribute_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="media_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addUniqueConstraint columnNames="attribute_id,media_id" constraintName="cpq_attribute_media_pkey" tableName="cpq_attribute_media" />
        <addForeignKeyConstraint
                baseTableName="cpq_attribute_media"
                baseColumnNames="attribute_id"
                constraintName="cpq_attribute_media_attribute_id_fk"
                referencedTableName="cpq_attribute" referencedColumnNames="id" />

        <addForeignKeyConstraint
                baseTableName="cpq_attribute_media" baseColumnNames="media_id"
                constraintName="cpq_attribute_media_id_fk"
                referencedTableName="cpq_media" referencedColumnNames="id" />

    </changeSet>





    <changeSet id="#20210222_540_269" author="TarikFA.">
        <dropColumn tableName="cpq_grouped_attributes">
            <column name="product_version_id"></column>
        </dropColumn>

        <dropColumn tableName="cpq_attribute">
            <column name="grouped_attributes_id"></column>
        </dropColumn>

        <createTable tableName="cpq_grouped_attributes_attribute">
            <column name="grouped_attributes" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>


        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="grouped_attributes" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_groupedattribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />

    </changeSet>

    <changeSet id="#20210222_540_269" author="TarikFA.">
        <dropColumn tableName="cpq_grouped_attributes">
            <column name="product_version_id"></column>
        </dropColumn>

        <dropColumn tableName="cpq_attribute">
            <column name="grouped_attributes_id"></column>
        </dropColumn>

        <createTable tableName="cpq_grouped_attributes_attribute">
            <column name="grouped_attributes" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>


        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="grouped_attributes" baseTableName="cpq_grouped_attributes_attribute" constraintName="fk_cpq_grouped_attributes_attribute_groupedattribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_grouped_attributes" />

    </changeSet>

    <changeSet id="#20210123_540_280" author="TarikFA.">

        <addColumn tableName="adm_secured_entity">
            <column name="disable" type="boolean" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>

        <addColumn tableName="adm_role_secured_entity">
            <column name="disable" type="boolean" defaultValueNumeric="0" >
                <constraints nullable="false" />
            </column>
        </addColumn>

    </changeSet>


    <changeSet   id="#20210123_540_281" author="TarikFA.">
        <addColumn tableName="adm_role">
            <column name="uuid" type="varchar(60)" defaultValue="" />
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="created" type="datetime" defaultValueDate="now()">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updated" type="datetime" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
        <sql>update ${db.schema.adapted}adm_role set uuid = 'role'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>
    </changeSet>

    <changeSet id="#20210224_5868" author="Mbarek-Ay">
        <addColumn tableName="cpq_commercial_order">
            <column name="oneshot_total_amount" type="numeric(23, 12)" />
        </addColumn>
        <dropForeignKeyConstraint baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_cpq_quote_offer_id"/>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_offer_id" baseTableName="cpq_quote_attribute" constraintName="fk_cpq_quote_attribute_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
    </changeSet>

    <changeSet id="#20210222_907" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="has_taxes" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="has_discounts" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="has_minimum" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20210302_540" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id"/>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_product_version_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version" />
    </changeSet>

    <changeSet id="#20210303_540305" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="cat_service_template" constraintName="fk-product-accounting_article"/>
        <dropColumn tableName="cat_service_template">
            <column name="accounting_article_id" />
        </dropColumn>
        <dropTable tableName="cpq_accounting_article"/>
        <dropSequence sequenceName="cpq_accounting_article_seq"/>
    </changeSet>

    <changeSet id="#20210304_540320" author="TarikFA.">

        <addColumn tableName="cpq_quote_attribute">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_quote_attribute set uuid = 'quote_attribute'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_order_item">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_order_item set uuid = 'order_item'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_attribute_instance">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}cpq_attribute_instance set uuid = 'attribute_instance'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="ar_payment_token">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>

        <sql>update ${db.schema.adapted}ar_payment_token set uuid = 'payment_token'||id</sql>
        <addNotNullConstraint tableName="adm_role" columnName="uuid"/>

        <addColumn tableName="cpq_attribute">
            <column name="read_only" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>

        <addColumn tableName="account_entity">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="com_sender_config">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="crm_provider">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="crm_provider_contact">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="ord_order_item">
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
        </addColumn>

        <addColumn tableName="cpq_offer_component">
            <column name="sequence" type="int4" defaultValueNumeric="0"/>
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="display" type="${type.boolean}" />
        </addColumn>

    </changeSet>


    <changeSet id="#20210304-312" author="Mbarek-Ay">
        <addColumn tableName="cpq_order_item">
            <column name="cpq_order_offer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_order_offer_id" baseTableName="cpq_order_item" constraintName="fk_cpq_order_item_cpq_order_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>


    <changeSet id="#20210310-342" author="Mbarek-Ay">
        <addColumn tableName="billing_invoice">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addColumn tableName="cat_discount_plan">
            <column name="expression_el" type="varchar(2000)" />
        </addColumn>

        <createTable tableName="discount_plan_item_articles">
            <column name="discount_plan_item_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="accounting_article_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="discount_plan_item_id"
                                 constraintName="discount_plan_item_articles_discount_plan_item_id_fk" referencedTableName="cat_discount_plan_item"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="discount_plan_item_articles" baseColumnNames="accounting_article_id"
                                 constraintName="discount_plan_item_articles_accounting_article_id_fk" referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="#20210315-329" author="Mbarek-Ay">
        <dropForeignKeyConstraint baseTableName="billing_service_instance" constraintName="fk_cpq_quote_version_serviceInstance_id"/>
        <addForeignKeyConstraint baseColumnNames="product_version_id" baseTableName="billing_service_instance" constraintName="fk_cpq_product_version_serviceInstance_id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product_version"/>
    </changeSet>


    <changeSet id="#20210316-356" author="Mbarek-Ay">
        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_product_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product"/>

        <addForeignKeyConstraint baseColumnNames="discount_id" baseTableName="cpq_product_discount_plan" constraintName="fk_cpq_product_discount_plan_discount_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

    </changeSet>

    <changeSet id="#20210316-356-2" author="Mbarek-Ay">
        <addColumn tableName="cat_discount_plan_item">
            <column name="price_plan_matrix_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="price_plan_matrix_id" baseTableName="cat_discount_plan_item" constraintName="fk_cat_discount_plan_item_price_plan_matrix_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_price_plan_matrix" />
    </changeSet>

    <changeSet id="#20210317_M540_16" author="TarikFA.">
        <dropColumn tableName="cpq_tag">
            <column name="attribute_id" />
        </dropColumn>

        <createTable tableName="cpq_attribute_tag">
            <column name="tag_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="tag_id,attribute_id" tableName="cpq_attribute_tag"/>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="tag_id" baseTableName="cpq_attribute_tag" constraintName="fk_cpq_attribute_tag_tag_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_tag" />

    </changeSet>

    <changeSet id="#2020317-342" author="Mbarek-Ay">
        <addColumn tableName="cpq_order_product">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>

        <addColumn tableName="cpq_order_offer">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>


        <addColumn tableName="cpq_quote_version">
            <column name="invoicing_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="invoicing_plan_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_invoicing_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoicing_plan"/>
    </changeSet>

    <changeSet id="#20210322_377" author="TarikFA.">
        <addColumn tableName="cpq_attribute">
            <column name="default_value" type="varchar(255)"></column>
        </addColumn>
        <addColumn tableName="cpq_offer_component">
            <column name="quantity_min" type="int4" />
            <column name="quantity_max" type="int4" />
            <column name="quantity_default" type="int4" />
        </addColumn>
    </changeSet>

    <changeSet id="#20210323_380" author="TarikFA.">
        <addColumn tableName="cat_discount_plan_item">
            <column name="description" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20210323-382" author="Mbarek-Ay">
        <addColumn tableName="cpq_contract_item">
            <column name="rate_type" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20210323-382" author="Mbarek-Ay">
        <addColumn tableName="cpq_contract_item">
            <column name="rate_type" type="varchar(255)"/>
        </addColumn>
    </changeSet>
    <changeSet id="#20220325_360" author="TarikFA.">
        <createTable tableName="cpq_commercial_order_order_lot">
            <column name="commercial_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="order_lot_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="commercial_order_id,order_lot_id" tableName="cpq_commercial_order_order_lot"/>

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
        <addForeignKeyConstraint baseColumnNames="order_lot_id" baseTableName="cpq_commercial_order_order_lot" constraintName="fk_cpq_commercial_order_order_lot_order_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_lot" />

    </changeSet>
    <changeSet id="#20210329_399" author="TarikFA.">
        <renameTable newTableName="cpq_order_attribute" oldTableName="cpq_order_item"/>
    </changeSet>
    <changeSet id="#20210401_402" author="TarikFA.">
        <addColumn tableName="account_entity">
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="account_entity" constraintName="fk_account_entity_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
    </changeSet>

    <changeSet id="#20210406_opencell-portal-593" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_service_template"/>
        <addForeignKeyConstraint baseColumnNames="offer_template_id" baseTableName="billing_article_mapping_line" constraintName="fk_billing_article_mapping_line_offer_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />
    </changeSet>





    <changeSet id="rebuild-str-fk_6012_20210323" author="MohamedAliHammal">
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa"/>
        <addForeignKeyConstraint baseColumnNames="inbound_request_id" baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
    </changeSet>
    <changeSet id="rebuild_5621_20201104_offer_template" author="NabilOUACHI">
        <addColumn tableName="cat_offer_template">
            <column name="offer_template_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="cat_offer_template" baseColumnNames="offer_template_id"
                                 constraintName="offer_template_offer_template_fk" referencedTableName="cat_offer_template"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#20210415-435" author="Mbarek-Ay">
        <addColumn tableName="billing_invoice">
            <column name="commercial_order_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />
    </changeSet>

    <changeSet id="#20210416_441" author="TarikFA.">
        <addColumn tableName="cpq_offer_component">
            <column name="product_set" type="varchar(250)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#470_20210422" author="Mbarek-Ay">
        <addColumn tableName="cat_offer_template">
            <column name="is_model" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
        <addColumn tableName="cpq_product">
            <column name="is_model" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <!-- end media post -->
  
	<changeSet id="#5627_20201212" author="MohammedELAZZOUZI">
        <addColumn tableName="billing_billing_run">
            <column name="skip_validation_script" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="suspect_auto_action" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="reject_auto_action" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_billing_run">
            <column name="next_billing_run_id" type="bigint"/>
        </addColumn>
        
        <addColumn tableName="billing_invoice">
            <column name="reject_reason" type="varchar(255)"/>
        </addColumn>

        <addColumn tableName="billing_cycle">
            <column name="billing_run_validation_script_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_invoice_type">
            <column name="invoice_validation_script_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="next_billing_run_id" baseTableName="billing_billing_run" constraintName="fk_billing_billing_run_next_billing_run"
                                 referencedColumnNames="id" referencedTableName="billing_billing_run"/>
        <addForeignKeyConstraint baseColumnNames="billing_run_validation_script_id" baseTableName="billing_cycle" constraintName="fk_billing_cycle_billing_run_validation_script"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance"/>
        <addForeignKeyConstraint baseColumnNames="invoice_validation_script_id" baseTableName="billing_invoice_type"
                                 constraintName="fk_billing_invoice_type_invoice_validation_script"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance"/>
    </changeSet>

    <changeSet id="#5627_20210112" author="MohammedELAZZOUZI">
        <addDefaultValue columnName="skip_validation_script" tableName="billing_billing_run" defaultValueNumeric="0"/>
        <sql>UPDATE ${db.schema.adapted}billing_billing_run SET skip_validation_script=0 WHERE skip_validation_script IS NULL</sql>
    </changeSet>
    <changeSet id="#5884_20210119" author="MohammedELAZZOUZI">
    	<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="billing_invoice" columnName="status_date" />
	       </not>
		</preConditions>

        <addColumn tableName="billing_invoice">
            <column name="status_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="xml_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="pdf_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="email_sent_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="payment_status" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="payment_status_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="start_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="end_date" type="datetime"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="raw_amount" type="numeric(23, 12)">
                <!--  <constraints nullable="false"/>  -->
            </column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="discount_amount" type="numeric(23, 12)">
                <!--  <constraints nullable="false"/>  -->
            </column>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="discount_rate" type="numeric(3, 3)">
            </column>
        </addColumn>

        <addColumn tableName="billing_invoice">
            <column name="is_already_applied_minimum" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_invoice">
            <column name="is_already_added_discount" type="${type.boolean}"/>
        </addColumn>
    </changeSet>
    <changeSet id="#5946_20210110" author="KhalidHORRI">
    	<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="cat_discount_plan" columnName="status" />
	       </not>
		</preConditions>
        <addColumn tableName="cat_discount_plan">
            <column name="status" type="varchar(50)"/>
            <column name="status_date" type="datetime"/>
            <column name="initial_quantity" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="used_quantity" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="application_limit" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="application_filter_el" type="varchar(2000)"/>
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cat_discount_plan"
                                 constraintName="fk_discount_plan_id"
                                 referencedColumnNames="id" referencedTableName="cat_discount_plan"/>
        <addColumn tableName="cat_discount_plan_item">
            <column name="allow_to_negate" type="${type.boolean}"/>
        </addColumn>
        <addColumn tableName="billing_discount_plan_instance">
            <column name="status" type="varchar(50)"/>
            <column name="status_date" type="datetime"/>
            <column name="application_count" type="bigint" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <sql>UPDATE ${db.schema.adapted}cat_discount_plan set status='DRAFT', status_date= now() WHERE status IS NULL</sql>
        <createTable tableName="cat_discount_applicable_entity">
            <column name="disount_plan_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="entity_class" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="disount_plan_id, code, entity_class" constraintName="cat_discount_applicable_entity_pkey" tableName="cat_discount_applicable_entity"/>
    </changeSet>

    <changeSet id="#5951_20210209_structure" author="AbdelmounaimAkadid">
	    <dropNotNullConstraint columnName="tax_category_id" tableName="billing_tax_mapping"/>
	    <dropNotNullConstraint columnName="tax_class_id" tableName="billing_tax_mapping"/>
	</changeSet>

    <changeSet id="#5872_20210104" author="AmineBENAICHA" dbms="postgresql">
    	<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other_tmp AS
			SELECT
			*
			FROM
				${db.schema.adapted}rating_edr_other
		</sql>

		<dropTable tableName="rating_edr_other"/>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other (
			  id bigint NOT NULL DEFAULT nextval('rating_edr_seq'),
			  version integer,
			  created timestamp without time zone,
			  event_date timestamp without time zone,
			  last_updated timestamp without time zone,
			  origin_batch character varying(255),
			  origin_record character varying(255),
			  parameter_1 character varying(255),
			  parameter_2 character varying(255),
			  parameter_3 character varying(255),
			  parameter_4 character varying(255),
			  quantity numeric(23,12),
			  reject_reason text,
			  status character varying(255) NOT NULL,
			  subscription_id bigint NOT NULL,
			  parameter_5 character varying(255),
			  parameter_6 character varying(255),
			  parameter_7 character varying(255),
			  parameter_8 character varying(255),
			  parameter_9 character varying(255),
			  date_parameter_1 timestamp without time zone,
			  date_parameter_2 timestamp without time zone,
			  date_parameter_3 timestamp without time zone,
			  date_parameter_4 timestamp without time zone,
			  date_parameter_5 timestamp without time zone,
			  decimal_parameter_1 numeric(23,12),
			  decimal_parameter_2 numeric(23,12),
			  decimal_parameter_3 numeric(23,12),
			  decimal_parameter_4 numeric(23,12),
			  decimal_parameter_5 numeric(23,12),
			  access_code character varying(255),
			  header_edr_id bigint,
			  extra_parameter text,
			  times_tried int4
			) partition by list (status)
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_rejected PARTITION OF ${db.schema.adapted}rating_edr_other
				FOR VALUES IN ('REJECTED')
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_duplicated PARTITION OF ${db.schema.adapted}rating_edr_other
				FOR VALUES IN ('DUPLICATED')
		</sql>

		<sql>
			CREATE TABLE ${db.schema.adapted}rating_edr_other_default PARTITION OF ${db.schema.adapted}rating_edr_other DEFAULT
		</sql>

		<sql>
			ALTER TABLE ${db.schema.adapted}rating_edr ATTACH PARTITION ${db.schema.adapted}rating_edr_other DEFAULT
		</sql>

		<sql>insert into ${db.schema.adapted}rating_edr
		     (select *
				from ${db.schema.adapted}rating_edr_other_tmp
			  )
		</sql>

		<dropTable tableName="rating_edr_other_tmp"/>
    </changeSet>

    <changeSet id="#5700_20210118" author="AmineBENAICHA" dbms="postgresql">
    	<sql>
    		update meveo_job_instance
			set cf_values=
				case
					when cf_values is not null then (cf_values::jsonb || ('{"AccountOperationsGenerationJob_excludeInvoicesWithoutAmount": [{"boolean": ' || exclude_inv_without_amount::boolean || '}]}')::jsonb)::text
					else '{"AccountOperationsGenerationJob_excludeInvoicesWithoutAmount": [{"boolean": ' || exclude_inv_without_amount::boolean || '}]}'
				end
			where (id=-14 or code='AO_Job')
    	</sql>
    </changeSet>

    <changeSet id="#5909_20210118" author="AndriusKarpavicius">
        <sql>CREATE INDEX audit_field_changes_history_index on ${db.schema.adapted}audit_field_changes_history (lower(entity_class), entity_id)</sql>
    </changeSet>

    <changeSet id="#5904_20210129" author="AmineBENAICHA">
    	<addColumn tableName="meveo_job_instance">
    		<column name="stop_on_error" type="${type.boolean}"
    			defaultValueNumeric="0" />
		</addColumn>
    </changeSet>
    
    <changeSet id="#5960_20210212" author="AndriusKarpavicius">
        <sql>CREATE INDEX flat_file_orig_name_index on ${db.schema.adapted}flat_file (lower(file_original_name))</sql>
        <sql>CREATE INDEX job_execution_job_id_index on ${db.schema.adapted}job_execution (job_instance_id)</sql>
        <sql>CREATE INDEX medina_access_lower_uid_index on ${db.schema.adapted}medina_access (lower(acces_user_id))</sql>
        <sql>CREATE INDEX ord_order_status_index on ${db.schema.adapted}ord_order (status)</sql>
        <sql>CREATE INDEX billing_service_instance_st_index on ${db.schema.adapted}billing_service_instance (service_template_id)</sql>
        <sql>CREATE INDEX billing_wallet_operation_sub_index on ${db.schema.adapted}billing_wallet_operation (subscription_id)</sql>
    </changeSet>
    
    <changeSet id="#5993_20210304" author="HatimOUDAD">
        <addUniqueConstraint columnNames="country_code" constraintName="UniqueConstraint_adm__country_code" tableName="adm_country" />
    </changeSet>
    
    <changeSet id="#5863_22122020" author="AbdelmounaimAkadid">
		<addColumn tableName="ar_ddrequest_lot_op">
            <column name="generate_payment_lines" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="payment_status" type="varchar(25)" />
        </addColumn>
	</changeSet>

    <changeSet id="#5999_20210305" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_invoice_br_index on ${db.schema.adapted}billing_invoice (billing_run_id)</sql>
        <sql>CREATE INDEX billing_invoice_agregate_br_index on ${db.schema.adapted}billing_invoice_agregate (billing_run_id)</sql>
        <sql>CREATE INDEX rt_br_index ON billing_rated_transaction (billing_run_id) where status='BILLED'</sql>
    </changeSet>
    
    <changeSet id="#6040_20210323" author="amineTazi">
        <addColumn tableName="dwh_report_extract">
            <column name="file_separator" type="varchar(1)" defaultValue=","/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#6012_20210323" author="MohamedAliHammal">
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_cookies" constraintName="fk_1kyctwmlumac9aoikhb3kmc02" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_headers" constraintName="fk_5l2gy0e4dol6gtr05sq929hnx" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa"/>
        <addForeignKeyConstraint baseColumnNames="inbound_request_id" baseTableName="adm_notif_history" constraintName="fk_8k2sxhjmrswxnecfo74bdmnsa" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_cookies" constraintName="fk_cfd55de59w792gxpcd478ujfq" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_req_params" constraintName="fk_djmbjb6ja9fapeadjyj395020" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
        <dropForeignKeyConstraint baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt"/>
        <addForeignKeyConstraint baseColumnNames="inboundrequest_id" baseTableName="adm_inbound_resp_headers" constraintName="fk_h07be9b84xmmx5ypkbunkxwxt" deferrable="false" initiallyDeferred="false"
                                 onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_inbound_request" />
    </changeSet>
    <changeSet id="4756_20191104" author="Andrius">
        <!-- <dropColumn tableName="job_execution" columnName="job_done"/>  -->
        <addColumn tableName="job_execution">
            <column name="job_status" type="varchar(14)"/>
        </addColumn>
    </changeSet>    
        
    <changeSet id="4756_20210311" author="Andrius">
    	<addColumn tableName="meveo_job_instance">
    		<column name="job_speed" type="varchar(10)" defaultValue="NORMAL" />
    	</addColumn>
    	<sql>update ${db.schema.adapted}job_execution set job_launcher='TRIGGER' where job_launcher='TRIGER'</sql>
    </changeSet>
    
    
    <changeSet id="6055_20210330" author="Andrius" dbms="postgresql">
    	<sql>CREATE OPERATOR ^|(
			  PROCEDURE = jsonb_exists_any,
			  LEFTARG = jsonb,
			  RIGHTARG = _text,
			  RESTRICT = contsel,
			  JOIN = contjoinsel)</sql>
		
		<sql>CREATE OPERATOR CLASS jsonb_ops_custom
			   FOR TYPE jsonb USING gin AS
			   OPERATOR 10  ^|(jsonb, _text),
			   FUNCTION 1  gin_compare_jsonb(text, text),
			   FUNCTION 2  gin_extract_jsonb(jsonb, internal, internal),
			   FUNCTION 3  gin_extract_jsonb_query(jsonb, internal, smallint, internal, internal, internal, internal),
			   FUNCTION 4  gin_consistent_jsonb(internal, smallint, jsonb, integer, internal, internal, internal, internal),
			   FUNCTION 6  gin_triconsistent_jsonb(internal, smallint, jsonb, integer, internal, internal, internal);
			   </sql>
    </changeSet>
    
    
    <changeSet id="#5622_20210406" author="AbdelmounaimAkadid">
	    <sql>
            ALTER TABLE ${db.schema.adapted}billing_wallet_operation ALTER COLUMN charge_instance_id DROP NOT NULL
        </sql>
    </changeSet>

    <changeSet id="#5214_20200415_migration" author="AbdelmounaimAkadid">
    	<sql>INSERT INTO ${db.schema.adapted}wf_generic_action(id, version, priority, action_script_id, type, condition_el, transition_id)
        		SELECT nextval('wf_generic_action_seq'), 0, 0, action_script_id, 'ACTION_SCRIPT', '#{true}', id from wf_generic_transition</sql>

        <sql>update ${db.schema.adapted}wf_generic_action set uuid = id</sql>

    	<dropColumn columnName="action_script_id" tableName="wf_generic_transition" />
    </changeSet>

    <changeSet id="#4742_20191030" author="MohamedSTITANE">
    	<preConditions onFail="MARK_RAN">
	       <not>
			<sequenceExists sequenceName="meveo_metrics_config_seq" />
	       </not>
		</preConditions>
        <createSequence sequenceName="meveo_metrics_config_seq" />
        <createTable tableName="meveo_metrics_config">
            <column name="id" type="BIGINT">
                <constraints nullable="false" primaryKey="true" primaryKeyName="meveo_metrics_config_id_pk" />
            </column>
            <column name="code" type="varchar(100)">
                <constraints unique="true" uniqueConstraintName="meveo_metrics_config_code_unique" nullable="false"/>
            </column>
            <column name="description" type="text"/>
            <column name="full_path" type="text"/>
            <column name="method" type="text"/>
            <column name="metrics_type" type="text"/>
            <column name="metrics_unit" type="text"/>
            <column name="version" type="int4"/>
            <column name="updated" type="datetime"/>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>
    </changeSet>

    <changeSet id="#6076_20210419" author="Zbariki">
        <addColumn tableName="dwh_report_extract">
            <column name="custom_table_code" type="varchar(255)" />
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="accumulate" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="decimal_separator" type="character" defaultValue="."/>
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="generate_empty_report" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
        <addColumn tableName="dwh_report_extract">
            <column name="maximum_line" type="bigint" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="07042021-540-423" author="NabilOuachi">
        <sql>
            <![CDATA[
				update billing_tax_class set version = 0 where code = 'NO_TAX';
                update billing_tax_class set version = 0 where code = 'NORMAL';
                update billing_tax_class set version = 0 where code = 'REDUCED';
			]]>
        </sql>
    </changeSet>

	<changeSet id="#5991_20210224" author="HatimOUDAD">
		<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="billing_invoice_configuration" columnName="default_invoice_subcategory_id" />
	       </not>
		</preConditions>
		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_subcategory_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_invoice_subcategory_id"
			referencedTableName="billing_invoice_sub_cat"
			baseColumnNames="default_invoice_subcategory_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_generic_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_generic_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_generic_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_discount_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_discount_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_discount_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_advanced_payment_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_advanced_payment_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_advanced_payment_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />

		<addColumn tableName="billing_invoice_configuration">
			<column name="default_invoice_minimum_article_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			constraintName="fk_invoice_configuration_invoice_minimum_article_id"
			referencedTableName="billing_accounting_article"
			baseColumnNames="default_invoice_minimum_article_id"
			baseTableName="billing_invoice_configuration"
			referencedColumnNames="id" />
	</changeSet>
	
	<changeSet id="#5623_20210427" author="Mbarek">
		<preConditions onFail="MARK_RAN">
	       <not>
	         <columnExists tableName="cpq_order_offer" columnName="quote_offer_id" />
	       </not>
		</preConditions>
       <addColumn tableName="cpq_order_offer">
            <column name="quote_offer_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_offer_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />
                                                     
      <addColumn tableName="cpq_order_product">
            <column name="quote_product_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_product_id" baseTableName="cpq_order_product" constraintName="fk_cpq_order_product_quote_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_product" />
                                 
      <addColumn tableName="cpq_order_lot">
            <column name="quote_lot_id" type="bigint"/>
        </addColumn>
      <addForeignKeyConstraint baseColumnNames="quote_lot_id" baseTableName="cpq_order_lot" constraintName="fk_cpq_order_lot_quote_lot_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_lot" />                                                   
    </changeSet>

	<changeSet id="#cpq_add_missing_migration" author="AbdelmounaimAkadid">
		<preConditions onFail="MARK_RAN">
	       <not>
			<sequenceExists sequenceName="cpq_price_plan_version_seq" />
	       </not>
		</preConditions>
		<createSequence sequenceName="cpq_price_plan_version_seq" />
        <createSequence sequenceName="cpq_price_plan_matrix_item_seq" />
        <createSequence sequenceName="cpq_quote_version_seq" />
        <createSequence sequenceName="cpq_quote_product_seq" />
        <createSequence sequenceName="cpq_quote_lot_seq" />
        <createSequence sequenceName="cpq_contract_seq" />
        <createSequence sequenceName="cpq_contract_item_seq" />

        <addColumn tableName="cat_discount_plan">
            <column name="discount_plan_type" type="varchar(50)" />
        </addColumn>
   	</changeSet>


    <changeSet id="#5937_20210428" author="Mbarek-Ay">
      <preConditions onFail="MARK_RAN">
        <columnExists tableName="cpq_invoice_line" columnName="code"/>
        <columnExists tableName="cpq_invoice_line" columnName="description"/>
      </preConditions>
      <dropColumn tableName="cpq_invoice_line" columnName="code"/>
      <dropColumn tableName="cpq_invoice_line" columnName="description"/>
    </changeSet>

    <changeSet id="#5595_540498_20210430" author="TarikFA.">
    	<addColumn tableName="cat_offer_template">
    		<column name="offer_model_id" type="bigint"/>
    	</addColumn>
    	
      <addForeignKeyConstraint baseColumnNames="offer_model_id" baseTableName="cat_offer_template" constraintName="fk_offer_template_offer_model_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_template" />    
	</changeSet>

      <changeSet id="#5595_540499_20210430" author="TarikFA.">
        <addColumn tableName="cpq_product">
            <column name="product_model_id" type="bigint"/>
        </addColumn>
        
      <addForeignKeyConstraint baseColumnNames="product_model_id" baseTableName="cpq_product" constraintName="fk_cpq_product_model_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />    
    </changeSet>
    
    <changeSet id="#5595_540504_20210503" author="TarikFA.">
        <addColumn tableName="cpq_quote_version">
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValue="" />
        </addColumn>
        <addUniqueConstraint columnNames="uuid" constraintName="cpq_quote_version_uuid_unique" deferrable="false" disabled="false"
                             initiallyDeferred="false" tableName="cpq_quote_version" />
        <sql>update ${db.schema.adapted}cpq_quote_version set uuid = id</sql>
		<dropColumn tableName="cpq_quote">
			<column name="cf_values"/>
            <column name="cf_values_accum"/>
            <column name="uuid" />
		</dropColumn>
    </changeSet>

    <changeSet id="#6076_20210504" author="Zbariki">
        <modifyDataType columnName="decimal_separator" newDataType="varchar(1)" tableName="dwh_report_extract"/>
    </changeSet>

    <changeSet id="#5595_20210506" author="NabilOuachi">
        <addColumn tableName="cpq_quote">
            <column name="previews_status" type="varchar(20)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#5595_20210512" author="RachidAityaazza">
       <renameColumn tableName="cpq_quote" newColumnName="previous_status" oldColumnName="previews_status"
                      columnDataType="varchar(20)"/>
        <sql>update ${db.schema.adapted}cpq_quote set previous_status='IN_PROGRESS' where previous_status is null</sql>
    </changeSet>
    
    <changeSet id="#6122_20210517" author="AbdelmounaimAkadid">
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_added_discount = 0;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_added_discount = 1 where invoice_id in (select invoice_id from billing_invoice_agregate where discount_aggregate = 1);</sql>

    	<sql>update ${db.schema.adapted}billing_invoice set is_already_applied_minimum = 0;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set is_already_applied_minimum = 1 where invoice_id in (select invoice_id from billing_rated_transaction where type = 'MINIMUM' group by invoice_id);</sql>

    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = 'NONE';</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = 'PENDING' where recorded_invoice_id IS NOT NULL;</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set payment_status = status where status IN ('PAID', 'PPAID', 'UNPAID', 'ABANDONED', 'REFUNDED', 'DISPUTED');</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set status = 'VALIDATED' where status IN ('GENERATED', 'PAID', 'PPAID', 'UNPAID', 'ABANDONED', 'REFUNDED', 'DISPUTED');</sql>
    	<sql>update ${db.schema.adapted}billing_invoice set status = 'NEW' where status = 'CREATED';</sql>
    	
    	<sql>UPDATE ${db.schema.adapted}crm_custom_field_tmpl SET field_type = 'CHECKBOX_LIST', value_required = 0, default_value = 'VALIDATED', storage_type = 'LIST' 
    		WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code ='invoicesToProcess';</sql>


		<sql>DELETE FROM ${db.schema.adapted}crm_custom_field_tmpl_val where customfieldtemplate_id in (
								SELECT id FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess');</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'New', 'NEW' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Draft', 'DRAFT' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Canceled', 'CANCELED' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Suspect', 'SUSPECT' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Validated', 'VALIDATED' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>

		<sql>INSERT INTO ${db.schema.adapted}crm_custom_field_tmpl_val(
								    customfieldtemplate_id, listvalues, listvalues_key)
								SELECT id, 'Rejected', 'REJECTED' FROM "crm_custom_field_tmpl" 
								WHERE applies_to = 'JobInstance_XMLInvoiceGenerationJob' AND code = 'invoicesToProcess';</sql>
    	
    </changeSet>


    <changeSet id="#5257_20210519" author="AndriusKarpavicius">
        <addColumn tableName="billing_wallet_operation">
            <column name="refunds_wo_id" type="bigint"/>
        </addColumn>
    </changeSet>

	<changeSet id="#5623-562-20210520" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		 <column name="quote_offer_id" type="bigint" />
		</addColumn>
		
		<addColumn tableName="order_price"> 
		<column name="order_offer_id" type="bigint" />
		</addColumn>

		<addForeignKeyConstraint
			baseColumnNames="quote_offer_id" baseTableName="cpq_quote_price" constraintName="fk_cpq_quote_price_quote_offer" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="quote_offer" />

		<addForeignKeyConstraint
			baseColumnNames="order_offer_id" baseTableName="order_price" constraintName="fk_order_price_order_offer" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id" referencedTableName="cpq_order_offer" />
	</changeSet>

    <changeSet id="#5869_20210521" author="NabilOuachi">
        <addColumn tableName="cpq_quote_version">
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </addColumn>
        <sql>
            update ${db.schema.adapted}cpq_quote_version set created=now() where created is null;
            update ${db.schema.adapted}cpq_quote_version set creator='applicationInitializer' where creator is null;
        </sql>
        <addNotNullConstraint tableName="cpq_quote_version" columnName="created"/>
    </changeSet>
    
    <changeSet id="#6122_20210524" author="AbdelmounaimAkadid">
    	<sql>UPDATE ${db.schema.adapted}meveo_job_instance set cf_values = REPLACE(cf_values, '"string":"DraftOnly"', '"listString":["DRAFT"]') where job_template = 'XMLInvoiceGenerationJob';</sql>
    	<sql>UPDATE ${db.schema.adapted}meveo_job_instance set cf_values = REPLACE(cf_values, '"string":"FinalOnly"', '"listString":["VALIDATED"]') where job_template = 'XMLInvoiceGenerationJob';</sql>
   	</changeSet>
   	
   	<changeSet   id="#20210123_540_281_1" author="TarikFA.">
        <sql>update ${db.schema.adapted}adm_role set uuid = 'role'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_2" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_quote_attribute set uuid = 'quote_attribute'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_3" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_order_attribute  set uuid = 'order_item'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_4" author="TarikFA.">
        <sql>update ${db.schema.adapted}cpq_attribute_instance set uuid = 'attribute_instance'||id where uuid is null</sql>
    </changeSet>
    <changeSet   id="#20210123_540_281_5" author="TarikFA.">
        <sql>update ${db.schema.adapted}ar_payment_token set uuid = 'payment_token'||id where uuid is null</sql>
    </changeSet>
    

    <changeSet id="#5599_20210526" author="AbdelmounaimAkadid">
    	<sql>CREATE INDEX idx_billing_invoice_agr_amount_on_aggr_id  ON billing_invoice_agr_amount (aggr_id)</sql>
    </changeSet>
    
    <changeSet id="#5416_20210526" author="AbdelmounaimAkadid">
    	<sql>CREATE INDEX idx_ar_ao_payment_histories__ao_id ON ar_ao_payment_histories(ao_id)</sql>
    </changeSet>

    <changeSet id="#533_20210526" author="NabilOuachi">
        <addColumn tableName="cpq_commercial_order">
            <column name="code" type="varchar(50)" />
            <column name="description" type="varchar(255)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#6147_20210530" author="anasseh">
	    <sql>CREATE INDEX idx_ar_payment_history_external_payment_id   ON ${db.schema.adapted}ar_payment_history (external_payment_id );</sql>
    </changeSet>
    
    <changeSet id="#559_20210603" author="TarikFA.">
    	<sql>update crm_customer_category set tax_category_id = -1 where tax_category_id is null</sql>
    	<addNotNullConstraint tableName="crm_customer_category" columnName="tax_category_id"/>
    </changeSet>
    
    <changeSet id="#20210607_540_563" author="TarikFA.">
    	<sql>INSERT INTO ${db.schema.adapted}billing_accounting_article (id,"version",created,creator,code,description,tax_class_id,invoice_sub_category_id,description_i18n,disabled,uuid)
				VALUES (nextval('billing_accounting_article_seq'),1,'2021-06-03 16:23:10.262','opencell.admin','PROD-STD','PROD-STD',-1,-2,'{}',0,'63ef9cee-f498-4908-PROD-STD');</sql>
		<sql>INSERT INTO ${db.schema.adapted}billing_accounting_article (id,"version",created,creator,code,description,tax_class_id,invoice_sub_category_id,description_i18n,disabled,uuid)
				VALUES (nextval('billing_accounting_article_seq'),1,'2021-06-03 16:23:10.262','opencell.admin','ADV-STD','ADV-STD',-1,-2,'{}',0,'63ef9cee-f498-4908-ADV-STD');</sql>
		<sql>INSERT INTO ${db.schema.adapted}cat_discount_plan (id,"version",disabled,created,updated,code,description,max_duration,min_duration,creator,updater,uuid,start_date,end_date,duration_unit,discount_plan_type,status,status_date,initial_quantity,used_quantity,application_limit)
				VALUES (nextval('cat_discount_plan_seq'),0,0,'2021-06-07 15:52:06.068','2021-06-07 15:52:06.643','DISC-STD','DISC-STD',99999,0,'opencell.admin','opencell.admin','bb686d5b-4c81-432c-bfd9','2021-01-01','2022-12-31','DAY','PRODUCT','ACTIVE','2021-06-07 15:51:06.643',0,0,0);</sql>
    </changeSet>
    
    <changeSet id="#20210608-540-527" author="Rachid.Aityaazza">
        <addColumn tableName="cpq_commercial_order">
            <column name="discount_plan_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_commercial_order" constraintName="fk_cpq_commercial_order_discount_plan_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan"/>
    </changeSet>
        <changeSet id="#20210611-540-637" author="Rachid.Aityaazza">
        <addColumn tableName="cpq_quote_article_line">
            <column name="quote_version_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="quote_version_id" baseTableName="cpq_quote_article_line" constraintName="fk_quote_article_line_quote_version_id" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_version"/>
    </changeSet>
    
 <changeSet id="#20210614_540_update_script_quotation_and_order" author="TarikFA.">
   
     <sql><![CDATA[update ${db.schema.adapted}meveo_script_instance 
     			set script = 'package org.meveo.service.quote.script;

	public class QuoteValidation extends QuoteValidationScript {}'
	where code = 'org.meveo.api.billing.QuoteValidation'
        ]]></sql>

     <sql><![CDATA[update ${db.schema.adapted}meveo_script_instance 
     			set script = 'package org.meveo.service.quote.script;

	public class OrderAdvancement extends OrderAdvancementScript {}'
	where code = 'org.meveo.api.billing.OrderAdvancement'
        ]]></sql>
    </changeSet>

    <changeSet id="#INTRD-242_20210623" author="Zbariki">
        <addColumn tableName="billing_billing_run">
            <column name="filters" type="text">
                <constraints nullable="true" />
            </column>
        </addColumn>
        <dropNotNullConstraint columnDataType="datetime" columnName="last_transaction_date" tableName="billing_billing_run"/>
    </changeSet>
    
    <changeSet id="#20210622-INTRD-272" author="TarikFA.">
    	<sql>update ${db.schema.adapted}billing_tax_category set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_invoice_cat set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax_mapping set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax set version = 0 where version is null</sql>
    	<sql>update ${db.schema.adapted}billing_tax_class set version = 0 where version is null</sql>
    </changeSet>
    
    <changeSet id="#20210623-INTRD-277-quoteValidationScript" author="TarikFA.">
    	<preConditions onFail="MARK_RAN" onSqlOutput="TEST">
    		<sqlCheck expectedResult="0">select count(*) from ${db.schema.adapted}meveo_script_instance where code = 'org.meveo.service.quote.script.QuoteValidation'</sqlCheck>
    	</preConditions>
    	<sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-32, 0, 0, now(), 'org.meveo.service.quote.script.QuoteValidation', 'quote validation', 'JAVA', '
            package org.meveo.service.quote.script;
            public class QuoteValidation extends QuoteValidationScript {}
            ');]]>
        </sql>
        
        <insert tableName="adm_notification">
        	<column name="id" value="-55" />
        	<column name="version" value="0"/>
        	<column name="disabled" value="0"/>
        	<column name="created" value="now()"/>
        	<column name="code" value="NOTIF_QUOTE_VALIDATION"/>
        	<column name="class_name_filter" value="org.meveo.model.cpq.CpqQuote"/>
        	<column name="event_expression_filter" value="#{event.status == 'ACCEPTED' }"/>
        	<column name="event_type_filter" value="STATUS_UPDATED"/>
        	<column name="creator" value="opencell.admin"/>
        	<column name="script_instance_id" value="-32"/>
        	<column name="uuid" value="GENERIC_UUID_CPQUOTE"/>
        	<column name="priority" value="0"/>
        	<column name="run_async" value="0"/>
        	<column name="save_successful_notif" value="1"/>
        </insert>
        
        <insert tableName="adm_notification_params">
        	<column name="notification_id" value="-55" />
        	<column name="params" value="#{event}" />
        	<column name="params_key" value="cpqQuote" />
        </insert>
        
        <insert tableName="adm_script_notification">
        	<column name="id" value="-55"/>
        </insert>
            
    </changeSet>
    
    <changeSet id="#20210623-INTRD-277-orderAdvacementScript" author="TarikFA.">
    	<preConditions onFail="MARK_RAN" onSqlOutput="TEST">
    		<sqlCheck expectedResult="0">select count(*) from ${db.schema.adapted}meveo_script_instance where code = 'org.meveo.service.quote.script.OrderAdvancement'</sqlCheck>
    	</preConditions>
    	
    		<sql><![CDATA[INSERT INTO ${db.schema.adapted}meveo_script_instance (id, version, disabled, created, code, description, src_type, script) VALUES (-33, 0, 0, now(), 'org.meveo.service.quote.script.OrderAdvancement', 'order advancemnt script', 'JAVA', '
            package org.meveo.service.quote.script;
            public class OrderAdvancement extends OrderAdvancementScript {}
            ');]]></sql>
        
            <insert tableName="adm_notification">
            	<column name="id" value="-56" />
            	<column name="version" value="0"/>
            	<column name="disabled" value="0"/>
            	<column name="created" value="now()"/>
            	<column name="code" value="NOTIF_ORDER_ADVANCEMENT"/>
            	<column name="class_name_filter" value="org.meveo.model.cpq.commercial.CommercialOrder"/>
            	<column name="event_type_filter" value="ADVT_RATE_INCREASED"/>
            	<column name="creator" value="opencell.admin"/>
            	<column name="script_instance_id" value="-33"/>
            	<column name="uuid" value="GENERIC_UUID_ORDER"/>
            	<column name="priority" value="0"/>
            	<column name="run_async" value="0"/>
            	<column name="save_successful_notif" value="1"/>
            </insert>
            
            <insert tableName="adm_notification_params">
            	<column name="notification_id" value="-56" />
            	<column name="params" value="#{event}" />
            	<column name="params_key" value="commercialOrder" />
            </insert>
            
            <insert tableName="adm_script_notification">
            	<column name="id" value="-56"/>
            </insert>
            
    </changeSet>

    <changeSet id="#INTRD-339_20210625" author="ZBariki">
        <addUniqueConstraint columnNames="code" constraintName="uk_genericSeq_9fnf93rp352nkw2kpdbari17yr"
                             deferrable="false" disabled="false" initiallyDeferred="false" tableName="generic_sequence" />
    </changeSet>
    
    <changeSet id="#INTRD-1441_20210728" author="TarikFA.">
    	<createTable tableName="cpq_quote_media">
    		<column name="quote_id" type="bigint" />
    		<column name="media_id" type="bigint" />
    	</createTable>
    	
    	<addPrimaryKey columnNames="quote_id, media_id" tableName="cpq_quote_media"/>
        <addForeignKeyConstraint baseColumnNames="quote_id" baseTableName="cpq_quote_media"
                                 constraintName="fk_cpq_quote_media_quote_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_quote"/>  
        <addForeignKeyConstraint baseColumnNames="media_id" baseTableName="cpq_quote_media"
                                 constraintName="fk_cpq_quote_media_media_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="cpq_media"/>  
    	
    </changeSet>
    
    
    <changeSet id="INTRD-1221_20210803" author="TarikFA.">
    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_SUBSCRIPTION" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'SUBSCRIPTION')</where>
    	</update>
    	
    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_TERMINATION" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'TERMINATION')</where>
    	</update>
    	
    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_OTHER" />
    		<where>charge_template_id  in (select id from cat_charge_template where type = 'OTHER')</where>
    	</update>
    	
    	<update tableName="cpq_quote_price">
    		<column name="price_type" value="ONE_SHOT_OTHER" />
    		<where>charge_template_id  is null</where>
    	</update>
    </changeSet>
    <changeSet id="INTRD-1310_050821" author="Mbarek-Ay">
     <addColumn tableName="billing_subscription">
            <column name="order_offer_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="billing_subscription" constraintName="fk_billing_subscription_order_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>

    <changeSet id="#INTRD-1396_20210812" author="ZBariki">
        <addColumn tableName="cpq_attribute">
            <column name="validation_type" type="varchar(10)" />
            <column name="validation_pattern" type="varchar(2000)" />
            <column name="validation_label" type="varchar(255)" />
        </addColumn>
    </changeSet>
    
    
     <changeSet author="TarikFA." id="INTRD_1687_20210906">
          <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_subscription_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
          <addForeignKeyConstraint baseColumnNames="charge_instance_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rated_transaction_charge_instance_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_charge_instance" />
    </changeSet>
    
    <changeSet id="#INTRD-1386_05092021" author="Mbarek-Ay">
	
	 <preConditions onFail="MARK_RAN">
     <foreignKeyConstraintExists foreignKeyName="fk__ord_quote__cat_discount_plan"/>
     <foreignKeyConstraintExists foreignKeyName="fk_cpq_quote_contract_id"/>
     <tableExists tableName="cpq_quote_media"/>
      </preConditions>
      
	<addColumn tableName="cpq_quote_version">
	<column name="discount_plan_id" type="bigint"/>
	<column name="xml_filename" type="varchar(255)" />
	<column name="pdf_filename" type="varchar(255)" />
	<column name="contract_id" type="bigint"/>
	</addColumn>
	
	<createTable tableName="cpq_quote_version_media">
	<column name="cpq_quote_version_id" type="bigint" />
	<column name="cpq_media_id" type="bigint" />
	</createTable>
	
	<addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_discount_plan" deferrable="false" initiallyDeferred="false"
	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
	
	<addForeignKeyConstraint baseColumnNames="contract_id" baseTableName="cpq_quote_version" constraintName="fk_cpq_quote_version_contract_id" deferrable="false" initiallyDeferred="false"
	onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_contract" />
	
	
	<addPrimaryKey columnNames="cpq_quote_version_id, cpq_media_id" tableName="cpq_quote_version_media"/>
	        <addForeignKeyConstraint baseColumnNames="cpq_quote_version_id" baseTableName="cpq_quote_version_media"
	                                 constraintName="fk_cpq_quote_version_media_id" deferrable="false"
	                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
	                                 referencedColumnNames="id" referencedTableName="cpq_quote_version"/>  
	        <addForeignKeyConstraint baseColumnNames="cpq_media_id" baseTableName="cpq_quote_version_media"
	                                 constraintName="fk_cpq_media_quote_version_id" deferrable="false"
	                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
	                                 referencedColumnNames="id" referencedTableName="cpq_media"/>
	                                 
	<sql>update ${db.schema.adapted}cpq_quote_version  set discount_plan_id=q.discount_plan_id from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.discount_plan_id is not null</sql> 
	
	<sql>update ${db.schema.adapted}cpq_quote_version  set xml_filename=q.xml_filename from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.xml_filename is not null</sql>
	
	<sql>update ${db.schema.adapted}cpq_quote_version  set pdf_filename=q.pdf_filename from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.pdf_filename is not null</sql>
	
	<sql>update ${db.schema.adapted}cpq_quote_version  set contract_id=q.contract_id from cpq_quote q where  cpq_quote_version.cpq_quote_id=q.id  and q.contract_id is not null</sql>
	
	<sql>INSERT INTO  ${db.schema.adapted}cpq_quote_version_media(cpq_quote_version_id, cpq_media_id) SELECT quote_id, media_id FROM cpq_quote_media </sql> 
	
	
      
	 <dropColumn tableName="cpq_quote">
     <column name="discount_plan_id"></column>
     <column name="xml_filename"></column>
     <column name="pdf_filename"></column>
     <column name="contract_id"></column>
     </dropColumn>  
     
     <dropForeignKeyConstraint baseTableName="cpq_quote" constraintName="fk__ord_quote__cat_discount_plan"/> 
     <dropForeignKeyConstraint baseTableName="cpq_quote" constraintName="fk_cpq_quote_contract_id"/>  
     <dropTable tableName="cpq_quote_media"/>
	
   </changeSet>
   
   <changeSet id="INTRD_1985_20210923" author="TarikFA.">
   		<addColumn tableName="quote_offer">
			<column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
   		</addColumn>
   		<addUniqueConstraint columnNames="code, quote_version_id" tableName="quote_offer"/>
   		
   		<addColumn tableName="cpq_order_offer">
			<column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
   		</addColumn>
   		<addUniqueConstraint columnNames="code, order_id" tableName="cpq_order_offer"/>
   </changeSet>
   
      <changeSet id="INTRD-2046_20210927" author="Mbarek-Ay">
     <addColumn tableName="cpq_invoice_line">
            <column name="cpq_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="cpq_invoice_line" constraintName="fk_cpq_invoice_line_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />
    </changeSet>
    
    <changeSet id="INTRD-2252_20211006" author="TarikFA.">
    	<dropNotNullConstraint tableName="billing_article_mapping_line" columnName="article_mapping_id"/>
    </changeSet>
    
     <changeSet id="INTRD-2425_20211014" author="Mbarek-Ay">
     <addColumn tableName="billing_invoice">
            <column name="cpq_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />
    </changeSet>

    <changeSet id="INTRD-2498_20211019" author="Mbarek-Ay">
     <addColumn tableName="cpq_invoice_line">
            <column name="quote_offer_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="quote_offer_id" baseTableName="cpq_invoice_line" constraintName="fk_invoice_line_quote_offer_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="quote_offer" />

       <addColumn tableName="cpq_invoice_line">
         <column name="order_offer_id" type="bigint" />
     </addColumn>
     <addForeignKeyConstraint baseColumnNames="order_offer_id" baseTableName="cpq_invoice_line" constraintName="fk_invoice_line_order_offer_id" deferrable="false" initiallyDeferred="false"
                              onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_order_offer" />
    </changeSet>

    <changeSet id="INTRD-2535_20211021" author="NabilOuachi">
        <addColumn tableName="cpq_commercial_rule_header">
            <column name="scope_type" type="varchar(25)" />
        </addColumn>
    </changeSet>

    
     <changeSet id="#INTRD-4682_20220209" author="AndriusKarpavicius">
        <renameColumn tableName="adm_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="boolean"/>
        <renameColumn tableName="adm_role_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="boolean"/>
     </changeSet>
     
     <changeSet id="#INTRD-5385_20220228" author="TarikFA.">
     	<addColumn tableName="cpq_quote_price">
     		<column name="quantity" type="numeric(19,2)"/>
     	</addColumn>
     	<addColumn tableName="cpq_quote_price">
     		<column name="discounted_quote_price" type="bigint"/>
     	</addColumn>
     	<renameColumn tableName="cpq_quote_price" oldColumnName="amount_without_tax_with_discount" newColumnName="amount_without_tax_without_discount"/>
        <addForeignKeyConstraint baseColumnNames="discounted_quote_price" baseTableName="cpq_quote_price" constraintName="fk_discounted_quote_price" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_price" />
     </changeSet>

    <changeSet id="#INTRD-4798_20220303" author="MohamedSTITANE">
        <sql>
            create index cpq_commercial_rule_item_header_id_index on cpq_commercial_rule_item (commercial_rule_header_id);
            create index cpq_tag_seller_id_index on cpq_tag (seller_id);
            create index cpq_tag_tag_type_id_index on cpq_tag (tag_type_id);
            create index cpq_tag_type_seller_id_index on cpq_tag_type (seller_id);
            create index cpq_commercial_rule_header_attribute_id_index on cpq_commercial_rule_header (attribute_id);
            create index cpq_commercial_rule_header_grouped_attributes_id_index on cpq_commercial_rule_header (grouped_attributes_id);
            create index cpq_commercial_rule_header_grouped_service_id_index on cpq_commercial_rule_header (grouped_service_id);
            create index cpq_commercial_rule_header_offer_template_id_index on cpq_commercial_rule_header (offer_template_id);
            create index cpq_commercial_rule_header_product_id_index on cpq_commercial_rule_header (product_id);
            create index cpq_commercial_rule_header_product_version_id_index on cpq_commercial_rule_header (product_version_id);
            create index cpq_commercial_rule_header_service_template_id_index on cpq_commercial_rule_header (service_template_id);
            create index cpq_commercial_rule_header_tag_id_index on cpq_commercial_rule_header (tag_id);
        </sql>
    </changeSet>
    
    <changeSet id="#INTRD-5529_20220304" author="TarikFA.">
	    <addColumn tableName="cpq_invoice_line">
	    	<column name="discounted_invoice_line" type="bigint"/>
	    </addColumn>
	    <addForeignKeyConstraint baseColumnNames="discounted_invoice_line" baseTableName="cpq_invoice_line" constraintName="fk_discounted_invoice_line" deferrable="false" 
	    						initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
    </changeSet>
    
    <changeSet id="#INTRD-5859_20220321" author="TarikFA.">
    	<addColumn tableName="billing_discount_plan_instance">
    		<column name="service_instance_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_discount_plan_instance" constraintName="fk_discount_instance_service_instance" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
    </changeSet>
    
    <changeSet id="#INTRD-5872_20220322" author="TarikFA.">
    	<addColumn tableName="billing_wallet_operation">
    		<column name="discounted_wallet_operation_id" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_wallet_operation" constraintName="fk_discount_plan_id_wallet_operation" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_rated_transaction" constraintName="fk_discount_plan_id_rated_transaction" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="cpq_quote_price">
			<column name="uuid" type="varchar(60)"/>
		</addColumn>
                                 
    </changeSet>
    <changeSet id="#INTRD-5872_20220326" author="R.AITYAAZZA">
    	<addColumn tableName="cpq_quote_price">
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_price" constraintName="fk_discount_plan_id_quote_price" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                
       <addColumn tableName="billing_rated_transaction">
    		<column name="discounted_ratedtransaction_id" type="bigint" />
    	</addColumn>                          
    </changeSet>
    
     <changeSet id="#20220326_M540_178" author="Mbarek-Ay">

        <createTable tableName="cpq_assigned_attributes">
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="assigned_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="attribute_id,assigned_attribute_id" tableName="cpq_assigned_attributes"/>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="assigned_attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_assigned_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

    </changeSet>
    
    <changeSet id="#INTRD-6108_20220330" author="TarikFA.">
    	<addColumn tableName="order_price">
    		<column name="quantity" type="numeric(19,2)" />
    		<column name="discounted_order_price" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discounted_order_price" baseTableName="order_price" constraintName="fk_order_price_discounted_order" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_price" />
                                 
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="order_price" constraintName="fk_order_price_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
    </changeSet>
    
	    <changeSet id="#20220404_M540_6296" author="Mbarek-Ay">
	
		<addColumn tableName="cpq_quote_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_wallet_operation">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="cpq_invoice_line">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn> 
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
        
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_wallet_operation" constraintName="fk_wallet_operation_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
      
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="cpq_invoice_line" constraintName="fk_invoice_line_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
      </changeSet>

    <changeSet id="#20220407_ADHOC" author="NabilOuachi">
        <addColumn tableName="cat_discount_plan">
            <column name="applicable_on_overridden_price" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
     <changeSet id="#20220408_M540_6296" author="Rachid.Aityaazza">
        <addColumn tableName="cat_discount_plan_item">
            <column name="apply_by_article" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#20220412_M540_172" author="Mbarek-Ay">
	
		<addColumn tableName="order_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn> 
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="order_price" constraintName="fk_order_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" /> 
      </changeSet>
      
       <changeSet id="#20220412_M540_6533" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		<column name="apply_discounts_on_overriden_price" type="${type.boolean}"/>
		</addColumn>
		<addColumn tableName="order_price">
		<column name="apply_discounts_on_overriden_price" type="${type.boolean}"/>
		</addColumn>
		<addColumn tableName="billing_charge_instance">
		<column name="apply_discounts_on_overriden_price" type="${type.boolean}"/>
		</addColumn>
      </changeSet>
      
       <changeSet id="#20220415_M540_6609" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
		<addColumn tableName="billing_charge_instance">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
      </changeSet>

	<changeSet id="#20220415_M540_6296" author="Rachid.Aityaazza">
		<dropNotNullConstraint columnDataType="bigint" columnName="order_article_line_id" tableName="order_price" />
	</changeSet>
	
	<changeSet id="#20220415_M540_6931-8" author="Mbarek-Ay">
		<addColumn tableName="cat_discount_plan">
		<column name="applicable_on_discounted_price" type="${type.boolean}"/>
		<column name="sequence" type="int4"/>
		</addColumn>
		
	   <addColumn tableName="crm_provider">
		<column name="activate_cascading_discounts" type="${type.boolean}" defaultValueNumeric="1"/> 
		</addColumn>
		
		<addColumn tableName="cat_discount_plan_item">
		<column name="sequence" type="int4"/>
		</addColumn>
		
		<addColumn tableName="billing_wallet_operation">
		<column name="discounted_amount" type="numeric(23,12)"/>
		<column name="sequence" type="int4"/>
		</addColumn>
		
		<addColumn tableName="cpq_quote_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>
		
		<addColumn tableName="order_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>
		
		<addColumn tableName="billing_rated_transaction">
		<column name="sequence" type="int4"/>
		</addColumn>
		
		<addColumn tableName="cpq_invoice_line">
		<column name="sequence" type="int4"/>
		</addColumn>
		
		 <createSequence sequenceName="discount_plan_sequence_seq" />
		<sql>
		alter sequence ${db.schema.adapted}discount_plan_sequence_seq RESTART WITH 1;
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='PRODUCT';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='OFFER';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='QUOTE';
		</sql>
		
      </changeSet>

      
    
</databaseChangeLog>