<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">

    <changeSet id="#INTRD-2628-20211025" author="AbdelkaderBouazza">
        <addForeignKeyConstraint baseTableName="dunning_level_dunning_action" baseColumnNames="dunning_level_id"
                                 constraintName="dunning_level_dunning_action_pkey_const" referencedTableName="dunning_level"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="dunning_level_dunning_action" baseColumnNames="dunning_action_id"
                                 constraintName="dunning_action_dunning_level_pkey_const" referencedTableName="ar_dunning_action"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="INTRD-2511-1_20211029" author="Mohammed_ElAzzouzi" failOnError="false">
    	<dropUniqueConstraint tableName="cpq_price_plan_version" constraintName="cpq_price_plan_version_UNIC" />
    </changeSet>
    <changeSet id="INTRD-2511-2_20211029" author="Mohammed_ElAzzouzi">
		<sql>update cpq_price_plan_version ppv set current_version = id where ppv.ppm_id in
				(select d.ppm_id from (select count(*), current_version, ppm_id from cpq_price_plan_version
				group by current_version, ppm_id having count(*)>1) d)</sql>
	    <addUniqueConstraint columnNames="current_version,ppm_id" constraintName="cpq_price_plan_version_UNIC" tableName="cpq_price_plan_version" />
	</changeSet>

	<changeSet id="#INTRD-2421_20211012" author="AndriusKarpavicius">
        <addColumn tableName="ar_customer_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <addColumn tableName="billing_billing_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="billing_user_account">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <renameColumn tableName="com_contact" oldColumnName="company" newColumnName="company_name" columnDataType="varchar(200)"/>

        <addColumn tableName="com_contact">
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="fax" type="varchar(50)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>

        <addColumn tableName="crm_customer">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="registration_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
        </addColumn>
        <addColumn tableName="crm_seller">
            <column name="version" type="int4" />
            <column name="created" type="datetime"/>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)"/>
            <column name="description" type="varchar(255)" />
            <column name="address_1" type="varchar(255)" />
            <column name="address_2" type="varchar(255)" />
            <column name="address_3" type="varchar(255)" />
            <column name="address_4" type="varchar(255)" />
            <column name="address_5" type="varchar(255)" />
            <column name="address_city" type="varchar(50)" />
            <column name="address_country_id" type="bigint" />
            <column name="address_state" type="varchar(50)" />
            <column name="address_zipcode" type="varchar(10)" />
            <column name="default_level" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="external_ref_1" type="varchar(255)" />
            <column name="external_ref_2" type="varchar(255)" />
            <column name="firstname" type="varchar(100)" />
            <column name="lastname" type="varchar(100)" />
            <column name="provider_contact" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="title_id" type="bigint" />
            <column name="primary_contact" type="bigint" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="bam_id" type="bigint" />
            <column name="cf_values" type="${type.json}" />
            <column name="job_title" type="varchar(255)" />
            <column name="email" type="varchar(2000)" />
            <column name="fax" type="varchar(50)" />
            <column name="mobile" type="varchar(100)" />
            <column name="phone" type="varchar(100)" />
            <column name="vat_no" type="varchar(100)" />
            <column name="minimum_amount_el" type="varchar(2000)" />
            <column name="minimum_label_el" type="varchar(2000)" />
            <column name="minimum_charge_template_id" type="bigint" />
            <column name="company" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="legal_entity_type_id" type="bigint" />
            <column name="minimum_article_id" type="bigint" />
        </addColumn>

        <dropAllForeignKeyConstraints baseTableName="account_entity"/>
        <dropForeignKeyConstraint baseTableName="crm_customer" constraintName="fk_rylbq2w5ij2o2lbubhv99m4ox"/>
        <dropForeignKeyConstraint baseTableName="ar_customer_account" constraintName="fk_9i811xvc40e19t613cmpvwmu9" />
        <dropForeignKeyConstraint baseTableName="billing_billing_account" constraintName="fk_fky4ah96o9fohkx7u569phxxr" />
        <dropForeignKeyConstraint baseTableName="billing_user_account" constraintName="fk_alpl7r5p2nm43w0ro26ckcqnb" />
        <dropForeignKeyConstraint baseTableName="com_contact" constraintName="fk9im60lcguu9v09p3dds2f4a3h" />
        <dropForeignKeyConstraint baseTableName="crm_seller" constraintName="fkjscoerhfwoc4i65w3pxpls10o" />
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_rt_ua"/>
        <dropForeignKeyConstraint baseTableName="document" constraintName="document_account_entity_id_fk"/>

    </changeSet>

    <changeSet id="#INTRD-2421_20211012-pg" author="AndriusKarpavicius" dbms="postgresql">
        <sql>update ${db.schema.adapted}crm_seller set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where crm_seller.id=ae.id and ae.account_type='ACCT_S'</sql>

        <sql>update ${db.schema.adapted}crm_customer set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where crm_customer.id=ae.id and ae.account_type='ACCT_CUST'</sql>

        <sql>update ${db.schema.adapted}ar_customer_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where ar_customer_account.id=ae.id and ae.account_type='ACCT_CA'</sql>

        <sql>update ${db.schema.adapted}billing_billing_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where billing_billing_account.id=ae.id and ae.account_type='ACCT_BA'</sql>

        <sql>update ${db.schema.adapted}billing_user_account set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,bam_id=ae.bam_id,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,minimum_amount_el=ae.minimum_amount_el,
minimum_label_el=ae.minimum_label_el,minimum_charge_template_id=ae.minimum_charge_template_id,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where billing_user_account.id=ae.id and ae.account_type='ACCT_UA'</sql>

        <sql>update ${db.schema.adapted}com_contact set version=ae.version,created=ae.created,updated=ae.updated,code=ae.code,description=ae.description,address_1=ae.address_1,address_2=ae.address_2,address_3=ae.address_3,
address_4=ae.address_4,address_5=ae.address_5,address_city=ae.address_city,address_country_id=ae.address_country_id,address_state=ae.address_state,address_zipcode=ae.address_zipcode,
default_level=ae.default_level,external_ref_1=ae.external_ref_1,external_ref_2=ae.external_ref_2,firstname=ae.firstname,lastname=ae.lastname,provider_contact=ae.provider_contact,
creator=ae.creator,updater=ae.updater,title_id=ae.title_id,primary_contact=ae.primary_contact,uuid=ae.uuid,cf_values=ae.cf_values,
job_title=ae.job_title,email=ae.email,fax=ae.fax,mobile=ae.mobile,phone=ae.phone,vat_no=ae.vat_no,registration_no=ae.registration_no,company=ae.company,legal_entity_type_id=ae.legal_entity_type_id
from ${db.schema.adapted}account_entity ae where com_contact.id=ae.id and ae.account_type='ACCT_CTACT'</sql>
    </changeSet>

    <changeSet id="#INTRD-2421_20211012-end" author="AndriusKarpavicius">

        <addNotNullConstraint tableName="crm_seller" columnName="created"/>
        <addNotNullConstraint tableName="crm_seller" columnName="code"/>
        <addNotNullConstraint tableName="crm_seller" columnName="uuid"/>
        <addNotNullConstraint tableName="crm_customer" columnName="created"/>
        <addNotNullConstraint tableName="crm_customer" columnName="code"/>
        <addNotNullConstraint tableName="crm_customer" columnName="uuid"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="created"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="code"/>
        <addNotNullConstraint tableName="ar_customer_account" columnName="uuid"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="created"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="code"/>
        <addNotNullConstraint tableName="billing_billing_account" columnName="uuid"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="created"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="code"/>
        <addNotNullConstraint tableName="billing_user_account" columnName="uuid"/>
        <addNotNullConstraint tableName="com_contact" columnName="created"/>
        <addNotNullConstraint tableName="com_contact" columnName="code"/>
        <addNotNullConstraint tableName="com_contact" columnName="uuid"/>

        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="crm_seller" constraintName="fk_seller_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="crm_customer" constraintName="fk_cust_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="ar_customer_account" constraintName="fk_ca_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="billing_billing_account" constraintName="fk_ba_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="billing_user_account" constraintName="fk_ua_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />
        <addForeignKeyConstraint baseColumnNames="primary_contact" baseTableName="com_contact" constraintName="fk_com_contact_primary_contact" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider_contact" />


        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="crm_seller" constraintName="fk_seller_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="crm_customer" constraintName="fk_cust_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="ar_customer_account" constraintName="fk_ca_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="billing_billing_account" constraintName="fk_ba_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="billing_user_account" constraintName="fk_ua_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="title_id" baseTableName="com_contact" constraintName="fk_com_contact_title" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />

        <addForeignKeyConstraint baseTableName="crm_seller" constraintName="fk_seller_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="crm_customer" constraintName="fk_cust_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="ar_customer_account" constraintName="fk_ca_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_billing_account" constraintName="fk_ba_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_user_account" constraintName="fk_ua_bam" baseColumnNames="bam_id" referencedTableName="crm_business_account_model"
            referencedColumnNames="id" deferrable="false" initiallyDeferred="false" onUpdate="NO ACTION" onDelete="NO ACTION" />

        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_seller" constraintName="fk_seller_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="crm_customer" constraintName="fk_cust_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="ar_customer_account" constraintName="fk_ca_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="billing_billing_account" constraintName="fk_ba_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="billing_user_account" constraintName="fk_ua_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />
        <addForeignKeyConstraint baseColumnNames="address_country_id" baseTableName="com_contact" constraintName="fk_com_contact_country_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_country" />


        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_rated_transaction" constraintName="fk_rt_ua" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />


        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="crm_seller"
            constraintName="fk_seller_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="crm_customer"
            constraintName="fk_cust_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="ar_customer_account"
            constraintName="fk_ca_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_billing_account"
            constraintName="fk_ba_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />
        <addForeignKeyConstraint baseColumnNames="minimum_charge_template_id" baseTableName="billing_user_account"
            constraintName="fk_ua_minimum_charge_template_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
            referencedTableName="cat_charge_template" />



        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="crm_seller" constraintName="fk_seller_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="crm_customer" constraintName="fk_cust_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="ar_customer_account" constraintName="fk_ca_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="billing_billing_account" constraintName="fk_ba_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="billing_user_account" constraintName="fk_ua_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />
        <addForeignKeyConstraint baseColumnNames="legal_entity_type_id" baseTableName="com_contact" constraintName="fk_com_contact_legal_entity_type_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_title" />

        <sql>CREATE INDEX crm_seller_ctb_index ON ${db.schema.adapted}crm_seller(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX crm_customer_ctb_index ON ${db.schema.adapted}crm_customer(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX ar_customer_account_ctb_index ON ${db.schema.adapted}ar_customer_account(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX billing_billing_account_ctb_index ON ${db.schema.adapted}billing_billing_account(primary_contact, title_id, bam_id)</sql>
        <sql>CREATE INDEX billing_user_account_ctb_index ON ${db.schema.adapted}billing_user_account(primary_contact, title_id, bam_id)</sql>

        <dropIndex tableName="crm_customer" indexName="crm_customer_primary_contact_index"/>
        <dropIndex tableName="ar_customer_account" indexName="ar_customer_account_index"/>
        <dropIndex tableName="account_entity" indexName="customer_code"/>
        <dropIndex tableName="billing_user_account" indexName="billing_user_account_index"/>
        <dropIndex tableName="billing_billing_account" indexName="billing_billing_account_index"/>


        <sql>CREATE INDEX crm_seller_bam_id_index ON ${db.schema.adapted}crm_seller(bam_id);</sql>
        <sql>CREATE INDEX crm_customer_bam_id_index ON ${db.schema.adapted}crm_customer(bam_id);</sql>
        <sql>CREATE INDEX ar_customer_account_bam_id_index ON ${db.schema.adapted}ar_customer_account(bam_id);</sql>
        <sql>CREATE INDEX billing_billing_account_bam_id_index ON ${db.schema.adapted}billing_billing_account(bam_id);</sql>
        <sql>CREATE INDEX billing_user_account_bam_id_index ON ${db.schema.adapted}billing_user_account(bam_id);</sql>

        <sql>CREATE INDEX crm_seller_title_id_index ON ${db.schema.adapted}crm_seller(title_id);</sql>
        <sql>CREATE INDEX crm_customer_title_id_index ON ${db.schema.adapted}crm_customer(title_id);</sql>
        <sql>CREATE INDEX ar_customer_account_title_id_index ON ${db.schema.adapted}ar_customer_account(title_id);</sql>
        <sql>CREATE INDEX billing_billing_account_title_id_index ON ${db.schema.adapted}billing_billing_account(title_id);</sql>
        <sql>CREATE INDEX billing_user_account_title_id_index ON ${db.schema.adapted}billing_user_account(title_id);</sql>
        <sql>CREATE INDEX com_contact_title_id_index ON ${db.schema.adapted}com_contact(title_id);</sql>

        <sql>CREATE INDEX crm_seller_primary_contact_index ON ${db.schema.adapted}crm_seller(primary_contact);</sql>
        <sql>CREATE INDEX crm_customer_primary_contact_index ON ${db.schema.adapted}crm_customer(primary_contact);</sql>
        <sql>CREATE INDEX ar_customer_account_primary_contact_index ON ${db.schema.adapted}ar_customer_account(primary_contact);</sql>
        <sql>CREATE INDEX billing_billing_account_primary_contact_index ON ${db.schema.adapted}billing_billing_account(primary_contact);</sql>
        <sql>CREATE INDEX billing_user_account_primary_contact_index ON ${db.schema.adapted}billing_user_account(primary_contact);</sql>
        <sql>CREATE INDEX com_contact_primary_contact_index ON ${db.schema.adapted}com_contact(primary_contact);</sql>

        <sql>CREATE INDEX crm_customer_cust_category_index ON ${db.schema.adapted}crm_customer(customer_category_id);</sql>

        <sql>CREATE INDEX seller_code ON ${db.schema.adapted}crm_seller(lower(code));</sql>
        <sql>CREATE INDEX customer_code ON ${db.schema.adapted}crm_customer(lower(code));</sql>
        <sql>CREATE INDEX ca_code ON ${db.schema.adapted}ar_customer_account(lower(code));</sql>
        <sql>CREATE INDEX ba_code ON ${db.schema.adapted}billing_billing_account(lower(code));</sql>
        <sql>CREATE INDEX ua_code ON ${db.schema.adapted}billing_user_account(lower(code));</sql>
        <sql>CREATE INDEX com_contact_code ON ${db.schema.adapted}com_contact(lower(code));</sql>

        <sql>CREATE INDEX seller_upper_code ON ${db.schema.adapted}crm_seller(UPPER(code));</sql>
        <sql>CREATE INDEX customer_upper_code ON ${db.schema.adapted}crm_customer(UPPER(code));</sql>
        <sql>CREATE INDEX ca_upper_code ON ${db.schema.adapted}ar_customer_account(UPPER(code));</sql>
        <sql>CREATE INDEX ba_upper_code ON ${db.schema.adapted}billing_billing_account(UPPER(code));</sql>
        <sql>CREATE INDEX ua_upper_code ON ${db.schema.adapted}billing_user_account(UPPER(code));</sql>
        <sql>CREATE INDEX com_contact_upper_code ON ${db.schema.adapted}com_contact(UPPER(code));</sql>

        <sql>CREATE INDEX ar_customer_account_credit_cat_index ON ${db.schema.adapted}ar_customer_account(credit_category_id)</sql>
        <sql>CREATE INDEX billing_user_account_ba_index ON ${db.schema.adapted}billing_user_account(billing_account_id)</sql>
        <sql>CREATE INDEX billing_billing_account_ca_index ON ${db.schema.adapted}billing_billing_account(customer_account_id)</sql>

        <dropTable tableName="account_entity" />
    </changeSet>

    <changeSet id="#INTRD-2421_2021012-reports" author="AndriusKarpavicius">
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT
                    TO_CHAR(ao.invoice_date,'MM') AS "Mois",
                    TO_CHAR(ao.invoice_date,'DD/MM/YYYY') AS "Date facture",
                    text('HG') AS "Code comptable",
                    ae.code AS "Client factur?",
                    text('MAI') AS "Type article",
                    split_part(bac.code, ',', 6) AS "Famille statistique",
                    split_part(bac.code, ',', 2) AS "Article",
                    trim(TO_CHAR(ia.amount_without_tax,'9999990D00')) AS "Montant HT",
                    trim(TO_CHAR(ia.quantity,'9999990')) AS "Qt? factur?e",
                    ao.reference AS "No facture",
                    ao.occ_description AS "Cat?gorie facture",
                    ao.occ_code AS "Type de pi?ce",
                    text('VEN') AS "Journal"
                FROM
                    ar_customer_account ae
                INNER JOIN ar_account_operation ao ON ao.customer_account_id = ae.id
                INNER JOIN billing_invoice i ON i.invoice_number = ao.reference
                INNER JOIN billing_invoice_agregate ia ON (ia.invoice_id = i.id AND type = 'F')
                LEFT JOIN billing_accounting_code bac ON bac.id = ia.accounting_code_id
                WHERE :START_DATE<>:END_DATE
                AND ao.invoice_date >= to_date('01/' || TO_CHAR(CURRENT_DATE,'MM/YYYY'),'DD/MM/YYYY') + interval '-12 month'
                AND ao.invoice_date <= to_date('01/' || TO_CHAR(CURRENT_DATE,'MM/YYYY'),'DD/MM/YYYY') + interval '0 month'
                ORDER BY
                    ae.code,
                    occ_code,
                    split_part(bac.code, ',', 6),
                    split_part(bac.code, ',', 2)
                ]]>
            </column>
            <where>code='SALES_JOURNAL'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
    , s.description AS "Seller description"
    , coalesce(c.code, '') AS "Customer code"
    , coalesce(replace(c.description, ',', ' '), '') AS "Customer description"
    , coalesce(ca.code, '') AS "Customer Account code"
    , coalesce(replace(ca.description, ',', ' '), '') AS "Customer Account description"
    , coalesce(ba.code, '') AS "Billing Account code"
    , coalesce(replace(ba.description, ',', ' '), '') AS "Billing Account description"
    , coalesce(ua.code, '') AS "User Account code"
    , coalesce(replace(ua.description, ',', ' '), '') AS "User Account description"
    , coalesce(su.code, '') AS "Subscription code"
    , coalesce(replace(su.description, ',', ' '), '') AS "Subscription description"
    , coalesce(ap.acces_user_id, '') AS "Access Point id"
from  crm_seller s left
    OUTER JOIN crm_customer c  on c.seller_id = s.id left
    OUTER JOIN ar_customer_account ca  on ca.customer_id = c.id left
    OUTER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id left
    OUTER JOIN billing_user_account ua  on ua.billing_account_id = ba.id left
    OUTER JOIN billing_subscription su  on su.user_account_id = ua.id left
    OUTER JOIN medina_access ap  on ap.subscription_id = su.id
where s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%'
    || :SEARCH_CRITERION || '%'  or c.code ilike '%' || :SEARCH_CRITERION
    || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  or ca.code ilike '%'
    || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%'
    || :SEARCH_CRITERION || '%'  or ua.code ilike '%' || :SEARCH_CRITERION
    || '%'  or ua.description ilike '%' || :SEARCH_CRITERION || '%'  or su.code ilike '%'
    || :SEARCH_CRITERION || '%'  or su.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ap.acces_user_id ilike '%' || :SEARCH_CRITERION || '%'
order by s.code
    ,c.code
    ,ca.code
    ,ba.code
    ,ua.code
    ,su.code
    ,ap.acces_user_id]]>
            </column>
            <where>code='FULL_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
                            , s.description AS "Seller description"
                            , coalesce(c.code, '') AS "Customer code"
                            , coalesce(replace(c.description, ',', ' '), '') AS "Customer description"
                    from  crm_seller s left
                            OUTER JOIN crm_customer c  on c.seller_id = s.id
                    where(  s.code ilike '%' || :SEARCH_CRITERION
                            || '%'  or s.description ilike '%' || :SEARCH_CRITERION || '%'  or c.code ilike '%'
                            || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
                    and (  s.code ilike '%' || :SELLER || '%'  or s.description ilike '%' || :SELLER || '%'  )
                    order by s.code
                            ,c.code]]>
            </column>
            <where>code='CUSTOMERS_PER_SELLER'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , s.code AS "Seller code"
    , s.description AS "Seller description"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION
    || '%'  or c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION
    || '%'  )  group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , s.code
    , s.description
    , c.code
    , c.description
    , ca.code
    , ca.description
    , ba.code
    , ba.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , s.code
    , c.code
    , ca.code
    , ba.code]]>
            </column>
            <where>code='INVOICED_BA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , ba.code
    , ba.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , ba.code]]>
            </column>
            <where>code='INVOICED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , ca.code
    , ca.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , ca.code]]>
            </column>
            <where>code='INVOICED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , to_char(sum(i.amount_without_tax), '9999999990.00') AS "Amount without tax"
    , to_char(sum(i.amount_with_tax), '9999999990.00') AS "Amount with tax"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
group by date_trunc('month', i.invoice_date)
    , it.code
    , it.description
    , c.code
    , c.description order by date_trunc('month', i.invoice_date) DESC
    , it.code DESC
    , c.code]]>
            </column>
            <where>code='INVOICED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,s.code AS "Seller code"
    ,s.description AS "Seller description"
    ,c.code AS "Customer code"
    ,c.description AS "Customer description"
    ,ca.code AS "Customer Account code"
    ,ca.description AS "Customer Account description"
    ,ba.code AS "Billing Account code"
    ,ba.description AS "Billing Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN billing_billing_account ba ON ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i ON i.billing_account_id = ba.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
        AND ao.reference = i.invoice_number
        AND ao.invoice_date = i.invoice_date
        AND ao.amount = abs(i.amount_with_tax)
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        s.code ilike '%' || :SEARCH_CRITERION || '%'
        OR s.description ilike '%' || :SEARCH_CRITERION || '%'
        OR c.code ilike '%' || :SEARCH_CRITERION || '%'
        OR c.description ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.description ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,s.code
    ,s.description
    ,c.code
    ,c.description
    ,ca.code
    ,ca.description
    ,ba.code
    ,ba.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,s.code
    ,c.code
    ,ca.code
    ,ba.code]]>
            </column>
            <where>code='RECORDED_BA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,ba.code AS "Billing Account code"
    ,ba.description AS "Billing Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN billing_billing_account ba ON ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i ON i.billing_account_id = ba.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
        AND ao.reference = i.invoice_number
        AND ao.invoice_date = i.invoice_date
        AND ao.amount = abs(i.amount_with_tax)
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        ba.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ba.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,ba.code
    ,ba.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,ba.code]]>
            </column>
            <where>code='RECORDED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,ca.code AS "Customer Account code"
    ,ca.description AS "Customer Account description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        ca.code ilike '%' || :SEARCH_CRITERION || '%'
        OR ca.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,ca.code
    ,ca.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,ca.code]]>
            </column>
            <where>code='RECORDED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[SELECT trim(to_char(date_trunc('month', ao.invoice_date), 'Month')) || to_char(date_trunc('month', ao.invoice_date), ' YYYY') AS "Month"
    ,c.code AS "Customer code"
    ,c.description AS "Customer description"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount DEBIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'CREDIT'
                    THEN ao.amount
                ELSE 0
                END), '99999999990.00') AS "Amount CREDIT"
    ,to_char(sum(CASE
                WHEN ao.transaction_category = 'DEBIT'
                    THEN ao.amount
                ELSE - ao.amount
                END), '99999999990.00') AS "Balance"
FROM crm_seller s
    INNER JOIN crm_customer c ON c.seller_id = s.id
    INNER JOIN ar_customer_account ca ON ca.customer_id = c.id
    INNER JOIN ar_account_operation ao ON ao.customer_account_id = ca.id
WHERE ao.invoice_date IS NOT NULL
    AND ao.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
    AND (
        c.code ilike '%' || :SEARCH_CRITERION || '%'
        OR c.description ilike '%' || :SEARCH_CRITERION || '%'
        )
GROUP BY date_trunc('month', ao.invoice_date)
    ,c.code
    ,c.description
ORDER BY date_trunc('month', ao.invoice_date) DESC
    ,c.code]]>
            </column>
            <where>code='RECORDED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select s.code AS "Seller code"
                    , s.description AS "Seller description"
                    , c.code AS "Customer code"
                    , c.description AS "Customer description"
                    , ca.code AS "Customer Account code"
                    , ca.description AS "Customer Account description"
                    , ba.code AS "Billing Account code"
                    , ba.description AS "Billing Account description"
                    , ua.code AS "User Account code"
                    , ua.description AS "User Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION || '%'  or c.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  or ca.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  or ba.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  or ua.code ilike '%'
                    || :SEARCH_CRITERION || '%'  or ua.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by s.code
                    , s.description
                    , c.code
                    , c.description
                    , ca.code
                    , ca.description
                    , ba.code
                    , ba.description
                    , ua.code
                    , ua.description order by s.code
                    , c.code
                    , ca.code
                    , ba.code
                    , ua.code
                ]]>
            </column>
            <where>code='UNBILLED_UA_HIERARCHY'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ua.code AS "User Account code"
                    , ua.description AS "User Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (   wo.STATUS = 'TREATED'
                    and EXISTS (   select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id
                and rt.STATUS = 'OPEN'   )  )  )  and(  ua.code ilike '%' || :SEARCH_CRITERION || '%'  or ua.description ilike '%'
                    || :SEARCH_CRITERION || '%'  )
                group by ua.code
                    , ua.description
                order by ua.code
                ]]>
            </column>
            <where>code='UNBILLED_UA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ba.code AS "Billing Account code"
                    , ba.description AS "Billing Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                    and(  ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by ba.code, ba.description
                order by ba.code
                ]]>
            </column>
            <where>code='UNBILLED_BA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select ca.code AS "Customer Account code"
                    , ca.description AS "Customer Account description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (  wo.STATUS = 'TREATED'
                    and EXISTS (  select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN' )  )  )
                and(  ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by ca.code, ca.description
                order by ca.code
                ]]>
            </column>
            <where>code='UNBILLED_CA'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select c.code AS "Customer code"
                    , c.description AS "Customer description"
                    , count(DISTINCT wo.id) AS "Transaction count"
                    , to_char(sum(wo.amount_without_tax), '99999999990.00') AS "Amount without tax"
                    , to_char(sum(wo.amount_with_tax), '99999999990.00') AS "Amount with tax"
                from  billing_wallet_operation wo
                    INNER JOIN billing_wallet wa  on wa.id = wo.wallet_id
                    INNER JOIN billing_user_account ua  on ua.id = wa.user_account_id
                    INNER JOIN billing_billing_account ba  on ba.id = ua.billing_account_id
                    INNER JOIN ar_customer_account ca  on ca.id = ba.customer_account_id
                    INNER JOIN crm_customer c  on c.id = ca.customer_id
                    INNER JOIN crm_seller s  on s.id = c.seller_id
                where  (  wo.STATUS = 'OPEN'  or (   wo.STATUS = 'TREATED'
                    and EXISTS (   select 1 from billing_rated_transaction rt where wo.rated_transaction_id = rt.id and rt.STATUS = 'OPEN'   )  )  )
                and(  c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION || '%'  )
                group by c.code, c.description
                order by c.code
                ]]>
            </column>
            <where>code='UNBILLED_C'</where>
        </update>
        <update tableName="dwh_report_extract">
            <column name="sql_query">
                <![CDATA[select trim(to_char(date_trunc('month', i.invoice_date), 'Month')) || to_char(date_trunc('month', i.invoice_date), ' YYYY') AS "Month"
    , to_char(i.invoice_date, 'YYYY-MM-DD') AS "Invoice date"
    , i.invoice_number AS "Invoice number"
    , to_char(i.amount_without_tax, '9999999990.00') AS "Amount without tax"
    , to_char(i.amount_with_tax, '9999999990.00') AS "Amount with tax"
    , it.code AS "Invoice type code"
    , it.description AS "Invoice type description"
    , s.code AS "Seller code"
    , s.description AS "Seller description"
    , c.code AS "Customer code"
    , c.description AS "Customer description"
    , ca.code AS "Customer Account code"
    , ca.description AS "Customer Account description"
    , ba.code AS "Billing Account code"
    , ba.description AS "Billing Account description"
from crm_seller s
    INNER JOIN crm_customer c  on c.seller_id = s.id
    INNER JOIN ar_customer_account ca  on ca.customer_id = c.id
    INNER JOIN billing_billing_account ba  on ba.customer_account_id = ca.id
    INNER JOIN billing_invoice i  on i.billing_account_id = ba.id
    INNER JOIN billing_invoice_type it  on it.id = i.invoice_type_id
where i.invoice_date > (date_trunc('month', CURRENT_DATE) - CAST(:MONTH_INTERVAL || ' month' AS INTERVAL))
and(  s.code ilike '%' || :SEARCH_CRITERION || '%'  or s.description ilike '%' || :SEARCH_CRITERION
    || '%'  or c.code ilike '%' || :SEARCH_CRITERION || '%'  or c.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ca.code ilike '%' || :SEARCH_CRITERION || '%'  or ca.description ilike '%' || :SEARCH_CRITERION
    || '%'  or ba.code ilike '%' || :SEARCH_CRITERION || '%'  or ba.description ilike '%' || :SEARCH_CRITERION
    || '%'  )
order by date_trunc('month', i.invoice_date) DESC
    , i.invoice_date DESC
    , it.code
    , i.invoice_number]]>
            </column>
            <where>code='INVOICES'</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-2421_20211018-reports" author="AndriusKarpavicius">
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
                package org.meveo.service.script.presale; import java.io.File; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.apache.commons.lang.time.DateUtils; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh */ public class KPIAgedBalanceReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(KPIAgedBalanceReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); String query = "Select count(distinct ao.customerAccount.id) " + "from AccountOperation ao where ao.transactionCategory = 'DEBIT'  and  ao.dueDate <=:dateTo and ao.dueDate >:dateFrom "; Map<String, Object> params = new HashMap<String, Object>(); params.put("dateFrom", DateUtils.addDays(new Date(), -30)); params.put("dateTo", new Date()); List<Long> count_now_30 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", DateUtils.addDays(new Date(), -60)); params.put("dateTo", DateUtils.addDays(new Date(), -30)); List<Long> count_30_60 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", DateUtils.addDays(new Date(), -90)); params.put("dateTo", DateUtils.addDays(new Date(), -60)); List<Long> count_60_90 = (List<Long>) customerAccountService.executeSelectQuery(query, params); params.put("dateFrom", new Date(1)); params.put("dateTo", DateUtils.addDays(new Date(), -90)); List<Long> count_90_up = (List<Long>) customerAccountService.executeSelectQuery(query, params); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "DEBT_TIER", "Number of accounts" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); csvBuilder.appendValue("0_30_days"); csvBuilder.appendValue("" + count_now_30.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("30_60_days"); csvBuilder.appendValue("" + count_30_60.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("60_90_days"); csvBuilder.appendValue("" + count_60_90.get(0)); csvBuilder.startNewLine(); csvBuilder.appendValue("90_days_up"); csvBuilder.appendValue("" + count_90_up.get(0)); csvBuilder.startNewLine(); csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on AgedBalanceReporting:", e); throw new BusinessException(e.getMessage()); } } }
                ]]>
            </column>
            <where>id=-16</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
                package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * */ public class KPICustomerRevenuReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(KPICustomerRevenuReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Date startDate = (Date) executeContext.get(ReportExtractScript.START_DATE); Date endDate = (Date) executeContext.get(ReportExtractScript.END_DATE); Map<String, Object> params = new HashMap<String, Object>(); params.put("startDateIN", startDate); params.put("endDateIN", endDate); String query = "Select ao.customerAccount.id , sum (ao.amount) as sum_amount from AccountOperation ao where ao.transactionCategory = 'DEBIT' and ao.dueDate >=:startDateIN " + "and ao.dueDate <:endDateIN  group by ao.customerAccount order by sum_amount "; List<Object[]> rows = (List<Object[]>) customerAccountService.executeSelectQuery(query, params); log.debug("execute columns size:{}", rows == null ? null : rows.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(KPICustomerRevenuReporting.FILENAME)); long cpt0_50000 = 0; long cpt50000_100000 = 0; long cpt100000_500000 = 0; long cpt500000_1000000 = 0; long cpt1000000Up = 0; CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "RANGE", "NB_CUSTOMERS" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] row : rows) { log.info("(BigDecimal) row[1]:"+(BigDecimal) row[1]); if (((BigDecimal) row[1]).compareTo(new BigDecimal(50000)) < 0) { cpt0_50000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(100000)) < 0) { cpt50000_100000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(500000)) < 0) { cpt100000_500000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(1000000)) < 0) { cpt500000_1000000++; continue; } if (((BigDecimal) row[1]).compareTo(new BigDecimal(1000000)) >= 0) { cpt1000000Up++; continue; } } csvBuilder.appendValue("0<50000"); csvBuilder.appendValue("" + cpt0_50000); csvBuilder.startNewLine(); csvBuilder.appendValue("50000<100000"); csvBuilder.appendValue("" + cpt50000_100000); csvBuilder.startNewLine(); csvBuilder.appendValue("100000<500000"); csvBuilder.appendValue("" + cpt100000_500000); csvBuilder.startNewLine(); csvBuilder.appendValue("500000<1000000"); csvBuilder.appendValue("" + cpt500000_1000000); csvBuilder.startNewLine(); csvBuilder.appendValue("1000000<"); csvBuilder.appendValue("" + cpt1000000Up); csvBuilder.startNewLine(); csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on KPICustomerRevenuReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if (amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }
                ]]>
            </column>
            <where>id=-17</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.apache.commons.lang.time.DateUtils; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.model.payments.CustomerAccount; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * @corrector jpviegas */ public class AgedBalanceReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(AgedBalanceReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Map<String, Object> params = new HashMap<String, Object>(); params.put("sysdate30", DateUtils.addDays(new Date(), -30)); params.put("sysdate60", DateUtils.addDays(new Date(), -60)); params.put("sysdate90", DateUtils.addDays(new Date(), -90)); String query = "Select ao.customerAccount.id , " + "sum (case when ao.dueDate <= current_date() and ao.dueDate >:sysdate30 then  ao.amount else 0 end ) as sum_0_30, " + "sum (case when ao.dueDate <=:sysdate30 and ao.dueDate >:sysdate60 then  ao.amount else 0 end ) as sum_30_60, " + "sum (case when ao.dueDate <=:sysdate60 and ao.dueDate >:sysdate90 then  ao.amount else 0 end ) as sum_60_90, " + "sum (case when ao.dueDate <=:sysdate90  then  ao.amount else 0 end ) as sum_90_up " + "from AccountOperation ao where ao.transactionCategory = 'DEBIT'  group by ao.customerAccount"; List<Object[]> rows = (List<Object[]>)  customerAccountService.executeSelectQuery(query,params); log.debug("execute rows size:{}", rows == null ? null : rows.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "CA_DESC", "C_DESC","DEBT_TIER_0_30_DAYS","DEBT_TIER_30_60_DAYS","DEBT_TIER_60_90_DAYS","DEBT_TIER_90_DAYS" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] row : rows) { CustomerAccount ca = customerAccountService.findById(((Long)row[0])); csvBuilder.appendValue(ca.getDescription()); csvBuilder.appendValue(ca.getCustomer().getDescription()); csvBuilder.appendValue(round((BigDecimal)row[1])); csvBuilder.appendValue(round((BigDecimal)row[2])); csvBuilder.appendValue(round((BigDecimal)row[3])); csvBuilder.appendValue(round((BigDecimal)row[4])); csvBuilder.startNewLine(); } csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on AgedBalanceReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if(amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }]]>
            </column>
            <where>id=-12</where>
        </update>
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[package org.meveo.service.script.presale; import java.io.File; import java.math.BigDecimal; import java.math.RoundingMode; import java.util.Date; import java.util.HashMap; import java.util.List; import java.util.Map; import org.meveo.admin.exception.BusinessException; import org.meveo.commons.utils.CsvBuilder; import org.meveo.model.payments.CustomerAccount; import org.meveo.service.payments.impl.AccountOperationService; import org.meveo.service.payments.impl.CustomerAccountService; import org.meveo.service.script.finance.ReportExtractScript; import org.slf4j.Logger; import org.slf4j.LoggerFactory; /** * @author anasseh * */ public class CustomerRevenuReporting extends ReportExtractScript { private static final Logger log = LoggerFactory.getLogger(CustomerRevenuReporting.class); private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName()); @Override public void execute(Map<String, Object> executeContext) throws BusinessException { try { log.debug("execute executeContext:{}", executeContext); Date startDate = (Date) executeContext.get(ReportExtractScript.START_DATE); Date endDate = (Date) executeContext.get(ReportExtractScript.END_DATE); Map<String, Object> params = new HashMap<String, Object>(); params.put("startDateIN", startDate); params.put("endDateIN", endDate); String query = "Select ao.customerAccount.id , sum (ao.amount) as sum_amount from AccountOperation ao where ao.transactionCategory = 'DEBIT' and ao.dueDate >=:startDateIN " + "and ao.dueDate <:endDateIN  group by ao.customerAccount order by sum_amount desc"; List<Object[]> aos = (List<Object[]>)  customerAccountService.executeSelectQuery(query,params); log.debug("execute aos size:{}", aos == null ? null : aos.size()); String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR)); String filename = String.valueOf(executeContext.get(CustomerRevenuReporting.FILENAME)); CsvBuilder csvBuilder = new CsvBuilder(";", false); String[] header = { "CA_DESC", "C_DESC","SUM_REVENUE" }; csvBuilder.appendValues(header); csvBuilder.startNewLine(); for (Object[] ao : aos) { CustomerAccount ca = customerAccountService.findById(((Long)ao[0])); csvBuilder.appendValue(ca.getDescription()); csvBuilder.appendValue(ca.getCustomer().getDescription()); csvBuilder.appendValue(round((BigDecimal)ao[1])); csvBuilder.startNewLine(); } csvBuilder.toFile(dirOutput + File.separator + filename); log.debug("execute file generated:{}", dirOutput + File.separator + filename); } catch (Exception e) { log.error("Error on CustomerRevenuReporting:", e); throw new BusinessException(e.getMessage()); } } private String round(BigDecimal amount) { if(amount == null) { return ""; } if (amount.scale() > 4) { String amountAsString = "" + amount; amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4)); } amount = amount.setScale(2, RoundingMode.UP); return amount.toPlainString(); } }]]>
            </column>
            <where>id=-13</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-1166_20211018_Business_attributes_default_value" author="MohammedELAZZOUZI">
    	<update tableName="cpq_attribute">
    		<column name="attribute_category" value="REGULAR"></column>
            <where>attribute_category is null</where>
    	</update>
    	<addColumn tableName="cpq_attribute">
    		<column name="el_value" type="varchar(255)"/>
    	</addColumn>
    	<addNotNullConstraint tableName="cpq_attribute" columnName="attribute_category"/>
    </changeSet>
	<changeSet id="INTRD-2548_20211027" author="YoussefIZEM">
		<addColumn tableName="com_message_template">
			<column name="channel" type="varchar(255)"/>
			<column name="trading_language_id" type="bigint"/>
			<column name="is_active" type="${type.boolean}" defaultValueNumeric="1"/>
		</addColumn>
        <addForeignKeyConstraint baseColumnNames="trading_language_id" baseTableName="com_message_template" constraintName="fk_language_message_template" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_language" />
	</changeSet>
    <changeSet id="INTRD-2679_20211027" author="khalidHORRI">
        <dropColumn columnName="language_id" tableName="dunning_pause_reasons"/>
        <dropColumn columnName="language_id" tableName="dunning_stop_reasons"/>
        <dropColumn columnName="language_id" tableName="invoice_dunning_statuses"/>
        <dropColumn columnName="language_id" tableName="dunning_collection_plan_statuses"/>
        <addUniqueConstraint columnNames="pause_reason, dunning_settings_id" tableName="dunning_pause_reasons"/>
        <addUniqueConstraint columnNames="stop_reason, dunning_settings_id" tableName="dunning_stop_reasons"/>
    </changeSet>

    <changeSet id="INTRD-2601_20211102" author="AmineBENAICHA" failOnError="false">
    	<dropForeignKeyConstraint baseTableName="dunning_collection_management" constraintName="fk_dunning_collection_management_dunning_settings"/>
	    <dropPrimaryKey constraintName="dunning_collection_management_pkey" tableName="dunning_collection_management"/>
    </changeSet>

    <changeSet id="#FIX-INTRD-2601_20211102-changeset" author="AbdelmounaimAkadid" failOnError="false">
    	<renameTable oldTableName="dunning_collection_management" newTableName="dunning_agent"/>
		<renameSequence oldSequenceName="dunning_collection_management_seq" newSequenceName="dunning_agent_seq" />
    	<!--  <addPrimaryKey columnNames="id" constraintName="dunning_agent_pkey" tableName="dunning_agent" />  -->
		<addForeignKeyConstraint constraintName="fk_dunning_agent_dunning_settings" referencedTableName="dunning_settings"
                                 baseColumnNames="dunning_settings_id" baseTableName="dunning_agent" referencedColumnNames="id" />
		<addColumn tableName="ar_dunning_action">
			<column name="dunning_agent_id" type="bigint"/>
		</addColumn>
		<addForeignKeyConstraint constraintName="fk_dunning_action_agent"
			baseColumnNames="dunning_agent_id" baseTableName="ar_dunning_action"
            referencedColumnNames="id" referencedTableName="dunning_agent"
			deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION"/>
    </changeSet>
    
    <changeSet id="#2333_20211021" author="anasseh">
        <addColumn tableName="ar_payment_token">
            <column name="token_3ds_id" type="varchar(250)"/>
   		</addColumn>
    </changeSet>
    <changeSet id="#INTRD-1254" author="MohammedELAZZOUZI">
        <addColumn tableName="cpq_order_offer">
            <column name="user_account_id" type="bigint"/>
   		</addColumn>
   		<addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_order_offer" constraintName="fk_cpq_order_offer_user_account" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>
    
    <changeSet id="INTRD-2868_20211105" author="TarikFA.">
    	<addColumn tableName="crm_provider">
    		<column name="cdr_deduplicationkey_el" type="varchar(500)" />
    	</addColumn>
    </changeSet>

	<changeSet id="#INTRD-2764-20211104" author="HatimOUDAD">
        
        <createSequence sequenceName="dunning_collection_plan_seq" startValue="1" />
        <createTable tableName="dunning_collection_plan">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_collection_plan_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
            <column name="collection_plan_number" type="varchar(255)" />
            <column name="related_policy_id" type="bigint" />
            <column name="initial_collection_plan_id" type="bigint" />
            <column name="billing_account_id" type="bigint" />
            <column name="related_invoice_id" type="bigint" />
            <column name="pause_reason_id" type="bigint" />
            <column name="stop_reason_id" type="bigint" />
            
            <column name="current_dunning_level_sequence" type="int4" />
            
            
            
            <column name="start_date" type="datetime" />
            <column name="days_open" type="int4" />
             <column name="close_date" type="datetime" />
            
            <column name="status_id" type="bigint" />
            <column name="paused_until_date" type="datetime" />
            <column name="balance" type="numeric(23, 12)"/>
            <column name="retry_payment_on_resume_date" type="${type.boolean}" defaultValueNumeric="0"/>
            
            <column name="next_action" type="varchar(255)" />
            <column name="next_action_date" type="datetime" />
            <column name="last_action" type="varchar(255)" />
            <column name="last_action_date" type="datetime" />
            <column name="total_dunning_levels" type="int4" />
            <column name="pause_duration" type="int4" />
            
            
        </createTable>
        
        
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_billing_account"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
        						 
		<addForeignKeyConstraint baseColumnNames="pause_reason_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_pause_reason"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_pause_reasons" /> 
        						        
        <addForeignKeyConstraint baseColumnNames="stop_reason_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_stop_reason"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_stop_reasons" /> 
        						 
        <addForeignKeyConstraint baseColumnNames="related_policy_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_related_policy"
        						 deferrable="false" initiallyDeferred="false"
        						 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_policy" /> 
        
        <addForeignKeyConstraint baseColumnNames="status_id" baseTableName="dunning_collection_plan" constraintName="fk_dunning_collection_plan_status"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan_statuses" />
                                 
        <addForeignKeyConstraint baseColumnNames="initial_collection_plan_id" baseTableName="dunning_collection_plan" constraintName="fk_initial_collection_plan"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
                                 
        <addForeignKeyConstraint baseColumnNames="related_invoice_id" baseTableName="dunning_collection_plan" constraintName="fk_collection_plan_related_invoice"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />                        
        
    </changeSet>
    <changeSet id="INTRD-30_2021114" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="dunning_min_balance_trigger_currency"
                                  constraintName="fk_dunning_min_balance_trigger_currency_id"/>
        <dropForeignKeyConstraint baseTableName="dunning_determine_level_by"
                                  constraintName="fk_dunning_determine_level_by_id"/>
        <dropTable tableName="dunning_min_balance_trigger_currency"/>
        <dropTable tableName="dunning_determine_level_by"/>
        <addColumn tableName="dunning_policy">
            <column name="min_balance_trigger_currency_id" type="bigint"/>
            <column name="determine_level_by" type="varchar(255)">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="min_balance_trigger_currency_id" baseTableName="dunning_policy"
                                 constraintName="fk_dunning_min_balance_currency_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="adm_currency"/>
    </changeSet>

    <changeSet id="INTRD-2449_2021114" author="ZBariki">
        <dropDefaultValue columnName="rule_line_joint" tableName="dunning_policy_rule_line"/>
	</changeSet>

    <changeSet id="INTRD-2418_20211105" author="TarikFA.">
    	<dropForeignKeyConstraint baseTableName="dunning_policy_level" constraintName="fk_dunning_policy_level_collection_plan_status"/>
		<addForeignKeyConstraint baseTableName="dunning_policy_level"
								baseColumnNames="collection_plan_status_id"
								constraintName="fk_dunning_policy_level_collection_plan_status"
								deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
								onUpdate="NO ACTION" referencedColumnNames="id"
								referencedTableName="dunning_collection_plan_statuses" />
		<dropTable tableName="collection_plan_status"/>
    </changeSet>
    <changeSet id="#INTRD-2800_04112021" author="AbdelkaderBouazza">
        <addColumn tableName="crm_provider">
            <column name="payment_deferral" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="payment_plan" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>
    
      <changeSet id="INTRD-2959_11082021" author="Mbarek-Ay">
     <addColumn tableName="cpq_quote">
            <column name="user_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_quote" constraintName="fk_cpq_quote_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
                                 
      <addColumn tableName="quote_offer">
      <column name="user_account_id" type="bigint" />
      </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="quote_offer" constraintName="fk_quote_offer_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" /> 
    </changeSet>

    <changeSet author="MohammedELAZZOUZI"  id="#INTRD-1889">
        <addColumn tableName="cat_charge_template">
            <column name="status" type="varchar(255)"/>
        </addColumn>
    	<update tableName="cat_charge_template">
	        <column name="status" value="ACTIVE"/>
	        <where>status is null</where>
    	</update>
        <addNotNullConstraint columnName="status" tableName="cat_charge_template"/>
    </changeSet>

	<changeSet id="#INTRD-1419_20211108" author="HHanine">
	    <addColumn tableName="crm_provider">
	        <column name="maximum_delay" type="int4" />
	        <column name="maximum_deferral_per_invoice" type="int4" />
	    </addColumn>
	</changeSet>
	<changeSet id="#INTRD-1418_20211202" author="HHanine">
	    <createTable tableName="crm_provider_payment_plan_policy_pay_methods">
            <column name="provider_id" type="BIGINT" />
            <column name="payment_method" type="varchar(255)" />
        </createTable>
        <addUniqueConstraint columnNames="provider_id, payment_method" constraintName="uk_prov_paym_plan_policy_pay_meth" tableName="crm_provider_payment_plan_policy_pay_methods" />
	   	<addColumn tableName="ar_credit_category">
			<column name="provider_id" type="BIGINT" />
	    </addColumn>	    
	    <addColumn tableName="crm_provider">	    
	   		<column name="dunning_default_pause_reason_id" type="BIGINT" />
			<column name="min_allowed_receivable_amount" type="numeric(23, 12)" />
			<column name="max_allowed_receivable_amount" type="numeric(23, 12)" />
			<column name="min_installment_amount" type="numeric(23, 12)" />
			<column name="theres_hold_for_approval" type="numeric(23, 12)" />
			<column name="max_payment_plan_duration" type="int4" />
			<column name="default_installment_count" type="int4" />
			<column name="default_fee_per_installment_plan" type="int4" defaultValueNumeric="0" />
			<column name="installment_amount_rounding" type="int4" defaultValueNumeric="2" />
			<column name="split_evenly" type="${type.boolean}" defaultValueNumeric="1">
				<constraints nullable="false" />
			</column>	
			<column name="allow_custom_installment_plan" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="add_interest_rate" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="add_installment_fee" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="default_block_payments" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="require_internal_approval" type="${type.boolean}" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>	
			<column name="default_interest_rate" type="int4" defaultValueNumeric="0">
				<constraints nullable="false" />
			</column>
			<column name="default_recurrence_unit" type="varchar(255)" />
			<column name="action_on_remaining_amount" type="varchar(255)" />
			<column name="clearing_priority" type="varchar(255)" />
	    </addColumn>
		<addForeignKeyConstraint baseColumnNames="dunning_default_pause_reason_id" baseTableName="crm_provider" constraintName="fk_dunning_default_pause_reason_provider" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_pause_reasons" />	
	    <addForeignKeyConstraint baseColumnNames="provider_id" baseTableName="ar_credit_category" constraintName="fk_acc_id_payment_token" deferrable="false" initiallyDeferred="false" onDelete="CASCADE"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_provider" />
	</changeSet>

    <changeSet id="#INTRD-2963_20211109" author="AbdelkaderBouazza">
        <dropTable tableName="invoice_dunning_statuses" cascadeConstraints="true"/>
    </changeSet>
    
    <changeSet id="#INTRD-2961_20211109" author="AmineBENAICHA">
		<renameColumn tableName="dunning_collection_plan_statuses"
			newColumnName="description" oldColumnName="context"
			columnDataType="varchar(255)" />
	    <addColumn tableName="dunning_collection_plan_statuses">
	        <column name="color_code" type="varchar(50)" />
	    </addColumn>
	</changeSet>

	<changeSet id="#INTRD-2973_20211110" author="AmineBENAICHA">
		<createSequence sequenceName="dunning_level_instance_seq" startValue="1" />
	    <createTable tableName="dunning_level_instance">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_level_instance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
			<column name="sequence" type="int4">
				<constraints nullable="false" />
			</column>
			<column name="days_overdue" type="int4" >
                <constraints nullable="false" />
            </column>
            <column name="dunning_policy_level_id" type="bigint" />
            <column name="dunning_collection_plan_id" type="bigint" />
            <column name="dunning_collection_plan_status_id" type="bigint"/>
            <column name="level_status" type="varchar(255)" />
		</createTable>

		<addForeignKeyConstraint baseColumnNames="dunning_policy_level_id" baseTableName="dunning_level_instance"
			constraintName="fk_dunning_policy_level" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_policy_level" />

        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_id" baseTableName="dunning_level_instance"
        	constraintName="fk_dunning_level_instance_collection_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />

        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_status_id" baseTableName="dunning_level_instance"
        	constraintName="fk_dunning_collection_plan_statuses" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan_statuses" />

		<createSequence sequenceName="dunning_action_instance_seq" startValue="1" />
		<createTable tableName="dunning_action_instance">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="dunning_action_instance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
			<column name="action_type" type="varchar(255)">
				<constraints nullable="false" />
			</column>
			<column name="code" type="varchar(255)" />
			<column name="description" type="varchar(255)" />
			<column name="action_mode" type="varchar(255)" >
                <constraints nullable="false" />
            </column>
            <column name="dunning_agent_id" type="bigint" />
            <column name="action_restult" type="varchar(255)" />
            <column name="action_status" type="varchar(255)" />
            <column name="dunning_collection_plan_id" type="bigint" />
            <column name="dunning_level_instance_id" type="bigint" />
		</createTable>

		<addUniqueConstraint columnNames="code" constraintName="uk_dunning_action_instance_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_action_instance" />
            
        <addForeignKeyConstraint baseColumnNames="dunning_collection_plan_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_action_instance_collection_plan" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
            
        <addForeignKeyConstraint baseColumnNames="dunning_level_instance_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_level_instance" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_level_instance" />
	</changeSet>

	<changeSet id="#INTRD-3250part2_20211123" author="AmineBENAICHA" failOnError="false">
		<addForeignKeyConstraint baseColumnNames="dunning_agent_id" baseTableName="dunning_action_instance"
        	constraintName="fk_dunning_action_instance_agent" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_agent" />
	</changeSet>
	
	<changeSet id="#INTRD-3250_20211123" author="HatimOUDAD">
	    <addColumn tableName="dunning_action_instance">
	        <column name="dunning_action_id" type="bigint" />
	    </addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-3307_20211125" author="AmineBENAICHA">
	    <addColumn tableName="dunning_level_instance">
	        <column name="dunning_level_id" type="bigint" />
	    </addColumn>
	    <addForeignKeyConstraint baseColumnNames="dunning_level_id" baseTableName="dunning_level_instance" constraintName="fk_dunning_level_instance_dunning_level"
        	deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_level" />
	</changeSet>

    <changeSet id="#INTRD-3426_202112012" author="ZBariki">
        <modifyDataType columnName="start_date" newDataType="date" tableName="sub_accounting_period"/>
        <modifyDataType columnName="end_date" newDataType="date" tableName="sub_accounting_period"/>
    </changeSet>
	
	 <changeSet id="INTRD-2425_20211014" author="Mbarek-Ay">
     <addColumn tableName="billing_invoice">
            <column name="cpq_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />
    </changeSet>
    <changeSet id="INTRD-1421-Payment_deferral" author="AbdelkaderBouazza">
        <addColumn tableName="ar_account_operation">
            <column name="payment_action" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="payment_deferral_count" type="int4">
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>

	<changeSet id="INTRD-3610_20211210" author="TarikRabeh">
	    <addColumn tableName="billing_accounting_article">
	        <column name ="unit_price" type="numeric(23, 12)" />
	    </addColumn>
	</changeSet>

	<changeSet id="INTRD-3721_20211216" author="AmineBENAICHA">
	    <addColumn tableName="cpq_order_offer">
	        <column name ="order_line_type" type="varchar(10)" />
	    </addColumn>
	    <addColumn tableName="quote_offer">
	        <column name ="quote_line_type" type="varchar(10)" />
	    </addColumn>
	</changeSet>
    
    <changeSet id="INTRD-3781_20211217" author="hichamElHaloui">
        <createSequence sequenceName="security_deposit_settings_seq" startValue="1" />
        <createTable tableName="security_deposit_settings">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_settings_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="use_security_deposit" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="max_amount_security_deposit" type="numeric(23, 12)"  />
            <column name="max_amount_consumer" type="numeric(23, 12)"  />
            <column name="auto_refund" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_renew" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_transfer" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
    </changeSet>

    <changeSet id="INTRD-3707_20211216" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="dunning_level_instance" constraintName="fk_dunning_policy_level"/>
        <dropColumn tableName="dunning_level_instance">
            <column name="dunning_policy_level_id" />
        </dropColumn>
    </changeSet>
    <changeSet id="INTRD-3807_20211227" author="HHanine">
 		<addColumn tableName="billing_accounting_article">
            <column name="invoice_type_el" type="varchar(255)" />
            <column name="invoice_type_id" type="bigint" />
	    </addColumn>
		<addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="billing_accounting_article"
            constraintName="fk_billing_accounting_article_invoice_type" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>


    <changeSet id="#INTRD-3461_20212128" author="hichamElHaloui">

        <createSequence sequenceName="security_deposit_templat_seq" startValue="1" />

        <createTable tableName="security_deposit_templat">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_templat_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="template_name" type="varchar(100)" />
            <column name="currency_id" type="bigint" />
            <column name="allow_validity_date" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="allow_validity_period" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="min_amount" type="numeric(23, 12)" />
            <column name="max_amount" type="numeric(23, 12)" />
            <column name="status" type="varchar(255)" />
            <column name="number_instantiation" type="int" />
        </createTable>

            <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="security_deposit_templat"
			constraintName="fk_adm_currency_security_deposit_templat" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />


		<createSequence sequenceName="security_deposit_seq" startValue="1" />

        <createTable tableName="security_deposit">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="cf_values" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}" />
            <column name="templat_id" type="bigint" />
            <column name="currency_id" type="bigint" />
            <column name="customer_account_id" type="bigint"/>
            <column name="validity_date" type="date" />
            <column name="validity_period" type="int4" />
            <column name="validity_period_unit" type="varchar(255)" />
            <column name="amount" type="numeric(23, 12)" />
            <column name="current_balance" type="numeric(23, 12)" />
            <column name="status" type="varchar(255)" />
            <column name="product_instance" type="varchar(255)"/>
            <column name="subscription_id" type="bigint"/>
            <column name="product_id" type="bigint"/>
            <column name="external_reference" type="varchar(255)"/>

		</createTable>

	<addForeignKeyConstraint baseColumnNames="templat_id" baseTableName="security_deposit"
			constraintName="fk_security_deposit_templat_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="security_deposit_templat" />

    <addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="security_deposit"
			constraintName="fk_adm_currency_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="adm_currency" />

    <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="security_deposit"
			constraintName="fk_ar_customer_account_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

    <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="security_deposit"
			constraintName="fk_billing_subscription_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

     <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="security_deposit"
			constraintName="fk_cpq_product_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

    </changeSet>
    
    <changeSet id="#INTRD-4072_20211229" author="AmineBENAICHA">
    	<renameTable newTableName="finance_settings" oldTableName="security_deposit_settings"/>
    	<renameSequence newSequenceName="finance_settings_seq" oldSequenceName="security_deposit_settings_seq" />

    	<dropPrimaryKey constraintName="security_deposit_settings_pkey"  
            schemaName="public"
            tableName="finance_settings"/>
        <addPrimaryKey columnNames="id" constraintName="finance_settings_pkey" tableName="finance_settings" />
    </changeSet>
    
    <changeSet id="#INTRD-4178_20220106" author="AmineBENAICHA">
    	<dropUniqueConstraint constraintName="uk_dunning_action_instance_code" tableName="dunning_action_instance"/>
    	<addUniqueConstraint columnNames="code, dunning_level_instance_id" constraintName="uk_dunning_action_instance_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="dunning_action_instance" />
    </changeSet>

    <changeSet id="#INTRD-4457_20220117" author="hichamElHaloui">
        <dropForeignKeyConstraint baseTableName="security_deposit" constraintName="fk_cpq_product_security_deposit"/>
        <dropColumn tableName="security_deposit">
            <column name="product_instance"></column>
            <column name="product_id"></column>
        </dropColumn>
        <addColumn tableName="security_deposit">
            <column name="invoice_receipt_number" type="varchar(255)" />
            <column name="service_instance_id" type="bigint"/>
        </addColumn>

         <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="security_deposit"
			constraintName="fk_billing_service_instance_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />

    </changeSet>

     <changeSet id="#INTRD-4454_20220117" author="hichamElHaloui">
         <dropColumn tableName="finance_settings">
            <column name="allow_renew"  />
            <column name="allow_transfer"  />
        </dropColumn>
     </changeSet>

    <changeSet id="#INTRD-4410_20220117" author="IlyassTalal">
    	<addColumn tableName="billing_user_account">
            <column name="parent_useraccount_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="parent_useraccount_id" baseTableName="billing_user_account" constraintName="fk_user_account_parent" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
    </changeSet>
    
    <changeSet id="#INTRD-4677_20220125" author="hatimOUDAD">
        <addColumn tableName="billing_user_account">
            <column name="is_consumer" type="${type.boolean}" defaultValueNumeric="1">
            </column>
        </addColumn>
     </changeSet>

    <changeSet id="#INTRD-4705_20220127" author="AbdelmounaimAkadid">
	  	<createIndex indexName="billing_wallet_operation_charge_instance_idx" tableName="billing_wallet_operation">
	      	<column name="charge_instance_id"/>
	  	</createIndex>
	</changeSet>

	<changeSet id="#INTRD-4705-cpq_20220127" author="AbdelmounaimAkadid">
		<createIndex indexName="cpq_attribute_instance_service_instance_idx" tableName="cpq_attribute_instance">
	      	<column name="service_instance_id"/>
	  	</createIndex>
	</changeSet>
	<changeSet id="#INTRD-5636-20220318" author="hhanine">
		<createSequence sequenceName="exchange_rate_seq" startValue="1" />
		<createTable tableName="exchange_rate">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
			    <constraints nullable="false" primaryKey="true" primaryKeyName="exchange_rate_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
			    <constraints nullable="false" />
			</column>
			<column name="created" type="datetime">
			    <constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />

			<column name="trading_currency_id" type="bigint" />
			<column name="exchange_rate" type="numeric(23, 6)" />
			<column name="from_date" type="datetime" />
			<column name="current_rate" type="${type.boolean}" defaultValueNumeric="0">
			<constraints nullable="false" />
			</column>
		</createTable>
		<addForeignKeyConstraint baseColumnNames="trading_currency_id" baseTableName="exchange_rate" constraintName="fk_exchange_rate_trading_currency" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
	            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
	</changeSet>
	<changeSet id="#INTRD-4654_20220203" author="AbdelmounaimAkadid">
		<addColumn tableName="security_deposit">
			<column name="refund_reason" type="varchar(255)"/>
			<column name="cancel_reason" type="varchar(255)"/>
		</addColumn>
		<createSequence sequenceName="security_deposit_transaction_seq" startValue="1" />
		
		<createTable tableName="security_deposit_transaction">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="security_deposit_transaction_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="code" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="varchar(255)" />
		
			<column name="security_deposit_id" type="bigint" />
			<column name="account_operation_id" type="bigint" />
			<column name="security_deposit_operation" type="varchar(255)" />	            
			<column name="amount" type="numeric(23, 12)" />
			<column name="transactionDate" type="date" />
			<column name="transaction_category" type="varchar(255)" />
		</createTable>
		
		<addForeignKeyConstraint baseColumnNames="security_deposit_id" baseTableName="security_deposit_transaction"
			constraintName="fk_security_deposit_security_deposit_transaction" deferrable="false" initiallyDeferred="false"
			onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="security_deposit" />
			
		<addForeignKeyConstraint baseColumnNames="account_operation_id" baseTableName="security_deposit_transaction"
			constraintName="fk_ar_account_operation_security_deposit_transaction" deferrable="false" initiallyDeferred="false"
			onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />
	
	</changeSet>
	
	<changeSet id="#INTRD-4654_20220203_2" author="HanineHicham">
	    <dropColumn tableName="security_deposit_transaction">
            <column name="transactionDate"></column>
        </dropColumn>
        <addColumn tableName="security_deposit_transaction">
			<column name="cf_values" type="${type.json}"></column>
			<column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
			<column name="transaction_date" type="date" />
		</addColumn>
	</changeSet>

     <changeSet id="#INTRD-4777_20220208" author="hichamELHALOUI">
		<addUniqueConstraint columnNames="template_name" constraintName="uk_security_deposit_template_name" deferrable="false" disabled="false" initiallyDeferred="false" tableName="security_deposit_templat" />
	</changeSet>
    <changeSet id="#4065_2022" author="Mounir_BOUKAYOUA">
        <addColumn tableName="crm_customer">
            <column name="anonymization_date" type="datetime" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-4950-20220209" author="MohammedSTITANE">
        <createSequence sequenceName="ar_accounting_scheme_seq" startValue="1" />
        <createTable tableName="ar_accounting_scheme">
            <column name="id" type="${cast.long}" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_accounting_scheme_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="ar_accounting_scheme_pkey_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="long_description" type="varchar(2000)"/>
            <column name="script_instance_id" type="${cast.long}"/>
        </createTable>
        <addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="ar_accounting_scheme" constraintName="fk_acc_scheme_script_inst_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="meveo_script_instance"/>

        <addColumn tableName="ar_occ_template">
            <column name="accounting_scheme_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="accounting_scheme_id" baseTableName="ar_occ_template" constraintName="fk_occ_tmplt_accnt_scheme_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="ar_accounting_scheme"/>
    </changeSet>
    
     <changeSet id="#INTRD-4682_20220209" author="AndriusKarpavicius">
        <renameColumn tableName="adm_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="${type.boolean}"/>
        <renameColumn tableName="adm_role_secured_entity" oldColumnName="disable" newColumnName="disabled" columnDataType="${type.boolean}"/>
     </changeSet>
    <changeSet id="#INTRD-5200_2022-02-08" author="MohammedSTITANE">
	    <!--  comment is reserved word in oracle database-->
	    <renameColumn  oldColumnName="comment" newColumnName="comment_text" tableName="billing_invoice"/>
	    <renameColumn  oldColumnName="comment" newColumnName="comment_text" tableName="ar_account_operation"/>
	</changeSet>
	<changeSet id="#INTRD-5274_2022-02-22" author="HichamHANINE">
	    <dropForeignKeyConstraint baseTableName="billing_accounting_article" constraintName="fk_billing_accounting_article_invoice_type"/>
		<addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="billing_accounting_article"
            constraintName="fk_billing_accounting_article_invoice_type" deferrable="false"
            initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
            referencedColumnNames="id" referencedTableName="billing_invoice_type" />
	</changeSet>

    <changeSet id="#INTRD-5286_2022-02_23" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="amount_without_tax_before_discount" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8743_20220802" author="HichamHANINE">
		<addColumn tableName="billing_rated_transaction">
            <column name="reject_reason" type="varchar(4000)" />
            <column name="origin_billing_account" type="bigint" />
        </addColumn>

		<addForeignKeyConstraint baseColumnNames="origin_billing_account" baseTableName="billing_rated_transaction" constraintName="fk_billing_rt_origin_ba" deferrable="false" referencedColumnNames="id" referencedTableName="billing_billing_account" />
	</changeSet>

    <changeSet id="#INTRD-5306_2022-02_24" author="hichamELHALOUI">
        <addColumn tableName="crm_provider">
            <column name="functional_currency_flag" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5343_2022-02_25" author="hichamELHALOUI">
        <addColumn tableName="billing_trading_currency">
            <column name="symbol" type="varchar(255)" />
            <column name="decimal_places" type="int" defaultValueNumeric="2" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5380_2022_02_28" author="ZBariki">
        <update tableName="billing_tax_mapping">
            <column name="version" value="0"/>
            <where>version is null</where>
        </update>
    </changeSet>



    <changeSet id="#INTRD-4798_20220303" author="MohamedSTITANE">
        <sql>
            create index cpq_commercial_rule_item_header_id_index on ${db.schema.adapted}cpq_commercial_rule_item (commercial_rule_header_id);
            create index cpq_tag_seller_id_index on ${db.schema.adapted}cpq_tag (seller_id);
            create index cpq_tag_tag_type_id_index on ${db.schema.adapted}cpq_tag (tag_type_id);
            create index cpq_tag_type_seller_id_index on ${db.schema.adapted}cpq_tag_type (seller_id);
            create index cpq_commercial_rule_header_attribute_id_index on ${db.schema.adapted}cpq_commercial_rule_header (attribute_id);
            create index cpq_commercial_rule_header_grouped_attributes_id_index on ${db.schema.adapted}cpq_commercial_rule_header (grouped_attributes_id);
            create index cpq_commercial_rule_header_grouped_service_id_index on ${db.schema.adapted}cpq_commercial_rule_header (grouped_service_id);
            create index cpq_commercial_rule_header_offer_template_id_index on ${db.schema.adapted}cpq_commercial_rule_header (offer_template_id);
            create index cpq_commercial_rule_header_product_id_index on ${db.schema.adapted}cpq_commercial_rule_header (product_id);
            create index cpq_commercial_rule_header_product_version_id_index on ${db.schema.adapted}cpq_commercial_rule_header (product_version_id);
            create index cpq_commercial_rule_header_service_template_id_index on ${db.schema.adapted}cpq_commercial_rule_header (service_template_id);
            create index cpq_commercial_rule_header_tag_id_index on ${db.schema.adapted}cpq_commercial_rule_header (tag_id);
        </sql>
    </changeSet>

     <changeSet id="#INTRD-5385_20220228" author="TarikFA.">
	     <addColumn tableName="cpq_quote_price">
	     	<column name="quantity" type="numeric(19,2)"/>
	     </addColumn>
	     <addColumn tableName="cpq_quote_price">
	     	<column name="discounted_quote_price" type="bigint"/>
	     </addColumn>
	     <renameColumn tableName="cpq_quote_price" oldColumnName="amount_without_tax_with_discount" newColumnName="amount_without_tax_without_discount"/>
	     <addForeignKeyConstraint baseColumnNames="discounted_quote_price" baseTableName="cpq_quote_price" constraintName="fk_discounted_quote_price" deferrable="false"
	     											initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote_price" />
      </changeSet>
      
      <changeSet id="#INTRD-5529_20220304" author="TarikFA.">
      	<addColumn tableName="cpq_invoice_line">
	     	<column name="discounted_invoice_line" type="bigint"/>
      	</addColumn>
	     <addForeignKeyConstraint baseColumnNames="discounted_invoice_line" baseTableName="cpq_invoice_line" constraintName="fk_discounted_invoice_line" deferrable="false" 
	     											initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_invoice_line" />
      </changeSet>
      

    <changeSet id="#INTRD-5458_20220304" author="TarikRabeh">
    	<addColumn tableName="billing_invoice_configuration">
    		<column name="display_user_account_hierarchy" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>


    <changeSet id="#INTRD-5276_2022-02-24_PG" author="MohammedSTITANE" dbms="postgresql">
        <modifyDataType columnName="description" newDataType="varchar(4000)" tableName="billing_rated_transaction" />
    </changeSet>
    <changeSet id="#INTRD-5276_2022-02-24_ORACLE" author="MohammedSTITANE" dbms="oracle">
        <!-- fixing compatibility problem with oracle-->
        <renameColumn newColumnName="long_description" oldColumnName="description" tableName="billing_rated_transaction"/>
        <addColumn tableName="billing_rated_transaction">
            <column name="description" type="varchar(4000)"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_rated_transaction
            set description = DBMS_LOB.SUBSTR(long_description, 4000, 1)
            where long_description is not null ;
        </sql>
        <dropColumn columnName="long_description" tableName="billing_rated_transaction" />
    </changeSet>

    <changeSet id="#INTRD-5533_2022_03_07" author="ZBariki">
        <update tableName="billing_invoice_type">
            <column name="use_self_sequence" value="0"/>
            <where>use_self_sequence is null</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-4590-20220308" author="HatimOUDAD" failOnError="false">
        <createSequence sequenceName="cpq_order_amendement_seq" startValue="1" />
        <createTable tableName="cpq_order_amendement">
            <column name="id" type="${cast.long}" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_order_amendement_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="cpq_order_amendement_pkey_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="subscription_id" type="bigint"/>
            <column name="user_account_id" type="bigint" />
            <column name="uuid" type="varchar(60)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="cf_values" type="${type.json}" />
            <column name="cf_values_accum" type="${type.json}" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_order_amendement"
			constraintName="fk_billing_subscription_order_amendement" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="cpq_order_amendement" constraintName="fk_order_amendement_user_account_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_suspend_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_suspend_id" baseTableName="cpq_order_product" constraintName="fk_prd_suspend_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_reactivate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_reactivate_id" baseTableName="cpq_order_product" constraintName="fk_prd_reactivate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_terminate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_terminate_id" baseTableName="cpq_order_product" constraintName="fk_prd_terminate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_activate_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_activate_id" baseTableName="cpq_order_product" constraintName="fk_prd_activate_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_product">
            <column name="order_amendement_restart_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_restart_id" baseTableName="cpq_order_product" constraintName="fk_prd_restart_order_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>

        <addColumn tableName="cpq_order_offer">
            <column name="order_amendement_id" type="${cast.long}"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="order_amendement_id" baseTableName="cpq_order_offer" constraintName="fk_offer_order_amd_id"
                                 deferrable="false" initiallyDeferred="false" onDelete="SET NULL" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="cpq_order_amendement"/>


    </changeSet>

    <changeSet id="#INTRD-5419-20220308" author="HichamELHALOUI">
        <createSequence sequenceName="open_order_setting_seq" startValue="1" />
        <createTable tableName="open_order_setting">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true" primaryKeyName="open_order_setting_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="code" type="varchar(255)">
				<constraints nullable="true" />
			</column>
			<column name="description" type="varchar(255)" />
            <column name="use_open_orders" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="apply_maximum_validity" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="apply_maximum_validity_value" type="int" />
            <column name="apply_maximum_validity_unit" type="varchar(6)" />
            <column name="define_maximum_validity" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="define_maximum_validity_value" type="int" />
            <column name="use_managment_validation_for_oo_quotation" type="${type.boolean}" defaultValueNumeric="0" />

        </createTable>
    </changeSet>

    <changeSet id="#FIX-delete-tax" author="AbdelmounaimAkadid">
    	 <update tableName="billing_tax_mapping">
            <column name="version" value="0"/>
            <where>version is null</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-5628_2022-03_11" author="hichamELHALOUI">
        <addColumn tableName="billing_trading_currency">
            <column name="current_rate" type="numeric(23, 12)" />
            <column name="current_rate_from_date" type="datetime" />
            <column name="current_rate_updater" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-5310-20220310" author="HichamELHALOUI">
        <createSequence sequenceName="open_order_threshold_seq" startValue="1"/>
        <createSequence sequenceName="open_order_template_seq" startValue="1"/>
        <createTable tableName="open_order_threshold">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="open_order_threshold_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="sequence" type="int"/>
            <column name="percentage" type="int"/>
            <column name="open_order_template_id" type="bigint"/>
        </createTable>

        <createTable tableName="open_order_threshold_recipients">
            <column name="threshold_id" type="bigint"/>
            <column name="recipient" type="varchar(100)"/>
        </createTable>

        <createTable tableName="open_order_template">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="open_order_template_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="code" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="open_order_type" type="varchar(50)"/>
        </createTable>
        <createTable tableName="open_order_template_tags">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="open_order_template_products">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="product_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="open_order_template_articles">
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="article_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="threshold_id, recipient" constraintName="open_order_threshold_recipients_pkey"
                       tableName="open_order_threshold_recipients"/>
        <addPrimaryKey columnNames="open_order_template_id,tag_id"
                       constraintName="open_order_template_tags_pkey"
                             tableName="open_order_template_tags"/>
         <addPrimaryKey columnNames="open_order_template_id,product_id"
                             constraintName="open_order_template_products_pkey"
                             tableName="open_order_template_products"/>
         <addPrimaryKey columnNames="open_order_template_id,article_id"
                             constraintName="open_order_template_articles_pkey"
                             tableName="open_order_template_articles"/>

    </changeSet>

	<changeSet id="#INTRD-5341_20220307" author="aelmalki">
        <renameTable oldTableName="cpq_invoice_line" newTableName="billing_invoice_line"/>
        <renameSequence oldSequenceName="cpq_invoice_line_seq" newSequenceName="billing_invoice_line_seq" />

        <sql>ALTER TABLE ${db.schema.adapted}billing_invoice_line RENAME CONSTRAINT pk_cpq_invoice_line TO pk_billing_invoice_line;</sql>

        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_invoice_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_cpq_quote_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_accounting_article_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_offer_service_template_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_product_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_service_template_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_discount_plan_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_tax_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_cpq_invoice_line_commercial_order_id"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="cpq_invoice_line__order_lot__fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="cpq_invoice_line__product_version__fk"/>

        <addForeignKeyConstraint baseColumnNames="invoice_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_invoice_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />

        <addForeignKeyConstraint baseColumnNames="cpq_quote_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_cpq_quote_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_quote" />

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_accounting_article_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="offer_service_template_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_offer_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_offer_serv_templates" />

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_product_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />

        <addForeignKeyConstraint baseColumnNames="service_template_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_service_template_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_service_template" />

        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_discount_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_tax_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />

        <addForeignKeyConstraint baseColumnNames="commercial_order_id" baseTableName="billing_invoice_line"
                                 constraintName="fk_billing_invoice_line_commercial_order_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_commercial_order" />

        <addForeignKeyConstraint baseTableName="billing_invoice_line" baseColumnNames="order_lot_id"
                                 constraintName="billing_invoice_line__order_lot__fk" referencedTableName="cpq_order_lot"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_invoice_line" baseColumnNames="product_version_id"
                                 constraintName="billing_invoice_line__product_version__fk"
                                 referencedTableName="cpq_product_version" referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-4852-18032022" author="AbdelkaderBouazza">
        <dropNotNullConstraint tableName="cpq_commercial_order" columnName="order_type_id" />
    </changeSet>


    <changeSet id="#INTRD-5777_2022-03-17_PG" author="MohammedSTITANE" dbms="postgresql">
        <createView viewName="all_sequences_view" replaceIfExists="true">
            <![CDATA[
                select nextVal(quote_ident(sequencename))::text as seq_val, sequencename as seq_code
                FROM pg_catalog.pg_sequences
            ]]>
        </createView>
    </changeSet>
    <changeSet id="#INTRD-5777_2022-03-17_ORACLE" author="MohammedSTITANE" dbms="oracle">
        <sql endDelimiter="/">
            CREATE OR REPLACE FUNCTION get_next_val (seq_name IN VARCHAR2) RETURN VARCHAR AS
                v_seq_id number(38);
                sql_stmt VARCHAR(2000);
            BEGIN
                sql_stmt := 'select ' || seq_name || '.nextval from dual';
                execute immediate sql_stmt into v_seq_id ;
                DBMS_OUTPUT.PUT_LINE(seq_name || ' => ' || v_seq_id);
                RETURN to_char(v_seq_id);
            END;
            /
        </sql>
        <createView viewName="all_sequences_view" replaceIfExists="true">
            select get_next_val(SEQUENCE_NAME) as seq_val, lower(SEQUENCE_NAME) as seq_code FROM ${db.schema.adapted}user_sequences s
        </createView>
    </changeSet>



    <changeSet id="#INTRD-5804-20220321" author="HatimOUDAD">

    	<dropForeignKeyConstraint baseTableName="cpq_order_offer" constraintName="fk_offer_order_amd_id"/>
    	<dropColumn tableName="cpq_order_offer">
            <column name="order_amendement_id"></column>
        </dropColumn>

    	<dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_restart_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_restart_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_activate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_activate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_terminate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_terminate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_reactivate_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_reactivate_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_product" constraintName="fk_prd_suspend_order_id"/>
    	<dropColumn tableName="cpq_order_product">
            <column name="order_amendement_suspend_id"></column>
        </dropColumn>

        <dropForeignKeyConstraint baseTableName="cpq_order_amendement" constraintName="fk_order_amendement_user_account_id"/>
    	<dropForeignKeyConstraint baseTableName="cpq_order_amendement" constraintName="fk_billing_subscription_order_amendement"/>
    	<dropTable tableName="cpq_order_amendement"/>

    	<addColumn tableName="cpq_order_product">
            <column name="production_action_type" type="varchar(10)" />
            <column name="termination_date" type="datetime" />
            <column name="sub_termin_reason_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_order_product" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbd" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />

        <addColumn tableName="cpq_order_offer">
            <column name="subscription_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="cpq_order_offer" constraintName="fk_dwdlb9d5mlvdddm3yowwa9uembd" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />

    </changeSet>


    <changeSet id="#INTRD-4702-20220321" author="ZBariki">
        <addColumn tableName="ar_occ_template">
            <column name="contra_accounting_code_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="contra_accounting_code_id" baseTableName="ar_occ_template"
                                     constraintName="fk_contra_accounting_code_id" deferrable="false"
                                     initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                     referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet author="TarikRabeh" id="#INTRD-5841-21032022">
        <addColumn tableName="billing_billing_account">
            <column name="trading_currency_id" type="bigint" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-5921-20220324" author="AmineBENAICHA">
        <addColumn tableName="audit_log">
            <column name="source" type="VARCHAR(200)" />
        </addColumn>
    </changeSet>

	<changeSet author="TarikRabeh" id="#INTRD-5846-24032022">
    	<sql>update ${db.schema.adapted}billing_billing_account bba
    		set trading_currency_id = (select aca.trading_currency_id from ${db.schema.adapted}ar_customer_account aca where aca.id = bba.customer_account_id )
    		where bba.trading_currency_id is null
    	</sql>
        <addNotNullConstraint tableName="billing_billing_account" columnName="trading_currency_id"/>
        <addForeignKeyConstraint baseColumnNames="trading_currency_id" baseTableName="billing_billing_account" constraintName="fk_trading_currency_id" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
	</changeSet>

    <changeSet id="#INTRD-5881_20220322" author="aelmalki">
        <createSequence sequenceName="accounting_journal_entry_seq"/>
        <createTable tableName="accounting_journal_entry">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_accounting_journal_entry" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <!-- Dependencies -->
            <column name="accounting_operation_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="accounting_code_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="seller_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="customer_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="tax_id" type="bigint" />

            <!-- Simple fields -->
            <column name="direction" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="amount" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="analytic_code_1" type="varchar(255)" />
            <column name="analytic_code_2" type="varchar(255)" />
            <column name="analytic_code_3" type="varchar(255)" />
        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_operation_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_account_operation" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />

        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_seller" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />

        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_customer_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

        <addForeignKeyConstraint baseColumnNames="tax_id" baseTableName="accounting_journal_entry"
                                 constraintName="fk_accounting_entry_tax" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>

    <changeSet id="#INTRD-5994-20220328" author="HichamELHALOUI">
        <addColumn tableName="ar_occ_template">
            <column name="commission_accounting_code_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="commission_accounting_code_id" baseTableName="ar_occ_template"
                                 constraintName="fk_commission_accounting_code_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />

    </changeSet>

	<changeSet id="#INTRD-5908-20220330" author="AmineBENAICHA">
		<createSequence sequenceName="global_settings_seq" startValue="1"/>
        <createTable tableName="global_settings">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="global_settings_pkey"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="quote_default_validity_delay" type="int" defaultValueNumeric="30">
            	<constraints nullable="false" />
            </column>
        </createTable>
    </changeSet>

    <changeSet id="#INTRD-6160-20220401" author="HichamELHALOUI">
        <dropForeignKeyConstraint baseTableName="ar_occ_template" constraintName="fk_commission_accounting_code_id"/>
        <renameColumn tableName="ar_occ_template" newColumnName="contra_accounting_code2_id" oldColumnName="commission_accounting_code_id"
                      columnDataType="bigint"/>
        <addForeignKeyConstraint baseColumnNames="contra_accounting_code2_id" baseTableName="ar_occ_template"
                                 constraintName="fk_contra_accounting_code2_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet id="#INTRD-6298_20220405" author="aelmalki">
        <addColumn tableName="ar_accounting_scheme">
            <column name="long_description_i18n" type="${type.json}" defaultValue='{"FRA":"", "ENG":""}'>
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6136-20220406" author="HatimOUDAD">
         <addColumn tableName="cpq_order_offer">
            <column name="termination_date" type="datetime" />
            <column name="sub_termin_reason_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_order_offer" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbdafs" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />
    </changeSet>

    <changeSet id="#INTRD-6263_20220406" author="AmineBENAICHA">
        <addColumn tableName="billing_billing_run">
            <column name="xml_job_execution_result_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6264_20220406" author="AmineBENAICHA">
        <addColumn tableName="billing_billing_run">
            <column name="pdf_job_execution_result_id" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6453_20220411" author="TarikRabeh">
        <addColumn tableName="billing_invoice_line">
            <column name="functional_unit_price" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6056_20220413" author="HatimOUDAD">
	    <addColumn tableName="cpq_quote_product">
	            <column name="product_action_type" type="varchar(10)" />
	            <column name="termination_date" type="datetime" />
	            <column name="sub_termin_reason_id" type="bigint" />
	    </addColumn>

	        <addForeignKeyConstraint baseColumnNames="sub_termin_reason_id" baseTableName="cpq_quote_product" constraintName="fk_q6d91d7b6bc2ypdbx4tjbr0acbdcc" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscrip_termin_reason" />

	        <addColumn tableName="quote_offer">
	            <column name="subscription_id" type="bigint" />
	        </addColumn>
	        <addForeignKeyConstraint baseColumnNames="subscription_id" baseTableName="quote_offer" constraintName="fk_dwdlb9d5mlvdddm3yowwa9uembdcc" deferrable="false" initiallyDeferred="false"
	            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_subscription" />
     </changeSet>

    <changeSet id="INTRD-6474-13042022" author="Abdelkader.Bouazza">
        <addColumn tableName="cat_price_plan_matrix">
            <column name="charge_template_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="charge_template_id" baseTableName="cat_price_plan_matrix"
                                 constraintName="fk_cat_price_plan_matrix_cat_charge_template"
                                 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
                                 onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_charge_template" />
        <sql>UPDATE ${db.schema.adapted}cat_price_plan_matrix SET charge_template_id = (SELECT id FROM ${db.schema.adapted}cat_charge_template WHERE code = event_code)</sql>
    </changeSet>

    <changeSet id="#INTRD-6562_20220414" author="aelmalki">
        <createSequence sequenceName="accounting_accountingcode_mapping_seq"/>
        <createTable tableName="accounting_accountingcode_mapping">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_accounting_accountingcode_mapping"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>

            <!-- Dependencies -->
            <column name="accounting_article_id" type="bigint"/>
            <column name="billing_country_id" type="bigint"/>
            <column name="billing_currency_id" type="bigint"/>
            <column name="seller_country_id" type="bigint"/>
            <column name="seller_id" type="bigint"/>

            <!-- Simple fields -->
            <column name="criteria_el" type="varchar(500)"/>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />

        <addForeignKeyConstraint baseColumnNames="billing_country_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_billing_country" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />

        <addForeignKeyConstraint baseColumnNames="billing_currency_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_trading_currency" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />

        <addForeignKeyConstraint baseColumnNames="seller_country_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_seller_country" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_country" />

        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_seller" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="crm_seller" />
    </changeSet>

    <changeSet id="#INTRD-6562_20220414-new-field" author="aelmalki">
        <addColumn tableName="billing_accounting_article">
            <column name="accountingcode_el" type="varchar(500)"/>
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-5859_20220321" author="TarikFA.">
    	<addColumn tableName="billing_discount_plan_instance">
    		<column name="service_instance_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="billing_discount_plan_instance" constraintName="fk_discount_instance_service_instance" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_service_instance" />
    </changeSet>
    
     <changeSet id="#INTRD-5872_20220322" author="TarikFA.">
    	<addColumn tableName="billing_wallet_operation">
    		<column name="discounted_wallet_operation_id" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_wallet_operation" constraintName="fk_discount_plan_id_wallet_operation" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_plan_id" type="bigint"/>
		</addColumn>
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="billing_rated_transaction" constraintName="fk_discount_plan_id_rated_transaction" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                                 
		<addColumn tableName="cpq_quote_price">
			<column name="uuid" type="varchar(60)"/>
		</addColumn>
                                 
    </changeSet>
    
     <changeSet id="#INTRD-5872_20220326" author="R.AITYAAZZA">
    	<addColumn tableName="cpq_quote_price">
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="cpq_quote_price" constraintName="fk_discount_plan_id_quote_price" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
                
       <addColumn tableName="billing_rated_transaction">
    		<column name="discounted_ratedtransaction_id" type="bigint" />
    	</addColumn>                          
    </changeSet>
    
     <changeSet id="#INTRD-6108_20220330" author="TarikFA.">
    	<addColumn tableName="order_price">
    		<column name="quantity" type="numeric(19,2)" />
    		<column name="discounted_order_price" type="bigint" />
    		<column name="discount_plan_id" type="bigint" />
    	</addColumn>
    	
        <addForeignKeyConstraint baseColumnNames="discounted_order_price" baseTableName="order_price" constraintName="fk_order_price_discounted_order" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="order_price" />
                                 
        <addForeignKeyConstraint baseColumnNames="discount_plan_id" baseTableName="order_price" constraintName="fk_order_price_discount_plan" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan" />
    </changeSet>
     <changeSet id="#20220404_M540_6296" author="Mbarek-Ay">
	
		<addColumn tableName="cpq_quote_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_wallet_operation">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_rated_transaction">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>
	
		<addColumn tableName="billing_invoice_line">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn> 
		
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="cpq_quote_price" constraintName="fk_quote_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
        
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_wallet_operation" constraintName="fk_wallet_operation_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_rated_transaction" constraintName="fk_rated_transaction_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
      
        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="billing_invoice_line" constraintName="fk_invoice_line_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
 
      </changeSet>

    <changeSet id="#20220407_ADHOC" author="NabilOuachi">
        <addColumn tableName="cat_discount_plan">
            <column name="applicable_on_overridden_price" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6631_20220419" author="TarikRabeh">
        <addColumn tableName="accounting_journal_entry">
            <column name="operation_number" type="bigint" />
            <column name="seller_code" type="varchar(255)" />
            <column name="client_unique_id" type="varchar(100)" />
            <column name="currency" type="varchar(3)" />
            <column name="supporting_document_ref" type="bigint" />
            <column name="supporting_document_type" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6633_20220420" author="TarikRabeh">
        <sql>
	        update ${db.schema.adapted}accounting_journal_entry set
		        seller_code = (select code from crm_seller cs where cs.id = seller_id),
		        client_unique_id = (select acc.registration_no from ar_customer_account acc where acc.id = customer_account_id),
		        currency = (select ac.currency_code from adm_currency ac, crm_provider pr where ac.id = pr.currency_id),
		        supporting_document_ref = (select aco.invoice_id from ar_account_operation aco where aco.id = accounting_operation_id),
		        supporting_document_type = (select bt.code from billing_invoice_type bt, billing_invoice inv,ar_account_operation aco where bt.id = inv.invoice_type_id and inv.id = aco.invoice_id and aco.id = accounting_operation_id)
        </sql>
        <addNotNullConstraint tableName="accounting_journal_entry" columnName="seller_code"/>
        <addNotNullConstraint tableName="accounting_journal_entry" columnName="currency"/>
    </changeSet>


    <changeSet id="#INTRD-6614_20220418" author="AmineBENAICHA">
    	<createSequence sequenceName="account_operation_number_seq" startValue="1" />
        <addColumn tableName="ar_account_operation">
            <column name="operation_number" type="bigint" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-6664_20220420" author="aelmalki">
        <dropNotNullConstraint tableName="accounting_journal_entry" columnName="seller_id"/>
    </changeSet>

    <changeSet id="#INTRD-6536_20220419-change-on-field" author="aelmalki">
        <addColumn tableName="billing_accounting_article">
            <column name="column_criteria_el" type="varchar(500)"/>
        </addColumn>
        <addColumn tableName="accounting_accountingcode_mapping">
            <column name="accounting_code_id" type="bigint"/>
        </addColumn>
        <renameColumn tableName="accounting_accountingcode_mapping" newColumnName="criteria_el_value" oldColumnName="criteria_el" />
    </changeSet>

    <changeSet id="#INTRD-6536_20220419-new-fk" author="aelmalki">
        <addForeignKeyConstraint baseColumnNames="accounting_code_id" baseTableName="accounting_accountingcode_mapping"
                                 constraintName="fk_accountingcode_mapping_accounting_code" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>

    <changeSet id="#INTRD-6668_20220421" author="TarikRabeh">
        <addColumn tableName="adm_currency">
            <column name="symbol" type="varchar(255)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-6672_20220511" author="HichamHANINE">
        <addColumn tableName="billing_invoice_line">
            <column name="target_tax_id" type="bigint" />
			<column name="target_tax_rate" type="numeric(23, 12)" />
        </addColumn>
		<addForeignKeyConstraint baseColumnNames="target_tax_id" baseTableName="billing_invoice_line" constraintName="fk_billing_invoice_line_target_tax_id" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>
    
    <changeSet id="#INTRD-7244_20220517" author="HichamHANINE">
        <addColumn tableName="billing_invoice_line">
            <column name="tax_mode" type="varchar(50)" />
        </addColumn>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line" constraintName="fk_billing_invoice_line_target_tax_id"/>
		<dropColumn columnName="target_tax_id" tableName="billing_invoice_line" />
		<dropColumn columnName="target_tax_rate" tableName="billing_invoice_line" />
    </changeSet>

    <changeSet id="#INTRD-6616_20220421" author="AmineBENAICHA" dbms="postgres">
		<sql>
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;

			update ${db.schema.adapted}ar_account_operation
			set operation_number = nextval('account_operation_number_seq')
			from (select ap.start_date, ap.end_date
					 from accounting_period ap
					 where accounting_period_year='2022-2023') as current_ap
			where accounting_date between current_ap.start_date and current_ap.end_date;

			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;
		</sql>
	</changeSet>

	<changeSet id="INTRD-6608_20220420" author="AkadidAbdelmounaim">
    	<dropView viewName="billing_wallet_operation_period"/>
    	<renameColumn newColumnName="parameter_extra_old" oldColumnName="parameter_extra" tableName="billing_wallet_operation"/>
    	<renameColumn newColumnName="parameter_extra_old" oldColumnName="parameter_extra" tableName="billing_rated_transaction"/>
    	<addColumn tableName="billing_wallet_operation">
            <column name="parameter_extra" type="varchar(4000)"/>
        </addColumn>
        <addColumn tableName="billing_rated_transaction">
            <column name="parameter_extra" type="varchar(4000)"/>
        </addColumn>
        <sql>
            update ${db.schema.adapted}billing_wallet_operation
            set parameter_extra = parameter_extra_old
            where parameter_extra_old is not null;
        </sql>
        <sql>
            update ${db.schema.adapted}billing_rated_transaction
            set parameter_extra = parameter_extra_old
            where parameter_extra_old is not null;
        </sql>
        <dropColumn columnName="parameter_extra_old" tableName="billing_wallet_operation" />
        <dropColumn columnName="parameter_extra_old" tableName="billing_rated_transaction" />
    </changeSet>
        
    <changeSet id="INTRD-6608_20220420_pg" author="AkadidAbdelmounaim" dbms="postgres">
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
            FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>
    <changeSet id="INTRD-6608_20220420_oracle" author="AkadidAbdelmounaim" dbms="oracle">
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (trunc(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id)) = trunc(o.start_date)) then 0 else 1 end) as flag
            FROM billing_wallet_operation o WHERE o.status = 'OPEN') o
        </createView>
    </changeSet>

    <changeSet id="INTRD-6012-07042022" author="Abdelkader.Bouazza">
        <addColumn tableName="global_settings">
            <column name="activate_dunning" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-7179_20220524" author="HichamHANINE">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price_el" type="varchar(255)" />
        </addColumn>
		<addColumn tableName="cpq_price_plan_matrix_line">
            <column name="price_el" type="varchar(255)" />
        </addColumn>
        <sql>UPDATE cpq_price_plan_version SET price_el = amount_with_tax_el WHERE amount_with_tax_el is not null</sql>
		<sql>UPDATE cpq_price_plan_version SET price_el = amount_without_tax_el WHERE amount_without_tax_el is not null</sql>
		<dropColumn columnName="amount_without_tax_el" tableName="cpq_price_plan_version" />
        <dropColumn columnName="amount_with_tax_el" tableName="cpq_price_plan_version" />
    </changeSet>

    <changeSet id="#INTRD-10188_20220928" author="MehdiBOURRAS">
        <renameColumn tableName="cpq_price_plan_matrix_line" newColumnName="value_el" oldColumnName="price_el"
                      columnDataType="varchar(255)"/>
    </changeSet>

    <changeSet id="#INTRD-6777_20220427" author="AmineBENAICHA" dbms="postgres">
		<sql>
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq RESTART WITH 1;

			UPDATE ${db.schema.adapted}ar_account_operation
			SET operation_number = null;

			UPDATE ${db.schema.adapted}ar_account_operation
			SET operation_number = nextval('account_operation_number_seq')
			FROM (select ap.start_date, ap.end_date
					 from accounting_period ap
					 where accounting_period_year='2022-2023') as current_ap
			WHERE accounting_date between current_ap.start_date and current_ap.end_date;

			ALTER TABLE ${db.schema.adapted}ar_account_operation ALTER COLUMN operation_number SET DEFAULT nextval('account_operation_number_seq');
			ALTER SEQUENCE ${db.schema.adapted}account_operation_number_seq OWNED BY ar_account_operation.operation_number;
		</sql>
	</changeSet>

    <changeSet id="#INTRD-6779_2022_04_28" author="ZBariki">
        <dropColumn tableName="billing_rated_transaction" columnName="accounting_article_id"/>
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction"
                                  constraintName="rated_transaction_article_fk"/>
        <renameColumn columnDataType="bigint" newColumnName="accounting_article_id"
                      oldColumnName="article_id" tableName="billing_rated_transaction"/>
        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="accounting_article_id"
                                 constraintName="fk_billing_rated_transaction_accounting_article_id"
                                 referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-6899_20220502" author="aelmalki">
        <dropNotNullConstraint tableName="accounting_journal_entry" columnName="customer_account_id"/>
    </changeSet>

    <changeSet id="#INTRD-6895_20220504" author="HichamHANINE">
		<sql>
			<![CDATA[
				ALTER SEQUENCE account_operation_number_seq RESTART WITH 1;
				update ar_account_operation as t
				set operation_number = nextval('account_operation_number_seq')
				from (select * 
						from ar_account_operation
						where accounting_date >= (select ap.start_date from accounting_period ap where accounting_period_year='2022-2023')
						and accounting_date <= (select ap.end_date from accounting_period ap where accounting_period_year='2022-2023')
						order by created) as s
				where s.id = t.id;
				ALTER SEQUENCE account_operation_number_seq RESTART WITH 1;
            ]]>			
		</sql>
	</changeSet>

    <changeSet id="#INTRD-7273_20220517" author="HichamHANINE">
		<sql>
			UPDATE billing_invoice_line set tax_mode = 'ARTICLE' where tax_mode is null
		</sql>
	</changeSet>

	<changeSet id="#INTRD-6923_20220505" author="hatimOUDAD">
        <dropNotNullConstraint tableName="cpq_commercial_order" columnName="order_type_id"/>
    </changeSet>


    <changeSet id="INTRD-7006_09052022" author="TarikRabeh">
        <addColumn tableName="accounting_journal_entry">
            <column name="trading_amount" type="numeric(23, 12)" />
            <column name="trading_currency" type="varchar(3)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="INTRD-7038_11052022" author="TarikRabeh">
        <addColumn tableName="billing_billing_run">
            <column name="is_quarantine" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="description" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7149_20220511" author="ZBariki">
        <addColumn tableName="accounting_journal_entry">
            <column name="auxiliary_account_code" type="varchar(255)" />
            <column name="auxiliary_account_label" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-6024-13052022" author="Abdelkader.Bouazza">
        <addColumn tableName="billing_invoice">
            <column name="is_reminder_level_triggered" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7099_2022051Z" author="ZBariki">
        <addColumn tableName="crm_provider">
            <column name="default_starting_date_of_plan" type="varchar(255)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-5806_20220516" author="HichamELHALOUI">
        <addColumn tableName="finance_settings">
            <column name="open_order_settings_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="finance_settings" baseColumnNames="open_order_settings_id"
                                 constraintName="fk_finance_settings_open_order_setting_id" referencedTableName="open_order_setting"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-7192_20220518" author="ZBariki">
        <addColumn tableName="finance_settings">
            <column name="use_auxiliary_accounting" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="auxiliary_account_code_el" type="varchar(2000)" />
            <column name="auxiliary_account_label_el" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-5311_20220518" author="HichamELHALOUI">

        <dropColumn tableName="open_order_threshold">
            <column name="created" />
            <column name="updated" />
            <column name="creator" />
            <column name="updater" />
            <column name="code" />
            <column name="description" type="varchar(255)"/>
        </dropColumn>
        <addUniqueConstraint columnNames="code" constraintName="uk_open_order_template_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="open_order_template" />

    </changeSet>

    <!--  fix for forgotten FK in current -->
    <changeSet id="INTRD-5311_20220518-fix" author="AkadidAbdelmounaim" failOnError="false">
    	<addForeignKeyConstraint baseTableName="open_order_threshold" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_threshold_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id" onDelete="CASCADE" onUpdate="CASCADE"/>


        <addForeignKeyConstraint baseTableName="open_order_template_tags" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_tags_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_tags" baseColumnNames="tag_id"
                                 constraintName="open_order_template_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_products_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="product_id"
                                 constraintName="open_order_template_products_product_id_fk"
                                 referencedTableName="cpq_product"
                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_template_articles_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="article_id"
                                 constraintName="open_order_template_articles_article_id_fk"
                                 referencedTableName="billing_accounting_article"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="INTRD-5312_20220518" author="HichamELHALOUI">
        <addColumn tableName="open_order_template">
            <column name="status" type="varchar(255)" />
        </addColumn>
    </changeSet>
    <changeSet id="INTRD-7031-18052022" author="Abdelkader.Bouazza">
        <addColumn tableName="billing_invoice">
            <column name="related_dunning_collection_plan_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="related_dunning_collection_plan_id" baseTableName="billing_invoice" constraintName="fk_invoice_related_collection_plan"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="dunning_collection_plan" />
    </changeSet>

    <!--  was split to deblock deploy -->
    <changeSet id="INTRD-7031-18052022-split" author="AbdelmounaimAkadid" failOnError="false">
        <sql>update ${db.schema.adapted}billing_invoice as invoice set related_dunning_collection_plan_id = (SELECT dc.id FROM dunning_collection_plan as dc WHERE dc.related_invoice_id=invoice.id)
        </sql>
    </changeSet>


    <changeSet id="INTRD-7040_18052022" author="TarikRabeh">
        <dropColumn tableName="billing_billing_run">
            <column name="description"></column>
        </dropColumn>
        <addColumn tableName="billing_billing_run">
            <column name="description_i18n" type="${type.json}" defaultValue='{"FRA":"", "ENG":""}'>
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-7039_23052022" author="TarikRabeh">
        <sql>
            <![CDATA[
				alter table billing_billing_run alter column description_i18n drop not null;
			]]>
        </sql>
    </changeSet>

    <changeSet id="#INTRD-7157_20220523" author="ZBariki">
        <addColumn tableName="billing_invoice">
            <column name="dunning_collection_plan_triggered" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-5725_20220524" author="HichamELHALOUI" >
        <addColumn tableName="open_order_template">
            <column name="number_instantiation" type="int" />
              <column name="template_name" type="varchar(100)" />
        </addColumn>

    </changeSet>

    <changeSet id="#INTRD-7422_20220525" author="ZBariki">
        <addColumn tableName="ar_customer_account">
            <column name="general_client_account_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="general_client_account_id" baseTableName="ar_customer_account"
                                 constraintName="fk_general_client_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_code" />
    </changeSet>


    <changeSet id="#INTRD-7537_20220531" author="TarikRabeh">
        <addColumn tableName="billing_billing_run">
            <column name="origin_billing_run_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint baseColumnNames="origin_billing_run_id" baseTableName="billing_billing_run" constraintName="fk_billing_billing_run_origin_billing_run"
              					 referencedColumnNames="id" referencedTableName="billing_billing_run"/>
    </changeSet>

    <changeSet id="INTRD-5570_20220601" author="AbdelmounaimAkadid">
     	<addColumn tableName="billing_invoice">
            <column name="last_applied_rate" type="numeric(23, 12)" />
            <column name="last_applied_rate_date" type="datetime" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7428_20220601" author="ZBariki">
        <addDefaultValue tableName="finance_settings" columnName="auxiliary_account_code_el"
                         defaultValue="#{gca.code.substring(0, 3)}#{ca.description}"/>
        <addDefaultValue tableName="finance_settings" columnName="auxiliary_account_label_el"
                         defaultValue="#{ca.description}"/>
    </changeSet>

    <changeSet id="#INTRD-7629_20220603" author="HatimOUDAD">
    	<addColumn tableName="cpq_order_product">
            <column name="instance_status" type="varchar(10)" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-7479_20220603" author="AndriusKarpavicius">
        <renameColumn tableName="sub_accounting_period" oldColumnName="number" newColumnName="period_number"/>
    </changeSet>

    <changeSet id="#INTRD-7642_20220603" author="ZBariki">
        <createSequence sequenceName="billing_invoice_line_conversion_seq"/>
        <createSequence sequenceName="billing_invoice_conversion_seq"/>

        <createTable tableName="billing_invoice_line_conversion">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_invoice_line_conversion"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="invoice_line_id" type="bigint"/>
            <column name="invoice_id" type="bigint"/>
            <column name="invoice_conversion_id" type="bigint"/>
            <column name="applied_rate" type="numeric(23, 12)"/>
            <column name="applied_rate_date" type="datetime"/>
            <column name="invoice_currency_id" type="bigint"/>
            <column name="unit_price" type="numeric(23, 12)"/>
            <column name="amount_with_tax" type="numeric(23, 12)"/>
            <column name="amount_without_tax" type="numeric(23, 12)"/>
            <column name="amount_tax" type="numeric(23, 12)"/>
            <column name="discount_amount" type="numeric(23, 12)"/>
            <column name="raw_amount" type="numeric(23, 12)"/>
        </createTable>

        <createTable tableName="billing_invoice_conversion">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_billing_invoice_conversion"/>
            </column>
            <column name="version" type="int4"/>
            <column name="created" type="datetime">
                <constraints nullable="false"/>
            </column>
            <column name="updated" type="datetime"/>
            <column name="creator" type="varchar(100)"/>
            <column name="updater" type="varchar(100)"/>
            <column name="invoice_id" type="bigint"/>
            <column name="applied_rate" type="numeric(23, 12)"/>
            <column name="applied_rate_date" type="datetime"/>
            <column name="invoice_currency_id" type="bigint"/>
            <column name="amount_with_tax" type="numeric(23, 12)"/>
            <column name="amount_without_tax" type="numeric(23, 12)"/>
            <column name="amount_tax" type="numeric(23, 12)"/>
            <column name="discount_amount" type="numeric(23, 12)"/>
            <column name="raw_amount" type="numeric(23, 12)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_line_id"
                                 constraintName="billing_invoice_line_conversion_invoice_line_id_fk"
                                 referencedTableName="billing_invoice_line"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_id"
                                 constraintName="billing_invoice_line_conversion_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_conversion_id"
                                 constraintName="billing_invoice_line_conversion_invoice_conversion_id_fk"
                                 referencedTableName="billing_invoice_conversion"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_line_conversion" baseColumnNames="invoice_currency_id"
                                 constraintName="billing_invoice_line_conversion_invoice_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="billing_invoice_conversion" baseColumnNames="invoice_id"
                                 constraintName="billing_invoice_conversion_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_invoice_conversion" baseColumnNames="invoice_currency_id"
                                 constraintName="billing_invoice_conversion_invoice_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-7399_20220603" author="aelmalki" failOnError="false">
        <createSequence sequenceName="ar_payment_plan_seq"/>
        <createTable tableName="ar_payment_plan">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_ar_payment_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="ar_payment_plan_code_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            <column name="amount_to_recover" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="amount_per_installment" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="remaining_amount" type="numeric(23, 12)" />
            <column name="action_on_remaining_amount" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="number_of_installments" type="int4">
                <constraints nullable="false" />
            </column>
            <column name="start_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="end_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="recurring_unit" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>

            <!-- Dependencies -->
            <column name="customer_account_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="customer_account_id" baseTableName="ar_payment_plan"
                                 constraintName="fk_payment_plan_customer_account" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_customer_account" />

        <createTable tableName="ar_payment_plan_created_aos">
            <column name="payment_plan_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="payment_plan_id, account_operation_id" constraintName="ar_payment_plan_created_aos_pkey" tableName="ar_payment_plan_created_aos" />

        <createTable tableName="ar_payment_plan_targeted_aos">
            <column name="payment_plan_id" type="bigint" />
            <column name="account_operation_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="payment_plan_id, account_operation_id" constraintName="ar_payment_plan_targeted_aos_pkey" tableName="ar_payment_plan_targeted_aos" />
    </changeSet>

    <changeSet id="#INTRD-7644_20220606" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_line_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_conversion_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_line_conversion"
                                  constraintName="billing_invoice_line_conversion_invoice_currency_id_fk"/>

        <dropForeignKeyConstraint baseTableName="billing_invoice_conversion"
                                  constraintName="billing_invoice_conversion_invoice_id_fk"/>
        <dropForeignKeyConstraint baseTableName="billing_invoice_conversion"
                                  constraintName="billing_invoice_conversion_invoice_currency_id_fk"/>

        <dropSequence sequenceName="billing_invoice_conversion_seq"/>
        <dropSequence sequenceName="billing_invoice_line_conversion_seq"/>

        <dropTable tableName="billing_invoice_conversion"/>
        <dropTable tableName="billing_invoice_line_conversion"/>

        <dropColumn tableName="billing_invoice_line">
            <column name="functional_unit_price" />
        </dropColumn>

        <addColumn tableName="billing_invoice_line">
            <column name="converted_unit_price" type="numeric(23, 12)" />
            <column name="converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="converted_amount_with_tax" type="numeric(23, 12)" />
            <column name="converted_tax_rate" type="numeric(23, 12)" />
            <column name="converted_discount_rate" type="numeric(23, 12)" />
            <column name="converted_amount_tax" type="numeric(23, 12)" />
            <column name="converted_discount_amount" type="numeric(23, 12)" />
            <column name="converted_raw_amount" type="numeric(23, 12)" />
        </addColumn>

        <addColumn tableName="billing_invoice">
            <column name="converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="converted_amount_with_tax" type="numeric(23, 12)" />
            <column name="converted_amount_tax" type="numeric(23, 12)" />
            <column name="converted_net_to_pay" type="numeric(23, 12)" />
            <column name="converted_raw_amount" type="numeric(23, 12)" />
            <column name="converted_discount_rate" type="numeric(23, 12)" />
            <column name="converted_discount_amount" type="numeric(23, 12)" />
            <column name="converted_amount_without_tax_before_discount" type="numeric(23, 12)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-7663_20220613" author="ZBariki">
		<sql>UPDATE billing_invoice SET last_applied_rate = 1, last_applied_rate_date = created
                       WHERE last_applied_rate IS NULL</sql>

		<sql>UPDATE billing_invoice SET converted_amount_without_tax = amount_without_tax
                       WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_with_tax = amount_with_tax
                       WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_tax = amount_tax WHERE converted_amount_tax IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_net_to_pay = net_to_pay WHERE converted_net_to_pay IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_raw_amount = raw_amount WHERE converted_raw_amount IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_discount_rate = discount_rate
                       WHERE converted_discount_rate IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_discount_amount = discount_amount
                       WHERE converted_discount_amount IS NULL</sql>
		<sql>UPDATE billing_invoice SET converted_amount_without_tax_before_discount = amount_without_tax_before_discount
                       WHERE converted_amount_without_tax_before_discount IS NULL</sql>

		<sql>UPDATE billing_invoice_line SET converted_unit_price = unit_price WHERE converted_unit_price IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_without_tax = amount_without_tax
                            WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_with_tax = amount_with_tax
                            WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_tax_rate = tax_rate WHERE converted_tax_rate IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_discount_rate = discount_rate
                            WHERE converted_tax_rate IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_amount_tax = amount_tax WHERE converted_amount_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_discount_amount = discount_amount
                            WHERE converted_discount_amount IS NULL</sql>
		<sql>UPDATE billing_invoice_line SET converted_raw_amount = raw_amount WHERE converted_raw_amount IS NULL</sql>
	</changeSet>

     <changeSet id="#INTRD-7352_20220614" author="HatimOUDAD" >
         <dropColumn tableName="open_order_template">
            <column name="number_instantiation" />
        </dropColumn>
	</changeSet>
	
    <changeSet id="#INTRD-7124-130622" author="AbdelkaderBouazza">
        <addColumn tableName="dunning_policy">
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7770_20220613" author="aelmalki">
        <addColumn tableName="billing_invoice">
            <column name="payment_plan_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="payment_plan_id" baseTableName="billing_invoice" constraintName="fk_billing_invoice_payment_plan_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_payment_plan" />
    </changeSet>

    <changeSet id="#INTRD-4424_20220221" author="Mounir_BOUKAYOUA">
        <addColumn tableName="billing_subscrip_termin_reason">
            <column name="invoice_agreement_immediately" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <sql>update ${db.schema.adapted}billing_subscrip_termin_reason set invoice_agreement_immediately = 0</sql>
    </changeSet>
    
    <changeSet id="#INTRD-7954_20220616" author="AbdelmounaimAkadid">
     	<createIndex indexName="idx_billing_invoice_line__invoice_id" tableName="billing_invoice_line">
	      	<column name="invoice_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx_billing_user_account__parent_useraccount_id" tableName="billing_user_account">
	      	<column name="parent_useraccount_id"/>
	  	</createIndex>
    </changeSet>

    <changeSet id="#INTRD-7872_20220615" author="ZBariki">
        <addColumn tableName="billing_invoice_agregate">
            <column name="converted_amount_without_tax" type="numeric(23, 12)"/>
            <column name="converted_amount_with_tax" type="numeric(23, 12)"/>
            <column name="converted_amount_tax" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7872_20220615-data" author="ZBariki">
		<sql>UPDATE billing_invoice_agregate SET converted_amount_without_tax = amount_without_tax
                                WHERE converted_amount_without_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_agregate SET converted_amount_with_tax = amount_with_tax
                                WHERE converted_amount_with_tax IS NULL</sql>
		<sql>UPDATE billing_invoice_agregate SET converted_amount_tax = amount_tax
                                WHERE converted_amount_tax IS NULL</sql>
	</changeSet>

    <changeSet id="#INTRD-7605_20220617" author="TarikRabeh">
        <addColumn tableName="cpq_product">
            <column name="price_version_date_setting" type="varchar(255)" defaultValue="DELIVERY">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <addColumn tableName="billing_service_instance">
            <column name="price_version_date_setting" type="varchar(255)" />
            <column name="price_version_date" type="datetime" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-7722_20220618" author="ZBariki">
        <dropSequence sequenceName="generic_sequence_seq"/>
    </changeSet>

    
    <changeSet id="#INTRD-8026_20220621" author="HatimOUDAD">
        <addColumn tableName="open_order_threshold">
            <column name="external_recipient" type="varchar(100)"/>
        </addColumn>
    </changeSet>
    

    <changeSet id="#INTRD-8055_20220621" author="AbdelkaderBouazza">
        <addColumn tableName="ar_occ_template">
            <column name="manual_creation_enabled" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>
        <update tableName="ar_occ_template" >
            <column name="manual_creation_enabled" value="0"/>
            <where>code in ('CRD_SD', 'CRD_TRS', 'DBT_TRS', 'DEB_SD', 'INV_CRN', 'INV_DIS', 'INV_REB', 'INV_STD', 'PAY_BATCH', 'PAY_DEP', 'PPL_CREATION', 'PPL_INSTALLMENT', 'REF_SD', 'TAX_VAT_00', 'TAX_VAT_05', 'TAX_VAT_10', 'TAX_VAT_20')</where>
        </update>
    </changeSet>
    
    <changeSet id="#INTRD-8036-20220621" author="hichamhanine">
        <createSequence sequenceName="invoice_sub_totals_seq" startValue="1" />
        <createTable tableName="invoice_sub_totals">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="invoice_sub_totals_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />            

            <column name="sub_total_el" type="varchar(2000)" />
            <column name="label" type="varchar(50)" />
            <column name="invoice_type_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="label_i18n" type="${type.json}" />
        </createTable>
        <addForeignKeyConstraint baseColumnNames="invoice_type_id" baseTableName="invoice_sub_totals" constraintName="fk_invoice_sub_totals_invoice_type" deferrable="false" initiallyDeferred="false"
				onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice_type" />
    </changeSet>
    
    <changeSet id="#INTRD-8026_20220622" author="HatimOUDAD">
        <createSequence sequenceName="open_order_quote_seq"/>
        <createTable tableName="open_order_quote">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_quote" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_quote_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

           
            <column name="external_reference" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="open_order_type" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_number" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="max_amount" type="numeric">
                <constraints nullable="false" />
            </column>
            <column name="currency_id" type="bigint">
                <constraints nullable="false" />
            </column>     
            <column name="end_validity_date" type="datetime">
                <constraints nullable="true" />
            </column>
            <column name="activation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(255)">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_quote"
                                 constraintName="fk_open_order_template" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
     	<addForeignKeyConstraint baseColumnNames="currency_id" baseTableName="open_order_quote"
                                 constraintName="fk_currency_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="open_order_quote"
                                 constraintName="fk_billing_account_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
                                 
                                 
        <addColumn tableName="open_order_threshold">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="open_order_threshold" constraintName="fk_threshold_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="cpq_product">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="cpq_product" constraintName="fk_cpq_product_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="billing_accounting_article">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="billing_accounting_article" constraintName="fk_billing_accounting_article_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
                                 
        <addColumn tableName="cpq_tag">
            <column name="open_order_quote_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_quote_id" baseTableName="cpq_tag" constraintName="fk_tag_open_quote" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_quote" />
    </changeSet>
    
	<changeSet author="hichamhanine" id="#INTRD-7850-20220622">
    	<dropUniqueConstraint tableName="ar_payment_token" uniqueColumns="customer_account_id, iban" constraintName="customer_account_id_iban_unique"/>
    </changeSet>

    <changeSet id="#INTRD-8109_20220622" author="ZBariki">
        <createIndex indexName="accounting_journal_entry_auxiliary_accounting_code_idx"
                     tableName="accounting_journal_entry">
            <column name="auxiliary_account_code"/>
        </createIndex>
    </changeSet>
    
	<changeSet id="#INTRD-8158_20220624" author="TarikFA.">
    	<createSequence sequenceName="edr_versioning_rule_seq"/>
    	<createSequence sequenceName="mediation_setting_seq"/>
    	
    	<createTable tableName="mediation_setting">
    	 	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_mediation_setting" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
    		<column name="enable_edr_versioning" type="${type.boolean}" defaultValueNumeric="0" />
    	</createTable>
    	
    	<createTable tableName="edr_versioning_rule">
    	 	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_edr_versioning_rule" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            
    		<column name="priority" type="int4" >
    			<constraints nullable="false" />
    		</column>
    		<column name="criterial_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="key_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="is_new_version_el" type="varchar(2000)" >
    			<constraints nullable="false" />
    		</column>
    		<column name="mediation_setting_id" type="bigint" >
    			<constraints nullable="false" />
    		</column>
    	</createTable>
    	
    	
        <addForeignKeyConstraint baseColumnNames="mediation_setting_id" baseTableName="edr_versioning_rule" constraintName="fk_edr_versioning_rule_mediation_setting" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="mediation_setting" />
    </changeSet>

    <changeSet id="#INTRD-8147_20220624" author="anas.rouaguebe">
        <addColumn tableName="accounting_journal_entry">
            <column name="journal_code" type="varchar(50)" />
            <column name="category" type="varchar(50)" />
            <column name="account" type="varchar(50)" />
            <column name="label" type="varchar(255)" />
            <column name="customer_code" type="varchar(50)" />
            <column name="customer_name" type="varchar(255)" />
            <column name="seller_name" type="varchar(255)" />
            <column name="reference" type="varchar(50)" />
            <column name="document_type" type="varchar(50)" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-8211_20220626" author="anas.rouaguebe">
		<addDefaultValue tableName="com_meveo_instance" columnName="version" defaultValueNumeric="0" />
		<update tableName="com_meveo_instance" >
            <column name="version" value="0" />
            <where>version is null</where>
        </update>
    </changeSet>

	<changeSet id="#INTRD-8067_20220627" author="anas.rouaguebe">
		<addDefaultValue tableName="billing_tax_mapping" columnName="version" defaultValueNumeric="0" />
		<update tableName="billing_tax_mapping">
			<column name="version" valueNumeric="0" />
			<where>version is null</where>
		</update>
	</changeSet>

    <changeSet id="#INTRD-8077_20220625" author="ZBariki">
        <addColumn tableName="billing_accounting_article">
            <column name="ignore_aggregation" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-8022_20220624" author="HatimOUDAD" >
        <createSequence sequenceName="open_order_article_seq"/>
        <createTable tableName="open_order_article">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_article_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_article_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            
            <column name="active" type="${type.boolean}"/>
            

            <!-- Dependencies -->
            <column name="accounting_article_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="accounting_article_id" baseTableName="open_order_article"
                                 constraintName="fk_open_billing_accounting_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_accounting_article" />
                                 
        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_article"
                                 constraintName="fk_open_order_template_article" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
		
		<createSequence sequenceName="open_order_product_seq"/>
        <createTable tableName="open_order_product">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order_product_plan" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_product_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>

            <!-- Simple fields -->
            
            <column name="active" type="${type.boolean}"/>
            

            <!-- Dependencies -->
            <column name="product_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>

        </createTable>

        <addForeignKeyConstraint baseColumnNames="product_id" baseTableName="open_order_product"
                                 constraintName="fk_product_open_order_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_product" />
                                 
        <addForeignKeyConstraint baseColumnNames="open_order_template_id" baseTableName="open_order_product"
                                 constraintName="fk_open_order_template_product" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order_template" />
		
      	</changeSet>

      	<changeSet id="#INTRD-8023_20220624-fk1" author="HatimOUDAD" failOnError="false">
        	<dropForeignKeyConstraint baseTableName="open_order_template_products"
	                               constraintName="open_order_template_products_product_id_fk"/>

	        <dropForeignKeyConstraint baseTableName="open_order_template_articles"
	                               constraintName="open_order_template_articles_article_id_fk"/>
        </changeSet>

      	<changeSet id="#INTRD-8023_20220624" author="HatimOUDAD" >

		    <dropPrimaryKey constraintName="open_order_template_articles_pkey" tableName="open_order_template_articles"/>
		    <dropPrimaryKey constraintName="open_order_template_products_pkey" tableName="open_order_template_products"/>
		    <dropColumn tableName="open_order_template_products">
	            <column name="product_id" />
	        </dropColumn>

	        <dropColumn tableName="open_order_template_articles">
	            <column name="article_id" />
	        </dropColumn>

	        <addColumn tableName="open_order_template_products">
		        <column name="open_product_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </addColumn>

	        <addColumn tableName="open_order_template_articles">
	        <column name="open_article_id" type="bigint">
	            <constraints nullable="false"/>
	        </column>
	        </addColumn>


	        <addPrimaryKey columnNames="open_order_template_id,open_article_id"
		            constraintName="open_order_template_articles_pkey"
		            tableName="open_order_template_articles"/>
	        <addPrimaryKey columnNames="open_order_template_id,open_product_id"
		            constraintName="open_order_template_products_pkey"
		            tableName="open_order_template_products"/>

        </changeSet>

        <changeSet id="#INTRD-8023_20220624-fk2" author="HatimOUDAD" failOnError="false">
        	<addForeignKeyConstraint baseTableName="open_order_template_products" baseColumnNames="open_product_id"
	                               constraintName="open_order_template_products_product_id_fk"
	                               referencedTableName="open_order_product"
	                               referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_template_articles" baseColumnNames="open_article_id"
	                               constraintName="open_order_template_articles_article_id_fk"
	                               referencedTableName="open_order_article"
	                               referencedColumnNames="id"/>
        </changeSet>

		<changeSet id="#INTRD-8219_20220627" author="HatimOUDAD" >

			<dropForeignKeyConstraint baseTableName="cpq_product"
	                               constraintName="fk_cpq_product_open_quote"/>
	        <dropColumn tableName="cpq_product">
	            <column name="open_order_quote_id" />
	        </dropColumn>

	        <dropForeignKeyConstraint baseTableName="billing_accounting_article"
	                               constraintName="fk_billing_accounting_article_open_quote"/>
	        <dropColumn tableName="billing_accounting_article">
	            <column name="open_order_quote_id" />
	        </dropColumn>

	        <dropForeignKeyConstraint baseTableName="cpq_tag"
	                               constraintName="fk_tag_open_quote"/>
	        <dropColumn tableName="cpq_tag">
	            <column name="open_order_quote_id" />
	        </dropColumn>


	        <createTable tableName="open_order_quote_tags">
	           <column name="open_order_quote_id" type="bigint">
	               <constraints nullable="false"/>
	           </column>
	           <column name="tag_id" type="bigint">
	               <constraints nullable="false"/>
	           </column>
	        </createTable>
	        <createTable tableName="open_order_quote_products">
	            <column name="open_order_quote_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	            <column name="open_product_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </createTable>
	        <createTable tableName="open_order_quote_articles">
	            <column name="open_order_quote_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	            <column name="open_article_id" type="bigint">
	                <constraints nullable="false"/>
	            </column>
	        </createTable>

	        <addPrimaryKey columnNames="open_order_quote_id,tag_id"
	                       constraintName="open_order_quote_tags_pkey"
	                             tableName="open_order_quote_tags"/>
	         <addPrimaryKey columnNames="open_order_quote_id,open_product_id"
	                             constraintName="open_order_quote_products_pkey"
	                             tableName="open_order_quote_products"/>
	         <addPrimaryKey columnNames="open_order_quote_id,open_article_id"
	                             constraintName="open_order_quote_articles_pkey"
	                             tableName="open_order_quote_articles"/>

	         <addForeignKeyConstraint baseTableName="open_order_quote_tags" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_tags_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_tags" baseColumnNames="tag_id"
	                                 constraintName="open_order_quote_tags_tag_id_fk" referencedTableName="cpq_tag"
	                                 referencedColumnNames="id"/>


	        <addForeignKeyConstraint baseTableName="open_order_quote_products" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_products_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_products" baseColumnNames="open_product_id"
		                                 constraintName="open_order_quote_products_product_id_fk"
		                                 referencedTableName="open_order_product"
		                                 referencedColumnNames="id"/>


	        <addForeignKeyConstraint baseTableName="open_order_quote_articles" baseColumnNames="open_order_quote_id"
	                                 constraintName="open_order_quote_articles_open_order_quote_id_fk"
	                                 referencedTableName="open_order_quote"
	                                 referencedColumnNames="id"/>

	        <addForeignKeyConstraint baseTableName="open_order_quote_articles" baseColumnNames="open_article_id"
		                                 constraintName="open_order_quote_articles_article_id_fk"
		                                 referencedTableName="open_order_article"
		                                 referencedColumnNames="id"/>


		</changeSet>

		<changeSet id="#INTRD-8132_20220628" author="anas.rouaguebe" >
			<addColumn tableName="billing_invoice">
				<column name="open_order_number" type="varchar(255)" />
			</addColumn>
			<addColumn tableName="billing_invoice_line">
				<column name="open_order_number" type="varchar(255)" />
			</addColumn>
		</changeSet>

    <changeSet id="#INTRD-8117_20220629" author="ZBariki">
        <createSequence sequenceName="open_order_seq"/>
        <createTable tableName="open_order">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_open_order" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="open_order_code_unique"/>
            </column>
            <column name="description" type="varchar(255)"/>
            <column name="external_reference" type="varchar(255)"/>
            <column name="type" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="status" type="varchar(25)">
                <constraints nullable="false" />
            </column>
            <column name="open_order_template_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_number" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="billing_account_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="initial_amount" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
            <column name="currency_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="open_order_quote_id" type="bigint"/>
            <column name="end_of_validity_date" type="datetime"/>
            <column name="activation_date" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="balance" type="numeric(23, 12)">
                <constraints nullable="false" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="open_order_template_id"
                                 constraintName="open_order_open_order_template_id_fk"
                                 referencedTableName="open_order_template"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="billing_account_id"
                                 constraintName="open_order_billing_account_id_fk"
                                 referencedTableName="billing_billing_account"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="currency_id"
                                 constraintName="open_order_currency_id_fk"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="open_order" baseColumnNames="open_order_quote_id"
                                 constraintName="open_order_open_order_quote_id_fk"
                                 referencedTableName="open_order_quote"
                                 referencedColumnNames="id"/>

        <addColumn tableName="open_order_threshold">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_product">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="billing_accounting_article">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addColumn tableName="cpq_tag">
            <column name="open_order_id" type="bigint"/>
        </addColumn>

        <addForeignKeyConstraint baseTableName="open_order_threshold" baseColumnNames="open_order_id"
                                 constraintName="open_order_threshold_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_product" baseColumnNames="open_order_id"
                                 constraintName="cpq_product_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="billing_accounting_article" baseColumnNames="open_order_id"
                                 constraintName="billing_accounting_article_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="cpq_tag" baseColumnNames="open_order_id"
                                 constraintName="cpq_tag_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-8106_20220630" author="TarikFA.">
    	<addColumn tableName="rating_edr">
            <column name="event_key" type="varchar(100)" />
            <column name="event_version" type="int4" />
    	</addColumn>
    </changeSet>

        <changeSet id="#INTRD-8027_20220629" author="aelmalki">
            <dropColumn tableName="open_order_product" columnName="code" />
            <dropColumn tableName="open_order_product" columnName="description" />
            <dropColumn tableName="open_order_article" columnName="code" />
            <dropColumn tableName="open_order_article" columnName="description" />
        </changeSet>

    <changeSet id="#INTRD-8580_20220714" author="aelmalki">
        <renameColumn tableName="open_order_quote" newColumnName="quote_number" oldColumnName="open_order_number"/>
        <addColumn tableName="open_order_quote">
            <column name="open_order_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="open_order_id" baseTableName="open_order_quote"
                                 constraintName="fk_open_order" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="open_order" />
    </changeSet>

    <changeSet id="#20220326_M540_178" author="Mbarek-Ay">

        <createTable tableName="cpq_assigned_attributes">
            <column name="attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="assigned_attribute_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addPrimaryKey columnNames="attribute_id,assigned_attribute_id" tableName="cpq_assigned_attributes"/>

        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />
        <addForeignKeyConstraint baseColumnNames="assigned_attribute_id" baseTableName="cpq_assigned_attributes" constraintName="fk_cpq_assigned_attributes_assigned_attribute_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cpq_attribute" />

    </changeSet>

     <changeSet id="#20220408_M540_6296" author="Rachid.Aityaazza">
        <addColumn tableName="cat_discount_plan_item">
            <column name="apply_by_article" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#20220412_M540_172" author="Mbarek-Ay">

		<addColumn tableName="order_price">
			<column name="discount_value" type="numeric(23,12)" />
			<column name="discount_plan_type" type="varchar(50)" />
			<column name="discount_plan_item_id" type="bigint" />
		</addColumn>

        <addForeignKeyConstraint baseColumnNames="discount_plan_item_id" baseTableName="order_price" constraintName="fk_order_price_cat_discount_plan_item" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="cat_discount_plan_item" />
      </changeSet>

	<changeSet id="#20220412_M540_6533" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
		<addColumn tableName="order_price">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
		<addColumn tableName="billing_charge_instance">
			<column name="apply_discounts_on_overriden_price"
				type="${type.boolean}" />
		</addColumn>
	</changeSet>

	<changeSet id="#INTRD-14340_20230228" author="HichamHANINE">
		<addColumn tableName="ar_account_operation">
			<column name="applied_rate" type="numeric(23, 12)" />
			<column name="applied_rate_date" type="datetime" />
		</addColumn>
	</changeSet>


       <changeSet id="#20220415_M540_6609" author="Mbarek-Ay">
		<addColumn tableName="cpq_quote_price">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
		<addColumn tableName="billing_charge_instance">
		<column name="overcharged_unit_amount_without_tax" type="numeric(23,12)"/>
		</addColumn>
      </changeSet>

      <changeSet id="#20220415_M540_6296" author="Rachid.Aityaazza">
		<dropNotNullConstraint columnDataType="bigint" columnName="order_article_line_id" tableName="order_price" />
	</changeSet>


	<changeSet id="#20220415_M540_6931" author="Mbarek-Ay">
		<addColumn tableName="cat_discount_plan">
		<column name="applicable_on_discounted_price" type="${type.boolean}"/>
		<column name="sequence" type="int4"/>
		</addColumn>

	   	<addColumn tableName="crm_provider">
		<column name="activate_cascading_discounts" type="${type.boolean}" defaultValueNumeric="1"/>
		</addColumn>

		<addColumn tableName="cat_discount_plan_item">
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="billing_wallet_operation">
		<column name="discounted_amount" type="numeric(23,12)"/>
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="cpq_quote_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>

		<addColumn tableName="order_price">
		<column name="sequence" type="int4"/>
		<column name="discounted_amount" type="numeric(23,12)"/>
		</addColumn>

		<addColumn tableName="billing_rated_transaction">
		<column name="sequence" type="int4"/>
		</addColumn>

		<addColumn tableName="billing_invoice_line">
		<column name="sequence" type="int4"/>
		</addColumn>

		<createSequence sequenceName="discount_plan_sequence_seq" />
		<sql>
		alter sequence ${db.schema.adapted}discount_plan_sequence_seq RESTART WITH 1;
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='PRODUCT';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='OFFER';
		update ${db.schema.adapted}cat_discount_plan set sequence = nextval('discount_plan_sequence_seq') where sequence is null and discount_plan_type='QUOTE';
		</sql>

      </changeSet>

      <changeSet id="#20220519_M540_7341" author="Mbarek-Ay">
      <addColumn tableName="cat_discount_plan_item">
		<column name="last_discount" type="${type.boolean}"/>
		</addColumn>
	 </changeSet>

    <changeSet id="#INTRD-4681_20220407" author="AndriusKarpavicius">
        <addColumn tableName="dwh_chart">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}dwh_chart set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="dwh_chart" columnName="role_id"/>

        <addColumn tableName="adm_script_exec_role">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}adm_script_exec_role set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="adm_script_exec_role" columnName="role_id"/>

        <createSequence sequenceName="adm_secured_entity_seq" startValue="1" />

        <addColumn tableName="adm_script_sourc_role">
            <column name="role" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}adm_script_sourc_role set role=(select role_name from ${db.schema.adapted}adm_role r where r.id=role_id)</sql>
        <dropColumn tableName="adm_script_sourc_role" columnName="role_id"/>

        <addColumn tableName="adm_secured_entity">
            <column name="id" type="bigint"/>
            <column name="user_name" type="varchar(255)"/>
            <column name="role_name" type="varchar(255)"/>
            <column name="entity_id" type="bigint"/>
            <column name="permission" type="varchar(6)"/>
        </addColumn>

        <renameColumn tableName="adm_secured_entity" oldColumnName="code" newColumnName="entity_code" columnDataType="varchar(255)"/>

        <sql>update ${db.schema.adapted}adm_secured_entity set id=nextval('adm_secured_entity_seq'), permission ='DELETE', user_name= (select u.username from ${db.schema.adapted}adm_user u where u.id=user_id)</sql>
        <sql>insert into ${db.schema.adapted}adm_secured_entity (id, role_name, entity_code, entity_class, permission, disabled) (select nextval('adm_secured_entity_seq'), r.role_name, se.code, se.entity_class, 'DELETE', disabled from ${db.schema.adapted}adm_role r join ${db.schema.adapted}adm_role_secured_entity se on r.id=se.role_id)</sql>

        <dropColumn tableName="adm_secured_entity" columnName="user_id"/>
        <addNotNullConstraint tableName="adm_secured_entity" columnName="id"/>

        <sql>CREATE INDEX adm_secured_entity_username_index ON ${db.schema.adapted}adm_secured_entity(lower(user_name))</sql>
        <sql>CREATE INDEX adm_secured_entity_rolename_index ON ${db.schema.adapted}adm_secured_entity(role_name)</sql>

        <dropTable tableName="adm_role_secured_entity"/>
        <dropTable tableName="adm_user_role"/>
        <dropTable tableName="adm_role_permission"/>
        <dropTable tableName="adm_permission"/>
        <dropTable tableName="adm_role_role"/>

        <addColumn tableName="ord_order">
            <column name="routed_to_user_group" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}ord_order set routed_to_user_group=(select code from ${db.schema.adapted}hierarchy_entity he where he.id=routed_to_user_group_id)</sql>
        <dropColumn tableName="ord_order" columnName="routed_to_user_group_id"/>

        <addColumn tableName="ord_quote">
            <column name="routed_to_user_group" type="varchar(50)"/>
        </addColumn>
        <sql>update ${db.schema.adapted}ord_quote set routed_to_user_group=(select code from ${db.schema.adapted}hierarchy_entity he where he.id=routed_to_user_group_id)</sql>
        <dropColumn tableName="ord_quote" columnName="routed_to_user_group_id"/>

        <dropColumn tableName="adm_user" columnName="email"/>
        <dropColumn tableName="adm_user" columnName="firstname"/>
        <dropColumn tableName="adm_user" columnName="lastname"/>
        <dropColumn tableName="adm_user" columnName="title_id"/>
        <dropColumn tableName="adm_user" columnName="hierarchy_level_id"/>
        <dropColumn tableName="adm_user" columnName="last_login_date"/>
        <dropColumn tableName="adm_user" columnName="crm_address_book_id"/>
        <dropColumn tableName="adm_role" columnName="role_description"/>

    </changeSet>

    <changeSet id="#INTRD-8689_20220727" author="ZBariki">
        <dropColumn tableName="billing_invoice_line" columnName="converted_tax_rate"/>
        <dropColumn tableName="billing_invoice_line" columnName="converted_discount_rate"/>
        <dropColumn tableName="billing_invoice" columnName="converted_discount_rate"/>
    </changeSet>

	<changeSet id="#INTRD-8753_20220727_001" author="anas.rouaguebe">
		<createSequence sequenceName="cpq_billing_rule_seq" startValue="1" />
		<createTable tableName="cpq_billing_rule">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="billing_rule_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="contract_id" type="bigint" />
            <column name="priority" type="int4">
            	<constraints nullable="false" />
            </column>
            <column name="criteria_el" type="varchar(2000)">
            	<constraints nullable="false" />
            </column>
            <column name="invoice_ba_code_el" type="varchar(2000)">
			    <constraints nullable="false" />
			</column>
		</createTable>
	</changeSet>

    <changeSet id="#INTRD-8700_20220728" author="ZBariki">
        <addColumn tableName="billing_tax">
            <column name="composite" type="${type.boolean}" defaultValueNumeric="0"/>
            <column name="main_tax_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="main_tax_id" baseTableName="billing_tax"
                                 constraintName="fk_billing_tax_main_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>

    <changeSet id="#INTRD-8812_20220729" author="ZBariki">
        <dropUniqueConstraint constraintName="open_order_article_unique" tableName="open_order_article"/>
        <dropColumn tableName="open_order_article" columnName="code"/>
        <dropColumn tableName="open_order_article" columnName="description"/>
    </changeSet>

    <changeSet id="#INTRD-8719_20220727" author="TarikRabeh">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price"  type="numeric(23, 12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8721_20220728" author="TarikRabeh">
        <sql>update cpq_price_plan_version set price = amount_without_tax where 1 in (select cp.entreprise from crm_provider cp)</sql>
		<sql>update cpq_price_plan_version set price = amount_with_tax where 0 in (select cp.entreprise from crm_provider cp)</sql>
        <dropColumn tableName="cpq_price_plan_version" columnName="amount_without_tax"/>
        <dropColumn tableName="cpq_price_plan_version" columnName="amount_with_tax"/>
    </changeSet>

	<changeSet id="#INTRD-8777_20220728" author="aelmalki">
		<createTable tableName="billing_run_job_execution">
			<column name="billing_run_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="job_execution_id" type="bigint">
				<constraints nullable="false" />
			</column>
		</createTable>

		<addForeignKeyConstraint baseTableName="billing_run_job_execution" baseColumnNames="billing_run_id"
								 constraintName="billing_run_job_execution_billing_run_id_fk" referencedTableName="billing_billing_run"
								 referencedColumnNames="id"/>

		<addForeignKeyConstraint baseTableName="billing_run_job_execution" baseColumnNames="job_execution_id"
								 constraintName="billing_run_job_execution_job_execution_id_fk" referencedTableName="job_execution"
								 referencedColumnNames="id"/>

	</changeSet>

    <changeSet id="#INTRD-8701_20220801" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="billing_tax"
                                  constraintName="fk_billing_tax_main_tax_id"/>
        <dropColumn tableName="billing_tax" columnName="main_tax_id"/>
        <createTable tableName="billing_tax_composition">
            <column name="main_tax_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="sub_tax_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="main_tax_id, sub_tax_id"
                       constraintName="billing_tax_composition_pkey" tableName="billing_tax_composition" />
        <addForeignKeyConstraint baseColumnNames="main_tax_id" baseTableName="billing_tax_composition"
                                 constraintName="fk_billing_tax_composition_main_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
        <addForeignKeyConstraint baseColumnNames="sub_tax_id" baseTableName="billing_tax_composition"
                                 constraintName="fk_billing_tax_composition_sub_tax_id" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="billing_tax" />
    </changeSet>
    <changeSet id="#INTRD-8252_20220628" author="Abdelkader.Bouazza">
        <addColumn tableName="com_contact">
            <column name="reference" type="varchar(80)" />
            <column name="comment" type="varchar(2000)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8706_20220812" author="TarikFA." dbms="oracle" >
    	<dropUniqueConstraint tableName="billing_invoice" constraintName="uk_billing_invoice"/>
    </changeSet>

	<changeSet id="#INTRD-9117_20220811" author="aelmalki">
		<createTable tableName="open_order_products">
			<column name="open_order_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="open_product_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>
		<createTable tableName="open_order_articles">
			<column name="open_order_id" type="bigint">
				<constraints nullable="false"/>
			</column>
			<column name="open_article_id" type="bigint">
				<constraints nullable="false"/>
			</column>
		</createTable>

		 <addPrimaryKey columnNames="open_order_id,open_product_id"
							 constraintName="open_order_products_pkey"
							 tableName="open_order_products"/>
		 <addPrimaryKey columnNames="open_order_id,open_article_id"
							 constraintName="open_order_articles_pkey"
							 tableName="open_order_articles"/>

        <addForeignKeyConstraint baseTableName="open_order_products" baseColumnNames="open_order_id"
                                 constraintName="open_order_products_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_products" baseColumnNames="open_product_id"
	                                 constraintName="open_order_products_product_id_fk"
	                                 referencedTableName="open_order_product"
	                                 referencedColumnNames="id"/>


        <addForeignKeyConstraint baseTableName="open_order_articles" baseColumnNames="open_order_id"
                                 constraintName="open_order_articles_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_articles" baseColumnNames="open_article_id"
	                                 constraintName="open_order_articles_article_id_fk"
	                                 referencedTableName="open_order_article"
	                                 referencedColumnNames="id"/>
	</changeSet>

	<changeSet id="#INTRD-9117_20220814-remove-oo-ids" author="aelmalki">
		<dropColumn tableName="billing_accounting_article" columnName="open_order_id" />
		<dropColumn tableName="cpq_product" columnName="open_order_id" />
	</changeSet>

    <changeSet id="#INTRD-86_20220815" author="AbdellatifBARI">
        <addColumn tableName="billing_invoice_configuration">
            <column name="display_tax_details" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7301_20220820_order" author="zelmeliani">
        <addColumn tableName="cpq_commercial_order">
            <column name="sales_person_name" type="varchar(52)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-7301_20220820_subscription" author="zelmeliani">
        <addColumn tableName="billing_subscription">
            <column name="sales_person_name" type="varchar(52)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-9232_20220819" author="aelmalki">
        <addColumn tableName="billing_article_mapping_line">
            <column name="attribute_operator" type="varchar(10)" defaultValue="AND">
                <constraints nullable="false"/>
			</column>
        </addColumn>
        <addColumn tableName="billing_attribute_mapping">
            <column name="operator" type="varchar(50)" defaultValue="EQUAL">
                <constraints nullable="false"/>
			</column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-8867_20220817-" author="KHorri">
        <addColumn tableName="open_order">
            <column name="cancel_reason" type="varchar(4000)"/>
        </addColumn>
    </changeSet>

    <changeSet  id="#INTRD-7950_20220816" author="Abdelkader.Bouazza">
         <update tableName="crm_provider">
            <column name="email" value="billing@opencellsoft.com" type="varchar(100)"/>
            <where>email is null</where>
         </update>
         <addNotNullConstraint tableName="crm_provider" columnName="email" columnDataType="varchar(100)"/>
	</changeSet>

    <changeSet id="#INTRD-9451_20220902" author="KhalidHORRI" >

        <createTable tableName="open_order_tags">
            <column name="open_order_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="tag_id" type="bigint">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addPrimaryKey columnNames="open_order_id,tag_id"
                       constraintName="open_order_tags_pkey"
                       tableName="open_order_tags"/>

        <addForeignKeyConstraint baseTableName="open_order_tags" baseColumnNames="open_order_id"
                                 constraintName="open_order_tags_open_order_id_fk"
                                 referencedTableName="open_order"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="open_order_tags" baseColumnNames="tag_id"
                                 constraintName="open_order_tags_tag_id_fk" referencedTableName="cpq_tag"
                                 referencedColumnNames="id"/>
        <dropForeignKeyConstraint baseTableName="cpq_tag"
                                  constraintName="cpq_tag_open_order_id_fk"/>
        <dropColumn tableName="cpq_tag">
            <column name="open_order_id" />
        </dropColumn>
    </changeSet>

    
    

    <changeSet id="#INTRD-9442_20220831" author="HichamHANINE">
		<addColumn tableName="billing_rated_transaction">
            <column name="rules_contract_id" type="bigint" />
        </addColumn>
		<addColumn tableName="billing_wallet_operation">
            <column name="rules_contract_id" type="bigint" />
        </addColumn>
		<addForeignKeyConstraint baseColumnNames="rules_contract_id" baseTableName="billing_rated_transaction" constraintName="fk_billing_rt_rules_contract" deferrable="false" referencedColumnNames="id" referencedTableName="cpq_contract" />
		<addForeignKeyConstraint baseColumnNames="rules_contract_id" baseTableName="billing_wallet_operation" constraintName="fk_billing_wa_op_rules_contract" deferrable="false" referencedColumnNames="id" referencedTableName="cpq_contract" />
	</changeSet>

    <changeSet id="#INTRD-9331_20220824_rt_migration" author="anas.rouaguebe">
        <sql>update ${db.schema.adapted}billing_rated_transaction set origin_billing_account = billing_account__id where origin_billing_account is null</sql>
    </changeSet>

    <changeSet id="#INTRD-7303_20220824_sales_person_name_migration" author="zelmeliani">
        <sql>
        	update ${db.schema.adapted}cpq_quote set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_quote.creator) = lower(adm_user.username)
			and (cpq_quote.sales_person_name is null or cpq_quote.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_quote set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_quote.creator) = lower(adm_user.username)
			and (cpq_quote.sales_person_name is null or cpq_quote.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_commercial_order set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_commercial_order.creator) = lower(adm_user.username)
			and (cpq_commercial_order.sales_person_name is null or cpq_commercial_order.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}cpq_commercial_order set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(cpq_commercial_order.creator) = lower(adm_user.username)
			and (cpq_commercial_order.sales_person_name is null or cpq_commercial_order.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}billing_subscription set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(billing_subscription.creator) = lower(adm_user.username)
			and (billing_subscription.sales_person_name is null or billing_subscription.sales_person_name = '');
		</sql>
		<sql>
			update ${db.schema.adapted}billing_subscription set sales_person_name = adm_user.username from ${db.schema.adapted}adm_user
			where lower(billing_subscription.creator) = lower(adm_user.username)
			and (billing_subscription.sales_person_name is null or billing_subscription.sales_person_name = '');
		</sql>
	</changeSet>
    <changeSet id="#INTRD-9383-20220830" author="Abdelkader.Bouazza">
        <modifyDataType tableName="ar_customer_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="billing_billing_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="billing_user_account" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="com_contact" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="com_sender_config" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_customer" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_provider" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_provider_contact" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="crm_seller" columnName="address_zipcode" newDataType="varchar(20)" />
        <modifyDataType tableName="ord_order_item" columnName="address_zipcode" newDataType="varchar(20)" />
    </changeSet>

    <changeSet id="#INTRD-9535-20220902" author="Abdelkader.Bouazza">
        <createTable tableName="crm_address_book_contact">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="crm_address_book_contact_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="address_book_id" type="bigint" />
            <column name="contact_id" type="bigint" />
            <column name="position" type="varchar(30)" />
            <column name="main_contact" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
        <addForeignKeyConstraint baseTableName="crm_address_book_contact" baseColumnNames="address_book_id"
                                 constraintName="address_book_contact_address_book_fk"
                                 referencedTableName="crm_address_book"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="crm_address_book_contact" baseColumnNames="contact_id"
                                 constraintName="address_book_contact_contact_fk"
                                 referencedTableName="com_contact"
                                 referencedColumnNames="id"/>
        <addUniqueConstraint columnNames="id,address_book_id,contact_id" constraintName="id_address_book_id_contact_id_UNIQUE" tableName="crm_address_book_contact" />
        <addColumn tableName="com_contact">
            <column name="entreprise" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    <changeSet id="#INTRD-9383-20220905" author="Abdelkader.Bouazza">
        <modifyDataType tableName="ar_customer_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="billing_billing_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="billing_user_account" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="com_contact" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="com_sender_config" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_customer" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_provider" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_provider_contact" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="crm_seller" columnName="address_city" newDataType="varchar(100)" />
        <modifyDataType tableName="ord_order_item" columnName="address_city" newDataType="varchar(100)" />
    </changeSet>

	<changeSet id="#INTRD-9583-20220906-br-generateao" author="a.rouaguebe">
		<addColumn tableName="billing_billing_run">
            <column name="generate_ao" type="${type.boolean}" defaultValueNumeric="0">
            	<constraints nullable="false" />
            </column>
        </addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-9581_20200907" author="TarikFA.">
		<addColumn tableName="billing_wallet_operation">
			<column name="price_plan_matrix_version_id" type="bigint" />
			<column name="price_plan_matrix_line_id" type="bigint" />
			<column name="contract_id" type="bigint" />
		</addColumn>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_version_id_fk" 
								 referencedTableName="cpq_price_plan_version" 
								 baseColumnNames="price_plan_matrix_version_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_line_fk" 
								 referencedTableName="cpq_price_plan_matrix_line" 
								 baseColumnNames="price_plan_matrix_version_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
		
		<addForeignKeyConstraint constraintName="contract_id_fk" 
								 referencedTableName="cpq_contract" 
								 baseColumnNames="contract_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
	</changeSet>
    <changeSet id="INTRD-9535-20220908" author="Abdelkader.bouazza">
        <addColumn tableName="crm_address_book">
            <column name="customer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint constraintName="address_book_crm_customer_id_fk"
                                 baseColumnNames="customer_id"
                                 baseTableName="crm_address_book"
                                 referencedTableName="crm_customer"
                                 referencedColumnNames="id" />
        <sql>update crm_address_book ab set customer_id=(select customer.id from crm_customer customer where customer.address_book_id = ab.id)</sql>
    </changeSet>

    <changeSet id="#INTRD-9598-20220909-contact-category" author="a.rouaguebe">
        <createTable tableName="com_contact_category">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="com_contact_category_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
        </createTable>
        <addUniqueConstraint columnNames="code" constraintName="uk_com_contact_category_code" deferrable="false" disabled="false" initiallyDeferred="false" tableName="com_contact_category" />
    </changeSet>
    <changeSet id="#INTRD-9684-20220909" author="khalidHORRI">
        <addColumn tableName="cpq_price_plan_version">
            <column name="price_version_type" type="varchar(255)" defaultValue="FIXED">
                <constraints nullable="false"/>
            </column>
        </addColumn>
        <renameColumn tableName="cpq_price_plan_matrix_line" oldColumnName="price_without_tax" newColumnName="value"/>
    </changeSet>

    <changeSet id="#INTRD-9854-20220915-contact-category-many-to-many" author="a.rouaguebe">
    	<createTable tableName="com_contact_category_contact">
            <column name="contact_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="contact_category_id" type="bigint">
                <constraints nullable="false" />
            </column>
    	</createTable>

    	<addUniqueConstraint columnNames="contact_id,contact_category_id" constraintName="com_contact_category_contact_pk" tableName="com_contact_category_contact" />

        <addForeignKeyConstraint constraintName="contact_category_id_fk"
                                 baseColumnNames="contact_category_id"
                                 baseTableName="com_contact_category_contact"
                                 referencedTableName="com_contact_category"
                                 referencedColumnNames="id" />

		<addForeignKeyConstraint constraintName="contact_id_fk"
                                 baseColumnNames="contact_id"
                                 baseTableName="com_contact_category_contact"
                                 referencedTableName="com_contact"
                                 referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-9786-20220915" author="HichamHANINE">
        <addColumn tableName="crm_provider">
            <column name="rgaa_message" type="varchar(500)" >
                <constraints nullable="true"/>
            </column>
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-10283_20220930" author="HichamHANINE">
        <addColumn tableName="security_deposit">
            <column name="billing_account_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="billing_account_id" baseTableName="security_deposit"
			constraintName="fk_billing_account_security_deposit" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_billing_account" />
    </changeSet>
    
    <changeSet id="#INTRD-9946_20220920" author="HichamHANINE">
        <addColumn tableName="security_deposit">
            <column name="sd_invoice_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="sd_invoice_id" baseTableName="security_deposit" constraintName="fk_security_deposit_invoice"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_invoice" />
    </changeSet>
    
    <changeSet id="#INTRD-10581_20221018" author="HichamHANINE">
        <addColumn tableName="meveo_script_instance">
            <column name="description_i18n" type="${type.json}"></column>
        </addColumn>
    </changeSet>
    
	<changeSet id="#INTRD-9871_20220919" author="TarikFA.">
	
		<dropForeignKeyConstraint constraintName="price_plan_matrix_line_fk"  baseTableName="billing_wallet_operation"/>
		
		<addForeignKeyConstraint constraintName="price_plan_matrix_line_fk" 
								 referencedTableName="cpq_price_plan_matrix_line" 
								 baseColumnNames="price_plan_matrix_line_id" 
								 baseTableName="billing_wallet_operation" 
								 referencedColumnNames="id"/>
	</changeSet>
    
    <changeSet id="#INTRD-9804-20220915" author="khalidHORRI">
        <modifyDataType tableName="cpq_contract_item" columnName="rate" newDataType="${type.float}"/>
    </changeSet>
    
    <changeSet id="#INTRD-10097_202000926" author="TarikFA.">
    	<addColumn tableName="cat_offer_template">
            <column name="generate_quote_edr_per_product" type="${type.boolean}" defaultValueNumeric="0"/>
    	</addColumn>
    </changeSet>
    
     <changeSet id="#INTRD-10135_28092022" author="Mbarek-Ay">
		<update tableName="cpq_attribute"><column name="attribute_type" value="NUMERIC"/><where>id=-9</where></update>
		<update tableName="cpq_attribute"><column name="attribute_type" value="NUMERIC"/><where>id=-10</where></update>
		<update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getActivationDate()}"/><where>id=-1</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getQuantity()}"/><where>id=-2</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getEventDate()}"/><where>id=-3</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getQuantity()}"/><where>id=-4</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getRenewalDate()}"/><where>id=-5</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{serviceInstance.getDeliveryDate()}"/><where>id=-6</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{quote.getValidationDate()}"/><where>id=-7</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{quote.getValidationDate()}"/><where>id=-8</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getSubscriptionMonthsAge()}"/><where>id=-9</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{sub.getSubscriptionDaysAge()}"/><where>id=-10</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter1()}"/><where>id=-11</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter2()}"/><where>id=-12</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter3()}"/><where>id=-13</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter4()}"/><where>id=-14</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter5()}"/><where>id=-15</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter6()}"/><where>id=-16</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter7()}"/><where>id=-17</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter8()}"/><where>id=-18</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getParameter9()}"/><where>id=-19</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam1()}"/><where>id=-21</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam2()}"/><where>id=-22</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam3()}"/><where>id=-23</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam4()}"/><where>id=-24</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDateParam5()}"/><where>id=-25</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam1()}"/><where>id=-31</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam2()}"/><where>id=-32</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam3()}"/><where>id=-33</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam4()}"/><where>id=-34</where></update>
        <update tableName="cpq_attribute"><column name="el_value" value="#{edr.getDecimalParam5()}"/><where>id=-35</where></update>
	</changeSet>
	
	<changeSet id="#INTRD-10163_20220930" author="TarikFA.">
		<createSequence sequenceName="billing_invoice_advance_mapping_seq" startValue="1"/>
		<createTable tableName="billing_invoice_advance_mapping">
			 <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="advance_mapping_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name= "advance_invoice_id" type="bigint" />
            <column name= "invoice_id" type="bigint" />
            <column name= "amount" type="numeric(23, 12)" />
		</createTable>
		
        <addForeignKeyConstraint baseTableName="billing_invoice_advance_mapping" 
        						baseColumnNames="advance_invoice_id"
                                 constraintName="advance_invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
                                 
        <addForeignKeyConstraint baseTableName="billing_invoice_advance_mapping" 
        						baseColumnNames="invoice_id"
                                 constraintName="invoice_id_fk"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"/>
                                 
		<addColumn tableName="billing_invoice">
            <column name= "invoice_balance" type="numeric(23, 12)" />
        </addColumn>
	</changeSet>

	<changeSet id="#INTRD-9796_30092022_exclude_aged_balance" author="a.rouaguebe">
		<addColumn tableName="billing_invoice_type">
			<column name="exclude_from_aged_trial_balance" type="${type.boolean}" defaultValueNumeric="0">
		    	<constraints nullable="false" />
			</column>
		</addColumn>
	</changeSet>

    <changeSet id="#INTRD-8158_20220915" author="AndriusKarpavicius" >
        <modifyDataType tableName="edr_versioning_rule" columnName="criterial_el" newDataType="varchar(2000)"/>
        <modifyDataType tableName="edr_versioning_rule" columnName="key_el" newDataType="varchar(2000)"/>
        <modifyDataType tableName="edr_versioning_rule" columnName="is_new_version_el" newDataType="varchar(2000)"/>
    </changeSet>

    <changeSet id="#INTRD-4681_20220929" author="AndriusKarpavicius">
        <sql>update ${db.schema.adapted}adm_secured_entity set entity_class = reverse(split_part(reverse(entity_class),'.',1))</sql>
    </changeSet>
    
    <changeSet id="#INTRD-10274_20221003" author="AndriusKarpavicius">
        <dropPrimaryKey tableName="adm_secured_entity" constraintName="adm_secured_entity_pkey"/>
        <dropNotNullConstraint tableName="adm_secured_entity" columnName="user_name"/>
        <addPrimaryKey columnNames="id" tableName="adm_secured_entity"/>
    </changeSet>
	
	<changeSet id="#INTRD-9766_20221011_EDR_new_fields" author="aelmalki">
		<addColumn tableName="rating_edr">
			<column name="wallet_operation_id" type="bigint"/>
		</addColumn>
	</changeSet>
    
    <changeSet id="#INTRD-10540_20221013" author="TarikFA.">
    	<dropTable tableName="billing_invoice_advance_mapping"/>
    </changeSet>
    
    <changeSet id="INTRD-10603_20221113" author="AbdelmounaimAkadid">	
		<modifyDataType tableName="adm_inbound_req_cookies" columnName="coockies" newDataType="varchar(500)" />
		<modifyDataType tableName="adm_inbound_req_cookies" columnName="coockies_key" newDataType="varchar(500)" />
	</changeSet>	
	
	<changeSet id="#INTRD-10607_20221014" author="AdilElJaouhari">
		<addColumn tableName="billing_invoice">
            <column name="use_current_rate" type="${type.boolean}" defaultValueNumeric="0">
            	<constraints nullable="false" />
            </column>
        </addColumn>
	</changeSet>

    <changeSet id="#INTRD-10541_20221013" author="TarikFA.">
	    <addColumn tableName="billing_linked_invoices">
	            <column name="amount" type="numeric(23, 12)" />
	            <column name="type" type="varchar(50)" />
	    </addColumn>
	    
		<addForeignKeyConstraint constraintName="invoice_id_fk"
                                 baseColumnNames="id"
                                 baseTableName="billing_linked_invoices"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id" />
                                 
		<addForeignKeyConstraint constraintName="linked_invoice_id_fk"
                                 baseColumnNames="linked_invoice_id"
                                 baseTableName="billing_linked_invoices"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id" />
    	
    </changeSet>
	
	<changeSet id="#INTRD-10522_20221017_matchingCode-journal-entry" author="aelmalki">
		<addColumn tableName="accounting_journal_entry">
			<column name="matching_code" type="varchar(255)" />
		</addColumn>
		<addColumn tableName="crm_provider">
			<column name="current_matching_code" type="varchar(255)" />
		</addColumn>
	</changeSet>
    <changeSet id="#INTRD-10693_20221019-sd-adjustment" author="a.rouaguebe">
        <addColumn tableName="security_deposit">
            <column name="sd_adjustment_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="security_deposit"
                                 baseColumnNames="sd_adjustment_id"
                                 constraintName="fk_security_adjustment_invoice"
                                 referencedTableName="billing_invoice"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>

    <changeSet id="#10629_20221018" author="zelmeliani">
        <addColumn tableName="billing_invoice_line">
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}">
                <constraints nullable="false" />
            </column>
            <column name="cf_values" type="${type.json}" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-10673_20221025" author="AbdellatifBARI">
        <addColumn tableName="finance_settings">
            <column name="activate_dunning" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
     <changeSet id="#INTRD-10957_20221026" author="Mbarek-Ay">
        <addColumn tableName="cpq_quote_version">
            <column name="comment" type="varchar(2000)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-10577_20221020" author="HichamHANINE">
        <addColumn tableName="meveo_script_instance_cat">
            <column name="description_i18n" type="${type.json}">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-10768-20221108-validationrule" author="a.rouaguebe">
        <createSequence sequenceName="billing_invoice_validation_rule_seq" startValue="1" />
        <createTable tableName="billing_invoice_validation_rule">
            <column name="id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(255)" />
            <column name="invoice_type_id" type="bigint" >
                <constraints nullable="false"/>
            </column>
            <column name="priority" type="int4" />
            <column name="valid_from" type="datetime" />
            <column name="valid_to" type="datetime" />
            <column name="type" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="fail_status" type="varchar(50)">
                <constraints nullable="false"/>
            </column>
            <column name="validation_script" type="${type.text}" />
            <column name="validation_el" type="${type.text}" />
        </createTable>
    </changeSet>
    
    
    <changeSet author="AndriusKarpavicius" id="#INTRD-10253_20221027" dbms="oracle">
        <createProcedure>
          create or replace type listagg_clob_t as object
            ( t_varchar2 varchar2(32767)
            , t_clob clob
            , static function odciaggregateinitialize( sctx in out listagg_clob_t )
              return number
            , member function odciaggregateiterate
                ( self in out listagg_clob_t
                , a_val varchar2
                )
              return number
            , member function odciaggregateterminate
                ( self in out listagg_clob_t
                , returnvalue out clob
                , flags in number
                )
              return number
            , member function odciaggregatemerge
                ( self in out listagg_clob_t
                , ctx2 in out listagg_clob_t
                )
              return number
            );
        </createProcedure>
        <createProcedure>
            create or replace type body listagg_clob_t
                is
                  static function odciaggregateinitialize( sctx in out listagg_clob_t )
                  return number
                  is
                  begin
                    sctx := listagg_clob_t( null, null );
                    return odciconst.success;
                  end;
                --
                  member function odciaggregateiterate
                    ( self in out listagg_clob_t
                    , a_val varchar2
                    )
                  return number
                  is
                    procedure add_val( p_val varchar2 )
                    is
                    begin
                      if nvl( lengthb( self.t_varchar2 ), 0 ) + lengthb( p_val ) &lt;= 4000
                -- Strange limit, the max size of self.t_varchar2 is 29993
                -- If you exceeds this number you get ORA-22813: operand value exceeds system limits
                -- with 29993 you get JSON-output as large 58894 bytes
                -- with 4000 you get JSON-output as large 1063896 bytes, probably max more
                      then
                        if self.t_varchar2 is null then
                          self.t_varchar2 := self.t_varchar2 || p_val;
                        else
                          self.t_varchar2 := self.t_varchar2 || ',' || p_val;
                        end if;
                      else
                        if self.t_clob is null
                        then
                          dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                          dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                        else
                          dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), ','||self.t_varchar2 );
                        end if;
                        self.t_varchar2 := p_val;
                      end if;
                    end;
                  begin
                    add_val( a_val );
                    return odciconst.success;
                  end;
                --
                  member function odciaggregateterminate
                    ( self in out listagg_clob_t
                    , returnvalue out clob
                    , flags in number
                    )
                  return number
                  is
                  begin
                    if self.t_clob is null
                    then
                      dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                    end if;
                    if self.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                    end if;
                    returnvalue := self.t_clob;
                    return odciconst.success;
                  end;
                --
                  member function odciaggregatemerge
                    ( self in out listagg_clob_t
                    , ctx2 in out listagg_clob_t
                    )
                  return number
                  is
                  begin
                    if self.t_clob is null
                    then
                      dbms_lob.createtemporary( self.t_clob, true, dbms_lob.call );
                    end if;
                    if self.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( self.t_varchar2 ), self.t_varchar2 );
                    end if;
                    if ctx2.t_clob is not null
                    then
                      dbms_lob.append( self.t_clob, ctx2.t_clob );
                      dbms_lob.freetemporary( ctx2.t_clob );
                    end if;
                    if ctx2.t_varchar2 is not null
                    then
                      dbms_lob.writeappend( self.t_clob, length( ctx2.t_varchar2 ), ctx2.t_varchar2 );
                      ctx2.t_varchar2 := null;
                    end if;
                    return odciconst.success;
                  end;
                --
                end;        
        </createProcedure>
        <createProcedure>
            create or replace function listagg_clob( agg varchar2 )
            return clob
            parallel_enable aggregate using listagg_clob_t;        
        </createProcedure>
    </changeSet>
    
    <changeSet id="#INTRD-11162_20221107" author="HatimOUDAD">
        <addColumn tableName="billing_invoice_line">
            <column name="adjustment_status" type="varchar(50)">
            </column>
        </addColumn>
    </changeSet>
    
   
    
    <changeSet id="INTRD-11433_20221110" author="AbdelmounaimAkadid">
        <modifyDataType tableName="dwh_report_extract_execution" columnName="file_path" newDataType="varchar(256)"/>
    </changeSet>

    <changeSet id="#INTRD-11310_20221110" author="ZBariki">
        <renameColumn tableName="crm_provider"
                      newColumnName="portal_message"
                      oldColumnName="rgaa_message"
                      columnDataType="varchar(500)"/>
    </changeSet>
    
    <changeSet id="#INTRD-10683_20221107" author="AdilElJaouhari">
        <createSequence sequenceName="meveo_script_parameter_seq"/>
        <createTable tableName="meveo_script_parameter">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_meveo_script_parameter" />
            </column>
            <column name="version" type="int4" />
            <column name="code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="script_instance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="description_i18n" type="${type.json}">
                <constraints nullable="true" />
            </column>
            <column name="class_name" type="varchar(255)" defaultValue="java.lang.String">
                <constraints nullable="false" />
            </column>
            <column name="default_value" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="mandatory" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
             <column name="allowed_values" type="varchar(255)">
                <constraints nullable="true" />
            </column>
            <column name="values_separator" type="varchar(20)" defaultValue="|">
                <constraints nullable="false" />
            </column>
            <column name="collection" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            
        </createTable>

        <addForeignKeyConstraint baseTableName="meveo_script_parameter" baseColumnNames="script_instance_id"
                                 constraintName="script_parameter_script_instance_id_fk"
                                 referencedTableName="meveo_script_instance"
                                 referencedColumnNames="id"/>

    </changeSet>

    <changeSet id="#INTRD-8859_20220802" author="hichamELHALOUI">
        <addColumn tableName="dwh_report_extract">
            <column name="include_headers" type="${type.boolean}" defaultValueNumeric="1"/>
        </addColumn>

    </changeSet>


    <changeSet id="#INTRD-11775_20221120" author="hichamELHALOUI">
        <addColumn tableName="cpq_commercial_order">
           <column name="billing_cycle_id" type="bigint" />
            <column name="billing_run_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseTableName="cpq_commercial_order"
                                 baseColumnNames="billing_cycle_id"
                                 constraintName="fk_cpq_commercial_order_billing_cycle"
                                 referencedTableName="billing_cycle"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="cpq_commercial_order"
                                 baseColumnNames="billing_run_id"
                                 constraintName="fk_cpq_commercial_order_billing_run"
                                 referencedTableName="billing_billing_run"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />

    </changeSet>

	<changeSet id="#INTRD-242_20221121" author="AdilElJaouhari">
		<addColumn tableName="billing_cycle">
			<column name="filters" type="${type.json}">
				<constraints nullable="true" />
			</column>
		</addColumn>
	</changeSet>
	
	<changeSet id="#INTRD-11780_20221128" author="AdilElJaouhari">
	 	<addPrimaryKey columnNames="id" tableName="billing_invoice_validation_rule"/>
        <addColumn tableName="billing_invoice">
            <column name="invoice_validation_rule_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="billing_invoice"
                                 baseColumnNames="invoice_validation_rule_id"
                                 constraintName="fk_billing_invoice_validation_rule"
                                 referencedTableName="billing_invoice_validation_rule"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>
    
    <changeSet id="#INTRD-12043_20221121" author="HatimOUDAD">
		<addColumn tableName="billing_invoice_validation_rule">
			<column name="rule_values" type="${type.json}">
			</column>
		</addColumn>
	</changeSet>

    <changeSet id="INTRD-11732_20221130" author="MehdiBOURRAS">
        <addColumn tableName="com_message_template">
            <column name="textcontent_i18n" type="${type.json}"/>
            <column name="subject_i18n" type="${type.json}"/>
            <column name="htmlcontent_i18n" type="${type.json}"/>
        </addColumn>
    </changeSet>
    
	<changeSet id="INTRD_12001_20221205" author="TarikFA.">
		<modifyDataType tableName="meveo_script_instance" columnName="description" newDataType="varchar(1000)"/>
	</changeSet>

    <changeSet id="#12201_20221212" author="zelmeliani">
        <renameTable newTableName="billing_redirection_rule" oldTableName="cpq_billing_rule"/>
    </changeSet>

	<changeSet id="#INTR-112153_20221209_new_field" author="a.rouaguebe">
		<addColumn tableName="cat_charge_template">
            <column name="internal_note" type="${type.longtext}" />
        </addColumn>
	</changeSet>
	
	 <changeSet id="#2038-20221130" author="Mbarek-Ay">
       <createSequence sequenceName="crm_address_book_contact_seq" startValue="1" />
    </changeSet>

	<changeSet id="#INTR-12252_20221212_agreement_date" author="a.rouaguebe">
		<addColumn tableName="cpq_product">
            <column name="agreement_date_setting" type="varchar(20)"/>
        </addColumn>
	</changeSet>
	
	<changeSet id="#INTR-12382_20221219" author="HichamHANINE">
		<addColumn tableName="cat_offer_template">
            <column name="sequence" type="INT4" defaultValue="0" />
			<column name="display" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
	</changeSet>

    <changeSet id="#INTRD-11841_20221214-reports" author="HichamHANINE">
        <update tableName="meveo_script_instance">
            <column name="script">
                <![CDATA[
package org.meveo.service.script.presale;
import java.io.File;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Collections;
import java.math.RoundingMode;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.*;
import static java.math.BigDecimal.ZERO;
import static java.util.Optional.ofNullable;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.PENDING;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.PPAID;
import static org.meveo.model.billing.InvoicePaymentStatusEnum.UNPAID;
import static org.meveo.model.billing.InvoiceStatusEnum.VALIDATED;
import static org.meveo.model.shared.DateUtils.setDateToEndOfDay;
import org.meveo.commons.utils.StringUtils;
import org.meveo.model.shared.DateUtils;
import org.meveo.commons.utils.QueryBuilder;
import org.meveo.admin.exception.BusinessException;
import org.meveo.commons.utils.CsvBuilder;
import org.meveo.model.payments.CustomerAccount;
import org.meveo.service.payments.impl.CustomerAccountService;
import org.meveo.service.script.finance.ReportExtractScript;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory; 
import org.meveo.admin.util.pagination.PaginationConfiguration;
import static java.util.Arrays.asList;
import org.meveo.model.payments.RecordedInvoice;
import org.meveo.model.payments.MatchingStatusEnum;
import org.meveo.api.dto.AgedReceivableDto;
import org.meveo.model.shared.Name;
import org.meveo.model.admin.Currency;
import org.meveo.model.crm.Provider;
import org.meveo.service.crm.impl.ProviderService;
import org.meveo.commons.utils.EjbUtils;
public class AgedBalanceReporting extends ReportExtractScript {
    private static final Logger log = LoggerFactory.getLogger(AgedBalanceReporting.class);
  	private static Provider appProvider;
    private CustomerAccountService customerAccountService = (CustomerAccountService) getServiceInterface(CustomerAccountService.class.getSimpleName());
    @Override public void execute(Map < String, Object > executeContext) throws BusinessException {
        try {    
          	appProvider = ((ProviderService) EjbUtils.getServiceInterface("ProviderService")).getProvider();
          	String currencyCode = "";
          	Map < String, Object > paramsProvider = new HashMap < String, Object > ();
          	paramsProvider.put("code", appProvider.getCode());
           	String queryProvider = "Select pr.currency.currencyCode, pr.id FROM Provider pr where lower(pr.code)=lower(:code)";
			List < Object[] > rowsProvider = (List < Object[] > ) customerAccountService.executeSelectQuery(queryProvider, paramsProvider);
          	for (Object[] row: rowsProvider) {
                currencyCode = row[0] + "";
            }
          
          	List<String> fetchFields = asList("fields");
          	PaginationConfiguration paginationConfiguration = new PaginationConfiguration(0, 50, null, null, fetchFields, "dueDate", "DESCENDING");
          	int numberOfPeriods = 4;
          	String query = getAgedReceivables(null, null, new Date(), null, null, paginationConfiguration, 30, numberOfPeriods, null, null, null, null, null);
          
            log.debug("execute executeContext:{}", executeContext);
            Map < String, Object > params = new HashMap < String, Object > ();
               
          	List < Object[] > rows = (List < Object[] > ) customerAccountService.executeSelectQuery(query, params);
          	List<AgedReceivableDto> listAgedReceivable = buildDynamicResponse(rows, numberOfPeriods);
            
            log.debug("execute rows size:{}", rows == null ? null : rows.size());
            String dirOutput = String.valueOf(executeContext.get(ReportExtractScript.DIR));
            String filename = String.valueOf(executeContext.get(ReportExtractScript.FILENAME));
            CsvBuilder csvBuilder = new CsvBuilder(";", false);
            String[] header = {
                "Customer description", "Customer", "Invoice Number",
               	"Total current", "0_30_DAYS","30_60_DAYS","60_90_DAYS","90_DAYS",
                "Total overdue","Total",
                "Currency","Amount billed","Billing currency"
            };
            csvBuilder.appendValues(header);
            csvBuilder.startNewLine();
            for (AgedReceivableDto agedReceivableDto: listAgedReceivable) {
                csvBuilder.appendValue(agedReceivableDto.getCustomerAccountDescription());
                csvBuilder.appendValue(agedReceivableDto.getCustomerAccountCode());
                csvBuilder.appendValue(agedReceivableDto.getInvoiceNumber());
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getNotYetDue()));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(0)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(1)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(2)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getTotalAmountByPeriod().get(3)));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getGeneralTotal()));
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getGeneralTotal()));
                csvBuilder.appendValue(currencyCode);
                csvBuilder.appendValue(round((BigDecimal) agedReceivableDto.getBilledAmount()));
                csvBuilder.appendValue(agedReceivableDto.getTradingCurrency());
              
                csvBuilder.startNewLine();
            }
            csvBuilder.toFile(dirOutput + File.separator + filename);
            log.debug("execute file generated:{}", dirOutput + File.separator + filename);
        } catch (Exception e) {
            log.error("Error on AgedBalanceReporting:", e);
            throw new BusinessException(e.getMessage());
        }
    }
    private String round(BigDecimal amount) {
        if (amount == null) {
            return "";
        }
        if (amount.scale() > 4) {
            String amountAsString = "" + amount;
            amount = new BigDecimal(amount.longValue() + "." + amountAsString.substring(amountAsString.indexOf(".") + 1).substring(0, 4));
        }
        amount = amount.setScale(2, RoundingMode.UP);
        return amount.toPlainString();
    }
  
  public String getAgedReceivables(String customerAccountCode, String sellerCode, Date startDate, Date startDueDate, Date endDueDate, PaginationConfiguration paginationConfiguration,
                                             Integer stepInDays, Integer numberOfPeriods, String invoiceNumber, String customerAccountDescription, String sellerDescription, String tradingCurrency, String functionalCurrency) {        
    	String datePattern = "yyyy-MM-dd";
        StringBuilder query = new StringBuilder("Select ao.customerAccount.id, sum (case when ao.dueDate >= '")
                .append(DateUtils.formatDateWithPattern(startDate, datePattern))
                .append("'  then  ao.unMatchingAmount else 0 end ) as notYetDue,");
    	if(stepInDays != null && numberOfPeriods != null) {
    	    String alias;
    	    int step;
    	    if(numberOfPeriods > 1) {
                query.append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_1_" + stepInDays + ",")
                        .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_1_" + stepInDays + "_awt,")
                        .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -stepInDays), datePattern)+"' then ao.taxAmount else 0 end ) as sum_1_" + stepInDays + "_tax,");
                for (int iteration = 1; iteration < numberOfPeriods - 1; iteration++) {
                    step = iteration * stepInDays;
                    alias = "as sum_"+ (stepInDays * iteration + 1) + "_" + (step * 2);
                    query.append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then ao.amountWithoutTax else 0 end ) ")
                            .append(alias).append(" , ")
                            .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then ao.unMatchingAmount  else 0 end ) ")
                            .append(alias).append("_awt, ")
                            .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -(step + stepInDays)), datePattern)+"' then  ao.taxAmount else 0 end ) ")
                            .append(alias).append("_tax, ");
                }
            }
            step = numberOfPeriods > 1  ? stepInDays * (numberOfPeriods - 1) : stepInDays;
            query.append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"'  then ao.amountWithoutTax else 0 end ) as sum_" + step + "_up,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"'  then ao.unMatchingAmount else 0 end ) as sum_" + step + "_up_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -step), datePattern)+"' then ao.taxAmount else 0 end ) as sum_" + step + "_up_tax,");
        } else {
    	    query.append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_1_30,")
    	            .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_1_30_awt,")
    	            .append("sum (case when ao.dueDate <'"+DateUtils.formatDateWithPattern(startDate, datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' then ao.taxAmount else 0 end ) as sum_1_30_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.amountWithoutTax  else 0 end ) as sum_31_60,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_31_60_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -30), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' then ao.taxAmount else 0 end ) as sum_31_60_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.amountWithoutTax else 0 end ) as sum_61_90,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.unMatchingAmount else 0 end ) as sum_61_90_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -60), datePattern)+"' and ao.dueDate >'"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"' then ao.taxAmount else 0 end ) as sum_61_90_tax,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.amountWithoutTax else 0 end ) as sum_90_up,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.unMatchingAmount else 0 end ) as sum_90_up_awt,")
                    .append("sum (case when ao.dueDate <='"+DateUtils.formatDateWithPattern(DateUtils.addDaysToDate(startDate, -90), datePattern)+"'  then ao.taxAmount else 0 end ) as sum_90_up_tax,");
        }
        query.append(" ao.customerAccount.dunningLevel, ao.customerAccount.name, ao.customerAccount.description, ao.seller.description, ao.seller.code, ao.dueDate, ao.invoice.tradingCurrency.currency.currencyCode, ao.invoice.id, ao.invoice.invoiceNumber, ao.invoice.amountWithTax, ao.customerAccount.code, ao.invoice.convertedAmountWithTax, ao.invoice.billingAccount.id ")
                .append("from ")
                .append(RecordedInvoice.class.getSimpleName())
                .append(" as ao");
        QueryBuilder qb = new QueryBuilder(query.toString());
        qb.addSql("(ao.matchingStatus='"+MatchingStatusEnum.O+"' or ao.matchingStatus='"+MatchingStatusEnum.P+"') ");
        qb.addSql("ao.invoice.invoiceType.excludeFromAgedTrialBalance = false");
        ofNullable(customerAccountCode).ifPresent(ca -> qb.addSql("UPPER(ao.customerAccount.code) like '%" + customerAccountCode.toUpperCase() +"%'"));
        ofNullable(customerAccountDescription).ifPresent(caDescription -> qb.addSql("UPPER(ao.customerAccount.description) like '%" + caDescription.toUpperCase() +"%'"));
        ofNullable(sellerDescription).ifPresent(sDescription -> qb.addSql("UPPER(ao.seller.description) like ('%" + sDescription.toUpperCase() +"%')"));
        ofNullable(sellerCode).ifPresent(sel -> qb.addSql("UPPER(ao.seller.code) like '%" + sellerCode.toUpperCase() +"%'"));
        ofNullable(invoiceNumber).ifPresent(invNumber -> qb.addSql("ao.invoice.invoiceNumber = '" + invNumber +"'"));
        ofNullable(tradingCurrency).ifPresent(fc -> qb.addSql("ao.invoice.tradingCurrency.currency.currencyCode = '" + fc + "'"));
        if (startDueDate != null && endDueDate != null) {
            qb.addSql("(ao.dueDate >= '" + DateUtils.formatDateWithPattern(startDueDate, datePattern)
                    + "' and ao.dueDate <= '" + DateUtils.formatDateWithPattern(endDueDate, datePattern) + "')");
        }
        if (DateUtils.compare(startDate, new Date()) < 0) {
            qb.addSql("ao.invoice.status = '" + VALIDATED + "' and ao.invoice.invoiceDate <= '"
                    + DateUtils.formatDateWithPattern(setDateToEndOfDay(startDate), "yyyy-MM-dd HH:mm:ss") + "'");
            qb.addSql("(ao.invoice.paymentStatus = '" + PENDING + "' or ao.invoice.paymentStatus = '" + PPAID + "' or ao.invoice.paymentStatus ='" + UNPAID + "')");
        }
        qb.addGroupCriterion("ao.customerAccount.id, ao.customerAccount.dunningLevel, ao.customerAccount.name, ao.customerAccount.description, ao.seller.description, ao.seller.code, ao.dueDate, ao.amount, ao.invoice.tradingCurrency.currency.currencyCode, ao.invoice.id, ao.invoice.invoiceNumber, ao.invoice.amountWithTax, ao.customerAccount.code, ao.invoice.convertedAmountWithTax, ao.invoice.billingAccount.id ");
        qb.addPaginationConfiguration(paginationConfiguration);
          return qb.getSqlString();
    }
  
  public List<AgedReceivableDto> buildDynamicResponse(List<Object[]> agedReceivables, int numberOfPeriods) {
		List<AgedReceivableDto> responseDto = new  ArrayList<>();
		for (int index = 0; index < agedReceivables.size(); index++) {
			Object[] agedReceivable = agedReceivables.get(index);
			AgedReceivableDto agedReceivableDto = new AgedReceivableDto();
			agedReceivableDto.setNotYetDue((BigDecimal) agedReceivable[1]);
			int sumIndex;
			int startingSumIndex = 2;
			agedReceivableDto.setNetAmountByPeriod(new ArrayList<>());
			agedReceivableDto.setTotalAmountByPeriod(new ArrayList<>());
			agedReceivableDto.setTaxAmountByPeriod(new ArrayList<>());
			for (sumIndex = 0; sumIndex < numberOfPeriods; sumIndex++) {
				agedReceivableDto.getNetAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex]);
				agedReceivableDto.getTotalAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex + 1]);
				agedReceivableDto.getTaxAmountByPeriod().add((BigDecimal) agedReceivable[startingSumIndex + 2]);
				startingSumIndex += 3;
			}
			agedReceivableDto.setCustomerAccountName(agedReceivable[++startingSumIndex] == null ? null : getName((Name) agedReceivable[startingSumIndex]));
			agedReceivableDto.setCustomerAccountDescription((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setSellerDescription((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setSellerCode((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setDueDate(agedReceivable[++startingSumIndex] == null ? null : ((Date) agedReceivable[startingSumIndex]));
			agedReceivableDto.setTradingCurrency((String) agedReceivable[++startingSumIndex]);
			BigDecimal generalTotal = agedReceivableDto.getTotalAmountByPeriod().stream().reduce(ZERO, BigDecimal::add);
			agedReceivableDto.setGeneralTotal(generalTotal);
			agedReceivableDto.setInvoiceId((Long) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setInvoiceNumber((String) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setBilledAmount((BigDecimal) agedReceivable[++startingSumIndex]);
			agedReceivableDto.setCustomerAccountCode((String) agedReceivable[++startingSumIndex]);
			if(agedReceivable[++startingSumIndex] != null)
				agedReceivableDto.setBilledAmount((BigDecimal) agedReceivable[startingSumIndex]);
			agedReceivableDto.setCustomerId((Long) agedReceivable[++startingSumIndex]);
			responseDto.add(agedReceivableDto);
		}
		return responseDto;
	}
  
  	private String getName(Name name) {
		return (name.getFirstName() != null ? name.getFirstName() : "")
				+ (name.getLastName() != null ? " " + name.getLastName() : "");
	}
}
				]]>
            </column>
            <where>id=-12</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-12466_20222012" author="bourras">
        <update tableName="global_settings">
            <column name="activate_dunning" value="1"/>
            <where>id=1</where>
        </update>
    </changeSet>

    <changeSet id="#INTRD-12609_20221227_converted_ppv" author="a.rouaguebe">
    	<createSequence sequenceName="cpq_converted_price_plan_version_seq" startValue="1" />
        <createTable tableName="cpq_converted_price_plan_version">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cpq_converted_price_plan_version_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="price_plan_matrix_version_id" type="bigint" />
            <column name="converted_price" type="numeric(23, 12)" />
            <column name="trading_currency_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="rate" type="numeric(23, 12)" />
            <column name="use_for_billing_accounts" type="${type.boolean}"/>
        </createTable>
    </changeSet>

    <changeSet id="#INTRD-12609_20221227_converted_ppv-fix" author="a.rouaguebe">
    	<addColumn tableName="cpq_converted_price_plan_version">
			 <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
		</addColumn>
    </changeSet>



    <changeSet id="#INTRD-12614_20221227" author="TarikFA.">
       <createSequence sequenceName="cpq_converted_price_plan_matrix_line_sq" startValue="1" />
       <createTable tableName="cpq_converted_price_plan_matrix_line">
       		<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_converted_plan_matrix_line" />
            </column>
            <column name="version" type="int4" />

            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

            <column name="converted_value" type="numeric(23, 12)" />
            <column name="trading_currency_id" type="bigint" />
            <column name="rate" type="numeric(23, 12)" />
            <column name="use_for_billing_accounts" type="${type.boolean}" />
            <column name="price_plan_matrix_line_id" type="bigint" />
       </createTable>

        <addForeignKeyConstraint baseTableName="cpq_converted_price_plan_matrix_line"
                                 baseColumnNames="trading_currency_id"
                                 constraintName="fk_cpq_converted_price_plan_matrix_line_id"
                                 referencedTableName="billing_trading_currency"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />


        <addForeignKeyConstraint baseTableName="cpq_converted_price_plan_matrix_line"
                                 baseColumnNames="price_plan_matrix_line_id"
                                 constraintName="fk_price_plan_matrix_line_id"
                                 referencedTableName="cpq_price_plan_matrix_line"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />

    </changeSet>

	<changeSet id="#INTRD-12478_20221226" author="AdilElJaouhari">
		<addColumn tableName="billing_cycle">
			<column name="priority" type="int4" defaultValueNumeric="0" />
		</addColumn>
	</changeSet>

	<changeSet id="#INTRD-12677_20221229" author="AdilElJaouhari">
		<createTable tableName="crm_provider_order_line_type">
			<column name="provider_id" type="bigint" />
			<column name="order_line_type" type="varchar(20)" />
		</createTable>

		<addForeignKeyConstraint
			baseTableName="crm_provider_order_line_type"
			baseColumnNames="provider_id"
			constraintName="crm_provider_order_line_type_provider_fk"
			referencedTableName="crm_provider" referencedColumnNames="id" />

		<addUniqueConstraint
			columnNames="provider_id, order_line_type"
			constraintName="crm_provider_order_line_type_uk"
			tableName="crm_provider_order_line_type" />
	</changeSet>
	
	<changeSet id="#INTRD-10544_20221207" author="HatimOUDAD"> 
        <createSequence sequenceName="iso_icd_seq" startValue="1" />
        <createTable tableName="iso_icd">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_iso_icd" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_icd_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="scheme_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        
        <createSequence sequenceName="untdid_unit_seq" startValue="1" />
        <createTable tableName="untdid_unit">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_untdid_unit" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
            </column>

            <!-- Simple fields -->           
            <column name="source" type="varchar(10)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_1001_invoice_code_type_seq" startValue="1" />
        <createTable tableName="untdid_1001_invoice_code_type">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_1001_invoice_type" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_1001_code_type_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="en16931_interpretation" type="varchar(20)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="true" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_2475_vat_payment_option_seq" startValue="1" />
        <createTable tableName="untdid_2475_vat_payment_option">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_2475_vat_payment" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />

             <!-- Simple fields -->           
            <column name="code_2005" type="varchar(10)">
                <constraints nullable="false" />
            </column>
             <column name="value_2005" type="varchar(500)">
                <constraints nullable="false" />
            </column>
             <column name="code_2475" type="varchar(10)">
                <constraints nullable="false" />
            </column>
             <column name="value_2475" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_4451_invoice_subject_code_seq" startValue="1" />
        <createTable tableName="untdid_4451_invoice_subject_code">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_4451_invoice_subject" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_4451_subject_code_unique"/>
            </column>

            <!-- Simple fields -->    
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_5305_taxation_category_seq" startValue="1" />
        <createTable tableName="untdid_5305_taxation_category">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_5305_taxation_category" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="iso_5305_taxation_category_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="semantic_model" type="varchar(500)">
                <constraints nullable="false" />
            </column>
            <column name="name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_vatex_seq" startValue="1" />
        <createTable tableName="untdid_vatex">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_untdid_vatex" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_vatex_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="remark" type="varchar(500)">
                <constraints nullable="true" />
            </column>
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <createSequence sequenceName="untdid_4461_payment_means_seq" startValue="1" />
        <createTable tableName="untdid_4461_payment_means">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_4461_payment_means" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_4461_payment_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="usage_in_EN16931" type="varchar(500)">
                <constraints nullable="true" />
            </column>
            <column name="code_name" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        


        <createSequence sequenceName="untdid_5189_allowance_code_seq" startValue="1" />
         <createTable tableName="untdid_5189_allowance_code">
            <!-- Generic fields -->
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="pk_5189_allowance_code" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(10)">
                <constraints unique="true" nullable="false" uniqueConstraintName="untdid_5189_allowance_code_unique"/>
            </column>

            <!-- Simple fields -->           
            <column name="description" type="varchar(500)">
                <constraints nullable="false" />
            </column>

        </createTable>
        
        <sql>INSERT INTO ${db.schema.adapted}untdid_5305_taxation_category(id,version,created,updated,creator,updater,code,semantic_model,name) VALUES (1, 0, now(), NULL, 'opencell.admin', NULL, 'S', 'Standard rate', 'Standard rate');
			INSERT INTO ${db.schema.adapted}untdid_2475_vat_payment_option(id,version,created,updated,creator,updater,code_2005,value_2005,code_2475,value_2475) VALUES (1, 0, now(), NULL, 'opencell.admin', NULL, '3', 'Invoice document issue date time', '5', 'Date of invoice');
		</sql>
			
        <addColumn tableName="billing_tax">
            <column name="taxation_category_id" type="bigint" defaultValueNumeric="1">
             <constraints nullable="false" />
            </column>
            <column name="vatex_id" type="bigint">
            </column>
        </addColumn>
         <addColumn tableName="billing_invoice_type">
            <column name="invoice_code_type_id" type="bigint">
            </column>
             <column name="vat_payment_option_id" type="bigint" defaultValueNumeric="1">
             <constraints nullable="false" />
            </column>
        </addColumn>
        
        <addForeignKeyConstraint baseTableName="billing_tax"
                                 baseColumnNames="taxation_category_id"
                                 constraintName="fk_billing_tax_5305_taxation_category"
                                 referencedTableName="UNTDID_5305_TAXATION_CATEGORY"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="billing_tax"
                                 baseColumnNames="vatex_id"
                                 constraintName="fk_billing_tax_vatex"
                                 referencedTableName="UNTDID_VATEX"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
                                 
        <addForeignKeyConstraint baseTableName="BILLING_INVOICE_TYPE"
                                 baseColumnNames="invoice_code_type_id"
                                 constraintName="fk_billing_invoice_1001_invoice"
                                 referencedTableName="UNTDID_1001_INVOICE_CODE_TYPE"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        <addForeignKeyConstraint baseTableName="BILLING_INVOICE_TYPE"
                                 baseColumnNames="vat_payment_option_id"
                                 constraintName="fk_billing_invoice_2475_vat"
                                 referencedTableName="UNTDID_2475_VAT_PAYMENT_OPTION"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
        
        
    </changeSet>

    <changeSet id="#INTRD-12668-20230102" author="AmineBENAICHA">
		<addColumn tableName="billing_cycle">
            <column name="disable_aggregation" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="use_accounting_article_label" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="date_aggregation" type="varchar(255)" defaultValue="NO_DATE_AGGREGATION" />
            <column name="aggregate_unit_amounts" type="${type.boolean}" defaultValueNumeric="0" />
            <column name="ignore_subscriptions" type="${type.boolean}" defaultValueNumeric="1" />
            <column name="ignore_orders" type="${type.boolean}" defaultValueNumeric="1" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-12794-20230102-counter_instance" author="a.rouaguebe">
    	<dropPrimaryKey tableName="billing_chrg_inst_counter" constraintName="billing_chrg_inst_counter_pkey" />
    	<addPrimaryKey columnNames="chrg_instance_id, counter_instance_id" constraintName="billing_chrg_inst_counter_pkey" tableName="billing_chrg_inst_counter" />
    </changeSet>

    <changeSet id="#INTRD-12544_20230102" author="bourras">
        <addColumn tableName="cat_offer_template">
            <column name="document_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="document_id" baseTableName="cat_offer_template"
                                 constraintName="fk_document_id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="document"/>
    </changeSet>

	<changeSet id="#INTRD-12405_20221226" author="HichamHANINE">
		<addColumn tableName="crm_provider">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="crm_seller">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_billing_account">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_user_account">
			<column name="icd_id" type="bigint"></column>
		</addColumn>
		<addColumn tableName="ar_payment_token">
			<column name="payment_means" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_invoice_type">
			<column name="invoice_subject_code" type="bigint"></column>
		</addColumn>
		<addColumn tableName="billing_accounting_article">
			<column name="allowance_code" type="bigint"></column>
		</addColumn>
	
		<addForeignKeyConstraint baseTableName="billing_billing_account"
								 baseColumnNames="icd_id"
								 constraintName="fk_billing_account_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="billing_user_account"
								 baseColumnNames="icd_id"
								 constraintName="fk_user_account_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="crm_seller"
								 baseColumnNames="icd_id"
								 constraintName="fk_seller_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="crm_provider"
								 baseColumnNames="icd_id"
								 constraintName="fk_provider_icd"
								 referencedTableName="iso_icd"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />							 
		<addForeignKeyConstraint baseTableName="billing_invoice_type"
								 baseColumnNames="invoice_subject_code"
								 constraintName="fk_invoice_type_untdid_4451_invoice_subject"
								 referencedTableName="untdid_4451_invoice_subject_code"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="ar_payment_token"
								 baseColumnNames="payment_means"
								 constraintName="fk_payment_token_untdid_4461_payment_means"
								 referencedTableName="untdid_4461_payment_means"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<addForeignKeyConstraint baseTableName="billing_accounting_article"
								 baseColumnNames="allowance_code"
								 constraintName="fk_accounting_article_untdid_5189_allowance_code"
								 referencedTableName="untdid_5189_allowance_code"
								 referencedColumnNames="id"
								 deferrable="false" initiallyDeferred="false"
								 onDelete="NO ACTION" onUpdate="NO ACTION" />
		<dropColumn tableName="untdid_4461_payment_means">
            <column name="usage_in_EN16931"></column>
        </dropColumn>
        <addColumn tableName="untdid_4461_payment_means">
			<column name="usage_in_en16931" type="varchar(500)">
                <constraints nullable="true" />
            </column>
		</addColumn>
	</changeSet>

    <changeSet id="#INTRD-12766_20230105" author="bourras">
        <addColumn tableName="billing_invoice">
            <column name="converted_invoice_balance" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-12047-20230112" author="AbdelmounaimAkadid">
    	<createIndex indexName="idx__cpq_attribute_instance__subscription_id" tableName="cpq_attribute_instance">
	      	<column name="subscription_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__cpq_attribute_instance__parent_id" tableName="cpq_attribute_instance">
	      	<column name="parent_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__origin_billing_account" tableName="billing_rated_transaction">
	      	<column name="origin_billing_account"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__rules_contract_id" tableName="billing_rated_transaction">
	      	<column name="rules_contract_id"/>
	  	</createIndex>
	  	<createIndex indexName="idx__billing_rated_transaction__service_instance_id" tableName="billing_rated_transaction">
	      	<column name="service_instance_id"/>
	  	</createIndex>
    </changeSet>

    <changeSet id="#INTRD-12720-20221230-query_report" author="a.rouaguebe">
      <addColumn tableName="report_query">
        <column name="query_parameters" type="${type.json}" />
      </addColumn>
    </changeSet>

    <changeSet id="#INTRD-12766_20230106" author="bourras">
        <addColumn tableName="billing_linked_invoices">
            <column name="converted_amount" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-13065_20230112" author="AdilElJaouhari">
		<dropColumn columnName="validation_script" tableName="billing_invoice_validation_rule" />
		<addColumn tableName="billing_invoice_validation_rule">
			<column name="script_instance_id" type="bigint" />
		</addColumn>
		<addForeignKeyConstraint baseColumnNames="script_instance_id" baseTableName="billing_invoice_validation_rule"
                                 constraintName="fk_validation_rule_meveo_script_instance" deferrable="false"
                                 initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
                                 referencedColumnNames="id" referencedTableName="meveo_script_instance" />
	</changeSet>

    <changeSet id="#INTRD-12781_20230116" author="zelmeliani">
        <addColumn tableName="ar_dunning_action">
            <column name="type" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="dunning_level">
            <column name="type" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="dunning_policy">
            <column name="type" type="varchar(255)"/>
        </addColumn>
        <addColumn tableName="com_message_template">
            <column name="type_dunning_mode" type="varchar(255)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-12799-20230113-query_report_aliases" author="a.rouaguebe">
		<addColumn tableName="report_query">
			<column name="aliases" type="${type.json}" />
		</addColumn>
	</changeSet>

	<changeSet id="#INTRD-13031_20230118" author="AdilElJaouhari">
		<addColumn tableName="cat_discount_plan">
			<column name="automatic_application" type="${type.boolean}" defaultValueNumeric="0" />
		</addColumn>
	</changeSet>

	<changeSet id="#INTRD-13204_20230119" author="HichamHANINE">
        <addColumn tableName="billing_invoice_line">
            <column name="specific_converted_unit_price" type="numeric(23, 12)" />
            <column name="specific_converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="specific_converted_amount_with_tax" type="numeric(23, 12)" />
            <column name="specific_converted_amount_tax" type="numeric(23, 12)" />
            <column name="specific_converted_discount_amount" type="numeric(23, 12)" />
            <column name="specific_converted_raw_amount" type="numeric(23, 12)" />
			<column name="use_specific_price_conversion" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-14231_20230227" author="HichamHANINE">
    	<dropColumn tableName="billing_invoice_line" columnName="specific_converted_unit_price"/>
        <dropColumn tableName="billing_invoice_line" columnName="specific_converted_amount_without_tax"/>
        <dropColumn tableName="billing_invoice_line" columnName="specific_converted_amount_with_tax"/>
        <dropColumn tableName="billing_invoice_line" columnName="specific_converted_amount_tax"/>
        <dropColumn tableName="billing_invoice_line" columnName="specific_converted_discount_amount"/>
        <dropColumn tableName="billing_invoice_line" columnName="specific_converted_raw_amount"/>
    </changeSet>

    <changeSet id="#INTRD-12651-20230123" author="AdilElJaouhari">
        <modifyDataType tableName="cpq_order_offer" columnName="order_line_type" newDataType="varchar(20)" />
    </changeSet>

	<changeSet id="#INTRD-12819-20221220-qb_advanced_query" author="a.rouaguebe">
        <addColumn tableName="report_query">
        	<column name="advanced_query" type="${type.json}" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-13062-20230124" author="ZBariki">
        <createSequence sequenceName="ar_customer_balance_seq" />
        <createTable tableName="ar_customer_balance">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="customer_balance_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(255)" />
            <column name="description" type="varchar(255)" />
            <column name="default_balance" type="${type.boolean}" defaultValueNumeric="0" />
        </createTable>
        <createTable tableName="ar_customer_balance_templates">
            <column name="customer_balance_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="template_id" type="bigint">
                <constraints nullable="false" />
            </column>
        </createTable>
        <addPrimaryKey columnNames="customer_balance_id, template_id"
                       constraintName="ar_templates_customer_balance_pkey"
                       tableName="ar_customer_balance_templates" />
        <addForeignKeyConstraint baseTableName="ar_customer_balance_templates" baseColumnNames="customer_balance_id"
                                 constraintName="fk_ar_customer_balance_templates"
                                 referencedTableName="ar_customer_balance"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="ar_customer_balance_templates" baseColumnNames="template_id"
                                 constraintName="fk_ar_templates_customer_balance"
                                 referencedTableName="ar_occ_template"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-13468_20230126" author="hichamELHALOUI">
        <addColumn tableName="billing_invoice_validation_rule">
            <column name="evaluation_mode" type="varchar(50)" defaultValue="VALIDATION">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-13045-20230202" author="ZBariki">
        <addColumn tableName="dunning_settings">
            <column name="customer_balance_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseTableName="dunning_settings" baseColumnNames="customer_balance_id"
                                 constraintName="fk_dunning_settings_customer_balance_id"
                                 referencedTableName="ar_customer_balance"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-13009_20230202" author="bourras">
        <addColumn tableName="finance_settings">
            <column name="enable_billing_redirection_rules" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    	 <changeSet id="#INTRD-13453_20230207" author="Mbarek-Ay">
		<addColumn tableName="cpq_contract_item">
			<column name="separate_discount" type="${type.boolean}" defaultValueNumeric="0"></column>
		</addColumn>
	</changeSet>

    <changeSet id="#INTRD-13220_20230203" author="AbdellatifBARI">
        <addColumn tableName="cpq_order_product">
            <column name="service_instance_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="service_instance_id" baseTableName="cpq_order_product"
                                 constraintName="fk_cpq_order_product_service_instance_id"
                                 referencedColumnNames="id"
                                 referencedTableName="billing_service_instance"/>
    </changeSet>

    <changeSet id="#INTRD-13883_20230208" author="hichamELHALOUI">
        <addColumn tableName="cat_discount_plan">
            <column name="allowance_code_id" type="bigint">
            </column>
		</addColumn>
    </changeSet>

    <changeSet id="#INTRD-12972" author="bourras">
        <dropNotNullConstraint tableName="cpq_contract" columnName="contract_date"/>
    </changeSet>
    
    <changeSet id="#INTRD-13957-20230214" author="houdad">
        <sql>
        DELETE FROM untdid_unit;
        DROP TABLE untdid_unit;
        </sql>
    </changeSet>

    <changeSet id="#INTRD-14022_20230215" author="AdilElJaouhari">
        <addColumn tableName="crm_customer">
            <column name="parent_customer_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="crm_customer" baseColumnNames="parent_customer_id"
                                 constraintName="fk_crm_customer_parent_customer_id"
                                 referencedTableName="crm_customer"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="HichamHANINE" id="#INTRD-13981_20230222">
    	<addColumn tableName="ar_matching_code">
            <column name="converted_matching_amount_credit" type="numeric(23, 12)" />
            <column name="converted_matching_amount_debit" type="numeric(23, 12)" />
        </addColumn>
        <addColumn tableName="ar_matching_amount">
            <column name="converted_matching_amount" type="numeric(23, 12)" />
        </addColumn>
        <addColumn tableName="ar_account_operation">
            <column name="converted_net_to_pay" type="numeric(23, 12)" />
            <column name="converted_amount" type="numeric(23, 12)" />
            <column name="converted_amount_without_tax" type="numeric(23, 12)" />
            <column name="converted_tax_amount" type="numeric(23, 12)" />
            <column name="converted_matching_amount" type="numeric(23, 12)" />
            <column name="converted_un_matching_amount" type="numeric(23, 12)" />
            <column name="transactional_currency" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="transactional_currency" baseTableName="ar_account_operation" constraintName="fk_account_operation_trading_currency"
        	deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_trading_currency" />
    </changeSet>

   	<changeSet author="HichamHANINE" id="#INTRD-14562_20230308" failOnError="false">
		<update tableName="ar_account_operation">
			<column name="converted_amount" valueComputed="amount"/>
			<column name="converted_amount_without_tax" valueComputed="amount_without_tax"/>
			<column name="converted_tax_amount" valueComputed="tax_amount"/>
			<column name="converted_matching_amount" valueComputed="matching_amount"/>
			<column name="converted_un_matching_amount" valueComputed="un_matching_amount"/>
			<column name="transactional_currency" valueComputed="(SELECT id FROM billing_trading_currency btc where currency_id = (SELECT currency_id from crm_provider where id = 1))"></column>
			<where>transactional_currency is null</where>
		</update>
	</changeSet>

    <changeSet id="#INTRD-13604_20230206" author="AdilElJaouhari">
    	<dropNotNullConstraint columnName="created" tableName="billing_invoice_validation_rule"/>
    	<dropNotNullConstraint columnName="fail_status" tableName="billing_invoice_validation_rule"/>
        <addColumn tableName="billing_invoice_validation_rule">
            <column name="operator" type="varchar(10)" defaultValue="OR" />
        </addColumn>
        <addColumn tableName="billing_invoice_validation_rule">
            <column name="parent_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="billing_invoice_validation_rule" baseColumnNames="parent_id"
                                 constraintName="fk_invoice_validation_rule_parent_id"
                                 referencedTableName="billing_invoice_validation_rule"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-14161_20230221" author="AdilElJaouhari">
        <renameColumn tableName="accounting_journal_entry" oldColumnName="trading_amount" newColumnName="converted_amount"/>
    </changeSet>

     <changeSet id="#INTRD-13867_20230220" author="aeljaouhari" failOnError="false">
        <sql>
	        update public.accounting_journal_entry set
		        trading_currency = (select ac.currency_code from adm_currency ac, billing_trading_currency btc, billing_invoice inv, ar_account_operation aco
		        	where ac.id = btc.currency_id and inv.trading_currency_id = btc.id and inv.id = aco.invoice_id and aco.id =  accounting_operation_id),
		        converted_amount = (select inv.amount_without_tax from billing_invoice inv, ar_account_operation aco
		        	where inv.id = aco.invoice_id and aco.id =  accounting_operation_id)
        </sql>
    </changeSet>

    <changeSet id="#INTRD-14264_20230222" author="TarikFA.">
    	<addColumn tableName="billing_rated_transaction">
    		<column name="origin_ratedtransaction_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseTableName="billing_rated_transaction" baseColumnNames="origin_ratedtransaction_id,status"
                                 constraintName="fk_origin_ratedtransaction_id"
                                 referencedTableName="billing_rated_transaction"
                                 referencedColumnNames="id,status"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>

    <changeSet id="#INTRD-14243_invoice_conversion" author="a.rouaguebe">
    	<addColumn tableName="billing_invoice">
    		<column name="use_specific_price_conversion" type="${type.boolean}" defaultValueNumeric="0" />
    	</addColumn>
    	<addColumn tableName="billing_invoice_agregate">
    		<column name="use_specific_price_conversion" type="${type.boolean}" defaultValueNumeric="0" />
    	</addColumn>
    </changeSet>

	<changeSet id="#INTRD-14332_20230226_contract_application_el" author="a.rouaguebe">
		<addColumn tableName="cpq_contract">
            <column name="application_el" type="varchar(2000)" />
		</addColumn>
	</changeSet>

    <changeSet author="ZBariki" id="#INTRD-14208_20230224" dbms="oracle">
        <dropProcedure procedureName="listagg_clob_t" />
        <createProcedure>
            create or replace type listagg_clob_t as object
            (
                t_varchar2 VARCHAR2 (32767),
                t_clob CLOB,
                STATIC FUNCTION odciaggregateinitialize (sctx IN OUT listagg_clob_t)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregateiterate (self    IN OUT listagg_clob_t,
                                                      a_val          VARCHAR2)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregateterminate (self          IN OUT listagg_clob_t,
                                                        returnvalue      OUT CLOB,
                                                        flags         IN     NUMBER)
                    RETURN NUMBER,
                MEMBER FUNCTION odciaggregatemerge (self   IN OUT listagg_clob_t,
                                                    ctx2   IN OUT listagg_clob_t)
                    RETURN NUMBER
            );
        </createProcedure>
        <createProcedure>
            CREATE OR REPLACE TYPE BODY OPENCELL."LISTAGG_CLOB_T"
            IS
                STATIC FUNCTION odciaggregateinitialize (sctx IN OUT listagg_clob_t)
                    RETURN NUMBER
                    IS
                BEGIN
                    sctx := listagg_clob_t (NULL, NULL);
                    RETURN odciconst.success;
                END;
                member function odciaggregateiterate
                ( self in out listagg_clob_t
                , a_val varchar2
                )
                    return number
                    is
                    procedure add_val( p_val varchar2 )
                        is
                    begin
                        if nvl( lengthb( self.t_varchar2 ), 0 ) + lengthb( p_val ) &lt;= 4000
                        THEN
                            IF self.t_varchar2 IS NULL
                            THEN
                                self.t_varchar2 := self.t_varchar2 || p_val;
                            ELSE
                                self.t_varchar2 := self.t_varchar2 || ',' || p_val;
                            END IF;
                        ELSE
                            IF self.t_clob IS NULL
                            THEN
                                DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);
                                DBMS_LOB.writeappend (self.t_clob,
                                                      LENGTH (self.t_varchar2),
                                                      self.t_varchar2);
                            ELSE
                                DBMS_LOB.writeappend (self.t_clob,
                                                      LENGTH (self.t_varchar2) + 1,
                                                      ',' || self.t_varchar2);
                            END IF;

                            self.t_varchar2 := p_val;
                        END IF;
                    END;
                BEGIN
                    add_val (a_val);
                    RETURN odciconst.success;
                END;

                MEMBER FUNCTION odciaggregateterminate (self          IN OUT listagg_clob_t,
                                                        returnvalue      OUT CLOB,
                                                        flags         IN     NUMBER)
                    RETURN NUMBER
                    IS
                BEGIN
                    IF self.t_clob IS NULL
                    THEN
                        DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);

                        IF self.t_varchar2 IS NOT NULL
                        THEN
                            DBMS_LOB.writeappend (self.t_clob,
                                                  LENGTH (self.t_varchar2) ,
                                                  self.t_varchar2);
                        END IF;
                    ELSE
                        IF self.t_varchar2 IS NOT NULL
                        THEN
                            DBMS_LOB.writeappend (self.t_clob,
                                                  LENGTH (self.t_varchar2) + 1,
                                                  ',' || self.t_varchar2);
                        END IF;
                    END IF;

                    returnvalue := self.t_clob;
                    RETURN odciconst.success;
                END;

                MEMBER FUNCTION odciaggregatemerge (self   IN OUT listagg_clob_t,
                                                    ctx2   IN OUT listagg_clob_t)
                    RETURN NUMBER
                    IS
                BEGIN
                    IF self.t_clob IS NULL
                    THEN
                        DBMS_LOB.createtemporary (self.t_clob, TRUE, DBMS_LOB.call);
                    END IF;

                    IF self.t_varchar2 IS NOT NULL
                    THEN
                        DBMS_LOB.writeappend (self.t_clob,
                                              LENGTH (self.t_varchar2),
                                              self.t_varchar2);
                    END IF;

                    IF ctx2.t_clob IS NOT NULL
                    THEN
                        DBMS_LOB.append (self.t_clob, ctx2.t_clob);
                        DBMS_LOB.freetemporary (ctx2.t_clob);
                    END IF;

                    IF ctx2.t_varchar2 IS NOT NULL
                    THEN
                        DBMS_LOB.writeappend (self.t_clob,
                                              LENGTH (ctx2.t_varchar2),
                                              ctx2.t_varchar2);
                        ctx2.t_varchar2 := NULL;
                    END IF;

                    RETURN odciconst.success;
                END;
            END;
        </createProcedure>
        <createProcedure>
            create or replace function listagg_clob( agg varchar2 )
                RETURN CLOB
                PARALLEL_ENABLE
                AGGREGATE USING listagg_clob_t;
        </createProcedure>
    </changeSet>
    
    <changeSet id="#INTRD-14522_20230301" author="TarikFA.">
    	<addColumn tableName="billing_subscription">
    		<column name="contract_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseTableName="billing_subscription" baseColumnNames="contract_id"
                                 constraintName="fk_contract_id"
                                 referencedTableName="cpq_contract"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />

    	<addColumn tableName="quote_offer">
    		<column name="contract_id" type="bigint" />
    	</addColumn>

        <addForeignKeyConstraint baseTableName="quote_offer" baseColumnNames="contract_id"
                                 constraintName="fk_contract_id"
                                 referencedTableName="cpq_contract"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
         <dropColumn tableName="quote_offer">
         	<column name="contract_code" />
         </dropColumn>
    </changeSet>

    <changeSet id="#INTRD-13326_20230227" author="zelmeliani">
        <addColumn tableName="billing_wallet_operation">
            <column name="use_specific_price_conversion" type="${type.boolean}" defaultValueNumeric="0">
			    <constraints nullable="false" />
			</column>
			<column name="converted_amount_without_tax" type="numeric(23, 12)" />
			<column name="converted_amount_with_tax" type="numeric(23, 12)" />
			<column name="converted_amount_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_without_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_with_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_tax" type="numeric(23, 12)" />
			<column name="trading_currency_id" type="bigint" />
        </addColumn>

        <addColumn tableName="billing_rated_transaction">
            <column name="use_specific_price_conversion" type="${type.boolean}" defaultValueNumeric="0">
			    <constraints nullable="false" />
			</column>
			<column name="converted_amount_without_tax" type="numeric(23, 12)" />
			<column name="converted_amount_with_tax" type="numeric(23, 12)" />
			<column name="converted_amount_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_without_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_with_tax" type="numeric(23, 12)" />
			<column name="converted_unit_amount_tax" type="numeric(23, 12)" />
			<column name="trading_currency_id" type="bigint" />
        </addColumn>

        <addForeignKeyConstraint
            constraintName="fk_trading_currency_id_billing_wallet_operation"
			referencedTableName="billing_trading_currency"
			referencedColumnNames="id"
			baseColumnNames="trading_currency_id"
			baseTableName="billing_wallet_operation" />
        <addForeignKeyConstraint
            constraintName="fk_trading_currency_id_billing_rated_transaction"
			referencedTableName="billing_trading_currency"
			referencedColumnNames="id"
			baseColumnNames="trading_currency_id"
			baseTableName="billing_rated_transaction" />
    </changeSet>

    <changeSet id="#INTRD-14336_20230227" author="ZBariki">
        <addColumn tableName="cpq_contract_item">
            <column name="application_el" type="varchar(2000)" />
        </addColumn>
        <addColumn tableName="billing_wallet_operation">
            <column name="contract_line_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseTableName="billing_wallet_operation" baseColumnNames="contract_line_id"
                                 constraintName="fk_wo_contract_line_id" referencedTableName="cpq_contract_item"
                                 referencedColumnNames="id" deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>

    <changeSet id="#INTRD-14598_20230303" author="zelmeliani">
        <addColumn tableName="finance_settings">
            <column name="discount_advanced_mode" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

  	<changeSet id="#INTRD-14402_20230301" author="AdilElJaouhari">
		<addColumn tableName="billing_invoice_line">
			<column name="conversion_from_billing_currency" type="${type.boolean}" defaultValueNumeric="0" />
		</addColumn>
		<addColumn tableName="billing_invoice">
			<column name="conversion_from_billing_currency" type="${type.boolean}" defaultValueNumeric="0" />
		</addColumn>
		<addColumn tableName="billing_invoice_agregate">
			<column name="conversion_from_billing_currency" type="${type.boolean}" defaultValueNumeric="0" />
		</addColumn>
	</changeSet>

<!--
    <changeSet id="#INTRD-14263_20200304" author="TarikFA.">
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_origin_ratedtransaction_id" />
    </changeSet>
 -->

    <changeSet id="#INTRD-14381-202303202" author="bourras" failOnError="false">
        <addColumn tableName="billing_invoice_configuration">
            <column name="display_rated_items" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-14555_20230303" author="AdilElJaouhari">
        <addColumn tableName="crm_customer_category">
            <column name="default_seller_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseTableName="crm_customer_category" baseColumnNames="default_seller_id"
                                 constraintName="fk_crm_customer_category_default_seller_id"
                                 referencedTableName="crm_seller"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="#INTRD-14632_20230306" author="AdilElJaouhari">
    	<addColumn tableName="cpq_order_offer">
    		<column name="contract_id" type="bigint" />
    	</addColumn>
        <addForeignKeyConstraint baseTableName="cpq_order_offer" baseColumnNames="contract_id"
                                 constraintName="fk_cpq_order_offer_contract_id"
                                 referencedTableName="cpq_contract"
                                 referencedColumnNames="id"
                                 deferrable="false" initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" />
    </changeSet>

    <changeSet id="#INTR-14747_20230308" author="TarikFA.">
    	<update tableName="cat_discount_plan">
    		<column name="applicable_on_overridden_price" value="1"/>
    		<where>applicable_on_overridden_price is null</where>
    	</update>
    	<update tableName="cat_discount_plan">
    		<column name="applicable_on_discounted_price" value="1"/>
    		<where>applicable_on_discounted_price is null</where>
    	</update>
    </changeSet>

  	<changeSet id="#INTRD-15043_20230317" author="AdilElJaouhari">
		<renameColumn tableName="billing_invoice" oldColumnName="converted_amount_without_tax" newColumnName="transactional_amount_without_tax"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_amount_with_tax" newColumnName="transactional_amount_with_tax"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_amount_tax" newColumnName="transactional_amount_tax"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_net_to_pay" newColumnName="transactional_net_to_pay"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_raw_amount" newColumnName="transactional_raw_amount"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_discount_amount" newColumnName="transactional_discount_amount"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_amount_without_tax_before_discount" newColumnName="transactional_amount_without_tax_before_discount"/>
		<renameColumn tableName="billing_invoice" oldColumnName="converted_invoice_balance" newColumnName="transactional_invoice_balance"/>

		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_unit_price" newColumnName="transactional_unit_price"/>
		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_amount_without_tax" newColumnName="transactional_amount_without_tax"/>
		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_amount_with_tax" newColumnName="transactional_amount_with_tax"/>
		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_amount_tax" newColumnName="transactional_amount_tax"/>
		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_discount_amount" newColumnName="transactional_discount_amount"/>
		<renameColumn tableName="billing_invoice_line" oldColumnName="converted_raw_amount" newColumnName="transactional_raw_amount"/>

		<renameColumn tableName="billing_invoice_agregate" oldColumnName="converted_amount_without_tax" newColumnName="transactional_amount_without_tax"/>
		<renameColumn tableName="billing_invoice_agregate" oldColumnName="converted_amount_with_tax" newColumnName="transactional_amount_with_tax"/>
		<renameColumn tableName="billing_invoice_agregate" oldColumnName="converted_amount_tax" newColumnName="transactional_amount_tax"/>
    </changeSet>

    <changeSet id="#INTRD-14811_20200310" author="TarikFA.">
        <preConditions onFail="MARK_RAN" >
            <and>
                <foreignKeyConstraintExists foreignKeyName="fk_origin_ratedtransaction_id" foreignKeyTableName="billing_rated_transaction" />
            </and>
        </preConditions>
        <comment>Foreign key exist !!</comment>
        <dropForeignKeyConstraint baseTableName="billing_rated_transaction" constraintName="fk_origin_ratedtransaction_id" />
    </changeSet>

	<changeSet id="#INTRD-15114_20230323" author="AdilElJaouhari">
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_net_to_pay" newColumnName="transactional_net_to_pay"/>
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_amount" newColumnName="transactional_amount"/>
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_amount_without_tax" newColumnName="transactional_amount_without_tax"/>
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_tax_amount" newColumnName="transactional_tax_amount"/>
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_matching_amount" newColumnName="transactional_matching_amount"/>
		<renameColumn tableName="ar_account_operation" oldColumnName="converted_un_matching_amount" newColumnName="transactional_un_matching_amount"/>

		<renameColumn tableName="billing_linked_invoices" oldColumnName="converted_amount" newColumnName="transactional_amount"/>

		<renameColumn tableName="ar_matching_amount" oldColumnName="converted_matching_amount" newColumnName="transactional_matching_amount"/>

		<renameColumn tableName="ar_matching_code" oldColumnName="converted_matching_amount_credit" newColumnName="transactional_matching_amount_credit"/>
		<renameColumn tableName="ar_matching_code" oldColumnName="converted_matching_amount_debit" newColumnName="transactional_matching_amount_debit"/>

        <renameColumn tableName="accounting_journal_entry" oldColumnName="converted_amount" newColumnName="transactional_amount"/>

        <addColumn tableName="ar_account_operation">
            <column name="transactional_payment_fees" type="numeric(23, 12)"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-14597_20230324" author="TarikFA.">
        <addColumn tableName="billing_rated_transaction">
            <column name="pending_duplicates" type="int4" defaultValueNumeric="0"/>
            <column name="pending_duplicates_to_negate" type="int4" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-14663_20230327" author="HatimO.">
        <addColumn tableName="document">
            <column name="document_version" type="int4" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-14743_20230313" author="TarikFA.">
        <createIndex tableName="rating_edr" indexName="rating_edr_eventKey_index_idx">
            <column name="event_key"/>
        </createIndex>
    </changeSet>
    
    <changeSet id="#INTRD-14743_20230315" author="TarikFA.">
        <sql>CREATE INDEX rt_customer_id_contract_index ON ${db.schema.adapted}cpq_contract (customer_id) where status='ACTIVE'</sql>
        <sql>CREATE INDEX rt_billing_account_id_contract_index ON ${db.schema.adapted}cpq_contract (billing_account_id) where status='ACTIVE'</sql>
        <sql>CREATE INDEX rt_customer_account_contract_index ON ${db.schema.adapted}cpq_contract (customer_account_id) where status='ACTIVE'</sql>
    </changeSet>
    
    <changeSet id="#INTRD-14743_20230316" author="TarikFA.">
        <sql>CREATE INDEX cpq_price_plan_matrix_value__ppml_id__idx ON cpq_price_plan_matrix_value(ppml_id)</sql>
        <sql>CREATE INDEX cpq_price_plan_matrix_line__ppm_version_id__idx ON cpq_price_plan_matrix_line(ppm_version_id)</sql>
    </changeSet>
    
    <changeSet id="#INTRD-14966_20230329" author="HatimO.">
        <addUniqueConstraint columnNames="code, document_version" constraintName="document_code_version_key" tableName="document" />
    </changeSet>

    <changeSet id="#5882_20220325" author="MohammedELAZZOUZI">
     	<addColumn tableName="billing_invoice_line">
            <column name="user_account_id" type="bigint"></column>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="user_account_id" baseTableName="billing_invoice_line" constraintName="fk_InvoiceLine_userAccount" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="billing_user_account" />
   	</changeSet> 

    <changeSet id="#INTRD-14743_20230331" author="AndriusKarpavicius">
        <alterSequence sequenceName="rating_cdr_seq" incrementBy="5000"/>
        <alterSequence sequenceName="rating_edr_seq" incrementBy="5000"/>
        <alterSequence sequenceName="billing_wallet_operation_seq" incrementBy="5000"/>
        <alterSequence sequenceName="billing_rated_transaction_seq" incrementBy="5000"/>
    </changeSet>

    <changeSet id="#INTRD-15146_20230406" author="ZBariki">
        <dropForeignKeyConstraint baseTableName="billing_accounting_article"
                                  constraintName="billing_accounting_article_open_order_id_fk"/>
        <dropColumn tableName="billing_accounting_article" columnName="open_order_id" />
    </changeSet>

    <changeSet id="#INTRD-15691_20230421" author="AbdellatifBARI">
        <addColumn tableName="billing_rated_transaction">
            <column name="discounted_amount" type="numeric(23,12)" />
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-4064_20211218" author="AndriusKarpavicius">
        <addColumn tableName="meveo_job_instance">
            <column name="cluster_behavior" type="varchar(25)" defaultValue="LIMIT_TO_SINGLE_NODE"/>
        </addColumn>
        <sql>update ${db.schema.adapted}meveo_job_instance set cluster_behavior = 'RUN_IN_PARALLEL' where single_node=0</sql>
        <dropColumn tableName="meveo_job_instance">
            <column name="single_node" />
        </dropColumn>
        <addColumn tableName="job_execution">
            <column name="parent_job_result_id" type="bigint" />
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-15233_20230425" author="AndriusKarpavicius">
        <sql>CREATE INDEX cpq_contract_item_code_index ON ${db.schema.adapted}cpq_contract_item(lower(code));</sql>
        <sql>CREATE INDEX cpq_contract_item_contract_index ON ${db.schema.adapted}cpq_contract_item(cpq_contract_id);</sql>
    </changeSet>
    
    <changeSet id="#INTRD-15729_20230425" author="AndriusKarpavicius">
        <dropIndex tableName="rating_cdr" indexName="rating_cdr_index"/>
        <sql>CREATE INDEX rating_cdr_ob_index ON ${db.schema.adapted}rating_cdr(origin_batch)</sql>
        <sql>CREATE INDEX rating_cdr_or_index ON ${db.schema.adapted}rating_cdr(origin_record)</sql>
        <dropIndex tableName="rating_edr" indexName="rating_edr_index"/>
        <sql>CREATE INDEX rating_edr_index ON ${db.schema.adapted}rating_edr(origin_record)</sql>
    </changeSet>
    
    <changeSet id="#INTRD-15733_20230425" author="AndriusKarpavicius">
        <sql>CREATE INDEX rating_edr_wo_index ON ${db.schema.adapted}rating_edr(wallet_operation_id)</sql>
    </changeSet>

	<changeSet author="aelmalki" id="#INTRD-15664-20230501">
        <createSequence sequenceName="ar_unmatching_code_seq"/>
        <createSequence sequenceName="ar_unmatching_amount_seq"/>

        <createTable tableName="ar_unmatching_code">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_unmatching_code_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="unmatching_amount_credit" type="numeric(23, 12)" />
            <column name="unmatching_amount_debit" type="numeric(23, 12)" />
			<column name="transactional_unmatching_amount_credit" type="numeric(23, 12)" />
            <column name="transactional_unmatching_amount_debit" type="numeric(23, 12)" />
            <column name="unmatching_date" type="date" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
        </createTable>

		<createTable tableName="ar_unmatching_amount">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="ar_unmatching_amount_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="unmatching_amount" type="numeric(23, 12)" />
            <column name="transactional_unmatching_amount" type="numeric(23, 12)" />

            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="account_operation_id" type="bigint" />
            <column name="unmatching_code_id" type="bigint" />
        </createTable>


		<addForeignKeyConstraint baseColumnNames="account_operation_id" baseTableName="ar_unmatching_amount" constraintName="fk_eurt0sf36q7w68zx58bn" deferrable="false" initiallyDeferred="false"
            onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_account_operation" />

		<addForeignKeyConstraint baseColumnNames="unmatching_code_id" baseTableName="ar_unmatching_amount" constraintName="fk_qwvfl1elw6vgzi7vp5dc" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            onUpdate="NO ACTION" referencedColumnNames="id" referencedTableName="ar_unmatching_code" />

    </changeSet>

  	<changeSet id="#INTRD-15841_20230502" author="AdilElJaouhari">
        <addColumn tableName="billing_invoice_type">
            <column name="description_i18n" type="${type.json}"></column>
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-13646_20230131" author="AdilElJaouhari">
        <dropNotNullConstraint tableName="billing_tax" columnName="taxation_category_id"/>
    </changeSet>

    <changeSet id="#INTRD-15881_20230504" author="zelmeliani">
        <addColumn tableName="finance_settings">
            <column name="enable_price_list" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

  	<changeSet id="#INTRD-15899_20230505" author="aelmalki">
        <addColumn tableName="billing_billing_account">
            <column name="exemption_reason" type="varchar(2000)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-15899_20230505-taxation-FK" author="aelmalki">
     	<addColumn tableName="billing_tax_category">
            <column name="untdid_taxation_category_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="untdid_taxation_category_id" baseTableName="billing_tax_category" constraintName="fk_untdid_taxation_category"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			referencedColumnNames="id" referencedTableName="untdid_5305_taxation_category" />
   	</changeSet>



    <changeSet id="#INTRD-15849_20230509" author="TarikFA.">
    		<createTable tableName="billing_seller_media">
    			<column name="seller_id" type="bigint" />
    			<column name="media_id" type="bigint" />
    		</createTable>
       	 <addUniqueConstraint columnNames="seller_id, media_id" constraintName="seller_id_media_id_unique_key" tableName="billing_seller_media" />
        <addForeignKeyConstraint baseColumnNames="seller_id"
        						 baseTableName="billing_seller_media"
        						 constraintName="fk_media_seller_id"
        						 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            					 onUpdate="NO ACTION" referencedColumnNames="id"
            					 referencedTableName="crm_seller" />
        <addForeignKeyConstraint baseColumnNames="media_id"
        						 baseTableName="billing_seller_media"
        						 constraintName="fk_seller_media_id"
        						 deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
            					 onUpdate="NO ACTION" referencedColumnNames="id"
            					 referencedTableName="cpq_media" />
    </changeSet>


    <changeSet id="#INTRD-16031_20230508" author="zelmeliani">
        <createSequence sequenceName="price_list_seq" startValue="1" />

        <createTable tableName="price_list">
	    	<column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="price_list_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(300)" />
            <column name="cf_values" type="${type.json}" />
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}" />
            <column name="valid_from" type="datetime" />
            <column name="valid_until" type="datetime" />
            <column name="application_start_date" type="datetime" />
            <column name="application_end_date" type="datetime" />
            <column name="status" type="varchar(50)" />
        </createTable>
    </changeSet>

	<changeSet id="#INTRD-15823_20230510" author="AdilElJaouhari">
		<createSequence sequenceName="cat_trading_discount_plan_item_seq" startValue="1" />
		<createTable tableName="cat_trading_discount_plan_item">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"	primaryKeyName="cat_trading_discount_plan_item_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="discount_plan_item_id" type="bigint" />
			<column name="transactional_discount_value" type="numeric(23, 12)" />
			<column name="trading_currency_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="rate" type="numeric(23, 12)" />
		</createTable>
		<addForeignKeyConstraint
			baseColumnNames="discount_plan_item_id"
			baseTableName="cat_trading_discount_plan_item"
			constraintName="cat_trading_discount_plan_item_fk" deferrable="false"
			initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id"
			referencedTableName="cat_discount_plan_item" />
		<addForeignKeyConstraint
			baseColumnNames="trading_currency_id"
			baseTableName="cat_trading_discount_plan_item"
			constraintName="cat_trading_discount_plan_trading_currency_fk"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="billing_trading_currency" />
	</changeSet>

    <changeSet id="#INTRD-16039_20230512" author="a.rouaguebe">

        <renameSequence oldSequenceName="price_list_seq" newSequenceName="cat_price_list_seq" />
        <renameTable oldTableName="price_list" newTableName="cat_price_list" />

        <createSequence sequenceName="cat_price_list_line_seq" startValue="1" />
        <createTable tableName="cat_price_list_line">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="cat_price_list_line_pk" />
            </column>
            <column name="uuid" type="varchar(60)" defaultValueComputed="${uuid_function}"/>
            <column name="version" type="int4" />
            <column name="disabled" type="${type.boolean}" defaultValueNumeric="0">
                <constraints nullable="false" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="code" type="varchar(50)">
                <constraints nullable="false" />
            </column>
            <column name="description" type="varchar(300)" />
            <column name="cf_values" type="${type.json}" />
            <column name="price_list_id" type="bigint" />
            <column name="offer_category_id" type="bigint" />
            <column name="offer_template_id" type="bigint" />
            <column name="product_id" type="bigint" />
            <column name="charge_template_id" type="bigint" />
            <column name="price_plan_id" type="bigint" />
            <column name="price_list_type" type="varchar(25)" />
            <column name="application_el" type="varchar(255)" />
            <column name="rate" type="numeric(23, 12)" />
        </createTable>
        <addForeignKeyConstraint
                constraintName="fk_pli_line_offer_category"
                referencedTableName="cat_offer_template_category"
                referencedColumnNames="id"
                baseColumnNames="offer_category_id"
                baseTableName="cat_price_list_line" />
        <addForeignKeyConstraint
                constraintName="fk_pli_line_offer_template"
                referencedTableName="cat_offer_template"
                referencedColumnNames="id"
                baseColumnNames="offer_template_id"
                baseTableName="cat_price_list_line" />
        <addForeignKeyConstraint
                constraintName="fk_pli_line_cpq_product"
                referencedTableName="cpq_product"
                referencedColumnNames="id"
                baseColumnNames="product_id"
                baseTableName="cat_price_list_line" />
        <addForeignKeyConstraint
                constraintName="fk_pli_line_charge_template"
                referencedTableName="cat_charge_template"
                referencedColumnNames="id"
                baseColumnNames="charge_template_id"
                baseTableName="cat_price_list_line" />
        <addForeignKeyConstraint
                constraintName="fk_pli_line_price_plan"
                referencedTableName="cat_price_plan_matrix"
                referencedColumnNames="id"
                baseColumnNames="price_plan_id"
                baseTableName="cat_price_list_line" />
        <addForeignKeyConstraint
                constraintName="fk_pli_line_price_list"
                referencedTableName="cat_price_list"
                referencedColumnNames="id"
                baseColumnNames="price_list_id"
                baseTableName="cat_price_list_line" />
    </changeSet>

	<changeSet id="#INTRD-15823_20230510_rename" author="AdilElJaouhari">
		<renameColumn tableName="cat_trading_discount_plan_item" oldColumnName="transactional_discount_value" newColumnName="trading_discount_value"/>
	</changeSet>

	<changeSet id="#INTRD-16219_20230511" author="aelmalki">
        <addColumn tableName="ar_account_operation">
            <column name="error_detail" type="varchar(2000)" />
        </addColumn>
    </changeSet>

	<changeSet id="#INTRD-16166_20230512" author="aelmalki">
        <addColumn tableName="ar_payment_token">
            <column name="mandate_change_action" type="varchar(20)" defaultValue="NONE">
                <constraints nullable="false" />
			</column>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-16040_20230516" author="a.rouaguebe">
        <addColumn tableName="cat_price_list_line">
            <column name="amount" type="numeric(23, 12)" />
            <column name="product_line_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                constraintName="fk_pli_line_product_line"
                referencedTableName="cpq_product_line"
                referencedColumnNames="id"
                baseColumnNames="product_line_id"
                baseTableName="cat_price_list_line" />
    </changeSet>
    <changeSet id="#INTRD-16036_20230516" author="zelmeliani" >
        <createTable tableName="cat_price_list_customer_brand">
            <column name="price_list_id" type="bigint" />
            <column name="customer_brand_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, customer_brand_id" constraintName="cat_price_list_customer_brand_pkey" tableName="cat_price_list_customer_brand" />

        <createTable tableName="cat_price_list_customer_category">
            <column name="price_list_id" type="bigint" />
            <column name="customer_category_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, customer_category_id" constraintName="cat_price_list_customer_category_pkey" tableName="cat_price_list_customer_category" />

        <createTable tableName="cat_price_list_credit_category">
            <column name="price_list_id" type="bigint" />
            <column name="credit_category_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, credit_category_id" constraintName="cat_price_list_credit_category_pkey" tableName="cat_price_list_credit_category" />

        <createTable tableName="cat_price_list_country">
            <column name="price_list_id" type="bigint" />
            <column name="country_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, country_id" constraintName="cat_price_list_country_pkey" tableName="cat_price_list_country" />

        <createTable tableName="cat_price_list_currency">
            <column name="price_list_id" type="bigint" />
            <column name="currency_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, currency_id" constraintName="cat_price_list_currency_pkey" tableName="cat_price_list_currency" />

        <createTable tableName="cat_price_list_legal_entity">
            <column name="price_list_id" type="bigint" />
            <column name="legal_entity_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, legal_entity_id" constraintName="cat_price_list_legal_entity_pkey" tableName="cat_price_list_legal_entity" />

        <createTable tableName="cat_price_list_payment_method">
            <column name="price_list_id" type="bigint" />
            <column name="payment_method_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, payment_method_id" constraintName="cat_price_list_payment_method_pkey" tableName="cat_price_list_payment_method" />

        <createTable tableName="cat_price_list_seller">
            <column name="price_list_id" type="bigint" />
            <column name="seller_id" type="bigint" />
        </createTable>
        <addPrimaryKey columnNames="price_list_id, seller_id" constraintName="cat_price_list_seller_pkey" tableName="cat_price_list_seller" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_customer_brand"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_customer_brand_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_customer_brand"
			baseColumnNames="customer_brand_id"
			constraintName="cat_price_list_customer_brand_cb_fk"
			referencedTableName="crm_customer_brand"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_customer_category"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_customer_category_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_customer_category"
			baseColumnNames="customer_category_id"
			constraintName="cat_price_list_customer_category_cc_fk"
			referencedTableName="crm_customer_category"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_credit_category"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_credit_category_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_credit_category"
			baseColumnNames="credit_category_id"
			constraintName="cat_price_list_credit_category_cc_fk"
			referencedTableName="ar_credit_category"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_country"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_country_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_country"
			baseColumnNames="country_id"
			constraintName="cat_price_list_country_c_fk"
			referencedTableName="adm_country"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_currency"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_currency_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_currency"
			baseColumnNames="currency_id"
			constraintName="cat_price_list_currency_c_fk"
			referencedTableName="adm_currency"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_legal_entity"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_legal_entity_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_legal_entity"
			baseColumnNames="legal_entity_id"
			constraintName="cat_price_list_legal_entity_le_fk"
			referencedTableName="adm_title"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_payment_method"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_payment_method_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_payment_method"
			baseColumnNames="payment_method_id"
			constraintName="cat_price_list_payment_method_pm_fk"
			referencedTableName="ar_payment_token"
            referencedColumnNames="id" />

        <addForeignKeyConstraint
			baseTableName="cat_price_list_seller"
			baseColumnNames="price_list_id"
			constraintName="cat_price_list_seller_pli_fk"
			referencedTableName="cat_price_list"
            referencedColumnNames="id" />
		<addForeignKeyConstraint
			baseTableName="cat_price_list_seller"
			baseColumnNames="seller_id"
			constraintName="cat_price_list_seller_s_fk"
			referencedTableName="crm_seller"
            referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-16256_20230515" author="ZBariki">
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_amount_without_tax"
                      newColumnName="transactional_amount_without_tax"/>
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_amount_with_tax"
                      newColumnName="transactional_amount_with_tax"/>
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_amount_tax"
                      newColumnName="transactional_amount_tax"/>
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_unit_amount_without_tax"
                      newColumnName="transactional_unit_amount_without_tax"/>
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_unit_amount_with_tax"
                      newColumnName="transactional_unit_amount_with_tax"/>
        <renameColumn tableName="billing_wallet_operation" oldColumnName="converted_unit_amount_tax"
                      newColumnName="transactional_unit_amount_tax"/>

        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_amount_without_tax"
                      newColumnName="transactional_amount_without_tax"/>
        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_amount_with_tax"
                      newColumnName="transactional_amount_with_tax"/>
        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_amount_tax"
                      newColumnName="transactional_amount_tax"/>
        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_unit_amount_without_tax"
                      newColumnName="transactional_unit_amount_without_tax"/>
        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_unit_amount_with_tax"
                      newColumnName="transactional_unit_amount_with_tax"/>
        <renameColumn tableName="billing_rated_transaction" oldColumnName="converted_unit_amount_tax"
                      newColumnName="transactional_unit_amount_tax"/>
    </changeSet>

    <changeSet id="#INTRD-16203_20230519_ba_pricelist" author="a.rouaguebe">
        <addColumn tableName="billing_billing_account">
            <column name="price_list_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                baseTableName="billing_billing_account"
                baseColumnNames="price_list_id"
                constraintName="fk_ba_price_list"
                referencedTableName="cat_price_list"
                referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-16374_20230519" author="zelmeliani">
        <dropPrimaryKey constraintName="cat_price_list_payment_method_pkey" tableName="cat_price_list_payment_method" />
        <dropForeignKeyConstraint baseTableName="cat_price_list_payment_method" constraintName="cat_price_list_payment_method_pm_fk" />
        <renameColumn tableName="cat_price_list_payment_method" oldColumnName="payment_method_id" newColumnName="payment_method"/>
        <modifyDataType tableName="cat_price_list_payment_method" columnName="payment_method" newDataType="varchar(50)"/>
    </changeSet>

    <changeSet id="#INTRD-15044_20230517" author="AdilElJaouhari">
    	<renameTable newTableName="cpq_trading_price_plan_version" oldTableName="cpq_converted_price_plan_version"/>
    	<renameColumn tableName="cpq_trading_price_plan_version" oldColumnName="converted_price" newColumnName="trading_price"/>
    	<renameSequence newSequenceName="cpq_trading_price_plan_version_seq" oldSequenceName="cpq_converted_price_plan_version_seq" />
    	<renameTable newTableName="cpq_trading_price_plan_matrix_line" oldTableName="cpq_converted_price_plan_matrix_line"/>
    	<renameColumn tableName="cpq_trading_price_plan_matrix_line" oldColumnName="converted_value" newColumnName="trading_value"/>
    	<renameSequence newSequenceName="cpq_trading_price_plan_matrix_line_sq" oldSequenceName="cpq_converted_price_plan_matrix_line_sq" />
	</changeSet>



    <changeSet id="#INTRD-16396_20230522_pli_quote" author="a.rouaguebe">
        <addColumn tableName="cpq_quote_version">
            <column name="price_list_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                baseTableName="cpq_quote_version"
                baseColumnNames="price_list_id"
                constraintName="fk_cpq_quote_version_price_list"
                referencedTableName="cat_price_list"
                referencedColumnNames="id" />
        <addColumn tableName="cpq_commercial_order">
            <column name="price_list_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                baseTableName="cpq_commercial_order"
                baseColumnNames="price_list_id"
                constraintName="fk_cpq_commercial_order_price_list"
                referencedTableName="cat_price_list"
                referencedColumnNames="id" />
        <addColumn tableName="billing_subscription">
            <column name="price_list_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                baseTableName="billing_subscription"
                baseColumnNames="price_list_id"
                constraintName="fk_billing_subscription_price_list"
                referencedTableName="cat_price_list"
                referencedColumnNames="id" />
    </changeSet>

    <changeSet id="#INTRD-16366_20230529" author="zelmeliani">
        <addColumn tableName="billing_wallet_operation">
            <column name="price_list_line_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                constraintName="fk_billing_wallet_operation_pli_line"
                referencedTableName="cat_price_list_line"
                referencedColumnNames="id"
                baseColumnNames="price_list_line_id"
                baseTableName="billing_wallet_operation" />
    </changeSet>

    <changeSet id="#INTRD-16713_20230606" author="TarikFA.">
        <addColumn tableName="billing_invoice">
            <column name="auto_matching" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>


    <changeSet id="#INTRD-15733_20230426" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_dpi_si_index ON ${db.schema.adapted}billing_discount_plan_instance(service_instance_id)</sql>
        <sql>CREATE INDEX billing_redirection_rule_contract_index  ON ${db.schema.adapted}billing_redirection_rule(contract_id)</sql>
        <dropUniqueConstraint tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
        <addUniqueConstraint columnNames="ppm_version_id,code" tableName="cpq_price_plan_matrix_column" constraintName="unique_code_ppm_version_id_pk"/>
        <dropUniqueConstraint tableName="cpq_price_plan_version" constraintName="cpq_price_plan_version_UNIC"/>
        <addUniqueConstraint columnNames="ppm_id,current_version" constraintName="cpq_price_plan_version_UNIC" tableName="cpq_price_plan_version" />
    </changeSet>

    <changeSet id="#INTRD-15938_20230503" author="AndriusKarpavcius">
        <addColumn tableName="cpq_price_plan_matrix_line">
            <column name="accuracy" type="int" defaultValueNumeric="0">
                 <constraints nullable="false" />
            </column>
        </addColumn>
        <sql>delete from ${db.schema.adapted}cpq_price_plan_matrix_value where long_value is null and double_value is null and string_value is null and date_value is null and from_date_value is null and to_date_value is null and from_double_value is null and to_double_value is null and boolean_value is null</sql>
        <sql>update ${db.schema.adapted}cpq_price_plan_matrix_line set accuracy = (select count(*) from ${db.schema.adapted}cpq_price_plan_matrix_value where ppml_id=cpq_price_plan_matrix_line.id)</sql>
    </changeSet>

    <changeSet id="#INTRD-16140_20230510" author="AndriusKarpavicius">
        <sql>CREATE INDEX billing_wo_disc_wo_index ON ${db.schema.adapted}billing_wallet_operation(discounted_wallet_operation_id)</sql>
    </changeSet>

 	<changeSet id="#INTRD-15938_20230511" author="AndriusKarpavicius" failOnError="false">
        <dropIndex tableName="cat_price_plan_matrix" indexName="cat_price_plan_event_c_index"/>
        <dropIndex tableName="cpq_price_plan_matrix_line" indexName="cpq_price_plan_matrix_line__ppm_version_id__idx"/>
    </changeSet>

    <changeSet id="#INTRD-15938_20230511-2" author="AndriusKarpavicius" failOnError="false">
        <sql>CREATE INDEX cat_price_plan_event_c_index ON ${db.schema.adapted}cat_price_plan_matrix(event_code, priority, id)</sql>
        <sql>CREATE INDEX cpq_ppl_ppVersion_index ON ${db.schema.adapted}cpq_price_plan_matrix_line(ppm_version_id, priority, accuracy)</sql>
    </changeSet>

    <changeSet id="#INTRD-16361_20230606" author="a.rouaguebe">
        <createTable tableName="cat_price_plan_charge">
            <column name="price_plan_id" type="bigint" />
            <column name="charge_id" type="bigint" />
        </createTable>
    </changeSet>

    <changeSet id="INTRD-15501_20230413" author="ThangNguyen">
        <addColumn tableName="billing_billing_run">
            <column name="incremental_invoice_lines" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>

    <changeSet id="INTRD-16050_20230515" author="ThangNguyen">
        <addColumn tableName="billing_cycle">
            <column name="incremental_invoice_lines" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-17353_S_14-07-2023" author="Mohammed_ELAZZOUZI">
        <addColumn tableName="billing_billing_account">
            <column name="mass_data" type="${type.boolean}" defaultValueNumeric="0"/>
        </addColumn>
    </changeSet>

    <changeSet id="#INTRD-16362_20230607_ppm_eventcode" author="a.rouaguebe">
        <dropNotNullConstraint tableName="cat_price_plan_matrix" columnName="event_code"></dropNotNullConstraint>
    </changeSet>

    <changeSet id="#INTRD-16600_20230531" author="AdilElJaouhari">
		<createSequence sequenceName="cpq_trading_contract_item_seq" startValue="1" />
		<createTable tableName="cpq_trading_contract_item">
			<column name="id" type="bigint" autoIncrement="${id.auto}">
				<constraints nullable="false" primaryKey="true"	primaryKeyName="cpq_trading_contract_item_pkey" />
			</column>
			<column name="version" type="int4" />
			<column name="creator" type="varchar(100)" />
			<column name="updater" type="varchar(100)" />
			<column name="created" type="datetime">
				<constraints nullable="false" />
			</column>
			<column name="updated" type="datetime" />
			<column name="contract_item_id" type="bigint" />
			<column name="trading_value" type="numeric(23, 12)" />
			<column name="trading_currency_id" type="bigint">
				<constraints nullable="false" />
			</column>
			<column name="rate" type="numeric(23, 12)" />
		</createTable>
		<addForeignKeyConstraint
			baseColumnNames="contract_item_id"
			baseTableName="cpq_trading_contract_item"
			constraintName="cpq_trading_contract_item_contract_item_fk" deferrable="false"
			initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION"
			referencedColumnNames="id"
			referencedTableName="cpq_contract_item" />
		<addForeignKeyConstraint
			baseColumnNames="trading_currency_id"
			baseTableName="cpq_trading_contract_item"
			constraintName="cpq_trading_contract_item_trading_currency_fk"
			deferrable="false" initiallyDeferred="false" onDelete="NO ACTION"
			onUpdate="NO ACTION" referencedColumnNames="id"
			referencedTableName="billing_trading_currency" />
	</changeSet>


    <changeSet id="INTRD-16780_20230614_pg" author="a.rouaguebe" dbms="postgres">
        <dropView viewName="billing_wallet_operation_period" />
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (DATE(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id )) = DATE(o.start_date)) then 0 else 1 end) as flag
                  FROM ${db.schema.adapted}billing_wallet_operation o WHERE o.status='OPEN' ) o
        </createView>
    </changeSet>
    <changeSet id="INTRD-16780_20230614_oracle" author="a.rouaguebe" dbms="oracle">
        <dropView viewName="billing_wallet_operation_period" />
        <createView viewName="billing_wallet_operation_period">
            select o.*, SUM(o.flag) over (partition by o.seller_id order by o.charge_instance_id ) as period
            from (select o.*, (case when (trunc(lag(o.end_Date) over (partition by o.seller_id order by o.charge_instance_id)) = trunc(o.start_date)) then 0 else 1 end) as flag
                  FROM billing_wallet_operation o WHERE o.status = 'OPEN') o
        </createView>
    </changeSet>

    <changeSet id="#INTRD-16363_20230608_migrate_ppm" author="a.rouaguebe">
        <sql>insert into ${db.schema.adapted}cat_price_plan_charge(price_plan_id, charge_id)
             select cppm.id, cct.id  from ${db.schema.adapted}cat_price_plan_matrix cppm join ${db.schema.adapted}cat_charge_template cct on cct.code = cppm.event_code</sql>
        <dropColumn tableName="cat_price_plan_matrix" columnName="event_code" />
    </changeSet>

	<changeSet id="#INTRD-16445_20230526" author="aelmalki">
        <addColumn tableName="ar_account_operation">
            <column name="refunded_payment_id" type="bigint" />
        </addColumn>
        <addForeignKeyConstraint
                baseTableName="ar_account_operation"
                baseColumnNames="refunded_payment_id"
                constraintName="fk_refunded_payment_id"
                referencedTableName="ar_account_operation"
                referencedColumnNames="id" />
    </changeSet>

	<changeSet author="aelmalki" id="#INTRD-16445_20230619">
        <createTable tableName="crm_provider_manual_refund_methods">
            <column name="provider_id" type="bigint" />
            <column name="payment_method" type="varchar(255)" />
        </createTable>
		<addUniqueConstraint columnNames="provider_id, payment_method" constraintName="uk_prov_manual_refund_methods" tableName="crm_provider_manual_refund_methods" />
    </changeSet>

    <changeSet id="#INTRD-17026_delete_duplicated_data" author="a.rouaguebe_ext">
        <renameTable oldTableName="cat_price_plan_charge" newTableName="cat_price_plan_charge_tmp" />
        <createTable tableName="cat_price_plan_charge">
            <column name="price_plan_id" type="bigint" />
            <column name="charge_id" type="bigint" />
        </createTable>
        <addUniqueConstraint columnNames="price_plan_id, charge_id" constraintName="uk_ppm_charge" tableName="cat_price_plan_charge" />

        <sql>insert into ${db.schema.adapted}cat_price_plan_charge(price_plan_id, charge_id)
             select distinct price_plan_id, charge_id from ${db.schema.adapted}cat_price_plan_charge_tmp</sql>

        <dropTable tableName="cat_price_plan_charge_tmp" />
    </changeSet>

    <changeSet id="#INTRD-17084_20230623" author="AndriusKarpavicius">
        <sql>CREATE INDEX idx__billing_wo__rules_contract_id ON ${db.schema.adapted}billing_wallet_operation USING btree (rules_contract_id)</sql>
        <sql>CREATE INDEX idx__billing_wo__contract_id ON ${db.schema.adapted}billing_wallet_operation USING btree (contract_id)</sql>
    </changeSet>

    <changeSet id="#INTRD-14368_20230630" author="AbdellatifBARI">
        <addColumn tableName="security_deposit">
            <column name="seller_id" type="bigint"/>
        </addColumn>
        <addForeignKeyConstraint baseColumnNames="seller_id" baseTableName="security_deposit"
                                 constraintName="fk_seller_security_deposit" deferrable="false"
                                 initiallyDeferred="false"
                                 onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="id"
                                 referencedTableName="crm_seller"/>
        <sql>update ${db.schema.adapted}security_deposit set seller_id=(select seller.id from crm_seller seller order by seller.id desc limit 1) where seller_id is null</sql>
        <addNotNullConstraint tableName="security_deposit" columnName="seller_id" columnDataType="bigint"/>
    </changeSet>

    <changeSet id="INTRD-17134_20230704" author="TarikFA.">
        <addColumn tableName="billing_invoice">
            <column name="ubl_reference" type="${type.boolean}" defaultValueNumeric="0" />
        </addColumn>
    </changeSet>
    
    <changeSet id="#INTRD-16881_20230614" author="Mohammed_ElAzzouzi">
		  <sql>CREATE INDEX idx__billing_rated_transaction__accountingArticle_id ON ${db.schema.adapted}billing_rated_transaction USING btree (accounting_article_id) WHERE (status= 'OPEN') </sql>
		  <sql>CREATE INDEX idx__billing_rated_transaction__charge_instance ON ${db.schema.adapted}billing_rated_transaction USING btree (charge_instance_id) WHERE (status= 'OPEN') </sql>
		  <sql>CREATE INDEX idx__billing_rated_transaction__offer ON ${db.schema.adapted}billing_rated_transaction USING btree (offer_id) WHERE (status= 'OPEN') </sql>
		  <sql>CREATE INDEX idx__billing_rated_transaction__service_instance ON ${db.schema.adapted}billing_rated_transaction USING btree (service_instance_id) WHERE (status= 'OPEN') </sql>
	</changeSet>

    <changeSet id="#INTRD-17500_20230726" author="AbdellatifBARI">
        <sql>CREATE INDEX rating_edr_subscription_index ON ${db.schema.adapted}rating_edr(subscription_id)</sql>
    </changeSet>

    <changeSet id="#INTRD-17592-rt-indexes" author="a.rouaguebe">
        <sql>create index idx__billing_billing_account__lower_code on ${db.schema.adapted}billing_billing_account (lower(code))</sql>
        <sql>create index idx__billing_rating_transaction__id_desc on ${db.schema.adapted}billing_rated_transaction (id desc)</sql>
        <sql>create index idx__billing_rating_transaction__usage_date_desc on ${db.schema.adapted}billing_rated_transaction (usage_date desc)</sql>
    </changeSet>

    <changeSet id="#INTRD-17581-wo-indexes" author="a.rouaguebe">
        <sql>create index idx__billing_wo__charge_instance_id on billing_wallet_operation(charge_instance_id)</sql>
        <sql>create index idx__billing_wo__billing_account_id on billing_wallet_operation(billing_account_id)</sql>
        <sql>create index idx__billing_wo__subscription_id on billing_wallet_operation(subscription_id)</sql>

        <sql>create index idx__charge_instance__lower_code on billing_charge_instance(lower(code))</sql>
        <sql>create index idx__charge_instance__lower_description on billing_charge_instance(lower(description))</sql>
    </changeSet>

    <changeSet id="#INTRD-10574_20221013" author="AndriusKarpavicius">
        <createSequence sequenceName="audit_data_config_seq" startValue="1" />
        <createSequence sequenceName="audit_data_log_rec_seq" startValue="1" incrementBy="1000"/>
        <createSequence sequenceName="audit_data_log_seq" startValue="1" />
                
        <modifyDataType tableName="audit_field_changes_history" columnName="current_state" newDataType="varchar(700)"/>
        <modifyDataType tableName="audit_field_changes_history" columnName="previous_state" newDataType="varchar(700)"/>
        
        <createTable tableName="audit_data_config">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="audit_data_config_pkey" />
            </column>
            <column name="version" type="int4" />
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="updated" type="datetime" />
            <column name="creator" type="varchar(100)" />
            <column name="updater" type="varchar(100)" />
            <column name="entity_class" type="varchar(255)">
                <constraints nullable="false" />
            </column>    
            <column name="entity_fields" type="varchar(2000)" />
            <column name="actions" type="varchar(2000)" />
        </createTable>
        
        <createTable tableName="audit_data_log_rec">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="audit_data_log_rec_pkey" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="tx_id" type="bigint">
                <constraints nullable="false" />
            </column>
            <column name="ref_table" type="varchar(60)">
                <constraints nullable="false" />
            </column>        
            <column name="ref_id" type="bigint" />
            <column name="action" type="varchar(6)">
                <constraints nullable="false" />
            </column>        
            <column name="origin" type="varchar(15)">
                <constraints nullable="false" />
            </column> 
            <column name="origin_name" type="varchar(250)"/>
            <column name="user_name" type="varchar(100)" />
            <column name="data_old" type="${type.json}" />
            <column name="data_new" type="${type.json}" />                  
        </createTable>        
        <createTable tableName="audit_data_log">
            <column name="id" type="bigint" autoIncrement="${id.auto}">
                <constraints nullable="false" primaryKey="true" primaryKeyName="audit_data_log_pkey" />
            </column>
            <column name="created" type="datetime">
                <constraints nullable="false" />
            </column>
            <column name="entity_class" type="varchar(255)">
                <constraints nullable="false" />
            </column>    
            <column name="entity_id" type="bigint" >
                <constraints nullable="false" />
            </column>   
            <column name="tx_id" type="bigint" >
                <constraints nullable="false" />
            </column>
            <column name="action" type="varchar(6)">
                <constraints nullable="false" />
            </column>        
            <column name="origin" type="varchar(15)">
                <constraints nullable="false" />
            </column> 
            <column name="origin_name" type="varchar(250)"/>
            <column name="user_name" type="varchar(100)" />
            <column name="data_old" type="${type.json}" />
            <column name="data_new" type="${type.json}" />                  
        </createTable>        
        <createProcedure>
            CREATE OR REPLACE FUNCTION jsonb_minus ( arg1 jsonb, arg2 jsonb, preserveField varchar, retainOnlyFields varchar ) RETURNS jsonb
                AS $$
                                
                SELECT 
                    COALESCE(json_object_agg(key, value), '{}')::jsonb
                FROM 
                    jsonb_each(arg1)
                WHERE 
                    ((arg1 -> key &lt;&gt; arg2 -> key OR arg2 -> key IS NULL) 
                    and key NOT IN ('version','created', 'updated', 'creator', 'updater') AND (retainOnlyFields ='' or position(','||key||',' IN ','||retainOnlyFields ||',') >0)) OR (preserveField &lt;&gt; '' and key = preserveField) 
                
                $$ LANGUAGE SQL;  
        </createProcedure>
        <createProcedure>
            CREATE OR REPLACE FUNCTION jsonb_removeNull ( arg1 jsonb, preserveField varchar, retainOnlyFields varchar ) RETURNS jsonb
                AS $$
                                
                SELECT 
                    COALESCE(json_object_agg(key, value), '{}')::jsonb
                FROM 
                    jsonb_each(arg1)
                WHERE 
                    value &lt;&gt; 'null' and value &lt;&gt; '{}' and key NOT IN ('version','created', 'updated', 'creator', 'updater') AND ((retainOnlyFields ='' or position(','||key||',' IN ','||retainOnlyFields ||',') >0)  OR (preserveField &lt;&gt; '' and key = preserveField))
              
                $$ LANGUAGE SQL;   
        </createProcedure>
        <createProcedure>
            CREATE OR REPLACE FUNCTION audit_data_log_trigger_func()
                RETURNS trigger AS $body$
            
                DECLARE
                    audit_info varchar(400);
                    audit_info_array text[];
                    db_user varchar(100);
                    origin varchar(15);  
                    origin_name varchar(250);
                    data_old jsonb;
                    data_new jsonb;
                    data_tmp jsonb;
                    ref_id bigint;
                    ref_table varchar(60);
                    save boolean; 
                BEGIN
            
                    save := true;
                    
                    audit_info := current_setting('var.opencell_audit_info', true);
                    if (audit_info IS NOT NULL) then
                        if (audit_info &lt;&gt; '') then
                            audit_info_array := string_to_array(audit_info, '~~');
                            db_user := audit_info_array[1];
                            origin := audit_info_array[2];
                            origin_name := audit_info_array[3];
                        else
                            origin :='GUI';
                        end if;
                     else 
                        select current_user into db_user;
                        origin :='DB';
                    end if;
                    
                    if (TG_OP = 'INSERT') then
                        data_new := to_jsonb(NEW);
                        if (data_new ? 'id') then
                            ref_id :=NEW.id;
                        end if;                        
                        data_new := jsonb_removeNull(data_new, TG_ARGV[0], TG_ARGV[1]);
                        
                        save := TG_ARGV[2]::bool or data_new &lt;&gt; '{}';
                        
                    elseif (TG_OP = 'UPDATE') then
                        data_old := to_jsonb(OLD);
                        data_new := to_jsonb(NEW);
                        if (data_new ? 'id') then
                            ref_id :=NEW.id;
                        end if;
                        data_tmp := jsonb_minus(data_new, data_old, TG_ARGV[0], TG_ARGV[1]);
                        data_old := jsonb_minus(data_old, data_new, TG_ARGV[0], TG_ARGV[1]);
                        data_new := data_tmp;
                        
                        save := TG_ARGV[2]::bool or data_new &lt;&gt; '{}';
            
                    else 
                        data_old := to_jsonb(OLD);
                        if (data_old ? 'id') then
                            ref_id :=OLD.id;
                        end if;                        
                        data_old := jsonb_removeNull(data_old, TG_ARGV[0], TG_ARGV[1]);
                        
                        save := TG_ARGV[2]::bool or data_old &lt;&gt; '{}';

                    end if;
            
                    if (save) then
                        INSERT INTO audit_data_log_rec (
                            id, created, tx_id, ref_table, ref_id, action, origin, origin_name, user_name, data_old, data_new )
                        VALUES(
                            nextval('audit_data_log_rec_seq'), statement_timestamp(), txid_current(), TG_TABLE_NAME, ref_id, TG_OP, origin, origin_name, db_user, data_old, data_new );
                    end if;
                    
                    if (TG_OP = 'DELETE') then
                        RETURN OLD;
                    else 
                        RETURN NEW;
                    end if;
                END;
                $body$
                LANGUAGE plpgsql;
        </createProcedure>
        <createProcedure>
          CREATE OR REPLACE procedure proc_recreate_audit_data_trigger(table_name varchar, fields varchar, actions varchar, preserveField varchar, saveEvenDiffIsEmpty boolean)
                language plpgsql
                as $$

                DECLARE
                    trigger_name varchar(100);
                    trigger_actions varchar(1000);
                BEGIN
            
            trigger_name :=table_name || '_audit_trigger';
        
            
            IF (actions IS NULL OR LOWER(actions) LIKE '%insert%') THEN
                trigger_actions := 'INSERT';
            END IF;

            IF (actions IS NULL OR LOWER(actions) LIKE '%update%') THEN
                trigger_actions := CASE WHEN trigger_actions IS NULL THEN '' ELSE trigger_actions || ' OR' END || ' UPDATE';
                if (fields IS NOT NULL) THEN
                    trigger_actions := trigger_actions || ' of ' || fields;
                END IF;
            END IF;


            IF (actions IS NULL OR LOWER(actions) LIKE '%delete%') THEN
                trigger_actions := CASE WHEN trigger_actions IS NULL THEN '' ELSE trigger_actions || ' OR' END || ' DELETE';
            END IF;

            EXECUTE format ('DROP TRIGGER IF EXISTS %s ON %s', trigger_name, table_name );
            EXECUTE format ('CREATE TRIGGER %I AFTER %s ON %s FOR EACH ROW EXECUTE FUNCTION audit_data_log_trigger_func(''%s'',''%s'',%I)', trigger_name, trigger_actions, table_name, preserveField, fields, saveEvenDiffIsEmpty::bool );

            END$$;
        </createProcedure>
        <createProcedure>
          CREATE OR REPLACE procedure proc_delete_audit_data_trigger(table_name varchar)
                language plpgsql
                as $$

                DECLARE
                    trigger_name varchar(100);
                BEGIN
            
            trigger_name :=table_name || '_audit_trigger';
        
            EXECUTE format ('DROP TRIGGER IF EXISTS %s ON %s', trigger_name, table_name );

            END$$;
        </createProcedure>
    </changeSet>

</databaseChangeLog>